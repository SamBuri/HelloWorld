
/*****************************************************************************************************
This Script is a property of ClinicMaster INTERNATIONAL
Un authorised use or ammendment is not permitted
-- Last updated 10/02/2016 by Wilson Kutegeka
******************************************************************************************************/

use ClinicMaster
go

------------------------------------------------------------------------------------------------------
---------------------- Inserts -> Updates -> Deletes -> Gets -----------------------------------------
------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
------------- Table name -----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
------------- Staff ----------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

------------ Insert Staff ----------------------------------------------------------------------------


if exists (select * from sysobjects where name = 'uspInsertStaff')
	drop proc uspInsertStaff
go

create proc uspInsertStaff(
@StaffNo varchar(10),
@FirstName varchar(20),
@LastName varchar(20),
@GenderID varchar(10),
@StaffTitleID varchar(10),
@Speciality varchar(20),
@Qualifications varchar(40),
@Email varchar(40),
@JoinDate smalldatetime,
@Phone varchar(30),
@Location varchar(40),
@DoctorSpecialtyID varchar(10) = null,
@Fingerprint image = null,
@Signature image = null,
@LoginID varchar(20) = null,
@Hidden bit = null,
@CreatorLoginID varchar(20) =null
)with encryption as 

declare @ErrorMSG varchar(200)
declare @StaffID int
declare @StaffNoPrefix varchar(1)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedStaffID int
declare @PassedStaffNo varchar(20)

if exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The Staff No: ' + @StaffNo + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GenderID)
	begin
		set @ErrorMSG = 'The Gender ID: ' + @GenderID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @StaffTitleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Staff Title ID', @StaffTitleID, 'Lookup Data')	
		return 1
	end
else

if not (@DoctorSpecialtyID is null or @DoctorSpecialtyID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @DoctorSpecialtyID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Doctor Specialty ID', @DoctorSpecialtyID, 'Lookup Data')
				return 1
			end
	end
else if (@DoctorSpecialtyID is null or @DoctorSpecialtyID = '') begin set @DoctorSpecialtyID = null end

if not (@LoginID is null or @LoginID = '') 
	begin
		if not exists(select LoginID from Logins where LoginID  = @LoginID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
				return 1
			end
		
		if exists(select StaffNo from Staff where LoginID  = @LoginID)
			begin
				set @ErrorMSG = 'The Login ID: ' + @LoginID + ', is already associated with another staff'
				raiserror(@ErrorMSG,16,1)	
				return 1
			end
	end
else if (@LoginID is null or @LoginID = '') begin set @LoginID = null end

------------------------------------------------------------------------------------------------------------------
begin

select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'Staff' and AutoColumnName = 'StaffNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'Staff' and AutoColumnName = 'StaffNo'

set @StaffNoPrefix = dbo.GetOptionValue('StaffNoPrefix')

if (@AutoColumnLEN = len(@StaffNo)) and (left(@StaffNo, len(@StaffNoPrefix)) = @StaffNoPrefix)

begin

	set @PassedStaffID = 1
	set @PassedStaffNo = @StaffNo
	set @PassedStaffNo = ltrim(rtrim(substring(@PassedStaffNo, len(@StaffNoPrefix) + 1, @PaddingLEN)))

	if isnumeric(@PassedStaffNo) = 1 set @PassedStaffID = @PassedStaffNo
	else set @PassedStaffID = 1

	set @StaffID = (select max(StaffID) from Staff where left(StaffNo, len(@StaffNoPrefix)) = @StaffNoPrefix)
	set @StaffID = dbo.GetNextAutoNumber('Staff', 'StaffNo', @StaffID)

	if @PassedStaffID < @StaffID set @StaffID = @PassedStaffID
	if @PassedStaffID > @StaffID set @StaffID = @PassedStaffID

end else set @StaffID = 1

------------------------------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
------------------------------------------------------------------------------------------------------------------

insert into Staff
(StaffID, StaffNo ,FirstName ,LastName ,GenderID ,StaffTitleID ,Speciality ,Qualifications ,
Email ,JoinDate ,Phone ,Location, DoctorSpecialtyID, Fingerprint, Signature, LoginID, Hidden,CreatorLoginID) 
values
(@StaffID, @StaffNo ,@FirstName ,@LastName ,@GenderID ,@StaffTitleID ,@Speciality ,@Qualifications ,
@Email ,@JoinDate ,@Phone ,@Location, @DoctorSpecialtyID, @Fingerprint, @Signature, @LoginID, @Hidden,@CreatorLoginID)
return 0
end
go

/************************************************************************************
--1----------------------------------------------------------------------------------
exec uspInsertStaff 'S004', 'Moses', 'Mugume', '15M', '20DR', 'Doctor', 'Degree', 
		'Mukasa@hotmail.com', '1 May 2005', '077609113','JCRC', '39GEN', 'Allen', 1
*************************************************************************************/

-- select * from staff
-- delete from staff 

------------Update Staff----------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateStaff')
	drop proc uspUpdateStaff
go

create proc uspUpdateStaff(
@StaffNo varchar(10),
@FirstName varchar(20),
@LastName varchar(20),
@GenderID varchar(10),
@StaffTitleID varchar(10),
@Speciality varchar(20),
@Qualifications varchar(40),
@Email varchar(40),
@JoinDate smalldatetime,
@Phone varchar(30),
@Location varchar(40),
@DoctorSpecialtyID varchar(10) = null,
@Fingerprint image = null,
@Signature image = null,
@LoginID varchar(20) = null,
@Hidden bit = null
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The Staff No: ' + @StaffNo + ', you''re trying to update does not exist in the registered Staff'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GenderID)
	begin
		set @ErrorMSG = 'The Gender ID: ' + @GenderID + ', you''re trying to update does not exists in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @StaffTitleID)
	begin
		set @ErrorMSG = 'The Staff Title ID: ' + @StaffTitleID + ', you''re trying to update does not exists in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else

if not (@DoctorSpecialtyID is null or @DoctorSpecialtyID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @DoctorSpecialtyID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Doctor Specialty ID', @DoctorSpecialtyID, 'Lookup Data')
				return 1
			end
	end
else if (@DoctorSpecialtyID is null or @DoctorSpecialtyID = '') begin set @DoctorSpecialtyID = null end

if not (@LoginID is null or @LoginID = '') 
	begin
		if not exists(select LoginID from Logins where LoginID  = @LoginID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
				return 1
			end

		if exists(select StaffNo from Staff where LoginID = @LoginID and not StaffNo = @StaffNo)
			begin
				set @ErrorMSG = 'The Login ID: ' + @LoginID + ', is already associated with another staff'
				raiserror(@ErrorMSG,16,1)	
				return 1
			end
	end
else if (@LoginID is null or @LoginID = '') begin set @LoginID = null end

begin

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

update Staff set
	FirstName = @FirstName ,LastName = @LastName ,GenderID = @GenderID ,StaffTitleID = @StaffTitleID ,
	Speciality = @Speciality ,Qualifications = @Qualifications ,Email = @Email ,--JoinDate = @JoinDate ,
	 Phone= @Phone ,Location = @Location, DoctorSpecialtyID = @DoctorSpecialtyID,Fingerprint = @Fingerprint, 
	Signature = @Signature, LoginID = @LoginID, Hidden = @Hidden,RecordDateTime =getdate(),ClientMachine=host_name()
where StaffNo = @StaffNo

return 0
end
go

/***********************************************************************************
-----------------------------------------------------------------------------------
exec uspUpdateStaff 'S001', 'Moses', 'Mugume', '15M', '20DR', 'Doctor', 'Degree', 
		'cbalungi@yahoo.co.uk', 'Jan 7, 2006', '077609113','Kampala', 'Kutegz', 0

exec uspUpdateStaff 'S004', 'Moses', 'Mugume', '15M', '20DR', 'Doctor', 'Degree', 
		'Mukasa@hotmail.com', '1 May 2005', '077609113','JCRC', '39PED', 'Allen', 0

***********************************************************************************/

-- select * from Staff

--------Get Staff-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetStaff')
	drop proc uspGetStaff
go

create proc uspGetStaff(
@StaffNo varchar(10) = null output,
@StaffTitleID varchar(10) = null output,
@DoctorSpecialtyID varchar(10) = null,
@Hidden bit = null
)with encryption as

declare @ErrorMSG varchar(200)

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

if (not (@StaffNo is null)) and (@StaffTitleID is null) and (@DoctorSpecialtyID is null)
begin
	if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG,16,1, 'Staff No', @StaffNo, 'Staff')	
			return 1
	end
	begin
		select Staff.StaffNo, FirstName, LastName ,JoinDate, StaffTitleID, dbo.GetLookupDataDes(StaffTitleID) as StaffTitle,
		GenderID, dbo.GetLookupDataDes(GenderID) as Gender, Speciality, Qualifications, Email, Phone, Location,
		DoctorSpecialtyID, dbo.GetLookupDataDes(DoctorSpecialtyID) as DoctorSpecialty, Signature,Fingerprint, Hidden,
		dbo.GetStaffName(Staff.StaffNo) as FullName, dbo.GetStaffFullName(Staff.StaffNo) as StaffFullName, LoginID
		from Staff
		where Staff.StaffNo = @StaffNo
		order by LastName
	end
end
else
if (@StaffNo is null) and (not (@StaffTitleID is null)) and (@DoctorSpecialtyID is null)
begin
	select Staff.StaffNo, FirstName, LastName ,JoinDate, StaffTitleID, dbo.GetLookupDataDes(StaffTitleID) as StaffTitle,
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender, Speciality, Qualifications, Email, Phone, Location,
	DoctorSpecialtyID, dbo.GetLookupDataDes(DoctorSpecialtyID) as DoctorSpecialty,Fingerprint, Signature, Hidden,
	dbo.GetStaffName(Staff.StaffNo) as FullName, dbo.GetStaffFullName(Staff.StaffNo) as StaffFullName,  LoginID
	from Staff
	where Hidden = @Hidden and StaffTitleID = @StaffTitleID
	order by LastName
end
else
if (@StaffNo is null) and (not (@StaffTitleID is null)) and (not (@DoctorSpecialtyID is null))
begin
	select Staff.StaffNo, FirstName, LastName ,JoinDate, StaffTitleID, dbo.GetLookupDataDes(StaffTitleID) as StaffTitle,
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender, Speciality, Qualifications, Email, Phone, Location,
	DoctorSpecialtyID, dbo.GetLookupDataDes(DoctorSpecialtyID) as DoctorSpecialty,Fingerprint, Signature, Hidden,
	dbo.GetStaffName(Staff.StaffNo) as FullName, dbo.GetStaffFullName(Staff.StaffNo) as StaffFullName,  LoginID
	from Staff
	where Hidden = @Hidden and StaffTitleID = @StaffTitleID and DoctorSpecialtyID = @DoctorSpecialtyID
	order by LastName
end
else
if  (@StaffNo is null)and (@StaffTitleID is null) and (@DoctorSpecialtyID is null)

begin
	select Staff.StaffNo, FirstName, LastName ,JoinDate, StaffTitleID, dbo.GetLookupDataDes(StaffTitleID) as StaffTitle,
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender, Speciality, Qualifications, Email, Phone, Location,
	DoctorSpecialtyID, dbo.GetLookupDataDes(DoctorSpecialtyID) as DoctorSpecialty,Fingerprint, Signature, Hidden,
	dbo.GetStaffName(Staff.StaffNo) as FullName, dbo.GetStaffFullName(Staff.StaffNo) as StaffFullName, LoginID
	from Staff
	where Hidden = @Hidden
	order by LastName
end

--------------------------------------------------------------------------------------------------------------------------------

return 0

go

-- select * from Staff
-- exec uspGetStaff '100',null, null
-- exec uspGetStaff null, '20DR', null
-- exec uspGetStaff null, '20TEC', null
-- exec uspGetStaff null, '20DR', '39GEN'
-- exec uspGetStaff null, '20DR', '39PED'
-- exec uspGetStaff null,null,null

-- dbo.GetMergedNameCode(StaffTitle.DataDes, StaffTitleID)  as StaffTitle,
-- dbo.GetMergedNameCode(Gender.DataDes, GenderID) as Gender,

-------- GetStaffByLoginID -------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetStaffByLoginID')
	drop proc uspGetStaffByLoginID
go

create proc uspGetStaffByLoginID(
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select Staff.StaffNo, FirstName, LastName , JoinDate, dbo.GetLookupDataDes(StaffTitleID) as StaffTitle,
	dbo.GetLookupDataDes(GenderID) as Gender, Speciality, Qualifications, Email, Phone, Location,
	DoctorSpecialtyID, dbo.GetLookupDataDes(DoctorSpecialtyID) as DoctorSpecialty, Fingerprint, Signature, Hidden,
	dbo.GetStaffName(Staff.StaffNo) as FullName, dbo.GetStaffFullName(Staff.StaffNo) as StaffFullName,  LoginID
	from Staff
	where LoginID = @LoginID
end

return 0

go

-- select * from Staff
-- exec uspGetStaffByLoginID null
-- exec uspGetStaffByLoginID 'admin'

-------- GetNextStaffID --------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextStaffID')
	drop proc uspGetNextStaffID
go

create proc uspGetNextStaffID(
@StaffID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @StaffNoPrefix varchar(1)

set @StaffNoPrefix = dbo.GetOptionValue('StaffNoPrefix')

set @StaffID = (select max(StaffID) from Staff where left(StaffNo, len(@StaffNoPrefix)) = @StaffNoPrefix)
set @StaffID = dbo.GetNextAutoNumber('Staff', 'StaffNo', @StaffID)

return 0
go

-- exec uspGetNextStaffID
-- select * from Staff


--------Get Logged In Staff-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLoggedInStaff')
	drop proc uspGetLoggedInStaff
go

create proc uspGetLoggedInStaff(
@StaffNo varchar(10) = null output,
@StaffTitleID varchar(10) = null output,
@DoctorSpecialtyID varchar(10) = null,
@Hidden bit = null
)with encryption as

declare @ErrorMSG varchar(200)

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

if (not (@StaffNo is null)) and (@StaffTitleID is null) and (@DoctorSpecialtyID is null)
begin
	if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG,16,1, 'Staff No', @StaffNo, 'Staff')	
			return 1
	end
	begin
		select Staff.StaffNo, FirstName, LastName ,JoinDate, StaffTitleID, dbo.GetLookupDataDes(StaffTitleID) as StaffTitle,
		GenderID, dbo.GetLookupDataDes(GenderID) as Gender, Speciality, Qualifications, Email, Phone, Location,
		DoctorSpecialtyID, dbo.GetLookupDataDes(DoctorSpecialtyID) as DoctorSpecialty, Signature,Fingerprint, Hidden,
		dbo.GetStaffName(Staff.StaffNo) as FullName, dbo.GetStaffFullName(Staff.StaffNo) as StaffFullName, Staff.LoginID as LoginID
		from Staff
		inner join ActiveUsers on Staff.LoginID=ActiveUsers.LoginID
		where Staff.StaffNo = @StaffNo
		order by LastName
	end
end
else
if (@StaffNo is null) and (not (@StaffTitleID is null)) and (@DoctorSpecialtyID is null)
begin
	select Staff.StaffNo, FirstName, LastName ,JoinDate, StaffTitleID, dbo.GetLookupDataDes(StaffTitleID) as StaffTitle,
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender, Speciality, Qualifications, Email, Phone, Location,
	DoctorSpecialtyID, dbo.GetLookupDataDes(DoctorSpecialtyID) as DoctorSpecialty,Fingerprint, Signature, Hidden,
	dbo.GetStaffName(Staff.StaffNo) as FullName, dbo.GetStaffFullName(Staff.StaffNo) as StaffFullName,  Staff.LoginID as LoginID
	from Staff
	inner join ActiveUsers on Staff.LoginID=ActiveUsers.LoginID
	where Hidden = @Hidden and StaffTitleID = @StaffTitleID
	order by LastName
end
else
if (@StaffNo is null) and (not (@StaffTitleID is null)) and (not (@DoctorSpecialtyID is null))
begin
	select Staff.StaffNo, FirstName, LastName ,JoinDate, StaffTitleID, dbo.GetLookupDataDes(StaffTitleID) as StaffTitle,
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender, Speciality, Qualifications, Email, Phone, Location,
	DoctorSpecialtyID, dbo.GetLookupDataDes(DoctorSpecialtyID) as DoctorSpecialty,Fingerprint, Signature, Hidden,
	dbo.GetStaffName(Staff.StaffNo) as FullName, dbo.GetStaffFullName(Staff.StaffNo) as StaffFullName,  Staff.LoginID as LoginID
	from Staff
	inner join ActiveUsers on Staff.LoginID=ActiveUsers.LoginID
	where Hidden = @Hidden and StaffTitleID = @StaffTitleID and DoctorSpecialtyID = @DoctorSpecialtyID
	order by LastName
end
else
if  (@StaffNo is null)and (@StaffTitleID is null) and (@DoctorSpecialtyID is null)

begin
	select Staff.StaffNo, FirstName, LastName ,JoinDate, StaffTitleID, dbo.GetLookupDataDes(StaffTitleID) as StaffTitle,
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender, Speciality, Qualifications, Email, Phone, Location,
	DoctorSpecialtyID, dbo.GetLookupDataDes(DoctorSpecialtyID) as DoctorSpecialty,Fingerprint, Signature, Hidden,
	dbo.GetStaffName(Staff.StaffNo) as FullName, dbo.GetStaffFullName(Staff.StaffNo) as StaffFullName, Staff.LoginID as LoginID
	from Staff
	inner join ActiveUsers on Staff.LoginID=ActiveUsers.LoginID
	where Hidden = @Hidden
	order by LastName
end

--------------------------------------------------------------------------------------------------------------------------------
return 0
go


------------------------------------------------------------------------------------------------------
------------- Patients -------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

------------Insert Patients---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPatients')
	drop proc uspInsertPatients
go

create proc uspInsertPatients(
@PatientNo varchar(20),
@ReferenceNo varchar(20),
@NationalIDNo varchar(14) = null,
@FirstName varchar(20),
@LastName varchar(20),
@MiddleName varchar(20),
@BirthDate smalldatetime,
@GenderID varchar(10),
@Photo image = null,
@Fingerprint image = null,
@BirthPlace varchar(40) ,
@Address varchar(100),
@Occupation varchar(100),
@Phone varchar(30),
@Email varchar(40),
@JoinDate smalldatetime,
@Location varchar(40),
@NOKName varchar(41),
@NOKRelationship varchar(20),
@NOKPhone varchar(30),
@DefaultBillModesID varchar(10),
@DefaultBillNo varchar(20),
@DefaultMemberCardNo varchar(30),
@DefaultMainMemberName varchar(41),
@EnforceDefaultBillNo bit,
@HideDetails bit,
@StatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40),
------------ Optional Fields ------------
@BloodGroupID varchar(10) = null,
@VillageCode varchar(20) = null,
@TribeID varchar(10) = null,
@MaritalStatusID varchar(10) = null,
@CareEntryPointID varchar(10) = null,
@CommunityID varchar(10) = null,
@CountryID varchar(10) = null,
@EducationLevelID varchar(10) = null,
@ReligionID varchar(10) = null,
@Employer varchar(41) = '',
@EmployerAddress varchar(100) = '',
@ReferringMedicalOfficer varchar(41) = '',
@NearestDispensary varchar(30) = '',
@PreviousAdmissions varchar(30) = '',
@ChronicDiseases varchar(200) = '',
@XrayNumbers  Decimal(6,2)=null,
@PoliceNotified bit ='',
@InfectiousDiseasesNotified bit ='',
@MedicalConditions varchar(2000)='',
@ProvisionalDiagnosis varchar(2000)='',
@ReferringFacility varchar(41) = null
)with encryption as 

declare @ErrorMSG varchar(200)

declare @CashBillModesID varchar(10)
declare @CashBillModes varchar(100)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)
declare @BranchID varchar(10)
declare @NABloodGroupID varchar(10)
declare @NATribeID varchar(10)
declare @NAReligionID varchar(10)
declare @NAMaritalStatusID varchar(10)
declare @NACareEntryPointID varchar(10)
declare @NACountryID varchar(10)
declare @NAEducationLevelID varchar(10)
declare @PatientID int
declare @OptionValue varchar(10)
declare @CurrentYear as char(2)
declare @PatientNoPrefix varchar(12)
declare @SelfRequest as char(4)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedPatientID int
declare @PassedPatientNo varchar(20)

----------------------------------------------------------------------------
set @BranchID = dbo.GetMyCurrentBranch(@LoginID)
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @CashBillModes = dbo.GetLookupDataDes(@CashBillModesID)
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
----------------------------------------------------------------------------
set @NABloodGroupID = dbo.GetLookupDataID('BloodGroup', 'NA')
set @NATribeID = dbo.GetLookupDataID('Tribe', 'NA')
set @NACountryID = dbo.GetLookupDataID('Country', 'UG')
set @NAReligionID = dbo.GetLookupDataID('Religion', 'NA')
set @NAMaritalStatusID = dbo.GetLookupDataID('MaritalStatus', 'N')
set @NACareEntryPointID = dbo.GetLookupDataID('CareEntryPoint', '01')
set @NAEducationLevelID= dbo.GetLookupDataID('EducationAttained', 'U')
----------------------------------------------------------------------------

if exists(select PatientNo from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG,16, 1, 'Patient No', @PatientNo)	
		return 1
	end
	
if (@BirthDate > GetDate())
	begin		
		set @ErrorMSG = 'The %s: ' + ltrim(rtrim(dbo.FormatDate(@BirthDate))) + ', you are trying to enter can''t be ahead of today’s date as set by server administrator'
		raiserror(@ErrorMSG, 16, 1, 'Birth Date')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GenderID )
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Gender ID', @GenderID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DefaultBillModesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Default Bill Modes ID', @DefaultBillModesID, 'Lookup Data')
		return 1
	end
------------------------------------------------------------------------------------------------------------------

if (@DefaultBillModesID = @AccountBillModesID) and (@DefaultBillNo = @CashBillModes)
	begin
		set @ErrorMSG = 'Default Bill No for Bill Mode Account can''t be Cash!'
		raiserror(@ErrorMSG,16, 1)	
		return 1
	end

if (@DefaultBillModesID = @InsuranceBillModesID)
	begin
		if not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @DefaultBillNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @DefaultBillNo, 'Scheme Members')
				return 1
			end

		if exists(select DefaultBillNo from Patients where DefaultBillNo = @DefaultBillNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter is already assigned to another Patient'
				raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @DefaultBillNo)
				return 1
			end
	end
else
	begin 
		if not exists(select AccountNo from BillCustomers where AccountNo = @DefaultBillNo)
			begin
				set @ErrorMSG = 'The  %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Account No', @DefaultBillNo, 'Bill Customers')	
				return 1
			end
			
		else if (@DefaultBillModesID = @AccountBillModesID) and exists(select DefaultBillNo from Patients 
						where DefaultBillNo = @DefaultBillNo and DefaultMemberCardNo = @DefaultMemberCardNo
						and not (@DefaultMemberCardNo = '' or @DefaultMemberCardNo is null))
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter is already assigned to another Patient on %s: %s.'
				raiserror(@ErrorMSG, 16, 1, 'Member Card No', @DefaultMemberCardNo, 'To-Bill Number', @DefaultBillNo)
				return 1
			end	
				
		else if (@DefaultBillModesID = @AccountBillModesID) and exists(select DefaultBillNo from Patients 
						where dbo.GetBillInsuranceNo(DefaultBillNo) = dbo.GetBillInsuranceNo(@DefaultBillNo) 
						and DefaultMemberCardNo = @DefaultMemberCardNo
						and not (@DefaultMemberCardNo = '' or @DefaultMemberCardNo is null))
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter is already assigned to another Patient on %s: ' + dbo.GetBillInsuranceNo(@DefaultBillNo) + '.'
				raiserror(@ErrorMSG, 16, 1, 'Member Card No', @DefaultMemberCardNo, 'To-Bill Insurance Number')
				return 1
			end				
	end
------------------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @StatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Status ID', @StatusID, 'Lookup Data')	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
----------------------- Optional Fields --------------------------------------------------------------------------

if not (@BloodGroupID is null or @BloodGroupID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @BloodGroupID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Blood Group ID', @BloodGroupID, 'Lookup Data')
				return 1
			end
	end
else if (@BloodGroupID is null or @BloodGroupID = '') begin set @BloodGroupID = @NABloodGroupID end

if not (@VillageCode is null or @VillageCode = '') 
	begin
		if not exists(select VillageCode from Villages where VillageCode  = @VillageCode)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Village Code', @VillageCode, 'Villages')
				return 1
			end
	end
else if (@VillageCode is null or @VillageCode = '') begin set @VillageCode = null end

if not (@CareEntryPointID is null or @CareEntryPointID = '')
begin 
if not exists(select DataID from LookupData where DataID = @CareEntryPointID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Care Entry Point ID', @CareEntryPointID, 'Lookup Data')
		return 1
	end
	end
else if (@CareEntryPointID is null or @CareEntryPointID = '') begin set @CareEntryPointID = @NACareEntryPointID end

if not (@CountryID is null or @CountryID = '')
begin 
if not exists(select DataID from LookupData where DataID = @CountryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Country', @CountryID, 'Lookup Data')
		return 1
	end
	end
else if (@CountryID is null or @CountryID = '') begin set @CountryID = @NACountryID end


if not (@EducationLevelID is null or @EducationLevelID = '')
begin 
if not exists(select DataID from LookupData where DataID = @EducationLevelID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Education Level', @EducationLevelID, 'Lookup Data')
		return 1
	end
	end
else if (@EducationLevelID is null or @EducationLevelID = '') begin set @EducationLevelID = @NAEducationLevelID end



if not (@MaritalStatusID is null or @MaritalStatusID = '')
begin
if not exists(select DataID from LookupData where DataID = @MaritalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Marital Status', @MaritalStatusID, 'Lookup Data')
		return 1
	end
	end
else if (@MaritalStatusID is null or @MaritalStatusID = '') begin set @MaritalStatusID = @NAMaritalStatusID end

if not (@TribeID is null or @TribeID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @TribeID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Tribe ID', @TribeID, 'Lookup Data')
				return 1
			end
	end
else if (@TribeID is null or @TribeID = '') begin set @TribeID = @NATribeID end

if not (@ReligionID is null or @ReligionID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @ReligionID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Religion ID', @ReligionID, 'Lookup Data')
				return 1
			end
	end
else if (@ReligionID is null or @ReligionID = '') begin set @ReligionID = @NAReligionID end


------------------------------------------------------------------------------------------------------------------
begin
select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'Patients' and AutoColumnName = 'PatientNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'Patients' and AutoColumnName = 'PatientNo'

set @OptionValue = dbo.GetOptionValue('PatientNoPrefix')
set @CurrentYear = right(year(getdate()),2)
set @PatientNoPrefix = @OptionValue + @CurrentYear
set @SelfRequest = dbo.GetOptionValue('SelfRequestNoPrefix') + @CurrentYear

if (@AutoColumnLEN = len(@PatientNo)) and (left(@PatientNo, len(@PatientNoPrefix)) = @PatientNoPrefix)

begin

	set @PassedPatientID = 1
	set @PassedPatientNo = @PatientNo
	set @PassedPatientNo = ltrim(rtrim(substring(@PassedPatientNo, len(@PatientNoPrefix) + 1, @PaddingLEN)))

	if isnumeric(@PassedPatientNo) = 1 set @PassedPatientID = @PassedPatientNo
	else set @PassedPatientID = 1

	set @PatientID = (select max(PatientID) from Patients where left(PatientNo, len(@PatientNoPrefix)) = @PatientNoPrefix)
	set @PatientID = dbo.GetNextAutoNumber('Patients', 'PatientNo', @PatientID)

	if @PassedPatientID < @PatientID set @PatientID = @PassedPatientID
	if @PassedPatientID > @PatientID set @PatientID = @PassedPatientID

end 
else if (left(@PatientNo, len(@SelfRequest)) = @SelfRequest)
begin

	set @PassedPatientID = 1
	set @PassedPatientNo = @PatientNo
	set @PassedPatientNo = ltrim(rtrim(substring(@PassedPatientNo, len(@SelfRequest) + 1, @PaddingLEN)))

	if isnumeric(@PassedPatientNo) = 1 set @PassedPatientID = @PassedPatientNo
	else set @PassedPatientID = 1

	set @PatientID = (select max(PatientID) from Patients where left(PatientNo, len(@SelfRequest)) = @SelfRequest)
	set @PatientID = dbo.GetNextAutoNumber('Patients', 'PatientNo', @PatientID)

	if @PassedPatientID < @PatientID set @PatientID = @PassedPatientID
	if @PassedPatientID > @PatientID set @PatientID = @PassedPatientID

end else set @PatientID = 1

---------------------------------------------------------------------------------------------------

insert into Patients
(PatientID, PatientNo, ReferenceNo,NationalIDNo, FirstName ,LastName, MiddleName, BirthDate ,GenderID, Photo, 
Fingerprint, BirthPlace, Address, Occupation, Phone, Email ,JoinDate, Location, NOKName, 
NOKRelationship, NOKPhone, DefaultBillModesID, DefaultBillNo, DefaultMemberCardNo, 
DefaultMainMemberName, EnforceDefaultBillNo, HideDetails, StatusID, LoginID, ClientMachine, 
---------------------- Optional Fields -----------------------------------------------------
BloodGroupID, VillageCode, TribeID, ReligionID,MaritalStatusID,CountryID,CareEntryPointID,BranchID,Employer, EmployerAddress, 
ReferringMedicalOfficer, NearestDispensary, PreviousAdmissions, ChronicDiseases,XrayNumbers,PoliceNotified,
InfectiousDiseasesNotified,MedicalConditions,ProvisionalDiagnosis, CommunityID,EducationLevelID, ReferringFacility)
values
(@PatientID ,@PatientNo, @ReferenceNo,@NationalIDNo,@FirstName ,@LastName, @MiddleName, @BirthDate ,@GenderID, @Photo, 
@Fingerprint, @BirthPlace, @Address, @Occupation, @Phone, @Email ,@JoinDate, @Location, @NOKName, 
@NOKRelationship, @NOKPhone, @DefaultBillModesID, @DefaultBillNo, @DefaultMemberCardNo, 
@DefaultMainMemberName, @EnforceDefaultBillNo, @HideDetails, @StatusID, @LoginID, @ClientMachine, 
---------------------- Optional Fields ----------------------------------------------------------
@BloodGroupID, @VillageCode, @TribeID, @ReligionID,@MaritalStatusID,@CountryID,@CareEntryPointID,@BranchID, 
@Employer, @EmployerAddress,@ReferringMedicalOfficer, @NearestDispensary,  @PreviousAdmissions, @ChronicDiseases,@XrayNumbers,@PoliceNotified,
@InfectiousDiseasesNotified,@MedicalConditions,@ProvisionalDiagnosis,@CommunityID,@EducationLevelID, @ReferringFacility)

return 0
end
go

/************************************************************************************************
--1----------------------------------------------------------------------------------------------
exec uspInsertPatients '0800001', 'Ref.004', 'Moses', 'Mugume', '', '1 Jan 2014', '15M', NULL, NULL, 'Kampala','P.O Box 7370',
			'Farmer', '077609113', 'kutegz@yahoo.com', '1 May 2006', 'MOH', 'NOK Name', '', 'NOK Phone', '17C', 'CASH', '', 
			'', 0, 0, '1A', 'Admin'

exec uspInsertPatients '0800002', '', 'Moses', 'Mugume', '', '1 Feb 1975','15M', NULL, NULL, 'Kampala','P.O Box 7370',
			'Farmer', '077609113', '', 'NOK Name', 'NOK Phone', '1 May 2006','Treat', 'CT', 1, '', 0, '1A', 'Admin'

exec uspInsertPatients '0800003', '', 'Moses', 'Mugume', '', '1 Feb 1975','15M',  NULL, NULL, 'Kampala','P.O Box 7370'
			,'Farmer', '077609113', '', '1 May 2006','', 'CT', 1, '', '1A', 'Kutegz'

****************************************************************************************/

-- select * from Patients where PatientNo = '0800001'
-- delete from Patients

------------Update Patients----------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePatients')
	drop proc uspUpdatePatients
go

create proc uspUpdatePatients(
@PatientNo varchar(20),
@ReferenceNo varchar(20),
@NationalIDNo varchar(14),
@FirstName varchar(20),
@LastName varchar(20),
@MiddleName varchar(20),
@BirthDate smalldatetime,
@GenderID varchar(10),
@Photo image = null,
@Fingerprint image = null,
@BirthPlace varchar(40) ,
@Address varchar(100),
@Occupation varchar(100),
@Phone varchar(30),
@Email varchar(40),
@JoinDate smalldatetime ,
@Location varchar(40),
@NOKName varchar(41),
@NOKRelationship varchar(20),
@NOKPhone varchar(30),
@DefaultBillModesID varchar(10),
@DefaultBillNo varchar(20),
@DefaultMemberCardNo varchar(30),
@DefaultMainMemberName varchar(41),
@EnforceDefaultBillNo bit,
@HideDetails bit,
@StatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40),
------------ Optional Fields ------------
@BloodGroupID varchar(10) = null,
@VillageCode varchar(20) = null,
@MaritalStatusID varchar(10) = null,
@CountryID varchar(10) = null,
@EducationLevelID varchar(10) =null,
@CareEntryPointID varchar(10) = null,
@TribeID varchar(10) = null,
@ReligionID varchar(10) = null,
@CommunityID varchar(10) = null,
@Employer varchar(41) = '',
@EmployerAddress varchar(100) = '',
@ReferringMedicalOfficer varchar(41) = '',
@NearestDispensary varchar(30) = '',
@PreviousAdmissions varchar(30) = '',
@ChronicDiseases varchar(200) = '',
@XrayNumbers  Decimal(6,2)=null,
@PoliceNotified bit='',
@InfectiousDiseasesNotified bit='',
@MedicalConditions varchar(2000)='',
@ProvisionalDiagnosis varchar(2000)='',
@ReferringFacility varchar(41) = null
)with encryption as 

declare @ErrorMSG varchar(200)

declare @CashBillModesID varchar(10)
declare @CashBillModes varchar(100)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

declare @NABloodGroupID varchar(10)
declare @NATribeID varchar(10)
declare @NAReligionID varchar(10)
declare @NAMaritalStatusID varchar(10)
declare @NACareEntryPointID varchar(10)
declare @NACountryID  varchar(10)
declare @NAEducationLevelID varchar(10)
declare @BranchID varchar(10)
----------------------------------------------------------------------------
set @BranchID = dbo.GetMyCurrentBranch(@LoginID)
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @CashBillModes = dbo.GetLookupDataDes(@CashBillModesID)
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
----------------------------------------------------------------------------
set @NABloodGroupID = dbo.GetLookupDataID('BloodGroup', 'NA')
set @NATribeID = dbo.GetLookupDataID('Tribe', 'NA')
set @NACountryID = dbo.GetLookupDataID('Country', 'UG')
set @NAReligionID = dbo.GetLookupDataID('Religion', 'NA')
set @NAMaritalStatusID = dbo.GetLookupDataID('MaritalStatus', 'N')
set @NACareEntryPointID = dbo.GetLookupDataID('CareEntryPoint', '01')
set @NAEducationLevelID =dbo.GetLookupDataID('EducationAttained', 'U')
----------------------------------------------------------------------------

if not exists(select PatientNo from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The Patient No: ' + @PatientNo + ', you are trying to update does not exist'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end
	
if (@BirthDate > GetDate())
	begin		
		set @ErrorMSG = 'The %s: ' + ltrim(rtrim(dbo.FormatDate(@BirthDate))) + ', you are trying to enter can''t be ahead of today’s date as set by server administrator'
		raiserror(@ErrorMSG, 16, 1, 'Birth Date')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GenderID)
	begin
		set @ErrorMSG = 'The Gender ID: ' + @GenderID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DefaultBillModesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Default Bill Modes ID', @DefaultBillModesID, 'Lookup Data')
		return 1
	end

------------------------------------------------------------------------------------------------------------------

if (@DefaultBillModesID = @AccountBillModesID) and (@DefaultBillNo = @CashBillModes)
	begin
		set @ErrorMSG = 'Default Bill No for Bill Mode Account can''t be Cash!'
		raiserror(@ErrorMSG,16, 1)	
		return 1
	end

if  (@DefaultBillModesID = @InsuranceBillModesID)
	begin
		if not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @DefaultBillNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @DefaultBillNo, 'Scheme Members')
				return 1
			end

		if exists(select DefaultBillNo from Patients where DefaultBillNo = @DefaultBillNo and not PatientNo = @PatientNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter is already assigned to another Patient'
				raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @DefaultBillNo)
				return 1
			end
	end
else 
	begin 
	
		if not exists(select AccountNo from BillCustomers where AccountNo = @DefaultBillNo)
			begin
				set @ErrorMSG = 'The  %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Account No', @DefaultBillNo, 'Bill Customers')	
				return 1
			end
		else if (@DefaultBillModesID = @AccountBillModesID) and exists(select DefaultBillNo from Patients 
			where DefaultBillNo = @DefaultBillNo and DefaultMemberCardNo = @DefaultMemberCardNo 
			and not PatientNo = @PatientNo and not (@DefaultMemberCardNo = '' or @DefaultMemberCardNo is null))
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter is already assigned to another Patient on %s: %s.'
				raiserror(@ErrorMSG, 16, 1, 'Member Card No', @DefaultMemberCardNo, 'To-Bill Number', @DefaultBillNo)
				return 1
			end	
		else if (@DefaultBillModesID = @AccountBillModesID) and exists(select DefaultBillNo from Patients 
			where dbo.GetBillInsuranceNo(DefaultBillNo) = dbo.GetBillInsuranceNo(@DefaultBillNo) 
			and DefaultMemberCardNo = @DefaultMemberCardNo and not PatientNo = @PatientNo 
			and not (@DefaultMemberCardNo = '' or @DefaultMemberCardNo is null))
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter is already assigned to another Patient on %s: ' + dbo.GetBillInsuranceNo(@DefaultBillNo) + '.'
				raiserror(@ErrorMSG, 16, 1, 'Member Card No', @DefaultMemberCardNo, 'To-Bill Insurance Number')
				return 1
			end	
	end
------------------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @StatusID)
	begin
		set @ErrorMSG = 'The Status ID: ' + @StatusID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG, 16, 1)	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG, 16, 1)	
		return 1
	end

else
----------------------- Optional Fields --------------------------------------------------------------------------

if not (@BloodGroupID is null or @BloodGroupID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @BloodGroupID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Blood Group ID', @BloodGroupID, 'Lookup Data')
				return 1
			end
	end
else if (@BloodGroupID is null or @BloodGroupID = '') begin set @BloodGroupID = @NABloodGroupID end

if not (@VillageCode is null or @VillageCode = '') 
	begin
		if not exists(select VillageCode from Villages where VillageCode  = @VillageCode)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Village Code', @VillageCode, 'Villages')
				return 1
			end
	end
else if (@VillageCode is null or @VillageCode = '') begin set @VillageCode = null end

if not (@CareEntryPointID is null or @CareEntryPointID = '')
begin 
if not exists(select DataID from LookupData where DataID = @CareEntryPointID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Care Entry Point ID', @CareEntryPointID, 'Lookup Data')
		return 1
	end
	end
else if (@CareEntryPointID is null or @CareEntryPointID = '') begin set @CareEntryPointID = @NACareEntryPointID end

if not (@MaritalStatusID is null or @MaritalStatusID = '')
begin
if not exists(select DataID from LookupData where DataID = @MaritalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Marital Status ID', @MaritalStatusID, 'Lookup Data')
		return 1
	end
	end
else if (@MaritalStatusID is null or @MaritalStatusID = '') begin set @MaritalStatusID = @NAMaritalStatusID  end

if not (@TribeID is null or @TribeID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @TribeID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Tribe ID', @TribeID, 'Lookup Data')
				return 1
			end
	end
else if (@TribeID is null or @TribeID = '') begin set @TribeID = @NATribeID end

if not (@CountryID is null or @CountryID = '')
begin 
if not exists(select DataID from LookupData where DataID = @CountryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Country', @CountryID, 'Lookup Data')
		return 1
	end
	end
else if (@CountryID is null or @CountryID = '') begin set @CountryID = @NACountryID end

if not (@EducationLevelID is null or @EducationLevelID = '')
begin 
if not exists(select DataID from LookupData where DataID = @EducationLevelID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Education Level', @EducationLevelID, 'Lookup Data')
		return 1
	end
	end
else if (@EducationLevelID is null or @EducationLevelID = '') begin set @EducationLevelID = @NAEducationLevelID end


if not (@ReligionID is null or @ReligionID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @ReligionID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Religion ID', @ReligionID, 'Lookup Data')
				return 1
			end
	end
else if (@ReligionID is null or @ReligionID = '') begin set @ReligionID = @NAReligionID end

------------------------------------------------------------------------------------------------------------------

if exists(select PatientNo from Deaths where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The Patient No: ' + @PatientNo + ', you are trying to update is Deceased'
		raiserror(@ErrorMSG, 16, 1)	
		return 1
	end
else

begin
update Patients set
	ReferenceNo = @ReferenceNo,NationalIDNo=@NationalIDNo ,JoinDate = @JoinDate, FirstName = @FirstName,LastName = @LastName, 
	MiddleName = @MiddleName, BirthDate = @BirthDate, GenderID = @GenderID, Photo = @Photo, 
	Fingerprint = @Fingerprint, BirthPlace = @BirthPlace, Address = @Address, Occupation = @Occupation, 
	Phone = @Phone, Email = @Email, Location =@Location, NOKName = @NOKName, NOKRelationship = @NOKRelationship, 
	NOKPhone = @NOKPhone, DefaultBillModesID = @DefaultBillModesID, DefaultBillNo = @DefaultBillNo, 
	DefaultMemberCardNo = @DefaultMemberCardNo, DefaultMainMemberName = @DefaultMainMemberName, 
	EnforceDefaultBillNo = @EnforceDefaultBillNo, HideDetails = @HideDetails, 
	StatusID = @StatusID, LoginID = @LoginID, ClientMachine = @ClientMachine, 
	---------------------- Optional Fields --------------------------------
	BloodGroupID = @BloodGroupID, VillageCode = @VillageCode,MaritalStatusID = @MaritalStatusID,
	CountryID = @CountryID,CareEntryPointID = @CareEntryPointID, 
	TribeID = @TribeID, ReligionID = @ReligionID, BranchID=@BranchID,
	Employer = @Employer, EmployerAddress = @EmployerAddress, ReferringMedicalOfficer = @ReferringMedicalOfficer, 
	NearestDispensary = @NearestDispensary, PreviousAdmissions = @PreviousAdmissions, ChronicDiseases = @ChronicDiseases,
	XrayNumbers=@XrayNumbers,PoliceNotified=@PoliceNotified,InfectiousDiseasesNotified=@InfectiousDiseasesNotified,
	MedicalConditions=@MedicalConditions,ProvisionalDiagnosis=@ProvisionalDiagnosis,CommunityID=@CommunityID,
	EducationLevelID=@EducationLevelID, ReferringFacility = @ReferringFacility

	where PatientNo = @PatientNo
return 0
end
go

/**************************************************************************************************
--1------------------------------------------------------------------------------------------------
exec uspUpdatePatients '0800001', 'Ref.004', 'Moses', 'Mugume', '', '1 Feb 2014', '15M', NULL, NULL, 'Kampala','P.O Box 7370',
			'Farmer', '077609113', 'kutegz@yahoo.com', '1 May 2006', 'MOH', 'NOK Name', '', 'NOK Phone', '17C', 'CASH', '', 
			'', 0, 0, '1A', 'Admin'

exec uspUpdatePatients '0800002', 'Moses', 'Mugume', 'Ken', '1 Feb 1975','15M', NULL, NULL, 'Kampala','P.O Box 7370',
			'Farmer', '077609113', '', '1 May 2006','Treat', 'CT', 1, '1A', 'Kutegz'

***************************************************************************************************/

-- select * from Patients where patientno ='0800001'

-------------DeletePatients--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspDeletePatients')
	drop proc uspDeletePatients
go

create proc uspDeletePatients(
@PatientNo varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @CashBillModesID varchar(10)
declare @AccountBalance money

set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBalance = dbo.FormatMoney(dbo.GetAccountBalance(@CashBillModesID, @PatientNo))

if not exists(select PatientNo from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16, 1, 'Patient No', @PatientNo, 'Patients')	
		return 1
	end
	
if not (@AccountBalance = 0)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to delete has account balance of ' + cast(@AccountBalance as varchar) +'. You can''t delete this Patient.'
		raiserror(@ErrorMSG,16, 1, 'Patient No', @PatientNo)	
		return 1
	end

else
begin tran

delete Accounts where AccountBillModesID = @CashBillModesID and AccountBillNo = @PatientNo
delete Patients where PatientNo = @PatientNo

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
return 0
go

-- exec uspDeletePatients 'YYY'
-- select * from Patients

--------Get Patient-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatient')
	drop proc uspGetPatient
go

create proc uspGetPatient(
@PatientNo varchar(20),
@FirstName varchar(20) = null output,
@LastName varchar(20) = null output,
@BirthDate smalldatetime = null output,
@Phone varchar(30)= null output
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from patients where PatientNo = @PatientNo)
begin
	set @ErrorMSG = 'The Patient No: ' + @PatientNo + ', you are trying to enter does not exist in the registered Patients'
	raiserror(@ErrorMSG,16,1)	
	return 1
end
else
begin

	set @FirstName = (select FirstName  from patients where PatientNo = @PatientNo)
	set @LastName = (select LastName from patients where PatientNo = @PatientNo)
	set @BirthDate = (select BirthDate from patients where PatientNo = @PatientNo)
	set @Phone = (select Phone from patients where PatientNo = @PatientNo)

	select PatientNo, JoinDate, FirstName, LastName,Phone,
	isnull(dbo.GetLastVisitDate(PatientNo),JoinDate) as LastVisitDate,
	dbo.GetMergedNameCode(dbo.GetLookupDataDes(GenderID), GenderID) as Gender, BirthDate, 
	dbo.GetAge(BirthDate, getdate()) as Age, Address, Occupation, Phone, 
	DefaultBillModesID, dbo.GetLookupDataDes(DefaultBillModesID) as DefaultBillModes,
	DefaultBillNo, DefaultMainMemberName, EnforceDefaultBillNo, 
	dbo.GetMergedNameCode(dbo.GetLookupDataDes(StatusID), StatusID) as Status 
	from Patients 
	where PatientNo = @PatientNo

end

return 0

go

--dbo.GetLookupDataDes(StatusID) as MMTType

-- select * from patients
-- exec uspGetPatient '0800001' 

--------Get Patients-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatients')
	drop proc uspGetPatients
go

create proc uspGetPatients(
@PatientNo varchar(20) 
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Patient No', @PatientNo, 'Patients')	
		return 1
	end
else
begin
	select PatientNo, ReferenceNo,NationalIDNo,FirstName, LastName, MiddleName, BirthDate, 	dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.GetAgeInMonths(BirthDate, getdate()) as AgeInMonths, dbo.GetAgeInDays(BirthDate, getdate()) as AgeInDays, 
	dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender, 
	Photo, Fingerprint, BirthPlace, Patients.Address as [Address], Occupation, Patients.Phone as [Phone], Email, Location, 
	NOKName, NOKRelationship, NOKPhone, JoinDate, isnull(dbo.GetFirstVisitDate(PatientNo),JoinDate) as FirstVisitDate, 
	isnull(dbo.GetLastVisitDate(PatientNo),JoinDate) as LastVisitDate, dbo.GetTotalVisits(PatientNo) as TotalVisits, 
	DefaultBillNo, dbo.GetBillName(DefaultBillModesID, DefaultBillNo) as BillCustomerName,
	dbo.GetBillCompanyNo(DefaultBillModesID, DefaultBillNo) as CompanyNo,
	DefaultMemberCardNo, DefaultMainMemberName, EnforceDefaultBillNo, DefaultBillModesID, 
	dbo.GetLookupDataDes(DefaultBillModesID) as DefaultBillModes,
	dbo.GetInsuranceNo(DefaultBillModesID, DefaultBillNo) as InsuranceNo,
	dbo.GetDefaultInsuranceName(DefaultBillModesID, DefaultBillNo) as InsuranceName, 
	dbo.GetSmartCardApplicable(DefaultBillModesID, DefaultBillNo) as SmartCardApplicable,
	dbo.GetAllowOnlyListedMember(DefaultBillNo) as AllowOnlyListedMember,
	dbo.GetCaptureMemberCardNo(DefaultBillNo) as CaptureMemberCardNo,
	dbo.GetCaptureClaimReferenceNo(DefaultBillNo) as CaptureClaimReferenceNo,
	dbo.GetCoPayTypeID(DefaultBillModesID, DefaultBillNo) as CoPayTypeID,
	dbo.GetCoPayPercent(DefaultBillModesID, DefaultBillNo) as CoPayPercent,
	dbo.GetCoPayValue(DefaultBillModesID, DefaultBillNo) as CoPayValue,
	dbo.GetLookupDataDes(dbo.GetCoPayTypeID(DefaultBillModesID, DefaultBillNo)) as CoPayType,
	dbo.FormatMoney(dbo.GetOutstandingBalance(PatientNo)) as OutstandingBalance,
    dbo.FormatMoney(dbo.GetCashAccountBalance(PatientNo)) as CashAccountBalance,
	dbo.GetCombinationCurrentlyOn(PatientNo) as Combination,
	HideDetails, StatusID, dbo.GetLookupDataDes(StatusID) as Status,	
	BloodGroupID, dbo.GetLookupDataDes(BloodGroupID) as BloodGroup, 
	VillageCode,MaritalStatusID, dbo.GetLookupDataDes(MaritalStatusID) as MaritalStatus,
	TribeID, dbo.GetLookupDataDes(TribeID) as Tribe, CareEntryPointID, dbo.GetLookupDataDes(CareEntryPointID) as CareEntryPoint,
	CountryID, dbo.GetLookupDataDes(CountryID) As Country,
	ReligionID, dbo.GetLookupDataDes(ReligionID) as Religion, Employer, EmployerAddress, 
	ReferringMedicalOfficer, NearestDispensary, PreviousAdmissions, 
	dbo.GetLookupDataName(ChronicDiseases) as ChronicDiseases,BranchID,
	dbo.GetLookupDataDes(BranchID) as BranchName,
	XrayNumbers,PoliceNotified,InfectiousDiseasesNotified,
	MedicalConditions,ProvisionalDiagnosis,
	dbo.GetIsPatientOnPackage(PatientNo) as HasPackage,
	dbo.FormatMoney(dbo.GetPatientAccountBalance(PatientNo)) as DebitCashAccountBalance,
	CommunityID, dbo.GetLookupDataDes(CommunityID) as Community,EducationLevelID,dbo.GetLookupDataDes(EducationLevelID) as EducationLevel,
	ReferringFacility
	from Patients 
	where PatientNo = @PatientNo
end

return 0
go

-- select * from Patients
-- exec uspGetPatients '1201516'
-- exec uspGetPatients '160017'
--exec uspGetVisits '160017002'

-- dbo.GetMergedNameCode(Gender.DataDes, GenderID) as Gender, 
-- dbo.GetMergedNameCode(Status.DataDes, StatusID) as Status

--------GetPatientFingerprints-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatientFingerprints')
	drop proc uspGetPatientFingerprints
go

create proc uspGetPatientFingerprints(
@PatientNo varchar(20) = null
)with encryption as

declare @OptionValue tinyint
declare @ActiveStatusID varchar(10)

set @OptionValue = dbo.GetOptionValue('ActivePatientMonths')
set @ActiveStatusID = dbo.GetLookupDataID('Status', 'A')

if (@PatientNo is null)
	begin
		select PatientNo, Fingerprint from Patients 
		where datediff(month, isnull(LastVisitDate, JoinDate), getdate()) <= @OptionValue 
		and StatusID = @ActiveStatusID and not Fingerprint is null
		order by isnull(LastVisitDate, JoinDate) desc
	end
else
	begin
		select PatientNo, Fingerprint from Patients 
		where PatientNo = @PatientNo and not Fingerprint is null
	end

return 0
go

-- select * from Patients
-- exec uspGetPatientFingerprints
-- exec uspGetPatientFingerprints '1313307'
-- exec uspGetPatientFingerprints ''


--------GetLabResultsFingerprints-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabResultsFingerprints')
	drop proc uspGetLabResultsFingerprints
go

create proc uspGetLabResultsFingerprints(@PatientNo varchar(20) = null)
with encryption as

begin
if (@PatientNo is null)
begin
select LabResults.SpecimenNo,Patients.PatientNo, Fingerprint from LabResults
inner join LabRequests on LabRequests.SpecimenNo = LabResults.SpecimenNo
inner join Visits on LabRequests.VisitNo = Visits.VisitNo
inner join Patients on Patients.PatientNo =visits.PatientNo
where VisitDate = (select max(VisitDate) from LabRequests inner join Visits on LabRequests.VisitNo = Visits.VisitNo 
and not Fingerprint is null)
end
end
return 0
go
--------GetPatientPhoneNumber-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatientPhoneNumber')
	drop proc uspGetPatientPhoneNumber
go

create proc uspGetPatientPhoneNumber(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

declare @OptionValue tinyint
declare @ActiveStatusID varchar(10)


set @ActiveStatusID = dbo.GetLookupDataID('Status', 'A')

if not(@StartDate is null) and not(@EndDate is null)
begin
	begin
		select PatientNo, dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,Phone as PhoneNumber,
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age,Address from Patients 
		where  StatusID = @ActiveStatusID and not Phone is null and not Phone ='' and RecordDateTime between @StartDate and @EndDate
		union
			select PatientNo, dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,NOKPhone as PhoneNumber,
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age,Address from Patients 
		where  StatusID = @ActiveStatusID and not NOKPhone is null and not NOKPhone ='' and RecordDateTime between @StartDate and @EndDate
	end
end
return 0
go

-- select * from Patients
-- exec uspGetPatientPhoneNumber '1 SEP 16','1 DEC 16'
-------------- Get Patient By Chronic Diseases -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatientByChronicDiseases')
	drop proc uspGetPatientByChronicDiseases
go

create proc uspGetPatientByChronicDiseases(
@PatientNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select PatientNo, ChronicDiseases, dbo.GetLookupDataName(ChronicDiseases) as ChronicDiseaseName
	from Patients
	where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspGetPatientByChronicDiseases '160017'
****************************/


--------GetPatientNoByBillNo-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatientNoByBillNo')
	drop proc uspGetPatientNoByBillNo
go

create proc uspGetPatientNoByBillNo(
@BillNo varchar(20),
@PatientNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Patients where DefaultBillNo = @BillNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Default Bill No', @BillNo, 'Patients')	
		return 1
	end
else begin set @PatientNo = (select top 1 PatientNo from Patients where DefaultBillNo = @BillNo) end
return 0
go

-- select * from Patients
-- exec uspGetPatientNoByBillNo '123'
-- exec uspGetPatientNoByBillNo null

--------GetPatientNoByMemberCardNo-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatientNoByMemberCardNo')
	drop proc uspGetPatientNoByMemberCardNo
go

create proc uspGetPatientNoByMemberCardNo(
@MemberCardNo varchar(30),
@PatientNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)

if (@MemberCardNo = '') or (@MemberCardNo is null)
	begin
		set @ErrorMSG = 'Member Card No can''t be empty or null!'
		raiserror(@ErrorMSG,16, 1)	
		return 1
	end
else
if not exists(select PatientNo from Patients where DefaultMemberCardNo = @MemberCardNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Default Member Card No', @MemberCardNo, 'Patients')	
		return 1
	end
else begin set @PatientNo = (select top 1 PatientNo from Patients where DefaultMemberCardNo = @MemberCardNo) end
print @PatientNo
return 0
go

-- select * from Patients
-- exec uspGetPatientNoByMemberCardNo 'TPS418/00'
-- exec uspGetPatientNoByMemberCardNo ''
-- exec uspGetPatientNoByMemberCardNo null

--------GetNextPatientID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextPatientID')
	drop proc uspGetNextPatientID
go

create proc uspGetNextPatientID(
@PatientID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @OptionValue varchar(10)
declare @CurrentYear as char(2)
declare @PatientNoPrefix varchar(12)

set @OptionValue = dbo.GetOptionValue('PatientNoPrefix')
set @CurrentYear = right(year(getdate()), 2)

set @PatientNoPrefix = @OptionValue + @CurrentYear

set @PatientID = (select max(PatientID) from Patients where left(PatientNo, len(@PatientNoPrefix)) = @PatientNoPrefix)
set @PatientID = dbo.GetNextAutoNumber('Patients', 'PatientNo', @PatientID)

return 0
go

-- exec uspGetNextPatientID
-- select * from Patients

--------Get Next SelfRequestPatientID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextSelfRequestPatientID')
	drop proc uspGetNextSelfRequestPatientID
go

create proc uspGetNextSelfRequestPatientID(
@PatientID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @OptionValue varchar(10)
declare @CurrentYear as char(2)
declare @SelfRequest as char(4)

set @OptionValue = dbo.GetOptionValue('SelfRequestNoPrefix')
set @CurrentYear = right(year(getdate()), 2)
set @SelfRequest = @OptionValue + @CurrentYear

set @PatientID = (select max(PatientID) from Patients where left(PatientNo, len(@SelfRequest)) = @SelfRequest)
set @PatientID = dbo.GetNextAutoNumber('Patients', 'PatientNo', @PatientID)

return 0

go

-- exec uspGetNextSelfRequestPatientID
-- select * from Patients

--------CountPatientFullName-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountPatientFullName')
	drop proc uspCountPatientFullName
go

create proc uspCountPatientFullName(
@FullName varchar(100),
@Records tinyint = null output
)with encryption as

set @Records = (select count(PatientNo) from Patients 
				where dbo.GetFullName(LastName, MiddleName, FirstName) = @FullName)
set @Records = isnull(@Records, 0)

return 0
go

-- exec uspCountPatientFullName 'Kato Moses'

--------CountPatientInWardAdmissions-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountPatientInWardAdmissions')
	drop proc uspCountPatientInWardAdmissions
go

create proc uspCountPatientInWardAdmissions(
@PatientNo varchar(20),
@Records tinyint = null output
)with encryption as

declare @InWardAdmissionStatusID varchar(10)

set @InWardAdmissionStatusID = dbo.GetLookupDataID('AdmissionStatus', 'I')

set @Records = (select count(AdmissionNo) from Admissions 
				where PatientNo = @PatientNo and AdmissionStatusID = @InWardAdmissionStatusID)
set @Records = isnull(@Records, 0)

return 0
go

-- exec uspCountPatientInWardAdmissions '1509614'
-- exec uspCountPatientInWardAdmissions '1505472'

------------------------------------------------------------------------------------------------------
-------------- PatientsEXT ---------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit PatientsEXT ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditPatientsEXT')
	drop proc uspEditPatientsEXT
go

create proc uspEditPatientsEXT(
@PatientNo varchar(20),
@AlternateNo varchar(20),
@Notes varchar(200)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select PatientNo from PatientsEXT where PatientNo = @PatientNo and AlternateNo = @AlternateNo)
	begin
		update PatientsEXT set Notes = @Notes
		where PatientNo = @PatientNo and AlternateNo = @AlternateNo
		return 0
	end
else
begin
insert into PatientsEXT
(PatientNo, AlternateNo, Notes)
values
(@PatientNo, @AlternateNo, @Notes)
return 0
end
go

/******************************************************************************************************
exec uspEditPatientsEXT '000001BA21078', '1BA21078', 'Notes'
exec uspEditPatientsEXT '000001BA21078', '1BA21045', 'Notes'

exec uspEditPatientsEXT '0800002', 'TR0800002', ''
******************************************************************************************************/
-- select * from PatientsEXT
-- delete from PatientsEXT

-------------- Get PatientsEXT -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatientsEXT')
	drop proc uspGetPatientsEXT
go

create proc uspGetPatientsEXT(
@PatientNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select PatientNo, AlternateNo, Notes from PatientsEXT
	where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspGetPatientsEXT '000001BA21078'
exec uspGetPatientsEXT '0800002'
******************************************************************************************************/
-- select * from PatientsEXT
-- delete from PatientsEXT

------------------------------------------------------------------------------------------------------
------------- BillCustomers --------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

------------Insert BillCustomers----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertBillCustomers')
	drop proc uspInsertBillCustomers
go

create proc uspInsertBillCustomers(
@AccountNo varchar(20),
@BillCustomerName varchar(40),
@BillCustomerTypeID varchar(10),
@InsuranceNo varchar(20),
@ContactPerson varchar(40),
@Address varchar(100),
@Phone varchar(30),
@Fax varchar(100),
@Email varchar(100),
@Website varchar(100),
@LogoPhoto image = null,
@MemberDeclaration varchar(800),
@DoctorDeclaration varchar(800),
@CoPayTypeID varchar(10),
@CoPayPercent decimal(5,2),
@CoPayValue money,
@CreditLimit money,
@AllowOnlyListedMember bit,
@UseCustomFee bit,
@SmartCardApplicable bit,
@CaptureMemberCardNo bit,
@CaptureClaimReferenceNo bit,
@Hidden bit = null,
@AccountStatusID varchar(10)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @AccountID int
declare @CurrentYear as char(2)

if exists(select AccountNo from BillCustomers where AccountNo = @AccountNo)
	begin
		set @ErrorMSG = 'The Account No: ' + @AccountNo + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BillCustomerTypeID)
	begin
		set @ErrorMSG = 'The Bill Customer Type ID: ' + @BillCustomerTypeID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CoPayTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CoPay Type ID', @CoPayTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AccountStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account Status ID', @AccountStatusID, 'Lookup Data')
		return 1
	end

if (not exists(select AccountNo from BillCustomers where AccountNo = @InsuranceNo) and (not (@InsuranceNo is null or @InsuranceNo = '')))
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s and not empty'
		raiserror(@ErrorMSG, 16, 1, 'Insurance No', @InsuranceNo, 'Bill Customers')
		return 1
	end
else if (@InsuranceNo is null or @InsuranceNo = '') begin set @InsuranceNo = null end

begin

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

set @CurrentYear = right(year(getdate()), 2)
set @AccountID = (select max(AccountID) from BillCustomers where substring(AccountNo, 2, 2) = @CurrentYear)
set @AccountID = dbo.GetNextAutoNumber('BillCustomers', 'AccountNo', @AccountID)

insert into BillCustomers
(AccountID ,AccountNo ,BillCustomerName ,BillCustomerTypeID, InsuranceNo, ContactPerson, 
Address, Phone, Fax, Email, Website, LogoPhoto, MemberDeclaration, DoctorDeclaration, 
CoPayTypeID, CoPayPercent, CoPayValue, CreditLimit, AllowOnlyListedMember, UseCustomFee, 
SmartCardApplicable, CaptureMemberCardNo, CaptureClaimReferenceNo, Hidden, AccountStatusID) 
values
(@AccountID ,@AccountNo ,@BillCustomerName ,@BillCustomerTypeID, @InsuranceNo, @ContactPerson, 
@Address, @Phone, @Fax, @Email, @Website, @LogoPhoto, @MemberDeclaration, @DoctorDeclaration, 
@CoPayTypeID, @CoPayPercent, @CoPayValue, @CreditLimit, @AllowOnlyListedMember, @UseCustomFee, 
@SmartCardApplicable, @CaptureMemberCardNo, @CaptureClaimReferenceNo, @Hidden, @AccountStatusID)
return 0
end
go

/************************************************************************************
--1----------------------------------------------------------------------------------
exec uspInsertBillCustomers '0600001A', 'State Wide Insurance Company LTD', 
				'18INS', '', 'MD', 'P.O Box 7370', '077609113', 0, 1

exec uspInsertBillCustomers '0600002A', 'NIC', '18INS', '', '','P.O Box 7370', '077609113', 0
exec uspInsertBillCustomers '0600003A', 'BOU', '18COM', '0600001A', 'CEO','P.O Box 7370', '077609113', 0

************************************************************************************/

-- select * from BillCustomers
-- delete from BillCustomers

------------Update BillCustomers-----------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateBillCustomers')
	drop proc uspUpdateBillCustomers
go

create proc uspUpdateBillCustomers(
@AccountNo varchar(20),
@BillCustomerName varchar(40),
@BillCustomerTypeID varchar(10),
@InsuranceNo varchar(20),
@ContactPerson varchar(40),
@Address varchar(100),
@Phone varchar(30),
@Fax varchar(100),
@Email varchar(100),
@Website varchar(100),
@LogoPhoto image = null,
@MemberDeclaration varchar(800),
@DoctorDeclaration varchar(800),
@CoPayTypeID varchar(10),
@CoPayPercent decimal(5,2),
@CoPayValue money,
@CreditLimit money,
@AllowOnlyListedMember bit,
@UseCustomFee bit,
@SmartCardApplicable bit,
@CaptureMemberCardNo bit,
@CaptureClaimReferenceNo bit,
@Hidden bit = null,
@AccountStatusID varchar(10)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select AccountNo from BillCustomers where AccountNo = @AccountNo)
	begin
		set @ErrorMSG = 'The Account No: %s, you''re trying to update does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, @AccountNo, 'To-Bill Customers')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BillCustomerTypeID)
	begin
		set @ErrorMSG = 'The Bill Customer Type ID: ' + @BillCustomerTypeID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CoPayTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CoPay Type ID', @CoPayTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AccountStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account Status ID', @AccountStatusID, 'Lookup Data')
		return 1
	end

if (not exists(select AccountNo from BillCustomers where AccountNo = @InsuranceNo) and (not (@InsuranceNo is null or @InsuranceNo = '')))
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s and not empty'
		raiserror(@ErrorMSG, 16, 1, 'Insurance No', @InsuranceNo, 'Bill Customers')
		return 1
	end
else if (@InsuranceNo is null or @InsuranceNo = '') begin set @InsuranceNo = null end

begin

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

update BillCustomers set 
BillCustomerName = @BillCustomerName, BillCustomerTypeID = @BillCustomerTypeID, 
InsuranceNo = @InsuranceNo, ContactPerson = @ContactPerson, Address = @Address, Phone = @Phone, 
Fax = @Fax, Email = @Email, Website = @Website, LogoPhoto = @LogoPhoto, 
MemberDeclaration = @MemberDeclaration, DoctorDeclaration = @DoctorDeclaration, 
CoPayTypeID = @CoPayTypeID, CoPayPercent = @CoPayPercent, CoPayValue = @CoPayValue, 
CreditLimit = @CreditLimit, AllowOnlyListedMember = @AllowOnlyListedMember, UseCustomFee = @UseCustomFee, 
SmartCardApplicable = @SmartCardApplicable, CaptureMemberCardNo = @CaptureMemberCardNo, 
CaptureClaimReferenceNo = @CaptureClaimReferenceNo, Hidden = @Hidden, AccountStatusID = @AccountStatusID
where AccountNo = @AccountNo

return 0
end
go

/**********************************************************************************************
--1--------------------------------------------------------------------------------------------
exec uspUpdateBillCustomers '0600001A', 'State Wide Insurance Company LTD', 
				'18INS', '', 'Director', 'P.O Box 7370', '077609113', 1, 0

exec uspUpdateBillCustomers '0600002A', 'NIC', '18INS', '', 'Director', 'P.O Box 7370', '077609113', 0

exec uspUpdateBillCustomers '0600003A', 'BOU', '18INS', '0600001A', 'Director', 'P.O Box 7370', '077609113', 0

**********************************************************************************************/

-- select * from BillCustomers
-- delete from BillCustomers

--1--------Delete BillCustomers---------------------------------------------------

if exists (select * from sysobjects where name = 'uspDeleteBillCustomers')
	drop proc uspDeleteBillCustomers
go

create proc uspDeleteBillCustomers(
@AccountNo varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select AccountNo from BillCustomers where AccountNo = @AccountNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16, 1, 'Account No', @AccountNo, 'To-Bill Customers')	
		return 1
	end

if @AccountNo = 'CASH'
	begin
		set @ErrorMSG = 'Cash Customer can''t be deleted!'
		raiserror(@ErrorMSG,16, 1)	
		return 1
	end

delete BillCustomers where (AccountNo = @AccountNo)

return 0
go

-- exec uspDeleteBillCustomers 'Cash'
-- exec uspDeleteBillCustomers '0600002A'
-- select * from BillCustomers

--------Get BillCustomers-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBillCustomers')
	drop proc uspGetBillCustomers
go

create proc uspGetBillCustomers(
@AccountNo varchar(20) = null output,
@ExcludeCashAccount bit = 0,
@Hidden bit = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @CashID varchar(10)
declare @AccountBillModesID varchar(10)

-------------------------------------------------------------------------------------
set @CashID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

if not (@AccountNo is null)
begin
	--if not exists(select AccountNo from BillCustomers where AccountNo = @AccountNo)
	----begin
	----	set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
	----	raiserror(@ErrorMSG,16, 1, 'Account No', @AccountNo, 'To-Bill Customers')	
	----	return 1
	----end
	begin
		select AccountNo, BillCustomerName, dbo.GetMergedNameCode(BillCustomerName, AccountNo)  as BillCustomerFullName,
		InsuranceNo, dbo.GetBillCustomerName(InsuranceNo) as BillCustomerInsurance,
		dbo.GetBillCustomerFullName(InsuranceNo) as BillCustomerFullInsurance, 
		dbo.FormatMoney(dbo.GetAccountBalance(@AccountBillModesID, AccountNo)) as ACCBalance,
		BillCustomerTypeID, dbo.GetLookupDataDes(BillCustomerTypeID) as BillCustomerType,
		ContactPerson, Address, Phone, Fax, Email, Website, LogoPhoto, MemberDeclaration, 
		DoctorDeclaration, CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
		CoPayPercent, CoPayValue, CreditLimit, AllowOnlyListedMember, UseCustomFee, 
		SmartCardApplicable, CaptureMemberCardNo, CaptureClaimReferenceNo, Hidden,
		AccountStatusID, dbo.GetLookupDataDes(AccountStatusID) as AccountStatus
		from BillCustomers 
		where AccountNo = @AccountNo
		order by BillCustomerName
	end
end
else
if (@AccountNo is null) and (@ExcludeCashAccount = 1)
	begin
		select AccountNo, BillCustomerName, dbo.GetMergedNameCode(BillCustomerName, AccountNo) as BillCustomerFullName,
		InsuranceNo, dbo.GetBillCustomerName(InsuranceNo) as BillCustomerInsurance,
		dbo.GetBillCustomerFullName(InsuranceNo) as BillCustomerFullInsurance,
		BillCustomerTypeID, dbo.GetLookupDataDes(BillCustomerTypeID) as BillCustomerType ,
		ContactPerson, Address, Phone, Fax, Email, Website, LogoPhoto, MemberDeclaration, 
		DoctorDeclaration, CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
		CoPayPercent, CoPayValue, CreditLimit, AllowOnlyListedMember, UseCustomFee, 
		SmartCardApplicable, CaptureMemberCardNo, CaptureClaimReferenceNo, Hidden,
		AccountStatusID, dbo.GetLookupDataDes(AccountStatusID) as AccountStatus
		from BillCustomers 
		where not (AccountNo = dbo.GetLookupDataDes(@CashID)) and Hidden = @Hidden
		order by BillCustomerName
	end
else
if (@AccountNo is null)
	begin
		select AccountNo, BillCustomerName, dbo.GetMergedNameCode(BillCustomerName, AccountNo) as BillCustomerFullName,
		InsuranceNo, dbo.GetBillCustomerName(InsuranceNo) as BillCustomerInsurance,
		dbo.GetBillCustomerFullName(InsuranceNo) as BillCustomerFullInsurance,
		BillCustomerTypeID, dbo.GetLookupDataDes(BillCustomerTypeID) as BillCustomerType ,
		ContactPerson, Address, Phone, Fax, Email, Website, LogoPhoto, MemberDeclaration, 
		DoctorDeclaration, CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
		CoPayPercent, CoPayValue, CreditLimit, AllowOnlyListedMember, UseCustomFee, 
		SmartCardApplicable, CaptureMemberCardNo, CaptureClaimReferenceNo, Hidden,
		AccountStatusID, dbo.GetLookupDataDes(AccountStatusID) as AccountStatus
		from BillCustomers 
		where Hidden = @Hidden
		order by BillCustomerName
	end

return 0

go

-- select * from BillCustomers
-- exec uspGetBillCustomers '100047A'
-- exec uspGetBillCustomers null, 1

-- dbo.GetMergedNameCode(BillCustomerType.DataDes, BillCustomerTypeID) as BillCustomerType

--------GetBillCustomersInsurance-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBillCustomersInsurance')
	drop proc uspGetBillCustomersInsurance
go

create proc uspGetBillCustomersInsurance(
@BillCustomerTypeID varchar(10) = null,
@InsuranceNo varchar(20) = null
)with encryption as

if (not (@BillCustomerTypeID is null) and (@InsuranceNo is null))
	begin
		select AccountNo, BillCustomerName, dbo.GetMergedNameCode(BillCustomerName, AccountNo) as BillCustomerFullName,
		InsuranceNo, dbo.GetBillCustomerName(InsuranceNo) as BillCustomerInsurance,
		dbo.GetBillCustomerFullName(InsuranceNo) as BillCustomerFullInsurance,
		BillCustomerTypeID, dbo.GetLookupDataDes(BillCustomerTypeID) as BillCustomerType ,
		ContactPerson, Address, Phone, AllowOnlyListedMember, UseCustomFee, Hidden
		from BillCustomers 
		where BillCustomerTypeID = @BillCustomerTypeID
	end
else if ((@BillCustomerTypeID is null) and not (@InsuranceNo is null))
	begin
		select AccountNo, BillCustomerName, dbo.GetMergedNameCode(BillCustomerName, AccountNo) as BillCustomerFullName,
		InsuranceNo, dbo.GetBillCustomerName(InsuranceNo) as BillCustomerInsurance,
		dbo.GetBillCustomerFullName(InsuranceNo) as BillCustomerFullInsurance,
		BillCustomerTypeID, dbo.GetLookupDataDes(BillCustomerTypeID) as BillCustomerType,
		ContactPerson, Address, Phone, AllowOnlyListedMember, UseCustomFee, Hidden
		from BillCustomers 
		where InsuranceNo = @InsuranceNo
	end

return 0

go

-- select * from BillCustomers
-- exec uspGetBillCustomersInsurance '18INS'
-- exec uspGetBillCustomersInsurance null, 'JUBILEE'

--------GetNextAccountID-------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextAccountID')
	drop proc uspGetNextAccountID
go

create proc uspGetNextAccountID(
@AccountID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @AccountID = (select max(AccountID) from BillCustomers where substring(AccountNo, 2, 2) = @CurrentYear)
set @AccountID = dbo.GetNextAutoNumber('BillCustomers', 'AccountNo', @AccountID)

return 0

go

-- exec uspGetNextAccountID
-- select * from BillCustomers

------------------------------------------------------------------------------------------------------
-------------- AssociatedBillCustomers ---------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit AssociatedBillCustomers ----------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditAssociatedBillCustomers')
	drop proc uspEditAssociatedBillCustomers
go

create proc uspEditAssociatedBillCustomers(
@AccountNo varchar(20),
@AssociatedBillNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AccountNo from BillCustomers where AccountNo = @AccountNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account No', @AccountNo, 'Bill Customers')	
		return 1
	end

if not exists(select AccountNo from BillCustomers where AccountNo = @AssociatedBillNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Associated Bill No', @AssociatedBillNo, 'Bill Customers')	
		return 1
	end
	
if not (@AccountNo = 'CASH')
	begin
		set @ErrorMSG = 'Only Cash Customer is supported to have ''Associated To-Bill Customer(s)'''
		raiserror(@ErrorMSG,16, 1)	
		return 1
	end
	
if (@AssociatedBillNo = 'CASH')
	begin
		set @ErrorMSG = 'Associated Bill No can''t be ''CASH'''
		raiserror(@ErrorMSG,16, 1)	
		return 1
	end

if exists(select AccountNo from AssociatedBillCustomers where AccountNo = @AccountNo and AssociatedBillNo = @AssociatedBillNo)
	begin return 0 end
else
begin
insert into AssociatedBillCustomers
(AccountNo, AssociatedBillNo)
values
(@AccountNo, @AssociatedBillNo)
return 0
end
go

/******************************************************************************************************
exec uspEditAssociatedBillCustomers 'CASH', 'CASHGEN'
exec uspEditAssociatedBillCustomers 'CASH', 'CASHPRI'
exec uspEditAssociatedBillCustomers 'A130009', 'A130001'
exec uspEditAssociatedBillCustomers 'CASH', 'CASH'

******************************************************************************************************/
-- select * from AssociatedBillCustomers
-- delete from AssociatedBillCustomers

-------------- Get AssociatedBillCustomers -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAssociatedBillCustomers')
	drop proc uspGetAssociatedBillCustomers
go

create proc uspGetAssociatedBillCustomers(
@AccountNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select AccountNo, AssociatedBillNo, dbo.GetBillCustomerFullName(AssociatedBillNo) as AssociatedFullBillCustomer
	from AssociatedBillCustomers where AccountNo = @AccountNo
return 0
end
go

/******************************************************************************************************
exec uspGetAssociatedBillCustomers 'CASH'
exec uspGetAssociatedBillCustomers 'A130009'

******************************************************************************************************/
-- select * from AssociatedBillCustomers
-- delete from AssociatedBillCustomers

------------------------------------------------------------------------------------------------------
-------------- BillCustomFee -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit BillCustomFee --------------------------------------------------------------------


if exists (select * from sysobjects where name = 'uspEditBillCustomFee')
	drop proc uspEditBillCustomFee
go

create proc uspEditBillCustomFee(
@AccountNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@CustomFee money,
@CurrenciesID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)

-------------------------------------------------------------------------
set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')
-------------------------------------------------------------------------

if not exists(select AccountNo from BillCustomers where AccountNo = @AccountNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account No', @AccountNo, 'Bill Customers')	
		return 1
	end

----------------------------------------------------------------------------------------------------------------------

if (@ItemCategoryID = @ServiceID) and 
	(not exists(select ServiceCode from Services where ServiceCode = @ItemCode)) -- Services
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Service Code', @ItemCode, 'Services')	
			return 1
		end

else if (@ItemCategoryID = @DrugID) and 
	(not exists(select DrugNo from Drugs where DrugNo = @ItemCode)) -- Drugs
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Drugs')	
			return 1
		end
	
else if (@ItemCategoryID = @ConsumableID) and 
	(not exists(select ConsumableNo from ConsumableItems where ConsumableNo  = @ItemCode)) -- Consumable Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Consumable Items')	
			return 1
		end

else if (@ItemCategoryID = @ProcedureID) and 
	(not exists(select ProcedureCode from Procedures where ProcedureCode = @ItemCode)) -- Procedures
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ItemCode, 'Procedures')	
			return 1
		end	

else if (@ItemCategoryID = @DentalID) and 
	(not exists(select DentalCode from DentalServices where DentalCode = @ItemCode)) -- DentalServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Dental Code', @ItemCode, 'Dental Services')	
			return 1
		end

else if (@ItemCategoryID = @TheatreID) and 
	(not exists(select TheatreCode from TheatreServices where TheatreCode = @ItemCode)) -- TheatreServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @ItemCode, 'Theatre Services')	
			return 1
		end

else if (@ItemCategoryID = @OpticalID) and 
	(not exists(select OpticalCode from OpticalServices where OpticalCode = @ItemCode)) -- OpticalServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Optical Code', @ItemCode, 'Optical Services')	
			return 1
		end

else if (@ItemCategoryID = @MaternityID) and 
	(not exists(select MaternityCode from MaternityServices where MaternityCode = @ItemCode)) -- MaternityServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @ItemCode, 'Maternity Services')	
			return 1
		end

else if (@ItemCategoryID = @ICUID) and 
	(not exists(select ICUCode from ICUServices where ICUCode = @ItemCode)) -- ICUServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ItemCode, 'ICU Services')	
			return 1
		end

else if (@ItemCategoryID = @TestID) and 
	(not exists(select TestCode from LabTests where TestCode = @ItemCode)) -- Test
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Test Code', @ItemCode, 'Lab Tests')	
			return 1
		end

else if (@ItemCategoryID = @CardiologyID) and 
	(not exists(select ExamCode from CardiologyExaminations where ExamCode = @ItemCode)) -- Cardiology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Cardiology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @RadiologyID) and 
	(not exists(select ExamCode from RadiologyExaminations where ExamCode = @ItemCode)) -- Radiology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Radiology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @PathologyID) and 
	(not exists(select ExamCode from PathologyExaminations where ExamCode = @ItemCode)) -- Pathology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Pathology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @EyeID) and 
	(not exists(select EyeCode from EyeServices where EyeCode = @ItemCode)) -- EyeServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Eye Code', @ItemCode, 'Eye Services')	
			return 1
		end

else if (@ItemCategoryID = @AdmissionID) and 
	(not exists(select BedNo from Beds where BedNo = @ItemCode)) -- Admission
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Bed No', @ItemCode, 'Beds')	
			return 1
		end

else if (@ItemCategoryID = @ExtrasID) and 
	(not exists(select ExtraItemCode from ExtraChargeItems where ExtraItemCode = @ItemCode)) -- Extras
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Extra Item Code', @ItemCode, 'Extra Charge Items')	
			return 1
		end
		
----------------------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CurrenciesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrenciesID, 'Lookup Data')
		return 1
	end

if exists(select AccountNo from BillCustomFee where AccountNo = @AccountNo 
		and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		update BillCustomFee set
		CustomFee = @CustomFee, CurrenciesID = @CurrenciesID
		where AccountNo = @AccountNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
		return 0
	end
else
begin
insert into BillCustomFee
(AccountNo, ItemCode, ItemCategoryID, CustomFee, CurrenciesID)
values
(@AccountNo, @ItemCode, @ItemCategoryID, @CustomFee, @CurrenciesID)
return 0
end
go

/*****************************************************************************************************
exec uspEditBillCustomFee
******************************************************************************************************/
-- select * from BillCustomFee
-- delete from BillCustomFee

-------------- Get BillCustomFee -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBillCustomFee')
	drop proc uspGetBillCustomFee
go

create proc uspGetBillCustomFee(
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@AccountNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not(@AccountNo is null)
begin

	if not exists(select AccountNo from BillCustomFee where AccountNo = @AccountNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Account No', @AccountNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Bill Custom Fee')
			return 1
		end
	else
	begin
		select BillCustomFee.AccountNo, ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, CustomFee, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, UseCustomFee
		from BillCustomFee
		inner join BillCustomers on BillCustomFee.AccountNo = BillCustomers.AccountNo
		where ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and BillCustomFee.AccountNo = @AccountNo
	end
end
else 
if @AccountNo is null
	begin
		select BillCustomFee.AccountNo, ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, CustomFee, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, UseCustomFee
		from BillCustomFee
		inner join BillCustomers on BillCustomFee.AccountNo = BillCustomers.AccountNo
		where ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	end
return 0
go

/******************************************************************************************************
exec uspGetBillCustomFee 'M001', '7D'
exec uspGetBillCustomFee 'M001', '7D', 'CASH'
******************************************************************************************************/
-- select * from BillCustomFee
-- delete from BillCustomFee

------------------------------------------------------------------------------------------------------
-------------- BillExcludedItems ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit BillExcludedItems ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditBillExcludedItems')
	drop proc uspEditBillExcludedItems
go

create proc uspEditBillExcludedItems(
@AccountNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)

-------------------------------------------------------------------------
set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')
-------------------------------------------------------------------------

if @AccountNo = 'CASH'
	begin
		set @ErrorMSG = 'Cash Customer can''t be excluded!'
		raiserror(@ErrorMSG,16, 1)	
		return 1
	end

if not exists(select AccountNo from BillCustomers where AccountNo = @AccountNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account No', @AccountNo, 'Bill Customers')	
		return 1
	end

----------------------------------------------------------------------------------------------------------------------

if (@ItemCategoryID = @ServiceID) and 
	(not exists(select ServiceCode from Services where ServiceCode = @ItemCode)) -- Services
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Service Code', @ItemCode, 'Services')	
			return 1
		end

else if (@ItemCategoryID = @DrugID) and 
	(not exists(select DrugNo from Drugs where DrugNo = @ItemCode)) -- Drugs
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Drugs')	
			return 1
		end
	
else if (@ItemCategoryID = @ConsumableID) and 
	(not exists(select ConsumableNo from ConsumableItems where ConsumableNo  = @ItemCode)) -- Consumable Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Consumable Items')	
			return 1
		end

else if (@ItemCategoryID = @ProcedureID) and 
	(not exists(select ProcedureCode from Procedures where ProcedureCode = @ItemCode)) -- Procedures
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ItemCode, 'Procedures')	
			return 1
		end	

else if (@ItemCategoryID = @DentalID) and 
	(not exists(select DentalCode from DentalServices where DentalCode = @ItemCode)) -- DentalServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Dental Code', @ItemCode, 'Dental Services')	
			return 1
		end

else if (@ItemCategoryID = @TheatreID) and 
	(not exists(select TheatreCode from TheatreServices where TheatreCode = @ItemCode)) -- TheatreServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @ItemCode, 'Theatre Services')	
			return 1
		end

else if (@ItemCategoryID = @OpticalID) and 
	(not exists(select OpticalCode from OpticalServices where OpticalCode = @ItemCode)) -- OpticalServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Optical Code', @ItemCode, 'Optical Services')	
			return 1
		end

else if (@ItemCategoryID = @MaternityID) and 
	(not exists(select MaternityCode from MaternityServices where MaternityCode = @ItemCode)) -- MaternityServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @ItemCode, 'Maternity Services')	
			return 1
		end

else if (@ItemCategoryID = @ICUID) and 
	(not exists(select ICUCode from ICUServices where ICUCode = @ItemCode)) -- ICUServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ItemCode, 'ICU Services')	
			return 1
		end

else if (@ItemCategoryID = @TestID) and 
	(not exists(select TestCode from LabTests where TestCode = @ItemCode)) -- Test
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Test Code', @ItemCode, 'Lab Tests')	
			return 1
		end

else if (@ItemCategoryID = @CardiologyID) and 
	(not exists(select ExamCode from CardiologyExaminations where ExamCode = @ItemCode)) -- Cardiology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Cardiology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @RadiologyID) and 
	(not exists(select ExamCode from RadiologyExaminations where ExamCode = @ItemCode)) -- Radiology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Radiology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @PathologyID) and 
	(not exists(select ExamCode from PathologyExaminations where ExamCode = @ItemCode)) -- Pathology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Pathology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @EyeID) and 
	(not exists(select EyeCode from EyeServices where EyeCode = @ItemCode)) -- EyeServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Eye Code', @ItemCode, 'Eye Services')	
			return 1
		end

else if (@ItemCategoryID = @AdmissionID) and 
	(not exists(select BedNo from Beds where BedNo = @ItemCode)) -- Admission
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Bed No', @ItemCode, 'Beds')	
			return 1
		end

else if (@ItemCategoryID = @ExtrasID) and 
	(not exists(select ExtraItemCode from ExtraChargeItems where ExtraItemCode = @ItemCode)) -- Extras
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Extra Item Code', @ItemCode, 'Extra Charge Items')	
			return 1
		end
		
----------------------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if exists(select AccountNo from BillExcludedItems where AccountNo = @AccountNo 
				and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin return 0 end
else
begin
insert into BillExcludedItems
(AccountNo, ItemCode, ItemCategoryID)
values
(@AccountNo, @ItemCode, @ItemCategoryID)
return 0
end
go

/******************************************************************************************************
exec uspEditBillExcludedItems
******************************************************************************************************/
-- select * from BillExcludedItems
-- delete from BillExcludedItems

-------------- Get BillExcludedItems ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBillExcludedItems')
	drop proc uspGetBillExcludedItems
go

create proc uspGetBillExcludedItems(
@AccountNo varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select AccountNo, ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName,
	ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory
	from BillExcludedItems
	where AccountNo = @AccountNo and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetBillExcludedItems 'SIL', '7D'
******************************************************************************************************/
-- select * from BillExcludedItems
-- delete from BillExcludedItems

--------------------------------------------------------------------------------------------------------
-------------- BillCustomerMembers ---------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------

-------------- Edit BillCustomerMembers ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditBillCustomerMembers')
	drop proc uspEditBillCustomerMembers
go

create proc uspEditBillCustomerMembers(
@MedicalCardNo varchar(20),
@AccountNo varchar(20),
@Surname varchar(20),
@FirstName varchar(20),
@MiddleName varchar(20),
@PolicyStartDate smalldatetime,
@PolicyEndDate smalldatetime,
@CreditLimit money,
@MemberStatusID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AccountNo from BillCustomers where AccountNo  = @AccountNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account No', @AccountNo, 'To- Bill Customers')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @MemberStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Member Status ID', @MemberStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select MedicalCardNo from BillCustomerMembers where MedicalCardNo = @MedicalCardNo and AccountNo = @AccountNo)
	begin
		update BillCustomerMembers set
		Surname = @Surname, FirstName = @FirstName, MiddleName = @MiddleName, PolicyStartDate = @PolicyStartDate, 
		PolicyEndDate = @PolicyEndDate, CreditLimit = @CreditLimit, MemberStatusID = @MemberStatusID, LoginID = @LoginID
		where MedicalCardNo = @MedicalCardNo and AccountNo = @AccountNo
	end
else
	begin
		insert into BillCustomerMembers
		(MedicalCardNo, AccountNo, Surname, FirstName, MiddleName, 
		PolicyStartDate, PolicyEndDate, CreditLimit, MemberStatusID, LoginID)
		values
		(@MedicalCardNo, @AccountNo, @Surname, @FirstName, @MiddleName, 
		@PolicyStartDate, @PolicyEndDate, @CreditLimit, @MemberStatusID, @LoginID)
	return 0
	end
go

/******************************************************************************************************
exec uspEditBillCustomerMembers 'M001', '100026A', 'Kituuku', 'Ivan', '', 
								  '1 Jan 13', '31 Dec 2013', 50000, '1A', 'Admin'

exec uspEditBillCustomerMembers 'MC001/1', '100026A', 'Kituuku', 'Rose', '', 
								  '1 Jan 13', '31 Dec 2013', 0, '1I', 'Admin'

******************************************************************************************************/
-- select * from BillCustomerMembers
-- delete from BillCustomerMembers

-------------- Get BillCustomerMembers --------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBillCustomerMembers')
	drop proc uspGetBillCustomerMembers
go

create proc uspGetBillCustomerMembers(
@MedicalCardNo varchar(20),
@AccountNo varchar(20),
@HideRecordExistsMSG bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if ((@HideRecordExistsMSG = 0) and (not exists(select MedicalCardNo from BillCustomerMembers 
									where MedicalCardNo = @MedicalCardNo and AccountNo = @AccountNo)))
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @MedicalCardNo, 'Account No', @AccountNo, 'To-Bill Customer Members')
		return 1
	end
else
begin
	select MedicalCardNo, AccountNo, Surname, FirstName, MiddleName, 
	dbo.GetBillCustomerName(AccountNo) as BillCustomerName, CreditLimit, 
	dbo.FormatDate(dbo.GetNullDateValue(PolicyStartDate)) as PolicyStartDate,
	dbo.FormatDate(dbo.GetNullDateValue(PolicyEndDate)) as PolicyEndDate,
	MemberStatusID, dbo.GetLookupDataDes(MemberStatusID) as MemberStatus
	from BillCustomerMembers
	where MedicalCardNo = @MedicalCardNo and AccountNo = @AccountNo
return 0
end
go

/******************************************************************************************************
exec uspGetBillCustomerMembers 'M001', '100026A'
exec uspGetBillCustomerMembers 'MC001', '100026A'
exec uspGetBillCustomerMembers 'MC001', '100026A', 1
exec uspGetBillCustomerMembers 'M001', '100026A', 1

******************************************************************************************************/
-- select * from BillCustomerMembers
-- delete from BillCustomerMembers

------------------------------------------------------------------------------------------------------
-------------- MemberBenefits ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert MemberBenefits -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertMemberBenefits')
	drop proc uspInsertMemberBenefits
go

create proc uspInsertMemberBenefits(
@BenefitCode varchar(20),
@BenefitName varchar(100),
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select BenefitCode from MemberBenefits where BenefitCode = @BenefitCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Benefit Code', @BenefitCode)
		return 1
	end 
 	
if not (@ItemCategoryID is null or @ItemCategoryID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Lookup Data')
				return 1
			end
	end
else if (@ItemCategoryID is null or @ItemCategoryID = '')  
begin set @ItemCategoryID = null end

begin
insert into MemberBenefits
(BenefitCode, BenefitName, ItemCategoryID)
values
(@BenefitCode, @BenefitName, @ItemCategoryID)
return 0
end
go

/******************************************************************************************************
exec uspInsertMemberBenefits '', '', ''
******************************************************************************************************/
-- select * from MemberBenefits
-- delete from MemberBenefits

-------------- Update MemberBenefits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateMemberBenefits')
	drop proc uspUpdateMemberBenefits
go

create proc uspUpdateMemberBenefits(
@BenefitCode varchar(20),
@BenefitName varchar(100),
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select BenefitCode from MemberBenefits where BenefitCode = @BenefitCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Benefit Code', @BenefitCode, 'Member Benefits')
		return 1
	end 
 	
if not (@ItemCategoryID is null or @ItemCategoryID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Lookup Data')
				return 1
			end
	end
else if (@ItemCategoryID is null or @ItemCategoryID = '') 
begin set @ItemCategoryID = null end

begin
update MemberBenefits set
BenefitName = @BenefitName, ItemCategoryID = @ItemCategoryID
where BenefitCode = @BenefitCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateMemberBenefits '', '', ''
******************************************************************************************************/
-- select * from MemberBenefits
-- delete from MemberBenefits

-------------- Get MemberBenefits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetMemberBenefits')
	drop proc uspGetMemberBenefits
go

create proc uspGetMemberBenefits(
@BenefitCode varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@BenefitCode is null or @BenefitCode = '') 
begin
	if not exists(select BenefitCode from MemberBenefits where BenefitCode = @BenefitCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Benefit Code', @BenefitCode, 'Member Benefits')
			return 1
		end
	else
	begin
		select BenefitCode, BenefitName, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
		dbo.GetMergedNameCode(dbo.GetLookupDataDes(ItemCategoryID), ItemCategoryID) as ItemFullCategory,
		dbo.GetMergedNameCode(BenefitName, BenefitCode) as BenefitFullName
		from MemberBenefits
		where BenefitCode = @BenefitCode
	end
end
else
begin
	select BenefitCode, BenefitName, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
	dbo.GetMergedNameCode(dbo.GetLookupDataDes(ItemCategoryID), ItemCategoryID) as ItemFullCategory,
		dbo.GetMergedNameCode(BenefitName, BenefitCode) as BenefitFullName
	from MemberBenefits
return 0
end
go

/******************************************************************************************************
exec uspGetMemberBenefits
exec uspGetMemberBenefits '7D'

******************************************************************************************************/
-- select * from MemberBenefits
-- delete from MemberBenefits

------------------------------------------------------------------------------------------------------
-------------- MemberLimits --------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit MemberLimits ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditMemberLimits')
	drop proc uspEditMemberLimits
go

create proc uspEditMemberLimits(
@MedicalCardNo varchar(20),
@AccountNo varchar(20),
@BenefitCode varchar(20),
@MemberLimit money
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select MedicalCardNo from BillCustomerMembers where MedicalCardNo  = @MedicalCardNo and AccountNo  = @AccountNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @MedicalCardNo, 'Account No', @AccountNo, 'To-Bill Customer Members')	
		return 1
	end	
	
if not exists(select BenefitCode from MemberBenefits where BenefitCode = @BenefitCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Benefit Code', @BenefitCode, 'Member Benefits')
		return 1
	end

if exists(select MedicalCardNo from MemberLimits where MedicalCardNo = @MedicalCardNo 
						and AccountNo = @AccountNo and BenefitCode = @BenefitCode)
	begin
		update MemberLimits set MemberLimit = @MemberLimit
		where MedicalCardNo = @MedicalCardNo and AccountNo = @AccountNo and BenefitCode = @BenefitCode
		return 0
	end
else
begin
insert into MemberLimits
(MedicalCardNo, AccountNo, BenefitCode, MemberLimit)
values
(@MedicalCardNo, @AccountNo, @BenefitCode, @MemberLimit)
return 0
end
go

/******************************************************************************************************
exec uspEditMemberLimits 'M001', '100029A', '7S', 12000
exec uspEditMemberLimits 'M001', '100029A', '7S', 8000
exec uspEditMemberLimits 'M001', '100029A', '7T', 18000
exec uspEditMemberLimits 'M001', '100026A', '7T', 20000

******************************************************************************************************/
-- select * from MemberLimits
-- delete from MemberLimits

-------------- Get MemberLimits --------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetMemberLimits')
	drop proc uspGetMemberLimits
go

create proc uspGetMemberLimits(
@MedicalCardNo varchar(20),
@AccountNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select MedicalCardNo, AccountNo, MemberLimit, MemberLimits.BenefitCode, BenefitName
	from MemberLimits
	inner join MemberBenefits on MemberLimits.BenefitCode = MemberBenefits.BenefitCode
	where MedicalCardNo = @MedicalCardNo and AccountNo = @AccountNo
return 0
end
go

/******************************************************************************************************
exec uspGetMemberLimits 'M001', '100029A'
exec uspGetMemberLimits 'M001', '100026A'
******************************************************************************************************/
-- select * from MemberLimits
-- delete from MemberLimits

------------------------------------------------------------------------------------------------------
-------------- Insurances ----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Insurances ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertInsurances')
	drop proc uspInsertInsurances
go

create proc uspInsertInsurances(
@InsuranceNo varchar(20),
@InsuranceName varchar(60),
@ContactPerson varchar(40),
@Address varchar(100),
@Phone varchar(100),
@Fax varchar(100),
@Email varchar(100),
@Website varchar(100),
@LogoPhoto image = null,
@MemberDeclaration varchar(800),
@DoctorDeclaration varchar(800),
@UseCustomFee bit,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
declare @InsuranceID int
declare @CurrentYear as char(2)

if exists(select InsuranceNo from Insurances where InsuranceNo = @InsuranceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Insurance No', @InsuranceNo)
		return 1
	end
begin
	--------------------------------------------------------------------------------------------------------------
	set @CurrentYear = right(year(getdate()),2)
	set @InsuranceID = (select max(InsuranceID) from Insurances where substring(InsuranceNo, 2, 2) = @CurrentYear)
	set @InsuranceID = dbo.GetNextAutoNumber('Insurances', 'InsuranceNo', @InsuranceID)
	--------------------------------------------------------------------------------------------------------------

	insert into Insurances
	(InsuranceID, InsuranceNo, InsuranceName, ContactPerson, Address, Phone, Fax, Email, 
	Website, LogoPhoto, MemberDeclaration, DoctorDeclaration, UseCustomFee, Hidden)
	values
	(@InsuranceID, @InsuranceNo, @InsuranceName, @ContactPerson, @Address, @Phone, @Fax, @Email, 
	@Website, @LogoPhoto, @MemberDeclaration, @DoctorDeclaration, @UseCustomFee, @Hidden)
	return 0
end
go

/******************************************************************************************************
exec uspInsertInsurances 'I11001', 'Jubilee', '', '', '0772609113'
exec uspInsertInsurances 'I11002', 'NIC', '', '', '0772609113', 0, 0
exec uspInsertInsurances 'I11003', 'SWIPCO', '', '', '0772609113', 0

******************************************************************************************************/
-- select * from Insurances
-- delete from Insurances

-------------- Update Insurances ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateInsurances')
	drop proc uspUpdateInsurances
go

create proc uspUpdateInsurances(
@InsuranceNo varchar(20),
@InsuranceName varchar(60),
@ContactPerson varchar(40),
@Address varchar(100),
@Phone varchar(100),
@Fax varchar(100),
@Email varchar(100),
@Website varchar(100),
@LogoPhoto image = null,
@MemberDeclaration varchar(800),
@DoctorDeclaration varchar(800),
@UseCustomFee bit,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select InsuranceNo from Insurances where InsuranceNo = @InsuranceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Insurance No', @InsuranceNo, 'Insurances')
		return 1
	end
begin
	update Insurances set
	InsuranceName = @InsuranceName, ContactPerson = @ContactPerson, Address = @Address, 
	Phone = @Phone, Fax = @Fax, Email = @Email, Website = @Website, LogoPhoto = @LogoPhoto, 
	MemberDeclaration = @MemberDeclaration, DoctorDeclaration = @DoctorDeclaration, 
	UseCustomFee = @UseCustomFee, Hidden = @Hidden
	where InsuranceNo = @InsuranceNo
	return 0
end
go

/******************************************************************************************************
exec uspUpdateInsurances 'I11001', 'Jubilees', 'aaa', 'bbbb', '07726091139999'

******************************************************************************************************/
-- select * from Insurances
-- delete from Insurances

-------------- Get Insurances -----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInsurances')
	drop proc uspGetInsurances
go

create proc uspGetInsurances(
@InsuranceNo varchar(20) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not (@InsuranceNo is null)
begin
	if not exists(select InsuranceNo from Insurances where InsuranceNo = @InsuranceNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Insurance No', @InsuranceNo, 'Insurances')
			return 1
		end
	else
	begin
		select InsuranceNo, InsuranceName, dbo.GetMergedNameCode(InsuranceName, InsuranceNo) as InsuranceFullName,
		ContactPerson, Address, Phone, Fax, Email, Website, LogoPhoto, MemberDeclaration, DoctorDeclaration, UseCustomFee, Hidden
		from Insurances
		where InsuranceNo = @InsuranceNo
	end
end
else
if (@InsuranceNo is null)
begin
	begin
		select InsuranceNo, InsuranceName, dbo.GetMergedNameCode(InsuranceName, InsuranceNo) as InsuranceFullName,
		ContactPerson, Address, Phone, Fax, Email, Website, LogoPhoto, MemberDeclaration, DoctorDeclaration, UseCustomFee, Hidden
		from Insurances
		where Hidden = @Hidden
		order by InsuranceName
	end
end
go

/******************************************************************************************************

exec uspGetInsurances
exec uspGetInsurances 'I11001'

******************************************************************************************************/
-- select * from Insurances
-- delete from Insurances

--------GetNextInsuranceID------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextInsuranceID')
	drop proc uspGetNextInsuranceID
go

create proc uspGetNextInsuranceID(
@InsuranceID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @InsuranceID = (select max(InsuranceID) from Insurances where substring(InsuranceNo, 2, 2) = @CurrentYear)
set @InsuranceID = dbo.GetNextAutoNumber('Insurances', 'InsuranceNo', @InsuranceID)

return 0

go

-- exec uspGetNextInsuranceID
-- select * from Insurances

------------------------------------------------------------------------------------------------------
-------------- InsuranceExclusions -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit InsuranceExclusions --------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditInsuranceExclusions')
	drop proc uspEditInsuranceExclusions
go

create proc uspEditInsuranceExclusions(
@InsuranceNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)

-------------------------------------------------------------------------
set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'R')

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')
-------------------------------------------------------------------------

if not exists(select InsuranceNo from Insurances where InsuranceNo  = @InsuranceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Insurance No', @InsuranceNo, 'Insurances')	
		return 1
	end

----------------------------------------------------------------------------------------------------------------------

if (@ItemCategoryID = @ServiceID) and 
	(not exists(select ServiceCode from Services where ServiceCode = @ItemCode)) -- Services
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Service Code', @ItemCode, 'Services')	
			return 1
		end

else if (@ItemCategoryID = @DrugID) and 
	(not exists(select DrugNo from Drugs where DrugNo = @ItemCode)) -- Drugs
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Drugs')	
			return 1
		end
	
else if (@ItemCategoryID = @ConsumableID) and 
	(not exists(select ConsumableNo from ConsumableItems where ConsumableNo  = @ItemCode)) -- Consumable Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Consumable Items')	
			return 1
		end

else if (@ItemCategoryID = @ProcedureID) and 
	(not exists(select ProcedureCode from Procedures where ProcedureCode = @ItemCode)) -- Procedures
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ItemCode, 'Procedures')	
			return 1
		end	

else if (@ItemCategoryID = @DentalID) and 
	(not exists(select DentalCode from DentalServices where DentalCode = @ItemCode)) -- DentalServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Dental Code', @ItemCode, 'Dental Services')	
			return 1
		end

else if (@ItemCategoryID = @TheatreID) and 
	(not exists(select TheatreCode from TheatreServices where TheatreCode = @ItemCode)) -- TheatreServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @ItemCode, 'Theatre Services')	
			return 1
		end

else if (@ItemCategoryID = @OpticalID) and 
	(not exists(select OpticalCode from OpticalServices where OpticalCode = @ItemCode)) -- OpticalServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Optical Code', @ItemCode, 'Optical Services')	
			return 1
		end

else if (@ItemCategoryID = @MaternityID) and 
	(not exists(select MaternityCode from MaternityServices where MaternityCode = @ItemCode)) -- MaternityServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @ItemCode, 'Maternity Services')	
			return 1
		end

else if (@ItemCategoryID = @ICUID) and 
	(not exists(select ICUCode from ICUServices where ICUCode = @ItemCode)) -- ICUServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ItemCode, 'ICU Services')	
			return 1
		end

else if (@ItemCategoryID = @TestID) and 
	(not exists(select TestCode from LabTests where TestCode = @ItemCode)) -- Test
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Test Code', @ItemCode, 'Lab Tests')	
			return 1
		end

else if (@ItemCategoryID = @CardiologyID) and 
	(not exists(select ExamCode from CardiologyExaminations where ExamCode = @ItemCode)) -- Cardiology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Cardiology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @RadiologyID) and 
	(not exists(select ExamCode from RadiologyExaminations where ExamCode = @ItemCode)) -- Radiology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Radiology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @PathologyID) and 
	(not exists(select ExamCode from PathologyExaminations where ExamCode = @ItemCode)) -- Pathology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Pathology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @EyeID) and 
	(not exists(select EyeCode from EyeServices where EyeCode = @ItemCode)) -- EyeServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Eye Code', @ItemCode, 'Eye Services')	
			return 1
		end

else if (@ItemCategoryID = @AdmissionID) and 
	(not exists(select BedNo from Beds where BedNo = @ItemCode)) -- Admission
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Bed No', @ItemCode, 'Beds')	
			return 1
		end

else if (@ItemCategoryID = @ExtrasID) and 
	(not exists(select ExtraItemCode from ExtraChargeItems where ExtraItemCode = @ItemCode)) -- Extras
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Extra Item Code', @ItemCode, 'Extra Charge Items')	
			return 1
		end
		
----------------------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin return 0 end
else
begin
	insert into InsuranceExclusions
	(InsuranceNo, ItemCode, ItemCategoryID)
	values
	(@InsuranceNo, @ItemCode, @ItemCategoryID)
	return 0
end
go

/******************************************************************************************************
exec uspEditInsuranceExclusions 'I1100101', '10C', '7S'
exec uspEditInsuranceExclusions 'I1100101', 'REV', '7S'
exec uspEditInsuranceExclusions 'I1100101', 'T001', '7T'
exec uspEditInsuranceExclusions 'I1100101', 'T132', '7T'
exec uspEditInsuranceExclusions 'I1100601', 'M001', '7D'
exec uspEditInsuranceExclusions 'I1100601', 'R001', '7R'

******************************************************************************************************/

-- select * from InsuranceExclusions
-- delete from InsuranceExclusions

-------------- Get InsuranceExclusions -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInsuranceExclusions')
	drop proc uspGetInsuranceExclusions
go

create proc uspGetInsuranceExclusions(
@InsuranceNo varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select InsuranceNo, ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName,
	ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory
	from InsuranceExclusions
	where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetInsuranceExclusions 'I1100101', '7S'
exec uspGetInsuranceExclusions 'I1100101', '7T'
******************************************************************************************************/
-- select * from InsuranceExclusions
-- delete from InsuranceExclusions

------------------------------------------------------------------------------------------------------
-------------- InsurancePolicies ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert InsurancePolicies --------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertInsurancePolicies')
	drop proc uspInsertInsurancePolicies
go

create proc uspInsertInsurancePolicies(
@PolicyNo varchar(20),
@InsuranceNo varchar(20),
@PolicyName varchar(40),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @PolicyID int

declare @PaddingLEN tinyint

declare @PassedPolicyID int
declare @PassedPolicyNo varchar(20)
declare @PassedInsuranceNo varchar(20)

if exists(select PolicyNo from InsurancePolicies where PolicyNo = @PolicyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Policy No', @PolicyNo)
		return 1
	end

if not exists(select InsuranceNo from Insurances where InsuranceNo  = @InsuranceNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Insurance No', @InsuranceNo, 'Insurances')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
	----------------------------------------------------------------------------------------------------------

	select @PaddingLEN = PaddingLEN from AutoNumbers 
			where ObjectName = 'InsurancePolicies' and AutoColumnName = 'PolicyNo'

	set @PassedInsuranceNo = ltrim(rtrim(substring(@PolicyNo, 1, len(@PolicyNo) - @PaddingLEN)))

	if (@PassedInsuranceNo = @InsuranceNo)

	begin

		set @PassedPolicyID = 1
		set @PassedPolicyNo = @PolicyNo

		set @PassedPolicyNo = ltrim(rtrim(substring(@PassedPolicyNo, len(@PassedInsuranceNo) + 1, @PaddingLEN)))

		if isnumeric(@PassedPolicyNo) = 1 set @PassedPolicyID = @PassedPolicyNo
		else set @PassedPolicyID = 1

		set @PolicyID = (select max(PolicyID) from InsurancePolicies where InsuranceNo = @InsuranceNo)
		set @PolicyID = dbo.GetNextAutoNumber('InsurancePolicies', 'PolicyNo', @PolicyID)

		if @PassedPolicyID < @PolicyID set @PolicyID = @PassedPolicyID
		if @PassedPolicyID > @PolicyID set @PolicyID = @PassedPolicyID

	end else set @PolicyID = 1

	----------------------------------------------------------------------------------------------------------------

	insert into InsurancePolicies
	(PolicyID, PolicyNo, InsuranceNo, PolicyName, LoginID)
	values
	(@PolicyID, @PolicyNo, @InsuranceNo, @PolicyName, @LoginID)
	return 0
end
go

/******************************************************************************************************
exec uspInsertInsurancePolicies 'I1100101', 'I11001', 'JUB Class A', 'Admin'
exec uspInsertInsurancePolicies 'I1100102', 'I11001', 'JUB Class B', 'Admin'
exec uspInsertInsurancePolicies 'I1100103', 'I11001', 'JUB Class C', 'Admin'

exec uspInsertInsurancePolicies 'I1100201', 'I11002', 'UAP Class A', 'Admin'

******************************************************************************************************/
-- select * from Insurances
-- select * from InsurancePolicies
-- delete from InsurancePolicies

-------------- Update InsurancePolicies -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateInsurancePolicies')
	drop proc uspUpdateInsurancePolicies
go

create proc uspUpdateInsurancePolicies(
@PolicyNo varchar(20),
@InsuranceNo varchar(20),
@PolicyName varchar(40),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PolicyNo from InsurancePolicies where PolicyNo = @PolicyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Policy No', @PolicyNo, 'Insurance Policies')
		return 1
	end

if not exists(select InsuranceNo from Insurances where InsuranceNo  = @InsuranceNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Insurance No', @InsuranceNo, 'Insurances')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
	update InsurancePolicies set --InsuranceNo = @InsuranceNo, 
	PolicyName = @PolicyName, LoginID = @LoginID
	where PolicyNo = @PolicyNo
	return 0
end
go

/******************************************************************************************************
exec uspUpdateInsurancePolicies 'I1100201', 'I11002', 'UAP Class AA', 'Admin'

******************************************************************************************************/
-- select * from InsurancePolicies
-- delete from InsurancePolicies

-------------- Get InsurancePolicies -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInsurancePolicies')
	drop proc uspGetInsurancePolicies
go

create proc uspGetInsurancePolicies(
@PolicyNo varchar(20) = null,
@InsuranceNo varchar(20)= null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@PolicyNo is null) and (@InsuranceNo is null))
begin
	if not exists(select PolicyNo from InsurancePolicies where PolicyNo = @PolicyNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Policy No', @PolicyNo, 'Insurance Policies')
			return 1
		end
	else
	begin
		select PolicyNo, InsurancePolicies.InsuranceNo, PolicyName, InsuranceName, 
		dbo.GetMergedNameCode(PolicyName,PolicyNo) as InsurancePolicyFullName
		from InsurancePolicies
		inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo	
		where PolicyNo = @PolicyNo
	end
end
else
if ((@PolicyNo is null) and not (@InsuranceNo is null))
begin
	select PolicyNo, InsurancePolicies.InsuranceNo, PolicyName, InsuranceName, 
		dbo.GetMergedNameCode(PolicyName,PolicyNo) as InsurancePolicyFullName
	from InsurancePolicies
	inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo			
	where InsurancePolicies.InsuranceNo = @InsuranceNo
end
else
if ((@PolicyNo is null) and (@InsuranceNo is null))
begin
	select PolicyNo, InsurancePolicies.InsuranceNo, PolicyName, InsuranceName, 
		dbo.GetMergedNameCode(PolicyName,PolicyNo) as InsurancePolicyFullName
	from InsurancePolicies
	inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo			
end

return 0

go

/******************************************************************************************************
exec uspGetInsurancePolicies 'I1100201'
exec uspGetInsurancePolicies null, 'I11002'
exec uspGetInsurancePolicies

******************************************************************************************************/
-- select * from InsurancePolicies
-- delete from InsurancePolicies

--------Get NextPolicyID -----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextPolicyID')
	drop proc uspGetNextPolicyID
go

create proc uspGetNextPolicyID(
@InsuranceNo varchar(20),
@PolicyID int = null output
)with encryption as

set @PolicyID = (select max(PolicyID) from InsurancePolicies where InsuranceNo = @InsuranceNo)
set @PolicyID = dbo.GetNextAutoNumber('InsurancePolicies', 'PolicyNo', @PolicyID)

return 0

go

-- exec uspGetNextPolicyID 'I11001'
-- select * from InsurancePolicies where InsuranceNo = 'I11001'

------------------------------------------------------------------------------------------------------
-------------- Companies -----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Companies ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertCompanies')
	drop proc uspInsertCompanies
go

create proc uspInsertCompanies(
@CompanyNo varchar(20),
@CompanyName varchar(60),
@ContactPerson varchar(100),
@ContractStartDate smalldatetime,
@ContractEndDate smalldatetime,
@Address varchar(200),
@Phone varchar(30)
)with encryption as

declare @ErrorMSG varchar(200)
declare @CompanyID int
declare @CurrentYear as char(2)

if exists(select CompanyNo from Companies where CompanyNo = @CompanyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Company No', @CompanyNo)
		return 1
	end

begin
	--------------------------------------------------------------------------------------------------------------
	set @CurrentYear = right(year(getdate()),2)
	set @CompanyID = (select max(CompanyID) from Companies where substring(CompanyNo, 2, 2) = @CurrentYear)
	set @CompanyID = dbo.GetNextAutoNumber('Companies', 'CompanyNo', @CompanyID)
	--------------------------------------------------------------------------------------------------------------

	insert into Companies
	(CompanyID, CompanyNo, CompanyName, ContactPerson, ContractStartDate, ContractEndDate, Address, Phone)
	values
	(@CompanyID, @CompanyNo, @CompanyName, @ContactPerson, @ContractStartDate, @ContractEndDate, @Address, @Phone)
	return 0
end
go

/******************************************************************************************************
exec uspInsertCompanies 'C11001', 'SyncSoft INTERNATIONAL LTD', 'CEO', 'Kampala', '0772609113'
exec uspInsertCompanies 'C11002', 'ClinicMaster Software', 'CEO', 'Kampala', '0772609113'

******************************************************************************************************/
-- select * from Companies
-- delete from Companies

-------------- Update Companies ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateCompanies')
	drop proc uspUpdateCompanies
go

create proc uspUpdateCompanies(
@CompanyNo varchar(20),
@CompanyName varchar(60),
@ContactPerson varchar(100),
@ContractStartDate smalldatetime,
@ContractEndDate smalldatetime,
@Address varchar(200),
@Phone varchar(30)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select CompanyNo from Companies where CompanyNo = @CompanyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Company No', @CompanyNo, 'Companies')
		return 1
	end

begin
	update Companies set
	CompanyName = @CompanyName, ContactPerson = @ContactPerson, ContractStartDate = @ContractStartDate, 
	ContractEndDate = @ContractEndDate, Address = @Address, Phone = @Phone
	where CompanyNo = @CompanyNo
	return 0
end
go

/******************************************************************************************************
exec uspUpdateCompanies 'C11002', 'ClinicMaster Software1', 'CEO1', 'Kampala1', '07726091131'

******************************************************************************************************/
-- select * from Companies
-- delete from Companies

-------------- Get Companies -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCompanies')
	drop proc uspGetCompanies
go

create proc uspGetCompanies(
@CompanyNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@CompanyNo is null)
begin
	if not exists(select CompanyNo from Companies where CompanyNo = @CompanyNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Company No', @CompanyNo, 'Companies')
			return 1
		end
	else
	begin
		select CompanyNo, CompanyName, dbo.GetMergedNameCode(CompanyName, CompanyNo) as CompanyFullName,
		ContactPerson, ContractStartDate, ContractEndDate, Address, Phone
		from Companies
		where CompanyNo = @CompanyNo
	end
end
else
if (@CompanyNo is null)
begin
	begin
		select CompanyNo, CompanyName, dbo.GetMergedNameCode(CompanyName, CompanyNo) as CompanyFullName,
		ContactPerson, ContractStartDate, ContractEndDate, Address, Phone
		from Companies
		order by CompanyName
	end
end
go

/******************************************************************************************************
exec uspGetCompanies
exec uspGetCompanies 'C11002'

******************************************************************************************************/
-- select * from Companies
-- delete from Companies

--------GetNextCompanyID--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextCompanyID')
	drop proc uspGetNextCompanyID
go

create proc uspGetNextCompanyID(
@CompanyID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @CompanyID = (select max(CompanyID) from Companies where substring(CompanyNo, 2, 2) = @CurrentYear)
set @CompanyID = dbo.GetNextAutoNumber('Companies', 'CompanyNo', @CompanyID)

return 0

go

-- exec uspGetNextCompanyID
-- select * from Companies

------------------------------------------------------------------------------------------------------
-------------- InsuranceSchemes ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert InsuranceSchemes ---------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertInsuranceSchemes')
	drop proc uspInsertInsuranceSchemes
go

create proc uspInsertInsuranceSchemes(
@CompanyNo varchar(20),
@PolicyNo varchar(20),
@SchemeJoinDate smalldatetime,
@SchemeStartDate smalldatetime,
@SchemeEndDate smalldatetime,
@CoPayTypeID varchar(10),
@CoPayPercent decimal(5,2),
@CoPayValue money,
@AnnualPremium money,
@MemberPremium money,
@SmartCardApplicable bit,
@SchemeStatusID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select CompanyNo from Companies where CompanyNo = @CompanyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Company No', @CompanyNo, 'Companies')
		return 1
	end

if not exists(select PolicyNo from InsurancePolicies where PolicyNo  = @PolicyNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Policy No', @PolicyNo, 'Insurance Policies')
		return 1
	end

if exists(select CompanyNo from InsuranceSchemes where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CoPayTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CoPay Type ID', @CoPayTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @SchemeStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Scheme Status ID', @SchemeStatusID, 'Lookup Data')
		return 1
	end

begin
insert into InsuranceSchemes
(CompanyNo, PolicyNo, SchemeJoinDate, SchemeStartDate, SchemeEndDate, CoPayTypeID, CoPayPercent, 
CoPayValue, AnnualPremium, MemberPremium, SmartCardApplicable, SchemeStatusID, LoginID)
values
(@CompanyNo, @PolicyNo, @SchemeJoinDate, @SchemeStartDate, @SchemeEndDate, @CoPayTypeID, @CoPayPercent, 
@CoPayValue, @AnnualPremium, @MemberPremium, @SmartCardApplicable, @SchemeStatusID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertInsuranceSchemes 'C11001', 'I1100101', 'Jan 1, 2011', 'Jan 1, 2011', 
								'Dec 31, 2011', '44NA', 0.00, 0, 0, '1A', 'Admin'

exec uspInsertInsuranceSchemes 'C11001', 'I1100102', 'Jan 1, 2011', 'Jan 1, 2011', 
								'Dec 31, 2011', '44NA', 0.00, 0, 1, '1A', 'Admin'

exec uspInsertInsuranceSchemes 'C11002', 'I1100101', 'Jan 1, 2011', 'Jan 1, 2011', 
								'Dec 31, 2011', '44PCT', 10.5, 0, 0, '1A', 'Admin'

exec uspInsertInsuranceSchemes 'C11002', 'I1100201', 'Jan 1, 2011', 'Jan 1, 2011', 
								'Dec 31, 2011', '44VAL', 0.00, 5000, 0, '1A', 'Admin'

******************************************************************************************************/
-- select * from InsuranceSchemes
-- delete from InsuranceSchemes

-------------- Update InsuranceSchemes -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateInsuranceSchemes')
	drop proc uspUpdateInsuranceSchemes
go

create proc uspUpdateInsuranceSchemes(
@CompanyNo varchar(20),
@PolicyNo varchar(20),
@SchemeJoinDate smalldatetime,
@SchemeStartDate smalldatetime,
@SchemeEndDate smalldatetime,
@CoPayTypeID varchar(10),
@CoPayPercent decimal(5,2),
@CoPayValue money,
@AnnualPremium money,
@MemberPremium money,
@SmartCardApplicable bit,
@SchemeStatusID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

declare @AutoRenewSchemeMembers bit
declare @PreviousSchemeStartDate smalldatetime
declare @PreviousSchemeEndDate smalldatetime
declare @ActiveStatusID varchar(10)

-----------------------------------------------------------------------------------------------------------------------------------
if (dbo.GetOptionValue('AutoRenewSchemeMembers') > 0)
set @AutoRenewSchemeMembers = 1 else set @AutoRenewSchemeMembers = 0

set @PreviousSchemeStartDate = (select SchemeStartDate from InsuranceSchemes where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo)
set @PreviousSchemeEndDate = (select SchemeEndDate from InsuranceSchemes where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo)

set @ActiveStatusID = dbo.GetLookupDataID('Status', 'A')
-----------------------------------------------------------------------------------------------------------------------------------

if not exists(select CompanyNo from InsuranceSchemes where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Company No', @CompanyNo, 'Policy No', @PolicyNo, 'Insurance Schemes')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CoPayTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CoPay Type ID', @CoPayTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @SchemeStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Scheme Status ID', @SchemeStatusID, 'Lookup Data')
		return 1
	end

begin
update InsuranceSchemes set
SchemeJoinDate = @SchemeJoinDate, SchemeStartDate = @SchemeStartDate, SchemeEndDate = @SchemeEndDate, 
CoPayTypeID = @CoPayTypeID, CoPayPercent = @CoPayPercent, CoPayValue = @CoPayValue, 
AnnualPremium = @AnnualPremium, MemberPremium = @MemberPremium, SmartCardApplicable = @SmartCardApplicable, 
SchemeStatusID = @SchemeStatusID, LoginID = @LoginID
where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo

----------------------------------------------------------------------------------------------------------------------------------------
if (@AutoRenewSchemeMembers = 1 and not @PreviousSchemeStartDate = @SchemeStartDate) 
	or (@AutoRenewSchemeMembers = 1 and not @PreviousSchemeEndDate = @SchemeEndDate)
begin
	update SchemeMembers set PolicyStartDate = @SchemeStartDate, PolicyEndDate = @SchemeEndDate
	where MemberStatusID = @ActiveStatusID and CompanyNo = @CompanyNo and PolicyNo = @PolicyNo
end
----------------------------------------------------------------------------------------------------------------------------------------
return 0
end
go

/******************************************************************************************************
exec uspUpdateInsuranceSchemes 'C11002', 'I1100201', 'Jan 11, 2011', 'Jan 11, 2011', 
								'Dec 11, 2011', '44PCT', 10, 0, 0, '1I', 'Debbie'

******************************************************************************************************/
-- select * from InsuranceSchemes
-- delete from InsuranceSchemes

-------------- Get InsuranceSchemes -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInsuranceSchemes')
	drop proc uspGetInsuranceSchemes
go

create proc uspGetInsuranceSchemes(
@CompanyNo varchar(20) = null,
@PolicyNo varchar(20) = null,
@InsuranceNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@CompanyNo is null) and not (@PolicyNo is null) and (@InsuranceNo is null))
begin
	if not exists(select CompanyNo from InsuranceSchemes where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Company No', @CompanyNo, 'Policy No', @PolicyNo, 'Insurance Schemes')
			return 1
		end
	else
	begin
		select InsuranceSchemes.CompanyNo, CompanyName,
		dbo.GetMergedNameCode(CompanyName, InsuranceSchemes.CompanyNo) as CompanyFullName,
		InsuranceSchemes.PolicyNo, PolicyName, InsurancePolicies.InsuranceNo, InsuranceName, 
		SchemeJoinDate, SchemeStartDate, SchemeEndDate, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
		CoPayValue, AnnualPremium, MemberPremium, SmartCardApplicable, 
		SchemeStatusID, dbo.GetLookupDataDes(SchemeStatusID) as SchemeStatus
		from InsuranceSchemes
		inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
		inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
		inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
		where InsuranceSchemes.CompanyNo = @CompanyNo and InsuranceSchemes.PolicyNo = @PolicyNo
	end	
end
else
if ((@CompanyNo is null) and (@PolicyNo is null) and not (@InsuranceNo is null))
begin
	select distinct InsurancePolicies.InsuranceNo, InsuranceSchemes.PolicyNo, PolicyName
	from InsuranceSchemes
	inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
	inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
	where InsurancePolicies.InsuranceNo = @InsuranceNo
end
else
if ((@CompanyNo is null) and (@PolicyNo is null) and (@InsuranceNo is null))
begin
	select InsuranceSchemes.CompanyNo, CompanyName,
	dbo.GetMergedNameCode(CompanyName, InsuranceSchemes.CompanyNo) as CompanyFullName,
	InsuranceSchemes.PolicyNo, PolicyName, InsurancePolicies.InsuranceNo, InsuranceName, 
	SchemeJoinDate, SchemeStartDate, SchemeEndDate,
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
	CoPayValue, AnnualPremium, MemberPremium, SmartCardApplicable, 
	SchemeStatusID, dbo.GetLookupDataDes(SchemeStatusID) as SchemeStatus
	from InsuranceSchemes
	inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
	inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
	inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo		
end

return 0

go

/**********************************************************************************************************
exec uspGetInsuranceSchemes  'C11002', 'I1100201'
exec uspGetInsuranceSchemes  null, null, 'I11002'
exec uspGetInsuranceSchemes 

***********************************************************************************************************/
-- select * from InsuranceSchemes
-- delete from InsuranceSchemes

-------------- Get Total Member Premium Balance -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTotalMemberPremiumBalance')
	drop proc uspGetTotalMemberPremiumBalance
go

create proc uspGetTotalMemberPremiumBalance(
@PatientNo varchar(20),
@CompanyNo varchar(20), 
@RemainingBalance money = null output
)with encryption as

begin
-------------------------------------------------------------------------------------------------------------------
declare @MainMemberNo varchar(20)
declare @PolicyNo varchar(20)
declare @TotalConsumed decimal
declare @AnnualPremium decimal
-------------------------------------------------------------------------------------------------------------------
set @MainMemberNo = (select TOP 1 MainMemberNo from SchemeMembers
inner join claims on SchemeMembers.MedicalCardNo= claims.MedicalCardNo
where PatientNo =@PatientNo Order By SchemeMembers.RecordDateTime Desc)
-------------------------------------------------------------------------------------------------------------------
set @PolicyNo=( select TOP 1 PolicyNo from SchemeMembers
inner join claims on SchemeMembers.MedicalCardNo= claims.MedicalCardNo
where PatientNo =@PatientNo and CompanyNo =@CompanyNo Order By SchemeMembers.RecordDateTime Desc)
-------------------------------------------------------------------------------------------------------------------
set @AnnualPremium =isnull((select MemberPremium from InsuranceSchemes where CompanyNo =@CompanyNo and PolicyNo =@PolicyNo),0)
-------------------------------------------------------------------------------------------------------------------
set @TotalConsumed =isnull((select sum(Amount) as AmountUsed from ClaimDetails
inner join Claims on ClaimDetails.ClaimNo= Claims.ClaimNo
inner join SchemeMembers on Claims.MedicalCardNo = SchemeMembers.MedicalCardNo
inner join InsuranceSchemes on SchemeMembers.CompanyNo = InsuranceSchemes.CompanyNo and SchemeMembers.PolicyNo = InsuranceSchemes.PolicyNo
where SchemeMembers.CompanyNo =@CompanyNo and MainMemberNo =@MainMemberNo and Claims.RecordDateTime between SchemeMembers.PolicyStartDate and SchemeMembers.PolicyEndDate),0)
-------------------------------------------------------------------------------------------------------------------
set @RemainingBalance =(@AnnualPremium -@TotalConsumed)
-------------------------------------------------------------------------------------------------------------------
end
return 0
go

-------------- Get InsuranceSchemesInsurances -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInsuranceSchemesInsurances')
	drop proc uspGetInsuranceSchemesInsurances
go

create proc uspGetInsuranceSchemesInsurances
with encryption as

declare @ErrorMSG varchar(200)
begin
	select distinct InsurancePolicies.InsuranceNo, InsuranceName, 
	dbo.GetMergedNameCode(InsuranceName, InsurancePolicies.InsuranceNo) as InsuranceFullName
	from InsuranceSchemes
	inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
	inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
	order by InsuranceName
return 0
end

go

/******************************************************************************************************
exec uspGetInsuranceSchemesInsurances

*******************************************************************************************************/
-- select * from InsuranceSchemes
-- delete from InsuranceSchemes

-------------- Get InsuranceSchemesCompanies -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInsuranceSchemesCompanies')
	drop proc uspGetInsuranceSchemesCompanies
go

create proc uspGetInsuranceSchemesCompanies
with encryption as

declare @ErrorMSG varchar(200)
begin
	select distinct InsuranceSchemes.CompanyNo, CompanyName,
	dbo.GetMergedNameCode(CompanyName, InsuranceSchemes.CompanyNo) as CompanyFullName,RecordDateTime
	from InsuranceSchemes
	inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
	order by CompanyName,RecordDateTime desc
return 0
end

go

/******************************************************************************************************
exec uspGetInsuranceSchemesCompanies

******************************************************************************************************/
-- select * from InsuranceSchemes
-- delete from InsuranceSchemes

-------------- Get InsuranceSchemesPolicies -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInsuranceSchemesPolicies')
	drop proc uspGetInsuranceSchemesPolicies
go

create proc uspGetInsuranceSchemesPolicies
with encryption as

declare @ErrorMSG varchar(200)
begin
	select distinct InsuranceSchemes.PolicyNo, PolicyName, InsuranceName, 
	dbo.GetMergedNameCode(InsuranceName, PolicyName) as InsurancePolicyName
	from InsuranceSchemes
	inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
	inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
	order by InsuranceName, PolicyName
return 0
end

go

/******************************************************************************************************
exec uspGetInsuranceSchemesPolicies

******************************************************************************************************/
-- select * from InsuranceSchemes
-- delete from InsuranceSchemes

-------------- Get Member Premium Usage Balance -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetMemberPremiumUsageBalance')
	drop proc uspGetMemberPremiumUsageBalance
go

create proc uspGetMemberPremiumUsageBalance(
@MedicalCardNo varchar(20),
@RemainingBalance money = null output
)with encryption as

begin
-------------------------------------------------------------------------------------------------------------------

declare @MainMemberNo varchar(20)
declare @PolicyNo varchar(20)
declare @CompanyNo varchar(20)
declare @TotalConsumedOPD decimal
declare @TotalConsumedIPD decimal
declare @AnnualPremium decimal

-------------------------------------------------------------------------------------------------------------------
set @MainMemberNo = (select  MainMemberNo from SchemeMembers where MedicalCardNo =@MedicalCardNo)
-------------------------------------------------------------------------------------------------------------------
set @PolicyNo=( select PolicyNo from SchemeMembers where MedicalCardNo =@MedicalCardNo)
-------------------------------------------------------------------------------------------------------------------
set @CompanyNo=( select CompanyNo from SchemeMembers where MedicalCardNo =@MedicalCardNo)
-------------------------------------------------------------------------------------------------------------------
set @AnnualPremium =isnull((select MemberPremium from InsuranceSchemes where CompanyNo =@CompanyNo and PolicyNo =@PolicyNo),0)
-------------------------------------------------------------------------------------------------------------------


set @TotalConsumedOPD =isnull((select sum(dbo.GetInvoiceItemBalanceAmount(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)) 
as InvoiceAmount from InvoiceDetails
inner join Invoices on InvoiceDetails.InvoiceNo =Invoices.InvoiceNo
inner join Visits on InvoiceDetails.VisitNo = Visits.VisitNo
inner join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
where MainMemberNo = @MainMemberNo and Invoices.InvoiceDate between PolicyStartDate and PolicyEndDate),0)


set @TotalConsumedIPD = isnull((select sum(dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)) as InvoiceAmount 
from ExtraBillItems
inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
inner join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
where MainMemberNo = @MainMemberNo and ExtraBillItems.RecordDateTime between PolicyStartDate and PolicyEndDate),0)


-------------------------------------------------------------------------------------------------------------------
if (dbo.GetOptionValue('EnforceCreditLimitOnInPatientAndOutPatient') > 0)
begin
set @RemainingBalance =(@AnnualPremium -@TotalConsumedOPD)
end
else
begin
set @RemainingBalance =(@AnnualPremium -(@TotalConsumedOPD + @TotalConsumedIPD))
end

-------------------------------------------------------------------------------------------------------------------
end
return 0
go

------ exec uspGetMemberPremiumUsageBalance '170000500'


--------IsSchemeMember-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspIsSchemeMember')
drop proc uspIsSchemeMember
go

create proc uspIsSchemeMember(
@MedicalCardNo varchar(20),
@Records tinyint = null output
)with encryption as

set @Records = (select count(MedicalCardNo) from SchemeMembers where MedicalCardNo =@MedicalCardNo)

set @Records = isnull(@Records, 0)

return 0
go


--select * from SchemeMembers
---exec uspIsSchemeMember '170000100'

------------------------------------------------------------------------------------------------------
-------------- PolicyLimits --------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit PolicyLimits ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditPolicyLimits')
	drop proc uspEditPolicyLimits
go

create proc uspEditPolicyLimits(
@CompanyNo varchar(20),
@PolicyNo varchar(20),
@BenefitCode varchar(20),
@PolicyLimit money
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select CompanyNo from InsuranceSchemes where CompanyNo  = @CompanyNo and PolicyNo  = @PolicyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Company No', @CompanyNo, 'Policy No', @PolicyNo, 'Insurance Schemes')	
		return 1
	end
	
if not exists(select BenefitCode from MemberBenefits where BenefitCode = @BenefitCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Benefit Code', @BenefitCode, 'Member Benefits')
		return 1
	end

if exists(select CompanyNo from PolicyLimits where CompanyNo = @CompanyNo and 
							PolicyNo = @PolicyNo and BenefitCode = @BenefitCode)
	begin
		update PolicyLimits set PolicyLimit = @PolicyLimit
		where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo and BenefitCode = @BenefitCode
		return 0
	end
else
begin
insert into PolicyLimits
(CompanyNo, PolicyNo, BenefitCode, PolicyLimit)
values
(@CompanyNo, @PolicyNo, @BenefitCode, @PolicyLimit)
return 0
end
go


/******************************************************************************************************
exec uspEditPolicyLimits 'C11033', 'JUBILEE01', '7S', 12000
exec uspEditPolicyLimits 'C11033', 'JUBILEE01', '7S', 8000
exec uspEditPolicyLimits 'C11033', 'JUBILEE01', '7T', 18000
exec uspEditPolicyLimits 'C11070', 'JUBILEE01', '7T', 20000
exec uspEditPolicyLimits 'LIBERTY', 'LIBERTY01', '7R', 92000
******************************************************************************************************/
-- select * from PolicyLimits
-- delete from PolicyLimits

-------------- Get PolicyLimits --------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPolicyLimits')
	drop proc uspGetPolicyLimits
go

create proc uspGetPolicyLimits(
@CompanyNo varchar(20),
@PolicyNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select CompanyNo, PolicyNo, PolicyLimits.BenefitCode, BenefitName, PolicyLimit
	from PolicyLimits
	inner join MemberBenefits on PolicyLimits.BenefitCode = MemberBenefits.BenefitCode
	where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo
return 0
end
go

/******************************************************************************************************
exec uspGetPolicyLimits 'C11033', 'JUBILEE01'
exec uspGetPolicyLimits 'C11070', 'JUBILEE01'
exec uspGetPolicyLimits 'LIBERTY', 'LIBERTY01'
******************************************************************************************************/
-- select * from PolicyLimits
-- delete from PolicyLimits

--------GetPolicyLimit--------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPolicyLimit')
	drop proc uspGetPolicyLimit
go

create proc uspGetPolicyLimit(
@MedicalCardNo varchar(20), 
@BenefitCode varchar(20),
@PolicyLimit money = null output
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @MedicalCardNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @MedicalCardNo, 'Scheme Members')
		return 1
	end

if not exists(select BenefitCode from MemberBenefits where BenefitCode = @BenefitCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Benefit Code', @BenefitCode, 'Member Benefits')
		return 1
	end 
	
else begin set @PolicyLimit = dbo.GetPolicyLimit(@MedicalCardNo, @BenefitCode) end

return 0
go

-- exec uspGetPolicyLimit 'RAS03', '7O'

------------------------------------------------------------------------------------------------------
-------------- InsuranceCustomFee --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit InsuranceCustomFee ---------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditInsuranceCustomFee')
	drop proc uspEditInsuranceCustomFee
go

create proc uspEditInsuranceCustomFee(
@InsuranceNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@CustomFee money,
@CurrenciesID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)

-------------------------------------------------------------------------
set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')
-------------------------------------------------------------------------

if not exists(select InsuranceNo from Insurances where InsuranceNo  = @InsuranceNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Insurance No', @InsuranceNo, 'Insurances')
		return 1
	end

----------------------------------------------------------------------------------------------------------------------

if (@ItemCategoryID = @ServiceID) and 
	(not exists(select ServiceCode from Services where ServiceCode = @ItemCode)) -- Services
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Service Code', @ItemCode, 'Services')	
			return 1
		end

else if (@ItemCategoryID = @DrugID) and 
	(not exists(select DrugNo from Drugs where DrugNo = @ItemCode)) -- Drugs
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Drugs')	
			return 1
		end
	
else if (@ItemCategoryID = @ConsumableID) and 
	(not exists(select ConsumableNo from ConsumableItems where ConsumableNo  = @ItemCode)) -- Consumable Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Consumable Items')	
			return 1
		end

else if (@ItemCategoryID = @ProcedureID) and 
	(not exists(select ProcedureCode from Procedures where ProcedureCode = @ItemCode)) -- Procedures
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ItemCode, 'Procedures')	
			return 1
		end	

else if (@ItemCategoryID = @DentalID) and 
	(not exists(select DentalCode from DentalServices where DentalCode = @ItemCode)) -- DentalServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Dental Code', @ItemCode, 'Dental Services')	
			return 1
		end

else if (@ItemCategoryID = @TheatreID) and 
	(not exists(select TheatreCode from TheatreServices where TheatreCode = @ItemCode)) -- TheatreServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @ItemCode, 'Theatre Services')	
			return 1
		end

else if (@ItemCategoryID = @OpticalID) and 
	(not exists(select OpticalCode from OpticalServices where OpticalCode = @ItemCode)) -- OpticalServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Optical Code', @ItemCode, 'Optical Services')	
			return 1
		end

else if (@ItemCategoryID = @MaternityID) and 
	(not exists(select MaternityCode from MaternityServices where MaternityCode = @ItemCode)) -- MaternityServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @ItemCode, 'Maternity Services')	
			return 1
		end

else if (@ItemCategoryID = @ICUID) and 
	(not exists(select ICUCode from ICUServices where ICUCode = @ItemCode)) -- ICUServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ItemCode, 'ICU Services')	
			return 1
		end

else if (@ItemCategoryID = @TestID) and 
	(not exists(select TestCode from LabTests where TestCode = @ItemCode)) -- Test
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Test Code', @ItemCode, 'Lab Tests')	
			return 1
		end

else if (@ItemCategoryID = @CardiologyID) and 
	(not exists(select ExamCode from CardiologyExaminations where ExamCode = @ItemCode)) -- Cardiology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Cardiology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @RadiologyID) and 
	(not exists(select ExamCode from RadiologyExaminations where ExamCode = @ItemCode)) -- Radiology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Radiology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @PathologyID) and 
	(not exists(select ExamCode from PathologyExaminations where ExamCode = @ItemCode)) -- Pathology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Pathology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @EyeID) and 
	(not exists(select EyeCode from EyeServices where EyeCode = @ItemCode)) -- EyeServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Eye Code', @ItemCode, 'Eye Services')	
			return 1
		end

else if (@ItemCategoryID = @AdmissionID) and 
	(not exists(select BedNo from Beds where BedNo = @ItemCode)) -- Admission
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Bed No', @ItemCode, 'Beds')	
			return 1
		end

else if (@ItemCategoryID = @ExtrasID) and 
	(not exists(select ExtraItemCode from ExtraChargeItems where ExtraItemCode = @ItemCode)) -- Extras
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Extra Item Code', @ItemCode, 'Extra Charge Items')	
			return 1
		end
		
----------------------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CurrenciesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrenciesID, 'Lookup Data')
		return 1
	end

if exists(select InsuranceNo from InsuranceCustomFee where InsuranceNo = @InsuranceNo 
						and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		update InsuranceCustomFee set
		CustomFee = @CustomFee, CurrenciesID = @CurrenciesID
		where InsuranceNo = @InsuranceNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
		return 0
	end
else
begin
insert into InsuranceCustomFee
(InsuranceNo, ItemCode, ItemCategoryID, CustomFee, CurrenciesID)
values
(@InsuranceNo, @ItemCode, @ItemCategoryID, @CustomFee, @CurrenciesID)
return 0
end
go

/******************************************************************************************************
exec uspEditInsuranceCustomFee 'C11001', 'I1100101', '10C', '7S', 12000
exec uspEditInsuranceCustomFee 'C11001', 'I1100101', 'REV', '7S', 8000
exec uspEditInsuranceCustomFee 'C11001', 'I1100101', 'T001', '7T', 18000
exec uspEditInsuranceCustomFee 'C11002', 'I1100101', 'T132', '7T', 20000
exec uspEditInsuranceCustomFee 'C11004', 'I1100601', 'M001', '7D', 6000
exec uspEditInsuranceCustomFee 'C11004', 'I1100601', 'R001', '7R', 92000

******************************************************************************************************/
-- select * from InsuranceCustomFee
-- delete from InsuranceCustomFee

-------------- Get InsuranceCustomFee -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInsuranceCustomFee')
	drop proc uspGetInsuranceCustomFee
go

create proc uspGetInsuranceCustomFee(
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@MedicalCardNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not(@MedicalCardNo is null)
begin

	if not exists(select MedicalCardNo from InsuranceCustomFee 
					inner join Insurances on InsuranceCustomFee.InsuranceNo = Insurances.InsuranceNo
					inner join InsurancePolicies on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
					inner join InsuranceSchemes on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
					inner join SchemeMembers on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
					and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
				where ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and MedicalCardNo = @MedicalCardNo)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Medical Card No', @MedicalCardNo, 'Insurance Custom Fee (Scheme Members)')
			return 1
		end
	else
	begin
		select InsuranceCustomFee.InsuranceNo, MedicalCardNo, 
		ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, CustomFee, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, UseCustomFee
		from InsuranceCustomFee
			inner join Insurances on InsuranceCustomFee.InsuranceNo = Insurances.InsuranceNo
			inner join InsurancePolicies on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
			inner join InsuranceSchemes on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
			inner join SchemeMembers on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
			and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
		where ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and MedicalCardNo = @MedicalCardNo
	end
end
else 
if @MedicalCardNo is null
	begin
		select InsuranceCustomFee.InsuranceNo, ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, CustomFee, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, UseCustomFee
		from InsuranceCustomFee
		inner join Insurances on InsuranceCustomFee.InsuranceNo = Insurances.InsuranceNo
		where ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	end
return 0
go

/******************************************************************************************************
exec uspGetInsuranceCustomFee 'M001', '7D'
exec uspGetInsuranceCustomFee 'REV', '7S'
exec uspGetInsuranceCustomFee 'M001', '7D', '4567'

******************************************************************************************************/
-- select * from InsuranceCustomFee
-- delete from InsuranceCustomFee

--select * from InsuranceSchemes
--select * from SchemeMembers

------------------------------------------------------------------------------------------------------
-------------- InsuranceExcludedItems ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit InsuranceExcludedItems -----------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditInsuranceExcludedItems')
	drop proc uspEditInsuranceExcludedItems
go

create proc uspEditInsuranceExcludedItems(
@CompanyNo varchar(20),
@PolicyNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)

-------------------------------------------------------------------------
set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')
-------------------------------------------------------------------------

if not exists(select CompanyNo from InsuranceSchemes where CompanyNo  = @CompanyNo and PolicyNo  = @PolicyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Company No', @CompanyNo, 'Policy No', @PolicyNo, 'Insurance Schemes')	
		return 1
	end

----------------------------------------------------------------------------------------------------------------------

if (@ItemCategoryID = @ServiceID) and 
	(not exists(select ServiceCode from Services where ServiceCode = @ItemCode)) -- Services
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Service Code', @ItemCode, 'Services')	
			return 1
		end

else if (@ItemCategoryID = @DrugID) and 
	(not exists(select DrugNo from Drugs where DrugNo = @ItemCode)) -- Drugs
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Drugs')	
			return 1
		end
	
else if (@ItemCategoryID = @ConsumableID) and 
	(not exists(select ConsumableNo from ConsumableItems where ConsumableNo  = @ItemCode)) -- Consumable Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Consumable Items')	
			return 1
		end

else if (@ItemCategoryID = @ProcedureID) and 
	(not exists(select ProcedureCode from Procedures where ProcedureCode = @ItemCode)) -- Procedures
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ItemCode, 'Procedures')	
			return 1
		end	

else if (@ItemCategoryID = @DentalID) and 
	(not exists(select DentalCode from DentalServices where DentalCode = @ItemCode)) -- DentalServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Dental Code', @ItemCode, 'Dental Services')	
			return 1
		end

else if (@ItemCategoryID = @TheatreID) and 
	(not exists(select TheatreCode from TheatreServices where TheatreCode = @ItemCode)) -- TheatreServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @ItemCode, 'Theatre Services')	
			return 1
		end

else if (@ItemCategoryID = @OpticalID) and 
	(not exists(select OpticalCode from OpticalServices where OpticalCode = @ItemCode)) -- OpticalServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Optical Code', @ItemCode, 'Optical Services')	
			return 1
		end

else if (@ItemCategoryID = @MaternityID) and 
	(not exists(select MaternityCode from MaternityServices where MaternityCode = @ItemCode)) -- MaternityServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @ItemCode, 'Maternity Services')	
			return 1
		end

else if (@ItemCategoryID = @ICUID) and 
	(not exists(select ICUCode from ICUServices where ICUCode = @ItemCode)) -- ICUServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ItemCode, 'ICU Services')	
			return 1
		end

else if (@ItemCategoryID = @TestID) and 
	(not exists(select TestCode from LabTests where TestCode = @ItemCode)) -- Test
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Test Code', @ItemCode, 'Lab Tests')	
			return 1
		end

else if (@ItemCategoryID = @CardiologyID) and 
	(not exists(select ExamCode from CardiologyExaminations where ExamCode = @ItemCode)) -- Cardiology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Cardiology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @RadiologyID) and 
	(not exists(select ExamCode from RadiologyExaminations where ExamCode = @ItemCode)) -- Radiology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Radiology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @PathologyID) and 
	(not exists(select ExamCode from PathologyExaminations where ExamCode = @ItemCode)) -- Pathology
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ItemCode, 'Pathology Examinations')	
			return 1
		end

else if (@ItemCategoryID = @EyeID) and 
	(not exists(select EyeCode from EyeServices where EyeCode = @ItemCode)) -- EyeServices
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Eye Code', @ItemCode, 'Eye Services')	
			return 1
		end

else if (@ItemCategoryID = @AdmissionID) and 
	(not exists(select BedNo from Beds where BedNo = @ItemCode)) -- Admission
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Bed No', @ItemCode, 'Beds')	
			return 1
		end

else if (@ItemCategoryID = @ExtrasID) and 
	(not exists(select ExtraItemCode from ExtraChargeItems where ExtraItemCode = @ItemCode)) -- Extras
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Extra Item Code', @ItemCode, 'Extra Charge Items')	
			return 1
		end
		
----------------------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
														and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin return 0 end
else
begin
	insert into InsuranceExcludedItems
	(CompanyNo, PolicyNo, ItemCode, ItemCategoryID)
	values
	(@CompanyNo, @PolicyNo, @ItemCode, @ItemCategoryID)
	return 0
end
go

/******************************************************************************************************
exec uspEditInsuranceExcludedItems 'C11001', 'I1100101', '10C', '7S'
exec uspEditInsuranceExcludedItems 'C11001', 'I1100101', 'REV', '7S'
exec uspEditInsuranceExcludedItems 'C11001', 'I1100101', 'T001', '7T'
exec uspEditInsuranceExcludedItems 'C11002', 'I1100101', 'T132', '7T'
exec uspEditInsuranceExcludedItems 'C11004', 'I1100601', 'M001', '7D'
exec uspEditInsuranceExcludedItems 'C11004', 'I1100601', 'R001', '7R'

******************************************************************************************************/

-- select * from InsuranceExcludedItems
-- delete from InsuranceExcludedItems

-------------- Get InsuranceExcludedItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInsuranceExcludedItems')
	drop proc uspGetInsuranceExcludedItems
go

create proc uspGetInsuranceExcludedItems(
@CompanyNo varchar(20),
@PolicyNo varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select CompanyNo, PolicyNo, ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName,
	ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory
	from InsuranceExcludedItems
	where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetInsuranceExcludedItems 'C11001', 'I1100101', '7S'
exec uspGetInsuranceExcludedItems 'C11002', 'I1100101', '7T'
******************************************************************************************************/
-- select * from InsuranceExcludedItems
-- delete from InsuranceExcludedItems

------------------------------------------------------------------------------------------------------
-------------- SchemeMembers -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert SchemeMembers ------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertSchemeMembers')
	drop proc uspInsertSchemeMembers
go

create proc uspInsertSchemeMembers(
@MemberTypeID varchar(10),
@MedicalCardNo varchar(20),
@MainMemberNo varchar(20),
@CompanyNo varchar(20),
@PolicyNo varchar(20),
@ReferenceNo varchar(20),
@Surname varchar(20),
@FirstName varchar(20),
@MiddleName varchar(20),
@BirthDate smalldatetime,
@GenderID varchar(10),
@Address varchar(100),
@PhoneWork varchar(30),
@PhoneMobile varchar(30),
@PhoneHome varchar(30),
@Email varchar(40),
@Photo image = null,
@Fingerprint image = null,
@JoinDate smalldatetime,
@Relationship varchar(41),
@PolicyStartDate smalldatetime,
@PolicyEndDate smalldatetime,
@MemberStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @StaffMemberTypeID varchar(10)
declare @DependantMemberTypeID varchar(10)

--------------------------------------------------------------------------------------------------------------
declare @MedicalCardID int
declare @CurrentYear as char(2)
declare @MedicalCardNoPrefix varchar(12)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedMedicalCardID int
declare @PassedMedicalCardNo varchar(20)

--------------------------------------------------------------------------------------------------------------
declare @MainMemberID int

declare @PassedMainMemberID int
declare @PassedMainMemberNo varchar(20)

--------------------------------------------------------------------------------------------------------------
set @StaffMemberTypeID = dbo.GetLookupDataID('MemberType', '01')
set @DependantMemberTypeID = dbo.GetLookupDataID('MemberType', '02')
--------------------------------------------------------------------------------------------------------------

if exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @MedicalCardNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @MedicalCardNo)
		return 1
	end

if  dbo.GetMainMemberDependantsTotal (@MainMemberNo) >= (isnull(dbo.GetOptionValue('SchemeMembersMaxDependants'),0))
begin
		set @ErrorMSG = 'The Main Member with %s: %s, you are transacting With has Reached the Maximum Allowed Dependants, Contact Your Administrator for help!'
		raiserror(@ErrorMSG, 16, 1, 'Main Member No', @MainMemberNo)
		return 1
	end


if not exists(select DataID from LookupData where DataID = @MemberTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Member Type ID', @MemberTypeID, 'Lookup Data')
		return 1
	end

if (not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @MainMemberNo) 
	and (not (@MainMemberNo is null or @MainMemberNo = '')) and (not (@MemberTypeID = @StaffMemberTypeID)))
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s and not empty'
		raiserror(@ErrorMSG, 16, 1, 'Main Member No', @MainMemberNo, 'Scheme Members')
		return 1
	end
else if (@MainMemberNo is null or @MainMemberNo = '') begin set @MainMemberNo = null end

if not exists(select CompanyNo from InsuranceSchemes where CompanyNo  = @CompanyNo and PolicyNo  = @PolicyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Company No', @CompanyNo, 'Policy No', @PolicyNo, 'Insurance Schemes')	
		return 1
	end
	
if (@BirthDate > GetDate())
	begin		
		set @ErrorMSG = 'The %s: ' + ltrim(rtrim(dbo.FormatDate(@BirthDate))) + ', you are trying to enter can''t be ahead of today’s date as set by server administrator'
		raiserror(@ErrorMSG, 16, 1, 'Birth Date')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GenderID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Gender ID', @GenderID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @MemberStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Member Status ID', @MemberStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

-----------------------------------------------------------------------------------------------------------------------------------------
select @AutoColumnLEN = AutoColumnLEN from AutoNumbers  where ObjectName = 'SchemeMembers' and AutoColumnName = 'MedicalCardNo'
select @PaddingLEN = PaddingLEN from AutoNumbers where ObjectName = 'SchemeMembers' and AutoColumnName = 'MedicalCardNo'

set @CurrentYear = right(year(getdate()), 2)
set @MedicalCardNoPrefix = dbo.GetOptionValue('MedicalCardNoPrefix') + @CurrentYear

if (@AutoColumnLEN = len(@MedicalCardNo)) and (left(@MedicalCardNo, len(@MedicalCardNoPrefix)) = @MedicalCardNoPrefix)

begin

	set @PassedMedicalCardID = 1
	set @PassedMedicalCardNo = @MedicalCardNo
	set @PassedMedicalCardNo = ltrim(rtrim(substring(@PassedMedicalCardNo, len(@MedicalCardNoPrefix) + 1, @PaddingLEN)))

	if isnumeric(@PassedMedicalCardNo) = 1 set @PassedMedicalCardID = @PassedMedicalCardNo
	else set @PassedMedicalCardID = 1

	set @MedicalCardID = (select max(MedicalCardID) from SchemeMembers 
	where left(MedicalCardNo, len(@MedicalCardNoPrefix)) = @MedicalCardNoPrefix)
	
	set @MedicalCardID = dbo.GetNextAutoNumber('SchemeMembers', 'MedicalCardNo', @MedicalCardID)
	
	if @PassedMedicalCardID < @MedicalCardID set @MedicalCardID = @PassedMedicalCardID
	if @PassedMedicalCardID > @MedicalCardID set @MedicalCardID = @PassedMedicalCardID

end else set @MedicalCardID = 1 

-----------------------------------------------------------------------------------------------------------------------------------------
select @AutoColumnLEN = AutoColumnLEN from AutoNumbers  where ObjectName = 'SchemeMembers' and AutoColumnName = 'MainMemberNo'
select @PaddingLEN = PaddingLEN from AutoNumbers where ObjectName = 'SchemeMembers' and AutoColumnName = 'MainMemberNo'

set @PassedMedicalCardNo = ltrim(rtrim(substring(@MedicalCardNo, 1, len(@MedicalCardNo) - @PaddingLEN)))

if ((@MemberTypeID = @DependantMemberTypeID) and (@AutoColumnLEN = len(@MedicalCardNo)))

begin

	set @PassedMainMemberID = 0
	set @PassedMainMemberNo = @MedicalCardNo

	set @PassedMainMemberNo = ltrim(rtrim(substring(@PassedMainMemberNo, len(@PassedMedicalCardNo) + 1, @PaddingLEN)))

	if isnumeric(@PassedMainMemberNo) = 1 set @PassedMainMemberID = @PassedMainMemberNo else set @PassedMainMemberID = 0
		
	if (@PaddingLEN > len(@MedicalCardNo)) begin set @PaddingLEN = 0 end
	set @PassedMedicalCardNo = ltrim(rtrim(substring(@MedicalCardNo, 1, len(@MedicalCardNo) - @PaddingLEN)))

	set @MainMemberID = (select max(MainMemberID) from SchemeMembers 
						 where left(MedicalCardNo, len(@MedicalCardNo) - @PaddingLEN) = @PassedMedicalCardNo)
	set @MainMemberID = dbo.GetNextAutoNumber('SchemeMembers', 'MainMemberNo', @MainMemberID)
	
	if @PassedMainMemberID < @MainMemberID set @MainMemberID = @PassedMainMemberID
	if @PassedMainMemberID > @MainMemberID set @MainMemberID = @PassedMainMemberID

end else set @MainMemberID = 0

-----------------------------------------------------------------------------------------------------------------------------------------
	insert into SchemeMembers
	(MedicalCardID, MainMemberID, MemberTypeID, MedicalCardNo, MainMemberNo, PolicyNo, CompanyNo, ReferenceNo, 
	Surname, FirstName, MiddleName, BirthDate, GenderID, Address, PhoneWork, PhoneMobile, PhoneHome, Email, Photo, 
	Fingerprint, JoinDate, Relationship, PolicyStartDate, PolicyEndDate, MemberStatusID, LoginID, ClientMachine)
	values
	(@MedicalCardID, @MainMemberID, @MemberTypeID, @MedicalCardNo, @MainMemberNo, @PolicyNo, @CompanyNo, @ReferenceNo, 
	@Surname, @FirstName, @MiddleName, @BirthDate, @GenderID, @Address, @PhoneWork, @PhoneMobile, @PhoneHome, @Email, @Photo, 
	@Fingerprint, @JoinDate, @Relationship, @PolicyStartDate, @PolicyEndDate, @MemberStatusID, @LoginID, @ClientMachine)
	return 0
end
go

/*****************************************************************************************************************************
exec uspInsertSchemeMembers '4201', 'UAP11001', '', 'C11001', 'I1100101', '', 'Kato', 'John', '', '23 Jan 1978', 
							'15M', null, null, 'Jan 1 2011', 'jan 11, 2011', 'Dec 31, 2011', '1A', 'Admin'

exec uspInsertSchemeMembers '4202', 'UAP11001/2', 'UAP11001', 'C11001', 'I1100101', '', 'Kato', 'John', '', '23 Jan 1978', 
							'15M', null, null, 'Jan 1 2011', 'jan 11, 2011', 'Dec 31, 2011', '1A', 'Admin'

******************************************************************************************************************************/
-- select * from SchemeMembers
-- delete from SchemeMembers

-------------- Update SchemeMembers -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateSchemeMembers')
	drop proc uspUpdateSchemeMembers
go

create proc uspUpdateSchemeMembers(
@MemberTypeID varchar(10),
@MedicalCardNo varchar(20),
@MainMemberNo varchar(20),
@CompanyNo varchar(20),
@PolicyNo varchar(20),
@ReferenceNo varchar(20),
@Surname varchar(20),
@FirstName varchar(20),
@MiddleName varchar(20),
@BirthDate smalldatetime,
@GenderID varchar(10),
@Address varchar(100),
@PhoneWork varchar(30),
@PhoneMobile varchar(30),
@PhoneHome varchar(30),
@Email varchar(40),
@Photo image = null,
@Fingerprint image = null,
@JoinDate smalldatetime,
@Relationship varchar(41),
@PolicyStartDate smalldatetime,
@PolicyEndDate smalldatetime,
@MemberStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @MedicalCardNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @MedicalCardNo, 'Scheme Members')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @MemberTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Member Type ID', @MemberTypeID, 'Lookup Data')
		return 1
	end

if (not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @MainMemberNo) 
									and (not (@MainMemberNo is null or @MainMemberNo = '')))
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s and not empty'
		raiserror(@ErrorMSG, 16, 1, 'Main Member No', @MainMemberNo, 'Scheme Members')
		return 1
	end
else if (@MainMemberNo is null or @MainMemberNo = '') begin set @MainMemberNo = null end

if not exists(select DataID from LookupData where DataID = @MemberStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Member Status ID', @MemberStatusID, 'Lookup Data')
		return 1
	end
	
if (@BirthDate > GetDate())
	begin		
		set @ErrorMSG = 'The %s: ' + ltrim(rtrim(dbo.FormatDate(@BirthDate))) + ', you are trying to enter can''t be ahead of today’s date as set by server administrator'
		raiserror(@ErrorMSG, 16, 1, 'Birth Date')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GenderID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Gender ID', @GenderID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
	update SchemeMembers set MemberTypeID = @MemberTypeID, MainMemberNo = @MainMemberNo, PolicyNo = @PolicyNo, 
	CompanyNo = @CompanyNo, ReferenceNo = @ReferenceNo, Surname = @Surname, FirstName = @FirstName, MiddleName = @MiddleName, 
	BirthDate = @BirthDate, GenderID = @GenderID, Address = @Address, PhoneWork = @PhoneWork, PhoneMobile = @PhoneMobile, 
	PhoneHome = @PhoneHome, Email = @Email, Photo = @Photo, Fingerprint = @Fingerprint, JoinDate = @JoinDate, 
	Relationship = @Relationship, PolicyStartDate = @PolicyStartDate, PolicyEndDate = @PolicyEndDate, 
	MemberStatusID = @MemberStatusID, LoginID = @LoginID, ClientMachine = @ClientMachine
	where MedicalCardNo = @MedicalCardNo
	return 0
end
go

/************************************************************************************************************************
exec uspUpdateSchemeMembers '4202', 'UAP11001/2', 'UAP11001', 'C11001', 'I1100101', '1', 'Kato1', 'John1', '', '21 Jan 1978', 
							'15F', null, null, 'Jan 11 2011', 'jan 1, 2011', 'Dec 11, 2011', '1I', 'Debbie'

************************************************************************************************************************/
-- select * from SchemeMembers
-- delete from SchemeMembers

-------------- Get SchemeMembers -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetSchemeMembers')
	drop proc uspGetSchemeMembers
go

create proc uspGetSchemeMembers(
@MedicalCardNo varchar(20)=null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@MedicalCardNo is null)
begin
	if not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @MedicalCardNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @MedicalCardNo, 'Scheme Members')
		return 1
	end
	else
	begin
		select MemberTypeID, dbo.GetLookupDataDes(MemberTypeID) as MemberType, 
	MainMemberNo, dbo.GetSchemeMemberName(MainMemberNo) as MainMemberName,
	MedicalCardNo, SchemeMembers.CompanyNo, CompanyName,
	dbo.GetMergedNameCode(CompanyName, InsuranceSchemes.CompanyNo) as CompanyFullName,
	SchemeMembers.PolicyNo, PolicyName, InsurancePolicies.InsuranceNo, InsuranceName, 
	SchemeStartDate, SchemeEndDate, ReferenceNo, Surname, FirstName, MiddleName, 
	dbo.GetFullName(Surname, MiddleName, FirstName) as FullName, 
	BirthDate, dbo.GetAge(BirthDate, getdate()) as Age, 
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender, SchemeMembers.Address, 
	PhoneWork, PhoneMobile, PhoneHome, SchemeMembers.Email, Photo, Fingerprint, JoinDate, Relationship,
	PolicyStartDate, PolicyEndDate, MemberStatusID, dbo.GetLookupDataDes(MemberStatusID) as MemberStatus,
	SchemeStartDate, SchemeEndDate, CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType,
	CoPayPercent, CoPayValue, UseCustomFee, SmartCardApplicable, 
	SchemeStatusID, dbo.GetLookupDataDes(SchemeStatusID) as SchemeStatus,
	dbo.GetMergedNameCode(dbo.GetFullName(Surname, MiddleName, FirstName),MedicalCardNo) as MemberFullName
	from SchemeMembers	
	inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
	and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
	inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
	inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
	inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
	where MedicalCardNo = @MedicalCardNo
	end
end
else
if (@MedicalCardNo is null)
begin
	begin
		select MemberTypeID, dbo.GetLookupDataDes(MemberTypeID) as MemberType, 
	MainMemberNo, dbo.GetSchemeMemberName(MainMemberNo) as MainMemberName,
	MedicalCardNo, SchemeMembers.CompanyNo, CompanyName,
	dbo.GetMergedNameCode(CompanyName, InsuranceSchemes.CompanyNo) as CompanyFullName,
	SchemeMembers.PolicyNo, PolicyName, InsurancePolicies.InsuranceNo, InsuranceName, 
	SchemeStartDate, SchemeEndDate, ReferenceNo, Surname, FirstName, MiddleName, 
	dbo.GetFullName(Surname, MiddleName, FirstName) as FullName, 
	BirthDate, dbo.GetAge(BirthDate, getdate()) as Age, 
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender, SchemeMembers.Address, 
	PhoneWork, PhoneMobile, PhoneHome, SchemeMembers.Email, Photo, Fingerprint, JoinDate, Relationship,
	PolicyStartDate, PolicyEndDate, MemberStatusID, dbo.GetLookupDataDes(MemberStatusID) as MemberStatus,
	SchemeStartDate, SchemeEndDate, CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType,
	CoPayPercent, CoPayValue, UseCustomFee, SmartCardApplicable, 
	SchemeStatusID, dbo.GetLookupDataDes(SchemeStatusID) as SchemeStatus,
	dbo.GetMergedNameCode(dbo.GetFullName(Surname, MiddleName, FirstName),MedicalCardNo) as MemberFullName
	from SchemeMembers	
	inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
	and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
	inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
	inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
	inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
	
	end
end
go


/******************************************************************************************************
exec uspGetSchemeMembers 'UAP11001'

******************************************************************************************************/
-- select * from SchemeMembers
-- delete from SchemeMembers

--------GetMemberFingerprints-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetMemberFingerprints')
	drop proc uspGetMemberFingerprints
go

create proc uspGetMemberFingerprints
with encryption as

declare @ActiveStatusID varchar(10)
set @ActiveStatusID = dbo.GetLookupDataID('Status', 'A')

begin
	select MedicalCardNo, Fingerprint from SchemeMembers 
	where MemberStatusID = @ActiveStatusID and not Fingerprint is null
	and PolicyStartDate <= getdate() and PolicyEndDate >= getdate()
end

return 0
go

-- select * from SchemeMembers
-- exec uspGetMemberFingerprints

--------GetNextMedicalCardID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextMedicalCardID')
	drop proc uspGetNextMedicalCardID
go

create proc uspGetNextMedicalCardID(
@MedicalCardID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @OptionValue varchar(10)
declare @CurrentYear as char(2)
declare @MedicalCardNoPrefix varchar(12)

set @OptionValue = dbo.GetOptionValue('MedicalCardNoPrefix')
set @CurrentYear = right(year(getdate()), 2)

set @MedicalCardNoPrefix = @OptionValue + @CurrentYear

set @MedicalCardID = (select max(MedicalCardID) from SchemeMembers 
					  where left(MedicalCardNo, len(@MedicalCardNoPrefix)) = @MedicalCardNoPrefix)
set @MedicalCardID = dbo.GetNextAutoNumber('SchemeMembers', 'MedicalCardNo', @MedicalCardID)

return 0
go

-- exec uspGetNextMedicalCardID
-- select * from SchemeMembers

--------GetNextMainMemberID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextMainMemberID')
	drop proc uspGetNextMainMemberID
go

create proc uspGetNextMainMemberID(
@MedicalCardNo varchar(20),
@MainMemberID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @PaddingLEN tinyint
declare @PassedMedicalCardNo varchar(20)

select @PaddingLEN = PaddingLEN from AutoNumbers where ObjectName = 'SchemeMembers' and AutoColumnName = 'MainMemberNo'

if (@PaddingLEN > len(@MedicalCardNo)) begin set @PaddingLEN = 0 end
set @PassedMedicalCardNo = ltrim(rtrim(substring(@MedicalCardNo, 1, len(@MedicalCardNo) - @PaddingLEN)))

set @MainMemberID = (select max(MainMemberID) from SchemeMembers 
					 where left(MedicalCardNo, len(@MedicalCardNo) - @PaddingLEN) = @PassedMedicalCardNo)
set @MainMemberID = dbo.GetNextAutoNumber('SchemeMembers', 'MainMemberNo', @MainMemberID)

return 0
go

-- exec uspGetNextMainMemberID '140000301'
-- select * from SchemeMembers

------------------------------------------------------------------------------------------------------
-------------- HealthUnits ---------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert HealthUnits --------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertHealthUnits')
	drop proc uspInsertHealthUnits
go

create proc uspInsertHealthUnits(
@HealthUnitCode varchar(10),
@HealthUnitName varchar(41),
@DistrictsID varchar(10),
@ContactPerson varchar(100),
@Address varchar(200),
@Phone varchar(100)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select HealthUnitCode from HealthUnits where HealthUnitCode = @HealthUnitCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Health Unit Code', @HealthUnitCode)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DistrictsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Districts ID', @DistrictsID, 'Lookup Data')
		return 1
	end

begin
insert into HealthUnits
(HealthUnitCode, HealthUnitName, DistrictsID, ContactPerson, Address, Phone)
values
(@HealthUnitCode, @HealthUnitName, @DistrictsID, @ContactPerson, @Address, @Phone)
return 0
end
go

/******************************************************************************************************
exec uspInsertHealthUnits 'HU001', 'Health Unit One', '5101'
exec uspInsertHealthUnits 'HU002', 'Health Unit Two', '5102'
exec uspInsertHealthUnits 'HU003', 'Health Unit Three', '5101'

******************************************************************************************************/
-- select * from HealthUnits
-- delete from HealthUnits

-------------- Update HealthUnits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateHealthUnits')
	drop proc uspUpdateHealthUnits
go

create proc uspUpdateHealthUnits(
@HealthUnitCode varchar(10),
@HealthUnitName varchar(41),
@DistrictsID varchar(10),
@ContactPerson varchar(100),
@Address varchar(200),
@Phone varchar(100)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select HealthUnitCode from HealthUnits where HealthUnitCode = @HealthUnitCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Health Unit Code', @HealthUnitCode, 'Health Units')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DistrictsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Districts ID', @DistrictsID, 'Lookup Data')
		return 1
	end

begin
update HealthUnits set
HealthUnitName = @HealthUnitName, DistrictsID = @DistrictsID, 
ContactPerson = @ContactPerson, Address = @Address, Phone = @Phone
where HealthUnitCode = @HealthUnitCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateHealthUnits  'HU001', 'Health Unit Two', '5402'
******************************************************************************************************/
-- select * from HealthUnits
-- delete from HealthUnits

-------------- Get HealthUnits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetHealthUnits')
	drop proc uspGetHealthUnits
go

create proc uspGetHealthUnits(
@HealthUnitCode varchar(10) = null,
@DistrictsID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@HealthUnitCode is null) and (@DistrictsID is null))
begin
	if not exists(select HealthUnitCode from HealthUnits where HealthUnitCode = @HealthUnitCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Health Unit Code', @HealthUnitCode, 'Health Units')
			return 1
		end
	else
	begin
		select HealthUnitCode, HealthUnitName, DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District, 
		dbo.GetMergedNameCode(HealthUnitName, HealthUnitCode) as HealthUnitFullName, ContactPerson, Address, Phone
		from HealthUnits
		where HealthUnitCode = @HealthUnitCode
	end
end
else
if  ((@HealthUnitCode is null) and not (@DistrictsID is null))
begin
		select HealthUnitCode, HealthUnitName, DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District, 
		dbo.GetMergedNameCode(HealthUnitName, HealthUnitCode) as HealthUnitFullName, ContactPerson, Address, Phone
		from HealthUnits
		where DistrictsID = @DistrictsID
end
else
if  ((@HealthUnitCode is null) and (@DistrictsID is null))
begin
		select HealthUnitCode, HealthUnitName, DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District, 
		dbo.GetMergedNameCode(HealthUnitName, HealthUnitCode) as HealthUnitFullName, ContactPerson, Address, Phone
		from HealthUnits
end
return 0
go

/******************************************************************************************************
exec uspGetHealthUnits
exec uspGetHealthUnits 'HU001'
exec uspGetHealthUnits null, '5402'

******************************************************************************************************/
-- select * from HealthUnits
-- delete from HealthUnits

-------------- GetHealthUnitsHealthUnitCode -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetHealthUnitsHealthUnitCode')
	drop proc uspGetHealthUnitsHealthUnitCode
go

create proc uspGetHealthUnitsHealthUnitCode(
@HealthUnitName varchar(41),
@HealthUnitCode varchar(10) = null output
)with encryption as

begin
	set @HealthUnitCode = (select top 1 HealthUnitCode from HealthUnits where HealthUnitName = @HealthUnitName)
return 0
end
go

/******************************************************************************************************
exec uspGetHealthUnitsHealthUnitCode 'SyncSoft INTERNATIONAL LTD'
******************************************************************************************************/
-- select * from HealthUnits
-- delete from HealthUnits

------------------------------------------------------------------------------------------------------
-------------- Counties ------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Counties -----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertCounties')
	drop proc uspInsertCounties
go

create proc uspInsertCounties(
@CountyCode varchar(20),
@CountyName varchar(41),
@DistrictsID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select CountyCode from Counties where CountyCode = @CountyCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'County Code', @CountyCode)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DistrictsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Districts ID', @DistrictsID, 'Lookup Data')
		return 1
	end

begin
insert into Counties
(CountyCode, CountyName, DistrictsID)
values
(@CountyCode, @CountyName, @DistrictsID)
return 0
end
go

/******************************************************************************************************
exec uspInsertCounties 'C001', 'KKOOME ISLAND', '4101'
exec uspInsertCounties 'C002', 'KYAMPISI', '4101'
exec uspInsertCounties 'C003', 'NAKISUNGA', '4101'
exec uspInsertCounties 'C004', 'NAMA', '4101'
exec uspInsertCounties 'C005', 'NTENJERU', '4101'
exec uspInsertCounties 'C006', 'CENTRAL DIVISION', '4101'
exec uspInsertCounties 'C007', 'GOMA DIVISION', '4101'
exec uspInsertCounties 'C008', 'KASAWO', '4101'

exec uspInsertCounties 'C009', 'BBAALE', '4122'
exec uspInsertCounties 'C010', 'BUSAANA', '4122'

******************************************************************************************************/
-- select * from Counties
-- delete from Counties

-------------- Update Counties -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateCounties')
	drop proc uspUpdateCounties
go

create proc uspUpdateCounties(
@CountyCode varchar(20),
@CountyName varchar(41),
@DistrictsID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select CountyCode from Counties where CountyCode = @CountyCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'County Code', @CountyCode, 'Counties')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DistrictsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Districts ID', @DistrictsID, 'Lookup Data')
		return 1
	end

begin
update Counties set
CountyName = @CountyName, DistrictsID = @DistrictsID
where CountyCode = @CountyCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateCounties 'C008', 'KASAWO', '4122'
******************************************************************************************************/
-- select * from Counties
-- delete from Counties

-------------- Get Counties -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCounties')
	drop proc uspGetCounties
go

create proc uspGetCounties(
@CountyCode varchar(20) = null,
@DistrictsID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@CountyCode is null) and (@DistrictsID is null))
begin
	if not exists(select CountyCode from Counties where CountyCode = @CountyCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'County Code', @CountyCode, 'Counties')
			return 1
		end
	else
	begin
		select CountyCode, CountyName, DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District, 
		dbo.GetMergedNameCode(CountyName,CountyCode) as CountyFullName
		from Counties
		where CountyCode = @CountyCode
	end
end
else
if ((@CountyCode is null) and not (@DistrictsID is null))
begin
		select CountyCode, CountyName, DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District, 
		dbo.GetMergedNameCode(CountyName,CountyCode) as CountyFullName
		from Counties
		where DistrictsID = @DistrictsID
end
else
if  ((@CountyCode is null) and (@DistrictsID is null))
begin
		select CountyCode, CountyName, DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District, 
		dbo.GetMergedNameCode(CountyName,CountyCode) as CountyFullName
		from Counties
end

return 0

go

/******************************************************************************************************
exec uspGetCounties 'C001'
exec uspGetCounties null, '4122'
exec uspGetCounties

******************************************************************************************************/
-- select * from Counties
-- delete from Counties

------------------------------------------------------------------------------------------------------
-------------- SubCounties ---------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert SubCounties --------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertSubCounties')
	drop proc uspInsertSubCounties
go

create proc uspInsertSubCounties(
@SubCountyCode varchar(20),
@SubCountyName varchar(41),
@CountyCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select SubCountyCode from SubCounties where SubCountyCode = @SubCountyCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Sub County Code', @SubCountyCode)
		return 1
	end

if not exists(select CountyCode from Counties where CountyCode  = @CountyCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'County Code', @CountyCode, 'Counties')
		return 1
	end

begin
insert into SubCounties
(SubCountyCode, SubCountyName, CountyCode)
values
(@SubCountyCode, @SubCountyName, @CountyCode)
return 0
end
go

/******************************************************************************************************
exec uspInsertSubCounties 'SC001', 'BUGOMBE', 'C002'
exec uspInsertSubCounties 'SC002', 'BUSANGA', 'C002'
exec uspInsertSubCounties 'SC003', 'BULIJJO', 'C003'

exec uspInsertSubCounties 'SC009', 'NAKITOKOLO', 'C009'
exec uspInsertSubCounties 'SC010', 'KASANA', 'C010'

******************************************************************************************************/
-- select * from SubCounties
-- delete from SubCounties

-------------- Update SubCounties -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateSubCounties')
	drop proc uspUpdateSubCounties
go

create proc uspUpdateSubCounties(
@SubCountyCode varchar(20),
@SubCountyName varchar(41),
@CountyCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SubCountyCode from SubCounties where SubCountyCode = @SubCountyCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sub County Code', @SubCountyCode, 'Sub Counties')
		return 1
	end

if not exists(select CountyCode from Counties where CountyCode  = @CountyCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'County Code', @CountyCode, 'Counties')
		return 1
	end
begin
update SubCounties set
SubCountyName = @SubCountyName, CountyCode = @CountyCode
where SubCountyCode = @SubCountyCode
return 0
end
go

/******************************************************************************************************
exec uspInsertSubCounties 'SC008', 'NAKITOKOLO8', 'C005'

******************************************************************************************************/
-- select * from SubCounties
-- delete from SubCounties

-------------- Get SubCounties --------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetSubCounties')
	drop proc uspGetSubCounties
go

create proc uspGetSubCounties(
@SubCountyCode varchar(20)= null,
@CountyCode varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@SubCountyCode is null) and (@CountyCode is null))
begin
	if not exists(select SubCountyCode from SubCounties where SubCountyCode = @SubCountyCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Sub County Code', @SubCountyCode, 'Sub Counties')
			return 1
		end
	else
	begin
		select SubCountyCode, SubCountyName, SubCounties.CountyCode, CountyName, 
		DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District, 
		dbo.GetMergedNameCode(SubCountyName,SubCountyCode) as SubCountyFullName
		from SubCounties
		inner join Counties on SubCounties.CountyCode = Counties.CountyCode		
		where SubCountyCode = @SubCountyCode
	end
end
else
if ((@SubCountyCode is null) and not (@CountyCode is null))
begin
		select SubCountyCode, SubCountyName, SubCounties.CountyCode, CountyName, 
		DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District, 
		dbo.GetMergedNameCode(SubCountyName,SubCountyCode) as SubCountyFullName
		from SubCounties
		inner join Counties on SubCounties.CountyCode = Counties.CountyCode		
		where SubCounties.CountyCode = @CountyCode
end
else
if  ((@SubCountyCode is null) and (@CountyCode is null))
begin
		select SubCountyCode, SubCountyName, SubCounties.CountyCode, CountyName, 
		DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District, 
		dbo.GetMergedNameCode(SubCountyName,SubCountyCode) as SubCountyFullName
		from SubCounties
		inner join Counties on SubCounties.CountyCode = Counties.CountyCode		
end

return 0

go

/******************************************************************************************************
exec uspGetSubCounties '323101'
exec uspGetSubCounties null, '3221'
exec uspGetSubCounties 
******************************************************************************************************/
-- select * from SubCounties
-- delete from SubCounties

------------------------------------------------------------------------------------------------------
-------------- Parishes ------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Parishes -----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertParishes')
	drop proc uspInsertParishes
go

create proc uspInsertParishes(
@ParishCode varchar(20),
@ParishName varchar(41),
@SubCountyCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select ParishCode from Parishes where ParishCode = @ParishCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Parish Code', @ParishCode)
		return 1
	end

if not exists(select SubCountyCode from SubCounties where SubCountyCode  = @SubCountyCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sub County Code', @SubCountyCode, 'Sub Counties')
		return 1
	end

begin
insert into Parishes
(ParishCode, ParishName, SubCountyCode)
values
(@ParishCode, @ParishName, @SubCountyCode)
return 0
end
go

/******************************************************************************************************
exec uspInsertParishes 'P001', 'BUGOMBE', 'SC002'
exec uspInsertParishes 'P002', 'BUSANGA', 'SC002'
exec uspInsertParishes 'P003', 'BULIJJO', 'SC003'

exec uspInsertParishes 'P009', 'NAKITOKOLO', 'SC009'
exec uspInsertParishes 'P010', 'KASANA', 'SC010'

******************************************************************************************************/
-- select * from Parishes
-- delete from Parishes

-------------- Update Parishes -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateParishes')
	drop proc uspUpdateParishes
go

create proc uspUpdateParishes(
@ParishCode varchar(20),
@ParishName varchar(41),
@SubCountyCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ParishCode from Parishes where ParishCode = @ParishCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Parish Code', @ParishCode, 'Parishes')
		return 1
	end

if not exists(select SubCountyCode from SubCounties where SubCountyCode  = @SubCountyCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sub County Code', @SubCountyCode, 'Sub Counties')
		return 1
	end
begin
update Parishes set
ParishName = @ParishName, SubCountyCode = @SubCountyCode
where ParishCode = @ParishCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateParishes 'P009', 'NAKITOKOLO8', 'SC010'

******************************************************************************************************/
-- select * from Parishes
-- delete from Parishes

-------------- Get Parishes --------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetParishes')
	drop proc uspGetParishes
go

create proc uspGetParishes(
@ParishCode varchar(20)= null,
@SubCountyCode varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@ParishCode is null) and (@SubCountyCode is null))
begin
	if not exists(select ParishCode from Parishes where ParishCode = @ParishCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Parish Code', @ParishCode, 'Parishes')
			return 1
		end
	else
	begin
		select ParishCode, ParishName, Parishes.SubCountyCode, SubCountyName, Counties.CountyCode, 
		CountyName, DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District, 
		dbo.GetMergedNameCode(ParishName,ParishCode) as ParishFullName
		from Parishes
		inner join SubCounties on Parishes.SubCountyCode = SubCounties.SubCountyCode
		inner join Counties on SubCounties.CountyCode = Counties.CountyCode	
		where ParishCode = @ParishCode
	end
end
else
if ((@ParishCode is null) and not (@SubCountyCode is null))
begin
		select ParishCode, ParishName, Parishes.SubCountyCode, SubCountyName, Counties.CountyCode, 
		CountyName, DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District, 
		dbo.GetMergedNameCode(ParishName,ParishCode) as ParishFullName
		from Parishes
		inner join SubCounties on Parishes.SubCountyCode = SubCounties.SubCountyCode
		inner join Counties on SubCounties.CountyCode = Counties.CountyCode	
		where Parishes.SubCountyCode = @SubCountyCode
end
else
if  ((@ParishCode is null) and (@SubCountyCode is null))
begin
		select ParishCode, ParishName, Parishes.SubCountyCode, SubCountyName, Counties.CountyCode, 
		CountyName, DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District, 
		dbo.GetMergedNameCode(ParishName,ParishCode) as ParishFullName
		from Parishes
		inner join SubCounties on Parishes.SubCountyCode = SubCounties.SubCountyCode
		inner join Counties on SubCounties.CountyCode = Counties.CountyCode		
end

return 0

go

/******************************************************************************************************
exec uspGetParishes 'P001'
exec uspGetParishes null, 'SC002'
exec uspGetParishes 
******************************************************************************************************/
-- select * from Parishes
-- delete from Parishes

------------------------------------------------------------------------------------------------------
-------------- Villages ------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Villages -----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertVillages')
	drop proc uspInsertVillages
go

create proc uspInsertVillages(
@VillageCode varchar(20),
@VillageName varchar(41),
@ParishCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select VillageCode from Villages where VillageCode = @VillageCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Village Code', @VillageCode)
		return 1
	end

if not exists(select ParishCode from Parishes where ParishCode  = @ParishCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Parish Code', @ParishCode, 'Parishes')
		return 1
	end

begin
insert into Villages
(VillageCode, VillageName, ParishCode)
values
(@VillageCode, @VillageName, @ParishCode)
return 0
end
go

/******************************************************************************************************
exec uspInsertVillages 'V001', 'MULUGA', 'P002'
exec uspInsertVillages 'V002', 'NAMATALA', 'P002'
exec uspInsertVillages 'V003', 'NSUBE', 'P009'
exec uspInsertVillages 'V004', 'JIIRA', 'P010'

******************************************************************************************************/
-- select * from Villages
-- delete from Villages

-------------- Update Villages -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateVillages')
	drop proc uspUpdateVillages
go

create proc uspUpdateVillages(
@VillageCode varchar(20),
@VillageName varchar(41),
@ParishCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VillageCode from Villages where VillageCode = @VillageCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Village Code', @VillageCode, 'Villages')
		return 1
	end

if not exists(select ParishCode from Parishes where ParishCode  = @ParishCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Parish Code', @ParishCode, 'Parishes')
		return 1
	end

begin
update Villages set
VillageName = @VillageName, ParishCode = @ParishCode
where VillageCode = @VillageCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateVillages 'V003', 'NSUBE', 'P009'
******************************************************************************************************/
-- select * from Villages
-- delete from Villages

-------------- Get Villages --------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVillages')
	drop proc uspGetVillages
go

create proc uspGetVillages(
@VillageCode varchar(20) = null,
@ParishCode varchar(20)= null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@VillageCode is null) and (@ParishCode is null))
begin
	if not exists(select VillageCode from Villages where VillageCode = @VillageCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Village Code', @VillageCode, 'Villages')
			return 1
		end
	else
	begin
		select VillageCode, VillageName, Villages.ParishCode, ParishName, 
		Parishes.SubCountyCode, SubCountyName, Counties.CountyCode, 
		CountyName, DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District,
		dbo.GetMergedNameCode(VillageName,VillageCode) as VillageFullName
		from Villages
		inner join Parishes on Villages.ParishCode = Parishes.ParishCode
		inner join SubCounties on Parishes.SubCountyCode = SubCounties.SubCountyCode
		inner join Counties on SubCounties.CountyCode = Counties.CountyCode		
		where VillageCode = @VillageCode
	end
end
else
if ((@VillageCode is null) and not (@ParishCode is null))
begin
		select VillageCode, VillageName, Villages.ParishCode, ParishName, 
		Parishes.SubCountyCode, SubCountyName, Counties.CountyCode, 
		CountyName, DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District,
		dbo.GetMergedNameCode(VillageName,VillageCode) as VillageFullName
		from Villages
		inner join Parishes on Villages.ParishCode = Parishes.ParishCode
		inner join SubCounties on Parishes.SubCountyCode = SubCounties.SubCountyCode
		inner join Counties on SubCounties.CountyCode = Counties.CountyCode	
		where Parishes.ParishCode = @ParishCode
end
else
if ((@VillageCode is null) and (@ParishCode is null))
begin
		select VillageCode, VillageName, Villages.ParishCode, ParishName, 
		Parishes.SubCountyCode, SubCountyName, Counties.CountyCode, 
		CountyName, DistrictsID, dbo.GetLookupDataDes(DistrictsID) as District,
		dbo.GetMergedNameCode(VillageName,VillageCode) as VillageFullName
		from Villages
		inner join Parishes on Villages.ParishCode = Parishes.ParishCode
		inner join SubCounties on Parishes.SubCountyCode = SubCounties.SubCountyCode
		inner join Counties on SubCounties.CountyCode = Counties.CountyCode		
end

return 0

go

/******************************************************************************************************
exec uspGetVillages 'V002'
exec uspGetVillages null, 'P002'
exec uspGetVillages 
******************************************************************************************************/
-- select * from Villages
-- delete from Villages

------------------------------------------------------------------------------------------------------
-------------- Suppliers -----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Suppliers ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertSuppliers')
	drop proc uspInsertSuppliers
go

create proc uspInsertSuppliers(
@SupplierNo varchar(20),
@SupplierName varchar(60),
@ContactPerson varchar(100),
@Address varchar(200),
@Phone varchar(30),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @SupplierID int
declare @CurrentYear as char(2)

if exists(select SupplierNo from Suppliers where SupplierNo = @SupplierNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Supplier No', @SupplierNo)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
	--------------------------------------------------------------------------------------------------------------
	set @CurrentYear = right(year(getdate()),2)
	set @SupplierID = (select max(SupplierID) from Suppliers where substring(SupplierNo, 2, 2) = @CurrentYear)
	set @SupplierID = dbo.GetNextAutoNumber('Suppliers', 'SupplierNo', @SupplierID)
	--------------------------------------------------------------------------------------------------------------

	insert into Suppliers
	(SupplierID, SupplierNo, SupplierName, ContactPerson, Address, Phone, LoginID)
	values
	(@SupplierID, @SupplierNo, @SupplierName, @ContactPerson, @Address, @Phone, @LoginID)


	return 0
end
go

/******************************************************************************************************
exec uspInsertSuppliers 'S15001', 'SyncSoft INTERNATIONAL LTD', 'CEO', 'Kampala', '0772609113'
exec uspInsertSuppliers 'S15002', 'ClinicMaster Software', 'CEO', 'Kampala', '0772609113'

******************************************************************************************************/
-- select * from Suppliers
-- delete from Suppliers

-------------- Update Suppliers ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateSuppliers')
	drop proc uspUpdateSuppliers
go

create proc uspUpdateSuppliers(
@SupplierNo varchar(20),
@SupplierName varchar(60),
@ContactPerson varchar(100),
@Address varchar(200),
@Phone varchar(30),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SupplierNo from Suppliers where SupplierNo = @SupplierNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Supplier No', @SupplierNo, 'Suppliers')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
	update Suppliers set
	SupplierName = @SupplierName, ContactPerson = @ContactPerson, Address = @Address, Phone = @Phone,
	LoginID =@LoginID
	where SupplierNo = @SupplierNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateSuppliers 'S15002', 'ClinicMaster Software1', 'CEO1', 'Kampala1', '07726091131'

******************************************************************************************************/
-- select * from Suppliers
-- delete from Suppliers

-------------- Get Suppliers -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetSuppliers')
	drop proc uspGetSuppliers
go

create proc uspGetSuppliers(
@SupplierNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

begin
if not (@SupplierNo is null)
begin
	if not exists(select SupplierNo from Suppliers where SupplierNo = @SupplierNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Supplier No', @SupplierNo, 'Suppliers')
			return 1
		end
	else
	begin
		select SupplierNo, SupplierName, dbo.GetMergedNameCode(SupplierName, SupplierNo) as SupplierFullName,
		ContactPerson, Address, Phone
		from Suppliers
		where SupplierNo = @SupplierNo
	end
end
else
if (@SupplierNo is null)
	begin
		select SupplierNo, SupplierName, CLinicMaster.dbo.GetMergedNameCode(SupplierName, SupplierNo) as SupplierFullName,
		ContactPerson, Address, Phone
		from Suppliers
		order by SupplierName
	end
	return 0
 end
go
/******************************************************************************************************
exec uspGetSuppliers
exec uspGetSuppliers 'S19001'

******************************************************************************************************/
-- select * from Suppliers
-- delete from Suppliers

--------GetNextSupplierID--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextSupplierID')
	drop proc uspGetNextSupplierID
go

create proc uspGetNextSupplierID(
@SupplierID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @SupplierID = (select max(SupplierID) from Suppliers where substring(SupplierNo, 2, 2) = @CurrentYear)
set @SupplierID = dbo.GetNextAutoNumber('Suppliers', 'SupplierNo', @SupplierID)

return 0

go

-- exec uspGetNextSupplierID
-- select * from Suppliers

------------------------------------------------------------------------------------------------------
-------------- AssetRegister --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert AssetRegister -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAssetRegister')
	drop proc uspInsertAssetRegister
go

create proc uspInsertAssetRegister(
@SerialNo Varchar(20),
@ManufacturerID Varchar(20),
@InstitutionalID Varchar(20),
@Photo Image =null,
@AssetSourceID Varchar(10),
@AssetCategoryID varchar(10),
@DeptID Varchar(10),
@ItemDescription Varchar(200),
@Brand Varchar(200),
@Quantity Int,
@Value Int,
@DateOfPurchase SmallDateTime,
@SupplierNo Varchar(20),
@InvoiceNo Varchar(20),
@InvoiceDate SmallDateTime,
@DateOfDelivery SmallDateTime,
@SalvageValue Int,
@DepreciationRate Int,
@UsefulLife Int,
@DepreciationMethodID Varchar(10),
@DepreciationStartDate SmallDateTime,
@AssignedTo Varchar(200),
@Location Varchar(200),
@ServicingSchedule int,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select SerialNo from AssetRegister where SerialNo = @SerialNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'SerialNo', @SerialNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AssetSourceID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Source', @AssetSourceID, 'Lookup Data')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @DeptID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Department', @DeptID, 'Lookup Data')
		return 1
	end

if not exists(select SupplierNo from Suppliers where SupplierNo  = @SupplierNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Supplier', @SupplierNo, 'Suppliers')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DepreciationMethodID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'DepreciationMethod', @DepreciationMethodID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into AssetRegister
(SerialNo, ManufacturerID, InstitutionalID, Photo, AssetSourceID, AssetCategoryID, DeptID, ItemDescription, Brand, Quantity, Value, DateOfPurchase, SupplierNo, InvoiceNo,
 InvoiceDate, DateOfDelivery, SalvageValue, DepreciationRate, UsefulLife, DepreciationMethodID, DepreciationStartDate, AssignedTo,
  Location, ServicingSchedule, LoginID)
values
(@SerialNo, @ManufacturerID, @InstitutionalID, @Photo, @AssetSourceID, @AssetCategoryID, @DeptID, @ItemDescription, @Brand, @Quantity, @Value, @DateOfPurchase, 
@SupplierNo, @InvoiceNo, @InvoiceDate, @DateOfDelivery, @SalvageValue, @DepreciationRate, @UsefulLife, @DepreciationMethodID, 
@DepreciationStartDate, @AssignedTo, @Location, @ServicingSchedule, @LoginID)

return 0
end
go

/******************************************************************************************************
exec uspInsertAssetRegister
******************************************************************************************************/
-- select * from AssetRegister
-- delete from AssetRegister


-------------- Update AssetRegister -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateAssetRegister')
	drop proc uspUpdateAssetRegister
go

create proc uspUpdateAssetRegister(
@SerialNo Varchar(20),
@ManufacturerID Varchar(20),
@InstitutionalID Varchar(20),
@Photo Image =null,
@AssetSourceID Varchar(10),
@AssetCategoryID varchar(10),
@DeptID Varchar(10),
@ItemDescription Varchar(200),
@Brand Varchar(200),
@Quantity Int,
@Value Int,
@DateOfPurchase SmallDateTime,
@SupplierNo Varchar(20),
@InvoiceNo Varchar(20),
@InvoiceDate SmallDateTime,
@DateOfDelivery SmallDateTime,
@SalvageValue Int,
@DepreciationRate Int,
@UsefulLife Int,
@DepreciationMethodID Varchar(10),
@DepreciationStartDate SmallDateTime,
@AssignedTo Varchar(200),
@Location Varchar(200),
@ServicingSchedule int,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SerialNo from AssetRegister where SerialNo = @SerialNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'SerialNo', @SerialNo, 'AssetRegister')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AssetSourceID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Source', @AssetSourceID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AssetCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'AssetCategory', @AssetCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DeptID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Department', @DeptID, 'Lookup Data')
		return 1
	end

if not exists(select SupplierNo from Suppliers where SupplierNo  = @SupplierNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Supplier', @SupplierNo, 'Suppliers')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DepreciationMethodID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'DepreciationMethod', @DepreciationMethodID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update AssetRegister set
ManufacturerID = @ManufacturerID, InstitutionalID = @InstitutionalID, Photo = @Photo, AssetSourceID = @AssetSourceID, AssetCategoryID = @AssetCategoryID, DeptID = @DeptID, 
ItemDescription = @ItemDescription, Brand = @Brand, Quantity = @Quantity, Value = @Value, 
DateOfPurchase = @DateOfPurchase, SupplierNo = @SupplierNo, InvoiceNo = @InvoiceNo, 
InvoiceDate = @InvoiceDate, DateOfDelivery = @DateOfDelivery, SalvageValue = @SalvageValue, DepreciationRate = @DepreciationRate, 
UsefulLife = @UsefulLife, DepreciationMethodID = @DepreciationMethodID, DepreciationStartDate = @DepreciationStartDate, 
AssignedTo = @AssignedTo, Location = @Location, ServicingSchedule = @ServicingSchedule, 
LoginID = @LoginID
where SerialNo = @SerialNo


return 0
end
go

/******************************************************************************************************
exec uspUpdateAssetRegister
******************************************************************************************************/
-- select * from AssetRegister
-- delete from AssetRegister


-------------- Get AssetRegister -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAssetRegister')
	drop proc uspGetAssetRegister
go

create proc uspGetAssetRegister(
@SerialNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SerialNo from AssetRegister where SerialNo = @SerialNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'SerialNo', @SerialNo, 'AssetRegister')
		return 1
	end
else
begin
select SerialNo, ManufacturerID, InstitutionalID, Photo, AssetSourceID, dbo.GetLookupDataDes(AssetSourceID) as [Source], AssetCategoryID, 
	dbo.GetLookupDataDes(AssetCategoryID) as AssetCategory, DeptID, dbo.GetLookupDataDes(DeptID) as [Department], 
	ItemDescription, Brand, Quantity, Value, DateOfPurchase, AssetRegister.SupplierNo,
	AssetRegister.SupplierNo as SupplierNo,dbo.GetMergedNameCode(SupplierName,AssetRegister.SupplierNo) as SupplierFullName,
	 InvoiceNo, InvoiceDate, DateOfDelivery, SalvageValue, DepreciationRate, UsefulLife, DepreciationMethodID,
	 dbo.FormatDate(isnull(dbo.GetLastAssetServiceDate(SerialNo),AssetRegister.RecordDateTime)) as LastAssetServiceDate, 
	 dbo.GetLookupDataDes(DepreciationMethodID) as [DepreciationMethod], DepreciationStartDate, AssignedTo,
	  Location, ServicingSchedule, AssetRegister.LoginID, AssetRegister.ClientMachine, AssetRegister.RecordDateTime
	from AssetRegister
	inner join Suppliers on AssetRegister.SupplierNo = Suppliers.SupplierNo
	where SerialNo = @SerialNo
return 0
end
go

/******************************************************************************************************
exec uspGetAssetRegister '001'
******************************************************************************************************/
-- select * from AssetRegister
-- delete from AssetRegister


------------------------------------------------------------------------------------------------------
-------------- AssetMaintainanceLog --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert AssetMaintainanceLog -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAssetMaintainanceLog')
	drop proc uspInsertAssetMaintainanceLog
go

create proc uspInsertAssetMaintainanceLog(
@SerialNo Varchar(20),
@ActionTaken Varchar(200),
@MaintainanceDate SmallDateTime,
@MaintainedBy Varchar(200),
@MaintainaceCost Money,
@NextDue SmallDateTime,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SerialNo from AssetRegister where SerialNo  = @SerialNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Serial No', @SerialNo, 'Asset Register')
		return 1
	end

if exists(select SerialNo from AssetMaintainanceLog where SerialNo = @SerialNo and MaintainanceDate = @MaintainanceDate)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: '+ dbo.FormatDate(@MaintainanceDate) +', you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Serial No', @SerialNo, 'Maintainance Date', 'Asset Maintainance Log')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into AssetMaintainanceLog
(SerialNo, ActionTaken, MaintainanceDate, MaintainedBy, MaintainaceCost, NextDue, LoginID)
values
(@SerialNo, @ActionTaken, @MaintainanceDate, @MaintainedBy, @MaintainaceCost, @NextDue, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertAssetMaintainanceLog
******************************************************************************************************/
-- select * from AssetMaintainanceLog
-- delete from AssetMaintainanceLog


-------------- Update AssetMaintainanceLog -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateAssetMaintainanceLog')
	drop proc uspUpdateAssetMaintainanceLog
go

create proc uspUpdateAssetMaintainanceLog(
@SerialNo Varchar(20),
@ActionTaken Varchar(200),
@MaintainanceDate SmallDateTime,
@MaintainedBy Varchar(200),
@MaintainaceCost Money,
@NextDue SmallDateTime,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SerialNo from AssetMaintainanceLog where SerialNo = @SerialNo and MaintainanceDate = @MaintainanceDate)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: '+ dbo.FormatDate(@MaintainanceDate) +', you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'SerialNo', @SerialNo, 'Maintainance Date', 'AssetMaintainanceLog')
		return 1

	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update AssetMaintainanceLog set
ActionTaken = @ActionTaken, MaintainedBy = @MaintainedBy, MaintainaceCost = @MaintainaceCost, NextDue = @NextDue, LoginID = @LoginID
where SerialNo = @SerialNo and MaintainanceDate = @MaintainanceDate
return 0
end
go

/******************************************************************************************************
exec uspUpdateAssetMaintainanceLog
******************************************************************************************************/
-- select * from AssetMaintainanceLog
-- delete from AssetMaintainanceLog


-------------- Get AssetMaintainanceLog -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAssetMaintainanceLog')
	drop proc uspGetAssetMaintainanceLog
go

create proc uspGetAssetMaintainanceLog(
@SerialNo Varchar(20),
@MaintainanceDate SmallDateTime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SerialNo from AssetMaintainanceLog where SerialNo = @SerialNo and MaintainanceDate = @MaintainanceDate)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: '+ dbo.FormatDate(@MaintainanceDate) +', you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'SerialNo', @SerialNo, 'Maintainance Date', 'AssetMaintainanceLog')
		return 1
	end
else
begin
	select SerialNo, ActionTaken, MaintainanceDate, MaintainedBy, MaintainaceCost, NextDue, AssetMaintainanceLog.LoginID, ClientMachine, RecordDateTime
	from AssetMaintainanceLog
	where SerialNo = @SerialNo and MaintainanceDate = @MaintainanceDate
return 0
end
go

/******************************************************************************************************
exec uspGetAssetMaintainanceLog
******************************************************************************************************/
-- select * from AssetMaintainanceLog
-- delete from AssetMaintainanceLog

------------------------------------------------------------------------------------------------------
-------------- ResearchRoutingForm --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ResearchRoutingForm -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertResearchRoutingForm')
	drop proc uspInsertResearchRoutingForm
go

create proc uspInsertResearchRoutingForm(
@UCIID varchar(20),
@PatientNo varchar(20),
@FirstName varchar(20),
@LastName varchar(20),
@OtherName varchar(20),
@ReferalInitials varchar(10),
@GenderID varchar(10),
@BirthDate smalldatetime,
@VillageCode varchar(10),
@ReferralDate smalldatetime,
@ReferralStudyCodeID varchar(10),
@ReferralStudyName varchar(100),
@Diagnosis varchar(1000),
@HealthUnitCode varchar(20),
@ReferredBy varchar(100),
@PatientScreenedBy varchar(200),
@ReferralInitials varchar(10),
@EligibleForScreeningID varchar(10),
@ExclusionReason varchar(1000),
@PatientReferedTo varchar(200),
@ReferredDate smalldatetime,
@SCRNo varchar(20),
@PID varchar(20),
@SID varchar(20),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @UCINo int
declare @CurrentYear as char(2)

if exists(select UCIID from ResearchRoutingForm where UCIID = @UCIID)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'UCI ID', @UCIID)
		return 1
	end

	
if not (@PatientNo is null or @PatientNo='') and not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PatientNo', @PatientNo, 'Patients')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GenderID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sex', @GenderID, 'Lookup Data')
		return 1
	end

if not exists(select VillageCode from Villages where VillageCode  = @VillageCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Village', @VillageCode, 'Villages')
		return 1
	end
	
if not exists(select DataID from LookupData where DataID = @ReferralStudyCodeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Referral Study Code ', @ReferralStudyCodeID, 'Lookup Data')
		return 1
	end	

if not exists(select HealthUnitCode from HealthUnits where HealthUnitCode  = @HealthUnitCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Heath Unit Code', @HealthUnitCode, 'HeathUnits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EligibleForScreeningID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Eligible For Screening', @EligibleForScreeningID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin

--------------------------------------------------------------------------------------------------------------
	set @CurrentYear = right(year(getdate()),2)
	set @UCINo = (select max(UCINo) from ResearchRoutingForm where substring(UCIID, 2, 2) = @CurrentYear)
	set @UCINo = dbo.GetNextAutoNumber('ResearchRoutingForm', 'UCIID', @UCINo)
--------------------------------------------------------------------------------------------------------------


insert into ResearchRoutingForm
(UCINo,UCIID,PatientNo, FirstName, LastName, OtherName, ReferalInitials, GenderID, BirthDate, 
VillageCode, ReferralDate, ReferralStudyCodeID, ReferralStudyName, Diagnosis, HealthUnitCode, 
ReferredBy, PatientScreenedBy, ReferralInitials, EligibleForScreeningID, ExclusionReason,
 PatientReferedTo, ReferredDate, SCRNo, PID, SID, LoginID)
values
(@UCINo,@UCIID,@PatientNo, @FirstName, @LastName, @OtherName, @ReferalInitials,
 @GenderID, @BirthDate, @VillageCode, @ReferralDate, @ReferralStudyCodeID, 
 @ReferralStudyName, @Diagnosis, @HealthUnitCode, @ReferredBy, @PatientScreenedBy,
  @ReferralInitials, @EligibleForScreeningID, @ExclusionReason, @PatientReferedTo,
   @ReferredDate, @SCRNo, @PID, @SID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertResearchRoutingForm
******************************************************************************************************/
-- select * from ResearchRoutingForm
-- delete from ResearchRoutingForm


-------------- Update ResearchRoutingForm -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateResearchRoutingForm')
	drop proc uspUpdateResearchRoutingForm
go

create proc uspUpdateResearchRoutingForm(
@UCIID varchar(20),
@FirstName varchar(20),
@LastName varchar(20),
@PatientNo varchar(20),
@OtherName varchar(20),
@ReferalInitials varchar(10),
@GenderID varchar(10),
@BirthDate smalldatetime,
@VillageCode varchar(10),
@ReferralDate smalldatetime,
@ReferralStudyCodeID varchar(10),
@ReferralStudyName varchar(100),
@Diagnosis varchar(1000),
@HealthUnitCode varchar(20),
@ReferredBy varchar(100),
@PatientScreenedBy varchar(200),
@ReferralInitials varchar(10),
@EligibleForScreeningID varchar(10),
@ExclusionReason varchar(1000),
@PatientReferedTo varchar(200),
@ReferredDate smalldatetime,
@SCRNo varchar(20),
@PID varchar(20),
@SID varchar(20),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select UCIID from ResearchRoutingForm where UCIID = @UCIID)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'UCI ID', @UCIID, 'ResearchRoutingForm')
		return 1
	end

	if not (@PatientNo is null or @PatientNo='') and not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PatientNo', @PatientNo, 'Patients')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GenderID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sex', @GenderID, 'Lookup Data')
		return 1
	end

if not exists(select VillageCode from Villages where VillageCode  = @VillageCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Village', @VillageCode, 'Villages')
		return 1
	end
	
if not exists(select DataID from LookupData where DataID = @ReferralStudyCodeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Referral Study Code ', @ReferralStudyCodeID, 'Lookup Data')
		return 1
	end
	
if not exists(select HealthUnitCode from HealthUnits where HealthUnitCode  = @HealthUnitCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Referral Clinic', @HealthUnitCode, 'HeathUnits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EligibleForScreeningID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Eligible For Screening', @EligibleForScreeningID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update ResearchRoutingForm set 
PatientNo=@PatientNo, FirstName = @FirstName, LastName = @LastName, OtherName = @OtherName, 
ReferalInitials = @ReferalInitials, GenderID = @GenderID, BirthDate = @BirthDate, 
VillageCode = @VillageCode, ReferralDate = @ReferralDate,ReferralStudyCodeID = @ReferralStudyCodeID, 
ReferralStudyName = @ReferralStudyName, Diagnosis = @Diagnosis, HealthUnitCode = @HealthUnitCode, 
ReferredBy = @ReferredBy, PatientScreenedBy = @PatientScreenedBy, ReferralInitials = @ReferralInitials
, EligibleForScreeningID = @EligibleForScreeningID, ExclusionReason = @ExclusionReason, 
PatientReferedTo = @PatientReferedTo, ReferredDate = @ReferredDate, SCRNo = @SCRNo, 
PID = @PID, SID = @SID, LoginID = @LoginID
where UCIID = @UCIID
return 0
end
go

/******************************************************************************************************
exec uspUpdateResearchRoutingForm
******************************************************************************************************/
-- select * from ResearchRoutingForm
-- delete from ResearchRoutingForm


-------------- Get ResearchRoutingForm -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetResearchRoutingForm')
	drop proc uspGetResearchRoutingForm
go

create proc uspGetResearchRoutingForm(
@UCIID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select UCIID from ResearchRoutingForm where UCIID = @UCIID)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'UCI ID', @UCIID, 'ResearchRoutingForm')
		return 1
	end
else
begin
	select UCINo, UCIID,PatientNo, FirstName, LastName, OtherName, 
	dbo.GetFullName(LastName, OtherName, FirstName) as FullName,
	ReferalInitials, GenderID, 
	dbo.GetLookupDataDes(GenderID) as Sex, BirthDate, ResearchRoutingForm.VillageCode, 
	ReferralDate, ReferralStudyCodeID, dbo.GetLookupDataDes(ReferralStudyCodeID) as ReferralStudyCode,
	 ReferralStudyName, Diagnosis,dbo.GetAge(BirthDate, getdate()) as Age,
	  ResearchRoutingForm.HealthUnitCode, ReferredBy,dbo.GetLookupDataName(PatientScreenedBy) as PatientScreenedBy,
	  ReferralInitials, EligibleForScreeningID,
	   dbo.GetLookupDataDes(EligibleForScreeningID) as EligibleForScreening, 
	   ExclusionReason, PatientReferedTo, ReferredDate, SCRNo, PID, SID, 
	   ResearchRoutingForm.LoginID, ResearchRoutingForm.ClientMachine, ResearchRoutingForm.RecordDateTime
	  from ResearchRoutingForm
	inner join HealthUnits on ResearchRoutingForm.HealthUnitCode = HealthUnits.HealthUnitCode	
	where UCIID = @UCIID
return 0
end
go

/******************************************************************************************************
exec uspGetResearchRoutingForm
******************************************************************************************************/
-- select * from ResearchRoutingForm
-- delete from ResearchRoutingForm
--------GetNextResearchRoutingFormID--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextResearchRoutingFormID')
	drop proc uspGetNextResearchRoutingFormID
go

create proc uspGetNextResearchRoutingFormID(
@UCINo int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @UCINo = (select max(UCINo) from ResearchRoutingForm where substring(UCIID, 2, 2) = @CurrentYear)
set @UCINo = dbo.GetNextAutoNumber('ResearchRoutingForm', 'UCIID', @UCINo)

return 0

go


-------------- Get tPeriodicResearchRoutingForm -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicResearchRoutingForm')
	drop proc uspGetPeriodicResearchRoutingForm
go

create proc uspGetPeriodicResearchRoutingForm(
@StartDate smalldatetime = null,
@EndDate smalldatetime= null
)with encryption as

declare @ErrorMSG varchar(200)

if @startDate is null and @EndDate is null
	
begin
	select UCINo, UCIID,PatientNo, FirstName, LastName, OtherName, 
	dbo.GetFullName(LastName, OtherName, FirstName) as FullName,
	ReferalInitials, GenderID, 
	dbo.GetLookupDataDes(GenderID) as Gender, BirthDate, ResearchRoutingForm.VillageCode, 
	ReferralDate, ReferralStudyCodeID, dbo.GetLookupDataDes(ReferralStudyCodeID) as ReferralStudyCode,
	 ReferralStudyName, Diagnosis,dbo.GetAge(BirthDate, getdate()) as Age,
	  ResearchRoutingForm.HealthUnitCode, ReferredBy,dbo.GetLookupDataName(PatientScreenedBy) as PatientScreenedBy,
	  ReferralInitials, EligibleForScreeningID,
	   dbo.GetLookupDataDes(EligibleForScreeningID) as EligibleForScreening, 
	   ExclusionReason, PatientReferedTo, dbo.FormatDate(ReferredDate) as ReferredDate, SCRNo, PID, SID, 
	   ResearchRoutingForm.LoginID, ResearchRoutingForm.ClientMachine, dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime 
	  from ResearchRoutingForm
	inner join HealthUnits on ResearchRoutingForm.HealthUnitCode = HealthUnits.HealthUnitCode	
end
else
begin
	select UCINo, UCIID,PatientNo, FirstName, LastName, OtherName, 
	dbo.GetFullName(LastName, OtherName, FirstName) as FullName,
	ReferalInitials, GenderID, 
	dbo.GetLookupDataDes(GenderID) as Gender, BirthDate, ResearchRoutingForm.VillageCode, 
	ReferralDate, ReferralStudyCodeID, dbo.GetLookupDataDes(ReferralStudyCodeID) as ReferralStudyCode,
	 ReferralStudyName, Diagnosis,dbo.GetAge(BirthDate, getdate()) as Age,
	  ResearchRoutingForm.HealthUnitCode, ReferredBy,dbo.GetLookupDataName(PatientScreenedBy) as PatientScreenedBy,
	  ReferralInitials, EligibleForScreeningID,
	   dbo.GetLookupDataDes(EligibleForScreeningID) as EligibleForScreening, 
	   ExclusionReason, PatientReferedTo, dbo.FormatDate(ReferredDate) as ReferredDate, SCRNo, PID, SID, 
	   ResearchRoutingForm.LoginID, ResearchRoutingForm.ClientMachine,
	   ResearchRoutingForm.LoginID, ResearchRoutingForm.ClientMachine, dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime 

	  from ResearchRoutingForm
	inner join HealthUnits on ResearchRoutingForm.HealthUnitCode = HealthUnits.HealthUnitCode	
	where dbo.FormatDate(RecordDateTime) between @StartDate and @EndDate
end
return 0

go

/******************************************************************************************************
exec uspGetPeriodicResearchRoutingForm
exec uspGetPeriodicResearchRoutingForm '1 Mar 2018', '2 Mar 2018'

******************************************************************************************************/
-- select * from ResearchRoutingForm
-- de

------------------------------------------------------------------------------------------------------
-------------- EnrollmentInformation --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert EnrollmentInformation -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertEnrollmentInformation')
	drop proc uspInsertEnrollmentInformation
go

create proc uspInsertEnrollmentInformation(
@UCIID varchar(20),
@ReferralStudyCodeID varchar(10),
@EnrolledID varchar(10),
@CoEnrolledID varchar(10),
@CoEnrolledStudyCodeID varchar(10),
@CCInitials varchar(20),
@ExclusionReason Varchar(1000),
@EnrollmentDate Smalldatetime,
@PatientReferred varchar(1000),
@ReferredDate Smalldatetime,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select UCIID from ResearchRoutingForm where UCIID  = @UCIID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'UCIID', @UCIID, 'Research Routing Form')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ReferralStudyCodeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Referral Study Code', @ReferralStudyCodeID, 'Lookup Data')
		return 1
	end

if exists(select UCIID from EnrollmentInformation where UCIID = @UCIID and ReferralStudyCodeID = @ReferralStudyCodeID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'UCIID', @UCIID, 'Referral Study Code', @ReferralStudyCodeID)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EnrolledID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Enrolled', @EnrolledID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CoEnrolledID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Co Enrolled', @CoEnrolledID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CoEnrolledStudyCodeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CoEnrolled Study Code', @CoEnrolledStudyCodeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into EnrollmentInformation
(UCIID, ReferralStudyCodeID, EnrolledID, CoEnrolledID, CoEnrolledStudyCodeID, 
CCInitials, ExclusionReason, EnrollmentDate, PatientReferred, ReferredDate, LoginID)
values
(@UCIID, @ReferralStudyCodeID, @EnrolledID, @CoEnrolledID, @CoEnrolledStudyCodeID,
 @CCInitials, @ExclusionReason, @EnrollmentDate, @PatientReferred, @ReferredDate,
  @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertEnrollmentInformation
******************************************************************************************************/
-- select * from EnrollmentInformation
-- delete from EnrollmentInformation


-------------- Update EnrollmentInformation -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateEnrollmentInformation')
	drop proc uspUpdateEnrollmentInformation
go

create proc uspUpdateEnrollmentInformation(
@UCIID varchar(20),
@ReferralStudyCodeID varchar(10),
@EnrolledID varchar(10),
@CoEnrolledID varchar(10),
@CoEnrolledStudyCodeID varchar(10),
@CCInitials varchar(20),
@ExclusionReason Varchar(1000),
@EnrollmentDate Smalldatetime,
@PatientReferred varchar(1000),
@ReferredDate Smalldatetime,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select UCIID from EnrollmentInformation where UCIID = @UCIID and ReferralStudyCodeID = @ReferralStudyCodeID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'UCIID', @UCIID, 'Referral Study Code', @ReferralStudyCodeID, 'Enrollment Information')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EnrolledID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Enrolled', @EnrolledID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CoEnrolledID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Co Enrolled', @CoEnrolledID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CoEnrolledStudyCodeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CoEnrolled Study Code', @CoEnrolledStudyCodeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update EnrollmentInformation set
EnrolledID = @EnrolledID, CoEnrolledID = @CoEnrolledID, CoEnrolledStudyCodeID = @CoEnrolledStudyCodeID,
 CCInitials = @CCInitials, ExclusionReason = @ExclusionReason, EnrollmentDate = @EnrollmentDate, PatientReferred = @PatientReferred, ReferredDate = @ReferredDate,
  LoginID = @LoginID
where UCIID = @UCIID and ReferralStudyCodeID = @ReferralStudyCodeID
return 0
end
go

/******************************************************************************************************
exec uspUpdateEnrollmentInformation
******************************************************************************************************/
-- select * from EnrollmentInformation
-- delete from EnrollmentInformation


-------------- Get EnrollmentInformation -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetEnrollmentInformation')
	drop proc uspGetEnrollmentInformation
go

create proc uspGetEnrollmentInformation(
@UCIID varchar(20),
@ReferralStudyCodeID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select UCIID from EnrollmentInformation where UCIID = @UCIID and ReferralStudyCodeID = @ReferralStudyCodeID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'UCIID', @UCIID, 'Referral Study Code', @ReferralStudyCodeID, 'Enrollment Information')
		return 1
	end
else
begin
	select UCIID, ReferralStudyCodeID, EnrolledID, dbo.GetLookupDataDes(EnrolledID) as Enrolled, 
	CoEnrolledID, dbo.GetLookupDataDes(CoEnrolledID) as CoEnrolled, CoEnrolledStudyCodeID, 
	dbo.GetLookupDataDes(CoEnrolledStudyCodeID) as CoEnrolledStudyCode, CCInitials, ExclusionReason,
	 EnrollmentDate, PatientReferred, ReferredDate, EnrollmentInformation.LoginID, 
	 ClientMachine, RecordDateTime
	from EnrollmentInformation

	where UCIID = @UCIID and ReferralStudyCodeID = @ReferralStudyCodeID
return 0
end
go

/******************************************************************************************************
exec uspGetEnrollmentInformation
******************************************************************************************************/
-- select * from EnrollmentInformation
-- delete from EnrollmentInformation



------------------------------------------------------------------------------------------------------
-------------- Procedures ----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Procedures ---------------------------------------------------------------------


if exists (select * from sysobjects where name = 'uspInsertProcedures')
	drop proc uspInsertProcedures
go

create proc uspInsertProcedures(
@ProcedureCode varchar(10),
@ProcedureName varchar(800),
@ShortName varchar(200),
@ProcedureCategoryID varchar(10),
@UnitCost money,
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit
)with encryption as

declare @ErrorMSG varchar(200)
declare @ProcedureID Int
declare @ProcedureCodePrefix varchar(1)

if exists(select ProcedureCode from Procedures where ProcedureCode = @ProcedureCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ProcedureCode)
		return 1
	end
if not exists(select DataID from LookupData where DataID = @ProcedureCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Optical Category ID', @ProcedureCategoryID, 'Lookup Data')
		return 1
	end


begin
	set @ProcedureCodePrefix = dbo.GetOptionValue('ProcedureCodePrefix')
	set @ProcedureID = (select max(ProcedureID) from Procedures where left(ProcedureCode, len(@ProcedureCodePrefix)) = @ProcedureCodePrefix)
	set @ProcedureID = dbo.GetNextAutoNumber('Procedures', 'ProcedureCode', @ProcedureID)

insert into Procedures
(ProcedureID, ProcedureCode, ProcedureName, ShortName,ProcedureCategoryID,UnitCost,UnitPrice, VATPercentage, Hidden)
values
(@ProcedureID, @ProcedureCode, @ProcedureName, @ShortName,@ProcedureCategoryID,@UnitCost, @UnitPrice,@VATPercentage, @Hidden)
return 0
end
go

/******************************************************************************************************
exec uspInsertProcedures '1', 'Therapeutic ultrasound of vessels of head and neck', 'vessels of head and neck', 0, 0
exec uspInsertProcedures '10', 'Implantation of chemotherapeutic agent', '', 0, 0
exec uspInsertProcedures '100', 'Removal of embedded foreign body from conjunctiva by incision', '', 0, 0

******************************************************************************************************/
-- select * from Procedures
-- delete from Procedures


---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextProcedureID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextProcedureID')
	drop proc uspGetNextProcedureID
go
create proc uspGetNextProcedureID(
@ProcedureID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @ProcedureCodePrefix varchar(1)

set @ProcedureCodePrefix =dbo.GetOptionValue('ProcedureCodePrefix')

set @ProcedureID = (select max(ProcedureID) from Procedures where left(ProcedureCode, len(@ProcedureCodePrefix)) = @ProcedureCodePrefix)
set @ProcedureID =  dbo.GetNextAutoNumber('Procedures', 'ProcedureCode', @ProcedureID)

return 0
go




-------------- Update Procedures -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateProcedures')
	drop proc uspUpdateProcedures
go

create proc uspUpdateProcedures(
@ProcedureCode varchar(10),
@ProcedureName varchar(800),
@ShortName varchar(200),
@ProcedureCategoryID varchar(10),
@UnitCost money,
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ProcedureCode from Procedures where ProcedureCode = @ProcedureCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ProcedureCode, 'Procedures')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ProcedureCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Optical Category ID', @ProcedureCategoryID, 'Lookup Data')
		return 1
	end

begin
	update Procedures set
	ProcedureName = @ProcedureName, ShortName = @ShortName,ProcedureCategoryID =@ProcedureCategoryID,UnitCost=@UnitCost,
	UnitPrice = @UnitPrice,VATPercentage=@VATPercentage, Hidden = @Hidden
	where ProcedureCode = @ProcedureCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateProcedures '100', 'Removal of embedded foreign body from conjunctiva by incision1', 
						'conjunctiva by incision1', 10, 1

******************************************************************************************************/
-- select * from Procedures
-- delete from Procedures

-------------- Get Procedures -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetProcedures')
	drop proc uspGetProcedures
go

create proc uspGetProcedures(
@ProcedureCode varchar(10) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not (@ProcedureCode is null)
begin
	if not exists(select ProcedureCode from Procedures where ProcedureCode = @ProcedureCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ProcedureCode, 'Procedures')
			return 1
		end
	else
	begin
		select ProcedureCode, ProcedureName, ShortName, UnitCost, UnitPrice,VATPercentage,ProcedureCategoryID,dbo.GetLookupDataDes(ProcedureCategoryID) as ProcedureCategory,
		 dbo.GetMergedNameCode(ProcedureName, ProcedureCode) as ProcedureFullName, Hidden
		from Procedures
		where ProcedureCode = @ProcedureCode
	end
end
else
if (@ProcedureCode is null)
begin
	begin
		select ProcedureCode, ProcedureName, ShortName,UnitCost, UnitPrice,VATPercentage,ProcedureCategoryID,dbo.GetLookupDataDes(ProcedureCategoryID) as ProcedureCategory,
		dbo.GetMergedNameCode(ProcedureName, ProcedureCode) as ProcedureFullName,Hidden
		from Procedures
		where Hidden = @Hidden
		order by ProcedureName
	end
end
go
/******************************************************************************************************
exec uspGetProcedures
exec uspGetProcedures '1'

******************************************************************************************************/
-- select * from Procedures
-- delete from Procedures

------------------------------------------------------------------------------------------------------
-------------- DentalServices ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert DentalServices -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertDentalServices')
	drop proc uspInsertDentalServices
go

create proc uspInsertDentalServices(
@DentalCode varchar(10),
@DentalName varchar(200),
@DentalCategoryID varchar(10),
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
declare @DentalID Int
declare @DentalCodePrefix varchar(1)

if exists(select DentalCode from DentalServices where DentalCode = @DentalCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Dental Code', @DentalCode)
		return 1
	end
else
begin
	set @DentalCodePrefix = dbo.GetOptionValue('DentalCodePrefix')
	set @DentalID = (select max(DentalID) from DentalServices where left(DentalCode, len(@DentalCodePrefix)) = @DentalCodePrefix)
	set @DentalID = dbo.GetNextAutoNumber('DentalServices', 'DentalCode', @DentalID)

	insert into DentalServices
	(DentalID, DentalCode, DentalName, DentalCategoryID, UnitPrice, VATPercentage, Hidden)
	values
	(@DentalID, @DentalCode, @DentalName, @DentalCategoryID, @UnitPrice,@VATPercentage, @Hidden)

	return 0
end
go

/******************************************************************************************************
exec uspInsertDentalServices 'EXT', 'Extraction', 90000, 0
exec uspInsertDentalServices 'EXT1', 'Extraction1', 90000, 0
exec uspInsertDentalServices 'REP', 'Repair', 80000, 0

******************************************************************************************************/
-- select * from DentalServices
-- delete from DentalServices

---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextDentalID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextDentalID')
	drop proc uspGetNextDentalID
go
create proc uspGetNextDentalID(
@DentalID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @DentalCodePrefix varchar(1)

set @DentalCodePrefix =dbo.GetOptionValue('DentalCodePrefix')

set @DentalID = (select max(DentalID) from DentalServices where left(DentalCode, len(@DentalCodePrefix)) = @DentalCodePrefix)
set @DentalID =  dbo.GetNextAutoNumber('DentalServices', 'DentalCode', @DentalID)

return 0
go


-------------- Update DentalServices ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateDentalServices')
	drop proc uspUpdateDentalServices
go

create proc uspUpdateDentalServices(
@DentalCode varchar(10),
@DentalName varchar(200),
@DentalCategoryID varchar(10),
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DentalCode from DentalServices where DentalCode = @DentalCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Dental Code', @DentalCode, 'Dental Services')
		return 1
	end
begin
	update DentalServices set
	DentalName = @DentalName, DentalCategoryID = @DentalCategoryID, UnitPrice = @UnitPrice, VATPercentage=@VATPercentage,Hidden = @Hidden
	where DentalCode = @DentalCode

	return 0
end
go

/******************************************************************************************************
exec uspUpdateDentalServices 'EXT1', 'Extraction11', 19000, 1

******************************************************************************************************/
-- select * from DentalServices
-- delete from DentalServices

-------------- Get DentalServices -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDentalServices')
	drop proc uspGetDentalServices
go

create proc uspGetDentalServices(
@DentalCode varchar(10) = null,
@DentalCategoryID varchar(10) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not (@DentalCode is null)
begin

	if not exists(select DentalCode from DentalServices where DentalCode = @DentalCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Dental Code', @DentalCode, 'Dental Services')
			return 1
		end
	else
	begin
		select DentalCode, DentalName, UnitPrice,VATPercentage, Hidden, 
		DentalCategoryID, dbo.GetLookupDataDes(DentalCategoryID) as DentalCategory, dbo.GetMergedNameCode(DentalName,DentalCode) as DentalFullName
		from DentalServices
		where DentalCode = @DentalCode
	end
end
else
if (@DentalCode is null) and not(@DentalCategoryID is null)
begin
	begin
		select DentalCode, DentalName, UnitPrice,VATPercentage, Hidden, 
		DentalCategoryID, dbo.GetLookupDataDes(DentalCategoryID) as DentalCategory, dbo.GetMergedNameCode(DentalName,DentalCode) as DentalFullName
		from DentalServices
		where DentalCategoryID = @DentalCategoryID and Hidden = @Hidden
		order by DentalName
	end
end
else
if (@DentalCode is null) and (@DentalCategoryID is null)
begin
	begin
		select DentalCode, DentalName, UnitPrice,VATPercentage, Hidden, 
		DentalCategoryID, dbo.GetLookupDataDes(DentalCategoryID) as DentalCategory, dbo.GetMergedNameCode(DentalName,DentalCode) as DentalFullName
		from DentalServices
		where Hidden = @Hidden
		order by DentalName
	end
end
go

/******************************************************************************************************
exec uspGetDentalServices
exec uspGetDentalServices '3.2'
exec uspGetDentalServices null, '102S'
exec uspGetDentalServices null, '102L'

******************************************************************************************************/
-- select * from DentalServices
-- delete from DentalServices

------------------------------------------------------------------------------------------------------
-------------- TheatreServices -----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert TheatreServices ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertTheatreServices')
	drop proc uspInsertTheatreServices
go

create proc uspInsertTheatreServices(
@TheatreCode varchar(20),
@TheatreName varchar(200),
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
declare @TheatreID Int
declare @TheatreCodePrefix varchar(1)

if exists(select TheatreCode from TheatreServices where TheatreCode = @TheatreCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @TheatreCode)
		return 1
	end

begin
	set @TheatreCodePrefix = dbo.GetOptionValue('TheatreCodePrefix')
	set @TheatreID = (select max(TheatreID) from TheatreServices where left(TheatreCode, len(@TheatreCodePrefix)) = @TheatreCodePrefix)
	set @TheatreID = dbo.GetNextAutoNumber('TheatreServices', 'TheatreCode', @TheatreID)

insert into TheatreServices
(TheatreID, TheatreCode, TheatreName, UnitPrice,VATPercentage, Hidden)
values
(@TheatreID, @TheatreCode, @TheatreName, @UnitPrice,@VATPercentage, @Hidden)
return 0
end
go

/******************************************************************************************************
exec uspInsertTheatreServices 'H001', 'Professional Fees', 90000
exec uspInsertTheatreServices 'H002', 'Threatre Fees', 90000, 1
exec uspInsertTheatreServices 'H003', 'Consultant Fees', 90000, 1

******************************************************************************************************/
-- select * from TheatreServices
-- delete from TheatreServices

---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextTheatreID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextTheatreID')
	drop proc uspGetNextTheatreID
go
create proc uspGetNextTheatreID(
@TheatreID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @TheatreCodePrefix varchar(1)

set @TheatreCodePrefix =dbo.GetOptionValue('TheatreCodePrefix')

set @TheatreID = (select max(TheatreID) from TheatreServices where left(TheatreCode, len(@TheatreCodePrefix)) = @TheatreCodePrefix)
set @TheatreID =  dbo.GetNextAutoNumber('TheatreServices', 'TheatreCode', @TheatreID)

return 0
go




-------------- Update TheatreServices ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateTheatreServices')
	drop proc uspUpdateTheatreServices
go

create proc uspUpdateTheatreServices(
@TheatreCode varchar(20),
@TheatreName varchar(200),
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TheatreCode from TheatreServices where TheatreCode = @TheatreCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @TheatreCode, 'Theatre Services')
		return 1
	end

begin
update TheatreServices set
TheatreName = @TheatreName, UnitPrice = @UnitPrice,VATPercentage=@VATPercentage, Hidden = @Hidden
where TheatreCode = @TheatreCode

return 0
end
go

/******************************************************************************************************
exec uspUpdateTheatreServices 'H003', 'Consultant Fees2', 7000, 0

******************************************************************************************************/
-- select * from TheatreServices
-- delete from TheatreServices

-------------- Get TheatreServices -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTheatreServices')
	drop proc uspGetTheatreServices
go

create proc uspGetTheatreServices(
@TheatreCode varchar(20) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not (@TheatreCode is null)
begin
	if not exists(select TheatreCode from TheatreServices where TheatreCode = @TheatreCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @TheatreCode, 'Theatre Services')
			return 1
		end
	else
	begin
		select TheatreCode, TheatreName, UnitPrice,VATPercentage,dbo.GetMergedNameCode(TheatreName,TheatreCode)as TheatreServicesFullName,
		 Hidden
		from TheatreServices
		where TheatreCode = @TheatreCode
	end
end
else 
if (@TheatreCode is null)
begin	
	select TheatreCode, TheatreName, UnitPrice, VATPercentage,dbo.GetMergedNameCode(TheatreName,TheatreCode)as TheatreServicesFullName,
	 Hidden
	from TheatreServices
	where Hidden = @Hidden
	order by TheatreName	
end
go

/******************************************************************************************************
exec uspGetTheatreServices
exec uspGetTheatreServices 'H002'
 
******************************************************************************************************/
-- select * from TheatreServices
-- delete from TheatreServices

------------------------------------------------------------------------------------------------------
-------------- EyeServices ---------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert EyeServices --------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertEyeServices')
	drop proc uspInsertEyeServices
go

create proc uspInsertEyeServices(
@EyeCode varchar(20),
@EyeName varchar(200),
@UnitCost money,
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
declare @EyeID Int
declare @EyeCodePrefix varchar(1)

if exists(select EyeCode from EyeServices where EyeCode = @EyeCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Eye Code', @EyeCode)
		return 1
	end

begin
	set @EyeCodePrefix = dbo.GetOptionValue('EyeCodePrefix')
	set @EyeID = (select max(EyeID) from EyeServices where left(EyeCode, len(@EyeCodePrefix)) = @EyeCodePrefix)
	set @EyeID = dbo.GetNextAutoNumber('EyeServices', 'EyeCode', @EyeID)

insert into EyeServices
(EyeID, EyeCode, EyeName, UnitCost, UnitPrice,VATPercentage, Hidden)
values
(@EyeID, @EyeCode, @EyeName, @UnitCost, @UnitPrice,@VATPercentage, @Hidden)
return 0
end
go

/******************************************************************************************************
exec uspInsertEyeServices 'O001', 'Professional Fees', 90000
exec uspInsertEyeServices 'O002', 'Threatre Fees', 90000, 1
exec uspInsertEyeServices 'O003', 'Consultant Fees', 90000, 1

******************************************************************************************************/
-- select * from EyeServices
-- delete from EyeServices

---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextEyeID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextEyeID')
	drop proc uspGetNextEyeID
go
create proc uspGetNextEyeID(
@EyeID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @EyeCodePrefix varchar(1)

set @EyeCodePrefix =dbo.GetOptionValue('EyeCodePrefix')

set @EyeID = (select max(EyeID) from EyeServices where left(EyeCode, len(@EyeCodePrefix)) = @EyeCodePrefix)
set @EyeID =  dbo.GetNextAutoNumber('EyeServices', 'EyeCode', @EyeID)

return 0
go


-------------- Update EyeServices ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateEyeServices')
	drop proc uspUpdateEyeServices
go

create proc uspUpdateEyeServices(
@EyeCode varchar(20),
@EyeName varchar(200),
@UnitCost money,
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select EyeCode from EyeServices where EyeCode = @EyeCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Eye Code', @EyeCode, 'Eye Services')
		return 1
	end

begin
update EyeServices set
EyeName = @EyeName, UnitCost = @UnitCost, UnitPrice = @UnitPrice,VATPercentage=@VATPercentage, Hidden = @Hidden
where EyeCode = @EyeCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateEyeServices 'O003', 'Consultant Fees2', 7000, 0

******************************************************************************************************/
-- select * from EyeServices
-- delete from EyeServices

-------------- GetEyeServices -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetEyeServices')
	drop proc uspGetEyeServices
go

create proc uspGetEyeServices(
@EyeCode varchar(20) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not (@EyeCode is null)
begin
	if not exists(select EyeCode from EyeServices where EyeCode = @EyeCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Eye Code', @EyeCode, 'Eye Services')
			return 1
		end
	else
	begin
		select EyeCode, EyeName, dbo.GetMergedNameCode(EyeName, EyeCode) as EyeFullName, 
		UnitCost, UnitPrice, VATPercentage,Hidden
		from EyeServices
		where EyeCode = @EyeCode
	end
end
else 
if (@EyeCode is null)
begin	
	select EyeCode, EyeName, dbo.GetMergedNameCode(EyeName, EyeCode) as EyeFullName, 
	UnitCost, UnitPrice,VATPercentage, Hidden
	from EyeServices
	where Hidden = @Hidden
	order by EyeName	
end
go

/******************************************************************************************************
exec uspGetEyeServices
exec uspGetEyeServices 'O002'
 
******************************************************************************************************/
-- select * from EyeServices
-- delete from EyeServices

/******************************************************************************************************
exec uspGetEyeServices
exec uspGetEyeServices 'O002'
 
******************************************************************************************************/
-- select * from EyeServices
-- delete from EyeServices

------------------------------------------------------------------------------------------------------
-------------- Refraction --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Refraction -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditRefraction')
	drop proc uspEditRefraction
go

create proc uspEditRefraction(
@VisitNo varchar(20),
@RightMRSPH varchar(200),
@LeftMRSPH varchar(200),
@RightMRCYL varchar(200),
@LeftMRCYL varchar(200),
@RightMRAXIS varchar(200),
@LeftMRAXIS varchar(200),
@RightCRSPH varchar(200),
@LeftCRSPH varchar(200),
@RightCRCYL varchar(200),
@LeftCRCYL varchar(200),
@RightCRAXIS varchar(200),
@LeftCRAXIS varchar(200),
@RightPCRSPH varchar(200),
@LeftPCRSPH varchar(200),
@RightPCRCYL varchar(200),
@LeftPCRCYL varchar(200),
@RightPCRAXIS varchar(200),
@LeftPCRRAXIS varchar(200),
@PD varchar(200),
@SegmentHeights varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
------------------------------------------------------------------------------------

if exists(select VisitNo from Refraction where VisitNo = @VisitNo)
begin	
update Refraction set
RightMRSPH = @RightMRSPH, LeftMRSPH = @LeftMRSPH, RightMRCYL = @RightMRCYL,
 LeftMRCYL = @LeftMRCYL, RightMRAXIS = @RightMRAXIS, LeftMRAXIS = @LeftMRAXIS, 
 RightCRSPH = @RightCRSPH, LeftCRSPH = @LeftCRSPH, RightCRCYL = @RightCRCYL, LeftCRCYL = @LeftCRCYL,
  RightCRAXIS = @RightCRAXIS, LeftCRAXIS = @LeftCRAXIS, RightPCRSPH = @RightPCRSPH,
   LeftPCRSPH = @LeftPCRSPH, RightPCRCYL = @RightPCRCYL, LeftPCRCYL = @LeftPCRCYL,
    RightPCRAXIS = @RightPCRAXIS, LeftPCRRAXIS = @LeftPCRRAXIS, PD = @PD, SegmentHeights = @SegmentHeights,
     LoginID = @LoginID
where VisitNo = @VisitNo
return 0
end
else
begin

insert into Refraction
(VisitNo, RightMRSPH, LeftMRSPH, RightMRCYL, LeftMRCYL, RightMRAXIS, LeftMRAXIS, RightCRSPH,
 LeftCRSPH, RightCRCYL, LeftCRCYL, RightCRAXIS, LeftCRAXIS, RightPCRSPH, LeftPCRSPH, RightPCRCYL, 
 LeftPCRCYL, RightPCRAXIS, LeftPCRRAXIS,PD, SegmentHeights, LoginID)
values
(@VisitNo, @RightMRSPH, @LeftMRSPH, @RightMRCYL, @LeftMRCYL, @RightMRAXIS, @LeftMRAXIS, @RightCRSPH,
 @LeftCRSPH, @RightCRCYL, @LeftCRCYL, @RightCRAXIS, @LeftCRAXIS, @RightPCRSPH, @LeftPCRSPH, @RightPCRCYL,
  @LeftPCRCYL, @RightPCRAXIS, @LeftPCRRAXIS,@PD, @SegmentHeights, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertRefraction
******************************************************************************************************/
-- select * from Refraction
-- delete from Refraction


-------------- Get Refraction -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRefraction')
	drop proc uspGetRefraction
go

create proc uspGetRefraction(
@VisitNo varchar(20)
)with encryption as
declare @ErrorMSG varchar(200)
begin
	select VisitNo, RightMRSPH, LeftMRSPH, RightMRCYL, LeftMRCYL, RightMRAXIS, LeftMRAXIS, RightCRSPH, LeftCRSPH, RightCRCYL, LeftCRCYL, RightCRAXIS, LeftCRAXIS, RightPCRSPH, LeftPCRSPH, RightPCRCYL, LeftPCRCYL, RightPCRAXIS, LeftPCRRAXIS,PD, SegmentHeights, Refraction.LoginID, RecordDateTime
	from Refraction

	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetRefraction
******************************************************************************************************/
-- select * from Refraction
-- delete from Refraction


------------------------------------------------------------------------------------------------------
-------------- OpticalServices -----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert OpticalServices ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertOpticalServices')
	drop proc uspInsertOpticalServices
go

create proc uspInsertOpticalServices(
@OpticalCode varchar(20),
@OpticalName varchar(200),
@OpticalCategoryID varchar(10),
@UnitCost money,
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
declare @OpticalID Int
declare @OpticalCodePrefix varchar(1)

if exists(select OpticalCode from OpticalServices where OpticalCode = @OpticalCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Optical Code', @OpticalCode)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OpticalCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Optical Category ID', @OpticalCategoryID, 'Lookup Data')
		return 1
	end

begin

	set @OpticalCodePrefix = dbo.GetOptionValue('OpticalCodePrefix')
	set @OpticalID = (select max(OpticalID) from OpticalServices where left(OpticalCode, len(@OpticalCodePrefix)) = @OpticalCodePrefix)
	set @OpticalID = dbo.GetNextAutoNumber('OpticalServices', 'OpticalCode', @OpticalID)


insert into OpticalServices
(OpticalID, OpticalCode, OpticalName, OpticalCategoryID,UnitCost, UnitPrice,VATPercentage, Hidden)
values
(@OpticalID, @OpticalCode, @OpticalName, @OpticalCategoryID,@UnitCost, @UnitPrice,@VATPercentage, @Hidden)
return 0
end
go

/******************************************************************************************************
exec uspInsertOpticalServices 'O001', 'Professional Fees', 90000
exec uspInsertOpticalServices 'O002', 'Threatre Fees', 90000, 1
exec uspInsertOpticalServices 'O003', 'Consultant Fees', 90000, 1

******************************************************************************************************/
-- select * from OpticalServices
-- delete from OpticalServices

---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextOpticalID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextOpticalID')
	drop proc uspGetNextOpticalID
go
create proc uspGetNextOpticalID(
@OpticalID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @OpticalCodePrefix varchar(1)

set @OpticalCodePrefix =dbo.GetOptionValue('OpticalCodePrefix')

set @OpticalID = (select max(OpticalID) from OpticalServices where left(OpticalCode, len(@OpticalCodePrefix)) = @OpticalCodePrefix)
set @OpticalID =  dbo.GetNextAutoNumber('OpticalServices', 'OpticalCode', @OpticalID)

return 0
go




-------------- Update OpticalServices ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateOpticalServices')
	drop proc uspUpdateOpticalServices
go

create proc uspUpdateOpticalServices(
@OpticalCode varchar(20),
@OpticalName varchar(200),
@OpticalCategoryID varchar(10),
@UnitCost money,
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select OpticalCode from OpticalServices where OpticalCode = @OpticalCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Optical Code', @OpticalCode, 'Optical Services')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OpticalCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Optical Category ID', @OpticalCategoryID, 'Lookup Data')
		return 1
	end

begin
update OpticalServices set
OpticalName = @OpticalName, OpticalCategoryID = @OpticalCategoryID, UnitPrice = @UnitPrice,
UnitCost=@UnitCost,
VATPercentage=@VATPercentage, Hidden = @Hidden
where OpticalCode = @OpticalCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateOpticalServices 'O003', 'Consultant Fees2', 7000, 0

******************************************************************************************************/
-- select * from OpticalServices
-- delete from OpticalServices

-------------- GetOpticalServices -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetOpticalServices')
	drop proc uspGetOpticalServices
go

create proc uspGetOpticalServices(
@OpticalCode varchar(20) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not (@OpticalCode is null)
begin
	if not exists(select OpticalCode from OpticalServices where OpticalCode = @OpticalCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Optical Code', @OpticalCode, 'Optical Services')
			return 1
		end
	else
	begin
		select OpticalCode, OpticalName, dbo.GetMergedNameCode(OpticalName, OpticalCode) as OpticalFullName, 
		OpticalCategoryID, dbo.GetLookupDataDes(OpticalCategoryID) as OpticalCategory, UnitPrice,UnitCost, VATPercentage,Hidden
		from OpticalServices
		where OpticalCode = @OpticalCode
	end
end
else 
if (@OpticalCode is null)
begin	
	select OpticalCode, OpticalName, dbo.GetMergedNameCode(OpticalName, OpticalCode) as OpticalFullName, 
	OpticalCategoryID, dbo.GetLookupDataDes(OpticalCategoryID) as OpticalCategory, UnitPrice,UnitCost,VATPercentage, Hidden
	from OpticalServices
	where Hidden = @Hidden
	order by OpticalName	
end
go

/******************************************************************************************************
exec uspGetOpticalServices
exec uspGetOpticalServices 'O002'
 
******************************************************************************************************/
-- select * from OpticalServices
-- delete from OpticalServices

------------------------------------------------------------------------------------------------------
-------------- MaternityServices -----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert MaternityServices ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertMaternityServices')
	drop proc uspInsertMaternityServices
go

create proc uspInsertMaternityServices(
@MaternityCode varchar(20),
@MaternityName varchar(200),
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
declare @MaternityID Int
declare @MaternityCodePrefix varchar(1)

if exists(select MaternityCode from MaternityServices where MaternityCode = @MaternityCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @MaternityCode)
		return 1
	end

begin
	set @MaternityCodePrefix = dbo.GetOptionValue('MaternityCodePrefix')
	set @MaternityID = (select max(MaternityID) from MaternityServices where left(MaternityCode, len(@MaternityCodePrefix)) = @MaternityCodePrefix)
	set @MaternityID = dbo.GetNextAutoNumber('MaternityServices', 'MaternityCode', @MaternityID)

insert into MaternityServices
(MaternityID, MaternityCode, MaternityName, UnitPrice, VATPercentage, Hidden)
values
(@MaternityID, @MaternityCode, @MaternityName, @UnitPrice,@VATPercentage, @Hidden)
return 0
end
go

/******************************************************************************************************
exec uspInsertMaternityServices 'O001', 'Professional Fees', 90000
exec uspInsertMaternityServices 'O002', 'Threatre Fees', 90000, 1
exec uspInsertMaternityServices 'O003', 'Consultant Fees', 90000, 1

******************************************************************************************************/
-- select * from MaternityServices
-- delete from MaternityServices


---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextMaternityID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextMaternityID')
	drop proc uspGetNextMaternityID
go
create proc uspGetNextMaternityID(
@MaternityID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @MaternityCodePrefix varchar(1)

set @MaternityCodePrefix =dbo.GetOptionValue('MaternityCodePrefix')

set @MaternityID = (select max(MaternityID) from MaternityServices where left(MaternityCode, len(@MaternityCodePrefix)) = @MaternityCodePrefix)
set @MaternityID =  dbo.GetNextAutoNumber('MaternityServices', 'MaternityCode', @MaternityID)

return 0
go

-------------- Update MaternityServices ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateMaternityServices')
	drop proc uspUpdateMaternityServices
go

create proc uspUpdateMaternityServices(
@MaternityCode varchar(20),
@MaternityName varchar(200),
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select MaternityCode from MaternityServices where MaternityCode = @MaternityCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @MaternityCode, 'Maternity Services')
		return 1
	end

begin
update MaternityServices set
MaternityName = @MaternityName, UnitPrice = @UnitPrice, VATPercentage=@VATPercentage, Hidden = @Hidden
where MaternityCode = @MaternityCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateMaternityServices 'O003', 'Consultant Fees2', 7000, 0

******************************************************************************************************/
-- select * from MaternityServices
-- delete from MaternityServices

-------------- Get MaternityServices -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetMaternityServices')
	drop proc uspGetMaternityServices
go

create proc uspGetMaternityServices(
@MaternityCode varchar(20) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not (@MaternityCode is null)
begin
	if not exists(select MaternityCode from MaternityServices where MaternityCode = @MaternityCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @MaternityCode, 'Maternity Services')
			return 1
		end
	else
	begin
		select MaternityCode, MaternityName, UnitPrice,VATPercentage,dbo.GetMergedNameCode(MaternityName,MaternityCode) as MaternityServiceFullName, Hidden
		from MaternityServices
		where MaternityCode = @MaternityCode
	end
end
else 
if (@MaternityCode is null)
begin	
	select MaternityCode, MaternityName, UnitPrice,VATPercentage,dbo.GetMergedNameCode(MaternityName,MaternityCode) as MaternityServiceFullName, Hidden
	from MaternityServices
	where Hidden = @Hidden
	order by MaternityName	
end
go

/******************************************************************************************************
exec uspGetMaternityServices
exec uspGetMaternityServices 'O002'
 
******************************************************************************************************/
-- select * from MaternityServices
-- delete from MaternityServices

------------------------------------------------------------------------------------------------------
-------------- ICUServices ---------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ICUServices --------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertICUServices')
	drop proc uspInsertICUServices
go

create proc uspInsertICUServices(
@ICUCode varchar(20),
@ICUName varchar(200),
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
declare @ICUID Int
declare @ICUCodePrefix varchar(1)

if exists(select ICUCode from ICUServices where ICUCode = @ICUCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ICUCode)
		return 1
	end

begin
	set @ICUCodePrefix = dbo.GetOptionValue('ICUCodePrefix')
	set @ICUID = (select max(ICUID) from ICUServices where left(ICUCode, len(@ICUCodePrefix)) = @ICUCodePrefix)
	set @ICUID = dbo.GetNextAutoNumber('ICUServices', 'ICUCode', @ICUID)

insert into ICUServices
(ICUID, ICUCode, ICUName, UnitPrice,VATPercentage, Hidden)
values
(@ICUID, @ICUCode, @ICUName, @UnitPrice,@VATPercentage, @Hidden)
return 0
end
go

/******************************************************************************************************
exec uspInsertICUServices 'O001', 'Professional Fees', 90000
exec uspInsertICUServices 'O002', 'Threatre Fees', 90000, 1
exec uspInsertICUServices 'O003', 'Consultant Fees', 90000, 1

******************************************************************************************************/
-- select * from ICUServices
-- delete from ICUServices

---------------------------------------------------------------------------------------------------------------------------------------------------
--------uspGetNextICUID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextICUID')
	drop proc uspGetNextICUID
go
create proc uspGetNextICUID(
@ICUID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @ICUCodePrefix varchar(1)

set @ICUCodePrefix =dbo.GetOptionValue('ICUCodePrefix')

set @ICUID = (select max(ICUID) from ICUServices where left(ICUCode, len(@ICUCodePrefix)) = @ICUCodePrefix)
set @ICUID =  dbo.GetNextAutoNumber('ICUServices', 'ICUCode', @ICUID)

return 0
go



-------------- Update ICUServices ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateICUServices')
	drop proc uspUpdateICUServices
go

create proc uspUpdateICUServices(
@ICUCode varchar(20),
@ICUName varchar(200),
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ICUCode from ICUServices where ICUCode = @ICUCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ICUCode, 'ICU Services')
		return 1
	end

begin
update ICUServices set
ICUName = @ICUName, UnitPrice = @UnitPrice, Hidden = @Hidden
where ICUCode = @ICUCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateICUServices 'O003', 'Consultant Fees2', 7000, 0

******************************************************************************************************/
-- select * from ICUServices
-- delete from ICUServices

-------------- Get ICUServices -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetICUServices')
	drop proc uspGetICUServices
go

create proc uspGetICUServices(
@ICUCode varchar(20) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not (@ICUCode is null)
begin
	if not exists(select ICUCode from ICUServices where ICUCode = @ICUCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ICUCode, 'ICU Services')
			return 1
		end
	else
	begin
		select ICUCode, ICUName, UnitPrice,VATPercentage, dbo.GetMergedNameCode(ICUName,ICUCode) as ICUFullName,Hidden
		from ICUServices
		where ICUCode = @ICUCode
	end
end
else 
if (@ICUCode is null)
begin	
	select ICUCode, ICUName, UnitPrice,VATPercentage, dbo.GetMergedNameCode(ICUName,ICUCode) as ICUFullName,Hidden
	from ICUServices
	where Hidden = @Hidden
	order by ICUName	
end
go


/******************************************************************************************************
exec uspGetICUServices
exec uspGetICUServices 'O002'
 
******************************************************************************************************/
-- select * from ICUServices
-- delete from ICUServices

------------------------------------------------------------------------------------------------------
-------------- Diseases ------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Diseases -----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertDiseases')
	drop proc uspInsertDiseases
go

create proc uspInsertDiseases(
@DiseaseCode varchar(10),
@DiseaseName varchar(800),
@DiseaseCategoriesID varchar(10),
@Hidden bit
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select DiseaseCode from Diseases where DiseaseCode = @DiseaseCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Disease Code', @DiseaseCode)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DiseaseCategoriesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Disease Categories ID', @DiseaseCategoriesID, 'Lookup Data')
		return 1
	end

begin
	insert into Diseases
	(DiseaseCode, DiseaseName, DiseaseCategoriesID, Hidden)
	values
	(@DiseaseCode, @DiseaseName, @DiseaseCategoriesID, @Hidden)
	return 0
end
go

/******************************************************************************************************
exec uspInsertDiseases 'A00.0', 'Cholera due to Vibrio cholerae 01, biovar cholerae', '431', 0
exec uspInsertDiseases 'A00.1', 'Cholera due to Vibrio cholerae 01, biovar el tor', '432', 0
exec uspInsertDiseases 'A00.9', 'Cholera, unspecified', '433', 0
exec uspInsertDiseases 'A01.0', 'Typhoid fever', '434', 0

******************************************************************************************************/
-- select * from Diseases
-- delete from Diseases

-------------- Update Diseases -----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateDiseases')
	drop proc uspUpdateDiseases
go

create proc uspUpdateDiseases(
@DiseaseCode varchar(10),
@DiseaseName varchar(800),
@DiseaseCategoriesID varchar(10),
@Hidden bit
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DiseaseCode from Diseases where DiseaseCode = @DiseaseCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Disease Code', @DiseaseCode, 'Diseases')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DiseaseCategoriesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Disease Categories ID', @DiseaseCategoriesID, 'Lookup Data')
		return 1
	end

begin
update Diseases set
DiseaseName = @DiseaseName, DiseaseCategoriesID = @DiseaseCategoriesID, Hidden = @Hidden
where DiseaseCode = @DiseaseCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateDiseases 'A00.9', 'Cholera, unspecified1', '4333', 1

*******************************************************************************************************/
-- select * from Diseases
-- delete from Diseases

-------------- Get Diseases --------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDiseases')
	drop proc uspGetDiseases
go

create proc uspGetDiseases(
@DiseaseCode varchar(10) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not (@DiseaseCode is null)
begin
	if not exists(select DiseaseCode from Diseases where DiseaseCode = @DiseaseCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Disease Code', @DiseaseCode, 'Diseases')
			return 1
		end
	else
	begin
		select  DiseaseCode, DiseaseName, DiseaseCategoriesID,dbo.GetMergedNameCode(DiseaseName, DiseaseCode) as DiseaseFullName, 
		dbo.GetLookupDataDes(DiseaseCategoriesID) as DiseaseCategories, Hidden
		from Diseases
		where DiseaseCode = @DiseaseCode
	end
end
else
if (@DiseaseCode is null)
begin
	begin
		select DiseaseCode, DiseaseName, DiseaseCategoriesID,dbo.GetMergedNameCode(DiseaseName, DiseaseCode) as DiseaseFullName, 
		dbo.GetLookupDataDes(DiseaseCategoriesID) as DiseaseCategories, Hidden
		from Diseases
		where Hidden = @Hidden
		order by DiseaseName
	end
end
go

/******************************************************************************************************
exec uspGetDiseases
exec uspGetDiseases 'A00.0'

******************************************************************************************************/
-- select * from Diseases
-- delete from Diseases

------------------------------------------------------------------------------------------------------
------------- Visits ---------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Visits--------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertVisits')
	drop proc uspInsertVisits
go

create proc uspInsertVisits(
@VisitNo varchar(20),
@PatientNo varchar(20),
@VisitDate smalldatetime,
@DoctorSpecialtyID varchar(10),
@StaffNo varchar(10) = null,
@VisitCategoryID varchar(10),
@ReferredBy varchar(40),
@ServiceCode varchar(10) = null,
@BillModesID varchar(10),
@BillNo varchar(20),
@InsuranceNo varchar(20),
@AssociatedBillNo varchar(20) = null,
@MemberCardNo varchar(30),
@MainMemberName varchar(41),
@ClaimReferenceNo varchar(30),
@VisitStatusID varchar(10),
@AccessCashServices bit,
@FingerprintVerified bit,
@CoPayTypeID varchar(10),
@CoPayPercent decimal(5,2),
@CoPayValue money,
@SmartCardApplicable bit,
@VisitsPriorityID varchar(10),
@CommunityID varchar(10) = null,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as 

declare @ErrorMSG varchar(200)

declare @InWardAdmissionStatusID varchar(10)

declare @CashBillModesID varchar(10)
declare @CashBillModes varchar(100)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

declare @VisitID int

declare @PaddingLEN tinyint

declare @PassedVisitID int
declare @PassedVisitNo varchar(20)
declare @PassedPatientNo varchar(20)
declare @ItemCategoryID varchar(10)

declare @PatientStatusID varchar(10)
declare @DeceasedStatusID varchar(10)
declare @InactiveStatusID varchar(10)
declare @BranchID varchar(10)
----------------------------------------------------------------------------------------------------------------
set @InWardAdmissionStatusID = dbo.GetLookupDataID('AdmissionStatus', 'I')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @CashBillModes = dbo.GetLookupDataDes(@CashBillModesID)
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'S')
----------------------------------------------------------------------------------------------------------------

if exists(select AdmissionNo from Admissions 
		  where PatientNo = @PatientNo and AdmissionStatusID = @InWardAdmissionStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, is known to have an active admission. You can''t register a new visit before discharging previous admission.'
		raiserror(@ErrorMSG, 16, 1, 'Patient with No', @PatientNo)	
		return 1
	end
	
if exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select PatientNo from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The Patient No: ' + @PatientNo + ', you are trying to enter does not exist in the registered patients'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end	
	
if (@VisitDate > GetDate())
	begin		
		set @ErrorMSG = 'The %s: ' + ltrim(rtrim(dbo.FormatDate(@VisitDate))) + ', you are trying to enter can''t be ahead of today’s date as set by server administrator'
		raiserror(@ErrorMSG, 16, 1, 'Visit Date')
	 	return 1
	end



if not exists(select DataID from LookupData where DataID = @DoctorSpecialtyID)
	begin
		set @ErrorMSG = 'The Doctor Specialty ID: ' + @DoctorSpecialtyID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end
	
if not ((@ClaimReferenceNo = '') or (@ClaimReferenceNo is null))
	begin
		if exists(select VisitNo from Visits where BillNo = @BillNo and InsuranceNo = @InsuranceNo and ClaimReferenceNo = @ClaimReferenceNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter already exists'
				raiserror(@ErrorMSG, 16, 1, 'Claim Reference No', @ClaimReferenceNo)	
				return 1
			end
	end

if not (@StaffNo is null or @StaffNo = '') 
	begin
		if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
				return 1
			end
	end
else if (@StaffNo is null or @StaffNo = '') 
begin set @StaffNo = null end

if not exists(select DataID from LookupData where DataID = @VisitCategoryID)
	begin
		set @ErrorMSG = 'The Visit Category ID: ' + @VisitCategoryID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end


if not (@ServiceCode is null or @ServiceCode = '') 
	begin
		if not exists(select ServiceCode from Services where ServiceCode  = @ServiceCode)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Services')
				return 1
			end
	end
else if (@ServiceCode is null or @ServiceCode = '')
begin set @ServiceCode = null end

if not exists(select DataID from LookupData where DataID = @BillModesID)
	begin
		set @ErrorMSG = 'The Bill Modes ID: ' + @BillModesID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG, 16, 1)	
		return 1
	end
	
if not (@AssociatedBillNo is null or @AssociatedBillNo = '') 
	begin
		if not exists(select AccountNo from BillCustomers where AccountNo  = @AssociatedBillNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Associated Bill No', @AssociatedBillNo, 'To-Bill Customers')
				return 1
			end
	end
else if (@AssociatedBillNo is null or @AssociatedBillNo = '') 
begin set @AssociatedBillNo = null end



------------------------------------------------------------------------------------------------------------------
if (@BillModesID = @AccountBillModesID) and (@BillNo = @CashBillModes)
	begin
		set @ErrorMSG = 'Default Bill No for Bill Mode Account can''t be Cash!'
		raiserror(@ErrorMSG,16, 1)	
		return 1
	end

if (@BillModesID = @InsuranceBillModesID)
	begin
		if not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @BillNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @BillNo, 'Scheme Members')
				return 1
			end

		if not exists(select PatientNo from Patients where PatientNo = @PatientNo and DefaultBillNo = @BillNo)
			begin
				if exists(select PatientNo from Patients where DefaultBillModesID = @InsuranceBillModesID and DefaultBillNo = @BillNo)
					begin
						set @ErrorMSG = 'The %s: %s, you are trying to enter is already assigned to another Patient'
						raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @BillNo)
						return 1
					end
			end
	end
else 
	begin 
		if not exists(select AccountNo from BillCustomers where AccountNo = @BillNo)
			begin
				set @ErrorMSG = 'The  %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Account No', @BillNo, 'Bill Customers')	
				return 1
			end
	end
------------------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @VisitStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit Status ID', @VisitStatusID, 'Lookup Data')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CoPayTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CoPay Type ID', @CoPayTypeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

else

----------------------------------------------------------------------------------------------------------

-- Ensure that Patient is not Deceased or Inactive

set @PatientStatusID = (select StatusID from Patients where PatientNo = @PatientNo)
set @DeceasedStatusID = dbo.GetLookupDataID('Status', 'D')
set @InactiveStatusID = dbo.GetLookupDataID('Status', 'I')

if (@PatientStatusID = @DeceasedStatusID) or (@PatientStatusID = @InactiveStatusID)
	begin
		set @ErrorMSG = 'The Patient No: ' + @PatientNo + ', you are trying to enter is not Active'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else

begin


----------------------------------------------------------------------------------------------------------
set @BranchID = dbo.GetMyCurrentBranch(@LoginID)

select @PaddingLEN = PaddingLEN from AutoNumbers where ObjectName = 'Visits' and AutoColumnName = 'VisitNo'

set @PassedPatientNo = ltrim(rtrim(substring(@VisitNo, 1, len(@VisitNo) - @PaddingLEN)))

if (@PassedPatientNo = @PatientNo)

begin

	set @PassedVisitID = 1
	set @PassedVisitNo = @VisitNo

	set @PassedVisitNo = ltrim(rtrim(substring(@PassedVisitNo, len(@PassedPatientNo) + 1, @PaddingLEN)))

	if isnumeric(@PassedVisitNo) = 1 set @PassedVisitID = @PassedVisitNo
	else set @PassedVisitID = 1

	set @VisitID = (select max(VisitID) from Visits where PatientNo = @PatientNo)
	set @VisitID = dbo.GetNextAutoNumber('Visits', 'VisitNo', @VisitID)

	if @PassedVisitID < @VisitID set @VisitID = @PassedVisitID
	if @PassedVisitID > @VisitID set @VisitID = @PassedVisitID

end else set @VisitID = 1

-------------------------------------------------------------------------------------------------------------------------------------
insert into Visits
(VisitID, VisitNo, PatientNo, VisitDate, DoctorSpecialtyID, StaffNo, VisitCategoryID,BranchID, ReferredBy, ServiceCode, 
BillModesID, BillNo, InsuranceNo, AssociatedBillNo,MemberCardNo, MainMemberName, ClaimReferenceNo, VisitStatusID, 
AccessCashServices, FingerprintVerified, CoPayTypeID, CoPayPercent, CoPayValue, SmartCardApplicable, VisitsPriorityID,CommunityID, LoginID, ClientMachine)
 values
(@VisitID, @VisitNo, @PatientNo, @VisitDate, @DoctorSpecialtyID, @StaffNo, @VisitCategoryID,@BranchID,
 @ReferredBy, @ServiceCode, 
@BillModesID, @BillNo, @InsuranceNo, @AssociatedBillNo,@MemberCardNo, @MainMemberName, @ClaimReferenceNo, @VisitStatusID, 
@AccessCashServices, @FingerprintVerified, @CoPayTypeID, @CoPayPercent, @CoPayValue, @SmartCardApplicable, @VisitsPriorityID,@CommunityID, @LoginID, @ClientMachine)

-------------------------------------------------------------------------------------------------------------------------------------
-- Update appointments table

if exists(select PatientNo from Appointments 
	  where (PatientNo = @PatientNo) and (@VisitDate >= StartDate) and (@VisitDate <= EndDate) 
		  and (AppointmentStatusID = dbo.GetLookupDataID('AppointmentStatus', 'WT')))
	begin
		declare @AppointmentStatusID varchar(10)		
		set @AppointmentStatusID = dbo.GetLookupDataID('AppointmentStatus', 'VT')
	
		update Appointments set AppointmentStatusID = @AppointmentStatusID
		where (PatientNo = @PatientNo) and (@VisitDate >= StartDate) and (@VisitDate <= EndDate
			and (AppointmentStatusID = dbo.GetLookupDataID('AppointmentStatus', 'WT')))
	end

----------------------------------------------------------------------------------------------------------
exec uspUpdatePatientCalculatedFields @PatientNo
----------------------------------------------------------------------------------------------------------

return 0
end
go

/*****************************************************************************************************
--1---------------------------------------------------------------------------------------------------

exec uspInsertVisits '100001004', '100001', '1 May 2006', null, '10C', 'Reffered By', null, '17A',
			'STAFF', null, '9DR', 0, 'Admin'

exec uspInsertVisits '0600001002', '0600001', '1 May 2006', null, '10C', 'Reffered By', null, '17A',
			'0600002A', '', '9DR', 1, 'Admin'

exec uspInsertVisits '0700001001', '0700001', '1 May 2006', null, '10C', 'Reffered By', null, '17A',
			'0600002A', '9DR', 1, 'Admin'

exec uspInsertVisits '0600003002', '0600003', '20 Jul 2006', null, '10C', 'Reffered By', null, '17A',
			'CB', '9DR', 0, 'Admin'

*******************************************************************************************************/

-- select * from Visits
-- delete from Visits
-- select * from Appointments

-----------------Update Visits--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateVisits')
	drop proc uspUpdateVisits
go

create proc uspUpdateVisits(
@VisitNo varchar(20),
@VisitStatusID varchar(10),
@VisitDate smalldatetime = null,
@BillModesID varchar(10) = null,
@BillNo varchar(20) = null,
@InsuranceNo varchar(20) = null,
@AssociatedBillNo varchar(20) = null,
@PackageNo varchar(20)=null,
@MemberCardNo varchar(30) = null,
@MainMemberName varchar(41) = null,
@ClaimReferenceNo varchar(30) = null,
@AccessCashServices bit = null,
@CoPayTypeID varchar(10) = null,
@CoPayPercent decimal(5,2) = null,
@CoPayValue money = null,
@SmartCardApplicable bit = null,
@CommunityID varchar(10)=null,
@LoginID varchar(20) = null,
@ClientMachine varchar(40) = null
)with encryption as 

declare @ErrorMSG varchar(200)

declare @CashBillModesID varchar(10)
declare @CashBillModes varchar(100)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)
declare @PayStatusID varchar(10)
declare @NAPayStatusID varchar(10)
declare @PatientNo varchar(20)
declare @BranchID varchar(10)
----------------------------------------------------------------------------
set @BranchID = dbo.GetMyCurrentBranch(@LoginID)
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @CashBillModes = dbo.GetLookupDataDes(@CashBillModesID)
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
set @PayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @NAPayStatusID = dbo.GetLookupDataID('PayStatus', 'NA')

set @PatientNo = (select PatientNo from Visits where VisitNo = @VisitNo)
----------------------------------------------------------------------------

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', does not exist in registered Visits'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisitStatusID)
	begin
		set @ErrorMSG = 'The Visit Status ID: ' + @VisitStatusID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not (@VisitDate is null) 
begin
	if (@VisitDate > GetDate())
		begin		
			set @ErrorMSG = 'The %s: ' + ltrim(rtrim(dbo.FormatDate(@VisitDate))) + ', you are trying to enter can''t be ahead of today’s date as set by server administrator'
			raiserror(@ErrorMSG, 16, 1, 'Visit Date')
	 		return 1
		end
end
	
if not (@AssociatedBillNo is null or @AssociatedBillNo = '') 
	begin
		if not exists(select AccountNo from BillCustomers where AccountNo  = @AssociatedBillNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Associated Bill No', @AssociatedBillNo, 'To-Bill Customers')
				return 1
			end
	end
else if (@AssociatedBillNo is null or @AssociatedBillNo = '') 
begin set @AssociatedBillNo = null end


if not (@PackageNo is null or @PackageNo = '') 
	begin
		if not exists(select PackageNo from Packages where PackageNo  = @PackageNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Package No', @PackageNo, 'Package No')
				return 1
			end
	end
else if (@PackageNo is null or @PackageNo = '') 
begin set @PackageNo = null end



if ( not(@LoginID is null or @LoginID = '') and not(@VisitDate is null) and not(@AccessCashServices is null) 
	 and not(@BillModesID is null) and not(@BillNo is null) and not (@SmartCardApplicable is null))
	begin
	
		------------------------------------------------------------------------------------------------------------------
		if (@BillModesID = @AccountBillModesID) and (@BillNo = @CashBillModes)
			begin
				set @ErrorMSG = 'Default Bill No for Bill Mode Account can''t be Cash!'
				raiserror(@ErrorMSG,16, 1)	
				return 1
			end

		if (@BillModesID = @InsuranceBillModesID)
			begin
				if not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @BillNo)
					begin
						set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
						raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @BillNo, 'Scheme Members')
						return 1
					end

				if not exists(select PatientNo from Patients where PatientNo = @PatientNo and DefaultBillNo = @BillNo)
					begin
						if exists(select PatientNo from Patients where DefaultBillModesID = @InsuranceBillModesID and DefaultBillNo = @BillNo)
							begin
								set @ErrorMSG = 'The %s: %s, you are trying to enter is already assigned to another Patient'
								raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @BillNo)
								return 1
							end
					end
			end
		else 
			begin 
				if not exists(select AccountNo from BillCustomers where AccountNo = @BillNo)
					begin
						set @ErrorMSG = 'The  %s: %s, you are trying to enter does not exist in the registered %s'
						raiserror(@ErrorMSG, 16, 1, 'Account No', @BillNo, 'Bill Customers')	
						return 1
					end
			end
		---------------------------------------------------------------------------------------------------------------------
		
		if not exists(select VisitNo from Visits where VisitNo = @VisitNo and BillModesID = @BillModesID and BillNo = @BillNo)
			begin
				if  exists(select VisitNo from Items where VisitNo = @VisitNo and PayStatusID Not in (@NAPayStatusID,@PayStatusID)) 
					begin	
						set @ErrorMSG = 'The %s: %s, has item(s) that have been paid for. You can''t update this visit to another bill!'
							raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo)
							return 1
					end
					
				if  exists(select VisitNo from ExtraBillItems
					inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
					where VisitNo = @VisitNo and PayStatusID Not in (@NAPayStatusID,@PayStatusID)) 
					begin	
						set @ErrorMSG = 'The %s: %s, has bill form item(s) that have been paid for. You can''t update this visit to another bill!'
							raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo)
							return 1
					end
					
				if  exists(select VisitNo from IPDItems
					inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
					inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
					where VisitNo = @VisitNo and PayStatusID Not in (@NAPayStatusID,@PayStatusID)) 
					begin	
						set @ErrorMSG = 'The %s: %s, has IPD item(s) that have been paid for. You can''t update this visit to another bill!'
							raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo)
							return 1
					end
					
				if  exists(select VisitNo from ItemsCASH where VisitNo = @VisitNo) 
					begin	
						set @ErrorMSG = 'The %s: %s, has Co-Pay item(s) that can''t be re-called. You can''t update this visit!'
							raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo)
							return 1
					end
					
				if  exists(select VisitNo from ExtraBillItemsCASH
					inner join ExtraBills on ExtraBillItemsCASH.ExtraBillNo = ExtraBills.ExtraBillNo
					where VisitNo = @VisitNo) 
					begin	
						set @ErrorMSG = 'The %s: %s, has bill form Co-Pay item(s) that can''t be re-called. You can''t update this visit!'
							raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo)
							return 1
					end
					
				if  exists(select VisitNo from ClaimsEXT where VisitNo = @VisitNo) 
					begin	
						set @ErrorMSG = 'The %s: %s, has Claim(s) that can''t be re-called. You can''t update this visit!'
							raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo)
							return 1
					end
			end
			
		---------------------------------------------------------------------------------------------------------------------

		if not exists(select LoginID from Logins where LoginID = @LoginID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
				return 1
			end
			
				begin tran
				
				if not ((@ClaimReferenceNo = '') or (@ClaimReferenceNo is null))
					begin
						if exists(select VisitNo from Visits where BillNo = @BillNo and InsuranceNo = @InsuranceNo 
									and ClaimReferenceNo = @ClaimReferenceNo and not VisitNo = @VisitNo)
							begin
								set @ErrorMSG = 'The %s: %s, you are trying to enter already exists'
								raiserror(@ErrorMSG, 16, 1, 'Claim Reference No', @ClaimReferenceNo)	
								rollback tran
								return 1
							end
					end

					update Visits set 
					VisitDate = @VisitDate, VisitStatusID = @VisitStatusID, BillModesID = @BillModesID, BillNo = @BillNo, 
					InsuranceNo = @InsuranceNo, AssociatedBillNo = @AssociatedBillNo, MemberCardNo = @MemberCardNo, 
					MainMemberName = @MainMemberName, ClaimReferenceNo = @ClaimReferenceNo, AccessCashServices = @AccessCashServices, 
					CoPayTypeID = @CoPayTypeID, CoPayPercent = @CoPayPercent, CoPayValue = @CoPayValue,BranchID =@BranchID,
					SmartCardApplicable = @SmartCardApplicable, CommunityID=@CommunityID, LoginID = @LoginID, ClientMachine = @ClientMachine
					where VisitNo = @VisitNo 
				
				if @@error > 0
					begin
						rollback tran
						return 1		
					end
				commit tran			
	end
else if ((@LoginID is null or @LoginID = '') and not(@VisitDate is null) and not(@AccessCashServices is null))
	begin 
		update Visits set
		VisitDate = @VisitDate, VisitStatusID = @VisitStatusID, AccessCashServices = @AccessCashServices,
		BranchID =@BranchID
		where VisitNo = @VisitNo 
	end
else
	begin 
		update Visits set 
		VisitStatusID = @VisitStatusID
		where VisitNo = @VisitNo 
	end

----------------------------------------------------------------------------------------------------------
exec uspUpdatePatientCalculatedFields @PatientNo
----------------------------------------------------------------------------------------------------------

return 0
go

/*----------------------------------------------------------------------------------
-- select * from Visits where visitno = '100001001'
-- exec uspUpdateVisits '100001001', '08 Mar 2010', '9DR', 1, 'Admin'
------------------------------------------------------------------------------------*/

--1--------Delete Visits--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspDeleteVisits')
	drop proc uspDeleteVisits
go

create proc uspDeleteVisits(
@VisitNo varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @PatientNo varchar(20)
declare @ItemStatusID varchar(10)
declare @PayStatusID varchar(10)
declare @NAPayStatusID varchar(10)
declare @CashVisitPayTypeID varchar(10)

set @ItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @PayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @NAPayStatusID = dbo.GetLookupDataID('PayStatus', 'NA')
set @CashVisitPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16, 1, 'Visit No', @VisitNo, 'Visits')	
		return 1
	end

if  exists(select VisitNo from Items where VisitNo = @VisitNo and ItemStatusID <> @ItemStatusID) 
	begin	
		set @ErrorMSG = 'The %s: %s, has item(s) that are not pending. You can''t delete this Visit!'
			raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo)
			return 1
	end

if  exists(select VisitNo from Items where VisitNo = @VisitNo and PayStatusID Not In (@NAPayStatusID,@PayStatusID)) 
	begin	
		set @ErrorMSG = 'The %s: %s, has item(s) that have been paid for. You can''t delete this Visit!'
			raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo)
			return 1
	end

else
begin tran

set @PatientNo = (select PatientNo from Visits where VisitNo = @VisitNo)

delete Payments where PayTypeID = @CashVisitPayTypeID and PayNo = @VisitNo
delete Items where VisitNo = @VisitNo
delete DoctorVisits where VisitNo = @VisitNo
delete Visits where VisitNo = @VisitNo
----------------------------------------------------------------------------------------------------------
exec uspUpdatePatientCalculatedFields @PatientNo
----------------------------------------------------------------------------------------------------------
if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
return 0
go

-- exec uspDeleteVisits '08022077009'
-- select * from Visits

--------Get Visits------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisits')
	drop proc uspGetVisits
go

create proc uspGetVisits(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
begin
	set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered visits'
	raiserror(@ErrorMSG,16,1)	
	return 1
end
else
begin
	select Visits.VisitDate, Patients.PatientNo, dbo.GetHidePatientDetails(FirstName,HideDetails) as FirstName, dbo.GetHidePatientDetails(LastName,HideDetails) as LastName, 
	dbo.GetHidePatientDetails(MiddleName,HideDetails) as MiddleName, Photo,
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, BirthDate, JoinDate, ReferenceNo,
	dbo.GetHidePatientDetails(Patients.Phone,HideDetails) as [Phone], isnull(dbo.GetLastVisitDate(Patients.PatientNo),JoinDate) as LastVisitDate,
	dbo.GetTotalVisits(Patients.PatientNo) as TotalVisits, ReferredBy, FingerprintVerified,
	dbo.GetAge(BirthDate, getdate()) as Age, dbo.GetAgeInMonths(BirthDate, getdate()) as AgeInMonths, 
	dbo.GetAgeInDays(BirthDate, getdate()) as AgeInDays, GenderID, dbo.GetLookupDataDes(GenderID) as Gender,
	 dbo.GetLookupDataDes(ReligionID) as Religion,dbo.GetLookupDataDes(TribeID) as Tribe,
	 Address,NOKName,NOKPhone,
	DoctorSpecialtyID, dbo.GetLookupDataDes(DoctorSpecialtyID) as DoctorSpecialty,
	dbo.GetStaffName(StaffNo) as ToSeeDoctor,Location,
	StaffNo, dbo.GetStaffFullName(StaffNo) as StaffFullName, Occupation, AccessCashServices,
	VisitCategoryID, dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Visits.ServiceCode, 
	ServiceName, dbo.GetServicePayStatusID(Visits.VisitNo, Visits.ServiceCode) as ServicePayStatusID,
	BillModesID, dbo.GetLookupDataDes(BillModesID) as BillMode, BillNo, MemberCardNo, MainMemberName, 
	ClaimReferenceNo, dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,Address,
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	InsuranceNo, dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, SmartCardApplicable,
	AssociatedBillNo, dbo.GetBillCustomerName(AssociatedBillNo) as AssociatedBillCustomer,
	dbo.GetCurrentPackage(PackageVisits.PackageNo) as PackageName,
	dbo.GetBillCustomerFullName(AssociatedBillNo) as AssociatedFullBillCustomer, 
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,	
	dbo.GetDoctorLoginID(Visits.VisitNo) as DoctorLoginID, 
	dbo.GetDoctorStaffNo(Visits.VisitNo) as DoctorStaffNo,
	dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact, 
	dbo.GetDoctorServiceCode(Visits.VisitNo) as DoctorServiceCode, 
	dbo.GetDoctorVisitClosed(Visits.VisitNo) as DoctorVisitClosed, 
	dbo.GetProvisionalDiagnosis(Visits.VisitNo) as ProvisionalDiagnosis,
	dbo.GetTotalPathologyRequests(Visits.VisitNo) as TotalPathologyRequests, 
	dbo.GetTotalCardiologyRequests(Visits.VisitNo) as TotalCardiologyRequests,
	dbo.GetTotalRadiologyRequests(Visits.VisitNo) as TotalRadiologyRequests,
	dbo.GetTotalDentalRequests(Visits.VisitNo) as TotalDentalRequests,
	dbo.GetAdmissionNo(Visits.VisitNo) as AdmissionNo,
	dbo.GetAdmissionLocation(Visits.VisitNo) as AdmissionLocation,
	dbo.FormatMoney(dbo.GetOutstandingBalance(Patients.PatientNo)) as OutstandingBalance,
    dbo.FormatMoney(dbo.GetCashAccountBalance(Patients.PatientNo)) as CashAccountBalance,
	VisitStatusID, dbo.GetLookupDataDes(VisitStatusID) as VisitStatus, 
	dbo.GetHasTriage(Visits.VisitNo) as HasTriage, Weight, Temperature, 
	Height, Pulse, BloodPressure, HeadCircum, BodySurfaceArea, RespirationRate,
	OxygenSaturation, HeartRate, dbo.CalculateBMI(Weight, Height/100) as BMI, Triage.Notes As Notes,
	dbo.GetIsScheduledVisit(Visits.PatientNo, VisitDate) as IsScheduledVisit,
	dbo.GetNextAppointmentDate(Visits.PatientNo, VisitDate) as NextAppointmentDate,
	dbo.GetARTStartDate(Visits.PatientNo) as ARTStartDate,
	dbo.GetDurationStartART(Visits.PatientNo, VisitDate) as DurationStartART,
	dbo.GetDurationCurrentART(Visits.PatientNo, VisitDate) as DurationCurrentART,
	dbo.GetCombinationCurrentlyOn(Visits.PatientNo) as Combination,
	dbo.GetLookupDataName(Patients.ChronicDiseases) as ChronicDiseases,
	Patients.MedicalConditions,
	VisitsPriorityID, dbo.GetLookupDataDes(VisitsPriorityID) as Priority,Visits.CommunityID, dbo.GetLookupDataDes(Visits.CommunityID) as Community,
	Visits.BranchID as VisitsBranchID,Triage.MUAC,dbo.GetLookupDataDes(Triage.BMIStatusID)as BMIStatus,
	dbo.GetLookupDataDes(Patients.BranchID) as BranchName,
	dbo.GetLookupDataDes(Visits.BranchID) as VisitsBranchName,
	dbo.GetPriority(Visits.VisitNo) as PriorityID,
	dbo.GetPatientAppointmentsDetails(Patients.PatientNo) as PatientAppointmentsDetails,
	dbo.GetPatientAppointmentsDate(Patients.PatientNo) as PatientAppointmentsDate,
	dbo.GetHasPackage(Patients.PatientNo,PackageVisits.PackageNo) as HasPackage,PackageVisits.PackageNo,
	dbo.GetMergedNameCode(dbo.GetCurrentPackage(PackageVisits.PackageNo), PackageVisits.PackageNo) as PackageFullName,
	dbo.GetHasServiceFee(Visits.VisitNo) as HasServiceFee,dbo.GetHasPackage(Patients.PatientNo,PackageVisits.PackageNo) as IPDHasPackage,
	dbo.GetHasPaidPackage(Visits.VisitNo,PackageVisits.PackageNo) as HasPaidPackage,
	dbo.IsBillReconciled(Visits.VisitNo) as BillReconciled,
	dbo.IsOPDBillReconciled(Visits.VisitNo) as OPDBillReconciled,
	dbo.GetVisitItemsCashPayStatusID(Visits.VisitNo, Visits.ServiceCode) as ItemsCashServicePayStatusID,
	Visits.VisitNo,MemberCardNo 
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Services on Visits.ServiceCode = Services.ServiceCode
	left outer join Triage on Triage.VisitNo = Visits.VisitNo
	left outer join PackageVisits on PackageVisits.VisitNo = Visits.VisitNo
	where Visits.VisitNo = @VisitNo
end
return 0
go

-- select * from Visits where patientNo= '160017'
-- exec uspGetVisits '324001'

--------GetDoctorVisits----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDoctorVisits')
	drop proc uspGetDoctorVisits
go

create proc uspGetDoctorVisits(
@VisitStatusID varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @ServicePointID varchar(10)
 
 set @ServicePointID=dbo.GetLookupDataID('ServicePoint', 'DOC')

if not(@StartDate is null) and not(@EndDate is null)
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo,dbo.GetHidePatientDetails(FirstName,HideDetails) as FirstName,
			dbo.FormatDate(VisitDate) as VisitDate,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(DoctorSpecialtyID) as ToSeeSpecialty,dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor,
			dbo.GetStaffName(StaffNo) as ToSeeDoctor, dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues on Visits.VisitNo = Queues.VisitNo and ServicePointID=@ServicePointID and QueueStatus=1
	where VisitStatusID = @VisitStatusID and VisitDate between @StartDate and @EndDate
	order by TokenNo asc, VisitDate desc, VisitNo desc
end
else
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,TokenNo,dbo.GetHidePatientDetails(FirstName,HideDetails) as FirstName,
			dbo.FormatDate(VisitDate) as VisitDate,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(DoctorSpecialtyID) as ToSeeSpecialty,dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor,
			dbo.GetStaffName(StaffNo) as ToSeeDoctor, dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues on Visits.VisitNo = Queues.VisitNo and ServicePointID=@ServicePointID and QueueStatus=1
	
	where VisitStatusID = @VisitStatusID
	order by TokenNo asc, VisitDate desc, VisitNo desc
end	
return 0
go

-- select * from Visits
-- exec uspGetDoctorVisits '9DR'
-- exec uspGetDoctorVisits '9DR', 'apr 15, 2011', 'apr 30, 2011'
-- exec uspGetDoctorVisits '9CO', 'apr 15, 2018', 'apr 30, 2018'


---------------------To See Doctor Visits-----------------------------------------------------

if exists (select * from sysobjects where name = 'uspToSeeDoctorsVisits')
	drop proc uspToSeeDoctorsVisits 
go

create proc uspToSeeDoctorsVisits(
@StaffNo varchar(10) = null,
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @CompletedVisitStatusID as varchar(10)
declare @SeeDoctorVisitStatusID as varchar(10)
declare @CancelledVisitStatusID as varchar(10)
declare @InPatientVisitStatusID as varchar(10)
-------------------------------------------------------------------------------------
set @CompletedVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'CO')
set @SeeDoctorVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'DR')
set @CancelledVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'CA')
set @InPatientVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'IP')
-------------------------------------------------------------------------------------
if not(@StaffNo is null or @StaffNo = '')
	begin
		-------------------------------------------------------------------------------------
		if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
			begin
				set @ErrorMSG = 'The %s: %s, you''re trying to update does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')	
				return 1
			end
		-------------------------------------------------------------------------------------
					if not(@StartDate is null) and not(@EndDate is null)
					begin	
							  select			  
								  StaffNo ,dbo.GetStaffName(StaffNo)as staffName,-- dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty,
								  --dbo.GetTotalVisitsPerDoctor(staffno, @StartDate, @EndDate)as TotalVisits,
								  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@CompletedVisitStatusID, @StartDate, @EndDate) as SeenVisits,
								  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@SeeDoctorVisitStatusID, @StartDate, @EndDate) as NotSeenVisits,
								  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@CancelledVisitStatusID, @StartDate, @EndDate) as CancelledVisits,
								  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@InPatientVisitStatusID, @StartDate, @EndDate) as InPatientVisits,
								  --Sum(standardFee) as TotalConsultationFee,
								  dbo.FormatMoney(dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@CompletedVisitStatusID, @StartDate, @EndDate)) as TotalConsultationFeeSeenVisits,
								  dbo.FormatMoney(dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@SeeDoctorVisitStatusID, @StartDate, @EndDate)) as TotalConsultationFeeUnSeenVisits,
								  dbo.FormatMoney(dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@InPatientVisitStatusID, @StartDate, @EndDate)) as TotalConsultationFeeInPatientVisits,
								  dbo.FormatMoney(dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@CancelledVisitStatusID, @StartDate, @EndDate)) as ToTalConsultationFeeCancelledVisits	  
							  from Visits
							  inner join services on visits.ServiceCode = services.ServiceCode
							  and not(StaffNo is null)
							  where visits.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
							  and Visits.StaffNo = @StaffNo
							  group by Visits.StaffNo  order by staffName
							   --Visits.VisitStatusID = @VisitStatusID--'9CO' and visits.VisitNo ='16005897011'
							  --and DoctorVisits.StaffNo = @StaffNo --'MH/171'
							  end
					else
						begin 
							select			  
								   StaffNo ,dbo.GetStaffName(StaffNo)as staffName,-- dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty,
								  --dbo.GetTotalVisitsPerDoctor(staffno, @StartDate, @EndDate)as TotalVisits,
								  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@CompletedVisitStatusID, @StartDate, @EndDate) as SeenVisits,
								  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@SeeDoctorVisitStatusID, @StartDate, @EndDate) as NotSeenVisits,
								  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@CancelledVisitStatusID, @StartDate, @EndDate) as CancelledVisits,
								  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@InPatientVisitStatusID, @StartDate, @EndDate) as InPatientVisits,
								  --Sum(standardFee) as TotalConsultationFee,
								  dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@CompletedVisitStatusID, @StartDate, @EndDate) as TotalConsultationFeeSeenVisits,
								  dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@SeeDoctorVisitStatusID, @StartDate, @EndDate) as TotalConsultationFeeUnSeenVisits,
								  dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@InPatientVisitStatusID, @StartDate, @EndDate) as TotalConsultationFeeInPatientVisits,
								  dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@CancelledVisitStatusID, @StartDate, @EndDate) as ToTalConsultationFeeCancelledVisits	  
							  from Visits
							  inner join services on visits.ServiceCode = services.ServiceCode
							  --left join DoctorVisits on Visits.VisitNo = Visits.VisitNo
							  and not(StaffNo is null)
							  group by Visits.StaffNo  order by staffName
							 
							  end


	end
else 
	begin
				if not(@StartDate is null) and not(@EndDate is null)
			begin	
					  select			  
						  StaffNo ,dbo.GetStaffName(StaffNo)as staffName,-- dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty,
						  --dbo.GetTotalVisitsPerDoctor(staffno, @StartDate, @EndDate)as TotalVisits,
						  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@CompletedVisitStatusID, @StartDate, @EndDate) as SeenVisits,
						  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@SeeDoctorVisitStatusID, @StartDate, @EndDate) as NotSeenVisits,
						  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@CancelledVisitStatusID, @StartDate, @EndDate) as CancelledVisits,
						  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@InPatientVisitStatusID, @StartDate, @EndDate) as InPatientVisits,
						  --Sum(standardFee) as TotalConsultationFee,
						  dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@CompletedVisitStatusID, @StartDate, @EndDate) as TotalConsultationFeeSeenVisits,
						  dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@SeeDoctorVisitStatusID, @StartDate, @EndDate) as TotalConsultationFeeUnSeenVisits,
						  dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@InPatientVisitStatusID, @StartDate, @EndDate) as TotalConsultationFeeInPatientVisits,
						  dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@CancelledVisitStatusID, @StartDate, @EndDate) as ToTalConsultationFeeCancelledVisits	  
					  from Visits
					  inner join services on visits.ServiceCode = services.ServiceCode
					  and not(StaffNo is null)
					  where visits.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
					  group by Visits.StaffNo  order by staffName
					   --Visits.VisitStatusID = @VisitStatusID--'9CO' and visits.VisitNo ='16005897011'
					  --and DoctorVisits.StaffNo = @StaffNo --'MH/171'
					  end
			else
				begin 
					select			  
						   StaffNo ,dbo.GetStaffName(StaffNo)as staffName,-- dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty,
						  --dbo.GetTotalVisitsPerDoctor(staffno, @StartDate, @EndDate)as TotalVisits,
						  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@CompletedVisitStatusID, @StartDate, @EndDate) as SeenVisits,
						  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@SeeDoctorVisitStatusID, @StartDate, @EndDate) as NotSeenVisits,
						  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@CancelledVisitStatusID, @StartDate, @EndDate) as CancelledVisits,
						  dbo.GetCountVisitsPerDoctorPerVisitStatus(staffno,@InPatientVisitStatusID, @StartDate, @EndDate) as InPatientVisits,
						  --Sum(standardFee) as TotalConsultationFee,
						  dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@CompletedVisitStatusID, @StartDate, @EndDate) as TotalConsultationFeeSeenVisits,
						  dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@SeeDoctorVisitStatusID, @StartDate, @EndDate) as TotalConsultationFeeUnSeenVisits,
						  dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@InPatientVisitStatusID, @StartDate, @EndDate) as TotalConsultationFeeInPatientVisits,
						  dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(staffno,@CancelledVisitStatusID, @StartDate, @EndDate) as ToTalConsultationFeeCancelledVisits	  
					  from Visits
					  inner join services on visits.ServiceCode = services.ServiceCode
					  --left join DoctorVisits on Visits.VisitNo = Visits.VisitNo
					  and not(StaffNo is null)
					  group by Visits.StaffNo  order by staffName
					 
					  end

	end

  return 0

go

/*
select TOP 10 staffno, count(visitNo),Sum(standardFee) from visits 
inner join services on visits.ServiceCode = services.ServiceCode
group by staffno

select TOP 10 * from Doctorvisits
select * from services
exec uspToSeeDoctorsVisits  '2016-01-01', '2016-01-30'
exec uspToSeeDoctorsVisits  '2016-01-01', '2016-01-01'
exec uspToSeeDoctorsVisits  '2016-09-01', '2016-12-01'
exec uspToSeeDoctorsVisits  '2016-11-01', '2016-12-01'
exec uspToSeeDoctorsVisits  '2016-04-01', '2016-12-01'
exec uspToSeeDoctorsVisits  null, null
*/

---------------------To See Doctor Visits Per Doctor -----------------------------------------------------

if exists (select * from sysobjects where name = 'uspToSeeDoctorVisitsPerDoctor')
	drop proc uspToSeeDoctorVisitsPerDoctor
go

create proc uspToSeeDoctorVisitsPerDoctor(
@StaffNo varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @CompletedVisitStatusID as varchar(10)
declare @SeeDoctorVisitStatusID as varchar(10)
declare @CancelledVisitStatusID as varchar(10)
declare @InPatientVisitStatusID as varchar(10)
-------------------------------------------------------------------------------------
set @CompletedVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'CO')
set @SeeDoctorVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'DR')
set @CancelledVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'CA')
set @InPatientVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'IP')
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------

-------------------------------------------------------------------------------------


if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to update does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')	
		return 1
	end


if not(@StartDate is null) and not(@EndDate is null)
begin
		 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
			  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
			  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
			  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
			  ,Visits.ServiceCode as servicecode
			  ,(select serviceName from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceName
			  ,(select StandardFee from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceFee
			  ,[Closed]
			  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
			  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
			  ,Visits.LoginID
			  ,Visits.RecordDateTime
			  ,DoctorVisits.RecordDateTime
			  ,Visits.ClientMachine
		  from Visits
		  left join patients on visits.PatientNo = patients.patientNo
		  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
		  where 
		  visits.VisitStatusID = @CompletedVisitStatusID  and DoctorVisits.StaffNo = @StaffNo
		  and DoctorVisits.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
		  		  
	union select Visits.PatientNo, Visits.VisitNo	, dbo.FormatDate(visits.VisitDate) as VisitDate 
			  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
			  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
			  ,Visits.StaffNo ,dbo.GetStaffName(Visits.StaffNo)as staffName
			  ,Visits.ServiceCode as servicecode
			  ,(select serviceName from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceName
			  ,(select StandardFee from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceFee
			  ,[Closed]
			  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
			  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
			  ,Visits.LoginID
			  ,Visits.RecordDateTime
			  ,DoctorVisits.RecordDateTime
			  ,Visits.ClientMachine
		  from Visits
		   left join patients on visits.PatientNo = patients.patientNo
		  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
		  where 
		  visits.VisitStatusID = @SeeDoctorVisitStatusID  and visits.StaffNo = @StaffNo
		  and visits.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
		  
		union select Visits.PatientNo, Visits.VisitNo	, dbo.FormatDate(visits.VisitDate) as VisitDate
			  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender 
		   	  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
			  ,Visits.StaffNo ,dbo.GetStaffName(Visits.StaffNo)as staffName
			  ,Visits.ServiceCode as servicecode
			  ,(select serviceName from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceName
			  ,(select StandardFee from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceFee
			  ,[Closed]
			  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
			  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
			  ,Visits.LoginID
			  ,Visits.RecordDateTime
			  ,DoctorVisits.RecordDateTime
			  ,Visits.ClientMachine
		  from Visits
		   left join patients on visits.PatientNo = patients.patientNo
		  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
		  where 
		  visits.VisitStatusID = @CancelledVisitStatusID  and visits.StaffNo = @StaffNo
		  and visits.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
		 
		 union select Visits.PatientNo, Visits.VisitNo	, dbo.FormatDate(visits.VisitDate) as VisitDate
			  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender 
		   	  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
			  ,Visits.StaffNo ,dbo.GetStaffName(Visits.StaffNo)as staffName
			  ,Visits.ServiceCode as servicecode
			  ,(select serviceName from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceName
			  ,(select StandardFee from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceFee
			  ,[Closed]
			  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
			  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
			  ,Visits.LoginID
			  ,Visits.RecordDateTime
			  ,DoctorVisits.RecordDateTime
			  ,Visits.ClientMachine
		  from Visits
		  left join patients on visits.PatientNo = patients.patientNo
		  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
		  where 
		  visits.VisitStatusID = @InPatientVisitStatusID  and visits.StaffNo = @StaffNo
		  and visits.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
		  order by VisitStatus asc 
		end
else
		begin
		  select Visits.PatientNo, Visits.VisitNo	,dbo.FormatDate(visits.VisitDate) as VisitDate
			  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender 
		  	  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
			  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
			  ,Visits.ServiceCode as servicecode
			  ,(select serviceName from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceName
			  ,(select StandardFee from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceFee
			  ,[Closed]
			  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
			  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
			  ,Visits.LoginID
			  ,Visits.RecordDateTime
			  ,DoctorVisits.RecordDateTime
			  ,Visits.ClientMachine
		  from Visits
		  left join patients on visits.PatientNo = patients.patientNo 
		  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
		  where
		  visits.VisitStatusID = @CompletedVisitStatusID  and DoctorVisits.StaffNo = @StaffNo
		 -- and DoctorVisits.RecordDateTime between @StartDate and @EndDate
		 
	union select Visits.PatientNo, Visits.VisitNo	, dbo.FormatDate(visits.VisitDate) as VisitDate
			  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender 
			  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
			  ,Visits.StaffNo ,dbo.GetStaffName(Visits.StaffNo)as staffName
			  ,Visits.ServiceCode as servicecode
			  ,(select serviceName from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceName
			  ,(select StandardFee from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceFee
			  ,[Closed]
			  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
			  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
			  ,Visits.LoginID
			  ,Visits.RecordDateTime
			  ,DoctorVisits.RecordDateTime
			  ,Visits.ClientMachine
		  from Visits
		  left join patients on visits.PatientNo = patients.patientNo
		  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
		  where 
		  visits.VisitStatusID = @SeeDoctorVisitStatusID  and visits.StaffNo = @StaffNo
		 
		 union select Visits.PatientNo, Visits.VisitNo	, dbo.FormatDate(visits.VisitDate) as VisitDate
		 	  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender 
			  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
			  ,Visits.StaffNo ,dbo.GetStaffName(Visits.StaffNo)as staffName
			  ,Visits.ServiceCode as servicecode
			  ,(select serviceName from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceName
			  ,(select StandardFee from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceFee
			  ,[Closed]
			  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
			  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
			  ,Visits.LoginID
			  ,Visits.RecordDateTime
			  ,DoctorVisits.RecordDateTime
			  ,Visits.ClientMachine
		  from Visits
		  left join patients on visits.PatientNo = patients.patientNo
		  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
		  where 
		  visits.VisitStatusID = @CancelledVisitStatusID  and visits.StaffNo = @StaffNo
		  
		 union  select Visits.PatientNo, Visits.VisitNo	, dbo.FormatDate(visits.VisitDate) as VisitDate
		      ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender 
			  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
			  ,Visits.StaffNo ,dbo.GetStaffName(Visits.StaffNo)as staffName
			  ,Visits.ServiceCode as servicecode
			  ,(select serviceName from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceName
			  ,(select StandardFee from Services where Services.ServiceCode = Visits.ServiceCode) as ServiceFee
			  ,[Closed]
			  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
			  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
			  ,Visits.LoginID
			  ,Visits.RecordDateTime
			  ,DoctorVisits.RecordDateTime
			  ,Visits.ClientMachine
		  from Visits
		  left join patients on visits.PatientNo = patients.patientNo
		  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
		  where 
		  visits.VisitStatusID = @InPatientVisitStatusID  and visits.StaffNo = @StaffNo
		  end
  return 0

go

/*
exec uspToSeeDoctorVisitsPerDoctor 'SUR0016', '2016-06-01', '2016-12-30'
exec uspToSeeDoctorVisitsPerDoctor 'MHIN/63', '2016-11-03 10:30:00', '2016-11-03 10:29:00'
exec uspToSeeDoctorVisitsPerDoctor 'MHIN/63', '2016-04-01', '2016-12-30'
*/







----------------------------------------------------------------------------------------------------------------
-------------- GetWaitingVisits --------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetWaitingVisits')
	drop proc uspGetWaitingVisits
go

create proc uspGetWaitingVisits(
@StaffLoginID varchar(20)= null
)with encryption as

declare @RecordDate smalldatetime
declare @SeeDoctorVisitStatusID varchar(10)

set @RecordDate = dbo.GetShortDate(dateadd(hour, -12, getdate()))
set @SeeDoctorVisitStatusID = dbo.GetLookupDataID('VisitStatus', 'DR')

if not (@StaffLoginID is null)
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
	dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo, DoctorSpecialtyID,
	VisitDate, dbo.FormatDate(VisitDate) as VisitDateText, FirstName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
	dbo.GetTime(Visits.RecordDateTime) as RecordTime, 
	Visits.StaffNo, dbo.GetStaffName(Visits.StaffNo) as StaffName, 
	dbo.GetStaffLoginID(Visits.StaffNo) as StaffLoginID,
	dbo.GetPriority(VisitNo) as Priority
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ((VisitDate >= @RecordDate and dbo.GetStaffLoginID(Visits.StaffNo) = @StaffLoginID)
		or (VisitDate >= @RecordDate and DoctorSpecialtyID = dbo.GetDoctorSpecialtyID(@StaffLoginID) 
		and Visits.StaffNo is null)) and (VisitStatusID = @SeeDoctorVisitStatusID)
	order by VisitDate, Visits.RecordDateTime
end
else if (@StaffLoginID is null)
	begin
		select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
	dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo, DoctorSpecialtyID,
	VisitDate, dbo.FormatDate(VisitDate) as VisitDateText, FirstName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
	dbo.GetTime(Visits.RecordDateTime) as RecordTime, 
	Visits.StaffNo, dbo.GetStaffName(Visits.StaffNo) as StaffName, 
	dbo.GetStaffLoginID(Visits.StaffNo) as StaffLoginID,
	dbo.GetPriority(VisitNo) as Priority
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where VisitDate >= @RecordDate and (VisitStatusID = @SeeDoctorVisitStatusID)
	order by VisitDate, Visits.RecordDateTime
	end
	
return 0
go

/***************************************************************************************************************
exec uspGetWaitingVisits 'Admin'

****************************************************************************************************************/
-- select * from Visits


----------------------------------------------------------------------------------------------------------------
-------------- GetEmergencyWaitingVisits --------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetEmergencyWaitingVisits')
	drop proc uspGetEmergencyWaitingVisits
go

create proc uspGetEmergencyWaitingVisits(
@StaffLoginID varchar(20)= null
)with encryption as

declare @RecordDate smalldatetime
declare @SeeDoctorVisitStatusID varchar(10)
declare @EMPriority varchar(10)

set @EMPriority = dbo.GetLookupDataID('Priority', 'EM')
set @RecordDate = dbo.GetShortDate(dateadd(hour, -12, getdate()))
set @SeeDoctorVisitStatusID = dbo.GetLookupDataID('VisitStatus', 'DR')

if not (@StaffLoginID is null)
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
	dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo, DoctorSpecialtyID,
	VisitDate, dbo.FormatDate(VisitDate) as VisitDateText, FirstName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
	dbo.GetTime(Visits.RecordDateTime) as RecordTime, 
	Visits.StaffNo, dbo.GetStaffName(Visits.StaffNo) as StaffName, 
	dbo.GetStaffLoginID(Visits.StaffNo) as StaffLoginID,
	dbo.GetPriority(VisitNo) as Priority
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ((VisitDate >= @RecordDate and dbo.GetStaffLoginID(Visits.StaffNo) = @StaffLoginID)
		or (VisitDate >= @RecordDate and DoctorSpecialtyID = dbo.GetDoctorSpecialtyID(@StaffLoginID) 
		and Visits.StaffNo is null)) and (VisitStatusID = @SeeDoctorVisitStatusID)
		and (dbo.GetPriority(VisitNo) = dbo.GetLookupDataDes(@EMPriority))
	order by dbo.GetPriority(VisitNo), VisitDate, Visits.RecordDateTime
end
else if (@StaffLoginID is null)
	begin
		select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
	dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo, DoctorSpecialtyID,
	VisitDate, dbo.FormatDate(VisitDate) as VisitDateText, FirstName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
	dbo.GetTime(Visits.RecordDateTime) as RecordTime, 
	Visits.StaffNo, dbo.GetStaffName(Visits.StaffNo) as StaffName, 
	dbo.GetStaffLoginID(Visits.StaffNo) as StaffLoginID,
	dbo.GetPriority(VisitNo) as Priority
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where VisitDate >= @RecordDate and (VisitStatusID = @SeeDoctorVisitStatusID)
	and (dbo.GetPriority(VisitNo) = dbo.GetLookupDataDes(@EMPriority))
	order by dbo.GetPriority(VisitNo), VisitDate, Visits.RecordDateTime
	end
	
return 0
go

/***************************************************************************************************************
exec uspGetEmergencyWaitingVisits 'Admin'
****************************************************************************************************************/


--------GetPayingVisits----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPayingVisits')
	drop proc uspGetPayingVisits
go

create proc uspGetPayingVisits(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

declare @CashBillModesID varchar(10)
declare @NACoPayTypeID varchar(10)

--------------------------------------------------------------------
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @NACoPayTypeID = dbo.GetLookupDataID('CoPayType', 'NA')
--------------------------------------------------------------------

begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
			dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo, FirstName,
			dbo.FormatDate(VisitDate) as VisitDate,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,
			dbo.GetLookupDataDes(GenderID) as Gender,
			dbo.GetAge(BirthDate, getdate()) as Age,
			dbo.GetLookupDataDes(BillModesID) as BillMode,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
			dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
			dbo.GetDoctorFullName(VisitNo) as PrimaryDoctor,
			dbo.FormatDate(Visits.RecordDateTime) as RecordDate,
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ((BillModesID = @CashBillModesID) or (not CoPayTypeID = @NACoPayTypeID)) 
	and (VisitDate between @StartDate and @EndDate)
	order by VisitDate desc, VisitNo desc
end
return 0
go

-- select * from Visits
-- exec uspGetPayingVisits 'Jan 15, 2012', 'apr 30, 2012'

-- select * from Visits
-- exec uspGetPayingVisits 'Jan 15, 2012', 'apr 30, 2012'

--------GetPeriodicVisits----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicVisits')
	drop proc uspGetPeriodicVisits
go

create proc uspGetPeriodicVisits(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

declare @ServicePointID varchar(10)
begin
set @ServicePointID = dbo.GetLookupDataID('ServicePoint', 'TRI')
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
			dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo, FirstName,
			dbo.FormatDate(VisitDate) as VisitDate,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,
			dbo.GetLookupDataDes(GenderID) as Gender,
			dbo.GetAge(BirthDate, getdate()) as Age,
			dbo.GetLookupDataDes(BillModesID) as BillMode,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
			dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.FormatDate(Visits.RecordDateTime) as RecordDate,
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues on Visits.VisitNo = Queues.VisitNo 
	where VisitDate between @StartDate and @EndDate and ServicePointID=@ServicePointID and QueueStatus=1
	order by TokenNo asc, VisitDate asc, VisitNo asc
end
return 0
go
-- select * from Visits
-- exec uspGetPeriodicVisits 'Jan 15, 2012', 'Jan 30, 2012'


--------GetGetPeriodicInvoicedVisits----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicInvoicedVisits')
	drop proc uspGetPeriodicInvoicedVisits
go

create proc uspGetPeriodicInvoicedVisits(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
			dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo, FirstName,
			dbo.FormatDate(VisitDate) as VisitDate,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,
			dbo.GetLookupDataDes(GenderID) as Gender, InvoiceNo,
			dbo.GetAge(BirthDate, getdate()) as Age,
			dbo.GetLookupDataDes(BillModesID) as BillMode,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
			dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.FormatDate(Visits.RecordDateTime) as RecordDate,
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	inner join Invoices on Invoices.PayNo = Visits.VisitNo
	where VisitDate between @StartDate and @EndDate
	order by VisitDate asc, VisitNo asc
end
return 0
go

/***************************************************************************************************
 select * from Visits
exec uspGetPeriodicInvoicedVisits 'Jan 15, 2018', 'Jan 30, 2018'
***************************************************************************************************/

--------GetVisitsByPatientNo------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisitsByPatientNo')
	drop proc uspGetVisitsByPatientNo
go

create proc uspGetVisitsByPatientNo(
@PatientNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Visits where PatientNo = @PatientNo)
begin
	set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
	raiserror(@ErrorMSG,16,1, 'Patient No', @PatientNo, 'Visits')	
	return 1
end
else
begin
	select VisitDate, VisitNo from Visits
	where PatientNo = @PatientNo order by VisitDate, VisitID, VisitNo
end
return 0
go

-- select * from Visits
-- exec uspGetVisitsByPatientNo '1010333'

--------GetVisitFingerprints-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisitFingerprints')
	drop proc uspGetVisitFingerprints
go

create proc uspGetVisitFingerprints
with encryption as

begin

declare @StartDate smalldatetime
declare @EndDate smalldatetime

set @StartDate = dbo.GetShortDate(dateadd(day, -1, getdate()))
set @EndDate = dbo.GetShortDate(dateadd(day, 1, getdate()))

select VisitNo, Visits.PatientNo, Fingerprint from Visits
inner join Patients on Visits.PatientNo = Patients.PatientNo
where (VisitDate >= @StartDate and VisitDate < @EndDate) and not Fingerprint is null
order by VisitDate desc 

end

return 0
go

-- select * from Visits
-- exec uspGetVisitFingerprints

----------------------------------------------------------------------------------------------------------------
-------------- GetPendingVisitFiles ----------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPendingVisitFiles')
	drop proc uspGetPendingVisitFiles
go

create proc uspGetPendingVisitFiles(
@HideSelfRequest bit = 0
)with encryption as

declare @SelfRequestVisitCategoryID varchar(10)
declare @RecordDate smalldatetime

set @SelfRequestVisitCategoryID = dbo.GetLookupDataID('VisitCategory', 'S')
set @RecordDate = dbo.GetShortDate(dateadd(hour, -24, getdate()))

if (@HideSelfRequest = 1)
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, ReferenceNo,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, 
			dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetFileReturnedBy(Visits.PatientNo) as ReturnStatus,
			dbo.GetFileReturnedByName(Visits.PatientNo) as ReturnedbyName,
			dbo.GetLookupDataDes(BillModesID) as BillMode,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
			dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName,
			dbo.GetLookupDataDes(DoctorSpecialtyID) as ToSeeSpecialty,
			dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory,
			dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, Visits.LoginID,
			dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where (VisitDate >= @RecordDate and dbo.GetVisitFileStatus(VisitNo) = '' 
			and not Visits.VisitCategoryID = @SelfRequestVisitCategoryID)
	order by VisitDate, Visits.RecordDateTime
end
else
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, ReferenceNo,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, 
			dbo.GetAge(BirthDate, getdate()) as Age,
			dbo.GetFileReturnedBy(Visits.PatientNo) as ReturnStatus,
			dbo.GetFileReturnedByName(Visits.PatientNo) as ReturnedbyName, 
			dbo.GetLookupDataDes(BillModesID) as BillMode,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
			dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName,
			dbo.GetLookupDataDes(DoctorSpecialtyID) as ToSeeSpecialty,
			dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory,
			dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, Visits.LoginID,
			dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where (VisitDate >= @RecordDate and dbo.GetVisitFileStatus(VisitNo) = '')
	order by VisitDate, Visits.RecordDateTime
end
return 0
go

/***************************************************************************************************************
exec uspGetPendingVisitFiles
exec uspGetPendingVisitFiles 1

****************************************************************************************************************/
-- select * from Visits

----------------------------------------------------------------------------------------------------------------
-------------- GetPendingVisitTriage ---------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPendingVisitTriage')
	drop proc uspGetPendingVisitTriage
go

create proc uspGetPendingVisitTriage(
@HideSelfRequest bit = 0
)with encryption as

declare @SelfRequestVisitCategoryID varchar(10)
declare @RecordDate smalldatetime

set @SelfRequestVisitCategoryID = dbo.GetLookupDataID('VisitCategory', 'S')
set @RecordDate = dbo.GetShortDate(dateadd(hour, -24, getdate()))

if (@HideSelfRequest = 1)
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo, FirstName,
			dbo.GetPriority(VisitNo) as Priority,
			dbo.FormatDate(VisitDate) as VisitDate, ReferenceNo,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, 
			dbo.GetAge(BirthDate, getdate()) as Age,
			dbo.GetFileReturnedBy(Visits.PatientNo) as ReturnStatus,
			dbo.GetFileReturnedByName(Visits.PatientNo) as ReturnedbyName,  
			dbo.GetLookupDataDes(BillModesID) as BillMode,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
			dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName,
			dbo.GetLookupDataDes(DoctorSpecialtyID) as ToSeeSpecialty,
			dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory,
			dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, Visits.LoginID,
			dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where (VisitDate >= @RecordDate and dbo.GetHasVisitTriage(VisitNo) = 0 
			and not Visits.VisitCategoryID = @SelfRequestVisitCategoryID)
	order by VisitDate, Visits.RecordDateTime
end
else
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo, FirstName,
			dbo.GetPriority(VisitNo) as Priority,
			dbo.FormatDate(VisitDate) as VisitDate, ReferenceNo,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, 
			dbo.GetAge(BirthDate, getdate()) as Age,
			dbo.GetFileReturnedBy(Visits.PatientNo) as ReturnStatus,
			dbo.GetFileReturnedByName(Visits.PatientNo) as ReturnedbyName, 
			dbo.GetLookupDataDes(BillModesID) as BillMode,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
			dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName,
			dbo.GetLookupDataDes(DoctorSpecialtyID) as ToSeeSpecialty,
			dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory,
			dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, Visits.LoginID,
			dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where (VisitDate >= @RecordDate and dbo.GetHasVisitTriage(VisitNo) = 0)
	order by VisitDate, Visits.RecordDateTime
end
return 0
go

/***************************************************************************************************************
exec uspGetPendingVisitTriage
exec uspGetPendingVisitTriage 1

****************************************************************************************************************/
-- select * from Visits

----------------------------------------------------------------------------------------------------------------
--------GetVisitNo----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisitNo')
	drop proc uspGetVisitNo
go

create proc uspGetVisitNo(
@PatientNo varchar(20),
@VisitDate smalldatetime = null output,
@VisitNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)

if (@VisitDate is null)
begin
	if not exists(select PatientNo from Visits where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Patient No', @PatientNo, 'Visits')	
		return 1
	end
	else
	begin
		set @VisitNo = (select top 1 VisitNo from Visits where PatientNo = @PatientNo
						and VisitDate = (select max(VisitDate) from Visits where PatientNo = @PatientNo)
						order by VisitID desc)
	end
end
else
if not (@VisitDate is null)
begin

if not exists(select PatientNo from Visits where PatientNo = @PatientNo and VisitDate = @VisitDate)
	begin
		set @ErrorMSG = '%s: %s and %s: ' + dbo.FormatDate(@VisitDate) + ', you are trying to enter does not exist %s'
		raiserror(@ErrorMSG,16,1, 'The record with Patient No', @PatientNo, 'Visit Date', 'in the registered Visits')	
		return 1		
	end
	else
	begin
		set @VisitNo = (select top 1 VisitNo from Visits where PatientNo = @PatientNo
						and VisitDate = @VisitDate order by VisitID desc)
	end
end

return 0

go

-- select * from patients
-- exec  uspGetVisitNo '07022061'
-- exec uspGetVisitNo '07022061', '23 Jan 2007'

--------CountPatientVisitDate-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountPatientVisitDate')
	drop proc uspCountPatientVisitDate
go

create proc uspCountPatientVisitDate(
@PatientNo varchar(20),
@VisitDate smalldatetime,
@DoctorSpecialtyID varchar(10) = null,
@Records tinyint = null output
)with encryption as

if not (@DoctorSpecialtyID is null or @DoctorSpecialtyID = '') 
	begin
		set @Records = (select count(VisitNo) from Visits 
		where PatientNo = @PatientNo and VisitDate = @VisitDate and DoctorSpecialtyID = @DoctorSpecialtyID) 
	end
else  begin set @Records = (select count(VisitNo) from Visits where PatientNo = @PatientNo and VisitDate = @VisitDate) end

set @Records = isnull(@Records, 0)

return 0

go

-- exec uspCountPatientVisitDate '08022078', '1 Jul 2008'

--------GetNextVisitID -----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextVisitID')
	drop proc uspGetNextVisitID
go

create proc uspGetNextVisitID(
@PatientNo varchar(20),
@VisitID int = null output
)with encryption as

set @VisitID = (select max(VisitID) from Visits where PatientNo = @PatientNo)
set @VisitID = dbo.GetNextAutoNumber('Visits', 'VisitNo', @VisitID)

return 0

go

-- exec uspGetNextVisitID '08022077'
-- select * from Visits where PatientNo = '08022077'

------------------------------------------------------------------------------------------------------
-------------- VisitFiles ----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert VisitFiles ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertVisitFiles')
	drop proc uspInsertVisitFiles
go

create proc uspInsertVisitFiles(
@VisitNo varchar(20),
@FileStatusID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if exists(select VisitNo from VisitFiles where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @FileStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'File Status ID', @FileStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into VisitFiles
(VisitNo, FileStatusID, LoginID)
values
(@VisitNo, @FileStatusID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertVisitFiles '1210883005', '100SN', 'Admin'
exec uspInsertVisitFiles '1210883003', '100NA', 'Admin'
exec uspInsertVisitFiles '1210883002', '100NS', 'Admin'

******************************************************************************************************/
-- select * from VisitFiles
-- delete from VisitFiles

-------------- Update VisitFiles ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateVisitFiles')
	drop proc uspUpdateVisitFiles
go

create proc uspUpdateVisitFiles(
@VisitNo varchar(20),
@FileStatusID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from VisitFiles where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visit Files')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @FileStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'File Status ID', @FileStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update VisitFiles set
FileStatusID = @FileStatusID, LoginID = @LoginID
where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateVisitFiles '1210883005', '100SN', 'Admin'

******************************************************************************************************/
-- select * from VisitFiles
-- delete from VisitFiles

-------------- Get VisitFiles -----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisitFiles')
	drop proc uspGetVisitFiles
go

create proc uspGetVisitFiles(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from VisitFiles where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visit Files')
		return 1
	end
else
begin
	select VisitNo, FileStatusID, dbo.GetLookupDataDes(FileStatusID) as FileStatus
	from VisitFiles
	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetVisitFiles '1210883005'

******************************************************************************************************/
-- select * from VisitFiles
-- delete from VisitFiles

------------------------------------------------------------------------------------------------------
-------------- SmartCardAuthorisations ---------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert SmartCardAuthorisations --------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertSmartCardAuthorisations')
	drop proc uspInsertSmartCardAuthorisations
go

create proc uspInsertSmartCardAuthorisations(
@PatientNo varchar(20),
@BillModesID varchar(10),
@BillNo varchar(20),
@ToVisitDate Smalldatetime,
@MedicalCardNo varchar(20),
@AuthorisedBy varchar(41),
@AuthorisationReason varchar(10),
@ClaimReferenceNo varchar(30),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

declare @CashBillModesID varchar(10)
declare @CashBillModes varchar(100)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

----------------------------------------------------------------------------
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @CashBillModes = dbo.GetLookupDataDes(@CashBillModesID)
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
----------------------------------------------------------------------------

if not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Patients')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BillModesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'To-Bill Modes ID', @BillModesID, 'Lookup Data')
		return 1
	end

------------------------------------------------------------------------------------------------------------------
if (@BillModesID = @AccountBillModesID) and (@BillNo = @CashBillModes)
	begin
		set @ErrorMSG = 'To-Bill No for Bill Mode Account can''t be Cash!'
		raiserror(@ErrorMSG,16, 1)	
		return 1
	end

if (@BillModesID = @InsuranceBillModesID)
	begin
		if not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @BillNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @BillNo, 'Scheme Members')
				return 1
			end
	end
else 
	begin 
		if not exists(select AccountNo from BillCustomers where AccountNo = @BillNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Account No', @BillNo, 'To-Bill Customers')	
				return 1
			end
	end
------------------------------------------------------------------------------------------------------------------

if exists(select PatientNo from SmartCardAuthorisations where PatientNo = @PatientNo and BillModesID = @BillModesID and BillNo = @BillNo and ToVisitDate = @ToVisitDate)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: '+ dbo.FormatDate(@ToVisitDate) +', you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'To-Bill Modes ID', @BillModesID, 'To-Bill No', @BillNo, 'To-Visit Date')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AuthorisationReason)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Authorisation Reason', @AuthorisationReason, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into SmartCardAuthorisations
(PatientNo, BillModesID, BillNo, ToVisitDate, MedicalCardNo, AuthorisedBy, AuthorisationReason, ClaimReferenceNo, LoginID, ClientMachine)
values
(@PatientNo, @BillModesID, @BillNo, @ToVisitDate, @MedicalCardNo, @AuthorisedBy, @AuthorisationReason, @ClaimReferenceNo, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertSmartCardAuthorisations '1512645', '17A', '100009A', '14 AUG 2015', 'M005', 'Kintu Fred', 
									  '14601', '7800', 'Admin', 'SyncSoft'

exec uspInsertSmartCardAuthorisations '1512641', '17A', '100009A', '14 AUG 2015', 'M005', 'Kintu Fred', 
									  '14601', '7800', 'Admin', 'SyncSoft'

******************************************************************************************************/
-- select * from SmartCardAuthorisations
-- delete from SmartCardAuthorisations

-------------- Update SmartCardAuthorisations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateSmartCardAuthorisations')
	drop proc uspUpdateSmartCardAuthorisations
go

create proc uspUpdateSmartCardAuthorisations(
@PatientNo varchar(20),
@BillModesID varchar(10),
@BillNo varchar(20),
@ToVisitDate Smalldatetime,
@MedicalCardNo varchar(20),
@AuthorisedBy varchar(41),
@AuthorisationReason varchar(10),
@ClaimReferenceNo varchar(30),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

declare @CashBillModesID varchar(10)
declare @CashBillModes varchar(100)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

----------------------------------------------------------------------------
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @CashBillModes = dbo.GetLookupDataDes(@CashBillModesID)
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
----------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @BillModesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'To-Bill Modes ID', @BillModesID, 'Lookup Data')
		return 1
	end

------------------------------------------------------------------------------------------------------------------
if (@BillModesID = @AccountBillModesID) and (@BillNo = @CashBillModes)
	begin
		set @ErrorMSG = 'To-Bill No for Bill Mode Account can''t be Cash!'
		raiserror(@ErrorMSG,16, 1)	
		return 1
	end

if (@BillModesID = @InsuranceBillModesID)
	begin
		if not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @BillNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @BillNo, 'Scheme Members')
				return 1
			end
	end
else 
	begin 
		if not exists(select AccountNo from BillCustomers where AccountNo = @BillNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Account No', @BillNo, 'To-Bill Customers')	
				return 1
			end
	end
------------------------------------------------------------------------------------------------------------------

if not exists(select PatientNo from SmartCardAuthorisations where PatientNo = @PatientNo and BillModesID = @BillModesID and BillNo = @BillNo and ToVisitDate = @ToVisitDate)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: '+ dbo.FormatDate(@ToVisitDate) +', you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'To-Bill Modes ID', @BillModesID, 'To-Bill No', @BillNo, 'To-Visit Date', 'Smart Card Authorisations')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AuthorisationReason)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Authorisation Reason', @AuthorisationReason, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update SmartCardAuthorisations set
MedicalCardNo = @MedicalCardNo, AuthorisedBy = @AuthorisedBy, AuthorisationReason = @AuthorisationReason, 
ClaimReferenceNo = @ClaimReferenceNo, LoginID = @LoginID, ClientMachine = @ClientMachine
where PatientNo = @PatientNo and BillModesID = @BillModesID and BillNo = @BillNo and ToVisitDate = @ToVisitDate
return 0
end
go

/******************************************************************************************************
exec uspUpdateSmartCardAuthorisations
******************************************************************************************************/
-- select * from SmartCardAuthorisations
-- delete from SmartCardAuthorisations

-------------- Get SmartCardAuthorisations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetSmartCardAuthorisations')
	drop proc uspGetSmartCardAuthorisations
go

create proc uspGetSmartCardAuthorisations(
@PatientNo varchar(20),
@BillModesID varchar(10),
@BillNo varchar(20),
@ToVisitDate Smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)
	
if not exists(select PatientNo from SmartCardAuthorisations where PatientNo = @PatientNo and BillModesID = @BillModesID and BillNo = @BillNo and ToVisitDate = @ToVisitDate)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: '+ dbo.FormatDate(@ToVisitDate) +', you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'To-Bill Modes ID', @BillModesID, 'To-Bill No', @BillNo, 'To-Visit Date', 'Smart Card Authorisations')
		return 1
	end
else
begin
	select PatientNo, BillModesID, dbo.GetLookupDataDes(BillModesID) as BillModes,
	BillNo, ToVisitDate, MedicalCardNo, AuthorisedBy, AuthorisationReason, 
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
	dbo.GetDefaultInsuranceName(BillModesID, BillNo) as InsuranceName, 
	dbo.GetLookupDataDes(AuthorisationReason) as AuthorisationReasonDesc, ClaimReferenceNo
	from SmartCardAuthorisations
	where PatientNo = @PatientNo and BillModesID = @BillModesID and BillNo = @BillNo and ToVisitDate = @ToVisitDate
return 0
end
go

/******************************************************************************************************
exec uspGetSmartCardAuthorisations
******************************************************************************************************/
-- select * from SmartCardAuthorisations
-- delete from SmartCardAuthorisations

--------IsSmartCardAuthorized-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspIsSmartCardAuthorized')
	drop proc uspIsSmartCardAuthorized
go

create proc uspIsSmartCardAuthorized(
@PatientNo varchar(20),
@BillModesID varchar(10),
@BillNo varchar(20),
@ToVisitDate Smalldatetime,
@IsSmartCardAuthorized bit = null output
)with encryption as

if exists(select PatientNo from SmartCardAuthorisations 
		  where PatientNo = @PatientNo and BillModesID = @BillModesID and BillNo = @BillNo and ToVisitDate = @ToVisitDate)
	begin set @IsSmartCardAuthorized = 1 end
else begin set @IsSmartCardAuthorized = 0 end

set @IsSmartCardAuthorized = isnull(@IsSmartCardAuthorized, 0)

return 0
go

-- exec uspIsSmartCardAuthorized '1509726', '12 Aug 2015', 'A130176'
-- exec uspIsSmartCardAuthorized '1509726', '13 Aug 2015', 'A130176'

-- select * from SmartCardAuthorisations

--------IsSmartCardApplicable-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspIsSmartCardApplicable')
	drop proc uspIsSmartCardApplicable
go

create proc uspIsSmartCardApplicable(
@BillModesID varchar(10), 
@BillNo varchar(20),
@IsSmartCardApplicable bit = null output
)with encryption as

begin 
	set @IsSmartCardApplicable = dbo.GetSmartCardApplicable(@BillModesID, @BillNo)	
	set @IsSmartCardApplicable = isnull(@IsSmartCardApplicable, 0)
end
return 0
go

-- exec uspIsSmartCardApplicable '17I', '100002A'
-- exec uspIsSmartCardApplicable '', '100008A'

-- select * from BillCustomers


------------------------------------------------------------------------------------------------------
-------------- Triage --------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Triage -------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspInsertTriage')
	drop proc uspInsertTriage
go

create proc uspInsertTriage(
@VisitNo varchar(20),
@Weight decimal(5,2),
@Temperature decimal(5,2),
@Height decimal(5,2),
@MUAC decimal(5,2),
@Pulse tinyint,
@BloodPressure varchar(10),
@HeadCircum decimal(5,2),
@BodySurfaceArea decimal(10,2),
@RespirationRate tinyint,
@OxygenSaturation decimal(5,2),
@HeartRate tinyint,
@Notes varchar(2000),
@TriagePriorityID varchar(10),
@BMIStatusID varchar(10),
@MUACStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if exists(select VisitNo from Triage where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BMIStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'BMI Status ID', @BMIStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @MUACStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'MUAC Status ID', @MUACStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end



begin

------------------------------------------------------------------------------------
if @Weight < 0 set @Weight = null
if @Temperature < 0 set @Temperature = null
if @Height < 0 set @Height = null
if @MUAC < 0 set @MUAC = null
if @Pulse <= 0 set @Pulse = null
if @HeadCircum < 0 set @HeadCircum = null
if @BodySurfaceArea < 0 set @BodySurfaceArea = null
if @RespirationRate <= 0 set @RespirationRate = null
if @OxygenSaturation <= 0 set @OxygenSaturation = null
if @HeartRate <= 0 set @HeartRate = null
------------------------------------------------------------------------------------

insert into Triage
(VisitNo, Weight, Temperature, Height,MUAC, Pulse, BloodPressure, HeadCircum, BodySurfaceArea, 
RespirationRate, OxygenSaturation, HeartRate, Notes, TriagePriorityID,BMIStatusID, MUACStatusID, LoginID, ClientMachine)
values
(@VisitNo, @Weight, @Temperature, @Height,@MUAC, @Pulse, @BloodPressure, @HeadCircum, @BodySurfaceArea, 
@RespirationRate, @OxygenSaturation, @HeartRate, @Notes, @TriagePriorityID,@BMIStatusID, @MUACStatusID, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertTriage '000001BA001', 78, 39.02, 89.36, 75.56, '78/95', 80, null, 'Kutegz'
exec uspInsertTriage '000004OR002', 45, 89.02, 89.36, 15, 78.95, 8, null, 'Admin'

******************************************************************************************************/
-- select * from Triage
-- delete from Triage

-------------- Update Triage -------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateTriage')
	drop proc uspUpdateTriage
go

create proc uspUpdateTriage(
@VisitNo varchar(20),
@Weight decimal(5,2),
@Temperature decimal(5,2),
@Height decimal(5,2),
@MUAC decimal(5,2),
@Pulse tinyint,
@BloodPressure varchar(10),
@HeadCircum decimal(5,2),
@BodySurfaceArea decimal(10,2),
@RespirationRate tinyint,
@OxygenSaturation decimal(5,2),
@HeartRate tinyint,
@Notes varchar(2000),
@TriagePriorityID varchar(10),
@BMIStatusID varchar(10),
@MUACStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Triage where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Triage')
		return 1
	end
if not exists(select DataID from LookupData where DataID = @BMIStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'BMI Status ID', @BMIStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @MUACStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'MUAC Status ID', @MUACStatusID, 'Lookup Data')
		return 1
	end
if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

-----------------------------------------------------------------------------------------------
if @Weight < 0 set @Weight = null
if @Temperature < 0 set @Temperature = null
if @Height < 0 set @Height = null
if @MUAC < 0 set @MUAC = null
if @Pulse <= 0 set @Pulse = null
if @HeadCircum < 0 set @HeadCircum = null
if @BodySurfaceArea < 0 set @BodySurfaceArea = null
if @RespirationRate <= 0 set @RespirationRate = null
if @OxygenSaturation <= 0 set @OxygenSaturation = null
if @HeartRate <= 0 set @HeartRate = null
-----------------------------------------------------------------------------------------------

update Triage set
Weight = @Weight, Temperature = @Temperature, Height = @Height,MUAC = @MUAC, Pulse = @Pulse, 
BloodPressure = @BloodPressure, HeadCircum = @HeadCircum, BodySurfaceArea = @BodySurfaceArea, 
RespirationRate = @RespirationRate, OxygenSaturation = @OxygenSaturation, HeartRate = @HeartRate, 
Notes = @Notes, TriagePriorityID = @TriagePriorityID, BMIStatusID = @BMIStatusID,MUACStatusID = @MUACStatusID, LoginID = @LoginID, @ClientMachine = @ClientMachine
where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateTriage '050878KE001', 245, 289.02, 289.36, 215, 278.95, 28, 26, '', 'Admin'

******************************************************************************************************/
-- select * from Triage
-- delete from Triage

-------------- Get Triage ----------------------------------------------------------------------------


if exists (select * from sysobjects where name = 'uspGetTriage')
	drop proc uspGetTriage
go

create proc uspGetTriage(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Triage where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Triage')
		return 1
	end
else
begin
	select VisitNo, Weight, Temperature, Height,MUAC, Pulse, BloodPressure, HeadCircum, BodySurfaceArea, 
	RespirationRate, OxygenSaturation, HeartRate, dbo.CalculateBMI(Weight, Height/100) as BMI, Notes,
	TriagePriorityID, dbo.GetLookupDataDes(TriagePriorityID) as Priority,
	BMIStatusID, dbo.GetLookupDataDes(BMIStatusID) as BMIStatus,
	MUACStatusID,dbo.GetLookupDataDes(MUACStatusID) as MUACStatus
	from Triage
	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetTriage '050878KE001'

******************************************************************************************************/
-- select * from Triage
-- delete from Triage

------------------------------------------------------------------------------------------------------
-------------- VisionAssessment ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert VisionAssessment ---------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertVisionAssessment')
	drop proc uspInsertVisionAssessment
go

create proc uspInsertVisionAssessment(
@VisitNo varchar(20),
@EyeTestID varchar(10),
@VisualAcuityRightID varchar(10),
@VisualAcuityRightExtID varchar(10),
@VisualAcuityLeftID varchar(10),
@VisualAcuityLeftExtID varchar(10),
@PreferentialLookingRightID varchar(10),
@PreferentialLookingLeftID varchar(10),
@Notes varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @EntryOrder integer

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EyeTestID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Eye Test', @EyeTestID, 'Lookup Data')
		return 1
	end

if exists(select VisitNo from VisionAssessment where VisitNo = @VisitNo and EyeTestID = @EyeTestID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Eye Test', @EyeTestID)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityRightID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visual Acuity Right', @VisualAcuityRightID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityRightExtID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visual Acuity Right Ext', @VisualAcuityRightExtID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityLeftID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisualAcuity Left', @VisualAcuityLeftID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityLeftExtID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visual Acuity Left Ext', @VisualAcuityLeftExtID, 'Lookup Data')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @PreferentialLookingRightID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Perception Of Light Right', @PreferentialLookingRightID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PreferentialLookingLeftID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Perception Of Ligh tLeft', @PreferentialLookingLeftID, 'Lookup Data')
		return 1
	end


if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
begin

if  exists(select VisitNo from VisionAssessment where VisitNo  = @VisitNo)
	begin
		set @EntryOrder =(select (Max(EntryOrder)) + 1 from VisionAssessment where VisitNo  = @VisitNo)
	end 
else set @EntryOrder = 1
-----------------------------------------------------------------------------------------------------------------------------

insert into VisionAssessment
(VisitNo,EntryOrder, EyeTestID, VisualAcuityRightID, VisualAcuityRightExtID, VisualAcuityLeftID, 
VisualAcuityLeftExtID,  PreferentialLookingRightID, 
PreferentialLookingLeftID,  Notes, LoginID, ClientMachine)
values
(@VisitNo,@EntryOrder ,@EyeTestID, @VisualAcuityRightID, @VisualAcuityRightExtID, @VisualAcuityLeftID, 
@VisualAcuityLeftExtID,  @PreferentialLookingRightID, 
@PreferentialLookingLeftID, @Notes, @LoginID, @ClientMachine)
return 0
end

go

/******************************************************************************************************
exec uspInsertVisionAssessment
******************************************************************************************************/
-- select * from VisionAssessment
-- delete from VisionAssessment

-------------- Update VisionAssessment -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateVisionAssessment')
	drop proc uspUpdateVisionAssessment
go

create proc uspUpdateVisionAssessment(
@VisitNo varchar(20),
@EyeTestID varchar(10),
@VisualAcuityRightID varchar(10),
@VisualAcuityRightExtID varchar(10),
@VisualAcuityLeftID varchar(10),
@VisualAcuityLeftExtID varchar(10),
@PreferentialLookingRightID varchar(10),
@PreferentialLookingLeftID varchar(10),
@Notes varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from VisionAssessment where VisitNo = @VisitNo and EyeTestID = @EyeTestID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Eye Test', @EyeTestID, 'VisionAssessment')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityRightID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visual Acuity Right', @VisualAcuityRightID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityRightExtID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visual Acuity Right Ext', @VisualAcuityRightExtID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityLeftID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisualAcuity Left', @VisualAcuityLeftID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityLeftExtID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visual Acuity Left Ext', @VisualAcuityLeftExtID, 'Lookup Data')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @PreferentialLookingRightID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Perception Of Light Right', @PreferentialLookingRightID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PreferentialLookingLeftID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Perception Of Ligh tLeft', @PreferentialLookingLeftID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update VisionAssessment set
VisualAcuityRightID = @VisualAcuityRightID, VisualAcuityRightExtID = @VisualAcuityRightExtID, VisualAcuityLeftID = @VisualAcuityLeftID, 
VisualAcuityLeftExtID = @VisualAcuityLeftExtID, 
PreferentialLookingRightID = @PreferentialLookingRightID, PreferentialLookingLeftID = @PreferentialLookingLeftID, 
Notes = @Notes, LoginID = @LoginID, ClientMachine = @ClientMachine
where VisitNo = @VisitNo and EyeTestID = @EyeTestID
return 0
end
go

/******************************************************************************************************
exec uspUpdateVisionAssessment
******************************************************************************************************/
-- select * from VisionAssessment
-- delete from VisionAssessment

-------------- Get VisionAssessment -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisionAssessment')
	drop proc uspGetVisionAssessment
go

create proc uspGetVisionAssessment(
@VisitNo varchar(20),
@EyeTestID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @RefractionEyeTestID varchar(10)

set @RefractionEyeTestID = dbo.GetLookupDataID('EyeTest',  'RF')

if @EyeTestID  is not null 
begin
if not exists(select VisitNo from VisionAssessment where VisitNo = @VisitNo and EyeTestID = @EyeTestID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Eye Test', @EyeTestID, 'VisionAssessment')
		return 1
	end
	select VisionAssessment.VisitNo,
	
	EyeTestID,dbo.GetLookupDataDes(EyeTestID) as EyeTest ,dbo.GetHasRefractionVisionAssessment(Visits.VisitNo) as HasRefractionVisionAssessment,
	VisualAcuityRightID, dbo.GetLookupDataDes(VisualAcuityRightID) as VisualAcuityRight,
	 VisualAcuityRightExtID, dbo.GetLookupDataDes(VisualAcuityRightExtID) as VisualAcuityRightExt, VisualAcuityLeftID,
	  dbo.GetLookupDataDes(VisualAcuityLeftID) as VisualAcuityLeft, VisualAcuityLeftExtID,
	   dbo.GetLookupDataDes(VisualAcuityLeftExtID) as VisualAcuityLeftExt, PreferentialLookingRightID, 
	    dbo.GetLookupDataDes(PreferentialLookingRightID) as PreferentialLookingRight, PreferentialLookingLeftID, 
	    dbo.GetLookupDataDes(PreferentialLookingLeftID) as PreferentialLookingLeft, Notes, VisionAssessment.LoginID, VisionAssessment.ClientMachine
	from VisionAssessment
	inner join Visits on VisionAssessment.VisitNo = Visits.VisitNo
where VisionAssessment.VisitNo = @VisitNo and EyeTestID = @EyeTestID
return 0
end
else
begin
	select VisionAssessment.VisitNo
 EyeTestID,dbo.GetLookupDataDes(EyeTestID) as EyeTest,
	 VisualAcuityRightID, dbo.GetLookupDataDes(VisualAcuityRightID) as VisualAcuityRight,
	 VisualAcuityRightExtID, dbo.GetLookupDataDes(VisualAcuityRightExtID) as VisualAcuityRightExt, VisualAcuityLeftID,
	  dbo.GetLookupDataDes(VisualAcuityLeftID) as VisualAcuityLeft, VisualAcuityLeftExtID,
	   dbo.GetLookupDataDes(VisualAcuityLeftExtID) as VisualAcuityLeftExt,PreferentialLookingRightID, 
	    dbo.GetLookupDataDes(PreferentialLookingRightID) as PreferentialLookingRight, PreferentialLookingLeftID, 
	    dbo.GetLookupDataDes(PreferentialLookingLeftID) as PreferentialLookingLeft, Notes, VisionAssessment.LoginID, VisionAssessment.ClientMachine
	from VisionAssessment
inner join Visits on VisionAssessment.VisitNo = Visits.VisitNo 
	where VisionAssessment.VisitNo = @VisitNo and NOT  EyeTestID = @RefractionEyeTestID
	Order by EntryOrder
return 0
end
go

/******************************************************************************************************
exec uspGetVisionAssessment '1300536006', '129RF'
******************************************************************************************************/
-- select * from VisionAssessment
-- delete from VisionAssessment

----------------------------------------------------------------------------------------------------------------
-------------- GetPendingVisionAssessment ----------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPendingVisionAssessment')
	drop proc uspGetPendingVisionAssessment
go

create proc uspGetPendingVisionAssessment(
@HideSelfRequest bit = 0
)with encryption as

declare @SelfRequestVisitCategoryID varchar(10)
declare @RecordDate smalldatetime

set @SelfRequestVisitCategoryID = dbo.GetLookupDataID('VisitCategory', 'S')
set @RecordDate = dbo.GetShortDate(dateadd(hour, -24, getdate()))

if (@HideSelfRequest = 1)
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, ReferenceNo,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, 
			dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetFileReturnedBy(Visits.PatientNo) as ReturnStatus,
			dbo.GetFileReturnedByName(Visits.PatientNo) as ReturnedbyName, 
			dbo.GetLookupDataDes(BillModesID) as BillMode,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
			dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName,
			dbo.GetLookupDataDes(DoctorSpecialtyID) as ToSeeSpecialty,
			dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory,
			dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, Visits.LoginID,
			dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where (VisitDate >= @RecordDate and dbo.GetHasVisionAssessment(VisitNo) = 0 
			and not Visits.VisitCategoryID = @SelfRequestVisitCategoryID)
	order by VisitDate, Visits.RecordDateTime
end
else
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, ReferenceNo,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, 
			dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(BillModesID) as BillMode,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
			dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName,
			dbo.GetLookupDataDes(DoctorSpecialtyID) as ToSeeSpecialty,
			dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory,
			dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, Visits.LoginID,
			dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where (VisitDate >= @RecordDate and dbo.GetHasVisionAssessment(VisitNo) = 0)
	order by VisitDate, Visits.RecordDateTime
end
return 0
go
---***************************************************************************************************************
--exec uspGetPendingVisionAssessment 0
--exec uspGetPendingVisionAssessment 1

----------------------------------------------------------------------------------------------------------------
-------------- GetEmergencyPendingVisitTriage ---------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetEmergencyPendingVisitTriage')
	drop proc uspGetEmergencyPendingVisitTriage
go

create proc uspGetEmergencyPendingVisitTriage(
@HideSelfRequest bit = 0
)with encryption as

declare @SelfRequestVisitCategoryID varchar(10)
declare @RecordDate smalldatetime
declare @EMPriority varchar(10) 

set @SelfRequestVisitCategoryID = dbo.GetLookupDataID('VisitCategory', 'S')
set @RecordDate = dbo.GetShortDate(dateadd(hour, -24, getdate()))
set @EMPriority = dbo.GetLookupDataID('Priority', 'EM')

if (@HideSelfRequest = 1)
	begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.GetPriority(VisitNo) as Priority,
			dbo.FormatDate(VisitDate) as VisitDate, ReferenceNo,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, 
			dbo.GetAge(BirthDate, getdate()) as Age,
			dbo.GetFileReturnedBy(Visits.PatientNo) as ReturnStatus,
			dbo.GetFileReturnedByName(Visits.PatientNo) as ReturnedbyName,  
			dbo.GetLookupDataDes(BillModesID) as BillMode,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
			dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName,
			dbo.GetLookupDataDes(DoctorSpecialtyID) as ToSeeSpecialty,
			dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory,
			dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, Visits.LoginID,
			dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where (VisitDate >= @RecordDate and dbo.GetHasVisitTriage(VisitNo) = 0 
			and not Visits.VisitCategoryID = @SelfRequestVisitCategoryID)
			and (dbo.GetPriority(VisitNo) = dbo.GetLookupDataDes(@EMPriority))
	order by VisitDate, Visits.RecordDateTime
	end
else
	begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.GetPriority(VisitNo) as Priority,
			dbo.FormatDate(VisitDate) as VisitDate, ReferenceNo,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, 
			dbo.GetAge(BirthDate, getdate()) as Age,
			dbo.GetFileReturnedBy(Visits.PatientNo) as ReturnStatus,
			dbo.GetFileReturnedByName(Visits.PatientNo) as ReturnedbyName, 
			dbo.GetLookupDataDes(BillModesID) as BillMode,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
			dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName,
			dbo.GetLookupDataDes(DoctorSpecialtyID) as ToSeeSpecialty,
			dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory,
			dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, Visits.LoginID,
			dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Visits
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where (VisitDate >= @RecordDate and dbo.GetHasVisitTriage(VisitNo) = 0)
		   and (dbo.GetPriority(VisitNo) = dbo.GetLookupDataDes(@EMPriority))
	order by VisitDate, Visits.RecordDateTime
	end
	
return 0
go

/***************************************************************************************************************
exec uspGetEmergencyPendingVisitTriage 1
****************************************************************************************************************/

------------------------------------------------------------------------------------------------------
-------------- IPDVisionAssessment --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert IPDVisionAssessment -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertIPDVisionAssessment')
	drop proc uspInsertIPDVisionAssessment
go

create proc uspInsertIPDVisionAssessment(
@AdmissionNo varchar(20),
@VARoundNo Varchar(20),
@RoundDateTime smalldatetime,
@EyeTestID varchar(10),
@VisualAcuityRightID varchar(10),
@VisualAcuityRightExtID varchar(10),
@VisualAcuityLeftID Varchar(10),
@VisualAcuityLeftExtID Varchar(10),
@PreferentialLookingRightID Varchar(10),
@PreferentialLookingLeftID Varchar(10),
@Notes Varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @VARoundID int

declare @PaddingLEN tinyint
declare @PassedVARoundID int
declare @PassedVARoundNo varchar(20)
declare @PassedAdmissionNo varchar(20)

if not exists(select DataID from LookupData where DataID = @EyeTestID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'EyeTest', @EyeTestID, 'Lookup Data')
		return 1
	end

if exists(select VARoundNo from IPDVisionAssessment where VARoundNo = @VARoundNo and EyeTestID = @EyeTestID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'VARoundNo', @VARoundNo, 'EyeTest', @EyeTestID)
		return 1
	end

if not exists(select AdmissionNo from Admissions where AdmissionNo  = @AdmissionNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'AdmissionNo', @AdmissionNo, 'Admissions')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityRightID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisualAcuityRight', @VisualAcuityRightID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityRightExtID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisualAcuityRightExt', @VisualAcuityRightExtID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityLeftID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisualAcuityLeft', @VisualAcuityLeftID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityLeftExtID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisualAcuityLeftExt', @VisualAcuityLeftExtID, 'Lookup Data')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @PreferentialLookingRightID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PreferentialLookingRight', @PreferentialLookingRightID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PreferentialLookingLeftID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PreferentialLookingLeft', @PreferentialLookingLeftID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
----------------------------------------------------------------------------------------------------------

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'IPDVisionAssessment' and AutoColumnName = 'VARoundNo'

set @PassedAdmissionNo = ltrim(rtrim(substring(@VARoundNo, 1, len(@VARoundNo) - @PaddingLEN)))

if (@PassedAdmissionNo = @AdmissionNo)

begin

	set @PassedVARoundID = 1
	set @PassedVARoundNo = @VARoundNo

	set @PassedVARoundNo = ltrim(rtrim(substring(@PassedVARoundNo, len(@PassedAdmissionNo) + 1, @PaddingLEN)))

	if isnumeric(@PassedVARoundNo) = 1 set @PassedVARoundID = @PassedVARoundNo
	else set @PassedVARoundID = 1

	set @VARoundID = (select max(VARoundID) from IPDVisionAssessment where AdmissionNo = @AdmissionNo)
	set @VARoundID = dbo.GetNextAutoNumber('IPDVisionAssessment', 'VARoundNo', @VARoundID)

	if @PassedVARoundID < @VARoundID set @VARoundID = @PassedVARoundID
	if @PassedVARoundID > @VARoundID set @VARoundID = @PassedVARoundID

end else set @VARoundID = 1

----------------------------------------------------------------------------------------------------------

insert into IPDVisionAssessment
(VARoundID, AdmissionNo, VARoundNo,RoundDateTime, EyeTestID, VisualAcuityRightID, VisualAcuityRightExtID,
 VisualAcuityLeftID, VisualAcuityLeftExtID, PreferentialLookingRightID,PreferentialLookingLeftID,
 Notes, LoginID, ClientMachine)
values
(@VARoundID, @AdmissionNo, @VARoundNo,@RoundDateTime, @EyeTestID, @VisualAcuityRightID, @VisualAcuityRightExtID,
 @VisualAcuityLeftID, @VisualAcuityLeftExtID, @PreferentialLookingRightID,
  @PreferentialLookingLeftID, @Notes, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertIPDVisionAssessment
******************************************************************************************************/
-- select * from IPDVisionAssessment
-- delete from IPDVisionAssessment

-------------- Update IPDVisionAssessment -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDVisionAssessment')
	drop proc uspUpdateIPDVisionAssessment
go

create proc uspUpdateIPDVisionAssessment(
@AdmissionNo varchar(20),
@VARoundNo Varchar(20),
@RoundDateTime smalldatetime,
@EyeTestID varchar(10),
@VisualAcuityRightID varchar(10),
@VisualAcuityRightExtID varchar(10),
@VisualAcuityLeftID Varchar(10),
@VisualAcuityLeftExtID Varchar(10),
@PreferentialLookingRightID Varchar(10),
@PreferentialLookingLeftID Varchar(10),
@Notes Varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VARoundNo from IPDVisionAssessment where VARoundNo = @VARoundNo and EyeTestID = @EyeTestID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VARoundNo', @VARoundNo, 'EyeTest', @EyeTestID, 'IPDVisionAssessment')
		return 1
	end

if not exists(select AdmissionNo from Admissions where AdmissionNo  = @AdmissionNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'AdmissionNo', @AdmissionNo, 'Admissions')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityRightID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisualAcuityRight', @VisualAcuityRightID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityRightExtID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisualAcuityRightExt', @VisualAcuityRightExtID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityLeftID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisualAcuityLeft', @VisualAcuityLeftID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualAcuityLeftExtID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisualAcuityLeftExt', @VisualAcuityLeftExtID, 'Lookup Data')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @PreferentialLookingRightID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PreferentialLookingRight', @PreferentialLookingRightID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PreferentialLookingLeftID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PreferentialLookingLeft', @PreferentialLookingLeftID, 'Lookup Data')
		return 1
	end


if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update IPDVisionAssessment set
AdmissionNo = @AdmissionNo, VisualAcuityRightID = @VisualAcuityRightID,RoundDateTime = @RoundDateTime,
 VisualAcuityRightExtID = @VisualAcuityRightExtID, VisualAcuityLeftID = @VisualAcuityLeftID, 
 VisualAcuityLeftExtID = @VisualAcuityLeftExtID, PreferentialLookingRightID = @PreferentialLookingRightID,
   PreferentialLookingLeftID = @PreferentialLookingLeftID,
   Notes = @Notes, LoginID = @LoginID, ClientMachine = @ClientMachine
where VARoundNo = @VARoundNo and EyeTestID = @EyeTestID
return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDVisionAssessment
******************************************************************************************************/
-- select * from IPDVisionAssessment
-- delete from IPDVisionAssessment


-------------- Get IPD Vision Assessment -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDVisionAssessment')
	drop proc uspGetIPDVisionAssessment
go

create proc uspGetIPDVisionAssessment(
@VARoundNo varchar(20) = null,
@EyeTestID varchar(10) = null,
@AdmissionNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @RefractionEyeTestID varchar(10)

set @RefractionEyeTestID = dbo.GetLookupDataID('EyeTest',  'RF')

if @EyeTestID  is not null 
begin
if not exists(select VARoundNo from IPDVisionAssessment where VARoundNo = @VARoundNo and EyeTestID = @EyeTestID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VARoundNo', @VARoundNo, 'EyeTest', @EyeTestID, 'IPDVisionAssessment')
		return 1
	end
	select  VARoundID, IPDVisionAssessment.AdmissionNo, VARoundNo, 
		IPDDoctor.RoundDateTime as IPDDoctorRoundDateTime, Admissions.VisitNo, Patients.PatientNo, FirstName, LastName, Photo,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, BirthDate, JoinDate, 
		dbo.FormatDate(VisitDate) as VisitDate,dbo.GetTotalIPDDoctorRounds(IPDVisionAssessment.AdmissionNo) as TotalIPDDoctorRounds,
		dbo.GetAge(BirthDate, getdate()) as Age, 
		GenderID, dbo.GetLookupDataDes(GenderID) as Gender,VisitCategoryID, 
		dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, 
		VisitStatusID, dbo.GetLookupDataDes(VisitStatusID) as VisitStatus,
        dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor, AdmissionDateTime, 
		AdmissionStatusID, dbo.GetLookupDataDes(AdmissionStatusID) as AdmissionStatus,
      EyeTestID,dbo.GetLookupDataDes(EyeTestID) as EyeTest,IPDVisionAssessment.RoundDateTime as IPDVARoundDateTime,
      dbo.GetHasIPDVisualAssessment(IPDVisionAssessment.AdmissionNo) as HasIPDVisualAssessment,
       VisualAcuityRightID,	 dbo.GetLookupDataDes(VisualAcuityRightID) as VisualAcuityRight, VisualAcuityRightExtID, 
	 dbo.GetLookupDataDes(VisualAcuityRightExtID) as VisualAcuityRightExt, VisualAcuityLeftID,
	  dbo.GetLookupDataDes(VisualAcuityLeftID) as VisualAcuityLeft, VisualAcuityLeftExtID,
	   dbo.GetLookupDataDes(VisualAcuityLeftExtID) as VisualAcuityLeftExt, PreferentialLookingRightID, 
	    dbo.GetLookupDataDes(PreferentialLookingRightID) as PreferentialLookingRight, 
	    PreferentialLookingLeftID, dbo.GetLookupDataDes(PreferentialLookingLeftID) as PreferentialLookingLeft, Notes,
	      IPDVisionAssessment.LoginID, IPDVisionAssessment.ClientMachine, IPDVisionAssessment.RecordDateTime
	from IPDVisionAssessment
inner join Admissions on IPDVisionAssessment.AdmissionNo = Admissions.AdmissionNo
	inner join IPDDoctor on IPDDoctor.AdmissionNo = IPDVisionAssessment.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo	
    inner join Patients on Visits.PatientNo = Patients.PatientNo
where VARoundNo = @VARoundNo and EyeTestID = @EyeTestID
Order by IPDVisionAssessment.RecordDateTime desc
return 0
end
else
begin
	select TOP 1 VARoundID, IPDVisionAssessment.AdmissionNo, VARoundNo, 
		IPDDoctor.RoundDateTime as IPDDoctorRoundDateTime, Admissions.VisitNo, Patients.PatientNo, FirstName, LastName, Photo,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, BirthDate, JoinDate, 
		dbo.FormatDate(VisitDate) as VisitDate,	dbo.GetAge(BirthDate, getdate()) as Age, 
		GenderID, dbo.GetLookupDataDes(GenderID) as Gender,VisitCategoryID, 
		dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory,
		dbo.GetTotalIPDDoctorRounds(IPDVisionAssessment.AdmissionNo) as TotalIPDDoctorRounds, 
		VisitStatusID, dbo.GetLookupDataDes(VisitStatusID) as VisitStatus,
        dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor, AdmissionDateTime, 
		AdmissionStatusID, dbo.GetLookupDataDes(AdmissionStatusID) as AdmissionStatus,
      EyeTestID,dbo.GetLookupDataDes(EyeTestID) as EyeTest,IPDVisionAssessment.RoundDateTime as IPDVARoundDateTime,
       VisualAcuityRightID,
	 dbo.GetLookupDataDes(VisualAcuityRightID) as VisualAcuityRight, VisualAcuityRightExtID, 
	 dbo.GetLookupDataDes(VisualAcuityRightExtID) as VisualAcuityRightExt, VisualAcuityLeftID,
	  dbo.GetLookupDataDes(VisualAcuityLeftID) as VisualAcuityLeft, VisualAcuityLeftExtID,
	   dbo.GetLookupDataDes(VisualAcuityLeftExtID) as VisualAcuityLeftExt, PreferentialLookingRightID, 
	    dbo.GetLookupDataDes(PreferentialLookingRightID) as PreferentialLookingRight, 
	    PreferentialLookingLeftID, dbo.GetLookupDataDes(PreferentialLookingLeftID) as PreferentialLookingLeft,
	      Notes, IPDVisionAssessment.LoginID, IPDVisionAssessment.ClientMachine, IPDVisionAssessment.RecordDateTime
	from IPDVisionAssessment
inner join Admissions on IPDVisionAssessment.AdmissionNo = Admissions.AdmissionNo
	inner join IPDDoctor on IPDDoctor.AdmissionNo = IPDVisionAssessment.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo	
    inner join Patients on Visits.PatientNo = Patients.PatientNo
	WHERE IPDVisionAssessment.AdmissionNo = @AdmissionNo
	Order by IPDVisionAssessment.VARoundID desc
return 0
end
go

/******************************************************************************************************
exec uspGetIPDVisionAssessment
******************************************************************************************************/


if exists (select * from sysobjects where name = 'uspGetIPDVisionAssessmentWithAdmissionNo')
	drop proc uspGetIPDVisionAssessmentWithAdmissionNo
go
create proc uspGetIPDVisionAssessmentWithAdmissionNo(
@AdmissionNo varchar(20) = null
)with encryption as

if @AdmissionNo  is not null 
begin
	select TOP 1 VARoundID, IPDVisionAssessment.AdmissionNo, VARoundNo, 
 VisualAcuityRightID,EyeTestID,dbo.GetLookupDataDes(EyeTestID) as EyeTest,dbo.GetHasIPDVisualAssessment(IPDVisionAssessment.AdmissionNo) as HasIPDVisualAssessment,
	 dbo.GetLookupDataDes(VisualAcuityRightID) as VisualAcuityRight, VisualAcuityRightExtID, 
	 dbo.GetLookupDataDes(VisualAcuityRightExtID) as VisualAcuityRightExt, VisualAcuityLeftID,
	  dbo.GetLookupDataDes(VisualAcuityLeftID) as VisualAcuityLeft, VisualAcuityLeftExtID,
	   dbo.GetLookupDataDes(VisualAcuityLeftExtID) as VisualAcuityLeftExt,PreferentialLookingRightID, 
	    dbo.GetLookupDataDes(PreferentialLookingRightID) as PreferentialLookingRight, 
	    PreferentialLookingLeftID, dbo.GetLookupDataDes(PreferentialLookingLeftID) as PreferentialLookingLeft,
	     Notes,IPDVisionAssessment.LoginID, IPDVisionAssessment.ClientMachine, IPDVisionAssessment.RecordDateTime
	from IPDVisionAssessment
     WHERE IPDVisionAssessment.AdmissionNo = @AdmissionNo
	Order by IPDVisionAssessment.VARoundID desc
return 0
end
go

/******************************************************************************************************
exec uspGetIPDVisionAssessmentWithAdmissionNo
******************************************************************************************************/

-- select * from IPDVisionAssessment
-- delete from IPDVisionAssessment

--------GetVARoundNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVARoundNo')
	drop proc uspGetVARoundNo
go

create proc uspGetVARoundNo(
@AdmissionNo varchar(20),
@RoundDateTime smalldatetime = null output,
@VARoundNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)

if (@RoundDateTime is null)
begin
	if not exists(select VARoundNo from IPDVisionAssessment where AdmissionNo = @AdmissionNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'VA Round No', @AdmissionNo, 'IPD Vision Assessment')	
		return 1
	end
	else
	begin
		set @VARoundNo = (select top 1 VARoundNo from IPDVisionAssessment where AdmissionNo = @AdmissionNo
						and RoundDateTime = (select max(RoundDateTime) from IPDVisionAssessment where AdmissionNo = @AdmissionNo)
						order by VARoundID desc)
	end
end
else
if not (@RoundDateTime is null)
begin

if not exists(select VARoundNo from IPDVisionAssessment where AdmissionNo = @AdmissionNo and RoundDateTime = @RoundDateTime)
	begin
		set @ErrorMSG = '%s: %s and %s: ' + dbo.FormatDateTime(@RoundDateTime) + ', you are trying to enter does not exist %s'
		raiserror(@ErrorMSG,16,1, 'The record with VA Round No', @AdmissionNo, 'Round Date Time', 'in the registered IPD Vision Assessment')	
		return 1		
	end
	else
	begin
		set @VARoundNo = (select top 1 VARoundNo from IPDVisionAssessment where AdmissionNo = @AdmissionNo
						and RoundDateTime = @RoundDateTime order by VARoundID desc)
	end
end

return 0

go


--------Get Next VARoundID -----------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetNextVARoundID')
	drop proc uspGetNextVARoundID
go
create proc uspGetNextVARoundID(
@AdmissionNo varchar(20),
@VARoundID int = null output
)with encryption as
set @VARoundID = (select max(VARoundID) from IPDVisionAssessment where AdmissionNo = @AdmissionNo)
set @VARoundID = dbo.GetNextAutoNumber('IPDVisionAssessment', 'VARoundNo', @VARoundID)
return 0

go



-------------- Get ReceiveINTBillables -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetReceiveINTBillables')
	drop proc uspGetReceiveINTBillables
go

create proc uspGetReceiveINTBillables(
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ReceiveIntegrationEntry varchar(10)
set @ReceiveIntegrationEntry = dbo.GetLookupDataID('IntegrationEntry','02')

begin
	select ItemCode, ItemName, ItemCategoryID,dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, UnitCost, 
	UnitPrice, AgentNo, SyncStatus, ClientMachine, RecordDateTime
	from INTBillables IE WHERE NOT EXISTS( Select DrugNo from Drugs DRs where IE.ItemCode = DRs.DrugNo)
	and IE.ItemCategoryID = @ItemCategoryID and SyncStatus = 0 and IntegrationEntryID = @ReceiveIntegrationEntry
return 0
end
go

--- exec uspGetReceiveINTBillables '7D'

-------------- Get ReceiveINTBillableItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetReceiveINTBillableItems')
	drop proc uspGetReceiveINTBillableItems
go

create proc uspGetReceiveINTBillableItems(
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ReceiveIntegrationEntry varchar(10)
set @ReceiveIntegrationEntry = dbo.GetLookupDataID('IntegrationEntry','02')

begin
	select ItemCode, ItemName, ItemCategoryID,dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, UnitCost,UnitPrice, AgentNo, 
	SyncStatus, ClientMachine, RecordDateTime
	from INTBillables IE WHERE NOT EXISTS( Select DrugNo from Drugs DRs where IE.ItemCode = DRs.DrugNo)
	and IE.ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode and IntegrationEntryID = @ReceiveIntegrationEntry
return 0
end
go

/******************************************************************************************************
exec uspGetReceiveINTBillableItems '10C02', '7D'
******************************************************************************************************/
-- select * from INTBillables
-- delete from INTBillables

if exists (select * from sysobjects where name = 'uspGetToCountToUnsavedINTDrugBillables')
	drop proc uspGetToCountToUnsavedINTDrugBillables
go

create proc uspGetToCountToUnsavedINTDrugBillables(
 @Records int = null output
)
with encryption as 


------------------------------------------------------------------------------------------------------------
declare @ErrorMSG varchar(200)
declare @DrugItemCategoryID varchar(10)
declare @ReceiveIntegrationEntry varchar(10)
set @ReceiveIntegrationEntry = dbo.GetLookupDataID('IntegrationEntry','02')
------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------
set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
------------------------------------------------------------------------------------------------------------
begin

set @Records = (select count(ItemCode) as IncompleteItems from INTBillables IE 
WHERE IntegrationEntryID = @ReceiveIntegrationEntry and NOT EXISTS( Select DrugNo from Drugs DRs where IE.ItemCode = DRs.DrugNo) and  SyncStatus = 0 and ItemCategoryID = @DrugItemCategoryID)

set @Records = isnull(@Records, 0)
  end
	
return 0
go
------------------------------------------------------------------------------------------------------
-------------- DrugCategories ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert DrugCategories -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertDrugCategories')
	drop proc uspInsertDrugCategories
go

create proc uspInsertDrugCategories(
@CategoryNo varchar(10),
@CategoryName varchar(40),
@VaryPrescribedQty bit,
@DefaultPrescribedQty smallint,
@DosageSeparator char(1),
@DosageCalculationID varchar(10),
@DosageFormat varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select CategoryNo from DrugCategories where CategoryNo = @CategoryNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Category No', @CategoryNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DosageCalculationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Dosage Calculation ID', @DosageCalculationID, 'Lookup Data')
		return 1
	end

begin
insert into DrugCategories
(CategoryNo, CategoryName, VaryPrescribedQty, DefaultPrescribedQty, DosageSeparator, DosageCalculationID, DosageFormat)
values
(@CategoryNo, @CategoryName, @VaryPrescribedQty, @DefaultPrescribedQty, @DosageSeparator, @DosageCalculationID, @DosageFormat)
return 0
end
go

/******************************************************************************************************
exec uspInsertDrugCategories 'C001', 'Anti-malarials', '4OI', 0, 1, ';', '31A', ''
exec uspInsertDrugCategories 'C002', 'Anti-TB', '4OI', 0, 1, ';', '31A', ''

******************************************************************************************************/
-- select * from DrugCategories
-- delete from DrugCategories

-------------- Update DrugCategories -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateDrugCategories')
	drop proc uspUpdateDrugCategories
go

create proc uspUpdateDrugCategories(
@CategoryNo varchar(10),
@CategoryName varchar(40),
@VaryPrescribedQty bit,
@DefaultPrescribedQty smallint,
@DosageSeparator char(1),
@DosageCalculationID varchar(10),
@DosageFormat varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select CategoryNo from DrugCategories where CategoryNo = @CategoryNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Category No', @CategoryNo, 'DrugCategories')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DosageCalculationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Dosage Calculation ID', @DosageCalculationID, 'Lookup Data')
		return 1
	end

begin
update DrugCategories set
	CategoryName = @CategoryName, VaryPrescribedQty = @VaryPrescribedQty, 
	DefaultPrescribedQty = @DefaultPrescribedQty, DosageSeparator = @DosageSeparator, 
	DosageCalculationID = @DosageCalculationID, DosageFormat = @DosageFormat
where CategoryNo = @CategoryNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateDrugCategories 'C002', 'Anti-TBs', '4OTHER', 1, 0, ':', '31M', 'N:N:N:N'

******************************************************************************************************/
-- select * from DrugCategories
-- delete from DrugCategories

-------------- GetDrugCategories -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDrugCategories')
	drop proc uspGetDrugCategories
go

create proc uspGetDrugCategories(
@CategoryNo varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@CategoryNo is null)
begin
	if not exists(select CategoryNo from DrugCategories where CategoryNo = @CategoryNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Category No', @CategoryNo, 'DrugCategories')
			return 1
		end
	else
	begin
		select CategoryNo, CategoryName, dbo.GetMergedNameCode(CategoryName, CategoryNo) as CategoryFullName, 
		VaryPrescribedQty, DefaultPrescribedQty, DosageSeparator, DosageCalculationID, 
		dbo.GetLookupDataDes(DosageCalculationID) as DosageCalculation, DosageFormat
		from DrugCategories
		where CategoryNo = @CategoryNo
	end
end
else
if  (@CategoryNo is null)
begin
		select CategoryNo, CategoryName, dbo.GetMergedNameCode(CategoryName, CategoryNo) as CategoryFullName, 
		VaryPrescribedQty, DefaultPrescribedQty, DosageSeparator, DosageCalculationID, 
		dbo.GetLookupDataDes(DosageCalculationID) as DosageCalculation, DosageFormat
		from DrugCategories
end

return 0

go

/******************************************************************************************************
exec uspGetDrugCategories
exec uspGetDrugCategories '4DRO'
******************************************************************************************************/
-- select * from DrugCategories
-- delete from DrugCategories

------------------------------------------------------------------------------------------------------
------------- Drugs ----------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert drugs---------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertDrugs')
	drop proc uspInsertDrugs
go

create proc uspInsertDrugs(
@DrugNo varchar(20),
@DrugName varchar(100),
@AlternateName varchar(100),
@CategoryNo varchar(10),
@GroupsID varchar(10),
@UnitMeasureID varchar(10),
@OrderLevel int,
@KeepingUnit int,
@UnitCost money,
@VATPercentage decimal,
@UnitPrice money,
@LastUpdate smalldatetime,
@Halted bit = 0,
@Hidden bit = null
)with encryption as 

declare @ErrorMSG varchar(200)

declare @DrugID int
declare @DrugNoPrefix varchar(1)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedDrugID int
declare @PassedDrugNo varchar(20)
declare @NAVAgentNo varchar(20)
declare @DrugItemCategoryID varchar(10)

set @NAVAgentNo = 'NAV'
set @DrugItemCategoryID = '7D'

if exists(select DrugNo from Drugs where DrugNo = @DrugNo)
	begin
		set @ErrorMSG = 'The Drug No: ' + @DrugNo + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not (@AlternateName is null or @AlternateName = '') 
	begin
		if exists(select AlternateName from Drugs where AlternateName = @AlternateName)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter already exists'
				raiserror(@ErrorMSG, 16, 1, 'Drug Alternate Name', @AlternateName)	
				return 1
			end
	end

if not exists(select CategoryNo from DrugCategories where CategoryNo  = @CategoryNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Category No', @CategoryNo, 'Drug Categories')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GroupsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Drug Group ID', @GroupsID, 'Lookup Data')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @UnitMeasureID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Unit Measure ID', @UnitMeasureID, 'Lookup Data')	
		return 1
	end
else

------------------------------------------------------------------------------------------------------------------
begin

--select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
--		where ObjectName = 'Drugs' and AutoColumnName = 'DrugNo'

--select @PaddingLEN = PaddingLEN from AutoNumbers 
--		where ObjectName = 'Drugs' and AutoColumnName = 'DrugNo'

--set @DrugNoPrefix = dbo.GetOptionValue('DrugNoPrefix')

--if (@AutoColumnLEN = len(@DrugNo)) and (left(@DrugNo, len(@DrugNoPrefix)) = @DrugNoPrefix)

--begin

--	set @PassedDrugID = 1
--	set @PassedDrugNo = @DrugNo
--	set @PassedDrugNo = ltrim(rtrim(substring(@PassedDrugNo, len(@DrugNoPrefix) + 1, @PaddingLEN)))

--	if isnumeric(@PassedDrugNo) = 1 set @PassedDrugID = @PassedDrugNo
--	else set @PassedDrugID = 1

--	set @DrugID = (select max(DrugID) from Drugs where left(DrugNo, len(@DrugNoPrefix)) = @DrugNoPrefix)
--	set @DrugID = dbo.GetNextAutoNumber('Drugs', 'DrugNo', @DrugID)

--	if @PassedDrugID < @DrugID set @DrugID = @PassedDrugID
--	if @PassedDrugID > @DrugID set @DrugID = @PassedDrugID

--end else set @DrugID = 1

	set @DrugNoPrefix = dbo.GetOptionValue('DrugNoPrefix')
	set @DrugID = (select max(DrugID) from Drugs where left(DrugNo, len(@DrugNoPrefix)) = @DrugNoPrefix)
	set @DrugID = dbo.GetNextAutoNumber('Drugs', 'DrugNo', @DrugID)


---------------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
---------------------------------------------------------------------------------------------------

insert into Drugs
(DrugID, DrugNo, DrugName, AlternateName, CategoryNo,GroupsID, UnitMeasureID, 
OrderLevel, KeepingUnit, UnitCost,VATPercentage, UnitPrice, LastUpdate, Halted, Hidden) 
values
(@DrugID, @DrugNo, @DrugName, @AlternateName, @CategoryNo,@GroupsID, @UnitMeasureID, 
@OrderLevel, @KeepingUnit, @UnitCost,@VATPercentage, @UnitPrice, @LastUpdate, @Halted, @Hidden)

-----Caters for Drug Integration 

if (dbo.GetOptionValue('EnableIntegrationN001') > 0)
begin

 update INTBillables set SyncStatus = 1 where ItemCode = @DrugNo and ItemCategoryID = @DrugItemCategoryID and AgentNo = @NAVAgentNo
end

return 0
end
go

/***********************************************************************************************************
--1---------------------------------------------------------------------------------------------------------

exec uspInsertDrugs 'D001', 'NEVIMUNE ORAL SOLUTION', '4ARVG', '8NA', 0, 0, 1, 1.68, '08 May 2010', 1

************************************************************************************************************/

-- select *  from Drugs
-- delete from Drugs

---------Update drugs-------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateDrugs')
	drop proc uspUpdateDrugs
go

create proc uspUpdateDrugs(
@DrugNo varchar(20),
@DrugName varchar(100),
@AlternateName varchar(100),
@CategoryNo varchar(10),
@GroupsID varchar(10),
@UnitMeasureID varchar(10),
@OrderLevel int,
@KeepingUnit int,
@UnitCost money,
@VATPercentage decimal,
@UnitPrice money,
@LastUpdate smalldatetime,
@Halted bit = 0,
@Hidden bit = null
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select DrugNo from Drugs where DrugNo = @DrugNo)
	begin
		set @ErrorMSG = 'The Drug No: %s, you''re trying to update does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, @DrugNo, 'Drugs')	
		return 1
	end

if not (@AlternateName is null or @AlternateName = '') 
	begin
		if exists(select AlternateName from Drugs where AlternateName = @AlternateName and not DrugNo = @DrugNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to update to, already exists'
				raiserror(@ErrorMSG, 16, 1, 'Drug Alternate Name', @AlternateName)	
				return 1
			end
	end

if not exists(select CategoryNo from DrugCategories where CategoryNo  = @CategoryNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Category No', @CategoryNo, 'Drug Categories')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GroupsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Drug Group ID', @GroupsID, 'Lookup Data')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @UnitMeasureID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Unit Measure ID', @UnitMeasureID, 'Lookup Data')	
		return 1
	end

else

begin

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

update Drugs set 
DrugName = @DrugName, AlternateName = @AlternateName, CategoryNo = @CategoryNo,GroupsID=@GroupsID, 
UnitMeasureID = @UnitMeasureID, OrderLevel = @OrderLevel, KeepingUnit = @KeepingUnit, 
UnitCost = @UnitCost ,VATPercentage=@VATPercentage,UnitPrice = @UnitPrice, LastUpdate = @LastUpdate, 
Halted = @Halted, Hidden = @Hidden
where DrugNo = @DrugNo
return 0
end
go

/******************************************************************************************
--1----------------------------------------------------------------------------------------
exec uspUpdateDrugs 'D001', 'NEVIMUNE ORAL SOLUTION', '4ARVG', '8NA', 0, 0, 1.2, 1.68, '08 May 2010', 0

******************************************************************************************/

-- select *  from Drugs
-- delete from Drugs

--------GetDrugs-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDrugs')
	drop proc uspGetDrugs
go

create proc uspGetDrugs(
@DrugNo varchar(20) = null output,
@ARVsOnly bit = 0,
@Hidden bit = null
)with encryption as

declare @ErrorMSG varchar(200)

declare @ARVBRANDID varchar(10)
declare @ARVGENERICID varchar(10)

set @ARVBRANDID = dbo.GetLookupDataID('Groups', 'ARVB')
set @ARVGENERICID = dbo.GetLookupDataID('Groups', 'ARVG')

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

if (@ARVsOnly = 0) and (not (@DrugNo is null))
begin
	if not exists(select DrugNo from Drugs where DrugNo = @DrugNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Drug No', @DrugNo, 'Drugs')	
		return 1
	end
	begin
		select DrugNo, DrugName, Drugs.CategoryNo, CategoryName, OrderLevel ,KeepingUnit , 
		dbo.FormatMoney(UnitCost) as UnitCost,VATPercentage, dbo.FormatMoney(UnitPrice) as UnitPrice, 
		UnitsInStock, LastUpdate, Drugs.GroupsID, dbo.GetLookupDataDes(Drugs.GroupsID) as [Group], 
		Hidden, UnitMeasureID, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure, 
		AlternateName, dbo.GetMergedNameCode(DrugName, DrugNo) as DrugFullName, 
		BatchNo, dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)) as ExpiryDate,
		Halted, dbo.GetHasAlternateDrugs(DrugNo) as HasAlternateDrugs,
		VaryPrescribedQty, DefaultPrescribedQty, DosageSeparator, DosageCalculationID, 
		dbo.GetLookupDataDes(DosageCalculationID) as DosageCalculation, DosageFormat
		from Drugs 
		inner join DrugCategories on Drugs.CategoryNo = DrugCategories.CategoryNo
		where DrugNo = @DrugNo
	end
end
else
if (@ARVsOnly = 0) and (@DrugNo is null)

begin
	select DrugNo, DrugName, Drugs.CategoryNo, CategoryName, OrderLevel ,KeepingUnit, 
	dbo.FormatMoney(UnitCost) as UnitCost, dbo.FormatMoney(UnitPrice) as UnitPrice,
	UnitsInStock, LastUpdate, Hidden, Drugs.GroupsID, dbo.GetLookupDataDes(Drugs.GroupsID) as [Group], 
	UnitMeasureID, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure, AlternateName,
	dbo.GetMergedNameCode(DrugName, DrugNo) as DrugFullName, Halted,
	BatchNo, dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)) as ExpiryDate,
	VaryPrescribedQty, DefaultPrescribedQty, DosageSeparator, DosageCalculationID, 
	dbo.GetLookupDataDes(DosageCalculationID) as DosageCalculation, DosageFormat
	from Drugs 
	inner join DrugCategories on Drugs.CategoryNo = DrugCategories.CategoryNo
	where Hidden = @Hidden
	order by DrugName
end
else
if (@ARVsOnly = 1) and (@DrugNo is null)
	begin
		select DrugNo, DrugName, Drugs.CategoryNo, CategoryName, OrderLevel ,KeepingUnit , 
		dbo.FormatMoney(UnitCost) as UnitCost, dbo.FormatMoney(UnitPrice) as UnitPrice ,
		UnitsInStock, LastUpdate, Hidden, Drugs.GroupsID, dbo.GetLookupDataDes(Drugs.GroupsID) as [Group], 
		UnitMeasureID, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure, AlternateName,
		dbo.GetMergedNameCode(DrugName, DrugNo) as DrugFullName, Halted, 
		BatchNo, dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)) as ExpiryDate,
		VaryPrescribedQty, DefaultPrescribedQty, DosageSeparator, DosageCalculationID, 
		dbo.GetLookupDataDes(DosageCalculationID) as DosageCalculation, DosageFormat
		from Drugs 
		inner join DrugCategories on Drugs.CategoryNo = DrugCategories.CategoryNo
		where Hidden = @Hidden and Drugs.GroupsID in (@ARVBRANDID, @ARVGENERICID)
		order by DrugName
	end

return 0

go

-- select * from Drugs
-- exec uspGetDrugs 'D001'
-- exec uspGetDrugs 'D001', 0
-- exec uspGetDrugs null, 0
-- exec uspGetDrugs null, 1

-------- GetNextDrugID --------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextDrugID')
	drop proc uspGetNextDrugID
go

create proc uspGetNextDrugID(
@DrugID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @DrugNoPrefix varchar(1)

set @DrugNoPrefix = dbo.GetOptionValue('DrugNoPrefix')

set @DrugID = (select max(DrugID) from Drugs where left(DrugNo, len(@DrugNoPrefix)) = @DrugNoPrefix)
set @DrugID = dbo.GetNextAutoNumber('Drugs', 'DrugNo', @DrugID)

return 0
go

-- exec uspGetNextDrugID
-- select * from Drugs where DrugNo like 'M%'

--------GetToOrderDrugs-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetToOrderDrugs')
	drop proc uspGetToOrderDrugs
go

create proc uspGetToOrderDrugs(
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

begin
	select DrugNo as ItemCode, DrugName as ItemName, OrderLevel, KeepingUnit, 
	dbo.GetMergedNameCode(DrugName, DrugNo) as ItemFullName, 	
	dbo.FormatMoney(UnitCost) as UnitCost, dbo.FormatMoney(UnitPrice) as UnitPrice, 
	BatchNo, isnull(dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)), '') as ExpiryDate, 
	dbo.GetExpiryRemainingDays(getdate(), ExpiryDate) as ExpiryRemainingDays, 
	UnitsInStock, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure
	from Drugs 
	where Hidden = @Hidden and OrderLevel >= UnitsInStock
	order by DrugName
end

return 0

go

-- select * from Drugs
-- exec uspGetToOrderDrugs null
-- exec uspGetToOrderDrugs 0

--------CountToOrderDrugs-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountToOrderDrugs')
	drop proc uspCountToOrderDrugs
go

create proc uspCountToOrderDrugs(
@Hidden bit = 0,
@Records int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @DrugCategoryID varchar(10)

---------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
---------------------------------------------------------------------------------------------

begin
	set @DrugCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
	set @Records = (select Count(DrugNo) from Drugs where Hidden = @Hidden 
					and OrderLevel >= dbo.GetInventoryBalance(null, @DrugCategoryID, DrugNo))
	set @Records = isnull(@Records, 0)
end

return 0

go

-- select * from Drugs
-- exec uspCountToOrderDrugs null
-- exec uspCountToOrderDrugs 0

--------GetToExpireDrugs-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetToExpireDrugs')
	drop proc uspGetToExpireDrugs
go

create proc uspGetToExpireDrugs(
@ExpiryWarningDays int,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

begin
	select DrugNo as ItemCode, DrugName as ItemName, OrderLevel, KeepingUnit, 
	dbo.GetMergedNameCode(DrugName, DrugNo) as ItemFullName, 
	dbo.FormatMoney(UnitCost) as UnitCost, dbo.FormatMoney(UnitPrice) as UnitPrice , 
	BatchNo, isnull(dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)), '') as ExpiryDate,
	dbo.GetExpiryRemainingDays(getdate(), ExpiryDate) as ExpiryRemainingDays,
	UnitsInStock, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure
	from Drugs 
	where Hidden = @Hidden and UnitsInStock > 0 and not dbo.GetNullDateValue(ExpiryDate) is null
	and (dbo.GetExpiryRemainingDays(getdate(), ExpiryDate) <= @ExpiryWarningDays)
	order by DrugName
end

return 0

go

-- select * from Drugs
-- exec uspGetToExpireDrugs 60, null
-- exec uspGetToExpireDrugs 60, 0

--------CountToExpireDrugs-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountToExpireDrugs')
	drop proc uspCountToExpireDrugs
go

create proc uspCountToExpireDrugs(
@ExpiryWarningDays int,
@Hidden bit = 0,
@Records int = null output
)with encryption as

declare @ErrorMSG varchar(200)

---------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
---------------------------------------------------------------------------------------------

begin
	set @Records = (select Count(DrugNo) from Drugs 
	where Hidden = @Hidden and UnitsInStock > 0 and not dbo.GetNullDateValue(ExpiryDate) is null
	and (dbo.GetExpiryRemainingDays(getdate(), ExpiryDate) <= @ExpiryWarningDays))	
	set @Records = isnull(@Records, 0)
	
end

return 0

go

-- select * from Drugs
-- exec uspCountToExpireDrugs 60, null
-- exec uspCountToExpireDrugs 60, 0

--------GetDrugStockCard-------------------------------------------------------------------------------------------
--------GetDrugStockCard-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDrugStockCard')
	drop proc uspGetDrugStockCard
go

create proc uspGetDrugStockCard(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime,
@DrugNo varchar(20),
@LocationID varchar(10) = null,
@LoginID varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@LocationID is null) and (@LoginID is null))
	begin
		select dbo.FormatDate(RecordDate) as RecordDate, RecordTime,dbo.FormatDate(TranDate) as TranDate,Location, StockType, 
		Quantity, LocationUnits, Balance, Details, LoginID 
		from DrugInventory
		where (RecordDateTime between @StartDateTime and @EndDateTime) and ItemCode = @DrugNo and LocationID = @LocationID 
		order by RecordDateTime
	end
else if (not (@LocationID is null) and not (@LoginID is null))
		begin
			select dbo.FormatDate(RecordDate) as RecordDate, RecordTime,dbo.FormatDate(TranDate) as TranDate,Location, StockType, 
			Quantity, LocationUnits, Balance, Details, LoginID 
			from DrugInventory
			where (RecordDateTime between @StartDateTime and @EndDateTime) and ItemCode = @DrugNo and LocationID = @LocationID  and LoginID = @LoginID 
			order by RecordDateTime
		end
else if ((@LocationID is null) and not (@LoginID is null))
		begin
			select dbo.FormatDate(RecordDate) as RecordDate, RecordTime,dbo.FormatDate(TranDate) as TranDate,Location, StockType, 
			Quantity, LocationUnits, Balance, Details, LoginID 
			from DrugInventory
			where (RecordDateTime between @StartDateTime and @EndDateTime) and ItemCode = @DrugNo and LoginID = @LoginID 
			order by RecordDateTime
		end	
else if ((@LocationID is null) and (@LoginID is null))
		begin
			select dbo.FormatDate(RecordDate) as RecordDate, RecordTime,dbo.FormatDate(TranDate) as TranDate,Location, StockType, 
			Quantity, LocationUnits, Balance, Details, LoginID 
			from DrugInventory
			where RecordDateTime between @StartDateTime and @EndDateTime and ItemCode = @DrugNo
			order by RecordDateTime
		end

return 0

go

-- select * from DrugInventory
-- exec uspGetDrugStockCard '1 Oct 2014', '20 Oct 2014', 'M414'
-- exec uspGetDrugStockCard '1 Oct 2014', '20 Oct 2014', 'M414', '11702'

-------------- To Count To UnsavedInventory EXT -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCountUnsavedInventoryEXT')
	drop proc uspGetCountUnsavedInventoryEXT
go

create proc uspGetCountUnsavedInventoryEXT(
@ItemCategoryID varchar(20),
@Records int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @Unsaveddrugs int
declare @remaining int
declare @bal int
---------------------------------------------------------------------------------------------

  begin

set @Unsaveddrugs =(select Count(ItemCode) As Unsaved from InventoryEXT
INNER JOIN Drugs on Drugs.DrugNo = InventoryEXT.ItemCode)
set @remaining =(select Count(ItemCode) As Unsaved from InventoryEXT)
set @Records = @remaining- @Unsaveddrugs
					
set @Records = isnull(@Records, 0)	

end
return 0
go


-----exec uspGetCountUnsavedInventoryEXT '7D',null


--------GetDrugPeriodicInventory-------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetDrugPeriodicInventory')
	drop proc uspGetDrugPeriodicInventory 
go

create proc uspGetDrugPeriodicInventory(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime,
@LocationID varchar(10) = null,
@DrugNo varchar(20) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
declare @DrugCategoryID varchar(10)

-------------------------------------------------------------------------------
set @DrugCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------

if not (@DrugNo is null)
	begin
		select DrugNo, DrugName, OrderLevel, KeepingUnit, dbo.FormatMoney(UnitCost) as UnitCost, 
		dbo.FormatMoney(UnitPrice) as UnitPrice ,UnitsInStock,
		isnull(dbo.GetLocationUnits(@LocationID, @DrugCategoryID, DrugNo) ,UnitsInStock) as UnitsAtHand,
		dbo.FormatMoney(UnitCost*UnitsInStock) as StockCostValue,
		dbo.FormatMoney(UnitPrice*UnitsInStock) as StockSellingValue,
		dbo.FormatMoney((UnitPrice*UnitsInStock)*(VATPercentage/100)) as VATValue,
		dbo.GetInventoryStartBalance(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime) as StartBalance,
		dbo.FormatMoney(UnitCost*(dbo.GetInventoryStartBalance(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime))) as openingStockCostValue,
		dbo.FormatMoney(UnitPrice*(dbo.GetInventoryStartBalance(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime))) as openingStockUnitValue,
		dbo.FormatMoney(UnitCost*(dbo.GetInventoryEndBalance(@LocationID, @DrugCategoryID, DrugNo, @EndDateTime))) as EndBalanceStockCostValue,
		dbo.FormatMoney(UnitPrice*(dbo.GetInventoryEndBalance(@LocationID, @DrugCategoryID, DrugNo, @EndDateTime))) as EndBalanceStockUnitValue,
		dbo.GetInventoryEndBalance(@LocationID, @DrugCategoryID, DrugNo, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.GetInventoryTotalIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime) as TotalIssued,
        dbo.GetInventoryTotalSystemIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime) as TotalSystemIssued,
		(dbo.GetInventoryTotalSystemIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime)*UnitCost) as ExpectedSystemIssuedAmount,

        dbo.GetInventoryTotalManualIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime) as TotalManualIssued,
		dbo.GetInventoryTotalManualIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime)*UnitCost as TotalManualIssuedCostValue,
		UnitPrice * dbo.GetInventoryTotalIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime) as ExpectedIssuedAmount,
        dbo.FormatMoney(dbo.GetInventoryTotalReceived(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime)*UnitCost) as TotalReceivedCostValue,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime)*UnitCost) as TotalIssuedCostValue
		--,dbo.GetActualIssuedAmount(@LocationID, DrugNo, @StartDateTime, @EndDateTime) as ActualIssuedAmount,
		--dbo.GetPaidIssuedAmount(@LocationID, DrugNo, @StartDateTime, @EndDateTime) as PaidIssuedAmount
		from Drugs 
		where DrugNo = @DrugNo order by DrugName
	end
else 
	begin
		select DrugNo, DrugName, OrderLevel, KeepingUnit, dbo.FormatMoney(UnitCost) as UnitCost, 
		dbo.FormatMoney(UnitPrice) as UnitPrice ,UnitsInStock,
		isnull(dbo.GetLocationUnits(@LocationID, @DrugCategoryID, DrugNo) ,UnitsInStock) as UnitsAtHand,
		dbo.FormatMoney(UnitCost*UnitsInStock) as StockCostValue,
		dbo.FormatMoney(UnitPrice*UnitsInStock) as StockSellingValue,
		dbo.FormatMoney((UnitPrice*UnitsInStock)*(VATPercentage/100)) as VATValue, 
		dbo.GetInventoryStartBalance(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime) as StartBalance,
		dbo.GetInventoryEndBalance(@LocationID, @DrugCategoryID, DrugNo, @EndDateTime) as EndBalance,
		dbo.FormatMoney(UnitCost*(dbo.GetInventoryStartBalance(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime))) as openingStockCostValue,
		dbo.FormatMoney(UnitPrice*(dbo.GetInventoryStartBalance(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime))) as openingStockUnitValue,
		dbo.FormatMoney(UnitCost*(dbo.GetInventoryEndBalance(@LocationID, @DrugCategoryID, DrugNo, @EndDateTime))) as EndBalanceStockCostValue,
		dbo.FormatMoney(UnitPrice*(dbo.GetInventoryEndBalance(@LocationID, @DrugCategoryID, DrugNo, @EndDateTime))) as EndBalanceStockUnitValue,
		dbo.GetInventoryTotalReceived(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.GetInventoryTotalIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.GetInventoryTotalSystemIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime) as TotalSystemIssued,
		(dbo.GetInventoryTotalSystemIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime)*UnitCost) as ExpectedIssuedAmount,

		dbo.GetInventoryTotalManualIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime) as TotalManualIssued,
		UnitPrice * dbo.GetInventoryTotalIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime) as ExpectedIssuedAmount,
		dbo.GetInventoryTotalManualIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime)*UnitCost as TotalManualIssuedCostValue,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime)*UnitCost) as TotalReceivedCostValue,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(@LocationID, @DrugCategoryID, DrugNo, @StartDateTime, @EndDateTime)*UnitCost) as TotalIssuedCostValue
		--,dbo.GetActualIssuedAmount(@LocationID, DrugNo, @StartDateTime, @EndDateTime) as ActualIssuedAmount,
		--dbo.GetPaidIssuedAmount(@LocationID, DrugNo, @StartDateTime, @EndDateTime) as PaidIssuedAmount
		from Drugs where Hidden = @Hidden order by DrugName
	end

return 0 

go
/******************************************************************************************************
-- select * from Drugs
-- exec uspGetDrugPeriodicInventory '1 Oct 2012', '19 Oct 2012'
-- exec uspGetDrugPeriodicInventory '1 Oct 2012', '19 Oct 2012', 'M506'
******************************************************************************************************/
------------------------------------------------------------------------------------------------------
-------------- AlternateDrugs ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit AlternateDrugs -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditAlternateDrugs')
	drop proc uspEditAlternateDrugs
go

create proc uspEditAlternateDrugs(
@DrugNo varchar(20),
@AlternateDrugNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DrugNo from Drugs where DrugNo = @DrugNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Drug No', @DrugNo, 'Drugs')
		return 1
	end

if not exists(select DrugNo from Drugs where DrugNo = @AlternateDrugNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Alternate Drug No', @AlternateDrugNo, 'Drugs')
		return 1
	end

if (@DrugNo = @AlternateDrugNo) 
	begin
		set @ErrorMSG = 'Both Drug No: %s and Alternate Drug No: %s can''t be the same'
		raiserror(@ErrorMSG, 16, 1, @DrugNo, @AlternateDrugNo)	
		return 1
	end

if exists(select DrugNo from AlternateDrugs where DrugNo = @DrugNo and AlternateDrugNo = @AlternateDrugNo)
	begin return 0 end
else
begin
insert into AlternateDrugs
(DrugNo, AlternateDrugNo)
values
(@DrugNo, @AlternateDrugNo)
return 0
end
go

/******************************************************************************************************
exec uspEditAlternateDrugs 'A001', 'A002'
exec uspEditAlternateDrugs 'A001', 'A003'

exec uspEditAlternateDrugs 'A005', 'A006'

******************************************************************************************************/
-- select * from AlternateDrugs
-- delete from AlternateDrugs

-------------- Get AlternateDrugs -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAlternateDrugs')
	drop proc uspGetAlternateDrugs
go

create proc uspGetAlternateDrugs(
@DrugNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin

select AlternateDrugs.DrugNo, AlternateDrugNo, DrugName as AlternateDrugName,
dbo.GetAvailableStock(AlternateDrugNo, getdate()) as AvailableStock 
from AlternateDrugs
inner join Drugs on AlternateDrugs.AlternateDrugNo = Drugs.DrugNo
where AlternateDrugs.DrugNo = @DrugNo

return 0

end
go

/******************************************************************************************************
exec uspGetAlternateDrugs 'M1115'
******************************************************************************************************/
-- select * from AlternateDrugs
-- delete from AlternateDrugs

-------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAllPendingOrderDetails')
	drop proc uspGetAllPendingOrderDetails
go

create proc uspGetAllPendingOrderDetails(
@FromLocationID varchar(20),
@Records int = null output
)with encryption as

---------------------------------------------------------------------------------------------

declare @unconfirmedOrders int
declare @ItemStatusProcessing varchar(10)
set @ItemStatusProcessing = dbo.GetLookupDataID('ItemStatus', 'R')

if not (@FromLocationID is null)
begin
set @Records =(select count(InventoryOrders.OrderNo) as Unconfirmed from InventoryOrderDetails
inner join InventoryOrders on InventoryOrderDetails.OrderNo = InventoryOrders.OrderNo
where ItemStatusID =@ItemStatusProcessing and  FromLocationID =@FromLocationID
and OrderDate between OrderDate and dbo.GetShortDate(dateadd(day, -2, getdate())))
end

else 
if (@FromLocationID is null)
begin	
set @Records =(select count(InventoryOrders.OrderNo) as Unconfirmed from InventoryOrderDetails
inner join InventoryOrders on InventoryOrderDetails.OrderNo =InventoryOrders.OrderNo
where ItemStatusID =@ItemStatusProcessing
and OrderDate between OrderDate and dbo.GetShortDate(dateadd(day, -2, getdate())))
end
					
set @Records = isnull(@Records, 0)	


return 0
go
-----------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
------------- ConsumableItems ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert ConsumableItems-----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertConsumableItems')
	drop proc uspInsertConsumableItems
go

create proc uspInsertConsumableItems(
@ConsumableNo varchar(20),
@ConsumableName varchar(100),
@AlternateName varchar(100),
@UnitMeasureID varchar(10),
@OrderLevel int,
@KeepingUnit int,
@UnitCost money,
@VATPercentage decimal,
@UnitPrice money,
@LastUpdate smalldatetime,
@Halted bit = 0,
@Hidden bit = 0,
@ConsumableCategoryID varchar(10) --=null
)with encryption as 

declare @ErrorMSG varchar(200)

declare @ConsumableID int
declare @ConsumableNoPrefix varchar(1)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedConsumableID int
declare @PassedConsumableNo varchar(20)
declare @NAConsumableCategoryID varchar(10)

set @NAConsumableCategoryID = dbo.GetLookupDataID('ConsumableCategoryID', 'NA')

if exists(select ConsumableNo from ConsumableItems where ConsumableNo = @ConsumableNo)
	begin
		set @ErrorMSG = 'The Consumable No: ' + @ConsumableNo + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not (@AlternateName is null or @AlternateName = '') 
	begin
		if exists(select AlternateName from ConsumableItems where AlternateName = @AlternateName)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter already exists'
				raiserror(@ErrorMSG, 16, 1, 'Consumable Alternate Name', @AlternateName)	
				return 1
			end
	end

--------------------------------------------------------------------------------------------------------------------------
	if dbo.GetOptionValue('EnableClinicMasterFinanceItengration')<=0
begin
	if not (@ConsumableCategoryID is null or @ConsumableCategoryID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @ConsumableCategoryID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Consumable CategoryID', @ConsumableCategoryID, 'Lookup Data')
				return 1
			end
	end
else if (@ConsumableCategoryID is null or @ConsumableCategoryID = '') begin set @ConsumableCategoryID = @NAConsumableCategoryID end
end
--------------------------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @UnitMeasureID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Unit Measure ID', @UnitMeasureID, 'Lookup Data')	
		return 1
	end
else

----------------------------------------------------------------------------------------------------------------------------
begin

--select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
--		where ObjectName = 'ConsumableItems' and AutoColumnName = 'ConsumableNo'

--select @PaddingLEN = PaddingLEN from AutoNumbers 
--		where ObjectName = 'ConsumableItems' and AutoColumnName = 'ConsumableNo'

--set @ConsumableNoPrefix = dbo.GetOptionValue('ConsumableNoPrefix')

--if (@AutoColumnLEN = len(@ConsumableNo)) and (left(@ConsumableNo, len(@ConsumableNoPrefix)) = @ConsumableNoPrefix)

--begin

--	set @PassedConsumableID = 1
--	set @PassedConsumableNo = @ConsumableNo
--	set @PassedConsumableNo = ltrim(rtrim(substring(@PassedConsumableNo, len(@ConsumableNoPrefix) + 1, @PaddingLEN)))

--	if isnumeric(@PassedConsumableNo) = 1 set @PassedConsumableID = @PassedConsumableNo
--	else set @PassedConsumableID = 1

--	set @ConsumableID = (select max(ConsumableID) from ConsumableItems where left(ConsumableNo, len(@ConsumableNoPrefix)) = @ConsumableNoPrefix)
--	set @ConsumableID = dbo.GetNextAutoNumber('ConsumableItems', 'ConsumableNo', @ConsumableID)

--	if @PassedConsumableID < @ConsumableID set @ConsumableID = @PassedConsumableID
--	if @PassedConsumableID > @ConsumableID set @ConsumableID = @PassedConsumableID

--end else set @ConsumableID = 1
---------------------------------------------------------------------------------------------------------------------------

	set @ConsumableNoPrefix = dbo.GetOptionValue('ConsumableNoPrefix')
	set @ConsumableID = (select max(ConsumableID) from ConsumableItems where left(ConsumableNo, len(@ConsumableNoPrefix)) = @ConsumableNoPrefix)
	set @ConsumableID = dbo.GetNextAutoNumber('ConsumableItems', 'ConsumableNo', @ConsumableID)



insert into ConsumableItems
(ConsumableID, ConsumableNo, ConsumableName, AlternateName, UnitMeasureID,ConsumableCategoryID, 
OrderLevel, KeepingUnit, UnitCost, VATPercentage, UnitPrice, LastUpdate, Halted, Hidden) 
values
(@ConsumableID, @ConsumableNo, @ConsumableName, @AlternateName, @UnitMeasureID,@ConsumableCategoryID, 
@OrderLevel, @KeepingUnit, @UnitCost, @VATPercentage, @UnitPrice, @LastUpdate, @Halted, @Hidden)
return 0
end
go

/***********************************************************************************************************
--1---------------------------------------------------------------------------------------------------------

exec uspInsertConsumableItems 'D001', 'NEVIMUNE ORAL SOLUTION', '', '8PC', 0, 0, 0, 600, '27 Oct 2013'

************************************************************************************************************/

-- select *  from ConsumableItems
-- delete from ConsumableItems

---------Update ConsumableItems-----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateConsumableItems')
	drop proc uspUpdateConsumableItems
go

create proc uspUpdateConsumableItems(
@ConsumableNo varchar(20),
@ConsumableName varchar(100),
@AlternateName varchar(100),
@UnitMeasureID varchar(10),
@OrderLevel int,
@KeepingUnit int,
@UnitCost money,
@VATPercentage decimal,
@UnitPrice money,
@LastUpdate smalldatetime,
@Halted bit = 0,
@Hidden bit = 0,
@ConsumableCategoryID varchar(10)

)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select ConsumableNo from ConsumableItems where ConsumableNo = @ConsumableNo)
	begin
		set @ErrorMSG = 'The Consumable No: %s, you''re trying to update does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, @ConsumableNo, 'Consumable Items')	
		return 1
	end

if not (@AlternateName is null or @AlternateName = '') 
	begin
		if exists(select AlternateName from ConsumableItems where AlternateName = @AlternateName and not ConsumableNo = @ConsumableNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to update to, already exists'
				raiserror(@ErrorMSG, 16, 1, 'Consumable Alternate Name', @AlternateName)	
				return 1
			end
	end

if not exists(select DataID from LookupData where DataID = @UnitMeasureID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Unit Measure ID', @UnitMeasureID, 'Lookup Data')	
		return 1
	end



else

begin

update ConsumableItems set 
ConsumableName = @ConsumableName, AlternateName = @AlternateName, UnitMeasureID = @UnitMeasureID, 
OrderLevel = @OrderLevel, KeepingUnit = @KeepingUnit, UnitCost = @UnitCost ,VATPercentage=@VATPercentage,UnitPrice = @UnitPrice, 
LastUpdate = @LastUpdate, Halted = @Halted, Hidden = @Hidden, ConsumableCategoryID=@ConsumableCategoryID
where ConsumableNo = @ConsumableNo
return 0
end
go

/******************************************************************************************
--1----------------------------------------------------------------------------------------

exec uspUpdateConsumableItems 'C0413', 'NEVIMUNE ORAL SOLUTION', '4ARVG', '8NA', 0, 0, 1.2, 1.68,0, '08 May 2010',0,0,'C0413'

******************************************************************************************/

-- select *  from ConsumableItems
-- delete from ConsumableItems

-------------- Get ConsumableItems -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetConsumableItems')
	drop proc uspGetConsumableItems
go

create proc uspGetConsumableItems(
@ConsumableNo varchar(20) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not (@ConsumableNo is null)
begin
	if not exists(select ConsumableNo from ConsumableItems where ConsumableNo = @ConsumableNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ConsumableNo, 'Consumable Items')
			return 1
		end
	else
	begin
		select ConsumableNo, ConsumableName, dbo.GetMergedNameCode(ConsumableName, ConsumableNo) as ConsumableFullName, 
		AlternateName, UnitMeasureID, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure, OrderLevel, KeepingUnit, 
		dbo.FormatMoney(UnitCost) as UnitCost,VATPercentage, dbo.FormatMoney(UnitPrice) as UnitPrice, LastUpdate, Halted,
		 Hidden,dbo.GetChartCategoryLookupName(ConsumableCategoryID) as CategoryName, 
		UnitsInStock, dbo.FormatMoney(UnitsInStock*UnitCost) as StockCostValue,
		dbo.FormatMoney(UnitsInStock*UnitPrice) as StockSellingValue, BatchNo, 
		dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)) as ExpiryDate
		from ConsumableItems
		where ConsumableNo = @ConsumableNo
	end
end
else 
if (@ConsumableNo is null)
begin	
	select ConsumableNo, ConsumableName, dbo.GetMergedNameCode(ConsumableName, ConsumableNo) as ConsumableFullName, 
	AlternateName, UnitMeasureID, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure, OrderLevel, KeepingUnit,dbo.GetChartCategoryLookupName(ConsumableCategoryID) as CategoryName, 
	dbo.FormatMoney(UnitCost) as UnitCost,VATPercentage, dbo.FormatMoney(UnitPrice) as UnitPrice, LastUpdate, Halted, Hidden, 
	UnitsInStock, dbo.FormatMoney(UnitsInStock*UnitCost) as StockCostValue,dbo.FormatMoney(UnitsInStock*UnitPrice) as StockSellingValue,
	 BatchNo, dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)) as ExpiryDate
	from ConsumableItems
	where Hidden = @Hidden
	order by ConsumableName	
end
go


-- select * from ConsumableItems
-------- GetNextConsumableID --------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextConsumableID')
	drop proc uspGetNextConsumableID
go

create proc uspGetNextConsumableID(
@ConsumableID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @ConsumableNoPrefix varchar(1)

set @ConsumableNoPrefix = dbo.GetOptionValue('ConsumableNoPrefix')

set @ConsumableID = (select max(ConsumableID) from ConsumableItems where left(ConsumableNo, len(@ConsumableNoPrefix)) = @ConsumableNoPrefix)
set @ConsumableID = dbo.GetNextAutoNumber('ConsumableItems', 'ConsumableNo', @ConsumableID)

return 0
go

--------CountToOrderConsumableItems-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountToOrderConsumableItems')
	drop proc uspCountToOrderConsumableItems
go

create proc uspCountToOrderConsumableItems(
@Hidden bit = 0,
@Records int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @ConsumableItemCategoryID varchar(10)

-------------------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------------------------

begin
	set @ConsumableItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')

	set @Records = (select Count(ConsumableNo) from ConsumableItems where Hidden = @Hidden 
					and OrderLevel >= dbo.GetInventoryBalance(null, @ConsumableItemCategoryID, ConsumableNo))
	set @Records = isnull(@Records, 0)
end

return 0

go

-- select * from ConsumableItems
-- exec uspCountToOrderConsumableItems null
-- exec uspCountToOrderConsumableItems 0

--------GetToExpireConsumableItems-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetToExpireConsumableItems')
	drop proc uspGetToExpireConsumableItems
go

create proc uspGetToExpireConsumableItems(
@ExpiryWarningDays int,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

-------------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------------------

begin
	select ConsumableNo as ItemCode, ConsumableName as ItemName, OrderLevel, KeepingUnit,
	dbo.GetMergedNameCode(ConsumableName, ConsumableNo) as ItemFullName,  
	dbo.FormatMoney(UnitCost) as UnitCost, dbo.FormatMoney(UnitPrice) as UnitPrice , 
	BatchNo, isnull(dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)), '') as ExpiryDate,
	dbo.GetExpiryRemainingDays(getdate(), ExpiryDate) as ExpiryRemainingDays,
	UnitsInStock, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure
	from ConsumableItems 
	where Hidden = @Hidden and UnitsInStock > 0 and not dbo.GetNullDateValue(ExpiryDate) is null
	and (dbo.GetExpiryRemainingDays(getdate(), ExpiryDate) <= @ExpiryWarningDays)
	order by ConsumableName
end

return 0

go

-- select * from ConsumableItems
-- exec uspGetToExpireConsumableItems 60, null
-- exec uspGetToExpireConsumableItems 60, 0

--------CountToExpireConsumableItems-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountToExpireConsumableItems')
	drop proc uspCountToExpireConsumableItems
go

create proc uspCountToExpireConsumableItems(
@ExpiryWarningDays int,
@Hidden bit = 0,
@Records int = null output
)with encryption as

declare @ErrorMSG varchar(200)

---------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
---------------------------------------------------------------------------------------------

begin
	set @Records = (select Count(ConsumableNo) from ConsumableItems 
	where Hidden = @Hidden and UnitsInStock > 0 and not dbo.GetNullDateValue(ExpiryDate) is null
	and (dbo.GetExpiryRemainingDays(getdate(), ExpiryDate) <= @ExpiryWarningDays))
	
	set @Records = isnull(@Records, 0)
	
end

return 0

go

-- select * from ConsumableItems
-- exec uspCountToExpireConsumableItems 60, null
-- exec uspCountToExpireConsumableItems 60, 0

--------GetConsumableStockCard-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetConsumableStockCard')
	drop proc uspGetConsumableStockCard
go

create proc uspGetConsumableStockCard(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime,
@ConsumableNo varchar(20),
@LocationID varchar(10) = null,
@LoginID varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)


if (not (@LocationID is null) and (@LoginID is null))
	begin
		select dbo.FormatDate(RecordDate) as RecordDate, RecordTime,dbo.FormatDate(TranDate) as TranDate,Location, StockType, 
		Quantity, LocationUnits, Balance, Details, LoginID 
		from ConsumableInventory
		where (RecordDateTime between @StartDateTime and @EndDateTime) and ItemCode = @ConsumableNo  and LocationID = @LocationID 
		order by RecordDateTime
	end
else 
	if (not (@LocationID is null) and not (@LoginID is null))
		begin
			select dbo.FormatDate(RecordDate) as RecordDate, RecordTime,dbo.FormatDate(TranDate) as TranDate,Location, StockType, 
			Quantity, LocationUnits, Balance, Details, LoginID 
			from ConsumableInventory
			where (RecordDateTime between @StartDateTime and @EndDateTime) and ItemCode = @ConsumableNo  and LocationID = @LocationID  and LoginID = @LoginID 
			order by RecordDateTime
		end
else 
	if ((@LocationID is null) and not (@LoginID is null))
		begin
			select dbo.FormatDate(RecordDate) as RecordDate, RecordTime,dbo.FormatDate(TranDate) as TranDate,Location, StockType, 
			Quantity, LocationUnits, Balance, Details, LoginID 
			from ConsumableInventory
			where (RecordDateTime between @StartDateTime and @EndDateTime) and ItemCode = @ConsumableNo  and LoginID = @LoginID 
			order by RecordDateTime
		end	
else
	if ((@LocationID is null) and (@LoginID is null))
		begin
			select dbo.FormatDate(RecordDate) as RecordDate, RecordTime,dbo.FormatDate(TranDate) as TranDate,Location, StockType, 
			Quantity, LocationUnits, Balance, Details, LoginID 
			from ConsumableInventory
			where (RecordDateTime between @StartDateTime and @EndDateTime) and ItemCode = @ConsumableNo  
			order by RecordDateTime
		end

return 0

go

-- select * from ConsumableInventory
-- exec uspGetConsumableStockCard '1 May 2014', '20 Dec 2014', 'LAB0055'
-- exec uspGetConsumableStockCard '1 Oct 2014', '20 Oct 2014', 'LAB0055', '11702'


--------GetConsumablePeriodicInventory-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetConsumablePeriodicInventory')
	drop proc uspGetConsumablePeriodicInventory
go

create proc uspGetConsumablePeriodicInventory(
@StartDate smalldatetime,
@EndDate smalldatetime,
@LocationID varchar(10) = null,
@ConsumableNo varchar(20) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
declare @ConsumableCategoryID varchar(10)

-------------------------------------------------------------------------------
set @ConsumableCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------

if not (@ConsumableNo is null)
	begin
		select ConsumableNo, ConsumableName, OrderLevel, KeepingUnit, dbo.FormatMoney(UnitCost) as UnitCost, 
		dbo.FormatMoney(UnitPrice) as UnitPrice ,UnitsInStock, 
		isnull(dbo.GetLocationUnits(@LocationID, @ConsumableCategoryID, ConsumableNo), UnitsInStock) as UnitsAtHand,
		dbo.FormatMoney(UnitsInStock*UnitCost) as StockCostValue,dbo.FormatMoney(UnitsInStock*UnitPrice) as StockSellingValue,
		dbo.FormatMoney((UnitPrice*UnitsInStock)*(VATPercentage/100)) as VATValue,
		dbo.GetInventoryStartBalance(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate) as StartBalance,
		dbo.FormatMoney(UnitCost*(dbo.GetInventoryStartBalance(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate))) as openingStockCostValue,
		dbo.FormatMoney(UnitPrice*(dbo.GetInventoryStartBalance(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate))) as openingStockUnitValue,
		dbo.FormatMoney(UnitCost*(dbo.GetInventoryEndBalance(@LocationID, @ConsumableCategoryID, ConsumableNo, @EndDate))) as EndBalanceStockCostValue,
		dbo.FormatMoney(UnitPrice*(dbo.GetInventoryEndBalance(@LocationID, @ConsumableCategoryID, ConsumableNo, @EndDate))) as EndBalanceStockUnitValue,
		dbo.GetInventoryEndBalance(@LocationID, @ConsumableCategoryID, ConsumableNo, @EndDate) as EndBalance,
		dbo.GetInventoryTotalReceived(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate) as TotalReceived,
		dbo.GetInventoryTotalIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate) as TotalIssued,
	    dbo.GetInventoryTotalSystemIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate) as TotalSystemIssued,
		(dbo.GetInventoryTotalSystemIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate)*UnitCost) as ExpectedSystemIssuedAmount,

		dbo.GetInventoryTotalManualIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate) as TotalManualIssued,
		UnitPrice * dbo.GetInventoryTotalIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate) as ExpectedIssuedAmount,
		dbo.GetInventoryTotalManualIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate)*UnitCost as TotalManualIssuedCostValue,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate)*UnitCost) as TotalReceivedCostValue,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate)*UnitCost) as TotalIssuedCostValue
		--dbo.GetActualIssuedAmount(@LocationID, ConsumableNo, @StartDateTime, @EndDateTime) as ActualIssuedAmount,
		--dbo.GetPaidIssuedAmount(@LocationID, ConsumableNo, @StartDateTime, @EndDateTime) as PaidIssuedAmount
		from ConsumableItems 
		where ConsumableNo = @ConsumableNo order by ConsumableName
	end
else
	begin
		select ConsumableNo, ConsumableName, OrderLevel, KeepingUnit, dbo.FormatMoney(UnitCost) as UnitCost, 
		dbo.FormatMoney(UnitPrice) as UnitPrice ,UnitsInStock, 
		isnull(dbo.GetLocationUnits(@LocationID, @ConsumableCategoryID, ConsumableNo), UnitsInStock) as UnitsAtHand,
		dbo.FormatMoney(UnitsInStock*UnitCost) as StockCostValue,dbo.FormatMoney(UnitsInStock*UnitPrice) as StockSellingValue,
		dbo.FormatMoney((UnitPrice*UnitsInStock)*(VATPercentage/100)) as VATValue,
		dbo.GetInventoryStartBalance(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate) as StartBalance,
		dbo.GetInventoryEndBalance(@LocationID, @ConsumableCategoryID, ConsumableNo, @EndDate) as EndBalance,
				dbo.FormatMoney(UnitCost*(dbo.GetInventoryStartBalance(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate))) as openingStockCostValue,
		dbo.FormatMoney(UnitPrice*(dbo.GetInventoryStartBalance(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate))) as openingStockUnitValue,
		dbo.FormatMoney(UnitCost*(dbo.GetInventoryEndBalance(@LocationID, @ConsumableCategoryID, ConsumableNo, @EndDate))) as EndBalanceStockCostValue,
		dbo.FormatMoney(UnitPrice*(dbo.GetInventoryEndBalance(@LocationID, @ConsumableCategoryID, ConsumableNo, @EndDate))) as EndBalanceStockUnitValue,
		dbo.GetInventoryTotalReceived(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate) as TotalReceived,
		dbo.GetInventoryTotalIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate) as TotalIssued,
		dbo.GetInventoryTotalSystemIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate) as TotalSystemIssued,
		(dbo.GetInventoryTotalSystemIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate)*UnitCost) as ExpectedSystemIssuedAmount,

		
		dbo.GetInventoryTotalManualIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate) as TotalManualIssued,
		UnitPrice * dbo.GetInventoryTotalIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate) as ExpectedIssuedAmount,
	    dbo.GetInventoryTotalManualIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate)*UnitCost as TotalManualIssuedCostValue,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate)*UnitCost) as TotalReceivedCostValue,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(@LocationID, @ConsumableCategoryID, ConsumableNo, @StartDate, @EndDate)*UnitCost) as TotalIssuedCostValue
		--,dbo.GetActualIssuedAmount(@LocationID, ConsumableNo, @StartDateTime, @EndDateTime) as ActualIssuedAmount,
		--dbo.GetPaidIssuedAmount(@LocationID, ConsumableNo, @StartDateTime, @EndDateTime) as PaidIssuedAmount
		from ConsumableItems where Hidden = @Hidden order by ConsumableName
	end

return 0

go

-- select * from ConsumableItems
-- exec uspGetConsumablePeriodicInventory '1 Apr 2014', '30 Apr 2014'
-- exec uspGetConsumablePeriodicInventory  '1 Apr 2014', '30 Apr 2014', '', 'C001'

------------------------------------------------------------------------------------------------------
-------------- OtherItems --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert OtherItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertOtherItems')
	drop proc uspInsertOtherItems
go

create proc uspInsertOtherItems(
@ItemCode Varchar(20),
@ItemName varchar(200),
@ItemCategoryID varchar(10),
@UnitCost Money,
@Quantity int,
@Details Varchar(1000),
@LocationID Varchar(10),
@GroupsID varchar(10),
@UnitMeasureID varchar(10),
@VATPercentage decimal,
@Hidden bit,
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

declare @ItemID int
declare @OtherItemsPrefix varchar(1)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedItemID int
declare @PassedItemCode varchar(20)

if exists(select ItemCode from OtherItems where ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'ItemCode', @ItemCode)
		return 1
	end

--if not exists(select SubCategoryNo from COASubCategories where SubCategoryNo = @ItemCategoryID)
--	begin
--	set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
--			raiserror(@ErrorMSG, 16, 1, 'COACategories Code', @ItemCategoryID, 'COACategories')
--			return 1
--	end

if not exists(select DataID from LookupData where DataID = @GroupsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Drug Group ID', @GroupsID, 'Lookup Data')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @UnitMeasureID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Unit Measure ID', @UnitMeasureID, 'Lookup Data')	
		return 1
	end


if not exists(select DataID from LookupData where DataID = @LocationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LocationID', @LocationID, 'Lookup Data')
		return 1
	end

else
------------------------------------------------------------------------------------------------------------------
begin

--select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
--		where ObjectName = 'OtherItems' and AutoColumnName = 'ItemCode'

--select @PaddingLEN = PaddingLEN from AutoNumbers 
--		where ObjectName = 'OtherItems' and AutoColumnName = 'ItemCode'

--set @OtherItemsPrefix = dbo.GetOptionValue('OtherItemsPrefix')

--if (@AutoColumnLEN = len(@ItemCode)) and (left(@ItemCode, len(@OtherItemsPrefix)) = @OtherItemsPrefix)

--begin

--	set @PassedItemID = 1
--	set @PassedItemCode = @ItemCode
--	set @PassedItemCode = ltrim(rtrim(substring(@PassedItemCode, len(@OtherItemsPrefix) + 1, @PaddingLEN)))

--	if isnumeric(@PassedItemCode) = 1 set @PassedItemID = @PassedItemCode
--	else set @PassedItemID = 1

--	set @ItemID = (select max(ItemID) from OtherItems where left(ItemCode, len(@OtherItemsPrefix)) = @OtherItemsPrefix)
--	set @ItemID = dbo.GetNextAutoNumber('OtherItems', 'ItemCode', @ItemID)

--	if @PassedItemID < @ItemID set @ItemID = @PassedItemID
--	if @PassedItemID > @ItemID set @ItemID = @PassedItemID

--end else set @ItemID = 1

	set @OtherItemsPrefix = dbo.GetOptionValue('OtherItemsPrefix')
	set @ItemID = (select max(ItemID) from OtherItems where left(ItemCode, len(@OtherItemsPrefix)) = @OtherItemsPrefix)
	set @ItemID = dbo.GetNextAutoNumber('OtherItems', 'ItemCode', @ItemID)


---------------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
---------------------------------------------------------------------------------------------------

insert into OtherItems
(ItemID, ItemCode, ItemName, ItemCategoryID, UnitCost, Quantity, Details, LocationID, Hidden,GroupsID, UnitMeasureID, VATPercentage,LoginID)
values
(@ItemID, @ItemCode, @ItemName, @ItemCategoryID, @UnitCost, @Quantity, @Details, @LocationID, @Hidden,@GroupsID, @UnitMeasureID,@VATPercentage, @LoginID)


return 0
end
go

/******************************************************************************************************
exec uspInsertOtherItems
******************************************************************************************************/
-- select * from OtherItems
-- delete from OtherItems


-------------- Update OtherItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateOtherItems')
	drop proc uspUpdateOtherItems
go

create proc uspUpdateOtherItems(
@ItemCode Varchar(20),
@ItemName varchar(200),
@ItemCategoryID varchar(10),
@UnitCost Money,
@Quantity int,
@Details Varchar(1000),
@LocationID Varchar(10),
@GroupsID varchar(10),
@UnitMeasureID varchar(10),
@VATPercentage decimal,
@Hidden bit,
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ItemCode from OtherItems where ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCode', @ItemCode, 'OtherItems')
		return 1
	end

--if not exists(select SubCategoryNo from COASubCategories where SubCategoryNo = @ItemCategoryID)
--	begin
--	set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
--			raiserror(@ErrorMSG, 16, 1, 'COACategories Code', @ItemCategoryID, 'COACategories')
--			return 1
--	end

if not exists(select DataID from LookupData where DataID = @GroupsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Drug Group ID', @GroupsID, 'Lookup Data')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @UnitMeasureID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Unit Measure ID', @UnitMeasureID, 'Lookup Data')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LocationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LocationID', @LocationID, 'Lookup Data')
		return 1
	end

begin
update OtherItems set ItemName = @ItemName, ItemCategoryID = @ItemCategoryID, UnitCost = @UnitCost, Quantity = @Quantity, 
Details = @Details,LocationID = @LocationID, Hidden = @Hidden,
GroupsID=@GroupsID,UnitMeasureID = @UnitMeasureID,VATPercentage=@VATPercentage,
 LoginID = @LoginID
where ItemCode = @ItemCode

return 0
end
go

/******************************************************************************************************
exec uspUpdateOtherItems
******************************************************************************************************/
-- select * from OtherItems
-- delete from OtherItems


-------- GetNextItemID --------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextItemID')
	drop proc uspGetNextItemID
go

create proc uspGetNextItemID(
@ItemID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @OtherItemsPrefix varchar(1)

set @OtherItemsPrefix = dbo.GetOptionValue('OtherItemsPrefix')

set @ItemID = (select max(ItemID) from OtherItems where left(ItemCode, len(@OtherItemsPrefix)) = @OtherItemsPrefix)
set @ItemID = dbo.GetNextAutoNumber('OtherItems', 'ItemCode', @ItemID)

return 0
go

-- exec uspGetNextItemID
-- select * from OtherItems where ItemCode like 'A%'

-------------- Get OtherItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetOtherItems')
	drop proc uspGetOtherItems
go

create proc uspGetOtherItems(
@ItemCode Varchar(20) =null
)with encryption as

declare @ErrorMSG varchar(200)
declare @Hidden bit
-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

if not (@ItemCode is null)
begin
select ItemID, OtherItems.ItemCode, OtherItems.ItemName, OtherItems.ItemCategoryID, ClinicMaster.dbo.GetChartCategoryLookupName(OtherItems.ItemCategoryID) as ItemCategory,
'' as OrderLevel,0 as Halted,UnitCost as UnitPrice,
	UnitCost, Quantity, Details, LocationID, ClinicMaster.dbo.GetLookupDataDes(LocationID) as [LocationID],dbo.GetMergedNameCode(OtherItems.ItemName, OtherItems.ItemCode) as ItemFullName,
	 OtherItems.GroupsID, dbo.GetLookupDataDes(OtherItems.GroupsID) as [Group], BatchNo, dbo.FormatDate(ExpiryDate) as ExpiryDate,
		Hidden, UnitMeasureID, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure,VATPercentage, 
	OtherItems.LoginID, OtherItems.RecordDateTime, OtherItems.ClientMachine
	from ClinicMaster.dbo.OtherItems

	where OtherItems.ItemCode = @ItemCode
		end
	else
begin
select ItemID, OtherItems.ItemCode, OtherItems.ItemName, OtherItems.ItemCategoryID, ClinicMaster.dbo.GetChartCategoryLookupName(OtherItems.ItemCategoryID) as ItemCategory,
'' as OrderLevel,0 as Halted,UnitCost as UnitPrice,
	UnitCost, Quantity, Details, LocationID, ClinicMaster.dbo.GetLookupDataDes(LocationID) as [LocationID],dbo.GetMergedNameCode(OtherItems.ItemName, OtherItems.ItemCode) as ItemFullName,
	 OtherItems.GroupsID, dbo.GetLookupDataDes(OtherItems.GroupsID) as [Group], 
		Hidden, UnitMeasureID, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure,VATPercentage, BatchNo, dbo.FormatDate(ExpiryDate) as ExpiryDate,
	OtherItems.LoginID, OtherItems.RecordDateTime, OtherItems.ClientMachine
	from ClinicMaster.dbo.OtherItems
	where Hidden = @Hidden

return 0
end
go

/******************************************************************************************************
exec uspGetOtherItems 'A0001'
******************************************************************************************************/
-- select * from OtherItems
-- delete from OtherItems

------------------------------------------------------------------------------------------------------
------------- Services -------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------


---------Insert Services------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertServices')
	drop proc uspInsertServices
go

create proc uspInsertServices(
@ServiceCode varchar(10),
@ServiceName varchar(100),
@ServicePointID varchar(10),
@ServiceBillAtID varchar(10),
@RevenueStreamCode varchar(20)=null,
@UnitCost money,
@VATPercentage decimal,
@StandardFee money,
@Hidden bit = null
)with encryption as 

declare @ErrorMSG varchar(200)
declare @ServiceID Int
declare @ServiceCodePrefix varchar(1)

if exists(select ServiceCode from Services where ServiceCode = @ServiceCode)
	begin
		set @ErrorMSG = 'The Service Code: ' + @ServiceCode + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ServicePointID)
	begin
		set @ErrorMSG = 'The Service Point ID: ' + @ServicePointID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ServiceBillAtID)
	begin
		set @ErrorMSG = 'The Service Bill At ID: ' + @ServiceBillAtID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end
else
begin

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
	set @ServiceCodePrefix = dbo.GetOptionValue('ServiceCodePrefix')
	set @ServiceID = (select max(ServiceID) from Services where left(ServiceCode, len(@ServiceCodePrefix)) = @ServiceCodePrefix)
	set @ServiceID = dbo.GetNextAutoNumber('Services', 'ServiceCode', @ServiceID)

-------------------------------------------------------------------------------------

insert into Services
(ServiceID, ServiceCode ,ServiceName, ServicePointID ,ServiceBillAtID,RevenueStreamCode ,UnitCost,VATPercentage, StandardFee, Hidden) 
values
(@ServiceID, @ServiceCode ,@ServiceName, @ServicePointID, @ServiceBillAtID ,@RevenueStreamCode,@UnitCost,@VATPercentage, @StandardFee, @Hidden)

return 0
end
go

/*******************************************************************************
--1-----------------------------------------------------------------------------
exec uspInsertServices '10C1', 'Consultation1', '16VIS', '30VIS', 5000, 1

*********************************************************************************/

-- select * from Services
-- delete from Services 

---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextServiceID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextServiceID')
	drop proc uspGetNextServiceID
go
create proc uspGetNextServiceID(
@ServiceID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @ServiceCodePrefix varchar(1)

set @ServiceCodePrefix =dbo.GetOptionValue('ServiceCodePrefix')

set @ServiceID = (select max(ServiceID) from Services where left(ServiceCode, len(@ServiceCodePrefix)) = @ServiceCodePrefix)
set @ServiceID =  dbo.GetNextAutoNumber('Services', 'ServiceCode', @ServiceID)

return 0
go

--PRINT uspGetNextServiceID

---------Update Services---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateServices')
	drop proc uspUpdateServices
go

create proc uspUpdateServices(
@ServiceCode varchar(10),
@ServiceName varchar(100),
@ServicePointID varchar(10),
@ServiceBillAtID varchar(10),
@RevenueStreamCode varchar(20),
@UnitCost money,
@VATPercentage decimal,
@StandardFee money,
@Hidden bit = null
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select ServiceCode from Services where ServiceCode = @ServiceCode)
	begin
		set @ErrorMSG = 'The Service Code: %s,you''re trying to update does not exist in the registered %s'
		raiserror(@ErrorMSG,16, 1, @ServiceCode, 'Services')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ServicePointID)
	begin
		set @ErrorMSG = 'The Service Point ID: ' + @ServicePointID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ServiceBillAtID)
	begin
		set @ErrorMSG = 'The Service Bill At ID: ' + @ServiceBillAtID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end
else
begin

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

update Services set 
	ServiceName = @ServiceName, ServicePointID = @ServicePointID, ServiceBillAtID = @ServiceBillAtID,RevenueStreamCode=@RevenueStreamCode, 
	UnitCost = @UnitCost , VATPercentage=@VATPercentage,StandardFee = @StandardFee, Hidden = @Hidden
where ServiceCode = @ServiceCode 

return 0
end
go

/********************************************************************************************
--1------------------------------------------------------------------------------------------
exec uspUpdateServices '10C1', 'Consultation1','16VIS', '30DOC', 9000, 0

********************************************************************************************/

-- select * from Services
-- delete from Services

--------Get Services -------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetServices')
	drop proc uspGetServices
go

create proc uspGetServices(
@ServiceCode varchar(10) = null,
@ServicePointID varchar(10) = null,
@Hidden bit = null
)with encryption as

declare @ErrorMSG varchar(200)

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

if (not(@ServiceCode is null) and (@ServicePointID is null))
begin
	if not exists(select ServiceCode from Services where ServiceCode = @ServiceCode)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Service Code', @ServiceCode, 'Services')	
		return 1
	end
	begin
		select ServiceCode, ServiceName, ServicePointID, dbo.GetLookupDataDes(ServicePointID) as ServicePoint, 
		Services.RevenueStreamCode as RevenueStreamCode,RevenueStreams.Name as Name, 
		ServiceBillAtID, dbo.GetLookupDataDes(ServiceBillAtID) as ServiceBillAt, Services.Hidden as Hidden, 
		dbo.GetMergedNameCode(ServiceName, ServiceCode) as ServiceFullName, dbo.FormatMoney(UnitCost) as UnitCost,VATPercentage,
		dbo.FormatMoney(StandardFee)as StandardFee 
		from Services
		left outer join RevenueStreams on RevenueStreams.RevenueStreamCode=Services.RevenueStreamCode 
		where ServiceCode = @ServiceCode
	end
end
else
if ((@ServiceCode is null) and not (@ServicePointID is null))
begin
	begin
		select ServiceCode, ServiceName, ServicePointID,dbo.GetLookupDataDes(ServicePointID) as ServicePoint, 
		ServiceBillAtID, dbo.GetLookupDataDes(ServiceBillAtID) as ServiceBillAt, Services.Hidden as Hidden, 
		dbo.GetMergedNameCode(ServiceName, ServiceCode) as ServiceFullName, dbo.FormatMoney(UnitCost) as UnitCost,
		Services.RevenueStreamCode as RevenueStreamCode,RevenueStreams.Name as Name ,  
		dbo.FormatMoney(StandardFee)as StandardFee 
		from Services 
		left outer join RevenueStreams on RevenueStreams.RevenueStreamCode=Services.RevenueStreamCode 
		where Services.Hidden = @Hidden and ServicePointID = @ServicePointID
		order by ServiceName
	end
end
else
begin
	select ServiceCode, ServiceName, ServicePointID, dbo.GetLookupDataDes(ServicePointID) as ServicePoint, 
	ServiceBillAtID, dbo.GetLookupDataDes(ServiceBillAtID) as ServiceBillAt, Services.Hidden as Hidden, 
	dbo.GetMergedNameCode(ServiceName, ServiceCode) as ServiceFullName, dbo.FormatMoney(UnitCost) as UnitCost,
	Services.RevenueStreamCode as RevenueStreamCode,RevenueStreams.Name as Name ,  
	dbo.FormatMoney(StandardFee)as StandardFee 
	from Services 
	left outer join RevenueStreams on RevenueStreams.RevenueStreamCode=Services.RevenueStreamCode 
	where Services.Hidden = @Hidden
	order by ServiceName
end

--------------------------------------------------------------------------------------------------------------------------------

return 0

go


-- select * from Services

-- exec uspGetServices
-- exec uspGetServices '10C'
-- exec uspGetServices null, '16VIS'

------------------------------------------------------------------------------------------------------
-------------- ServicesDrSpecialtyFee ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ServicesDrSpecialtyFee -----------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditServicesDrSpecialtyFee')
	drop proc uspEditServicesDrSpecialtyFee
go

create proc uspEditServicesDrSpecialtyFee(
@ServiceCode varchar(10),
@DoctorSpecialtyID varchar(10),
@SpecialtyFee money,
@CurrenciesID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ServiceCode from Services where ServiceCode = @ServiceCode)
	begin
		set @ErrorMSG = 'The %: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Services')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DoctorSpecialtyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Doctor Specialty ID',@DoctorSpecialtyID, 'Lookup Data')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CurrenciesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrenciesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select ServiceCode from ServicesDrSpecialtyFee where ServiceCode = @ServiceCode and DoctorSpecialtyID = @DoctorSpecialtyID)
	begin
		update ServicesDrSpecialtyFee set SpecialtyFee = @SpecialtyFee, CurrenciesID = @CurrenciesID, LoginID = @LoginID, ClientMachine = @ClientMachine
		where ServiceCode = @ServiceCode and DoctorSpecialtyID = @DoctorSpecialtyID
		return 0
	end
else
begin
insert into ServicesDrSpecialtyFee
(ServiceCode, DoctorSpecialtyID, SpecialtyFee, CurrenciesID, LoginID, ClientMachine)
values
(@ServiceCode, @DoctorSpecialtyID, @SpecialtyFee, @CurrenciesID, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspEditServicesDrSpecialtyFee '10C', '39GEN', 20000, '49UGX', 'Admin', 'CEO'
exec uspEditServicesDrSpecialtyFee 'REV', '39GEN', 15000, '49UGX', 'Admin', 'CEO'
exec uspEditServicesDrSpecialtyFee '10C', '39PED', 30000, '49UGX', 'Admin', 'CEO'
exec uspEditServicesDrSpecialtyFee 'REV', '39PED', 30000, '49UGX', 'Admin', 'CEO'
exec uspEditServicesDrSpecialtyFee 'PHY', '39GEN', 45000, '49UGX', 'Admin', 'CEO'

******************************************************************************************************/
-- select * from ServicesDrSpecialtyFee
-- delete from ServicesDrSpecialtyFee

-------------- Get ServicesDrSpecialtyFee -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetServicesDrSpecialtyFee')
	drop proc uspGetServicesDrSpecialtyFee
go

create proc uspGetServicesDrSpecialtyFee(
@ServiceCode varchar(10),
@DoctorSpecialtyID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not(@DoctorSpecialtyID is null)
begin
--	if not exists(select ServiceCode from ServicesDrSpecialtyFee where ServiceCode = @ServiceCode and DoctorSpecialtyID = @DoctorSpecialtyID)
--		begin
--			set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
--			raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Doctor Specialty ID', @DoctorSpecialtyID, 'Services Dr. Specialty Fee')
--			return 1
--		end
--	else
	begin
		select ServiceCode, DoctorSpecialtyID, dbo.GetLookupDataDes(DoctorSpecialtyID) as DoctorSpecialty,
		SpecialtyFee, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency
		from ServicesDrSpecialtyFee
		where ServiceCode = @ServiceCode and DoctorSpecialtyID = @DoctorSpecialtyID
	end
end
else 
if @DoctorSpecialtyID is null
	begin
		select ServiceCode, DoctorSpecialtyID, dbo.GetLookupDataDes(DoctorSpecialtyID) as DoctorSpecialty,
		SpecialtyFee, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency
		from ServicesDrSpecialtyFee
		where ServiceCode = @ServiceCode
	end
return 0
go

/******************************************************************************************************
exec uspGetServicesDrSpecialtyFee '10C'
exec uspGetServicesDrSpecialtyFee '10C', '39GEN'
******************************************************************************************************/
-- select * from ServicesDrSpecialtyFee
-- delete from ServicesDrSpecialtyFee

------------------------------------------------------------------------------------------------------
-------------- ServicesStaffFee ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ServicesStaffFee -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditServicesStaffFee')
	drop proc uspEditServicesStaffFee
go

create proc uspEditServicesStaffFee(
@ServiceCode varchar(10),
@StaffNo varchar(10),
@StaffFee money,
@CurrenciesID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ServiceCode from Services where ServiceCode = @ServiceCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Services')	
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to update does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CurrenciesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrenciesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select ServiceCode from ServicesStaffFee where ServiceCode = @ServiceCode and StaffNo = @StaffNo)
	begin
		update ServicesStaffFee set StaffFee = @StaffFee, CurrenciesID = @CurrenciesID, LoginID = @LoginID, ClientMachine = @ClientMachine
		where ServiceCode = @ServiceCode and StaffNo = @StaffNo
		return 0
	end
else
begin
insert into ServicesStaffFee
(ServiceCode, StaffNo, StaffFee, CurrenciesID, LoginID, ClientMachine)
values
(@ServiceCode, @StaffNo, @StaffFee, @CurrenciesID, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspEditServicesStaffFee '10C', '100', 30000, '49UGX', 'Admin', 'CEO'
exec uspEditServicesStaffFee 'REV', '100', 15000, '49UGX', 'Admin', 'CEO'

******************************************************************************************************/
-- select * from ServicesStaffFee
-- delete from ServicesStaffFee

-------------- Get ServicesStaffFee -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetServicesStaffFee')
	drop proc uspGetServicesStaffFee
go

create proc uspGetServicesStaffFee(
@ServiceCode varchar(10),
@StaffNo varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not(@StaffNo is null)
begin
--	if not exists(select ServiceCode from ServicesStaffFee where ServiceCode = @ServiceCode and StaffNo = @StaffNo)
--		begin
--			set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
--			raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Staff No', @StaffNo, 'Services Staff Fee')
--			return 1
--		end
--	else
	begin
		select ServiceCode, StaffNo, dbo.GetStaffFullName(StaffNo) as StaffFullName, 
		StaffFee, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency
		from ServicesStaffFee
		where ServiceCode = @ServiceCode and StaffNo = @StaffNo
	end
end
else 
if @StaffNo is null
	begin
		select ServiceCode, StaffNo, dbo.GetStaffFullName(StaffNo) as StaffFullName, 
		StaffFee, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency
		from ServicesStaffFee
		where ServiceCode = @ServiceCode
	end
return 0
go

/******************************************************************************************************
exec uspGetServicesStaffFee 'REV'
exec uspGetServicesStaffFee '10C', '100'
exec uspGetServicesStaffFee 'REV', '254'

******************************************************************************************************/
-- select * from ServicesStaffFee
-- delete from ServicesStaffFee


------------------------------------------------------------------------------------------------------
-------------- ServicesSpecialtyBillCustomFee --------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ServicesSpecialtyBillCustomFee ---------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditServicesSpecialtyBillCustomFee')
	drop proc uspEditServicesSpecialtyBillCustomFee
go

create proc uspEditServicesSpecialtyBillCustomFee(
@ServiceCode varchar(10),
@DoctorSpecialtyID varchar(10),
@AccountNo varchar(20),
@CustomFee money,
@CurrenciesID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ServiceCode from Services where ServiceCode = @ServiceCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Services')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DoctorSpecialtyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Doctor Specialty',@DoctorSpecialtyID, 'Lookup Data')	
		return 1
	end
	
if not exists(select AccountNo from BillCustomers where AccountNo = @AccountNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account No', @AccountNo, 'To-Bill Customers')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CurrenciesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrenciesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select ServiceCode from ServicesSpecialtyBillCustomFee where ServiceCode = @ServiceCode and DoctorSpecialtyID = @DoctorSpecialtyID and AccountNo = @AccountNo)
	begin
		update ServicesSpecialtyBillCustomFee 
		set CustomFee = @CustomFee, CurrenciesID = @CurrenciesID, LoginID = @LoginID, ClientMachine = @ClientMachine
		where ServiceCode = @ServiceCode and DoctorSpecialtyID = @DoctorSpecialtyID and AccountNo = @AccountNo
		return 0
	end
else
begin
insert into ServicesSpecialtyBillCustomFee
(ServiceCode, DoctorSpecialtyID, AccountNo, CustomFee, CurrenciesID, LoginID, ClientMachine)
values
(@ServiceCode, @DoctorSpecialtyID, @AccountNo, @CustomFee, @CurrenciesID, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspEditServicesSpecialtyBillCustomFee '10C', '39PED', 'CM00135', 100000, '49UGX', 'Admin', 'CEO'
exec uspEditServicesSpecialtyBillCustomFee '10C', '39SUR', 'CM00135', 150000, '49UGX', 'Admin', 'CEO'
exec uspEditServicesSpecialtyBillCustomFee '10C', '39PED', '100041A', 180, '49USD', 'Admin', 'CEO'

exec uspEditServicesSpecialtyBillCustomFee 'REV', '39PED', 'CM00135', 90000, '49UGX', 'Admin', 'CEO'
exec uspEditServicesSpecialtyBillCustomFee 'REV', '39SUR', 'CM00135', 110000, '49UGX', 'Admin', 'CEO'
exec uspEditServicesSpecialtyBillCustomFee 'REV', '39PED', '100041A', 120, '49USD', 'Admin', 'CEO'

exec uspEditServicesSpecialtyBillCustomFee '10C02', '39PED', 'CM00135', 80, '49USD', 'Admin', 'CEO'

******************************************************************************************************/

-- select * from ServicesSpecialtyBillCustomFee
-- delete from ServicesSpecialtyBillCustomFee

-------------- Get ServicesSpecialtyBillCustomFee -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetServicesSpecialtyBillCustomFee')
	drop proc uspGetServicesSpecialtyBillCustomFee
go

create proc uspGetServicesSpecialtyBillCustomFee(
@ServiceCode varchar(10),
@DoctorSpecialtyID varchar(10) = null,
@AccountNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@DoctorSpecialtyID is null) and not (@AccountNo is null))
begin
--if not exists(select ServiceCode from ServicesSpecialtyBillCustomFee where ServiceCode = @ServiceCode 
--								and DoctorSpecialtyID = @DoctorSpecialtyID and AccountNo = @AccountNo)
--	begin
--		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Doctor Specialty', @DoctorSpecialtyID, 'Account No', @AccountNo, 'Services Specialty Bill Custom Fee')
--		return 1
--	end
--	else
	begin
		select ServiceCode, DoctorSpecialtyID, AccountNo, CustomFee, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency
		from ServicesSpecialtyBillCustomFee
		where ServiceCode = @ServiceCode and DoctorSpecialtyID = @DoctorSpecialtyID and AccountNo = @AccountNo
	end
end
else if (@DoctorSpecialtyID is null and @AccountNo is null)
	begin
		select ServiceCode, DoctorSpecialtyID, AccountNo, CustomFee, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency
		from ServicesSpecialtyBillCustomFee
		where ServiceCode = @ServiceCode 
	end
return 0
go

/******************************************************************************************************************************
exec uspGetServicesSpecialtyBillCustomFee '10C'
exec uspGetServicesSpecialtyBillCustomFee '10C', '39PED', 'CM00135'
exec uspGetServicesSpecialtyBillCustomFee 'REV'
exec uspGetServicesSpecialtyBillCustomFee '10C02', '39PED', 'CM00135'

******************************************************************************************************************************/
-- select * from ServicesSpecialtyBillCustomFee
-- delete from ServicesSpecialtyBillCustomFee


------------------------------------------------------------------------------------------------------
-------------- ServicesStaffBillCustomFee ------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ServicesStaffBillCustomFee -------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditServicesStaffBillCustomFee')
	drop proc uspEditServicesStaffBillCustomFee
go

create proc uspEditServicesStaffBillCustomFee(
@ServiceCode varchar(10),
@StaffNo varchar(10),
@AccountNo varchar(20),
@CustomFee money,
@CurrenciesID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ServiceCode from Services where ServiceCode = @ServiceCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Services')	
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No',@StaffNo, 'Staff')	
		return 1
	end
	
if not exists(select AccountNo from BillCustomers where AccountNo = @AccountNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account No', @AccountNo, 'To-Bill Customers')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CurrenciesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrenciesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select ServiceCode from ServicesStaffBillCustomFee where ServiceCode = @ServiceCode and StaffNo = @StaffNo and AccountNo = @AccountNo)
	begin
		update ServicesStaffBillCustomFee 
		set CustomFee = @CustomFee, CurrenciesID = @CurrenciesID, LoginID = @LoginID, ClientMachine = @ClientMachine
		where ServiceCode = @ServiceCode and StaffNo = @StaffNo and AccountNo = @AccountNo
		return 0
	end
else
begin
insert into ServicesStaffBillCustomFee
(ServiceCode, StaffNo, AccountNo, CustomFee, CurrenciesID, LoginID, ClientMachine)
values
(@ServiceCode, @StaffNo, @AccountNo, @CustomFee, @CurrenciesID, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspEditServicesStaffBillCustomFee '10C', '007', 'CM00135', 100000, '49UGX', 'Admin', 'CEO'
exec uspEditServicesStaffBillCustomFee '10C', '022', 'CM00135', 150000, '49UGX', 'Admin', 'CEO'
exec uspEditServicesStaffBillCustomFee '10C', '023', '100041A', 180, '49USD', 'Admin', 'CEO'

exec uspEditServicesStaffBillCustomFee 'REV', '007', 'CM00135', 90000, '49UGX', 'Admin', 'CEO'
exec uspEditServicesStaffBillCustomFee 'REV', '025', 'CM00135', 110000, '49UGX', 'Admin', 'CEO'
exec uspEditServicesStaffBillCustomFee 'REV', '022', '100041A', 120, '49USD', 'Admin', 'CEO'

exec uspEditServicesStaffBillCustomFee '10C02', '007', 'CM00135', 80, '49USD', 'Admin', 'CEO'

******************************************************************************************************/

-- select * from ServicesStaffBillCustomFee
-- delete from ServicesStaffBillCustomFee

-------------- Get ServicesStaffBillCustomFee -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetServicesStaffBillCustomFee')
	drop proc uspGetServicesStaffBillCustomFee
go

create proc uspGetServicesStaffBillCustomFee(
@ServiceCode varchar(10),
@StaffNo varchar(10) = null,
@AccountNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@StaffNo is null) and not (@AccountNo is null))
begin

--if not exists(select ServiceCode from ServicesStaffBillCustomFee where ServiceCode = @ServiceCode 
--								and StaffNo = @StaffNo and AccountNo = @AccountNo)
--	begin
--		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Staff No', @StaffNo, 'Account No', @AccountNo, 'Services Staff Bill Custom Fee')
--		return 1
--	end
--	else

	begin
		select ServiceCode, StaffNo, dbo.GetStaffFullName(StaffNo) as StaffFullName, AccountNo, 
		CustomFee, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency
		from ServicesStaffBillCustomFee
		where ServiceCode = @ServiceCode and StaffNo = @StaffNo and AccountNo = @AccountNo
	end
end
else if (@StaffNo is null and @AccountNo is null)
	begin
		select ServiceCode, StaffNo, dbo.GetStaffFullName(StaffNo) as StaffFullName, AccountNo, 
		CustomFee, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency
		from ServicesStaffBillCustomFee
		where ServiceCode = @ServiceCode 
	end
return 0
go

/******************************************************************************************************************************
exec uspGetServicesStaffBillCustomFee '10C'
exec uspGetServicesStaffBillCustomFee '10C', '007', 'CM00135'
exec uspGetServicesStaffBillCustomFee 'REV'
exec uspGetServicesStaffBillCustomFee '10C02', '007', 'CM00135'

******************************************************************************************************************************/
-- select * from ServicesStaffBillCustomFee
-- delete from ServicesStaffBillCustomFee


------------------------------------------------------------------------------------------------------
-------------- ServicesSpecialtyCustomCode -----------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ServicesSpecialtyCustomCode ------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditServicesSpecialtyCustomCode')
	drop proc uspEditServicesSpecialtyCustomCode
go

create proc uspEditServicesSpecialtyCustomCode(
@ServiceCode varchar(10),
@DoctorSpecialtyID varchar(10),
@CustomCode varchar(20),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ServiceCode from Services where ServiceCode = @ServiceCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Services')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DoctorSpecialtyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Doctor Specialty',@DoctorSpecialtyID, 'Lookup Data')	
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select ServiceCode from ServicesSpecialtyCustomCode where ServiceCode = @ServiceCode and DoctorSpecialtyID = @DoctorSpecialtyID)
	begin
		update ServicesSpecialtyCustomCode set
		CustomCode = @CustomCode, LoginID = @LoginID, ClientMachine = @ClientMachine
		where ServiceCode = @ServiceCode and DoctorSpecialtyID = @DoctorSpecialtyID
		return 0
	end
else
begin
	insert into ServicesSpecialtyCustomCode
	(ServiceCode, DoctorSpecialtyID, CustomCode, LoginID, ClientMachine)
	values
	(@ServiceCode, @DoctorSpecialtyID, @CustomCode, @LoginID, @ClientMachine)
	return 0
end
go

/******************************************************************************************************
exec uspEditServicesSpecialtyCustomCode '10C', '39PED', 'CM00135', 'Admin', 'CEO'
exec uspEditServicesSpecialtyCustomCode '10C', '39SUR', 'CM00135', 'Admin', 'CEO'
exec uspEditServicesSpecialtyCustomCode '10C', '39PED', '100041A', 'Admin', 'CEO'

exec uspEditServicesSpecialtyCustomCode 'REV', '39PED', 'CM00135', 'Admin', 'CEO'
exec uspEditServicesSpecialtyCustomCode 'REV', '39SUR', 'CM00135', 'Admin', 'CEO'
exec uspEditServicesSpecialtyCustomCode 'REV', '39PED', '100041A', 'Admin', 'CEO'

exec uspEditServicesSpecialtyCustomCode '10C02', '39PED', 'CM00135', 'Admin', 'CEO'

******************************************************************************************************/

-- select * from ServicesSpecialtyCustomCode
-- delete from ServicesSpecialtyCustomCode

-------------- Get ServicesSpecialtyCustomCode -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetServicesSpecialtyCustomCode')
	drop proc uspGetServicesSpecialtyCustomCode
go

create proc uspGetServicesSpecialtyCustomCode(
@ServiceCode varchar(10),
@DoctorSpecialtyID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not @DoctorSpecialtyID is null)
	begin
	--if not exists(select ServiceCode from ServicesSpecialtyCustomCode where ServiceCode = @ServiceCode and DoctorSpecialtyID = @DoctorSpecialtyID)
	--	begin
	--		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
	--		raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Doctor Specialty', @DoctorSpecialtyID, 'Services Specialty Custom Code')
	--		return 1
	--	end
	--	else
		begin
			select ServiceCode, DoctorSpecialtyID, CustomCode from ServicesSpecialtyCustomCode
			where ServiceCode = @ServiceCode and DoctorSpecialtyID = @DoctorSpecialtyID
		end
	end

else if (@DoctorSpecialtyID is null)
	begin
		select ServiceCode, DoctorSpecialtyID, CustomCode from ServicesSpecialtyCustomCode
		where ServiceCode = @ServiceCode 
	end
return 0
go

/******************************************************************************************************************************
exec uspGetServicesSpecialtyCustomCode '10C'
exec uspGetServicesSpecialtyCustomCode '10C', '39PED'
exec uspGetServicesSpecialtyCustomCode 'REV'
exec uspGetServicesSpecialtyCustomCode '10C02', '39PED'

******************************************************************************************************************************/
-- select * from ServicesSpecialtyCustomCode
-- delete from ServicesSpecialtyCustomCode


------------------------------------------------------------------------------------------------------
-------------- ItemsBalanceDetails -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ItemsBalanceDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertItemsBalanceDetails')
	drop proc uspInsertItemsBalanceDetails
go

create proc uspInsertItemsBalanceDetails(
@VisitNo Varchar(20),
@ItemCode Varchar(20),
@ItemCategoryID varchar(10),
@Balance int,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @NextVisitNo Varchar(20)
declare @ItemStatusPending varchar(10) 

set @NextVisitNo = @VisitNo
set @ItemStatusPending = dbo.GetLookupDataID('ItemStatus','P')

if not exists(select VisitNo from visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'visits')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCategoryID', @ItemCategoryID, 'Lookup Data')
		return 1
	end


if not exists(select VisitNo from visits where VisitNo  = @NextVisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'nextVisitNo', @nextVisitNo, 'Lookup Data')
		return 1
	end

else if not exists(select VisitNo from ItemsBalanceDetails where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin			
			insert into ItemsBalanceDetails
			(VisitNo, ItemCode, ItemCategoryID, ItemName, Balance, BalanceStatus, NextVisitNo, LoginID, ClientMachine)
			values
			(@VisitNo, @ItemCode, @ItemCategoryID, dbo.GetItemName(@ItemCategoryID, @ItemCode), @Balance, @ItemStatusPending, @nextVisitNo, @LoginID, @ClientMachine)
		
	return 0
end
go

/******************************************************************************************************
exec uspInsertItemsBalanceDetails
******************************************************************************************************/
-- select * from ItemsBalanceDetails
-- delete from ItemsBalanceDetails


---------------- Update ItemsBalanceDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateItemsBalanceDetails')
	drop proc uspUpdateItemsBalanceDetails
go

create proc uspUpdateItemsBalanceDetails(
@VisitNo Varchar(20),
@ItemCode Varchar(20),
@ItemCategoryID varchar(10),
@NextVisitNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ItemStatusOffered varchar(10) 
set @ItemStatusOffered = dbo.GetLookupDataID('ItemStatus','O')

--if not exists(select VisitNo from ItemsBalanceDetails where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
--	begin
--		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'ItemsBalanceDetails')
--		return 1
--	end

if  exists(select VisitNo from ItemsBalanceDetails where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
begin
update ItemsBalanceDetails set
BalanceStatus = @ItemStatusOffered, NextVisitNo = @NextVisitNo
where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspUpdateItemsBalanceDetails
******************************************************************************************************/
-- select * from ItemsBalanceDetails
-- delete from ItemsBalanceDetails


-------------- Get ItemsBalanceDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetItemsBalanceDetails')
	drop proc uspGetItemsBalanceDetails
go

create proc uspGetItemsBalanceDetails(
@VisitNo Varchar(20),
@ItemCode Varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from ItemsBalanceDetails where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'ItemsBalanceDetails')
		return 1
	end
else
begin
	select VisitNo, ItemCode, ItemCategoryID, ItemName, Balance, BalanceStatus, NextVisitNo, LoginID, ClientMachine
	from ItemsBalanceDetails

	where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetItemsBalanceDetails
******************************************************************************************************/
-- select * from ItemsBalanceDetails
-- delete from ItemsBalanceDetails------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
-------------- PackageConsumption --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PackageConsumption -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPackageConsumption')
	drop proc uspInsertPackageConsumption
go

create proc uspInsertPackageConsumption(
@VisitNo varchar(20),
@PackageNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ItemStatusID varchar(10),
@Quantity int,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @PackageVisitNo varchar(20)

----------------------------------------------------------------------------------------------------------------
set @PackageVisitNo = (select top 1 PackageVisitNo from PackageVisits where VisitNo = @VisitNo
and PackageNo = @PackageNo)
----------------------------------------------------------------------------------------------------------------
 
if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if not exists(select PackageNo from Packages where PackageNo  = @PackageNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PackageNo', @PackageNo, 'Packages')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCategoryID', @ItemCategoryID, 'Lookup Data')
		return 1
	end



if not exists(select DataID from LookupData where DataID = @ItemStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemStatusID', @ItemStatusID, 'Lookup Data')
		return 1
	end

begin
insert into PackageConsumption
(VisitNo,PackageVisitNo,PackageNo, ItemCode, ItemCategoryID, ItemStatusID, Quantity, LoginID)
values
(@VisitNo,@PackageVisitNo, @PackageNo, @ItemCode, @ItemCategoryID, @ItemStatusID, @Quantity, @LoginID)
return 0
end
go


/******************************************************************************************************
exec uspInsertPackageConsumption
******************************************************************************************************/
-- select * from PackageConsumption
-- delete from PackageConsumption


-------------- Update PackageConsumption -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePackageConsumption')
	drop proc uspUpdatePackageConsumption
go

create proc uspUpdatePackageConsumption(
@VisitNo varchar(20),
@PackageNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ItemStatusID varchar(10),
@Quantity int,
@LoginID varchar(20),
@ClientMachine varchar(41),
@RecordDateTime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select DataID from LookupData where DataID = @ItemStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemStatusID', @ItemStatusID, 'Lookup Data')
		return 1
	end

begin
update PackageConsumption set
ItemStatusID = @ItemStatusID,Quantity = @Quantity, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
where VisitNo = @VisitNo and PackageNo = @PackageNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspUpdatePackageConsumption
******************************************************************************************************/
-- select * from PackageConsumption
-- delete from PackageConsumption


-------------- Get PackageConsumption -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPackageConsumption')
	drop proc uspGetPackageConsumption
go

create proc uspGetPackageConsumption(
@VisitNo varchar(20),
@PackageNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from PackageConsumption where VisitNo = @VisitNo and PackageNo = @PackageNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'PackageNo', @PackageNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'PackageConsumption')
		return 1
	end
else
begin
	select VisitNo, PackageNo, ItemCode, ItemCategoryID, ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as [ItemStatusID], Quantity, LoginID, ClientMachine, RecordDateTime
	from PackageConsumption

	where VisitNo = @VisitNo and PackageNo = @PackageNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetPackageConsumption
******************************************************************************************************/
-- select * from PackageConsumption
-- delete from PackageConsumption



-------- Get Packages Item Unit Price-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPackageItemUnitPrice')
	drop proc uspGetPackageItemUnitPrice
go

create proc uspGetPackageItemUnitPrice(
@PackageNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@UnitPrice money = null output
)with encryption as

declare @ErrorMSG varchar(200)

----------------------------------------------------------------------------------------------
begin set @UnitPrice = (select TOP 1 UnitPrice from PackagesEXT where PackageNo =@PackageNo and ItemCode =@ItemCode and ItemCategoryID =@ItemCategoryID) end
----------------------------------------------------------------------------------------------

return 0

go
-- select * from PackagesEXT 
-- exec uspGetPackageItemUnitPrice '001','009','7p'


------------- Items ----------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Items---------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertItems')
	drop proc uspInsertItems
go

create proc uspInsertItems(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Quantity int,
@UnitPrice money,
@ItemDetails varchar(800),
@LastUpdate smalldatetime,
@ItemStatusID varchar(10),
@PayStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40) = null,
@CreatorLoginID varchar(20),
@CreatorClientMachine varchar(40)

)with encryption as 

declare @ErrorMSG varchar(200)
declare @InWardAdmissionStatusID varchar(10)
declare @ItemStatus varchar(10)
declare @PayStatus  varchar(10)

declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

declare @PatientNo varchar(20)

declare @BillModesID varchar(10)
declare @BillNo varchar(20)
declare @InsuranceNo varchar(20)
declare @CompanyNo varchar(20)
declare @PolicyNo varchar(20)

declare @UnitCost money
declare @VisitLockedStatus varchar(20)

declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)
declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)
declare @PackageID varchar(10)
declare @ItemName varchar(800)
declare @UnitMeasure varchar(100)
declare @VATValue money
declare @PackageNo varchar(20)
declare @PackageQuantity int
declare @ServiceFee varchar(10)
declare @PackageVisitNo varchar(20)
declare @PackageRemainingQuantity varchar(20)
declare @ConclusionDate smallDateTime =null


set @InWardAdmissionStatusID = dbo.GetLookupDataID('AdmissionStatus', 'I')
set @ServiceFee =('SF')
set @ItemStatus = dbo.GetLookupDataID('ItemStatus', 'P')
set @PayStatus = dbo.GetLookupDataID('PayStatus', 'NP')

set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')

set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')
set @PackageID = dbo.GetLookupDataID('ItemCategory', 'G')
------------------------------------------------------------------------------------------------------------
set @ItemName = dbo.GetItemName(@ItemCategoryID, @ItemCode)
set @UnitMeasure = dbo.GetUnitMeasure(@ItemCategoryID,@ItemCode)
------------------------------------------------------------------------------------------------------------
set @UnitCost = dbo.GetItemUnitCost(@ItemCategoryID, @ItemCode)
if  (@ClientMachine is null or @ClientMachine = '') begin set @ClientMachine = host_name() end

if (@ItemCategoryID = @ExtrasID) begin set @ConclusionDate = Getdate() end
------------------------------------------------------------------------------------------------------------
set @BillModesID =(select BillModesID from Visits where VisitNo = @VisitNo)
set @BillNo = (select BillNo from Visits where VisitNo = @VisitNo)
set @InsuranceNo = (select InsuranceNo from Visits where VisitNo = @VisitNo)

set @CompanyNo = (select CompanyNo from SchemeMembers where MedicalCardNo = @BillNo)
set @PolicyNo = (select PolicyNo from SchemeMembers where MedicalCardNo = @BillNo)

set @VATValue=dbo.GetVATValue(@ItemCategoryID, @ItemCode, @Quantity,@UnitPrice) 

------------------------------------------------------------------------------------------------------------
set @PackageNo = (select Top 1 PackageNo from PackageVisits where VisitNo = @VisitNo)

set @PackageVisitNo = (select Top 1 PackageVisitNo from PackageVisits where VisitNo = @VisitNo
and PackageNo = @PackageNo)

set @PackageRemainingQuantity= dbo.GetPackageRemainingQuantities(@PackageVisitNo,@PackageNo,@ItemCode,@ItemCategoryID)



------------------------------------------------------------------------------------------------------------

if exists(select AdmissionNo from Admissions where Admissions.VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, is known to have an admission.Please use IPD Doctor to enter the Patient Record!.'
		raiserror(@ErrorMSG, 16, 1, 'Patient with No', @VisitNo)	
		return 1
	end
----------------------------------------------------------------------------------------------------------------------------------------

if (@DrugID = @ItemCategoryID) and (exists(select PatientNo from PatientAllergies
	inner join AllergyDrugs on PatientAllergies.AllergyNo = AllergyDrugs.AllergyNo 
	where PatientNo = (select PatientNo from Visits where VisitNo = @VisitNo) and DrugNo = @ItemCode))
	begin
		set @PatientNo = (select top 1 PatientNo from PatientAllergies
			inner join AllergyDrugs on PatientAllergies.AllergyNo = AllergyDrugs.AllergyNo 
			where PatientNo = (select PatientNo from Visits where VisitNo = @VisitNo) and DrugNo = @ItemCode)
		set @ErrorMSG = 'Patient No: %s, is allergic to Drug No: %s, you can’t prescribe this drug'
		raiserror(@ErrorMSG,16,1, @PatientNo, @ItemCode)	
		return 1
	end

----------------------------------------------------------------------------------------------------------------------------------------

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @ServiceID)-- Services
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Service Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @ServiceID)-- Services
	begin	
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Service Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Service Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @DrugID)-- Drugs
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @DrugID)-- Drugs
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @ConsumableID)-- Consumable Items
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @ConsumableID)-- Consumable Items
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @ProcedureID)-- Procedure
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @ProcedureID)-- Procedure
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end	
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @DentalID)-- Dental
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Dental Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @DentalID)-- Dental
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Dental Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Dental Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @TheatreID)-- Theatre
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @TheatreID)-- Theatre
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @OpticalID)-- Optical
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Optical Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @OpticalID)-- Optical
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Optical Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Optical Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @MaternityID)-- Maternity
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @MaternityID)-- Maternity
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @ICUID)-- ICU
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @ICUID)-- ICU
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @TestID)-- Test
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Test Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @TestID)-- Test
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Test Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Test Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else


if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @CardiologyID)-- Cardiology
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Cardiology Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @CardiologyID)-- Cardiology
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Cardiology Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Cardiology Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else


if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @RadiologyID)-- Radiology
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Radiology Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @RadiologyID)-- Radiology
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Radiology Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Radiology Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @PathologyID)-- Pathology
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Pathology Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @PathologyID)-- Pathology
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Pathology Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Pathology Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @EyeID)-- Eye
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Eye Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @EyeID)-- Eye
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Eye Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Eye Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @AdmissionID)-- Admission
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Bed No', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @AdmissionID)-- Admission
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Bed No', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Bed No', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @ExtrasID)-- Extras
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Extra Item Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @ExtrasID)-- Extras
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Extra Item Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Extra Item Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end


----------------------------------------------------------------------------------------------------------------------------------------

---- Check if Quantity given is in range with Package Quantity

if not (@PackageNo is null or @PackageNo = '') and not (@Quantity is null or @Quantity = '') And (dbo.GetIsPackageLimited(@PackageNo) > 0)
begin

if exists(select ItemCode from PackagesEXT where PackageNo =@PackageNo and ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode)
begin

set @PackageQuantity= (select Quantity from PackagesEXT where PackageNo =@PackageNo and ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode)

if  (@Quantity > @PackageQuantity)
begin
set @ErrorMSG = 'The %s: %s, you are trying to enter has Quantities exceeding the Package defined quantities. You Can''t save this record'
raiserror(@ErrorMSG,16,1,'Item Code',@ItemCode,'Packages')	
return 1

end
end
end


----------------------------------------------------------------------------------------------------------------------------------------

---- Check if Quantity given doesn't exceed  Package Quantity

if not (@PackageNo is null or @PackageNo = '') and not (@Quantity is null or @Quantity = '') and not (@ItemCode=@ServiceFee)
begin

if exists(select ItemCode from PackagesEXT where PackageNo =@PackageNo and ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode)
begin

if exists (select Top 1 PatientNo from PackageCheck where PackageNo =@PackageNo and PackageVisitNo =@PackageVisitNo)
begin

if  (@Quantity > @PackageRemainingQuantity)
begin
set @ErrorMSG = 'The %s: %s, you are trying to enter has ' +  (cast(@PackageRemainingQuantity as varchar(20))) + ' Remaining quantity on this Package You Can''t save this record'
raiserror(@ErrorMSG,16,1,'Item Code',@ItemCode,'Packages')
	
return 1

end
end
end
end
----------------------------------------------------------------------------------------------------------------------------------------

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered Visits'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

----------------------------------------------------------------------------------------------------------
-- Ensure that Invoice is not Created already

set @VisitLockedStatus = (select TOP 1 PayNo from Invoices where PayNo = @VisitNo)
	
if (dbo.GetOptionValue('LockVisitUponInvoiceCreation') > 0) and (len(@VisitLockedStatus) > 0) 
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to add Items to has an Existing Invoice and is Locked please Contact the administrator'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end
----------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The Item Category ID: ' + @ItemCategoryID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end
		
if (dbo.GetShortDate(@LastUpdate) > GetDate())
	begin		
		set @ErrorMSG = 'The %s: ' + ltrim(rtrim(dbo.FormatDate(dbo.GetShortDate(@LastUpdate)))) + ', you are trying to enter can''t be ahead of today’s date as set by server administrator'
		raiserror(@ErrorMSG, 16, 1, 'Last Update')
	 	return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemStatusID)
	begin
		set @ErrorMSG = 'The Item Status ID: ' + @ItemStatusID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayStatusID)
	begin
		set @ErrorMSG = 'The Pay Status ID: ' + @PayStatusID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end
if not exists(select LoginID from Logins where LoginID = @CreatorLoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @CreatorLoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end


if exists(select VisitNo from Items where VisitNo = @VisitNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		if  exists(select VisitNo from Items where VisitNo = @VisitNo and  ItemCode = @ItemCode and
			ItemCategoryID = @ItemCategoryID and ItemStatusID = @ItemStatus and PayStatusID = @PayStatus  and len(InvoiceNo) < 1) 
			
		begin
			update Items set
			Quantity = @Quantity, UnitCost = @UnitCost, UnitPrice = @UnitPrice, VATValue=@VATValue, ItemDetails = @ItemDetails, LastUpdate = @LastUpdate, 
			ItemStatusID = @ItemStatusID, PayStatusID = @PayStatusID, LoginID  = @LoginID, ClientMachine = @ClientMachine,
			ItemName=@ItemName,UnitMeasure=@UnitMeasure
			where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID

			if not (@PackageNo is null or @PackageNo = '')
            begin
            update PackageConsumption set
            ItemStatusID = @ItemStatusID,Quantity = @Quantity, LoginID = @LoginID
            where VisitNo = @VisitNo and PackageNo = @PackageNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
            end
		
			return 0
		end
		else

		if  not (@ItemCode=@ServiceFee)

		begin

		set @ErrorMSG = 'The record with %s: %s and  %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', is not pending or has been invoiced or paid for. You can''t update this record!'
		raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo, 'Item Code', @ItemCode , 'Item Category')
			
		end
		return 0
	end

else

begin

-----------------------------------------------------------------------------------------------------------------------------------------------------------------

insert into Items
(VisitNo, ItemCode,ItemName,UnitMeasure, ItemCategoryID, Quantity, UnitCost, UnitPrice,  VATValue,ItemDetails, 
LastUpdate, ItemStatusID, PayStatusID, OriginalQuantity, OriginalPrice,ConclusionDate, LoginID, ClientMachine,CreatorLoginID,CreatorClientMachine) 
values
(@VisitNo, @ItemCode,@ItemName,@UnitMeasure,@ItemCategoryID, @Quantity, @UnitCost, @UnitPrice, @VATValue,@ItemDetails, 
@LastUpdate, @ItemStatusID,@PayStatusID,  @Quantity, @UnitPrice,@ConclusionDate, @LoginID, @ClientMachine,@CreatorLoginID,@CreatorClientMachine)

------------------------------------------------------------------------------------------------------------------------------------------------------------------

if not (@PackageNo is null or @PackageNo = '') and not (@ItemCategoryID =@PackageID)
begin

exec uspInsertPackageConsumption @VisitNo, @PackageNo, @ItemCode, @ItemCategoryID, @ItemStatusID, @Quantity, @LoginID

end
return 0
end
go

/*******************************************************************************************
--1-----------------------------------------------------------------------------------------
exec uspInsertItems '0600001001', '10C', '7S', 1, 500, '1 X 4', '12 Nov 2005', '11P','12NP', 'Admin'
*******************************************************************************************/

-- select * from Items
-- delete from Items
-- select * from visits

-----------------Update Items--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateItems')
	drop proc uspUpdateItems
go

create proc uspUpdateItems(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@LastUpdate smalldatetime ,
@PayStatusID varchar(10) = null,
@LoginID varchar(20),
@ItemStatusID varchar(10) = null,
@ClientMachine varchar(40) =  null
)with encryption as 

declare @ErrorMSG varchar(200)

declare @NotPaidPayStatus  varchar(10)
declare @DrugItemCategoryID  varchar(10)
declare @ConsumableItemCategoryID varchar(10)
declare @ProcedureItemCategoryID  varchar(10)
declare @TheatreItemCategoryID  varchar(10)
declare @PendingItemStatusID varchar(10)
declare @Quantity int
declare @UnitPrice money
declare @CopayAmount money
declare @ItemName varchar(500)


declare @PercentCoPayTypeID varchar(10)
declare @CoPayTypeID varchar(10)
declare @CoPayPercent decimal(5,2)
declare @ItemOfferedID varchar(10)
declare @ItemDoneID varchar(10)
declare @ValueCoPayTypeID as varchar(10)
declare @ServiceID as varchar(10)
declare @VATValue as money
declare @PackageNo varchar(20)
declare @PackageVisitNo varchar(20)
declare @ConclusionDate smallDateTime
declare @PayDate smallDateTime

set @NotPaidPayStatus = dbo.GetLookupDataID('PayStatus', 'NP')
set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TheatreItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'H')
set @PendingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')

set @PercentCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'PCT')
set @ValueCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'VAL')
set @ItemOfferedID = dbo.GetLookupDataID('ItemStatus', 'O')
set @ItemDoneID = dbo.GetLookupDataID('ItemStatus', 'D')
set @ServiceID =  dbo.GetLookupDataID('ItemCategory', 'S')
set @ConclusionDate = getdate()
set @PayDate =getdate()
set @PackageNo = (select TOP 1 PackageNo from PackageVisits where VisitNo = @VisitNo)

----------------------------------------------------------------------------------------------- 
set @PackageVisitNo = (select Top 1 PackageVisitNo from PackageVisits where VisitNo = @VisitNo
and PackageNo = @PackageNo)

-----------------------------------------------------------------------------------------------
if  (@ClientMachine is null or @ClientMachine = '') begin set @ClientMachine = host_name() end
-----------------------------------------------------------------------------------------------

if not exists(select VisitNo from Items where VisitNo = @VisitNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with Visit No: %s and Item Code: %s and Item Category: %s, does not  exist in registered items'
		raiserror(@ErrorMSG,16,1, @VisitNo, @ItemCode, @ItemCategoryID)	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end
else

if (@ItemStatusID is null)
begin

	if not exists(select VisitNo from Items where VisitNo = @VisitNo and ItemCode = @ItemCode 
				  and ItemCategoryID = @ItemCategoryID and PayStatusID = @NotPaidPayStatus)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', is already ' + dbo.GetLookupDataDes(@PayStatusID) + ''
			raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category')	
			return 1
		end

	if not exists(select DataID from LookupData where DataID = @PayStatusID)
		begin
			set @ErrorMSG = 'The Pay Status ID: ' + @PayStatusID + ', you are trying to enter does not exist in the registered Lookup Data'
			raiserror(@ErrorMSG,16,1)	
			return 1
		end



	update Items 
	set LastUpdate = @LastUpdate, PayStatusID = @PayStatusID, LoginID = @LoginID, ClientMachine = @ClientMachine,PayDate =@PayDate
	where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
end

else
begin

if (@ItemCategoryID = @DrugItemCategoryID or @ItemCategoryID = @ProcedureItemCategoryID 
	or @ItemCategoryID = @TheatreItemCategoryID or @ItemCategoryID = @ConsumableItemCategoryID)
	begin	
		if not exists(select VisitNo from Items where VisitNo = @VisitNo and ItemCode = @ItemCode 
					  and ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID)
			begin
				set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', is already ' + dbo.GetLookupDataDes(@ItemStatusID) + ''
				raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category')	
				return 1
			end
	end

if not exists(select DataID from LookupData where DataID = @ItemStatusID)
	begin
		set @ErrorMSG = 'The Item Status ID: ' + @ItemStatusID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG, 16, 1)	
		return 1
	end

if exists(select VisitNo from RefundDetails where VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
		set @ErrorMSG = 'The record with Visit No: %s and Item Code: %s and Item Category: %s,you are trying to enter has been Refunded!!, You can''t Proceed!!'
		raiserror(@ErrorMSG,16,1, @VisitNo, @ItemCode, @ItemCategoryID)	
		return 1
end	

begin tran
update Items set 
	LastUpdate = @LastUpdate, LoginID = @LoginID, ItemStatusID = @ItemStatusID, ClientMachine = @ClientMachine
	where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID

---------------------------------------------------------------------------------------------------------------------------------
if not (@PackageNo is null or @PackageNo = '')
begin

update PackageConsumption set
ItemStatusID = @ItemStatusID,LoginID = @LoginID,PackageVisitNo=@PackageVisitNo
where VisitNo = @VisitNo and PackageNo = @PackageNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
end


set @CoPayTypeID = (select CoPayTypeID from Visits where VisitNo = @VisitNo)
set @ItemName = dbo.GetItemName(@ItemCategoryID, @ItemCode)
set @Quantity = (select Quantity from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
set @UnitPrice = (select UnitPrice from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)

---------------------------------------------------------------------------------------------------------------------------------

if not exists(select VisitNo from ItemsIncome where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
begin

if (@CoPayTypeID = @PercentCoPayTypeID) and  (@ItemStatusID = @ItemOfferedID or @ItemStatusID = @ItemDoneID)
begin

set @CoPayPercent = (select CoPayPercent from Visits where VisitNo = @VisitNo)
set @CopayAmount = (@Quantity * @UnitPrice * @CoPayPercent)/100
set @CopayAmount = isnull(@CopayAmount, 0)
set @UnitPrice = (@UnitPrice - @CopayAmount)
set @VATValue=dbo.GetVATValue(@ItemCategoryID, @ItemCode, @Quantity,@UnitPrice)


insert into ItemsIncome
(VisitNo, ItemCode, ItemCategoryID, ItemName, UnitPrice, CopayAmount, Quantity, VATValue,LoginID, ClientMachine)
values
(@VisitNo, @ItemCode, @ItemCategoryID, @ItemName, @UnitPrice, @CopayAmount, @Quantity, @VATValue, @LoginID, @ClientMachine)
end

---------------------------------------------------------------------------------------------------------------------------------
else

if ((@CoPayTypeID = @ValueCoPayTypeID) and  (@ItemStatusID = @ItemOfferedID) and (@ServiceID = @ServiceID))
begin

set @ValueCoPayTypeID = (select CoPayValue from Visits where VisitNo = @VisitNo)
set @CopayAmount = (@ValueCoPayTypeID)
set @CopayAmount = isnull(@CopayAmount, 0)
set @UnitPrice = (@UnitPrice - @CopayAmount)
set @VATValue=dbo.GetVATValue(@ItemCategoryID, @ItemCode, @Quantity,@UnitPrice) 
insert into ItemsIncome

(VisitNo, ItemCode, ItemCategoryID, ItemName, UnitPrice, CopayAmount, Quantity, VATValue,LoginID, ClientMachine)
values
(@VisitNo, @ItemCode, @ItemCategoryID, @ItemName, @UnitPrice, @CopayAmount, @Quantity, @VATValue,@LoginID, @ClientMachine)
end
---------------------------------------------------------------------------------------------------------------------------------

else
if (@ItemStatusID = @ItemOfferedID or @ItemStatusID = @ItemDoneID)
begin
set @CopayAmount = 0
set @VATValue=dbo.GetVATValue(@ItemCategoryID, @ItemCode, @Quantity,@UnitPrice)

---------------------------------------------------------------------------------------
update Items set ConclusionDate = @ConclusionDate
where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID	
---------------------------------------------------------------------------------------
 
insert into ItemsIncome
(VisitNo, ItemCode, ItemCategoryID, ItemName, UnitPrice, CopayAmount, Quantity, VATValue,LoginID, ClientMachine)
values
(@VisitNo, @ItemCode, @ItemCategoryID, @ItemName, @UnitPrice, @CopayAmount, @Quantity,@VATValue, @LoginID, @ClientMachine)
end
end

---------------------------------------------------------------------------------------------------------------------------------


if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
return 0
end

go


------------select* from ItemsIncome



--------GetCountPeriodicNotCashPaidItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCountPeriodicNotCashPaidItems')
	drop proc uspGetCountPeriodicNotCashPaidItems
go

create proc uspGetCountPeriodicNotCashPaidItems(
@StartDate smalldatetime,
@EndDate smalldatetime,
@CountedItems int = null output
)with encryption as

declare @CashBillModesID varchar(10)

declare @NotPaidPayStatusID varchar(10)
declare @CopayPayments int
--------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')


set @CopayPayments = (select  count(*) from Items
			inner join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
			and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			
			where CashPayStatusID = @NotPaidPayStatusID	and VisitDate between @StartDate and @EndDate)
--------------------------------------------------------------------------

 set @CountedItems=  (select (count(*)+@CopayPayments) 
   from Items 
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @CashBillModesID 
			 and VisitDate between @StartDate and @EndDate)
			
	return 0
go


--- exec uspGetCountPeriodicNotCashPaidItems 'Jun 19 2018', 'Jun 20 2018'

--------GetCountToRefundRequests----------------------------------------------------------------------------------------------------------------


if exists (select * from sysobjects where name = 'uspGetCountToRefundRequests')
	drop proc uspGetCountToRefundRequests
go

create proc uspGetCountToRefundRequests(
@ToRefuntCount int = null output
)with encryption as

declare @PendingRequestStatusID varchar(10)
declare @PendingApprovalStatusID  varchar(10)
declare @ApprovalStatusID  varchar(10)

set @PendingRequestStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @PendingApprovalStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @ApprovalStatusID = dbo.GetLookupDataID('ItemStatus', 'A')

begin

if not (dbo.GetOptionValue('ForceRefundsApproval') > 0)

begin
	set @ToRefuntCount = (select count(*)
	from RefundRequests where RefundRequests.RequestStatusID = @PendingRequestStatusID and ApprovalStatusID=@PendingApprovalStatusID)
	end
	else
	begin
		set @ToRefuntCount = (select count(*) from RefundRequests
	    where RefundRequests.RequestStatusID = @PendingRequestStatusID and ApprovalStatusID=@ApprovalStatusID) 
	--and RefundRequests.RequestStatusID not in (Select RequestStatusID from Refunds))
	end
	end
return 0
go



--- exec uspGetCountToRefundRequests

------------------------------------------------------------------------------------------------------------------------------------------------------------

--------GetPeriodicCashNotPaidItemsSummary----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicCashNotPaidItemsSummary')
	drop proc uspGetPeriodicCashNotPaidItemsSummary
go

create proc uspGetPeriodicCashNotPaidItemsSummary(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

declare @CashBillModesID varchar(10)
declare @ServicePointID varchar(10)

declare @NotPaidPayStatusID varchar(10)
declare @CopayPayments int
--------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @ServicePointID = dbo.GetLookupDataID('ServicePoint', 'CAS')



begin
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, Quantity, UnitPrice,
			Quantity * UnitPrice as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime
	
			from Items 
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			left outer join Queues  on Queues.VisitNo = Visits.VisitNo and ServicePointID = @ServicePointID and QueueStatus = 1
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @CashBillModesID 
			 and VisitDate between @StartDate and @EndDate
			union
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, Quantity, UnitPrice,
			Quantity * UnitPrice as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(CashPayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime
	
			from Items
			inner join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
			and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			left outer join Queues  on Queues.VisitNo = Visits.VisitNo and ServicePointID = @ServicePointID and QueueStatus = 1
			where CashPayStatusID = @NotPaidPayStatusID	and VisitDate between @StartDate and @EndDate order by TokenNo asc
end	
	return 0
go

---- exec uspGetPeriodicCashNotPaidItemsSummary 'Jun 14 2018', 'Jun 15 2018'


------------------------------------------------------------------------------------------------------------------------------------------------------------

--------GetCashNotPaidItemsSummary----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCashNotPaidItemsSummary')
	drop proc uspGetCashNotPaidItemsSummary
go

create proc uspGetCashNotPaidItemsSummary
with encryption as

declare @CashBillModesID varchar(10)
declare @ServicePointID varchar(10)

declare @NotPaidPayStatusID varchar(10)
declare @CopayPayments int
--------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @ServicePointID = dbo.GetLookupDataID('ServicePoint', 'CAS')



begin
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, Quantity, UnitPrice,
			Quantity * UnitPrice as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime
	
			from Items 
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			left outer join Queues  on Queues.VisitNo = Visits.VisitNo and ServicePointID = @ServicePointID and QueueStatus = 1
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @CashBillModesID 
			union
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, Quantity, UnitPrice,
			Quantity * UnitPrice as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(CashPayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime
	
			from Items
			inner join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
			and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			left outer join Queues  on Queues.VisitNo = Visits.VisitNo and ServicePointID = @ServicePointID and QueueStatus = 1
			where CashPayStatusID = @NotPaidPayStatusID order by TokenNo asc
end	
	return 0
go

---- exec uspGetCashNotPaidItemsSummary


--------GetSales----------------------------------------------------------------------------------------------------------------

--------GetSales----------------------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetSales')
	drop proc uspGetSales
go

create proc uspGetSales(
@StartDateTime smalldatetime=null,
@EndDateTime smalldatetime = null,
@BranchID varchar(10)=null,
@ItemCategoryID varchar(10) = null,
@ItemCode varchar(10)=null,
@BillModesID varchar(10) =null,
@PayStatusID varchar(10) =null,
@LoginID varchar(20) = null

)with encryption as

declare @ErrorMSG varchar(200)
declare @ItemOfferedID varchar(10)
declare @ItemDoneID varchar(10)
declare @PaymentStatusID varchar(10)

set @ItemOfferedID = dbo.GetLookupDataID('ItemStatus', 'O')
set @ItemDoneID = dbo.GetLookupDataID('ItemStatus', 'D')
set @PaymentStatusID = dbo.GetLookupDataID('PayStatus', 'PF')


	------------------------------------------------------------All selected---------------------------------------------------------------
	if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, 
			UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost,  Quantity,(UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,
			BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
			PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,
			Items.LoginID
			from Items
			inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end


		--only five Items Selected (only one not selected)-------------------------------------------------------------------------------
		---------------------------------------------------------------------------------------------------------------------------------
		  
		  ------------------------------------------------------------only BranchID not selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,
			UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		 ------------------------------------------------------------only ItemCategoryID not selected---------------------------------------------------------------
	else if  not (@BranchID is null) and  (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,
			UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		 ------------------------------------------------------------Only ItemCode---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and  BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------only BillMode null---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and  (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno 
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode 
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only PayStatus null---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only LoginID null---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------All selected---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID,  dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end
		--only five Items Selected (only one not selected) End---------------------------------------------------------------------------
		---------------------------------------------------------------------------------------------------------------------------------

		--only four Items Selected (only two not selected) ---------------------------------------------------------------------------
		---------------------------------------------------------------------------------------------------------------------------------
		------------------------------------------------------------BranchID and ItemCategory not selected---------------------------------------------------------------
	else if  (@BranchID is null) and(@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID,  dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end
		------------------------------------------------------------Only BranchID and ItemCode not selected-------------------------------------------------------
	else if (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			 and ItemCategoryID=@ItemCategoryID and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only BranchID and BillMode not selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode 
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only BranchID and PayStatus---------------------------------------------------------------
	else if (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only Branch and LoginID not selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID 
			order by Items.RecordDateTime asc
		end
		------------------------------------------------------------Only ItemCategory and ItemCode not selected---------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only ItemCategory and BillMode not selected---------------------------------------------------------------
	else if not (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and  (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCode=@ItemCode  
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only ItemCategory and PayStatus not sected---------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice, UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only ItemCategory and LoginID not selected---------------------------------------------------------------
	else if not (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID  and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------only ItemCode and BillMode not selected---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and  (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID 
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only ItemCode and PayStatus not selected--------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and BillModesID=@BillModesID 
			and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		-----------------------------------------------------------Only ItemCode and LoginID not selected---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only BillMode and PayStatus not selected---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

------------------------------------------------------------Only BillMode and Login------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode 
			and PayStatusID=@PayStatusID 
			order by Items.RecordDateTime asc
		end

		---------------------------------------------------------PayStatus and LoginID not selected---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			order by Items.RecordDateTime asc
		end

		--only four Items Selected (only two not selected)End ---------------------------------------------------------------------------
		---------------------------------------------------------------------------------------------------------------------------------

		--only 3 Items Selected (only 3 not selected) ---------------------------------------------------------------------------
		-------------------------------------------------------------------------------------------------------------------------
		-----------------------------------------------------------Branch and ItemCategory and ItemCode selected-----------------
	else if not(@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID,  dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode
			order by Items.RecordDateTime asc
		end


		---------------------------------------------------BranchID and ItemCategory BillMode selected-------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID,  dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and  BillModesID=@BillModesID 
			
			order by Items.RecordDateTime asc
		end
		--------------------------------------------------------BranchID and ItemCategory and PayStatus---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID 
			and PayStatusID=@PayStatusID 
			order by Items.RecordDateTime asc
		end

		-------------------------------------------------------Only BranchID  and ItemCategory and LoginID -----------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID
			and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end
		
		------------------------------------------------------------BranchID and ItemCode and BillMode  selected---------------------------------------------------------------
	else if not (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID  and ItemCode=@ItemCode and BillModesID=@BillModesID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------BranchID, ItemCode and PayStatus---------------------------------------------------------------
	else if not (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCode=@ItemCode 
			and PayStatusID=@PayStatusID
			order by Items.RecordDateTime asc
		end


		------------------------------------------------------------Only BranchID,ItemCode and Login selected--------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and  (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID  and ItemCode=@ItemCode and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end
		------------------------------------------------------------Only BranchID, BillMode and PayStatus selected---------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and BillModesID=@BillModesID and PayStatusID=@PayStatusID
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only BranchID, BillModes, LoginID selected--------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and  not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID  and BillModesID=@BillModesID and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		-----------------------------------------------------Only BranchID, PayMode and Login selected---------------------------------------------------------------
	else if not (@BranchID is null) and (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end


------------------------------------------------------------Only ItemCategory, ItemCode and BillMode selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only ItemCategory, ItemCode and PayStatus selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and  not(@ItemCode is null) 
	and  (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			 and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode 
			and PayStatusID=@PayStatusID 
			order by Items.RecordDateTime asc
		end

------------------------------------------------------------Only ItemCategory, ItemCode and LoginID---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID,  dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end


		------------------------------------------------------------Only ItemCategory, BillMode and PayStatus selected--------------------------------------------------------------
	else if  (@BranchID is null) and  not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID
			order by Items.RecordDateTime asc
		end

		---------------------------------------------------------Only ItemCategory, BillMode and LoginID selected--------------------------------------------------------------
	else if (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and BillModesID=@BillModesID 
			 and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only ItemCategory, PayStatus and Login selected---------------------------------------------------------------
	else if (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only ItemCode, BillMode and PayStatus selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID
			order by Items.RecordDateTime asc
		end

		--------------------------------------------------------Only ItemCode, BillMode and LoginID selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end
		---------------------------------------------------------Only ItemCode, PayStatus and LoginID selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and not(@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		---------------------------------------------------------Only Billmode, PayStatus and LoginID selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		--only 3 Items Selected (only 3 not selected) End---------------------------------------------------------------------------
		---------------------------------------------------------------------------------------------------------------------------------

		--only 2 Items Selected (only 4 not selected) ---------------------------------------------------------------------------
		-----------------------------------------------------------------------------------------------------------------------------

		------------------------------------------------------------On BranchID and ItemCategory selected---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID
			order by Items.RecordDateTime asc
		end
		---------------------------------------------------------Only BranchID and ItemCode selected---------------------------------------------------------------
	else if not (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and  (@BillModesID is null) and(@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID  and ItemCode=@ItemCode 
			order by Items.RecordDateTime asc
		end

		-----------------------------------------------------------Only BranchID and BillMode selected---------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and BillModesID=@BillModesID 
			order by Items.RecordDateTime asc
		end

		--------------------------------------------------------Only BranchID and PayStatus selected---------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID  
			and PayStatusID=@PayStatusID
			order by Items.RecordDateTime asc
		end

		----------------------------------------------------------Only BranchID and LoginID selected---------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and  (@BillModesID is null) and  (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		----------------------------------------------------------Only ItemCategory and ItemCode selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and  not (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only ItemCategory and BillMode selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and  not (@BillModesID is null) and  (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and BillModesID=@BillModesID 
			order by Items.RecordDateTime asc
		end
		------------------------------------------------------------Only ItemCategory and PayStatus selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			 and ItemCategoryID=@ItemCategoryID 
			and PayStatusID=@PayStatusID
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only ItemCategory and LoginID selected---------------------------------------------------------------
	else if (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and  (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only ItemCode and BillMode selected---------------------------------------------------------------
	else if (@BranchID is null) and  (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			 and ItemCode=@ItemCode and BillModesID=@BillModesID 
			order by Items.RecordDateTime asc
		end

		----------------------------------------------------------Only ItemCode and PayStatus selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode 
			and PayStatusID=@PayStatusID
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only ItemCode and LoginID selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end

		----------------------------------------------------------Only BillModes and PayStatus selected---------------------------------------------------------------
	else if (@BranchID is null) and  (@ItemCategoryID is null) and (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			 and BillModesID=@BillModesID and PayStatusID=@PayStatusID
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only BillMode and LoginID selected---------------------------------------------------------------
	else if  (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID,  dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BillModesID=@BillModesID and Items.LoginID=@LoginID
			order by Items.RecordDateTime asc
		end

		----------------------------------------------------------Only PayStatus and LoginID---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and PayStatusID=@PayStatusID  and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end
		
		--only 2 Items Selected (only 4 not selected) End---------------------------------------------------------------------------
		---------------------------------------------------------------------------------------------------------------------------------

		--only 1 Items Selected (only 5 not selected) ---------------------------------------------------------------------------
		---------------------------------------------------------------------------------------------------------------------------------
		
		-----------------------------------------------------------Only BranchID selected--------------------------------------------------------------
	
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only ItemCategory selected---------------------------------------------------------------
	else if (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID order by Items.RecordDateTime asc
		end
		------------------------------------------------------------Only ItemCode selected--------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only BillMode selected---------------------------------------------------------------
	else if  (@BranchID is null) and  (@ItemCategoryID is null) and (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
		and BillModesID=@BillModesID order by Items.RecordDateTime asc
		end

		-----------------------------------------------------------Only PayStatus selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime  and PayStatusID=@PayStatusID 
			order by Items.RecordDateTime asc
		end

		------------------------------------------------------------Only LoginID selected---------------------------------------------------------------
	else if  (@BranchID is null) and (@ItemCategoryID is null) and  (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)
			and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			and Items.LoginID = @LoginID 
			order by Items.RecordDateTime asc
		end
		--only 1 Items Selected (only 5 not selected) End----------------------------------------------------------------------------------------
		-----------------------------------------------------------------------------------------------------------------------------------------
    
	---------------------------------------------------------------------------------------------------------------------------------------------
	------------------------------------------------------------nothing is selected---------------------------------------------------------------
	else if  (@BranchID is null) and (@ItemCategoryID is null) and  (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,Items.VisitNo, UnitPrice,UnitCost, (UnitCost*Quantity) as SalesCost, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode, dbo.GetLookupDataDes(BranchID) as BranchName,
					 dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime,Items.LoginID
					from Items
					inner join visits on Items.VisitNo=Visits.Visitno
			where (ItemStatusID=@ItemDoneID or ItemStatusID=@ItemOfferedID or PayStatusID=@PaymentStatusID)and Items.RecordDateTime between @StartDateTime and @EndDateTime 
			order by Items.RecordDateTime asc
		end 
go
/******************************************************************************************************

exec uspGetSales  '27 May 2011', '28 Sep 2011'


******************************************************************************************************/
-- select * from Items

-----------------------------------uspGetItemsLogins------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetItemsLogins')
	drop proc uspGetItemsLogins
go
create proc uspGetItemsLogins(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime
)with encryption as

begin
	select distinct LoginID from 
	(select RecordDateTime, LoginID from Items
	union select RecordDateTime, LoginID from Expenditure		
	union select RecordDateTime, LoginID from Items) as Logins
	where RecordDateTime between @StartDateTime and @EndDateTime
end

return 0
go
----------------------------------------------------------------------------------------------------------
----------------------------------------------------uspGetItemsInventory----------------------------------

if exists (select * from sysobjects where name = 'uspGetItemsInventory')
	drop proc uspGetItemsInventory
go
create proc uspGetItemsInventory(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime,
@ItemCategoryID varchar(10)=null
)with encryption as

if @ItemCategoryID is null or @ItemCategoryID=''
 begin
	select distinct ItemFullName from 
	(select ItemCategoryID,RecordDateTime, dbo.GetMergedNameCode(ItemName ,ItemCode) as ItemFullName from Items
	union select ItemCategoryID, RecordDateTime,dbo.GetMergedNameCode(dbo.GetItemName(ItemCategoryID, ItemCode) ,ItemCode) as ItemFullName from Inventory		
	) as ItemFullName
	where RecordDateTime between @StartDateTime and @EndDateTime
end

else
 begin
	select distinct ItemFullName from 
	(select ItemCategoryID, RecordDateTime, dbo.GetMergedNameCode(ItemName,ItemCode) as ItemFullName from Items
	union select ItemCategoryID,RecordDateTime, dbo.GetMergedNameCode(dbo.GetItemName(ItemCategoryID, ItemCode) ,ItemCode) as ItemFullName from Inventory		
	) as ItemFullName
	where RecordDateTime between @StartDateTime and @EndDateTime and ItemCategoryID=@ItemCategoryID
end


return 0
go

/*--------------------------------------------------------------------------------------------------------
-- select * from Items
-- exec uspUpdateItems '06000001002', '10C', '7S', '11 Oct 2005', '12NP', 'Admin'
-- exec uspUpdateItems '06000001002', '10C', '7S', '11 Oct 2005', null, 'Admin', '11P'
---------------------------------------------------------------------------------------------------------*/

-----------------UpdateItemUnitPrice--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateItemUnitPrice')
	drop proc uspUpdateItemUnitPrice
go

create proc uspUpdateItemUnitPrice(
@VisitNo varchar(20) = null,
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@UnitPrice money = null,
@UnitCost money = null
)with encryption as 

declare @ErrorMSG varchar(200)
declare @NotPaidPayStatusID varchar(10)
declare @PercentCoPayTypeID varchar(10)

declare @CoPayTypeID varchar(10)
declare @CoPayPercent decimal(5,2)
declare @Quantity int
declare @CashAmount money

declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)
declare @PackageID varchar(10)
declare @OtherItemsID varchar(10)
-----------------------------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @PercentCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'PCT')
-----------------------------------------------------------------------------------------------

if not (@VisitNo is null or @VisitNo = '')
begin
	if  exists(select VisitNo from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and
		ItemCategoryID = @ItemCategoryID and PayStatusID = @NotPaidPayStatusID) 
			begin
				if ((not exists(select VisitNo from ItemsCash where VisitNo = @VisitNo and 
						ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)) 
						or								
					(exists(select VisitNo from ItemsCash where VisitNo = @VisitNo and ItemCode = @ItemCode and
						ItemCategoryID = @ItemCategoryID and CashPayStatusID = @NotPaidPayStatusID))) 
						
						begin
							begin tran 						
												
								set @CoPayTypeID = (select CoPayTypeID from Visits where VisitNo = @VisitNo)
								
								---------------------------------------------------------------------------------------
								update Items set UnitPrice = @UnitPrice
								where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID	
								---------------------------------------------------------------------------------------
								if (@CoPayTypeID = @PercentCoPayTypeID)
								begin
									set @CoPayPercent = (select CoPayPercent from Visits where VisitNo = @VisitNo)
									
									set @Quantity = (select Quantity from Items 
													where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)

									set @CashAmount = (@Quantity * @UnitPrice * @CoPayPercent)/100
									set @CashAmount = isnull(@CashAmount, 0)

									update ItemsCash set CashAmount = @CashAmount
									where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
								end
								---------------------------------------------------------------------------------------
											
							if @@error > 0
								begin
									rollback tran
									return 1		
								end
							commit tran
						
							return 0
						end
					else
						begin
							set @ErrorMSG = 'The record with %s: %s and  %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', has Co-Pay paid for. You can''t update this record!'
							raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo, 'Item Code', @ItemCode , 'Item Category')	
							return 1
						end
			end
		else
			begin
				set @ErrorMSG = 'The record with %s: %s and  %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', doesn''t exist or has been paid for. You can''t update this record!'
				raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo, 'Item Code', @ItemCode , 'Item Category')	
				return 1
			end
end
else
begin

	set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
	set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
	set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
	set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
	set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
	set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')
	
	set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
	set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
	set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
	set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
	set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
	set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
	set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
	set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
	set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
	set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')
	set @PackageID = dbo.GetLookupDataID('ItemCategory', 'G')
	set @OtherItemsID =dbo.GetLookupDataID('ItemCategory', 'NM')
	if @ItemCategoryID = @DrugID -- Drugs
		begin 
			if not exists(select DrugNo from Drugs where DrugNo = @ItemCode)
				begin
					set @ErrorMSG = 'The Drug No: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Drugs')	
					return 1
				end
				
			else if ((@UnitCost is null) and not (@UnitPrice is null))
					begin update Drugs set UnitPrice = @UnitPrice where DrugNo = @ItemCode end
					
			else if (not (@UnitCost is null) and (@UnitPrice is null))
					begin update Drugs set UnitCost = @UnitCost where DrugNo = @ItemCode end
					
				else begin update Drugs set UnitCost = @UnitCost, UnitPrice = @UnitPrice where DrugNo = @ItemCode end
		end
	else
	if @ItemCategoryID = @ConsumableID -- ConsumableItems

		begin 
			if not exists(select ConsumableNo from ConsumableItems where ConsumableNo = @ItemCode)
				begin
					set @ErrorMSG = 'The Consumable No: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Consumable Items')	
					return 1
				end 
				
			else if ((@UnitCost is null) and not (@UnitPrice is null))
					begin update ConsumableItems set UnitPrice = @UnitPrice where ConsumableNo = @ItemCode end
					
			else if (not (@UnitCost is null) and (@UnitPrice is null))
					begin update ConsumableItems set UnitCost = @UnitCost where ConsumableNo = @ItemCode end
					
				else begin update ConsumableItems set UnitCost = @UnitCost, UnitPrice = @UnitPrice where ConsumableNo = @ItemCode end
		end
	else
	if @ItemCategoryID = @ProcedureID -- Procedures

		begin 
			if not exists(select ProcedureCode from Procedures where ProcedureCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Procedure Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Procedures')	
					return 1
				end 
				
			else if ((@UnitCost is null) and not (@UnitPrice is null))
					begin update Procedures set UnitPrice = @UnitPrice where ProcedureCode = @ItemCode end
					
			--	else if (not (@UnitCost is null) and (@UnitPrice is null))
			--		begin update Procedures set UnitCost = @UnitCost where ProcedureCode = @ItemCode end
						
				else begin update Procedures set UnitPrice = @UnitPrice where ProcedureCode = @ItemCode end	-- UnitCost = @UnitCost, 
		end
	else


		if @ItemCategoryID = @OtherItemsID -- Other Items

		begin 
			if not exists(select ItemCode from OtherItems where ItemCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Item Code : %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'OtherItems')	
					return 1
				end 
				
			else if ((@UnitCost is null) and not (@UnitPrice is null))
					begin update OtherItems set UnitCost = @UnitCost where ItemCode = @ItemCode end
					
						
				else begin update OtherItems set UnitCost = @UnitCost where ItemCode = @ItemCode end	-- UnitCost = @UnitCost, 
		end
	else

	if @ItemCategoryID = @TestID -- LabTests

		begin 
			if not exists(select TestCode from LabTests where TestCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Test Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Lab Tests')	
					return 1
				end 
				
			else if ((@UnitCost is null) and not (@UnitPrice is null))
					begin update LabTests set TestFee = @UnitPrice where TestCode = @ItemCode end
					
			--	else if (not (@UnitCost is null) and (@UnitPrice is null))
			--		begin update LabTests set UnitCost = @UnitCost where TestCode = @ItemCode end
								
				else begin update LabTests set TestFee = @UnitPrice where TestCode = @ItemCode end -- UnitCost = @UnitCost, 
		end	
	else

	
	if @ItemCategoryID = @CardiologyID -- CardiologyExaminations

		begin 
			if not exists(select ExamCode from CardiologyExaminations where ExamCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Exam Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Cardiology Examinations')	
					return 1
				end 
				
			else if ((@UnitCost is null) and not (@UnitPrice is null))
					begin update CardiologyExaminations set UnitPrice = @UnitPrice where ExamCode = @ItemCode end
					
			--	else if (not (@UnitCost is null) and (@UnitPrice is null))
			--		begin update CardiologyExaminations set UnitCost = @UnitCost where ExamCode = @ItemCode end
					
				else begin update CardiologyExaminations set UnitPrice = @UnitPrice where ExamCode = @ItemCode end -- UnitCost = @UnitCost, 
		end	
	else

	if @ItemCategoryID = @RadiologyID -- RadiologyExaminations

		begin 
			if not exists(select ExamCode from RadiologyExaminations where ExamCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Exam Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Radiology Examinations')	
					return 1
				end 
				
			else if ((@UnitCost is null) and not (@UnitPrice is null))
					begin update RadiologyExaminations set UnitPrice = @UnitPrice where ExamCode = @ItemCode end
					
			--	else if (not (@UnitCost is null) and (@UnitPrice is null))
			--		begin update RadiologyExaminations set UnitCost = @UnitCost where ExamCode = @ItemCode end
					
				else begin update RadiologyExaminations set UnitPrice = @UnitPrice where ExamCode = @ItemCode end -- UnitCost = @UnitCost, 
		end	
	else

	if @ItemCategoryID = @PathologyID -- PathologyExaminations

		begin 
			if not exists(select ExamCode from PathologyExaminations where ExamCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Exam Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Pathology Examinations')	
					return 1
				end 
				
			else if ((@UnitCost is null) and not (@UnitPrice is null))
					begin update PathologyExaminations set UnitPrice = @UnitPrice where ExamCode = @ItemCode end
					
			--	else if (not (@UnitCost is null) and (@UnitPrice is null))
			--		begin update PathologyExaminations set UnitCost = @UnitCost where ExamCode = @ItemCode end
					
				else begin update PathologyExaminations set UnitPrice = @UnitPrice where ExamCode = @ItemCode end -- UnitCost = @UnitCost, 
		end	
	else
	if @ItemCategoryID = @DentalID -- DentalServices

		begin 
			if not exists(select DentalCode from DentalServices where DentalCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Dental Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Dental Services')	
					return 1
				end 
				
			else if ((@UnitCost is null) and not (@UnitPrice is null))
					begin update DentalServices set UnitPrice = @UnitPrice where DentalCode = @ItemCode end
					
			--	else if (not (@UnitCost is null) and (@UnitPrice is null))
			--		begin update DentalServices set UnitCost = @UnitCost where DentalCode = @ItemCode end
					
				else begin update DentalServices set UnitPrice = @UnitPrice where DentalCode = @ItemCode end -- UnitCost = @UnitCost, 
		end	
	else

		if @ItemCategoryID = @PackageID -- Packages

		begin 
			if not exists(select PackageNo from Packages where PackageNo = @PackageID)
				begin
					set @ErrorMSG = 'The Dental Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Packages')	
					return 1
				end 
				
			else if ((@UnitCost is null) and not (@UnitPrice is null))
					begin update Packages set UnitPrice = @UnitPrice where PackageNo = @ItemCode end
					
			--	else if (not (@UnitCost is null) and (@UnitPrice is null))
			--		begin update DentalServices set UnitCost = @UnitCost where DentalCode = @ItemCode end
					
				else begin update Packages set UnitPrice = @UnitPrice where PackageNo = @ItemCode end -- UnitCost = @UnitCost, 
		end	
	else
	if @ItemCategoryID = @TheatreID -- TheatreServices

		begin 
			if not exists(select TheatreCode from TheatreServices where TheatreCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Theatre Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Theatre Services')	
					return 1
				end 
				
			else if ((@UnitCost is null) and not (@UnitPrice is null))
					begin update TheatreServices set UnitPrice = @UnitPrice where TheatreCode = @ItemCode end
					
			--	else if (not (@UnitCost is null) and (@UnitPrice is null))
			--		begin update TheatreServices set UnitCost = @UnitCost where TheatreCode = @ItemCode end
					
				else begin update TheatreServices set UnitPrice = @UnitPrice where TheatreCode = @ItemCode end -- UnitCost = @UnitCost, 
		end
	else
		begin	
			set @ErrorMSG = 'Item Category: %s, not supported!'
			raiserror(@ErrorMSG, 16, 1, @ItemCategoryID)	
			return 1
		end
end
return 0
go

/*--------------------------------------------------------------------------------------------------------
-- exec uspUpdateItemUnitPrice '001002', '7D', 'M603', 50500
-- exec uspUpdateItemUnitPrice '001005', '7T', 'T056', 50200
-- exec uspUpdateItemUnitPrice '005004', '7T', 'T010', 50300
-- exec uspUpdateItemUnitPrice '005005', '7T', 'T056', 50200
-- exec uspUpdateItemUnitPrice '1010012013', '7S', '10C', 40000

-- exec uspUpdateItemUnitPrice null, '7D', 'D001', 50600
-- exec uspUpdateItemUnitPrice null, '7D', 'D001', 50200, 10
-- exec uspUpdateItemUnitPrice '', '7D', 'D001', 50600
-- exec uspUpdateItemUnitPrice '487899', '7D', 'D001', 50200, 10
---------------------------------------------------------------------------------------------------------*/


-----------------UpdateIPDItemUnitPriceQuantity--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateItemUnitPriceQuantity')
	drop proc uspUpdateItemUnitPriceQuantity
go

create proc uspUpdateItemUnitPriceQuantity(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@UnitPrice money,
@Quantity int
)with encryption as 

declare @ErrorMSG varchar(200)

declare @NotPaidPayStatusID varchar(10)
declare @PercentCoPayTypeID varchar(10)

declare @CoPayTypeID varchar(10)
declare @CoPayPercent decimal(5,2)
declare @CashAmount money

-----------------------------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @PercentCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'PCT')
-----------------------------------------------------------------------------------------------

			
					 
					begin tran 						
				 								
								set @CoPayTypeID = (select CoPayTypeID from Visits where VisitNo = @VisitNo)				
														
								---------------------------------------------------------------------------------------
								update Items set UnitPrice = @UnitPrice, Quantity = @Quantity
								where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID	
								
								update ItemsIncome set UnitPrice = @UnitPrice, Quantity = @Quantity
								where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID	
								---------------------------------------------------------------------------------------
							if  exists(select VisitNo from ItemsCASH 
				             where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
					
					     begin		
								if (@CoPayTypeID = @PercentCoPayTypeID)
								begin
									set @CoPayPercent = (select CoPayPercent from Visits where VisitNo = @VisitNo)

									set @CashAmount = (@Quantity * @UnitPrice * @CoPayPercent)/100
									set @CashAmount = isnull(@CashAmount, 0)

									update ItemsCash set CashAmount = @CashAmount
									from ItemsCash where @VisitNo = @VisitNo 
									and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
																		
								end
								---------------------------------------------------------------------------------------
						  end				
							
							if @@error > 0
								begin
									rollback tran
									return 1		
								end
							commit tran
						
							return 0
		

go


/*--------------------------------------------------------------------------------------------------------
select top 2 * from Items
exec uspUpdateItemUnitPriceQuantity '001003','ART', '7S', 6000, 1
select * from Items where VisitNo = '001003'
*/---------------------------------------------------------------------------------------------------------*/


-----------------UpdateIPDItemUnitPrice--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDItemUnitPrice')
	drop proc uspUpdateIPDItemUnitPrice
go

create proc uspUpdateIPDItemUnitPrice(
@ExtraBillNo varchar(20) = null,
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@UnitPrice money = null,
@UnitCost money = null
)with encryption as 

declare @ErrorMSG varchar(200)

declare @RoundNo varchar(20)
declare @NotPaidPayStatusID varchar(10)
declare @PercentCoPayTypeID varchar(10)

declare @CoPayTypeID varchar(10)
declare @CoPayPercent decimal(5,2)
declare @Quantity int
declare @CashAmount money

-----------------------------------------------------------------------------------------------
set @RoundNo = dbo.GetExtraBillRoundNo(@ExtraBillNo)
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @PercentCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'PCT')
-----------------------------------------------------------------------------------------------

if not (@ExtraBillNo is null or @ExtraBillNo = '')
begin
	if  exists(select ExtraBillNo from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and
		ItemCategoryID = @ItemCategoryID and PayStatusID = @NotPaidPayStatusID) 
		begin
				if ((not exists(select ExtraBillNo from ExtraBillItemsCASH 
				where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)) 
						or								
					(exists(select ExtraBillNo from ExtraBillItemsCASH 
				    where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
				    and CashPayStatusID = @NotPaidPayStatusID))) 
					begin
					 
					begin tran 						
				 								
								set @CoPayTypeID = (select CoPayTypeID from Visits 
								inner join ExtraBills on ExtraBills.ExtraBillNo = Visits.VisitNo
								where ExtraBills.ExtraBillNo = @ExtraBillNo)				
														
								---------------------------------------------------------------------------------------
								update ExtraBillItems set UnitPrice = @UnitPrice
								where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID	
													
								if not (@RoundNo is null or @RoundNo = '') 
								begin					
									update IPDItems set UnitPrice = @UnitPrice
									where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID	
								end
								---------------------------------------------------------------------------------------
								if (@CoPayTypeID = @PercentCoPayTypeID)
								begin
									set @CoPayPercent = (select CoPayPercent from Visits 
									inner join ExtraBills on ExtraBills.ExtraBillNo = Visits.VisitNo
									where ExtraBills.ExtraBillNo = @ExtraBillNo)
									
									set @Quantity = (select Quantity from ExtraBillItems 
													where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)

									set @CashAmount = (@Quantity * @UnitPrice * @CoPayPercent)/100
									set @CashAmount = isnull(@CashAmount, 0)

									update ExtraBillItemsCash set CashAmount = @CashAmount
									from ExtraBillItemsCash where @ExtraBillNo = @ExtraBillNo 
									and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
																		
								end
								---------------------------------------------------------------------------------------
											
							if @@error > 0
								begin
									rollback tran
									return 1		
								end
							commit tran
						
							return 0
					
			end
		else
			begin
				set @ErrorMSG = 'The record with %s: %s and  %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', doesn''t exist or has been paid for. You can''t update this record!'
				raiserror(@ErrorMSG,16,1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode , 'Item Category')	
				return 1
			end
	end
end
else
return 0
go

/*--------------------------------------------------------------------------------------------------------
-- exec uspUpdateIPDItemUnitPrice '001002', '7D', 'M603', 50500
-- exec uspUpdateIPDItemUnitPrice '001005', '7T', 'T056', 50200
-- exec uspUpdateIPDItemUnitPrice '005004', '7T', 'T010', 50300
-- exec uspUpdateIPDItemUnitPrice '005005', '7T', 'T056', 50200
-- exec uspUpdateIPDItemUnitPrice '1010012013', '7S', '10C', 40000

-- exec uspUpdateIPDItemUnitPrice null, '7D', 'D001', 50600
-- exec uspUpdateIPDItemUnitPrice null, '7D', 'D001', 50200, 10
-- exec uspUpdateIPDItemUnitPrice '', '7D', 'D001', 50600
-- exec uspUpdateIPDItemUnitPrice '487899', '7D', 'D001', 50200, 10
*/---------------------------------------------------------------------------------------------------------*/


-----------------UpdateIPDItemUnitPriceQuantity--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDItemUnitPriceQuantity')
	drop proc uspUpdateIPDItemUnitPriceQuantity
go

create proc uspUpdateIPDItemUnitPriceQuantity(
@ExtraBillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@UnitPrice money,
@Quantity int
)with encryption as 

declare @ErrorMSG varchar(200)

declare @RoundNo varchar(20)
declare @NotPaidPayStatusID varchar(10)
declare @PercentCoPayTypeID varchar(10)

declare @CoPayTypeID varchar(10)
declare @CoPayPercent decimal(5,2)
declare @CashAmount money

-----------------------------------------------------------------------------------------------
set @RoundNo = dbo.GetExtraBillRoundNo(@ExtraBillNo)
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @PercentCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'PCT')
-----------------------------------------------------------------------------------------------

			
					 
					begin tran 						
				 								
								set @CoPayTypeID = (select CoPayTypeID from Visits 
								inner join ExtraBills on ExtraBills.ExtraBillNo = Visits.VisitNo
								where ExtraBills.ExtraBillNo = @ExtraBillNo)				
														
								---------------------------------------------------------------------------------------
								update ExtraBillItems set UnitPrice = @UnitPrice, Quantity = @Quantity
								where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID	
													
								if not (@RoundNo is null or @RoundNo = '') 
								begin					
									update IPDItems set UnitPrice = @UnitPrice, Quantity = @Quantity
									where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID	
								end
								---------------------------------------------------------------------------------------
							if  exists(select ExtraBillNo from ExtraBillItemsCASH 
				             where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
					
					     begin		
								if (@CoPayTypeID = @PercentCoPayTypeID)
								begin
									set @CoPayPercent = (select CoPayPercent from Visits 
									inner join ExtraBills on ExtraBills.ExtraBillNo = Visits.VisitNo
									where ExtraBills.ExtraBillNo = @ExtraBillNo)
									
									set @CashAmount = (@Quantity * @UnitPrice * @CoPayPercent)/100
									set @CashAmount = isnull(@CashAmount, 0)

									update ExtraBillItemsCash set CashAmount = @CashAmount
									from ExtraBillItemsCash where @ExtraBillNo = @ExtraBillNo 
									and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
																		
								end
								---------------------------------------------------------------------------------------
						  end				
							
							if @@error > 0
								begin
									rollback tran
									return 1		
								end
							commit tran
						
							return 0
		

go

--- select * from ExtraBillItemsCASH

/*--------------------------------------------------------------------------------------------------------
exec uspUpdateIPDItemUnitPriceQuantity '015004','M024', '7D', 1100, 1
select * from ExtraBillItems where ExtraBillNo = '015004'
*/---------------------------------------------------------------------------------------------------------*/

----------------Delete Item-------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspDeleteItem')
	drop proc uspDeleteItem
go

create proc uspDeleteItem(
@VisitNo varchar(20) ,
@ItemCode varchar(20) ,
@ItemCategoryID varchar(10)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @ItemStatusID varchar(10)
declare @PayStatusID varchar(10)
declare @NAPayStatusID varchar(10)


set @ItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @PayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @NAPayStatusID = dbo.GetLookupDataID('PayStatus', 'NA')

if exists(select VisitNo from Items where VisitNo = @VisitNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		if  exists(select VisitNo from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID 
								and ItemStatusID = @ItemStatusID and PayStatusID IN (@NAPayStatusID,@PayStatusID)) 
			
		begin				
			delete Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
			return 0
		end
		else
			set @ErrorMSG = 'The record with %s: %s, %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', is not pending or has been paid for. You can''t delete this record!'
			raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo, 'Item Code', @ItemCode , 'Item Category')
			return 1
	end
else
		set @ErrorMSG = 'The record with %s: %s, %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', does not exist!'
		raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo, 'Item Code', @ItemCode , 'Item Category')
		return 1

return 0

go

-- exec uspDeleteItem '000001BA21078001', '10C','7S'

-- select * from Items


--------GetItems--------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetItems')
	drop proc uspGetItems
go

create proc uspGetItems(
@VisitNo varchar(20) = null,
@ItemCategoryID varchar(10) = null,
@ItemStatusID varchar(10) = null,
@PayStatusID varchar(10)= null,
@BillAccount varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @BillModesID varchar(10)
declare @CashID varchar(10)

set @CashID = dbo.GetLookupDataID('BillModes', 'C')

if not (@VisitNo is null)
begin
	if not exists(select VisitNo from Items where VisitNo = @VisitNo)
		begin
			--set @ErrorMSG = 'The Visit No: ' + cast(@VisitNo as varchar) + ', you are trying to enter does not exist in the registered Items'
			--raiserror(@ErrorMSG,16,1)	
			return 1
		end
end

if not (@VisitNo is null) and (@ItemCategoryID is null) and (@ItemStatusID is null) 
	and not (@PayStatusID is null) and not (@BillAccount is null)
	begin
		select Items.VisitNo, BillNo, Items.ItemCode, Items.InvoiceNo, 
		dbo.GetDrQuantityitemsEXT(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as DoctorQuantity, Quantity, 
		
		Quantity * UnitPrice as Amount, 		
		dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as Balance, 
		UnitPrice,Quantity,  Quantity * UnitPrice as Amount,  ItemDetails, Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
		dbo.GetRejectionStatus(Items.VisitNo,Items.ItemCategoryID) as RejectionStatus, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, CashAmount,
		CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName,UnitMeasure, Dosage, Duration,
		dbo.GetMergedNameCode(dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode), Items.ItemCode) as ItemFullName,
		dbo.GetStaffFullNameWithLoginID(CreatorLoginID) as CreatorFullName,
		dbo.GetLabApprovedStatusID(Items.VisitNo,Items.ItemCode) as LabApprovedStatusID
		from Items
		left outer join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
		and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
		left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
		and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
		inner join Visits  on Items.VisitNo = Visits.VisitNo
		where Items.VisitNo = @VisitNo and PayStatusID = @PayStatusID and BillNo = @BillAccount
	end

else

if not (@VisitNo is null) and not (@ItemCategoryID is null) and (@ItemStatusID is null) and (@PayStatusID is null)
	begin
		select  Items.VisitNo, Items.ItemCode, Items.InvoiceNo,
		dbo.GetDrQuantityitemsEXT(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as DoctorQuantity,  		
		dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as Balance, Quantity, UnitPrice, 
		Quantity  * UnitPrice as Amount, 		
		ItemDetails, Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
		dbo.GetRejectionStatus(Items.VisitNo,Items.ItemCategoryID) as RejectionStatus,  
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, CashAmount,
		CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName,UnitMeasure, Dosage, Duration,
		dbo.GetMergedNameCode(dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode), Items.ItemCode) as ItemFullName, 
		ItemDetails,dbo.GetStaffFullNameWithLoginID(CreatorLoginID) as CreatorFullName,
		dbo.GetLabApprovedStatusID(Items.VisitNo,Items.ItemCode) as LabApprovedStatusID
		from Items
		left outer join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
		and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
		left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
		and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
		where Items.VisitNo = @VisitNo and Items.ItemCategoryID = @ItemCategoryID
	end
else

if not (@VisitNo is null) and not (@ItemCategoryID is null) and not (@ItemStatusID is null) and (@PayStatusID is null)
	begin
		select Items.VisitNo, BillNo, Items.ItemCode, Items.InvoiceNo, 
		dbo.GetDrQuantityitemsEXT(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as DoctorQuantity,  		
		dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as Balance, UnitPrice, Quantity,
		Quantity * UnitPrice as Amount,		
		ItemDetails, Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
		dbo.GetRejectionStatus(Items.VisitNo,Items.ItemCategoryID) as RejectionStatus, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, CashAmount,
		CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName,UnitMeasure, Dosage, Duration,
		dbo.GetMergedNameCode(dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode), Items.ItemCode) as ItemFullName, 
		ItemStatusID,dbo.GetStaffFullNameWithLoginID(CreatorLoginID) as CreatorFullName,
		dbo.GetLabApprovedStatusID(Items.VisitNo,Items.ItemCode) as LabApprovedStatusID from Items
		left outer join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
		and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
		left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
		and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
		inner join Visits  on Items.VisitNo = Visits.VisitNo
		where Items.VisitNo = @VisitNo and Items.ItemCategoryID = @ItemCategoryID and ItemStatusID = @ItemStatusID
	end
else

begin

	set @BillModesID = (select BillModesID from Visits where VisitNo = @VisitNo)

	if @BillModesID = @CashID
	begin
		select  Items.VisitNo, BillNo, Items.ItemCode, Items.InvoiceNo,
		dbo.GetDrQuantityitemsEXT(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as DoctorQuantity,  		
		dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as Balance, UnitPrice, 
	     Quantity, Quantity * UnitPrice as Amount, 		
		ItemDetails, Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
		dbo.GetRejectionStatus(Items.VisitNo,Items.ItemCategoryID) as RejectionStatus, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, CashAmount,CashPayStatusID, 
		dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName,UnitMeasure, Dosage, Duration,
		dbo.GetMergedNameCode(dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode), Items.ItemCode) as ItemFullName,
		ItemStatusID,dbo.GetStaffFullNameWithLoginID(CreatorLoginID) as CreatorFullName,
		dbo.GetLabApprovedStatusID(Items.VisitNo,Items.ItemCode) as LabApprovedStatusID from Items
		left outer join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
		and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
		left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
		and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
		inner join Visits  on Items.VisitNo = Visits.VisitNo
		where Items.VisitNo = @VisitNo and PayStatusID = @PayStatusID
		and Items.ItemCategoryID = @ItemCategoryID and ItemStatusID = @ItemStatusID
	end
	else
		begin
			select  Items.VisitNo, BillNo, Items.ItemCode, Items.InvoiceNo, 
			dbo.GetDrQuantityitemsEXT(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as DoctorQuantity,  		
			dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as Balance, UnitPrice, Quantity,
	       Quantity * UnitPrice as Amount, ItemDetails, 
			Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
			ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetRejectionStatus(Items.VisitNo,Items.ItemCategoryID) as RejectionStatus, 
			PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, CashAmount,
			CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName,UnitMeasure, Dosage, Duration,
			dbo.GetMergedNameCode(dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode), Items.ItemCode) as ItemFullName, 
			ItemStatusID,dbo.GetStaffFullNameWithLoginID(CreatorLoginID) as CreatorFullName,
			dbo.GetLabApprovedStatusID(Items.VisitNo,Items.ItemCode) as LabApprovedStatusID from Items
			left outer join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
			and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
			left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
			and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			where Items.VisitNo = @VisitNo and Items.ItemCategoryID = @ItemCategoryID and ItemStatusID = @ItemStatusID
		end
	
end

return 0
go

-- exec uspGetItems '180500002', '7d', '11P', null, null
-- exec uspGetItems null, null, null, '12NP', 'Account'
-- exec uspGetItems null, null, null, '12NP', 'SHARP'
-- exec uspGetItems null, '7P', '11P', '12NP', null
-- exec uspGetItems '16005768001', null, null, '12NP', 'Cash'
-- exec uspGetItems '0600001002', '7T', '11R', '12PF'
-- exec uspGetItems '07022068001', '7P', null, null
-- select * from Items
-- select * from Visits


------------------------------------------------------------------------------------------------------

--------uspGetSelfRequestItems--------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetSelfRequestItems')
	drop proc uspGetSelfRequestItems
go

create proc uspGetSelfRequestItems(
@VisitNo varchar(20) = null,
@ItemCategoryID varchar(10) = null,
@ItemStatusID varchar(10) = null,
@PayStatusID varchar(10)= null,
@BillAccount varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @BillModesID varchar(10)
declare @CashID varchar(10)

set @CashID = dbo.GetLookupDataID('BillModes', 'C')

if not (@VisitNo is null)
begin
	if not exists(select VisitNo from Items where VisitNo = @VisitNo)
		begin
			--set @ErrorMSG = 'The Visit No: ' + cast(@VisitNo as varchar) + ', you are trying to enter does not exist in the registered Items'
			--raiserror(@ErrorMSG,16,1)	
			return 1
		end
end

if not (@VisitNo is null) and (@ItemCategoryID is null) and (@ItemStatusID is null) 
	and not (@PayStatusID is null) and not (@BillAccount is null)
	begin
		select Items.VisitNo, BillNo, Items.ItemCode, 
		dbo.GetDrQuantityitemsEXT(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as DoctorQuantity, Quantity, 		
		dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as Balance, 
		UnitPrice, Quantity * UnitPrice as Amount, ItemDetails, 
		Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, CashAmount,
		CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus,ItemName,UnitMeasure, Dosage, Duration,
		dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName
		from Items
		left outer join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
		and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
		left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
		and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
		inner join Visits  on Items.VisitNo = Visits.VisitNo
		where Items.VisitNo = @VisitNo and PayStatusID = @PayStatusID and BillNo = @BillAccount
		and dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) > 0
		and dbo.IsItemBalanceStatusOffered(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) = 1
	end

else

if not (@VisitNo is null) and not (@ItemCategoryID is null) and (@ItemStatusID is null) and (@PayStatusID is null)
	begin
		select  Items.VisitNo, Items.ItemCode, 
		dbo.GetDrQuantityitemsEXT(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as DoctorQuantity, Quantity, 		
		dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as Balance, 
		UnitPrice, Quantity * UnitPrice as Amount, ItemDetails, 
		Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, CashAmount,
		CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus, 
		Items.ItemName,UnitMeasure, Dosage, Duration,
		dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName, 
		ItemDetails from Items
		left outer join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
		and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
		left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
		and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
		where Items.VisitNo = @VisitNo and Items.ItemCategoryID = @ItemCategoryID
		and dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) > 0
		and dbo.IsItemBalanceStatusOffered(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) = 1
	end
else

if not (@VisitNo is null) and not (@ItemCategoryID is null) and not (@ItemStatusID is null) and (@PayStatusID is null)
	begin
		select Items.VisitNo, BillNo, Items.ItemCode, 
		dbo.GetDrQuantityitemsEXT(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as DoctorQuantity, Quantity, 		
		dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as Balance, 
		UnitPrice, Quantity * UnitPrice as Amount, ItemDetails, 
		Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, CashAmount,
		CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus,ItemName,UnitMeasure, Dosage, Duration,
		dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName, 
		ItemStatusID from Items
		left outer join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
		and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
		left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
		and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
		inner join Visits  on Items.VisitNo = Visits.VisitNo
		where Items.VisitNo = @VisitNo and Items.ItemCategoryID = @ItemCategoryID and ItemStatusID = @ItemStatusID
		and dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) > 0
		and dbo.IsItemBalanceStatusOffered(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) = 1
	end
else

begin

	set @BillModesID = (select BillModesID from Visits where VisitNo = @VisitNo)

	if @BillModesID = @CashID
	begin
		select  Items.VisitNo, BillNo, Items.ItemCode, 
		dbo.GetDrQuantityitemsEXT(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as DoctorQuantity, Quantity, 		
		dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as Balance, 
		UnitPrice, Quantity * UnitPrice as Amount, ItemDetails, 
		Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, CashAmount,
		CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus,ItemName,UnitMeasure, Dosage, Duration,
		dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName, 
		ItemStatusID from Items
		left outer join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
		and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
		left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
		and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
		inner join Visits  on Items.VisitNo = Visits.VisitNo
		where Items.VisitNo = @VisitNo and PayStatusID = @PayStatusID
		and Items.ItemCategoryID = @ItemCategoryID and ItemStatusID = @ItemStatusID
		and dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) > 0
		and dbo.IsItemBalanceStatusOffered(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) = 1
	end
	else
		begin
			select  Items.VisitNo, BillNo, Items.ItemCode, 
			dbo.GetDrQuantityitemsEXT(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as DoctorQuantity, Quantity, 		
			dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as Balance, 
			UnitPrice, Quantity * UnitPrice as Amount, ItemDetails, 
			Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
			ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, CashAmount,
			CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus,ItemName,UnitMeasure, Dosage, Duration,
			dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName, 
			ItemStatusID from Items
			left outer join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
			and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
			left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
			and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			where Items.VisitNo = @VisitNo and Items.ItemCategoryID = @ItemCategoryID and ItemStatusID = @ItemStatusID
			and dbo.GetPrescriptionItemBalance(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) > 0
			and dbo.IsItemBalanceStatusOffered(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) = 1
		end
	
end

return 0
go

-- exec uspGetSelfRequestItems '16005768001', 7D, M114
-- select * from Items
-- select * from Visits

--------GetItemsByVisitNo----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetItemsByVisitNo')
	drop proc uspGetItemsByVisitNo
go

create proc uspGetItemsByVisitNo(
@VisitNo varchar(20)
)with encryption as

begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
	MemberCardNo, MainMemberName, ClaimReferenceNo, dbo.FormatDate(VisitDate) as VisitDate, 
	Quantity, UnitPrice, (Quantity * UnitPrice) as Amount, 
	
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, Items.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory,ItemName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, isnull(CashAmount, 0) as CashAmount,
	CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus, 
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,	
	dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
	dbo.FormatDate(Visits.RecordDateTime) as RecordDate, 
	dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from Items 
	left outer join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
	and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
	inner join Visits on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where Visits.VisitNo = @VisitNo 
end
return 0
go

-- select top 1000 * from Visits
-- exec uspGetItemsByVisitNo '005002'
-- exec uspGetItemsByVisitNo '1010058012'



--------GetIPDItemsByVisitNo----------------------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetIPDItemsByVisitNo')
	drop proc uspGetIPDItemsByVisitNo
go

create proc uspGetIPDItemsByVisitNo(
@VisitNo varchar(20)
)with encryption as

begin
	select 
	Visits.PatientNo as PatientNo,	VisitDate as VisitDate,	IPDItems.RoundNo as RoundNo, ExtraBillItems.ExtraBillNo as ExtraBillNo,
	ExtraBillItems.Quantity, ExtraBillItems.UnitPrice, (ExtraBillItems.Quantity * ExtraBillItems.UnitPrice) as Amount, 
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
	ExtraBillItems.EntryModeID, dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode,ExtraBillItems.ItemName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	ExtraBillItems.PayStatusID, dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, 
	IPDItems.ItemStatusID, dbo.GetLookupDataDes(IPDItems.ItemStatusID) as ItemStatus, isnull(CashAmount, 0) as CashAmount,
	CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus,
	MemberCardNo, MainMemberName, ClaimReferenceNo, 
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,	
	dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
	dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, 
	dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime
	from ExtraBillItems 
	inner join ExtraBills on ExtraBills.ExtraBillNo = ExtraBillItems.ExtraBillNo
	left join ExtrabillItemsCASH on ExtrabillItemsCASH.ExtraBillNo = ExtraBills.VisitNo	
	and ExtrabillItemsCASH.ItemCode = ExtraBillItems.ItemCode and ExtrabillItemsCASH.ItemCategoryID = ExtraBillItems.ItemCategoryID
	left join ExtraBillsEXT on ExtraBillsEXT.ExtraBillNo = ExtraBillItems.ExtraBillNo
	left join IPDItems on ExtraBillsEXT.RoundNo = IPDItems.RoundNo and IPDItems.ItemCode = ExtraBillItems.ItemCode 
	and IPDItems.ItemCategoryID = ExtraBillItems.ItemCategoryID and ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ExtraBills.VisitNo = @VisitNo 
	order by ExtraBillItems.RecordDateTime
end
return 0
go

--select * from IPDItems
-- select top 1000 * from Visits
-- exec uspGetIPDItemsByVisitNo '15002683001'--------GetDentalItems--------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDentalItems')
	drop proc uspGetDentalItems
go

create proc uspGetDentalItems(
@VisitNo varchar(20),
@DentalCategory varchar(100)
)with encryption as

declare @ErrorMSG varchar(200)
declare @DentalID varchar(10)

set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')

if not exists(select VisitNo from Items where VisitNo = @VisitNo)
	begin
		--set @ErrorMSG = 'The Visit No: ' + cast(@VisitNo as varchar) + ', you are trying to enter does not exist in the registered Items'
		--raiserror(@ErrorMSG,16,1)	
		return 1
	end
else
	begin
		select  Items.VisitNo, ItemCode, Quantity, UnitPrice, ItemDetails, 
		dbo.GetDentalCategory(ItemCode) as DentalCategory, Quantity * UnitPrice as Amount, 
		Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,ItemName,UnitMeasure,
		dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName, 
		ItemDetails from Items
		where Items.VisitNo = @VisitNo and Items.ItemCategoryID = @DentalID 
		and dbo.GetDentalCategory(ItemCode) = @DentalCategory
	end
return 0
go

-- exec uspGetDentalItems '1100709009', 'Service'
-- select * from Items
-- select * from Visits

--------GetNotPaidItemsCASH--------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNotPaidItemsCASH')
	drop proc uspGetNotPaidItemsCASH
go

create proc uspGetNotPaidItemsCASH(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @NotPaidCashPayStatusID varchar(10)

set @NotPaidCashPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')

if not exists(select VisitNo from Items where VisitNo = @VisitNo)
	begin
		--set @ErrorMSG = 'The Visit No: ' + cast(@VisitNo as varchar) + ', you are trying to enter does not exist in the registered Items'
		--raiserror(@ErrorMSG, 16, 1)	
		return 1
	end
else
	begin
		select Items.VisitNo, BillNo, Items.ItemCode, Quantity,
		dbo.GetBillCustomerName(BillNo) as BillCustomerName,
		UnitPrice, CashAmount as Amount, ItemDetails,
		dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, 
		Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
		CashPayStatusID,  dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus,ItemName,UnitMeasure,
		dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName, ItemsCASH.InvoiceNo
		from Items
		inner join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
		and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
		inner join Visits  on Items.VisitNo = Visits.VisitNo
		where Items.VisitNo = @VisitNo and CashPayStatusID = @NotPaidCashPayStatusID
	end

return 0
go

-- exec uspGetNotPaidItemsCASH 'PLH393999001'
-- select * from Items
--  select * from ItemsCASH
-- select * from Visits

--------GetNotPaidItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNotPaidItems')
	drop proc uspGetNotPaidItems
go

create proc uspGetNotPaidItems(
@BillModesID varchar(10),
@BillNo varchar(20),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null,
@CompanyNo varchar(20) = null
)with encryption as

declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)
declare @NotPaidPayStatusID varchar(10)
declare @ServicePointID varchar(10)

--------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
--------------------------------------------------------------------------
set @ServicePointID = dbo.GetLookupDataID('ServicePoint', 'CAS')


if not(@StartDate is null) and not(@EndDate is null)
begin
	if (@BillNo = 'CASH' and @BillModesID = @CashBillModesID) -- Bill Cash
		begin
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate,
			dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity, UnitPrice,
			Quantity * UnitPrice as Amount, ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo
	
			from Items 
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			left outer join Queues  on Queues.VisitNo = Visits.VisitNo and ServicePointID=@ServicePointID and QueueStatus=1
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and BillNo = @BillNo and VisitDate between @StartDate and @EndDate
			union
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate,
			dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity, UnitPrice,
			Quantity * UnitPrice as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(CashPayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, Items.InvoiceNo
	
			from Items
			inner join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
			and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			left outer join Queues  on Queues.VisitNo = Visits.VisitNo and ServicePointID=@ServicePointID and QueueStatus=1
			where CashPayStatusID = @NotPaidPayStatusID	and (Quantity*UnitPrice)>0 and VisitDate between @StartDate and @EndDate order by TokenNo asc
		end
	else if (@BillModesID = @AccountBillModesID) -- Bill Account 
		 if not(@CompanyNo is null)
			begin
				select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, MainMemberName, ClaimReferenceNo,
				dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity,
				UnitPrice, dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)  as BillPrice,
			    (Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount,
				
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, Items.ItemCode, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
				Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory,ItemName, 
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
				dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
				dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
				dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
				dbo.GetTime(Items.RecordDateTime) as RecordTime,
				dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo
	
 				from Items 
				inner join Visits on Items.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo
				--inner join Queues on Queues.VisitNo = Visits.VisitNo
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and (BillNo = @CompanyNo and InsuranceNo = @BillNo) 
				and VisitDate between @StartDate and @EndDate
				order by VisitDate, Items.RecordDateTime
			end
		else
		begin
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, MainMemberName, ClaimReferenceNo,
			dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity, 
			UnitPrice, dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)  as BillPrice,
			(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice) ) as Amount,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, Items.ItemCode, 
			CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory,ItemName, 
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo
	
 			from Items 
			inner join Visits on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			--inner join Queues on Queues.VisitNo = Visits.VisitNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID
			and (BillNo = @BillNo or InsuranceNo = @BillNo) 
			and VisitDate between @StartDate and @EndDate
			order by VisitDate, Items.RecordDateTime
		end
	else if (@BillModesID = @InsuranceBillModesID) -- Bill Insurance
		 if not(@CompanyNo is null)
			begin
				select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo, 
				dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, MainMemberName, ClaimReferenceNo,
				dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity,
				UnitPrice, dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)  as BillPrice,
				(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount,
				
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, Items.ItemCode, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
				Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory,ItemName,
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
				dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
				dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
				dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
				dbo.GetTime(Items.RecordDateTime) as RecordTime,
				dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo
	
 				from Items 
				inner join Visits on Items.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo
				--inner join Queues on Queues.VisitNo = Visits.VisitNo
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo and VisitDate between @StartDate and @EndDate
				and dbo.GetSchemeCompanyNo(BillNo) = @CompanyNo
				order by VisitDate, Items.RecordDateTime
			end
		else
		begin
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, MainMemberName, ClaimReferenceNo,
			dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity,
			UnitPrice, dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)  as BillPrice,
			(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, Items.ItemCode, 
			CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo
		from Items 
			inner join Visits on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			--inner join Queues on Queues.VisitNo = Visits.VisitNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo and VisitDate between @StartDate and @EndDate
			order by VisitDate, Items.RecordDateTime
		end	
end
else
begin
	if (@BillNo = 'CASH' and @BillModesID = @CashBillModesID) -- Bill Cash
		begin
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo,
			dbo.FormatDate(VisitDate) as VisitDate,FirstName,
			dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity, UnitPrice,
			Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo
			from Items 
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			left outer join Queues on Queues.VisitNo = Visits.VisitNo  and ServicePointID=@ServicePointID and QueueStatus=1
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and BillNo = @BillNo and (Quantity*UnitPrice)>0
			union
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate,
			dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,  Quantity, UnitPrice,
			Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(CashPayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, Items.InvoiceNo
            from Items
			inner join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
			and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			left outer join Queues on Queues.VisitNo = Visits.VisitNo  and ServicePointID=@ServicePointID and QueueStatus=1
			where CashPayStatusID = @NotPaidPayStatusID
			order by TokenNo asc 
		end
	else if (@BillModesID = @AccountBillModesID) -- Bill Account
		 if not(@CompanyNo is null)
			begin
				select  Items.VisitNo, Visits.PatientNo, VisitDate, BillNo, Items.ItemCode, Quantity, 
			    UnitPrice, dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice)  as BillPrice,
				dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
				(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount, 		
				dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName,
				ItemDetails, Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
 				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, MemberCardNo, MainMemberName, ClaimReferenceNo, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,UnitMeasure,ItemName, Dosage, Duration,
				dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName, 
				dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo,
				ItemStatusID from Items 
				left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
				and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
				inner join Visits  on Items.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and (BillNo = @CompanyNo and InsuranceNo = @BillNo)
				order by VisitDate desc, Items.VisitNo asc
			end
		else
			begin
				select  Items.VisitNo, Visits.PatientNo, VisitDate, BillNo, Items.ItemCode, Quantity, 
			  UnitPrice, dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)  as BillPrice,
				dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
				(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount, 		
				
				dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName,
				ItemDetails, Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
 				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, MemberCardNo, MainMemberName, ClaimReferenceNo, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,UnitMeasure,ItemName, Dosage, Duration,
				dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName, 
				dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo,
				ItemStatusID from Items 
				left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
				and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
				inner join Visits  on Items.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0 
				and (BillNo = @BillNo or InsuranceNo = @BillNo)
				order by  VisitDate desc, Items.VisitNo asc
			end
	else if (@BillModesID = @InsuranceBillModesID) -- Bill Insurance
		 if not(@CompanyNo is null)
			begin
				select  Items.VisitNo, Visits.PatientNo, VisitDate, BillNo, Items.ItemCode, Quantity, 
		 	    UnitPrice, dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)  as BillPrice,
				dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
				(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount, 		
				dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName,
				ItemDetails, Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
 				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, MemberCardNo, MainMemberName, ClaimReferenceNo, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,UnitMeasure,ItemName, Dosage, Duration,
				dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName, 
				dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo, ItemStatusID
 
				from Items 
				left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
				and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
				inner join Visits  on Items.VisitNo = Visits.VisitNo
				--inner join Queues on Queues.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo		
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and dbo.GetSchemeInsuranceNo(Visits.BillNo) = @BillNo
				and dbo.GetSchemeCompanyNo(BillNo) = @CompanyNo
				order by VisitDate desc, Items.VisitNo asc
			end
		else
			begin
				select  Items.VisitNo, Visits.PatientNo, VisitDate, BillNo, Items.ItemCode, Quantity, 
			   UnitPrice, dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)  as BillPrice,
				dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
				(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount, 		
				dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName,
				ItemDetails, Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
 				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, MemberCardNo, MainMemberName, ClaimReferenceNo, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,UnitMeasure,ItemName, Dosage, Duration,
				dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName, 
				dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo, 
				ItemStatusID from Items 
				left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
				and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
				inner join Visits  on Items.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo
				--inner join Queues on Queues.VisitNo = Visits.VisitNo		
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and dbo.GetSchemeInsuranceNo(Visits.BillNo) = @BillNo
				order by  VisitDate desc, Items.VisitNo asc
			end
end	
return 0
go


-- select * from Visits
-- exec uspGetNotPaidItems '17C', 'CASH'
-- exec uspGetNotPaidItems '17C', 'CASH', 'apr 15, 2012', 'apr 30, 2012'
-- exec uspGetNotPaidItems '17A', 'CM00130'
-- exec uspGetNotPaidItems '17A', 'CM00130', 'apr 15, 2012', 'apr 30, 2012'
-- exec uspGetNotPaidItems '17I', 'CMC'
-- exec uspGetNotPaidItems '17I', 'CMC', null, null, 'URA'
-- exec uspGetNotPaidItems '17I', 'CMC', 'Jul 1, 2012', 'Jul 15, 2012'
-- exec uspGetNotPaidItems '17I', 'CMC', 'Jul 1, 2012', 'Jul 15, 2012', 'URA'



--------GetInvoicedNotPaidItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInvoicedNotPaidItems')
	drop proc uspGetInvoicedNotPaidItems
go

create proc uspGetInvoicedNotPaidItems(
@BillModesID varchar(10),
@BillNo varchar(20),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null,
@CompanyNo varchar(20) = null
)with encryption as

declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)
declare @NotPaidPayStatusID varchar(10)
declare @ServicePointID varchar(10)

--------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
--------------------------------------------------------------------------
set @ServicePointID = dbo.GetLookupDataID('ServicePoint', 'CAS')


if not(@StartDate is null) and not(@EndDate is null)
begin
	if (@BillNo = 'CASH' and @BillModesID = @CashBillModesID) -- Bill Cash
		begin
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate,
			dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity, UnitPrice,
			Quantity * UnitPrice as Amount, ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo

			from Items 
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			left outer join Queues  on Queues.VisitNo = Visits.VisitNo and ServicePointID=@ServicePointID and QueueStatus=1
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and BillNo = @BillNo and VisitDate between @StartDate and @EndDate and dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode)>0
			union
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate,
			dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity, UnitPrice,
			Quantity * UnitPrice as Amount, ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, Items.InvoiceNo
	
			from Items
			inner join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
			and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			left outer join Queues  on Queues.VisitNo = Visits.VisitNo and ServicePointID=@ServicePointID and QueueStatus=1
			where CashPayStatusID = @NotPaidPayStatusID	and (Quantity*UnitPrice)>0 
			and VisitDate between @StartDate and @EndDate 
			and not Items.InvoiceNo in (null, '')
			order by TokenNo asc
		end
	else if (@BillModesID = @AccountBillModesID) -- Bill Account 
		 if not(@CompanyNo is null)
			begin
				select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, MainMemberName, ClaimReferenceNo,
				dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity,
				dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice) as BillPrice, UnitPrice,
				(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount,
				
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, Items.ItemCode, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
				Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory,ItemName, 
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
				dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
				dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
				dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
				dbo.GetTime(Items.RecordDateTime) as RecordTime,
	            dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo
	
 				from Items 
				inner join Visits on Items.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo
				--inner join Queues on Queues.VisitNo = Visits.VisitNo
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0 
				and (BillNo = @CompanyNo and InsuranceNo = @BillNo) 
				and VisitDate between @StartDate and @EndDate
				and dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode)>0
				order by VisitDate, Items.RecordDateTime
			end
		else
		begin
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, MainMemberName, ClaimReferenceNo,
			dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity,
		    dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice) as BillPrice, UnitPrice,
			(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount,
						
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, Items.ItemCode, 
			CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory,ItemName, 
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo
	
 			from Items 
			inner join Visits on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			--inner join Queues on Queues.VisitNo = Visits.VisitNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and (BillNo = @BillNo or InsuranceNo = @BillNo) 
			and VisitDate between @StartDate and @EndDate
			and dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode)>0
			order by VisitDate, Items.RecordDateTime
		end
	else if (@BillModesID = @InsuranceBillModesID) -- Bill Insurance
		 if not(@CompanyNo is null)
			begin
				select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo, 
				dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, MainMemberName, ClaimReferenceNo,
				dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity,
				dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice) as BillPrice, UnitPrice,
				(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount,
				
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, Items.ItemCode, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
				Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory,ItemName,
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
				dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
				dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
				dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
				dbo.GetTime(Items.RecordDateTime) as RecordTime,
				dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo
	
 				from Items 
				inner join Visits on Items.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo
				--inner join Queues on Queues.VisitNo = Visits.VisitNo
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo and VisitDate between @StartDate and @EndDate
				and dbo.GetSchemeCompanyNo(BillNo) = @CompanyNo
				and dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode)>0
				order by VisitDate, Items.RecordDateTime
			end
		else
		begin
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, MainMemberName, ClaimReferenceNo,
			dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity,
			dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice) as BillPrice, UnitPrice,
			(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, Items.ItemCode, 
			CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate,
	        dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo
		from Items 
			inner join Visits on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			--inner join Queues on Queues.VisitNo = Visits.VisitNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo and VisitDate between @StartDate and @EndDate
			order by VisitDate, Items.RecordDateTime
		end	
end
else
begin
	if (@BillNo = 'CASH' and @BillModesID = @CashBillModesID) -- Bill Cash
		begin
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo,
			dbo.FormatDate(VisitDate) as VisitDate,FirstName,
			dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity, UnitPrice,
			Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
	        dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo
	
			from Items 
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			left outer join Queues on Queues.VisitNo = Visits.VisitNo  and ServicePointID=@ServicePointID and QueueStatus=1
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and BillNo = @BillNo and (Quantity*UnitPrice)>0
			union
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate,
			dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode, Quantity, UnitPrice,
			Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(CashPayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
	        dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, Items.InvoiceNo
	
			from Items
			inner join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
			and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			left outer join Queues on Queues.VisitNo = Visits.VisitNo  and ServicePointID=@ServicePointID and QueueStatus=1
			where CashPayStatusID = @NotPaidPayStatusID and (Quantity*UnitPrice)>0
			and dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode)>0
			order by TokenNo asc 
		end
	else if (@BillModesID = @AccountBillModesID) -- Bill Account
		 if not(@CompanyNo is null)
			begin
				select  Items.VisitNo, Visits.PatientNo, VisitDate, BillNo, Items.ItemCode, Quantity, 
				dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice) as BillPrice, UnitPrice,
				dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
				(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount, 		
							
				dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName,
				ItemDetails, Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
 				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, MemberCardNo, MainMemberName, ClaimReferenceNo, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,UnitMeasure,ItemName, Dosage, Duration,
				dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName, ItemStatusID,
				dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo
				 from Items 
				left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
				and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
				inner join Visits  on Items.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo
				--inner join Queues  on Queues.VisitNo = Visits.VisitNo		
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and (BillNo = @CompanyNo and InsuranceNo = @BillNo)
				order by VisitDate desc, Items.VisitNo asc
			end
		else
			begin
				select  Items.VisitNo, Visits.PatientNo, VisitDate, BillNo, Items.ItemCode, Quantity, 
				dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice) as BillPrice, UnitPrice,
				dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
				(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount, 		
				
				dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName,
				ItemDetails, Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
 				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, MemberCardNo, MainMemberName, ClaimReferenceNo, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,UnitMeasure,ItemName, Dosage, Duration,
				dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName, ItemStatusID, 
				dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo
				 from Items 
				left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
				and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
				inner join Visits  on Items.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo
				--inner join Queues on Queues.VisitNo = Visits.VisitNo		
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and (BillNo = @BillNo or InsuranceNo = @BillNo)
				and dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode)>0
				order by  VisitDate desc, Items.VisitNo asc
			end
	else if (@BillModesID = @InsuranceBillModesID) -- Bill Insurance
		 if not(@CompanyNo is null)
			begin
				select  Items.VisitNo, Visits.PatientNo, VisitDate, BillNo, Items.ItemCode, Quantity, 
				dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice) as BillPrice, UnitPrice,
				dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
				(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount, 		
				dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName,
				ItemDetails, Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
 				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, MemberCardNo, MainMemberName, ClaimReferenceNo, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,UnitMeasure,ItemName, Dosage, Duration,
				dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName,
				dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo, 
				ItemStatusID from Items 
				left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
				and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
				inner join Visits  on Items.VisitNo = Visits.VisitNo
				--inner join Queues on Queues.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo		
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and dbo.GetSchemeInsuranceNo(Visits.BillNo) = @BillNo
				and dbo.GetSchemeCompanyNo(BillNo) = @CompanyNo
				order by VisitDate desc, Items.VisitNo asc
			end
		else
			begin
				select  Items.VisitNo, Visits.PatientNo, VisitDate, BillNo, Items.ItemCode, Quantity, 
				dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice) as BillPrice, 
				UnitPrice, dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
				(Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice)) as Amount, 		
				
				dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName,
				ItemDetails, Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, 
 				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, MemberCardNo, MainMemberName, ClaimReferenceNo, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,UnitMeasure,ItemName, Dosage, Duration,
				dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName,
				dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode) as InvoiceAmount, InvoiceNo, 
				ItemStatusID from Items 
				left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
				and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
				inner join Visits  on Items.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo
				--inner join Queues on Queues.VisitNo = Visits.VisitNo		
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and dbo.GetSchemeInsuranceNo(Visits.BillNo) = @BillNo
				and dbo.GetOPDItemInvoicedAmount(Items.VisitNo,Items.ItemCategoryID,Items.ItemCode)>0
				order by  VisitDate desc, Items.VisitNo asc
			end
end	
return 0
go



--------GetNotPaidItemsByVisitNo----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNotPaidItemsByVisitNo')
	drop proc uspGetNotPaidItemsByVisitNo
go

create proc uspGetNotPaidItemsByVisitNo(
@VisitNo varchar(20)
)with encryption as

declare @NotPaidPayStatusID varchar(10)

--------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
--------------------------------------------------------------------------

begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
	MemberCardNo, MainMemberName, ClaimReferenceNo, 
	dbo.FormatDate(VisitDate) as VisitDate, 
	Quantity, UnitPrice, Quantity * UnitPrice as Amount, 
	dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, Items.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory,ItemName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,	
	dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,InvoiceNo

	
	from Items 
	inner join Visits on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where PayStatusID = @NotPaidPayStatusID and (Quantity*UnitPrice)>0 and Visits.VisitNo = @VisitNo 
	order by Items.VisitNo desc
end
return 0
go

-- select * from Visits
-- exec uspGetNotPaidItemsByVisitNo '005002'



--------Get VisitItemsByInvoiceStatus ----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisitItemsByInvoiceStatus')
	drop proc uspGetVisitItemsByInvoiceStatus
go

create proc uspGetVisitItemsByInvoiceStatus(
@VisitNo varchar(20),
@InvoiceStatus bit= 0
)with encryption as

declare @NotPaidPayStatusID varchar(10)

--------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
--------------------------------------------------------------------------
if @InvoiceStatus = 0
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, InvoiceNo,
	MemberCardNo, MainMemberName, ClaimReferenceNo, 
	dbo.FormatDate(VisitDate) as VisitDate, Quantity, 
   UnitPrice, Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice) as Amount,
	dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice) as BillPrice, 
	dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, Items.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory,ItemName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,	
	dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty
	
	from Items 
	inner join Visits on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where PayStatusID = @NotPaidPayStatusID and Visits.VisitNo = @VisitNo and (InvoiceNo ='' or InvoiceNo is null) 
	order by Items.RecordDateTime desc

end

else if @InvoiceStatus = 1
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, InvoiceNo,
	MemberCardNo, MainMemberName, ClaimReferenceNo, 
	dbo.FormatDate(VisitDate) as VisitDate, Quantity, 
	 UnitPrice, dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice) as BillPrice, 
	Quantity * dbo.GetItemBillPrice(Items.VisitNo, Items.ItemCode, Items.ItemCategoryID, CoPayTypeID, CoPayPercent, Items.UnitPrice) as Amount,
	dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, Items.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory,ItemName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,	
	dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty
	
	
	from Items 
	inner join Visits on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where  Visits.VisitNo = @VisitNo and not (InvoiceNo ='' or InvoiceNo is null) 
	order by Items.RecordDateTime desc

end
return 0
go

-- select * from Items order by RecordDateTime desc
-- exec uspGetVisitItemsByInvoiceStatus 'P160040940001', 0


-- select * from Items order by RecordDateTime desc
-- exec uspGetVisitItemsByInvoiceStatus '1010665014', 0

--------GetPendingItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPendingItems')
	drop proc uspGetPendingItems
go

create proc uspGetPendingItems(
@ItemCategoryID varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @PendingItemStatusID varchar(10)
declare @Laboratory varchar(10)
declare @Cardiology varchar(10)
declare @Radiology varchar(10)
declare @Drug varchar(10)

declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @DrugID varchar(10)


----------------------------------------------------------------------------------------------------
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')
set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
-----------------------------------------------------------------------------------------------------
set @PendingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @Laboratory = dbo.GetLookupDataID('ServicePoint', 'LAB')
set @Cardiology = dbo.GetLookupDataID('ServicePoint', 'CAR')
set @Radiology = dbo.GetLookupDataID('ServicePoint', 'RAD')
set @Drug = dbo.GetLookupDataID('ServicePoint', 'PHA')




if not(@StartDate is null) and not(@EndDate is null)
begin
if(@ItemCategoryID=@TestID)
    begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo, FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,			
				ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
			
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues on Visits.VisitNo = Queues.VisitNo and ServicePointID=@Laboratory and QueueStatus=1
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	and VisitDate between @StartDate and @EndDate
	order by TokenNo asc, VisitDate, Items.RecordDateTime
  end

  --------------------------Cardiology-------------------------------------------------------------------------------------
else if(@ItemCategoryID=@CardiologyID)
    begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,			
			ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
			
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues on Visits.VisitNo = Queues.VisitNo and ServicePointID=@Cardiology and QueueStatus=1 and Queues.RecordDateTime  between @StartDate and @EndDate
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	and VisitDate between @StartDate and @EndDate
	order by TokenNo asc, VisitDate, Items.RecordDateTime
  end

--------------------------Radiology-------------------------------------------------------------------------------------
else if(@ItemCategoryID=@RadiologyID)
    begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,			
			ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
			
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues on Visits.VisitNo = Queues.VisitNo and ServicePointID=@Radiology and QueueStatus=1 and Queues.RecordDateTime  between @StartDate and @EndDate
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	and VisitDate between @StartDate and @EndDate
	order by TokenNo asc, VisitDate, Items.RecordDateTime
  end

  --------------------------Drug-------------------------------------------------------------------------------------
else if(@ItemCategoryID=@DrugID)
    begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,TokenNo,FirstName,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
			
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues on Visits.VisitNo = Queues.VisitNo and ServicePointID=@Drug and QueueStatus=1
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	and VisitDate between @StartDate and @EndDate
	order by TokenNo asc, VisitDate, Items.RecordDateTime
  end

  else
    begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,'' as TokenNo, FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
			
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	and VisitDate between @StartDate and @EndDate
	order by  VisitDate, Items.RecordDateTime
  end
  
end
else
begin
	if(@ItemCategoryID=@TestID)
    begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
			
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues on Visits.VisitNo = Queues.VisitNo and ServicePointID=@Laboratory and QueueStatus=1
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	order by TokenNo asc, VisitDate, Items.RecordDateTime
  end


--------------------------Cardiology-------------------------------------------------------------------------------------
else if(@ItemCategoryID=@CardiologyID)
    begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
			
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues on Visits.VisitNo = Queues.VisitNo and ServicePointID=@Cardiology and QueueStatus=1
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	order by TokenNo asc, VisitDate, Items.RecordDateTime
  end


--------------------------Radiology-------------------------------------------------------------------------------------
else if(@ItemCategoryID=@RadiologyID)
    begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
			
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues on Visits.VisitNo = Queues.VisitNo and ServicePointID=@Radiology and QueueStatus=1
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	order by TokenNo asc, VisitDate, Items.RecordDateTime
  end

  --------------------------Drug-------------------------------------------------------------------------------------
else if(@ItemCategoryID=@DrugID)
    begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo,FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
			
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues on Visits.VisitNo = Queues.VisitNo and ServicePointID=@Drug and QueueStatus=1
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	order by TokenNo asc, VisitDate, Items.RecordDateTime
  end

  else
    begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,'' as TokenNo, FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
			
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	order by VisitDate, Items.RecordDateTime
  end
end	
return 0
go

-- select * from Visits
-- exec uspGetProcessingItems '7R'
-- exec uspGetProcessingItems '7R', 'apr 3, 2014', 'Apr 4, 2014'


-- select * from Visits
-- exec uspGetPendingItems '7T'
-- exec uspGetPendingItems '7T', 'apr 15, 2011', 'may 30, 2011'




--------GetProcessingItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetProcessingItems')
	drop proc uspGetProcessingItems
go

create proc uspGetProcessingItems(
@ItemCategoryID varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @ProcessingItemStatusID varchar(10)
declare @ServicePointID varchar(10)
-- declare @CardiologyID varchar(10)
declare @RadiologyID varchar(10)
set @ProcessingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'R')
set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
-- set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')
set @ServicePointID=dbo.GetLookupDataID('ServicePoint', 'RAD')


if not(@StartDate is null) and not(@EndDate is null)
begin

if @ItemCategoryID=@RadiologyID
  begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,TokenNo, FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime
	from Items  
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues  on Queues.VisitNo = Items.VisitNo and ServicePointID=@ServicePointID and QueueStatus=1
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @ProcessingItemStatusID
	and VisitDate between @StartDate and @EndDate
	order by TokenNO asc, VisitNo desc
   end
else
 begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,'' as TokenNo, FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
	from Items  
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @ProcessingItemStatusID
	and VisitDate between @StartDate and @EndDate
	order by VisitNo desc
 end
end

else
begin

  if(@ItemCategoryID=@RadiologyID)
     begin
	  select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,TokenNo, FirstName,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues  on Queues.VisitNo = Items.VisitNo and ServicePointID=@ServicePointID and QueueStatus=1
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @ProcessingItemStatusID
	order by TokenNo asc, VisitNo desc
end
else
   begin
      select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,'' as TokenNo, FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @ProcessingItemStatusID
	order by VisitNo desc
 end	
    
end	
return 0
go

-- select * from Visits
-- exec uspGetProcessingItems '7R'
-- exec uspGetProcessingItems '7R', 'apr 3, 2014', 'Apr 4, 2014'


--------GetDoneItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDoneItems')
	drop proc uspGetDoneItems
go

create proc uspGetDoneItems(
@ItemCategoryID varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @DoneItemStatusID varchar(10)
set @DoneItemStatusID = dbo.GetLookupDataID('ItemStatus', 'D')

if not(@StartDate is null) and not(@EndDate is null)
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @DoneItemStatusID
	and VisitDate between @StartDate and @EndDate
	order by VisitNo desc
end
else
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @DoneItemStatusID
	order by VisitNo desc
end	
return 0
go

-- select * from Visits
-- exec uspGetDoneItems '7R'
-- exec uspGetDoneItems '7R', 'apr 15, 2011', 'may 30, 2011'

--------GetDoctorItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDoctorItems')
	drop proc uspGetDoctorItems
go

create proc uspGetDoctorItems(
@ItemCategoryID varchar(10),
@StaffLoginID varchar(20),
@ShowOnlyPending bit,
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @PendingItemStatusID varchar(10)
set @PendingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')

if (@ShowOnlyPending = 1) and not(@StartDate is null) and not(@EndDate is null)
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, Quantity, UnitPrice, DrQuantity,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
	from Items
	left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
	and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	inner join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
	where Items.ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	and dbo.GetStaffLoginID(DoctorVisits.StaffNo) = @StaffLoginID 
	and VisitDate between @StartDate and @EndDate
	order by VisitNo desc
end
else if (@ShowOnlyPending = 0) and not(@StartDate is null) and not(@EndDate is null)
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, Quantity, UnitPrice, DrQuantity,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
	from Items
	left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
	and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	inner join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
	where Items.ItemCategoryID = @ItemCategoryID
	and dbo.GetStaffLoginID(DoctorVisits.StaffNo) = @StaffLoginID 
	and VisitDate between @StartDate and @EndDate
	order by VisitNo desc
end
else if (@ShowOnlyPending = 1) 
	begin
		select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatDate(VisitDate) as VisitDate, Quantity, UnitPrice, DrQuantity,ItemName,
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
				dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
		from Items
		left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
		and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID  
		inner join Visits  on Items.VisitNo = Visits.VisitNo
		inner join Patients on Visits.PatientNo = Patients.PatientNo
		inner join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
		where Items.ItemCategoryID = @ItemCategoryID  and ItemStatusID = @PendingItemStatusID
		and dbo.GetStaffLoginID(DoctorVisits.StaffNo) = @StaffLoginID 
		order by VisitNo desc
	end	
else
	begin
		select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatDate(VisitDate) as VisitDate, Quantity, UnitPrice, DrQuantity,ItemName,
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
				dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact
		from Items 
		left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
		and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID 
		inner join Visits  on Items.VisitNo = Visits.VisitNo
		inner join Patients on Visits.PatientNo = Patients.PatientNo
		inner join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
		where Items.ItemCategoryID = @ItemCategoryID and dbo.GetStaffLoginID(DoctorVisits.StaffNo) = @StaffLoginID 
		order by VisitNo desc
	end	
return 0
go

-- select * from Visits
-- exec uspGetDoctorItems '7D', 'Admin', 0
-- exec uspGetDoctorItems '7D', 'Admin', 1
-- exec uspGetDoctorItems '7D', 'Admin', 0, 'apr 15, 2011', 'may 30, 2011'
-- exec uspGetDoctorItems '7D', 'Admin', 1, 'apr 15, 2011', 'may 30, 2011'

----------------Get Item-------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetItem')
	drop proc uspGetItem
go

create proc uspGetItem(
@VisitNo varchar(20) ,
@ItemCode varchar(20) ,
@ItemCategoryID varchar(10)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Items where VisitNo = @VisitNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s, %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', does not exist!'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode , 'Item Category')
		return 1
	end
else
begin
		select  VisitNo, ItemCode, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, Quantity, UnitPrice, ItemDetails
		from Items 
		where VisitNo = @VisitNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
end
return 0

go

-- exec uspGetItem '000001BA21078001', '10C','7S'

-- select UnitPrice, * from Items

------------------------------------------------------------------------------------------------------
-------------- ItemsCASH ----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ItemsCASH -----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditItemsCASH')
	drop proc uspEditItemsCASH
go

create proc uspEditItemsCASH(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@CashAmount money,
@CashPayStatusID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)
declare @NotPaidPayStatus  varchar(10)

set @NotPaidPayStatus = dbo.GetLookupDataID('PayStatus', 'NP')

if not exists(select DataID from LookupData where DataID = @CashPayStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cash Pay Status ID', @CashPayStatusID, 'Lookup Data')
		return 1
	end

if not exists(select VisitNo from Items where VisitNo = @VisitNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with Visit No: %s and Item Code: %s and Item Category: %s, does not  exist in registered items'
		raiserror(@ErrorMSG, 16, 1, @VisitNo, @ItemCode, @ItemCategoryID)	
		return 1
	end

if exists(select VisitNo from ItemsCASH where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		if  exists(select VisitNo from ItemsCASH where VisitNo = @VisitNo and ItemCode = @ItemCode and
					ItemCategoryID = @ItemCategoryID and CashPayStatusID = @NotPaidPayStatus) 
			
		begin
			update ItemsCASH set CashAmount = @CashAmount, CashPayStatusID = @CashPayStatusID
			where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
			return 0
		end
		else
		set @ErrorMSG = 'The record with %s: %s and  %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', has been paid for. You can''t update this record!'
		raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo, 'Item Code', @ItemCode , 'Item Category')	
		return 1
	end
else
begin
insert into ItemsCASH
(VisitNo, ItemCode, ItemCategoryID, CashAmount, CashPayStatusID)
values
(@VisitNo, @ItemCode, @ItemCategoryID, @CashAmount, @CashPayStatusID)
return 0
end
go

/******************************************************************************************************
exec uspEditItemsCASH
******************************************************************************************************/
-- select * from ItemsCASH
-- delete from ItemsCASH

-------------- Update ItemsCASH -----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateItemsCASH')
	drop proc uspUpdateItemsCASH
go

create proc uspUpdateItemsCASH(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)
declare @PaidForPayStatusID  varchar(10)

declare @CopayTypeID varchar(10)
declare @ValueCoPayTypeID as varchar(10)
declare @ExtraChargeItemCategoryID varchar(10)
declare @CoPayItemCode varchar(20)

--------------------------------------------------------------------
set @ValueCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'VAL')
set @ExtraChargeItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'E')
set @CoPayItemCode = 'CPV'

set @PaidForPayStatusID = dbo.GetLookupDataID('PayStatus', 'PF')
set @CopayTypeID= (select CopayTypeID from Visits where VisitNo = @VisitNo)

if not exists(select VisitNo from Items where VisitNo = @VisitNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with Visit No: %s and Item Code: %s and Item Category: %s, does not  exist in registered items CASH'
		raiserror(@ErrorMSG, 16, 1, @VisitNo, @ItemCode, @ItemCategoryID)	
		return 1
	end
else
begin
	update ItemsCASH set CashPayStatusID = @PaidForPayStatusID
	where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID

	return 0
end   
go

/******************************************************************************************************
exec uspUpdateItemsCASH
******************************************************************************************************/
-- select * from ItemsCASH
-- delete from ItemsCASH


-------------- Update ItemsCASH InvoiceNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateItemsCASHInvoiceNo')
	drop proc uspUpdateItemsCASHInvoiceNo
go

create proc uspUpdateItemsCASHInvoiceNo(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@InvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select VisitNo from ItemsCASH where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Items CASH')
		return 0
	end
begin

update ItemsCASH set
InvoiceNo = @InvoiceNo
where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspUpdateItemsCASHInvoiceNo 'P160009550006', 'CPV', '7E', '1900001'
******************************************************************************************************/
-- select * from ItemsCASH
-- delete from ItemsCASH


-------------- Get ItemsCASH -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetItemsCASH')
	drop proc uspGetItemsCASH
go

create proc uspGetItemsCASH(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select VisitNo, ItemCode, ItemCategoryID, CashAmount, 
	CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus
	from ItemsCASH
	where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetItemsCASH
******************************************************************************************************/
-- select * from ItemsCASH
-- delete from ItemsCASH

------------------------------------------------------------------------------------------------------
-------------- ItemsEXT ------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ItemsEXT -------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditItemsEXT')
	drop proc uspEditItemsEXT
go

create proc uspEditItemsEXT(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Dosage varchar(100),
@Duration int,
@DrQuantity int
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Items where VisitNo = @VisitNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with Visit No: %s and Item Code: %s and Item Category: %s, does not  exist in registered items'
		raiserror(@ErrorMSG,16,1, @VisitNo, @ItemCode, @ItemCategoryID)	
		return 1
	end

if exists(select VisitNo from ItemsEXT where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		update ItemsEXT set
		Dosage = @Dosage, Duration = @Duration, DrQuantity = @DrQuantity
		where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
		return 0
	end
else
begin
insert into ItemsEXT
(VisitNo, ItemCode, ItemCategoryID, Dosage, Duration, DrQuantity)
values
(@VisitNo, @ItemCode, @ItemCategoryID, @Dosage, @Duration, @DrQuantity)
return 0
end
go

/******************************************************************************************************
exec uspEditItemsEXT '000001BA21078001', 'M 0011B', '7D', '2X3', 5
exec uspEditItemsEXT '000001BA21078001', 'M 0188', '7D', '2X3', 5
exec uspEditItemsEXT '000001BA21078002', 'M 0070', '7D', '2X2', 3

******************************************************************************************************/
-- select * from ItemsEXT
-- delete from ItemsEXT

-------------- Update ItemsEXT -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateItemsEXT')
	drop proc uspUpdateItemsEXT
go

create proc uspUpdateItemsEXT(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Pharmacist varchar(10),
@LocationID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @IssueDateTime smalldatetime

set @IssueDateTime = GETDATE()

if not exists(select VisitNo from ItemsEXT where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Items EXTRA')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Pharmacist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pharmacist', @Pharmacist, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update ItemsEXT set
IssueDateTime = @IssueDateTime, Pharmacist = @Pharmacist, LocationID = @LocationID, 
LoginID = @LoginID, ClientMachine = @ClientMachine
where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspUpdateItemsEXT '001002', 'M603', '7D', '22 Oct 2012', 'P001', 'Admin'

******************************************************************************************************/
-- select * from ItemsEXT
-- delete from ItemsEXT


------------------------------------------------------------------------------------------------------
-------------- ExchangeRates -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ExchangeRates --------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditExchangeRates')
	drop proc uspEditExchangeRates
go

create proc uspEditExchangeRates(
@CurrenciesID varchar(10),
@Buying money,
@Selling money,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @RecordDateTime smalldatetime

----------------------------------------------------------------------------------------------------
set @RecordDateTime = Getdate()
----------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @CurrenciesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrenciesID, 'Lookup Data')
		return 1
	end
	
if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select CurrenciesID from ExchangeRates where CurrenciesID = @CurrenciesID)
	begin
		update ExchangeRates set
		Buying = @Buying, Selling = @Selling, LoginID = @LoginID, RecordDateTime = @RecordDateTime
		where CurrenciesID = @CurrenciesID
		return 0
	end
else
begin
insert into ExchangeRates
(CurrenciesID, Buying, Selling, LoginID, RecordDateTime)
values
(@CurrenciesID, @Buying, @Selling, @LoginID, @RecordDateTime)
return 0
end
go

/******************************************************************************************************
exec uspEditExchangeRates '49USD', 2500, 'Admin'
exec uspEditExchangeRates '49KEY', 30, 'Admin'
exec uspEditExchangeRates '49KEY', 0, 'Admin'

******************************************************************************************************/
-- select * from ExchangeRates
-- delete from ExchangeRates

-------------- Get ExchangeRates --------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExchangeRates')
	drop proc uspGetExchangeRates
go

create proc uspGetExchangeRates(
@CurrenciesID varchar(10) = null
)with encryption as

if (not @CurrenciesID is null)

begin
	select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, Buying, Selling
	from ExchangeRates
	where CurrenciesID = @CurrenciesID
end
else
begin
	select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, Buying, Selling
	from ExchangeRates
end

return 0
go

/******************************************************************************************************
exec uspGetExchangeRates
exec uspGetExchangeRates '49USD'
exec uspGetExchangeRates '49UGX'

*******************************************************************************************************/
-- select * from ExchangeRates
-- delete from ExchangeRates

------------------------------------------------------------------------------------------------------
------------- Payments -------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Payments -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPayments')
	drop proc uspInsertPayments
go

create proc uspInsertPayments(
@ReceiptNo varchar(20),
@PayTypeID varchar(10),
@PayNo varchar(20),
@ClientFullName varchar(100),
@PayDate smalldatetime,
@PayModesID varchar(20),
@DocumentNo varchar(20),
@AmountWords varchar(200) ,
@Notes varchar(100),
@CurrenciesID varchar(10),
@WithholdingTax money,
@GrandDiscount money,
@AmountTendered money,
@ExchangeRate money,
@Change money,
@SendBalanceToAccount bit,
@UseAccountBalance bit,
@VisitTypeID varchar(10),
@FilterNo varchar(20) = null,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as 

declare @ErrorMSG varchar(200)

declare @CashVisitPayTypeID varchar(10)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)
declare @IPDRoundPayTypeID varchar(10)
declare @ExtraBillPayTypeID varchar(10)
declare @BranchID varchar(10)
declare @ReceiptNoPrefix varchar(12)
declare @OptionValue varchar(10)
declare @ReceiptID int
declare @CurrentYear as char(2)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedReceiptID int
declare @PassedReceiptNo varchar(20)

----------------------------------------------------------------------------
set @BranchID = dbo.GetMyCurrentBranch(@LoginID)
set @CashVisitPayTypeID =  dbo.GetLookupDataID('PayType', 'CAS')
set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')
set @IPDRoundPayTypeID = dbo.GetLookupDataID('PayType', 'IPR')
set @ExtraBillPayTypeID = dbo.GetLookupDataID('PayType', 'EXT')
----------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------
if ((@PayTypeID = @CashVisitPayTypeID) or (@PayTypeID = @ExtraBillPayTypeID))
	begin
		if not exists(select VisitNo from Visits where VisitNo = @PayNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Visit No', @PayNo, 'Visits')
				return 1
			end
	end

else if (@PayTypeID = @AccountBillPayTypeID)
	begin 
		if not exists(select AccountNo from BillCustomers where AccountNo = @PayNo)
			begin
				set @ErrorMSG = 'The  %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Account No', @PayNo, 'To-Bill Customers')	
				return 1
			end
	end

else if (@PayTypeID = @InsuranceBillPayTypeID)
	begin 
		if not exists(select InsuranceNo from Insurances where InsuranceNo = @PayNo)
			begin
				set @ErrorMSG = 'The  %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Insurance No', @PayNo, 'Insurances')	
				return 1
			end
	end

else if (@PayTypeID = @IPDRoundPayTypeID)
	begin 
		if not exists(select RoundNo from IPDDoctor where RoundNo  = @PayNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Round No', @PayNo, 'IPD Doctor')
				return 1
			end
	end
	
------------------------------------------------------------------------------------------------------------------

if exists(select ReceiptNo from Payments where ReceiptNo = @ReceiptNo)
	begin
		set @ErrorMSG = 'The Receipt No: ' + @ReceiptNo + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pay Type', @PayTypeID, 'Lookup Data')
		return 1
	end	
	
if (@PayDate > GetDate())
	begin		
		set @ErrorMSG = 'The %s: ' + ltrim(rtrim(dbo.FormatDate(@PayDate))) + ', you are trying to enter can''t be ahead of today’s date as set by server administrator'
		raiserror(@ErrorMSG, 16, 1, 'Pay Date')
	 	return 1
	end
	
if not exists(select DataID from LookupData where DataID = @PayModesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pay Modes', @PayModesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CurrenciesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrenciesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisitTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit Type', @VisitTypeID, 'Lookup Data')
		return 1
	end
	
if not (@FilterNo is null or @FilterNo = '') 
	begin
		if not exists(select VisitNo from Visits where VisitNo  = @FilterNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Filter No', @FilterNo, 'Visits')
				return 1
			end
	end
else if (@FilterNo is null or @FilterNo = '') 
begin set @FilterNo = null end
	
if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

else
begin

---------------------------------------------------------------------------------------------------------------------

select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'Payments' and AutoColumnName = 'ReceiptNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'Payments' and AutoColumnName = 'ReceiptNo'

set @OptionValue = dbo.GetOptionValue('ReceiptNoPrefix')
set @CurrentYear = right(year(getdate()),2)
set @ReceiptNoPrefix = @OptionValue + @CurrentYear

if (@AutoColumnLEN = len(@ReceiptNo)) and (left(@ReceiptNo, len(@ReceiptNoPrefix)) = @ReceiptNoPrefix)

begin

	set @PassedReceiptID = 1
	set @PassedReceiptNo = @ReceiptNo
	set @PassedReceiptNo = ltrim(rtrim(substring(@PassedReceiptNo, len(@ReceiptNoPrefix) + 1, @PaddingLEN)))
	if isnumeric(@PassedReceiptNo) = 1 set @PassedReceiptID = @PassedReceiptNo
	else set @PassedReceiptID = 1

	set @ReceiptID = (select max(ReceiptID) from Payments where left(ReceiptNo, len(@ReceiptNoPrefix)) = @ReceiptNoPrefix)

	set @ReceiptID = dbo.GetNextAutoNumber('Payments', 'ReceiptNo', @ReceiptID)

	if @PassedReceiptID < @ReceiptID set @ReceiptID = @PassedReceiptID
	if @PassedReceiptID > @ReceiptID set @ReceiptID = @PassedReceiptID

end else set @ReceiptID = 1

---------------------------------------------------------------------------------------------------------------------------
insert into Payments
(ReceiptID, ReceiptNo, PayTypeID, PayNo, ClientFullName, PayDate, PayModesID, DocumentNo, AmountWords, Notes, CurrenciesID, 
AmountTendered, WithholdingTax, GrandDiscount, ExchangeRate, Change, SendBalanceToAccount, UseAccountBalance, VisitTypeID, FilterNo,BranchID, LoginID, ClientMachine) 
values
(@ReceiptID, @ReceiptNo, @PayTypeID, @PayNo,@ClientFullName,@PayDate, @PayModesID, @DocumentNo, @AmountWords, @Notes, @CurrenciesID, 
@AmountTendered, @WithholdingTax, @GrandDiscount, @ExchangeRate, @Change, @SendBalanceToAccount, @UseAccountBalance, @VisitTypeID, @FilterNo,@BranchID, @LoginID, @ClientMachine)

return 0
end
go

/*************************************************************************************
--1-----------------------------------------------------------------------------------
exec uspInsertPayments 13, '47VIS', '0600001001', '1 May 2005','6CA', 'Doc: 001', 
						'Amount Words', 'Payment for the drugs taken', 'Admin'

*************************************************************************************/

-- select *  from payments
-- delete from Payments

-------------- Get Payments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPayments')
	drop proc uspGetPayments
go

create proc uspGetPayments(
@ReceiptNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ReceiptNo from Payments where ReceiptNo = @ReceiptNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payments')
		return 1
	end
else
begin
	select ReceiptNo, PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,	
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, PayDate, 
	dbo.FormatMoney(dbo.GetOutstandingBalance(dbo.GetPayeeNo(PayTypeID, PayNo))) as OutstandingBalance,
	PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
	AmountTendered, ExchangeRate, Change, UseAccountBalance,
	dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded,
	VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as VisitType
	from Payments
	where ReceiptNo = @ReceiptNo
return 0
end
go

/******************************************************************************************************
exec uspGetPayments '13010353'
exec uspGetPayments '13010334'
exec uspGetPayments '13010342'
exec uspGetPayments '13010352'

******************************************************************************************************/
-- select * from Payments
-- delete from Payments


--------GetCashPayments----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCashPayments')
	drop proc uspGetCashPayments
go

create proc uspGetCashPayments(
@ReceiptNo varchar(20) = null,
@StartDateTime smalldatetime = null,
@EndDateTime smalldatetime = null,
@LoginID varchar(20) = null,
@VisitsBranch varchar(10) =null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@ReceiptNo is null) and (@StartDateTime is null) and (@EndDateTime is null) and (@LoginID is null) and (@VisitsBranch is null)
	begin
		if not exists(select ReceiptNo from Payments where ReceiptNo = @ReceiptNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payments')
				return 1
			end
		else
			begin
				select ReceiptNo, PayNo, VisitNo, PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
				PatientNo, dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,ClientFullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
				CoPayValue, dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount,
				dbo.FormatDate(VisitDate) as VisitDate, DocumentNo, Notes, SendBalanceToAccount, 
				dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(AmountPaid-AmountRefunded) as NetAmount, UseAccountBalance, 
				CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
				AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
				dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,VisitsBranch,VisitsBranchID
				from CashPayments
				where ReceiptNo = @ReceiptNo
			end
	end	
else if (@ReceiptNo is null) and (@LoginID is null) and (@VisitsBranch is null) and not(@StartDateTime is null) and not(@EndDateTime is null) 
	begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,
		PayNo, dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatText(PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,ClientFullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
		CoPayValue, dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount,
		dbo.FormatDate(VisitDate) as VisitDate, DocumentNo, Notes, SendBalanceToAccount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(AmountPaid-AmountRefunded) as NetAmount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
		,VisitsBranch,VisitsBranchID
		from CashPayments
		where RecordDateTime >= @StartDateTime And RecordDateTime < @EndDateTime
		order by PayDate, RecordDateTime
	end

else if (@ReceiptNo is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null) and not(@VisitsBranch is null)
	begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, 
		PayNo, dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatText(PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,ClientFullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
		CoPayValue, dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount,
		dbo.FormatDate(VisitDate) as VisitDate, DocumentNo, Notes, SendBalanceToAccount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(AmountPaid-AmountRefunded) as NetAmount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,
		VisitCategoryID,VisitsBranch,VisitsBranchID
		from CashPayments
		where RecordDateTime >= @StartDateTime And RecordDateTime < @EndDateTime and LoginID = @LoginID 
		and VisitsBranchID =@VisitsBranch
		order by PayDate, RecordDateTime
	end


else if (@ReceiptNo is null) and (@LoginID is null) and not(@StartDateTime is null) and not(@EndDateTime is null)  and not(@VisitsBranch is null)
	begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, 
		PayNo, dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatText(PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,ClientFullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
		CoPayValue, dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount,
		dbo.FormatDate(VisitDate) as VisitDate, DocumentNo, Notes, SendBalanceToAccount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(AmountPaid-AmountRefunded) as NetAmount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,
		VisitCategoryID,VisitsBranch,VisitsBranchID
		from CashPayments
		where RecordDateTime >= @StartDateTime And RecordDateTime < @EndDateTime and VisitsBranchID = @VisitsBranch
		order by PayDate, RecordDateTime
	end

	
else if (@ReceiptNo is null) and (@VisitsBranch is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null)  
	begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, 
		PayNo, dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatText(PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,ClientFullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
		CoPayValue, dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount,
		dbo.FormatDate(VisitDate) as VisitDate, DocumentNo, Notes, SendBalanceToAccount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(AmountPaid-AmountRefunded) as NetAmount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,
		VisitCategoryID,VisitsBranch,VisitsBranchID
		from CashPayments
		where RecordDateTime >= @StartDateTime And RecordDateTime < @EndDateTime and LoginID = @LoginID
		order by PayDate, RecordDateTime
	end



else 
	begin
		select ReceiptNo, PayNo, VisitNo, PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		PatientNo, dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,ClientFullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
		CoPayValue, dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords WithholdingTax, GrandDiscount,
		dbo.FormatDate(VisitDate) as VisitDate, DocumentNo, Notes, SendBalanceToAccount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(AmountPaid-AmountRefunded) as NetAmount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,
		VisitCategoryID,VisitsBranch,VisitsBranchID
		from CashPayments
	end	
return 0
go



/******************************************************************************************************
exec uspGetCashPayments '16000013'
exec uspGetCashPayments null, '27 May 2011', '4 Jun 2011'
exec uspGetCashPayments '16000001', '27 May 2011', '4 Jun 2011', 'Admin'
exec uspGetCashPayments 

******************************************************************************************************/
-- select * from Payments


--------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------
----------------------------------- Account Statement --------------------------------------------------
--- Items
--- ExtraBillItems
--- Payments
--- Refunds
--- Accounts


-------------- Get PeriodicItemsByPatientNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicItemsByPatientNo')
	drop proc uspGetPeriodicItemsByPatientNo
go

create proc uspGetPeriodicItemsByPatientNo(
@PatientNo varchar(20),
@StartDate smalldatetime,
@EndDate smalldatetime,
@IncludeProcessing bit = 0,
@IncludePending bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
declare @PendingItemStatusID varchar(10)
declare @ProcessingItemStatusID varchar(10)
declare @OfferedItemStatusID varchar(10)
declare @DoneItemStatusID varchar(10)
declare @CashBillModesID varchar(10)

set @PendingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @ProcessingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'R')
set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')
set @DoneItemStatusID = dbo.GetLookupDataID('ItemStatus', 'D')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')

begin
if @IncludeProcessing = 1 and @IncludePending = 1 
begin
	 select VisitNo, dbo.FormatDate(VisitDate) as VisitDate,  dbo.FormatMoney(sum(Amount)) as Amount
	from 
	(
	select PatientNo, Visits.VisitNo as VisitNo, Visits.VisitDate as VisitDate, (Quantity  * UnitPrice) as Amount, ItemStatusID from
	Items
	inner join Visits on Visits.VisitNo = Items.VisitNo
	where BillModesID = @CashBillModesID
	
	union
	select  PatientNo, Visits.VisitNo, Visits.VisitDate, CashAmount as Amount, ItemStatusID
	from ItemsCASH
	inner join Items on Items.VisitNo = ItemsCASH.VisitNo and Items.ItemCode = ItemsCASH.ItemCode and Items.ItemCategoryID = ItemsCASH.ItemCategoryID
	inner join Visits on Visits.VisitNo = Items.VisitNo
	)as OPDPatientBills
	where PatientNo = @PatientNo and VisitDate >= @StartDate and VisitDate < @EndDate and ItemStatusID in (@PendingItemStatusID, @ProcessingItemStatusID, @OfferedItemStatusID, @DoneItemStatusID)
	group by PatientNo, VisitNo, VisitDate
	order by VisitDate asc

 end
 
 else if @IncludeProcessing =1 and @IncludePending = 0 
begin
	 select VisitNo, dbo.FormatDate(VisitDate) as VisitDate,  dbo.FormatMoney(sum(Amount)) as Amount
	from 
	(
	select PatientNo, Visits.VisitNo as VisitNo, Visits.VisitDate as VisitDate, (Quantity  * UnitPrice) as Amount, ItemStatusID from
	Items
	inner join Visits on Visits.VisitNo = Items.VisitNo
	where BillModesID = @CashBillModesID
	
	union
	select  PatientNo, Visits.VisitNo, Visits.VisitDate, CashAmount as Amount, ItemStatusID
	from ItemsCASH
	inner join Items on Items.VisitNo = ItemsCASH.VisitNo and Items.ItemCode = ItemsCASH.ItemCode and Items.ItemCategoryID = ItemsCASH.ItemCategoryID
	inner join Visits on Visits.VisitNo = Items.VisitNo
	)as OPDPatientBills
	where PatientNo = @PatientNo and VisitDate >= @StartDate and VisitDate < @EndDate and ItemStatusID in (@ProcessingItemStatusID, @OfferedItemStatusID, @DoneItemStatusID)
	group by PatientNo, VisitNo, VisitDate
	order by VisitDate asc

 end
 
 
 else
 begin
	 select VisitNo, dbo.FormatDate(VisitDate) as VisitDate,  dbo.FormatMoney(sum(Amount)) as Amount
	from 
	(
	select PatientNo, Visits.VisitNo as VisitNo, Visits.VisitDate as VisitDate, (Quantity  * UnitPrice) as Amount, ItemStatusID from
	Items
	inner join Visits on Visits.VisitNo = Items.VisitNo
	where BillModesID = @CashBillModesID
	
	union
	select PatientNo, Visits.VisitNo, Visits.VisitDate, CashAmount as Amount, ItemStatusID
	from ItemsCASH
	inner join Items on Items.VisitNo = ItemsCASH.VisitNo and Items.ItemCode = ItemsCASH.ItemCode and Items.ItemCategoryID = ItemsCASH.ItemCategoryID
	inner join Visits on Visits.VisitNo = Items.VisitNo
	)as OPDPatientBills
	where PatientNo = @PatientNo and VisitDate >= @StartDate and VisitDate < @EndDate and ItemStatusID in (@OfferedItemStatusID, @DoneItemStatusID)
	group by VisitNo, VisitDate
	order by VisitDate asc
	end
return 0
end
go


/****************************************************************************************
exec uspGetPeriodicItemsByPatientNo 'P190000001', 'Jan 1, 2018', 'Oct 30, 2019'
exec uspGetPeriodicItemsByPatientNo 'P190000001', 'Jan 1, 2018', 'Oct 30, 2019', 1, 0
exec uspGetPeriodicItemsByPatientNo 'P190000001', 'Jan 1, 2018', 'Oct 30, 2019', 1, 1
select * from Payments
select top 2 * from Visits
select top 2 * from Items where VisitNo  = 'P160000010001'
*****************************************************************************************/

-------------- Get PeriodicItemsByBillNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicItemsByBillNo')
	drop proc uspGetPeriodicItemsByBillNo
go

create proc uspGetPeriodicItemsByBillNo(
@BillNo varchar(20),
@StartDate smalldatetime,
@EndDate smalldatetime,
@IncludeProcessing bit = 0,
@IncludePending bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
declare @PendingItemStatusID varchar(10)
declare @ProcessingItemStatusID varchar(10)
declare @OfferedItemStatusID varchar(10)
declare @DoneItemStatusID varchar(10)
declare @CashBillModesID varchar(10)

set @PendingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @ProcessingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'R')
set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')
set @DoneItemStatusID = dbo.GetLookupDataID('ItemStatus', 'D')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')

begin
if @IncludeProcessing = 1 and @IncludePending = 1 
begin
	 select VisitNo, dbo.FormatDate(VisitDate) as VisitDate,  dbo.FormatMoney(sum(Amount)) as Amount
	from 
	(
	select PatientNo, Visits.VisitNo as VisitNo, Visits.VisitDate as VisitDate, BillNo, ItemStatusID, InsuranceNo, (Quantity  * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount 
	from Items
	inner join Visits on Visits.VisitNo = Items.VisitNo
	where BillModesID = @CashBillModesID
	)as OPDPatientBills
	where (BillNo = @BillNo or InsuranceNo = @BillNo) and VisitDate >= @StartDate and VisitDate < @EndDate and ItemStatusID in (@PendingItemStatusID, @ProcessingItemStatusID, @OfferedItemStatusID, @DoneItemStatusID) and Amount >0
	group by VisitNo, VisitDate
	order by VisitDate asc

 end
 
 else if @IncludeProcessing = 1 and @IncludePending = 0 
begin
	 select VisitNo, dbo.FormatDate(VisitDate) as VisitDate,  dbo.FormatMoney(sum(Amount)) as Amount
	from 
	(
	select PatientNo, Visits.VisitNo as VisitNo, Visits.VisitDate as VisitDate, BillNo, ItemStatusID, InsuranceNo, (Quantity  * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount 
	from Items
	inner join Visits on Visits.VisitNo = Items.VisitNo
	)as OPDPatientBills
	where (BillNo = @BillNo or InsuranceNo = @BillNo) and VisitDate >= @StartDate and VisitDate < @EndDate and ItemStatusID in (@ProcessingItemStatusID, @OfferedItemStatusID, @DoneItemStatusID) and Amount > 0
	group by PatientNo, VisitNo, VisitDate
	order by VisitDate asc

 end
 
 
 else
 begin
	 select VisitNo, dbo.FormatDate(VisitDate) as VisitDate,  dbo.FormatMoney(sum(Amount)) as Amount
	from 
	(
	select PatientNo, Visits.VisitNo as VisitNo, Visits.VisitDate as VisitDate, BillNo, ItemStatusID, InsuranceNo, (Quantity  * UnitPrice) as Amount 
	from Items
	inner join Visits on Visits.VisitNo = Items.VisitNo
	)as OPDPatientBills
	where (BillNo = @BillNo or InsuranceNo = @BillNo) and VisitDate >= @StartDate and VisitDate < @EndDate and ItemStatusID in (@OfferedItemStatusID, @DoneItemStatusID) and Amount > 0
	group by VisitNo, VisitDate
	order by VisitDate asc
	end
return 0
end
go


/****************************************************************************************
exec uspGetPeriodicItemsByBillNo 'CASH', 'Jan 1, 2019', 'Oct 30, 2019'
exec uspGetPeriodicItemsByBillNo 'CASH', 'Jan 1, 2019', 'Oct 30, 2019', 1, 0
exec uspGetPeriodicItemsByBillNo 'CASH', 'Jan 1, 2019', 'Oct 30, 2019', 1, 1
exec uspGetPeriodicItemsByBillNo 'CASH', 'Jan 1, 2019', 'Oct 30, 2019', 0, 0

select * from Payments
select top 2 * from Visits
select top 2 * from Items where VisitNo  = 'P160000010001'
*****************************************************************************************/


-------------- Get PeriodicExtraBillItemsByBillToCustomerNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicExtraBillItemsByBillToCustomerNo')
	drop proc uspGetPeriodicExtraBillItemsByBillToCustomerNo
go

create proc uspGetPeriodicExtraBillItemsByBillToCustomerNo(
@BillNo varchar(20),
@BillModesID varchar(10),
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)
declare @CashBillModeID varchar(10)
declare @AccountBillModeID varchar(10)
declare @InsuranceBillModeID varchar(10)

set @CashBillModeID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModeID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModeID = dbo.GetLookupDataID('BillModes', 'I')

begin
if @BillModesID = @CashBillModeID
begin
	select  ExtraBillNo, dbo.FormatDate(ExtraBillDate) as ExtraBillDate, dbo.FormatMoney(sum(Amount)) as Amount 
		from 
		(select  PatientNo, ExtraBills.ExtraBillNo as ExtraBillNo, ExtraBills.ExtraBillDate as ExtraBillDate, (Quantity  *  UnitPrice) as Amount 
		from ExtraBillItems
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo 
		where BillModesID = @CashBillModeID
        union
		select  PatientNo, ExtraBills.ExtraBillNo as ExtraBillNo,  ExtraBills.ExtraBillDate as ExtraBillDate, CashAmount as Amount
		from ExtraBillItems
		inner join ExtraBillItemsCASH on ExtraBillItemsCASH.ExtraBillNo = ExtraBillItems.ExtraBillNo and ExtraBillItemsCASH.ItemCode = ExtraBillItems.ItemCode 
		and ExtraBillItemsCASH.ItemCategoryID = ExtraBillItems.ItemCategoryID
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo 

		) as IPDPatientBills where PatientNo = @BillNo and ExtraBillDate between @StartDate and @EndDate
			
			group by ExtraBillNo,ExtraBillDate
		order by ExtraBillDate asc

 end
 else if @BillModesID = @AccountBillModeID
 begin
	select  ExtraBills.ExtraBillNo, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,  dbo.FormatMoney(sum(Quantity  * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice))) as Amount
		from ExtraBillItems
		    inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo				
			
			where (BillNo = @BillNo or InsuranceNo = @BillNo) and BillModesID = @BillModesID and (ExtraBillDate >= @StartDate and ExtraBillDate < @EndDate) and UnitPrice > 0
			group by ExtraBills.ExtraBillNo, ExtraBillDate
		order by ExtraBillDate asc
	end

	else if @BillModesID = @InsuranceBillModeID
 begin
	select  ExtraBills.ExtraBillNo, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,  dbo.FormatMoney(sum(Quantity  * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice))) as Amount
		from ExtraBillItems
		    inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo				
			
			where (BillNo = @BillNo) and BillModesID = @BillModesID and (ExtraBillDate >= @StartDate and ExtraBillDate < @EndDate) and UnitPrice > 0
			group by ExtraBills.ExtraBillNo, ExtraBillDate
		order by ExtraBillDate asc
	end
return 0
end
go


/*
exec uspGetPeriodicExtraBillItemsByBillToCustomerNo 'CUST0125', '17A', 'Oct 20, 2012 00:00', 'Dec 30, 2018'
exec uspGetPeriodicExtraBillItemsByBillToCustomerNo 'P170000157', '17C', 'Oct 20, 2016 00:00', 'Dec 30, 2018'
exec uspGetPeriodicExtraBillItemsByBillToCustomerNo 'CUST0031', '17I', 'Oct 20, 2012 00:00', 'Oct 30, 2017'
select top 20 * from Admissions  where BillModesID = '17I'
select top 2 * from ExtraBillItems

*/

-------------- Get PeriodicPaymentsByBillToCustomerNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicPaymentsByBillToCustomerNo')
	drop proc uspGetPeriodicPaymentsByBillToCustomerNo
go

create proc uspGetPeriodicPaymentsByBillToCustomerNo(
@BillNo varchar(20),
@BillModesID varchar(10),
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)
declare @CashBillModeID varchar(10)
declare @AccountBillModeID varchar(10)
declare @InsuranceBillModeID varchar(10)

set @CashBillModeID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModeID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModeID = dbo.GetLookupDataID('BillModes', 'I')

begin
if @BillModesID = @CashBillModeID
begin

   select ReceiptNo,PatientNo, PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,	
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, dbo.FormatDate(PayDate) as PayDate, 
	dbo.FormatMoney(dbo.GetOutstandingBalance(dbo.GetPayeeNo(PayTypeID, PayNo))) as OutstandingBalance,
	PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	dbo.GetAmountPaidCash(ReceiptNo) as AmountPaid, AmountWords, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, WithholdingTax, GrandDiscount,
	AmountTendered, ExchangeRate, Change, UseAccountBalance, Notes,
	dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded,BillNo,
	VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as VisitType,dbo.FormatDate(Payments.RecordDateTime) as RecordDate, 
	dbo.GetTime(Payments.RecordDateTime) as RecordTime
	from Payments
	inner join Visits on Visits.VisitNo = Payments.PayNo
	where (Payments.PayDate >= @StartDate and Payments.PayDate < @EndDate)
	 and PatientNo = @BillNo  
	order by Payments.PayDate asc

 end
 else  --if @BillModesID = @AccountBillModeID
 begin
	select ReceiptNo, PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,	
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, PayDate, 
	dbo.FormatMoney(dbo.GetOutstandingBalance(dbo.GetPayeeNo(PayTypeID, PayNo))) as OutstandingBalance,
	PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	dbo.GetAmountPaidCash(ReceiptNo) as AmountPaid, AmountWords, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, WithholdingTax, GrandDiscount,
	AmountTendered, ExchangeRate, Change, UseAccountBalance, Notes,
	dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded, PayNo,
	VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as VisitType,dbo.FormatDate(Payments.RecordDateTime) as RecordDate, 
	dbo.GetTime(Payments.RecordDateTime) as RecordTime
	from Payments
	where (Payments.PayDate >= @StartDate and Payments.PayDate < @EndDate)
	 and PayNo = @BillNo  
	order by Payments.PayDate asc
	end

return 0
end
go


/*
exec uspGetPeriodicPaymentsByBillToCustomerNo 'CUST0125', '17A', 'Oct 20, 2012 00:00', 'Dec 30, 2018'
exec uspGetPeriodicPaymentsByBillToCustomerNo 'P170002440', '17C', 'Oct 20, 2016 00:00', 'Dec 30, 2018'
exec uspGetPeriodicPaymentsByBillToCustomerNo 'CUST0031', '17I', 'Oct 20, 2012 00:00', 'Oct 30, 2017'
exec uspGetPeriodicPaymentsByBillToCustomerNo 'P190000001', '17C', 'Jan 1, 2018', 'Jan 30, 2019'

select top 20 * from Admissions  where BillModesID = '17I'
select top 2 * from Payments order by recorddatetime desc
select * from Visits where VisitNo = 'P170002440002'
*/

-------------------------------------------------------------------------------------------------------------------------------------------------

--------------Patient Account -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicAccountTransactionsByAccountBillNo')
	drop proc uspGetPeriodicAccountTransactionsByAccountBillNo
go

create proc uspGetPeriodicAccountTransactionsByAccountBillNo(
@StartDate smalldatetime,
@EndDate smalldatetime,
@AccountBillNo varchar(20)
)with encryption as
declare @ErrorMSG varchar(200)
declare @CRAccountActionID varchar(10)
declare @DRAccountActionID varchar(10)
set @CRAccountActionID = dbo.GetLookupDataID('AccountAction', 'CR')
set @DRAccountActionID = dbo.GetLookupDataID('AccountAction', 'DR')
begin
select dbo.FormatText(TranNo, 'Accounts', 'TranNo') as TranNo, 
				dbo.GetLookupDataDes(AccountBillModesID) as AccountCategory, 
				dbo.FormatDate(TranDate) as TranDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
				AccountBillNo, dbo.GetAccountName(AccountBillModesID, AccountBillNo) as AccountName,
				dbo.GetLookupDataDes(AccountActionID) as AccountAction, Amount,
				(case when (AccountActionID) =@CRAccountActionID then dbo.FormatMoney(Amount) else 0 end) as Credit, 
				(case when (AccountActionID) =@DRAccountActionID then dbo.FormatMoney(Amount) else 0 end) as Debit, Balance,
				dbo.FormatMoney(dbo.GetAccountAmount(TranNo)) as AccountAmount, DocumentNo, Notes,
				CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
				AccountGroupID, dbo.GetLookupDataDes(AccountGroupID) as AccountGroup, 
				EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,dbo.GetLookupDataDes(BranchID) as BranchName, 
				AmountTendered, ExchangeRate, Change, Notes, LoginID,
				dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
				from Accounts where TranDate between @StartDate and @EndDate and AccountBillNo= @AccountBillNo
return 0
end
go

--- exec uspGetPeriodicAccountTransactionsByAccountBillNo 'Oct 20, 2016', 'Oct 30, 2017','A15225'


-------------- Get PeriodicRefundsByBillToCustomerNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicRefundsByBillToCustomerNo')
	drop proc uspGetPeriodicRefundsByBillToCustomerNo
go

create proc uspGetPeriodicRefundsByBillToCustomerNo(
@BillNo varchar(20),
@BillModesID varchar(10),
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)
declare @CashBillModeID varchar(10)
declare @AccountBillModeID varchar(10)
declare @InsuranceBillModeID varchar(10)

set @CashBillModeID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModeID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModeID = dbo.GetLookupDataID('BillModes', 'I')

begin
if @BillModesID = @CashBillModeID
begin
select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
	dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, PayNo,
	dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
	dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,
	dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
	dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes as Notes,BillNo, 
	Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
	dbo.GetTime(Refunds.RecordDateTime) as RecordTime
	from Refunds
	inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
	inner join Visits on Visits.VisitNo = Payments.PayNo
	where (Refunds.RefundDate >= @StartDate and Refunds.RefundDate < @EndDate) and PatientNo = @BillNo  
	order by Refunds.RefundDate asc

 end
 else  --if @BillModesID = @AccountBillModeID
 begin
	select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo,
	dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, PayNo,
	dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
	dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,
	dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
	dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes as Notes, 
	Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
	dbo.GetTime(Refunds.RecordDateTime) as RecordTime
	from Refunds
	inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
	where (RefundDate >= @StartDate and RefundDate < @EndDate) and PayNo = @BillNo  
	order by Refunds.RefundDate asc
	end

return 0
end
go


/*
exec uspGetPeriodicRefundsByBillToCustomerNo 'CUST0125', '17A', 'Oct 20, 2012 00:00', 'Dec 30, 2018'
exec uspGetPeriodicRefundsByBillToCustomerNo P170000030, '17C', 'Oct 20, 2016 00:00', 'Dec 30, 2018'
exec uspGetPeriodicRefundsByBillToCustomerNo CUST0031, '17I', 'Oct 20, 2012 00:00', 'Oct 30, 2017'
select top 20 * from Admissions  where BillModesID = '17I'
select top 2 * from Refunds
select * from Payments where ReceiptNo = 'R17000200'
select * from Visits where VisitNo = 'P170000030002'
*/


/**************************************************************************

****************************************************************************/

--------GetBillFormPayment----------------------------------------------------------------------------------------------------------------


if exists (select * from sysobjects where name = 'uspGetBillFormPayment')
	drop proc uspGetBillFormPayment
go

create proc uspGetBillFormPayment(
@ReceiptNo varchar(20) = null,
@StartDateTime smalldatetime = null,
@EndDateTime smalldatetime = null,
@LoginID varchar(20) = null,
@VisitsBranch varchar(10) =null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@ReceiptNo is null) and (@StartDateTime is null) and (@EndDateTime is null) and (@LoginID is null) and (@VisitsBranch is null)
	begin
		if not exists(select ReceiptNo from Payments where ReceiptNo = @ReceiptNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payments')
				return 1
			end
		else
			begin
				select ReceiptNo, PayNo, VisitNo, PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
				PatientNo, ClientFullName as FullName,ClientFullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
				CoPayValue, dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount, 
				dbo.FormatDate(VisitDate) as VisitDate, DocumentNo, Notes, SendBalanceToAccount, 
				dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(AmountPaid-AmountRefunded) as NetAmount, UseAccountBalance, 
				CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,BranchName, 
				AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
				dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,
				VisitsBranchID
				from BillFormPayment
				where ReceiptNo = @ReceiptNo
			end
	end	
else if (@ReceiptNo is null) and (@LoginID is null) and (@VisitsBranch is null) and not(@StartDateTime is null) and not(@EndDateTime is null) 
	begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,
		PayNo, dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatText(PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		ClientFullName as FullName,ClientFullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
		CoPayValue, dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount, 
		dbo.FormatDate(VisitDate) as VisitDate, DocumentNo, Notes, SendBalanceToAccount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(AmountPaid-AmountRefunded) as NetAmount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,BranchName, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,VisitsBranchID
		from BillFormPayment
		where RecordDateTime between @StartDateTime and @EndDateTime
		order by PayDate, RecordDateTime
	end

else if (@ReceiptNo is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null) and not(@VisitsBranch is null)
	begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, 
		PayNo, dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatText(PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		ClientFullName as FullName,ClientFullName,
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
		CoPayValue, dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords,WithholdingTax, GrandDiscount, 
		dbo.FormatDate(VisitDate) as VisitDate, DocumentNo, Notes, SendBalanceToAccount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(AmountPaid-AmountRefunded) as NetAmount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,BranchName, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,VisitsBranchID
		from BillFormPayment
		where (RecordDateTime >= @StartDateTime and RecordDateTime < @EndDateTime) and LoginID = @LoginID
		and VisitsBranchID =@VisitsBranch
		order by PayDate, RecordDateTime
	end

else if (@ReceiptNo is null) and (@LoginID is null) and not(@StartDateTime is null) and not(@EndDateTime is null)  and not(@VisitsBranch is null)
	begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, 
		PayNo, dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatText(PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		ClientFullName as FullName,ClientFullName,
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
		CoPayValue, dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords,WithholdingTax, GrandDiscount, 
		dbo.FormatDate(VisitDate) as VisitDate, DocumentNo, Notes, SendBalanceToAccount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(AmountPaid-AmountRefunded) as NetAmount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,BranchName, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,VisitsBranchID
		from BillFormPayment
		where (RecordDateTime >= @StartDateTime and RecordDateTime < @EndDateTime)
		and VisitsBranchID =@VisitsBranch
		order by PayDate, RecordDateTime
	end

else if (@ReceiptNo is null) and (@VisitsBranch is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null) 
	begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, 
		PayNo, dbo.FormatText(VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatText(PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		ClientFullName as FullName,ClientFullName,
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
		CoPayValue, dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount, 
		dbo.FormatDate(VisitDate) as VisitDate, DocumentNo, Notes, SendBalanceToAccount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(AmountPaid-AmountRefunded) as NetAmount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,BranchName, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,VisitsBranchID
		from BillFormPayment
		where (RecordDateTime >= @StartDateTime and RecordDateTime < @EndDateTime)
		and LoginID = @LoginID
		order by PayDate, RecordDateTime
	end


else 
	begin
		select ReceiptNo, PayNo, VisitNo, PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		PatientNo, ClientFullName as FullName,ClientFullName,
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, 
		CoPayValue, dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount, 
		dbo.FormatDate(VisitDate) as VisitDate, DocumentNo, Notes, SendBalanceToAccount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(AmountPaid-AmountRefunded) as NetAmount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,BranchName, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
		from BillFormPayment
	end	
return 0
go

/******************************************************************************************************
exec uspGetBillFormPayment '13033103'
exec uspGetBillFormPayment null, '27 May 2014', '15 Dec 2014'
exec uspGetBillFormPayment null, '15 Jan 2014', '16 Dec 2014', 'Admin'
exec uspGetBillFormPayment 

******************************************************************************************************/
-- select * from BillFormPayment

--------GetBillsPayment----------------------------------------------------------------------------------------------------------------


if exists (select * from sysobjects where name = 'uspGetBillsPayment')
	drop proc uspGetBillsPayment
go

create proc uspGetBillsPayment(
@ReceiptNo varchar(20) = null,
@StartDateTime smalldatetime = null,
@EndDateTime smalldatetime = null,
@LoginID varchar(20) = null,
@VisitsBranch varchar(10) =null
)with encryption as

declare @ErrorMSG varchar(200)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)

set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')

if not (@ReceiptNo is null) and (@StartDateTime is null) and (@EndDateTime is null) and (@LoginID is null) and (@VisitsBranch is null)
	begin
		if not exists(select ReceiptNo from Payments where ReceiptNo = @ReceiptNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payments')
				return 1
			end
		else
			begin
				select ReceiptNo, PayNo, PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
				dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, DocumentNo, 
				dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(NetAmount) as NetAmount,
				Notes, SendBalanceToAccount, UseAccountBalance, WithholdingTax, GrandDiscount, 
				CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
				PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, ClientFullName as BillCustomerName,
				AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
				dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,
				VisitsBranch,VisitsBranchID
				from BillsPayment
				where ReceiptNo = @ReceiptNo
			end
	end	
else if (@ReceiptNo is null) and (@LoginID is null) and (@VisitsBranch is null) and not(@StartDateTime is null) and not(@EndDateTime is null)
	begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,
		PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType,
		case PayTypeID
			when @AccountBillPayTypeID then dbo.FormatText(PayNo, 'BillCustomers', 'AccountNo')
			when @InsuranceBillPayTypeID then dbo.FormatText(PayNo, 'Insurances', 'InsuranceNo')
		else PayNo end as PayNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount,
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(NetAmount) as NetAmount,
		ClientFullName as BillCustomerName, DocumentNo, Notes, SendBalanceToAccount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,
		VisitsBranch,VisitsBranchID
		from BillsPayment
		where (RecordDateTime >= @StartDateTime and RecordDateTime < @EndDateTime) 
		order by PayDate, RecordDateTime
	end
else if (@ReceiptNo is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null) and not(@VisitsBranch is null)
	begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, 
		case PayTypeID
			when @AccountBillPayTypeID then dbo.FormatText(PayNo, 'BillCustomers', 'AccountNo')
			when @InsuranceBillPayTypeID then dbo.FormatText(PayNo, 'Insurances', 'InsuranceNo')
		else PayNo end as PayNo,
		PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount,
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(NetAmount) as NetAmount,
 
		ClientFullName as BillCustomerName, DocumentNo, Notes, SendBalanceToAccount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,VisitsBranch,VisitsBranchID
		from BillsPayment
		where (RecordDateTime >= @StartDateTime and RecordDateTime < @EndDateTime) and LoginID = @LoginID and VisitsBranchID =@VisitsBranch
		order by PayDate, RecordDateTime
	end

else if (@ReceiptNo is null) and (@LoginID is null) and not(@StartDateTime is null) and not(@EndDateTime is null)  and not(@VisitsBranch is null)

	begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, 
		case PayTypeID
			when @AccountBillPayTypeID then dbo.FormatText(PayNo, 'BillCustomers', 'AccountNo')
			when @InsuranceBillPayTypeID then dbo.FormatText(PayNo, 'Insurances', 'InsuranceNo')
		else PayNo end as PayNo,
		PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount, 
		ClientFullName as BillCustomerName, DocumentNo, Notes, SendBalanceToAccount, UseAccountBalance, 
						dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(NetAmount) as NetAmount,

		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,VisitsBranch,VisitsBranchID
		from BillsPayment
		where (RecordDateTime >= @StartDateTime and RecordDateTime < @EndDateTime) and VisitsBranchID =@VisitsBranch
		order by PayDate, RecordDateTime
	end

else if (@ReceiptNo is null) and (@VisitsBranch is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null)
	begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, 
		case PayTypeID
			when @AccountBillPayTypeID then dbo.FormatText(PayNo, 'BillCustomers', 'AccountNo')
			when @InsuranceBillPayTypeID then dbo.FormatText(PayNo, 'Insurances', 'InsuranceNo')
		else PayNo end as PayNo,
		PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount, 
						dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(NetAmount) as NetAmount,

		ClientFullName as BillCustomerName, DocumentNo, Notes, SendBalanceToAccount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,VisitsBranch,VisitsBranchID
		from BillsPayment
		where (RecordDateTime >= @StartDateTime and RecordDateTime < @EndDateTime) and LoginID = @LoginID
		order by PayDate, RecordDateTime
	end


else 
	begin
		select ReceiptNo, PayNo, PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
		dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount, 
						dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(NetAmount) as NetAmount,

		ClientFullName as BillCustomerName, DocumentNo, Notes, SendBalanceToAccount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
		from BillsPayment
	end	
return 0
go

/******************************************************************************************************
exec uspGetBillsPayment '14039508'
exec uspGetBillsPayment null, '1 Jan 2014', '26 Oct 2014'
exec uspGetBillsPayment null, '1 Jan 2014', '26 Oct 2014', 'Admin'
exec uspGetBillsPayment 

******************************************************************************************************/
-- select * from BillsPayment

--------GetCreditBillFormPayment----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCreditBillFormPayment')
	drop proc uspGetCreditBillFormPayment
go

create proc uspGetCreditBillFormPayment(
@ReceiptNo varchar(20) = null,
@StartDateTime smalldatetime = null,
@EndDateTime smalldatetime = null,
@LoginID varchar(20) = null,
@VisitsBranch varchar(10) =null
)with encryption as

declare @ErrorMSG varchar(200)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)

set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')


if not (@ReceiptNo is null) and (@StartDateTime is null) and (@EndDateTime is null) and (@LoginID is null) and (@VisitsBranch is null)
	begin
		if not exists(select ReceiptNo from Payments where ReceiptNo = @ReceiptNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payments')
				return 1
			end
		else
			begin
				select ReceiptNo, PayNo, PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
				dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount, DocumentNo,
				dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(NetAmount) as NetAmount, 
				Notes, SendBalanceToAccount, UseAccountBalance, 
				CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
				PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType,ClientFullName as BillCustomerName,
				AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
				dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,
				VisitsBranch,VisitsBranchID
				from CreditBillFormPayment
				where ReceiptNo = @ReceiptNo
			end 
			end
	
else if (@ReceiptNo is null) and (@LoginID is null) and (@VisitsBranch is null) and not(@StartDateTime is null) and not(@EndDateTime is null)
		
	begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,
		PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType,
		case PayTypeID
			when @AccountBillPayTypeID then dbo.FormatText(PayNo, 'BillCustomers', 'AccountNo')
			when @InsuranceBillPayTypeID then dbo.FormatText(PayNo, 'Insurances', 'InsuranceNo')
		else PayNo end as PayNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(NetAmount) as NetAmount,
		ClientFullName as BillCustomerName, DocumentNo, Notes, SendBalanceToAccount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,
		VisitsBranch,VisitsBranchID
		from CreditBillFormPayment
		where (RecordDateTime >= @StartDateTime and RecordDateTime < @EndDateTime)
		order by PayDate, RecordDateTime
	end

else if (@ReceiptNo is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null) and not(@VisitsBranch is null)

begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, 
		case PayTypeID
			when @AccountBillPayTypeID then dbo.FormatText(PayNo, 'BillCustomers', 'AccountNo')
			when @InsuranceBillPayTypeID then dbo.FormatText(PayNo, 'Insurances', 'InsuranceNo')
		else PayNo end as PayNo,
		PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount,
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(NetAmount) as NetAmount,
		ClientFullName as BillCustomerName, DocumentNo, Notes, SendBalanceToAccount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,
		VisitsBranch,VisitsBranchID
		from CreditBillFormPayment
		where (RecordDateTime >= @StartDateTime and RecordDateTime < @EndDateTime) and LoginID = @LoginID and VisitsBranchID =@VisitsBranch
		order by PayDate, RecordDateTime
	end

else if (@ReceiptNo is null) and (@LoginID is null) and not(@StartDateTime is null) and not(@EndDateTime is null)  and not(@VisitsBranch is null)
begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, 
		case PayTypeID
			when @AccountBillPayTypeID then dbo.FormatText(PayNo, 'BillCustomers', 'AccountNo')
			when @InsuranceBillPayTypeID then dbo.FormatText(PayNo, 'Insurances', 'InsuranceNo')
		else PayNo end as PayNo,
		PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(NetAmount) as NetAmount,
		ClientFullName as BillCustomerName, DocumentNo, Notes, SendBalanceToAccount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,
		VisitsBranch,VisitsBranchID
		from CreditBillFormPayment
		where (RecordDateTime >= @StartDateTime and RecordDateTime < @EndDateTime) and VisitsBranchID =@VisitsBranch
		order by PayDate, RecordDateTime
	end


else if (@ReceiptNo is null) and (@VisitsBranch is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null)
begin
		select dbo.FormatText(ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo, 
		case PayTypeID
			when @AccountBillPayTypeID then dbo.FormatText(PayNo, 'BillCustomers', 'AccountNo')
			when @InsuranceBillPayTypeID then dbo.FormatText(PayNo, 'Insurances', 'InsuranceNo')
		else PayNo end as PayNo,
		PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType,
		dbo.FormatDate(PayDate) as PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(NetAmount) as NetAmount,
		ClientFullName as BillCustomerName, DocumentNo, Notes, SendBalanceToAccount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,
		VisitsBranch,VisitsBranchID
		from CreditBillFormPayment
		where (RecordDateTime >= @StartDateTime and RecordDateTime < @EndDateTime) and LoginID =@LoginID
		order by PayDate, RecordDateTime
	end

else 
	begin
		select ReceiptNo, PayNo, PayDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
		dbo.FormatMoney(AmountPaid) as AmountPaid, AmountWords, WithholdingTax, GrandDiscount, 
		dbo.FormatMoney(AmountRefunded) as AmountRefunded,dbo.FormatMoney(NetAmount) as NetAmount,
		ClientFullName as BillCustomerName, DocumentNo, Notes, SendBalanceToAccount, UseAccountBalance, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, dbo.FormatMoney(Change) as Change, FilterNo, LoginID, 
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime,VisitsBranch,VisitsBranchID
		from CreditBillFormPayment
	end	
return 0
go

/******************************************************************************************************
exec uspGetCreditBillFormPayment '13028913'
exec uspGetCreditBillFormPayment null, '1 Jan 2018', '26 Aug 2018'
exec uspGetCreditBillFormPayment null, '1 Jan 2012', '26 Aug 2014', 'Admin'
exec uspGetCreditBillFormPayment 

******************************************************************************************************/
-- select * from CreditBillFormPayment

--------GetCahierLogins----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCahierLogins')
	drop proc uspGetCahierLogins
go

create proc uspGetCahierLogins(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime
)with encryption as

begin
	select distinct LoginID from 
	(select RecordDateTime, LoginID from CashPayments
	union select RecordDateTime, LoginID from BillFormPayment
	union select RecordDateTime, LoginID from BillsPayment
	union select RecordDateTime, LoginID from CreditBillFormPayment
	union select RecordDateTime, LoginID from Accounts		
	union select RecordDateTime, LoginID from OtherIncome
	union select RecordDateTime, LoginID from Refunds
	union select RecordDateTime, LoginID from Expenditure		
	) as CahierLogins
	where RecordDateTime between @StartDateTime and @EndDateTime
end

return 0
go

/******************************************************************************************************
exec uspGetCahierLogins '1 Aug 2013', '2 Sep 2013'
******************************************************************************************************/

--------GetCurrencySummaries----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCurrencySummaries')
	drop proc uspGetCurrencySummaries
go

create proc uspGetCurrencySummaries(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime,
@LoginID varchar(20) = null
)with encryption as

declare @LocalCurrenciesID varchar(10)

-------------------------------------------------------------------
set @LocalCurrenciesID = dbo.GetLookupDataID('Currencies', 'UGX')
-------------------------------------------------------------------

if (@LoginID is null)
	begin
		select dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		dbo.FormatMoney(Sum(AmountTendered)) as ForeignCurrencyAmount, 
		dbo.FormatMoney(Sum(AmountTendered * ExchangeRate)) as LocalCurrencyAmount
		from (
		select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		AmountTendered, ExchangeRate, RecordDateTime, LoginID
		from CashPayments
	union 
		select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		AmountTendered, ExchangeRate, RecordDateTime, LoginID
		from BillFormPayment
	union 
		select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		AmountTendered, ExchangeRate, RecordDateTime, LoginID
		from BillsPayment
	union 
		select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		AmountTendered, ExchangeRate, RecordDateTime, LoginID
		from CreditBillFormPayment
	union 
		select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		dbo.GetAccountAmountTendered(TranNo) as AmountTendered, ExchangeRate, RecordDateTime, LoginID
		from Accounts
	union 
		select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		AmountTendered, ExchangeRate, RecordDateTime, LoginID
		from OtherIncome
		) as CurrencySummaries
		where not CurrenciesID = @LocalCurrenciesID 
		and RecordDateTime between @StartDateTime and @EndDateTime
		group by CurrenciesID		
	end
else
	begin
		select dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		dbo.FormatMoney(Sum(AmountTendered)) as ForeignCurrencyAmount, 
		dbo.FormatMoney(Sum(AmountTendered * ExchangeRate)) as LocalCurrencyAmount
		from (
		select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		AmountTendered, ExchangeRate, RecordDateTime, LoginID
		from CashPayments
	union 
		select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		AmountTendered, ExchangeRate, RecordDateTime, LoginID
		from BillFormPayment
	union 
		select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		AmountTendered, ExchangeRate, RecordDateTime, LoginID
		from BillsPayment
	union 
		select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		AmountTendered, ExchangeRate, RecordDateTime, LoginID
		from CreditBillFormPayment
	union 
		select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		dbo.GetAccountAmountTendered(TranNo) as AmountTendered, ExchangeRate, RecordDateTime, LoginID
		from Accounts
	union 
		select CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,  
		AmountTendered, ExchangeRate, RecordDateTime, LoginID
		from OtherIncome
		) as CurrencySummaries
		where not CurrenciesID = @LocalCurrenciesID and 
		RecordDateTime between @StartDateTime and @EndDateTime and LoginID = @LoginID
		group by CurrenciesID
	end
return 0
go

/******************************************************************************************************
exec uspGetCurrencySummaries '1 Sep 2013', '2 Sep 2013'
exec uspGetCurrencySummaries '1 Sep 2013', '2 Sep 2013', 'Admin'

******************************************************************************************************/

--------GetNextReceiptID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextReceiptID')
	drop proc uspGetNextReceiptID
go

create proc uspGetNextReceiptID(
@ReceiptID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @OptionValue varchar(10)
declare @CurrentYear as char(2)
declare @ReceiptNoPrefix varchar(12)

set @OptionValue = dbo.GetOptionValue('ReceiptNoPrefix')
set @CurrentYear = right(year(getdate()), 2)
set @ReceiptNoPrefix = @OptionValue + @CurrentYear

set @ReceiptID = (select max(ReceiptID) from Payments where left(ReceiptNo, len(@ReceiptNoPrefix)) = @ReceiptNoPrefix)
set @ReceiptID = dbo.GetNextAutoNumber('Payments', 'ReceiptNo', @ReceiptID)

return 0

go

-- exec uspGetNextReceiptID
-- select * from Payments

-------------- Refunds -------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
-------------- Insert Refunds ------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertRefunds')
	drop proc uspInsertRefunds
go

create proc uspInsertRefunds(
@RefundNo varchar(20),
@ReceiptNo varchar(20),
@RefundRequestNo varchar(20),
@VisitTypeID varchar(10),
@RefundDate smalldatetime,
@Amount money,
@AmountWords varchar(200),
@Notes varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

declare @CashVisitPayTypeID varchar(10)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)
declare @IPDRoundPayTypeID varchar(10)
declare @ExtraBillPayTypeID varchar(10)
declare @BranchID varchar(10)

declare @RefundID int
declare @PaddingLEN tinyint

declare @PassedRefundID int
declare @PassedRefundNo varchar(20)
declare @PassedReceiptNo varchar(20)

declare @PayTypeID varchar(10)
declare @AmountPaid money
declare @AmountRefunded money

declare @CancelledRequestStatusID varchar(10)

----------------------------------------------------------------------------------------------
set @BranchID = dbo.GetMyCurrentBranch(@LoginID)
set @CashVisitPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')
set @IPDRoundPayTypeID = dbo.GetLookupDataID('PayType', 'IPR')
set @ExtraBillPayTypeID = dbo.GetLookupDataID('PayType', 'EXT')
set @CancelledRequestStatusID = dbo.GetLookupDataID('ItemStatus', 'P') 
----------------------------------------------------------------------------------------------

if exists(select RefundNo from Refunds where RefundNo = @RefundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Refund No', @RefundNo)
		return 1
	end

if not exists(select ReceiptNo from Payments where ReceiptNo  = @ReceiptNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payments')
		return 1
	end
if (dbo.GetOptionValue('AllowAccountReceiptsRefunds') =0)
begin
if not exists(select ReceiptNo from Payments where ReceiptNo  = @ReceiptNo and 
			PayTypeID in (@CashVisitPayTypeID, @IPDRoundPayTypeID, @ExtraBillPayTypeID))
	begin
		set @ErrorMSG = 'You can only refund cash or bill form payment!'
		raiserror(@ErrorMSG, 16, 1)
		return 1
	end
end
	if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo  = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'Refund Requests')
		return 1
	end

	if  exists(select RefundRequestNo from Refunds where RefundRequestNo  = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does is already processed %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'Refund Requests')
		return 1
	end

	if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo  = @RefundRequestNo and  RequestStatusID = @CancelledRequestStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter is Cancelled and cannot be processed'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo)
		return 1
	end


if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

----------------------------------------------------------------------------------------------------------
set @PayTypeID = (select PayTypeID from Payments where ReceiptNo = @ReceiptNo)
set @AmountPaid =  dbo.GetAmountPaid(@PayTypeID, @VisitTypeID, @ReceiptNo)
set @AmountRefunded = dbo.GetAmountRefunded(@ReceiptNo) 

if (@Amount <= 0)
	begin
		set @ErrorMSG = 'Zero or less amount not allowed for refund!'
		raiserror(@ErrorMSG, 16, 1)
		return 1
	end

if (@AmountPaid < (@Amount + @AmountRefunded))
	begin
		set @ErrorMSG = 'Total refunded amount can''t be more than receipt amount!'
		raiserror(@ErrorMSG, 16, 1)
		return 1
	end

----------------------------------------------------------------------------------------------------------

begin

----------------------------------------------------------------------------------------------------------

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'Refunds' and AutoColumnName = 'RefundNo'

set @PassedReceiptNo = ltrim(rtrim(substring(@RefundNo, 1, len(@RefundNo) - @PaddingLEN)))

if (@PassedReceiptNo = @ReceiptNo)

begin

	set @PassedRefundID = 1
	set @PassedRefundNo = @RefundNo

	set @PassedRefundNo = ltrim(rtrim(substring(@PassedRefundNo, len(@PassedReceiptNo) + 1, @PaddingLEN)))

	if isnumeric(@PassedRefundNo) = 1 set @PassedRefundID = @PassedRefundNo
	else set @PassedRefundID = 1

	set @RefundID = (select max(RefundID) from Refunds where ReceiptNo = @ReceiptNo)
	set @RefundID = dbo.GetNextAutoNumber('Refunds', 'RefundNo', @RefundID)

	if @PassedRefundID < @RefundID set @RefundID = @PassedRefundID
	if @PassedRefundID > @RefundID set @RefundID = @PassedRefundID

end else set @RefundID = 1

----------------------------------------------------------------------------------------------------------
declare @StatusID varchar(10)
set @StatusID= dbo.GetLookupDataID('ItemStatus', 'D')
begin tran
insert into Refunds
(RefundID, RefundNo, ReceiptNo,RefundRequestNo, VisitTypeID, RefundDate, Amount, AmountWords, Notes, LoginID,BranchID,ClientMachine)
values
(@RefundID, @RefundNo, @ReceiptNo, @RefundRequestNo, @VisitTypeID, @RefundDate, @Amount, @AmountWords, @Notes, @LoginID,@BranchID, @ClientMachine)

update RefundRequests set RequestStatusID=@StatusID where RefundRequestNo=@RefundRequestNo


	if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
return 0
end
go

/******************************************************************************************************
exec uspInsertRefunds '1301035401', '13010354','18000051', '110OPD', '09 Mar 2013', '4000', 'Four Thousand', 'Notes', 'Admin'
exec uspInsertRefunds '1301035402', '13010354', '18000051', '110OPD', '09 Mar 2013', '3000', 'Three Thousand', '', 'Admin'
exec uspInsertRefunds '1301035301', '13010353', '18000051', '110OPD', '09 Mar 2013', '50000', 'Fifty Thousand', '', 'Admin'

exec uspInsertRefunds '1301033401', '13010334', '09 Mar 2013', '1500', 'one Thousand', '', 'Admin'

******************************************************************************************************/
-- select * from Refunds  
-- delete from Refunds

--------GetRefunds----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRefunds')
	drop proc uspGetRefunds
go

create proc uspGetRefunds(
@RefundNo varchar(20) = null,
@StartDateTime smalldatetime = null,
@EndDateTime smalldatetime = null,
@LoginID varchar(20) = null,
@BranchID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@RefundNo is null) and (@StartDateTime is null) and (@EndDateTime is null) and (@LoginID is null) and (@BranchID is null)
	begin
		if not exists(select RefundNo from Refunds where RefundNo = @RefundNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Refund No', @RefundNo, 'Refunds')
				return 1
			end
		else
			begin
				select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
				dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
				Refunds.VisitTypeID, dbo.GetLookupDataDes(Refunds.VisitTypeID) as VisitType,
				dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
				dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,
				dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
				dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
				Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
				dbo.GetTime(Refunds.RecordDateTime) as RecordTime
				from Refunds
				inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
				where RefundNo = @RefundNo
			end
	end	
else if (@RefundNo is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and (@LoginID is null) and (@BranchID is null)
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
				dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
				Refunds.VisitTypeID, dbo.GetLookupDataDes(Refunds.VisitTypeID) as VisitType,
				dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
				dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,
				dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
				dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
				Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
				dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
		where Refunds.RecordDateTime between @StartDateTime and @EndDateTime
		order by RefundDate, Refunds.RecordDateTime
	end
else if (@RefundNo is null) and (@BranchID is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null)
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
				dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
				Refunds.VisitTypeID, dbo.GetLookupDataDes(Refunds.VisitTypeID) as VisitType,
				dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
				dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,
				dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
				dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
				Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
				dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
		where Refunds.RecordDateTime between @StartDateTime and @EndDateTime and Refunds.LoginID = @LoginID
		order by RefundDate, Refunds.RecordDateTime
	end

	else if (@RefundNo is null) and (@LoginID is null) and not (@BranchID is null) and not(@StartDateTime is null) and not(@EndDateTime is null)
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
				dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
				Refunds.VisitTypeID, dbo.GetLookupDataDes(Refunds.VisitTypeID) as VisitType,
				dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
				dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,
				dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
				dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
				Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
				dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
		where Refunds.RecordDateTime between @StartDateTime and @EndDateTime and Refunds.BranchID = @BranchID
		order by RefundDate, Refunds.RecordDateTime
	end

	else if (@RefundNo is null) and not (@BranchID is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null)
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
				dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
				Refunds.VisitTypeID, dbo.GetLookupDataDes(Refunds.VisitTypeID) as VisitType,
				dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
				dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,
				dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
				dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
				Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
				dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
		where Refunds.RecordDateTime between @StartDateTime and @EndDateTime and Refunds.LoginID = @LoginID and Refunds.BranchID = @BranchID
		order by RefundDate, Refunds.RecordDateTime
	end

else 
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
				dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
				Refunds.VisitTypeID, dbo.GetLookupDataDes(Refunds.VisitTypeID) as VisitType,
				dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
				dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,
				dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
				dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
				Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
				dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
	end	
return 0
go

/******************************************************************************************************
exec uspGetRefunds '1301035001'
exec uspGetRefunds null, '10 Mar 2013', '11 Mar 2013'
exec uspGetRefunds null, '05 Mar 2013', '11 Mar 2013', 'Admin'
exec uspGetRefunds 

******************************************************************************************************/
-- select * from Refunds



if exists (select * from sysobjects where name = 'uspGetRefundByRequestNo')
	drop proc uspGetRefundByRequestNo
go

create proc uspGetRefundByRequestNo(
@RefundRequestNo varchar(20) = null,
@StartDateTime smalldatetime = null,
@EndDateTime smalldatetime = null,
@LoginID varchar(20) = null,
@BranchID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@RefundRequestNo is null) and (@StartDateTime is null) and (@EndDateTime is null) and (@LoginID is null) and (@BranchID is null)
	begin


		if not (dbo.GetOptionValue('ForceRefundsApproval') > 0) and not exists(select RefundRequestNo from Refunds where RefundRequestNo = @RefundRequestNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'Refunds')
				return 1
			end


		else
			begin
				select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
				dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
				dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
				dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,
				dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid,
				dbo.FormatMoney(dbo.GetOutstandingBalance(dbo.GetPayeeNo(PayTypeID, PayNo))) as OutstandingBalance, 
				dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
				Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
				dbo.GetTime(Refunds.RecordDateTime) as RecordTime
				from Refunds
				inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
				where RefundRequestNo = @RefundRequestNo
			end
	end	
else if (@RefundRequestNo is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and (@LoginID is null) and (@BranchID is null)
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
		dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
		dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,	
		dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
		dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
		Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
		dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
		where Refunds.RecordDateTime between @StartDateTime and @EndDateTime
		order by RefundDate, Refunds.RecordDateTime
	end
else if (@RefundRequestNo is null) and (@BranchID is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null)
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
		dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
		dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,	
		dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
		dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
		Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
		dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
		where Refunds.RecordDateTime between @StartDateTime and @EndDateTime and Refunds.LoginID = @LoginID
		order by RefundDate, Refunds.RecordDateTime
	end

	else if (@RefundRequestNo is null) and (@LoginID is null) and not (@BranchID is null) and not(@StartDateTime is null) and not(@EndDateTime is null)
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
		dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
		dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,	
		dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
		dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
		Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
		dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
		where Refunds.RecordDateTime between @StartDateTime and @EndDateTime and Refunds.BranchID = @BranchID
		order by RefundDate, Refunds.RecordDateTime
	end

	else if (@RefundRequestNo is null) and not (@BranchID is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null)
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
		dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
		dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,	
		dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
		dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
		Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
		dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
		where Refunds.RecordDateTime between @StartDateTime and @EndDateTime and Refunds.LoginID = @LoginID and Refunds.BranchID = @BranchID
		order by RefundDate, Refunds.RecordDateTime
	end

else 
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
		dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
		dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,	
		dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
		dbo.FormatMoney(Amount) as Amount, Refunds.Notes, Refunds.AmountWords, 
		Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
		dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
	end	
return 0
go

/******************************************************************************************************
exec uspGetRefundByRequestNo '17000002'
exec uspGetRefundByRequestNo null, '10 Mar 2013', '11 Mar 2013'
exec uspGetRefundByRequestNo null, '05 Mar 2013', '11 Mar 2013', 'Admin'
exec uspGetRefundByRequestNo 

******************************************************************************************************/

-- select * from Refunds

--------GetNextRefundID --------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextRefundID')
	drop proc uspGetNextRefundID
go

create proc uspGetNextRefundID(
@ReceiptNo varchar(20),
@RefundID int = null output
)with encryption as

set @RefundID = (select max(RefundID) from Refunds where ReceiptNo = @ReceiptNo)
set @RefundID = dbo.GetNextAutoNumber('Refunds', 'RefundNo', @RefundID)

return 0

go

-- exec uspGetNextRefundID '08022077'
-- select * from Refunds where ReceiptNo = '08022077'

--------GetRefundsWithTransDate----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRefundsWithTransDate')
	drop proc uspGetRefundsWithTransDate
go

create proc uspGetRefundsWithTransDate(
@RefundNo varchar(20) = null,
@StartDateTime date = null,
@EndDateTime smalldatetime = null,
@LoginID varchar(20) = null,
@BranchID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@RefundNo is null) and (@StartDateTime is null) and (@EndDateTime is null) and (@LoginID is null) and (@BranchID is null)
	begin
		if not exists(select RefundNo from Refunds where RefundNo = @RefundNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Refund No', @RefundNo, 'Refunds')
				return 1
			end
		else
			begin
				select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
				dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
				dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
				dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,
				dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
				dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
				Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
				dbo.GetTime(Refunds.RecordDateTime) as RecordTime
				from Refunds
				inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
				where RefundNo = @RefundNo
			end
	end	
else if (@RefundNo is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and (@LoginID is null) and (@BranchID is null)
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
		dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
		dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,	
		dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
		dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
		Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
		dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
		where Payments.RecordDateTime between @StartDateTime and @EndDateTime
		order by RefundDate
	end
else if (@RefundNo is null) and (@BranchID is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null)
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
		dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
		dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,	
		dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
		dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
		Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
		dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
		where Payments.RecordDateTime between @StartDateTime and @EndDateTime and Refunds.LoginID = @LoginID
		order by RefundDate
	end

	else if (@RefundNo is null) and (@LoginID is null) and not (@BranchID is null) and not(@StartDateTime is null) and not(@EndDateTime is null)
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
		dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
		dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,	
		dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
		dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
		Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
		dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
		where Payments.RecordDateTime between @StartDateTime and @EndDateTime and Refunds.BranchID = @BranchID
		order by RefundDate
	end

	else if (@RefundNo is null) and not (@BranchID is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null)
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
		dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
		dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,	
		dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
		dbo.FormatMoney(Amount) as Amount, Refunds.AmountWords, Refunds.Notes, 
		Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
		dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
		where Payments.RecordDateTime between @StartDateTime and @EndDateTime and Refunds.LoginID = @LoginID and Refunds.BranchID = @BranchID
		order by RefundDate
	end

else 
	begin
		select dbo.FormatText(RefundNo, 'Refunds', 'RefundNo') as RefundNo, 
		dbo.FormatText(Refunds.ReceiptNo, 'Payments', 'ReceiptNo') as ReceiptNo,RefundRequestNo,
		dbo.FormatDate(PayDate) as PayDate, dbo.FormatDate(RefundDate) as RefundDate, 
		dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,dbo.GetLookupDataDes(Refunds.BranchID) as BranchName,	
		dbo.GetAmountPaid(PayTypeID, Refunds.VisitTypeID, Refunds.ReceiptNo) as AmountPaid, 
		dbo.FormatMoney(Amount) as Amount, Refunds.Notes, Refunds.AmountWords, 
		Refunds.LoginID, dbo.FormatDate(Refunds.RecordDateTime) as RecordDate, 
		dbo.GetTime(Refunds.RecordDateTime) as RecordTime
		from Refunds
		inner join Payments on Refunds.ReceiptNo = Payments.ReceiptNo
	end	
return 0
go


--exec uspGetRefundsWithTransDate '1301035001'
--exec uspGetRefundsWithTransDate null, '10 Mar 2013', '11 Mar 2013'
--exec uspGetRefundsWithTransDate null, '05 Mar 2013', '11 Mar 2013', 'Admin'
--exec uspGetRefundsWithTransDate 

------------------------------------------------------------------------------------------------------
-------------- RefundDetails --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert RefundDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertRefundDetails')
	drop proc uspInsertRefundDetails
go

create proc uspInsertRefundDetails(
@RefundNo varchar(20),
@VisitNo varchar(20),
@ReceiptNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReturnReasonID varchar(10),
@Quantity int,
@Amount money,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundNo from Refunds where RefundNo  = @RefundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund No', @RefundNo, 'Refunds')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if exists(select RefundNo from RefundDetails where RefundNo = @RefundNo and VisitNo = @VisitNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Refund No', @RefundNo, 'VisitNo', @VisitNo, 'Receipt No', @ReceiptNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into RefundDetails
(RefundNo, VisitNo, ReceiptNo, ItemCode, ItemCategoryID, ReturnReasonID, Quantity, Amount, LoginID, ClientMachine)
values
(@RefundNo, @VisitNo, @ReceiptNo, @ItemCode, @ItemCategoryID, @ReturnReasonID, @Quantity, @Amount, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertRefundDetails
******************************************************************************************************/
-- select * from RefundDetails
-- delete from RefundDetails


-------------- Get RefundDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRefundDetails')
	drop proc uspGetRefundDetails
go

create proc uspGetRefundDetails(
@RefundNo varchar(20),
@VisitNo varchar(20),
@ReceiptNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundNo from RefundDetails where RefundNo = @RefundNo and VisitNo = @VisitNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund No', @RefundNo, 'VisitNo', @VisitNo, 'Receipt No', @ReceiptNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'RefundDetails')
		return 1
	end
else
begin
	select RefundNo, VisitNo, ReceiptNo, ItemCode, ItemCategoryID, ReturnReasonID, Quantity, Amount, RefundDetails.LoginID, ClientMachine, RecordDateTime
	from RefundDetails
	inner join Logins on RefundDetails.LoginID = Logins.LoginID
	where RefundNo = @RefundNo and VisitNo = @VisitNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetRefundDetails
******************************************************************************************************/
-- select * from RefundDetails
-- delete from RefundDetails



-----------------------------------------------------------------------------------------------------------------------


/******************************************************************************************************
exec uspGetRefundDetails
******************************************************************************************************/
-- select * from RefundDetails
-- delete from RefundDetails




------------------------------------------------------------------------------------------------------
-------------- RefundExtraBillItems --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert RefundExtraBillItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertRefundExtraBillItems')
	drop proc uspInsertRefundExtraBillItems
go

create proc uspInsertRefundExtraBillItems(
@RefundNo varchar(20),
@ExtraBillNo varchar(20),
@ReceiptNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReturnReasonID varchar(10),
@Quantity int,
@Amount money,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundNo from Refunds where RefundNo  = @RefundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund No', @RefundNo, 'Refunds')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if exists(select RefundNo from RefundExtraBillItems where RefundNo = @RefundNo and ExtraBillNo = @ExtraBillNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Refund No', @RefundNo, 'Extra Bill No', @ExtraBillNo, 'Receipt No', @ReceiptNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID)
		return 1
	end

if not exists(select ReceiptNo from PaymentExtraBillItems where ReceiptNo = @ReceiptNo and ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'Bill Form Payments')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into RefundExtraBillItems
(RefundNo, ExtraBillNo, ReceiptNo, ItemCode, ItemCategoryID, ReturnReasonID, Quantity, Amount, LoginID, ClientMachine)
values
(@RefundNo, @ExtraBillNo, @ReceiptNo, @ItemCode, @ItemCategoryID, @ReturnReasonID, @Quantity, @Amount, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertRefundExtraBillItems
******************************************************************************************************/
-- select * from RefundExtraBillItems
-- delete from RefundExtraBillItems


-------------- Get RefundExtraBillItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRefundExtraBillItems')
	drop proc uspGetRefundExtraBillItems
go

create proc uspGetRefundExtraBillItems(
@RefundNo varchar(20),
@ExtraBillNo varchar(20),
@ReceiptNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundNo from RefundExtraBillItems where RefundNo = @RefundNo and ExtraBillNo = @ExtraBillNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund No', @RefundNo, 'Extra Bill No', @ExtraBillNo, 'Receipt No', @ReceiptNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'RefundExtraBillItems')
		return 1
	end
else
begin
	select RefundNo, ExtraBillNo, ReceiptNo, ItemCode, ItemCategoryID, ReturnReasonID, Quantity, Amount, RefundExtraBillItems.LoginID, ClientMachine, RecordDateTime
	from RefundExtraBillItems
	inner join Logins on RefundExtraBillItems.LoginID = Logins.LoginID
	where RefundNo = @RefundNo and ExtraBillNo = @ExtraBillNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetRefundExtraBillItems
******************************************************************************************************/
-- select * from RefundExtraBillItems
-- delete from RefundExtraBillItems




-------------- Get AllAllRefundDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAllRefundDetails')
	drop proc uspGetAllRefundDetails
go

create proc uspGetAllRefundDetails(
@RefundNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundNo from RefundDetails where RefundNo = @RefundNo )
	begin
		set @ErrorMSG = 'The record with %s: %s , you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund No', @RefundNo, 'Refunds')
		return 1
	end
if exists(select RefundNo from ReceiptReversals where RefundNo = @RefundNo )
	begin
		set @ErrorMSG = 'The record with %s: %s , you are trying to enter is already Reversed and exists in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund No', @RefundNo, 'Receipt Reversals')
		return 1
	end

else
begin
	select dbo.GetRefundVisitNo(RefundDetails.ReceiptNo) as VisitNo,RefundNo,ReceiptNo, ItemCategoryID, ItemCode, Quantity, Amount, ReturnReasonID, 
	dbo.GetLookupDataDes(ReturnReasonID) as [ReturnReason],RefundDetails.LoginID, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName,
	 dbo.GetPatientFullNameWithReceiptNo(ReceiptNo) as FullName,dbo.FormatDate(dbo.GetReceiptRecordDateTime(RefundDetails.ReceiptNo)) as PayDate,
	RefundDetails.ClientMachine, RefundDetails.RecordDateTime,dbo.IsOPDReceiptNo(ReceiptNo) as ReceiptType
	from RefundDetails
	where RefundNo = @RefundNo and 
	RefundDetails.RefundNo NOT IN 
	(Select RefundNo from ReceiptReversals)
return 0
end
go

-----------------------------------------------------------------------------------------------------------------------


/******************************************************************************************************
exec uspGetAllRefundDetails '180000010401'
exec uspGetAllRefundDetails '180000006001'
exec uspGetAllRefundDetails '160001097301'
******************************************************************************************************/

------------------------------------------------------------------------------------------------------
------------- PaymentsDetails ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Payment Details ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPaymentDetails')
	drop proc uspInsertPaymentDetails
go

create proc uspInsertPaymentDetails(
@ReceiptNo varchar(20),
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Quantity int,
@UnitPrice money,
@Discount money ,
@Amount money 
)with encryption as 

declare @ErrorMSG varchar(200)
declare @PackageID varchar(10)
declare @StatusID varchar(10)
declare @PatientNo varchar(20)
declare @LoginID varchar(20)

set @PackageID =dbo.GetLookupDataID('ItemCategory', 'G')
set @StatusID = dbo.GetLookupDataID('Status', 'A')
set @PatientNo= dbo.GetPatientNo(@VisitNo)

set @LoginID = (select top 1 LoginID from Payments where ReceiptNo = @ReceiptNo)

if not exists(select ReceiptNo from Payments where ReceiptNo = @ReceiptNo)
	begin
		set @ErrorMSG = 'The Receipt No: ' + @ReceiptNo + ', you are trying to enter does not exist in the registered Payments'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select VisitNo from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'Items')
		return 1
	end

if exists(select ReceiptNo from PaymentDetails where ReceiptNo = @ReceiptNo and VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID)
		return 1
	end

else
begin
insert into PaymentDetails
(ReceiptNo, VisitNo, ItemCode, ItemCategoryID, Quantity, UnitPrice, Discount, Amount) 
values
(@ReceiptNo, @VisitNo, @ItemCode, @ItemCategoryID, @Quantity, @UnitPrice, @Discount, @Amount)


return 0
end
go


------------- Get PaymentDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPaymentDetails')
	drop proc uspGetPaymentDetails
go

create proc uspGetPaymentDetails(
@ReceiptNo varchar(20),
@ItemCategoryID varchar(10)=null
)with encryption as

declare @ErrorMSG varchar(200)
declare @OPDVisitTypeID varchar(10)
set @OPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')


if not @ReceiptNo is null and @ItemCategoryID is null 
begin
	if not exists(select ReceiptNo from PaymentDetails where ReceiptNo = @ReceiptNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not have entries in %s'
			raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payment Details')
			return 1
		end
	else
	begin
		select PaymentDetails.ReceiptNo, dbo.FormatDate(VisitDate) as VisitDate,
		dbo.FormatText(PaymentDetails.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
		dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		PaymentDetails.ItemCode, dbo.GetItemName(PaymentDetails.ItemCategoryID, PaymentDetails.ItemCode) as ItemName, MemberCardNo, ClaimReferenceNo, 
		PaymentDetails.ItemCategoryID, dbo.GetLookupDataDes(PaymentDetails.ItemCategoryID) as ItemCategory, PaymentDetails.Quantity, 
		PaymentDetails.UnitPrice, Discount, Amount, dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
		dbo.GetLookupDataDes(Visits.BranchID) as BranchName,
		dbo.IsReturnableOPDInventory(PaymentDetails.VisitNo, PaymentDetails.ItemCategoryID, PaymentDetails.ItemCode) as IsReturnable,
		dbo.FormatMoney(dbo.GetRefundItemAmount(PaymentDetails.ReceiptNo, PaymentDetails.VisitNo,
		 PaymentDetails.ItemCode, PaymentDetails.ItemCategoryID)) as RefundedAmount,
		dbo.GetRefundItemQuantity(PaymentDetails.ReceiptNo, 
		PaymentDetails.VisitNo, PaymentDetails.ItemCode, PaymentDetails.ItemCategoryID) as RefundedQuantity,
		items.InvoiceNo as InvoiceNo, items.Quantity as BillQuantity, items.UnitPrice as BillPrice,
		(Amount - dbo.GetRefundItemAmount(PaymentDetails.ReceiptNo, PaymentDetails.VisitNo,
		 PaymentDetails.ItemCode, PaymentDetails.ItemCategoryID)) as AmountBalance

		from PaymentDetails	
		inner join Payments on PaymentDetails.ReceiptNo = Payments.ReceiptNo
		inner join Visits on PaymentDetails.VisitNo = Visits.VisitNo
		inner join Items on Items.VisitNo = PaymentDetails.VisitNo and Items.ItemCode = PaymentDetails.ItemCode
		and Items.ItemCategoryID = PaymentDetails.ItemCategoryID
		inner join Patients on Visits.PatientNo = Patients.PatientNo
		where PaymentDetails.ReceiptNo = @ReceiptNo
	end
end

else if not @ReceiptNo is null and not @ItemCategoryID is null 
begin
	select PaymentDetails.ReceiptNo, dbo.FormatDate(VisitDate) as VisitDate,
		dbo.FormatText(PaymentDetails.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
		dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		PaymentDetails.ItemCode, dbo.GetItemName(PaymentDetails.ItemCategoryID, PaymentDetails.ItemCode) as ItemName, MemberCardNo, ClaimReferenceNo, 
		PaymentDetails.ItemCategoryID, dbo.GetLookupDataDes(PaymentDetails.ItemCategoryID) as ItemCategory, PaymentDetails.Quantity, 
		PaymentDetails.UnitPrice, Discount, Amount, dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
		dbo.GetLookupDataDes(Visits.BranchID) as BranchName,
		dbo.IsReturnableOPDInventory(PaymentDetails.VisitNo, PaymentDetails.ItemCategoryID, PaymentDetails.ItemCode) as IsReturnable,
		dbo.FormatMoney(dbo.GetRefundItemAmount(PaymentDetails.ReceiptNo, PaymentDetails.VisitNo,
		 PaymentDetails.ItemCode, PaymentDetails.ItemCategoryID)) as RefundedAmount,
		dbo.GetRefundItemQuantity(PaymentDetails.ReceiptNo, 
		PaymentDetails.VisitNo, PaymentDetails.ItemCode, PaymentDetails.ItemCategoryID) as RefundedQuantity,
		items.InvoiceNo as InvoiceNo, items.Quantity as BillQuantity, items.UnitPrice as BillPrice,
		(Amount - dbo.GetRefundItemAmount(PaymentDetails.ReceiptNo, PaymentDetails.VisitNo,
		 PaymentDetails.ItemCode, PaymentDetails.ItemCategoryID)) as AmountBalance

		from PaymentDetails	
		inner join Payments on PaymentDetails.ReceiptNo = Payments.ReceiptNo
		inner join Visits on PaymentDetails.VisitNo = Visits.VisitNo
		inner join Items on Items.VisitNo = PaymentDetails.VisitNo and Items.ItemCode = PaymentDetails.ItemCode
		and Items.ItemCategoryID = PaymentDetails.ItemCategoryID
		inner join Patients on Visits.PatientNo = Patients.PatientNo
	where PaymentDetails.ReceiptNo = @ReceiptNo and Items.ItemCategoryID = @ItemCategoryID
end

return 0
go
/******************************************************************************************************
exec uspGetPaymentDetails '10000001'
exec uspGetPaymentDetails '10000001','7N'
exec uspGetPaymentDetails '10000001','7T'

select * from PaymentDetails

******************************************************************************************************/

------------- Get PaymentDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisitPaymentDetails')
	drop proc uspGetVisitPaymentDetails
go

create proc uspGetVisitPaymentDetails(
@ReceiptNo varchar(20),
@visitNo varchar(20),
@ItemCategoryID varchar(10)=null
)with encryption as

declare @ErrorMSG varchar(200)
declare @OPDVisitTypeID varchar(10)
set @OPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')


if not @ReceiptNo is null and @ItemCategoryID is null 
begin
	if not exists(select ReceiptNo from PaymentDetails where ReceiptNo = @ReceiptNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not have entries in %s'
			raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payment Details')
			return 1
		end
	else
	begin
		select PaymentDetails.ReceiptNo, dbo.FormatDate(VisitDate) as VisitDate,
		dbo.FormatText(PaymentDetails.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
		dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		PaymentDetails.ItemCode, dbo.GetItemName(PaymentDetails.ItemCategoryID, PaymentDetails.ItemCode) as ItemName, MemberCardNo, ClaimReferenceNo, 
		PaymentDetails.ItemCategoryID, dbo.GetLookupDataDes(PaymentDetails.ItemCategoryID) as ItemCategory, PaymentDetails.Quantity, 
		PaymentDetails.UnitPrice, Discount, Amount, dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
		dbo.GetLookupDataDes(Visits.BranchID) as BranchName,
		dbo.IsReturnableOPDInventory(PaymentDetails.VisitNo, PaymentDetails.ItemCategoryID, PaymentDetails.ItemCode) as IsReturnable,
		dbo.FormatMoney(dbo.GetRefundItemAmount(PaymentDetails.ReceiptNo, PaymentDetails.VisitNo,
		 PaymentDetails.ItemCode, PaymentDetails.ItemCategoryID)) as RefundedAmount,
		dbo.GetRefundItemQuantity(PaymentDetails.ReceiptNo, 
		PaymentDetails.VisitNo, PaymentDetails.ItemCode, PaymentDetails.ItemCategoryID) as RefundedQuantity,
		items.InvoiceNo as InvoiceNo, items.Quantity as BillQuantity, items.UnitPrice as BillPrice,
		(Amount - dbo.GetRefundItemAmount(PaymentDetails.ReceiptNo, PaymentDetails.VisitNo,
		 PaymentDetails.ItemCode, PaymentDetails.ItemCategoryID)) as AmountBalance

		from PaymentDetails	
		inner join Payments on PaymentDetails.ReceiptNo = Payments.ReceiptNo
		inner join Visits on PaymentDetails.VisitNo = Visits.VisitNo
		inner join Items on Items.VisitNo = PaymentDetails.VisitNo and Items.ItemCode = PaymentDetails.ItemCode
		and Items.ItemCategoryID = PaymentDetails.ItemCategoryID
		inner join Patients on Visits.PatientNo = Patients.PatientNo
		where PaymentDetails.ReceiptNo = @ReceiptNo and PaymentDetails.VisitNo = @visitNo
	end
end

else if not @ReceiptNo is null and not @ItemCategoryID is null 
begin
	select PaymentDetails.ReceiptNo, dbo.FormatDate(VisitDate) as VisitDate,
		dbo.FormatText(PaymentDetails.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
		dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		PaymentDetails.ItemCode, dbo.GetItemName(PaymentDetails.ItemCategoryID, PaymentDetails.ItemCode) as ItemName, MemberCardNo, ClaimReferenceNo, 
		PaymentDetails.ItemCategoryID, dbo.GetLookupDataDes(PaymentDetails.ItemCategoryID) as ItemCategory, PaymentDetails.Quantity, 
		PaymentDetails.UnitPrice, Discount, Amount, dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
		dbo.GetLookupDataDes(Visits.BranchID) as BranchName,
		dbo.IsReturnableOPDInventory(PaymentDetails.VisitNo, PaymentDetails.ItemCategoryID, PaymentDetails.ItemCode) as IsReturnable,
		dbo.FormatMoney(dbo.GetRefundItemAmount(PaymentDetails.ReceiptNo, PaymentDetails.VisitNo,
		 PaymentDetails.ItemCode, PaymentDetails.ItemCategoryID)) as RefundedAmount,
		dbo.GetRefundItemQuantity(PaymentDetails.ReceiptNo, 
		PaymentDetails.VisitNo, PaymentDetails.ItemCode, PaymentDetails.ItemCategoryID) as RefundedQuantity,
		items.InvoiceNo as InvoiceNo, items.Quantity as BillQuantity, items.UnitPrice as BillPrice,
		(Amount - dbo.GetRefundItemAmount(PaymentDetails.ReceiptNo, PaymentDetails.VisitNo,
		 PaymentDetails.ItemCode, PaymentDetails.ItemCategoryID)) as AmountBalance
		from PaymentDetails	
		inner join Payments on PaymentDetails.ReceiptNo = Payments.ReceiptNo
		inner join Visits on PaymentDetails.VisitNo = Visits.VisitNo
		inner join Items on Items.VisitNo = PaymentDetails.VisitNo and Items.ItemCode = PaymentDetails.ItemCode
		and Items.ItemCategoryID = PaymentDetails.ItemCategoryID
		inner join Patients on Visits.PatientNo = Patients.PatientNo
	where PaymentDetails.ReceiptNo = @ReceiptNo and PaymentDetails.VisitNo = @visitNo and Items.ItemCategoryID = @ItemCategoryID
end

return 0
go
/******************************************************************************************************
exec uspGetVisitPaymentDetails '10000001', '1091/09001'
exec uspGetVisitPaymentDetails '10000001', '1091/09001','7S'
exec uspGetVisitPaymentDetails '10000001', '1091/09001', '7T'

select * from PaymentDetails

******************************************************************************************************/

------------------------------------------------------------------------------------------------------
-------------- Quotations ----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Quotations ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertQuotations')
	drop proc uspInsertQuotations
go

create proc uspInsertQuotations(
@QuotationNo varchar(20),
@QuotationDate smalldatetime,
@AmountWords varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

declare @QuotationID int
declare @CurrentYear as char(2)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedQuotationID int
declare @PassedQuotationNo varchar(20)

------------------------------------------------------------------------------------------------------------------

if exists(select QuotationNo from Quotations where QuotationNo = @QuotationNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Quotation No', @QuotationNo)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

---------------------------------------------------------------------------------------------------------------------

select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'Quotations' and AutoColumnName = 'QuotationNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'Quotations' and AutoColumnName = 'QuotationNo'

set @CurrentYear = right(year(getdate()),2)

if (@AutoColumnLEN = len(@QuotationNo)) and (left(@QuotationNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedQuotationID = 1
	set @PassedQuotationNo = @QuotationNo
	set @PassedQuotationNo = ltrim(rtrim(substring(@PassedQuotationNo, len(@CurrentYear) + 1, @PaddingLEN)))

	if isnumeric(@PassedQuotationNo) = 1 set @PassedQuotationID = @PassedQuotationNo
	else set @PassedQuotationID = 1

	set @QuotationID = (select max(QuotationID) from Quotations where left(QuotationNo, len(@CurrentYear)) = @CurrentYear)
	set @QuotationID = dbo.GetNextAutoNumber('Quotations', 'QuotationNo', @QuotationID)

	if @PassedQuotationID < @QuotationID set @QuotationID = @PassedQuotationID
	if @PassedQuotationID > @QuotationID set @QuotationID = @PassedQuotationID

end else set @QuotationID = 1

---------------------------------------------------------------------------------------------------------------------

insert into Quotations
(QuotationID, QuotationNo, QuotationDate, AmountWords, LoginID, ClientMachine)
values
(@QuotationID, @QuotationNo, @QuotationDate, @AmountWords, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertQuotations '15000001', '27 Oct 2012', 'One Hundred Three Thousand Two Hundred', 'Admin', 'SYNCSOFT'			
exec uspInsertQuotations '15000002', '27 Oct 2012', 'One Hundred Three Thousand Two Hundred', 'Admin', 'CIL_1'
exec uspInsertQuotations '15000006', '27 Oct 2012', 'One Hundred Three Thousand Two Hundred', 'Admin', 'CIL_1'

******************************************************************************************************/
-- select * from Quotations
-- delete from Quotations

-------------- Update Quotations ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateQuotations')
	drop proc uspUpdateQuotations
go

create proc uspUpdateQuotations(
@QuotationNo varchar(20),
@QuotationDate smalldatetime,
@AmountWords varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select QuotationNo from Quotations where QuotationNo = @QuotationNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Quotation No', @QuotationNo, 'Quotations')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update Quotations set 
	QuotationDate = @QuotationDate, AmountWords = @AmountWords, LoginID = @LoginID, ClientMachine = @ClientMachine
where QuotationNo = @QuotationNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateQuotations '15000002', '27 Feb 2015', 'One Hundred Three Thousand Two Hundred', 'Admin','SIL2'

******************************************************************************************************/
-- select * from Quotations
-- delete from Quotations



-------------- Get Quotations -------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetQuotations')
	drop proc uspGetQuotations
go

create proc uspGetQuotations(
@QuotationNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select QuotationNo from Quotations where QuotationNo = @QuotationNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Quotation No', @QuotationNo, 'Quotations')
		return 1
	end
else
begin
	select Quotations.QuotationNo, Quotations.QuotationDate, dbo.GetQuotationAmount(Quotations.QuotationNo) as QuotationAmount, 
	AmountWords,QuotationDetails.VisitNo, dbo.GetAge(BirthDate, getdate()) as Age, dbo.GetLookupDataDes(BillModesID) as BillMode,
	 BillNo,dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
	 dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetLookupDataDes(VisitStatusID) as VisitStatus,JoinDate,dbo.GetFullName(LastName, 
	 MiddleName, FirstName) as FullName, Patients.PatientNo,VisitDate
	from Quotations
	inner join QuotationDetails on QuotationDetails.QuotationNo = Quotations.QuotationNo
	inner join Visits on Visits.VisitNo=QuotationDetails.VisitNo
	inner join Patients on Patients.PatientNo=visits.PatientNo
	where Quotations.QuotationNo = @QuotationNo
return 0
end
go

/******************************************************************************************************
exec uspGetQuotations '12000001'

******************************************************************************************************/
-- select * from Quotations
-- delete from Quotations

--------GetPeriodicQuotations----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicQuotations')
	drop proc uspGetPeriodicQuotations
go

create proc uspGetPeriodicQuotations(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as
begin
	select dbo.FormatText(QuotationNo, 'Quotations', 'QuotationNo') as QuotationNo,
			dbo.FormatDate(QuotationDate) as QuotationDate,
			dbo.GetQuotationAmount(QuotationNo) as QuotationAmount, AmountWords,
			dbo.FormatDate(Quotations.RecordDateTime) as RecordDate,
			dbo.GetTime(Quotations.RecordDateTime) as RecordTime
	from Quotations
	where QuotationDate between @StartDate and @EndDate
	order by QuotationDate desc, QuotationNo desc
end
return 0
go

-- select * from Quotations
-- exec uspGetPeriodicQuotations 'Oct 20, 2011', 'Oct 30, 2011'

--------GetNextQuotationID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextQuotationID')
	drop proc uspGetNextQuotationID
go

create proc uspGetNextQuotationID(
@QuotationID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @QuotationID = (select max(QuotationID) from Quotations where left(QuotationNo, 2) = @CurrentYear)
set @QuotationID = dbo.GetNextAutoNumber('Quotations', 'QuotationNo', @QuotationID)

return 0

go

-- exec uspGetNextQuotationID
-- select * from Quotations

------------------------------------------------------------------------------------------------------
-------------- QuotationDetails ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit QuotationDetails -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditQuotationDetails')
	drop proc uspEditQuotationDetails
go

create proc uspEditQuotationDetails(
@QuotationNo varchar(20),
@VisitNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@ItemName varchar(800),
@UnitMeasure varchar(100),
@Quantity int,
@UnitPrice money,
@Discount money,
@Amount money,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select QuotationNo from Quotations where QuotationNo = @QuotationNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Quotation No', @QuotationNo, 'Quotations')
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')		
		return 1
	end
		
if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end
		
if exists(select QuotationNo from QuotationDetails where QuotationNo = @QuotationNo and VisitNo = @VisitNo 
										and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		update QuotationDetails set
		ItemName = @ItemName, UnitMeasure = @UnitMeasure, Quantity = @Quantity, UnitPrice = @UnitPrice, 
		Discount = @Discount, Amount = @Amount, LoginID = @LoginID, ClientMachine = @ClientMachine
		where QuotationNo = @QuotationNo and VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
		return 0
	end
else
begin
insert into QuotationDetails
(QuotationNo, VisitNo, ItemCategoryID, ItemCode, ItemName, UnitMeasure, 
Quantity, UnitPrice, Discount, Amount, LoginID, ClientMachine)
values
(@QuotationNo, @VisitNo, @ItemCategoryID, @ItemCode, @ItemName, @UnitMeasure, 
@Quantity, @UnitPrice, @Discount, @Amount, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspEditQuotationDetails '15000001', '1313893001', '7S', '10C', 'Consultation', '', 1, 25000.00, 0.00, 25000.00, 'Admin', 'SYNCSOFT'
exec uspEditQuotationDetails '15000001', '1313893001', '7D', 'M056', 'PenV', '', 60, 1000.00, 0.00, 6000.00, 'Admin', 'SYNCSOFT'
exec uspEditQuotationDetails '15000002', '1313893001', '7D', 'M516', 'Panadol', 'Tab', 60, 1000.00, 0.00, 6000.00, 'Admin', 'CIL_1'

******************************************************************************************************/
-- select * from QuotationDetails
-- delete from QuotationDetails

-------------- Get QuotationDetails ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetQuotationDetails')
	drop proc uspGetQuotationDetails
go

create proc uspGetQuotationDetails(
@QuotationNo varchar(20),
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@ItemCategoryID is null)
begin
	select dbo.FormatText(QuotationDetails.QuotationNo, 'Quotations', 'QuotationNo') as QuotationNo,	
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(QuotationDetails.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, ClaimReferenceNo, 
	QuotationDetails.Quantity, QuotationDetails.UnitPrice, Discount, Amount,
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, QuotationDetails.ItemCategoryID, 
	dbo.GetLookupDataDes(QuotationDetails.ItemCategoryID) as ItemCategory, QuotationDetails.ItemCode, 
	ItemName, UnitMeasure, CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
	CoPayPercent, CoPayValue, dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor
	from QuotationDetails	
	inner join Quotations on QuotationDetails.QuotationNo = Quotations.QuotationNo	
	inner join Visits on QuotationDetails.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where QuotationDetails.QuotationNo = @QuotationNo and ItemCategoryID = @ItemCategoryID
end
else
begin
	select dbo.FormatText(QuotationDetails.QuotationNo, 'Quotations', 'QuotationNo') as QuotationNo,	
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(QuotationDetails.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, ClaimReferenceNo, 
	QuotationDetails.Quantity, QuotationDetails.UnitPrice, Discount, Amount,
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, QuotationDetails.ItemCategoryID, 
	dbo.GetLookupDataDes(QuotationDetails.ItemCategoryID) as ItemCategory, QuotationDetails.ItemCode, 
	ItemName, UnitMeasure, CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
	CoPayPercent, CoPayValue, dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor
	from QuotationDetails	
	inner join Quotations on QuotationDetails.QuotationNo = Quotations.QuotationNo	
	inner join Visits on QuotationDetails.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where QuotationDetails.QuotationNo = @QuotationNo
end
return 0
go

/******************************************************************************************************
exec uspGetQuotationDetails '15000002'
exec uspGetQuotationDetails '15000002', '7D'

******************************************************************************************************/
-- select * from QuotationDetails
-- delete from QuotationDetails


------------------------------------------------------------------------------------------------------
-------------- Invoices ------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Invoices -----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertInvoices')
	drop proc uspInsertInvoices
go

create proc uspInsertInvoices(
@InvoiceNo varchar(20),
@PayTypeID varchar(10),
@PayNo varchar(20),
@InvoiceDate smalldatetime,
@StartDate smalldatetime,
@EndDate smalldatetime,
@AmountWords varchar(200),
@VisitTypeID varchar(10),
@EntryModeID varchar(10),
@Locked bit =0,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

declare @CashVisitPayTypeID varchar(10)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)
declare @IPDRoundPayTypeID varchar(10)
declare @ExtraBillPayTypeID varchar(10)
declare @LockStatus bit
declare @InvoiceID int
declare @CurrentYear as char(2)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedInvoiceID int
declare @PassedInvoiceNo varchar(20)

----------------------------------------------------------------------------
set @CashVisitPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')
set @IPDRoundPayTypeID = dbo.GetLookupDataID('PayType', 'IPR')
set @ExtraBillPayTypeID = dbo.GetLookupDataID('PayType', 'EXT')
----------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------
if (@PayTypeID = @CashVisitPayTypeID)
	begin
		if not exists(select VisitNo from Visits where VisitNo = @PayNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Visit No', @PayNo, 'Visits')
				return 1
			end
	end

else if (@PayTypeID = @AccountBillPayTypeID)
	begin 
		if not exists(select AccountNo from BillCustomers where AccountNo = @PayNo)
			begin
				set @ErrorMSG = 'The  %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Account No', @PayNo, 'To-Bill Customers')	
				return 1
			end
	end

else if (@PayTypeID = @InsuranceBillPayTypeID)
	begin 
		if not exists(select InsuranceNo from Insurances where InsuranceNo = @PayNo)
			begin
				set @ErrorMSG = 'The  %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Insurance No', @PayNo, 'Insurances')	
				return 1
			end
	end

else if (@PayTypeID = @IPDRoundPayTypeID)
	begin 
		if not exists(select RoundNo from IPDDoctor where RoundNo  = @PayNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Round No', @PayNo, 'IPD Doctor')
				return 1
			end
	end

else if (@PayTypeID = @ExtraBillPayTypeID)
	begin 
		if not exists(select ExtraBillNo from ExtraBills where ExtraBillNo = @PayNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @PayNo, 'Extra Bills')
				return 1
			end
	end
------------------------------------------------------------------------------------------------------------------

if exists(select InvoiceNo from Invoices where InvoiceNo = @InvoiceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pay Type', @PayTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisitTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit Type', @VisitTypeID, 'Lookup Data')
		return 1
	end

	if not exists(select DataID from LookupData where DataID = @EntryModeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Entry Mode', @EntryModeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if (dbo.GetOptionValue('LockVisitUponInvoiceCreation') > 0)
set @LockStatus = 1 else set @LockStatus = 0

begin update Visits set Locked = @LockStatus where VisitNo = @PayNo end

begin

---------------------------------------------------------------------------------------------------------------------

select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'Invoices' and AutoColumnName = 'InvoiceNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'Invoices' and AutoColumnName = 'InvoiceNo'

set @CurrentYear = right(year(getdate()),2)

if (@AutoColumnLEN = len(@InvoiceNo)) and (left(@InvoiceNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedInvoiceID = 1
	set @PassedInvoiceNo = @InvoiceNo
	set @PassedInvoiceNo = ltrim(rtrim(substring(@PassedInvoiceNo, len(@CurrentYear) + 1, @PaddingLEN)))

	if isnumeric(@PassedInvoiceNo) = 1 set @PassedInvoiceID = @PassedInvoiceNo
	else set @PassedInvoiceID = 1

	set @InvoiceID = (select max(InvoiceID) from Invoices where left(InvoiceNo, len(@CurrentYear)) = @CurrentYear)
	set @InvoiceID = dbo.GetNextAutoNumber('Invoices', 'InvoiceNo', @InvoiceID)

	if @PassedInvoiceID < @InvoiceID set @InvoiceID = @PassedInvoiceID
	if @PassedInvoiceID > @InvoiceID set @InvoiceID = @PassedInvoiceID

end else set @InvoiceID = 1

---------------------------------------------------------------------------------------------------------------------

insert into Invoices
(InvoiceID, InvoiceNo, PayTypeID, PayNo, InvoiceDate, StartDate, EndDate, AmountWords, VisitTypeID, EntryModeID, Locked, LoginID)
values
(@InvoiceID, @InvoiceNo, @PayTypeID, @PayNo, @InvoiceDate, @StartDate, @EndDate, @AmountWords, @VisitTypeID, @EntryModeID, @Locked,@LoginID)

return 0
end
go

/******************************************************************************************************
exec uspInsertInvoices '1900004590', '47CAS', 'P16000002003', '01 Jan 2010', '12 Feb 2019', '12 Feb 2019',
                        'One Hundred Three Thousand Two Hundred', '110OPD', '46MAN', 0, 'Admin'
******************************************************************************************************/
-- select * from Invoices
-- delete from Invoices


-------------- Update Invoices ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateInvoices')
	drop proc uspUpdateInvoices
go

create proc uspUpdateInvoices(
@InvoiceNo varchar(20),
@PayTypeID varchar(10),
@PayNo varchar(20),
@InvoiceDate smalldatetime,
@StartDate smalldatetime,
@EndDate smalldatetime,
@AmountWords varchar(200),
@VisitTypeID varchar(10),
@Locked bit =0,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @PayTpeID varchar(10)


if not exists(select InvoiceNo from Invoices where InvoiceNo = @InvoiceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo, 'Invoices')
		return 1
	end

	if  exists(select InvoiceNo from Invoices where InvoiceNo = @InvoiceNo and Locked = 1)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter is among the non editable %s'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo, 'Invoices')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @PayTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pay Type', @PayTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisitTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit Type', @VisitTypeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update Invoices set
PayTypeID = @PayTypeID, PayNo = @PayNo, InvoiceDate = @InvoiceDate, StartDate = @StartDate, 
EndDate = @EndDate, AmountWords = @AmountWords, VisitTypeID = @VisitTypeID,Locked=@Locked, LoginID = @LoginID
where InvoiceNo = @InvoiceNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateInvoices '12000002', '47ACC', '100026A', '27 Oct 2012', '22 oct 2012', '22 oct 2012',
						'One Hundred Three Thousand Two Hundred', 'Admin'

******************************************************************************************************/
-- select * from Invoices
-- delete from Invoices

-------------- Get Invoices -------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInvoices')
	drop proc uspGetInvoices
go

create proc uspGetInvoices(
@InvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select InvoiceNo from Invoices where InvoiceNo = @InvoiceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo, 'Invoices')
		return 1
	end
else
begin
	select InvoiceNo, PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName, InvoiceDate, PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
	 dbo.GetInvoiceAmount(InvoiceNo, VisitTypeID) as InvoiceAmount, StartDate, EndDate, AmountWords, Cancelled, EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
	 dbo.FormatMoney(dbo.GetInvoiceReversedAmount(Invoices.InvoiceNo, VisitTypeID)) as ReversedAmount,
	dbo.FormatMoney(dbo.GetInvoicBalanceAmount(InvoiceNo, VisitTypeID)) as NetAmount, VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as VisitType,Locked
	from Invoices
	where InvoiceNo = @InvoiceNo
return 0
end
go

/******************************************************************************************************
exec uspGetInvoices '1900004590'

******************************************************************************************************/
-- select * from Invoices
-- delete from Invoices

--------GetPeriodicInvoices----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicInvoices')
	drop proc uspGetPeriodicInvoices
go

create proc uspGetPeriodicInvoices(
@PayTypeID varchar(10),
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as
begin
	select dbo.FormatText(InvoiceNo, 'Invoices', 'InvoiceNo') as InvoiceNo,
			PayNo, dbo.FormatDate(InvoiceDate) as InvoiceDate,
			dbo.GetLookupDataDes(PayTypeID) as PayType,
			dbo.GetInvoiceName(PayTypeID, PayNo) as InvoiceName,
			dbo.FormatDate(StartDate) as StartDate,
			dbo.FormatDate(EndDate) as EndDate,		
			dbo.GetInvoiceAmount(InvoiceNo, VisitTypeID) as InvoiceAmount, AmountWords,
			dbo.FormatDate(Invoices.RecordDateTime) as RecordDate,
			dbo.GetTime(Invoices.RecordDateTime) as RecordTime
	from Invoices
	where PayTypeID = @PayTypeID and InvoiceDate between @StartDate and @EndDate
	order by InvoiceDate desc, InvoiceNo desc
end
return 0
go

-- select * from Invoices
-- exec uspGetPeriodicInvoices '47CAS', 'Oct 20, 2012', 'Oct 30, 2012'

--------GetInvoiceNoByPayNo-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInvoiceNoByPayNo')
	drop proc uspGetInvoiceNoByPayNo
go

create proc uspGetInvoiceNoByPayNo(
@PayTypeID varchar(10),
@PayNo varchar(20),
@VisitTypeID varchar(10),
@InvoiceNo varchar(20) = null output
)with encryption as

set @InvoiceNo = (select top 1 InvoiceNo from Invoices 
				where PayTypeID = @PayTypeID and PayNo = @PayNo and VisitTypeID = @VisitTypeID 
				order by RecordDateTime desc)
						
set @InvoiceNo = isnull(@InvoiceNo, '')

return 0

go

-- exec uspGetInvoiceNoByPayNo '47CAS', '1306943007', '110OPD'

--------CountVisitInvoices-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountVisitInvoices')
	drop proc uspCountVisitInvoices
go

create proc uspCountVisitInvoices(
@PayTypeID varchar(10),
@PayNo varchar(20),
@VisitTypeID varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null,
@Records tinyint = null output
)with encryption as

if ((@StartDate is null) or (@EndDate is null))
	begin
		set @Records = (select count(InvoiceNo) from Invoices 
						where PayTypeID = @PayTypeID and PayNo = @PayNo and VisitTypeID = @VisitTypeID)
	end		
else
	begin
		set @Records = (select count(InvoiceNo) from Invoices 
						where PayTypeID = @PayTypeID and PayNo = @PayNo and VisitTypeID = @VisitTypeID
						and StartDate = @StartDate  and EndDate = @EndDate)
	end	

set @Records = isnull(@Records, 0)

return 0

go

-- exec uspCountVisitInvoices '47CAS', '1306943007', '110OPD'

--------GetNextInvoiceID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextInvoiceID')
	drop proc uspGetNextInvoiceID
go

create proc uspGetNextInvoiceID(
@InvoiceID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @InvoiceID = (select max(InvoiceID) from Invoices where left(InvoiceNo, 2) = @CurrentYear)
set @InvoiceID = dbo.GetNextAutoNumber('Invoices', 'InvoiceNo', @InvoiceID)

return 0

go

-- exec uspGetNextInvoiceID
-- select * from Invoices



-------------- usp Get Visit No By InvoiceNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisitNoByInvoiceNo')
	drop proc uspGetVisitNoByInvoiceNo
go

create proc uspGetVisitNoByInvoiceNo(
@InvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @VisitBillPayTypeID varchar(10)
set @VisitBillPayTypeID =  dbo.GetLookupDataID('PayType', 'CAS')

if not exists(select InvoiceNo from Invoices where InvoiceNo = @InvoiceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo, 'Invoices')
		return 1
	end

	if  exists(select top 1 InvoiceNo from Invoices where InvoiceNo = @InvoiceNo and not (PayTypeID = @VisitBillPayTypeID))
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter is for an Account Bill Type. It is no tis not allowed for this operation'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo)
		return 1
	end

else
begin
	 select  top 1 Invoices.InvoiceNo,dbo.FormatText(InvoiceDetails.VisitNo, 'Visits', 'VisitNo') as VisitNo,InvoiceDate,
	 dbo.GetInvoiceBillNo(PayTypeID, PayNo)as BIllNo,VisitDate
	 from Invoices
     inner join InvoiceDetails on InvoiceDetails.invoiceNo= Invoices.InvoiceNo
	 inner join Visits on Visits.VisitNo=InvoiceDetails.VisitNo
	 where Invoices.InvoiceNo = @InvoiceNo and PayTypeID=@VisitBillPayTypeID

return 0
end
go


/**********************************************************************************************************************
exec uspGetVisitNoByInvoiceNo '18000018'
***********************************************************************************************************************/

----------------Delete Invoices-------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspDeleteInvoice')
	drop proc uspDeleteInvoice
go

create proc uspDeleteInvoice(
@InvoiceNo varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @visitNo varchar(20)
declare @LockStatus as bit
if not exists(select InvoiceNo from Invoices where InvoiceNo = @InvoiceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo, 'Invoices')
		return 1
	end

begin
begin tran

set @visitNo = (select TOP 1 PayNo from Invoices where InvoiceNo = @InvoiceNo)
set @LockStatus = 0
-----------------------------------------------------------------------------------------------------------------------
	update Visits set Locked = @LockStatus where VisitNo = @VisitNo
-----------------------------------------------------------------------------------------------------------------------
	delete Invoices where InvoiceNo  = @InvoiceNo
-----------------------------------------------------------------------------------------------------------------------

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran

end
return 0
go

-- exec uspDeleteInvoice '000001BA21078001', '10C','7S'

-------------- update UpdateItemInvoiceNo ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateItemInvoiceNo')
	drop proc uspUpdateItemInvoiceNo
go

create proc uspUpdateItemInvoiceNo(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@InvoiceNo varchar(20),
@ObjectName varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @VisitBillPayTypeID varchar(10)
declare @OPDVisitTypeID varchar(10)
declare @ItemsObjectName varchar(40)
declare @ItemsCASHObjectName varchar(40)
declare @PayTpeID varchar(10)
declare @VisitTypeID varchar(10)


set @VisitBillPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @OPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')
set @ItemsObjectName = 'Items'
set @ItemsCASHObjectName = 'ItemsCASH'
set @PayTpeID = (select PayTypeID from Invoices where InvoiceNo = @InvoiceNo)
set @VisitTypeID = (select VisitTypeID from Invoices where InvoiceNo = @InvoiceNo)

if not (exists(select InvoiceNo from Invoices where InvoiceNo = @InvoiceNo)) and not (@InvoiceNo is null or @InvoiceNo = '')
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter is not registered in table %s'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo, 'Invoices')
		return 1
	end

begin
	if @PayTpeID = @VisitBillPayTypeID and @VisitTypeID = @OPDVisitTypeID
	begin
	 if @ObjectName = @ItemsObjectName
		 begin
		 update Items set InvoiceNo = @InvoiceNo 
		 where  VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
		 end

	 else if @ObjectName = @ItemsCASHObjectName
		begin
		 update ItemsCASH set InvoiceNo = @InvoiceNo 
		 where  VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
		end
	end
 return 0
 end
go

 -- select * from InvoiceDetails
 --- exec uspUpdateItemInvoiceNo 'ABUB0001', '10C01',  '7S', '18072252', 'Items'
 --- exec uspUpdateItemInvoiceNo 'P160009550006', 'CPV',  '7E', '18072252', 'ItemsCASH'
 -- select top 2 * from Items
  -- select top 2 * from ItemsCASH

------------------------------------------------------------------------------------------------------
-------------- InvoiceDetails ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit InvoiceDetails -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditInvoiceDetails')
	drop proc uspEditInvoiceDetails
go

create proc uspEditInvoiceDetails(
@InvoiceNo varchar(20),
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ObjectName varchar(40),
@Quantity int,
@UnitPrice Money,
@Discount Money,
@Amount Money
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select InvoiceNo from Invoices where InvoiceNo = @InvoiceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo, 'Invoices')
		return 1
	end

if not exists(select VisitNo from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'Items')
		return 1
	end

if not exists(select ObjectName from AccessObjects where ObjectName  = @ObjectName)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Object Name', @ObjectName, 'Access Objects')
		return 1
	end

else

 begin
 begin tran

	insert into InvoiceDetails
	(InvoiceNo, VisitNo, ItemCode, ItemCategoryID, ObjectName, Quantity, UnitPrice, Discount, Amount)
	values
	(@InvoiceNo, @VisitNo, @ItemCode, @ItemCategoryID, @ObjectName, @Quantity, @UnitPrice, @Discount, @Amount)

	exec uspUpdateItemInvoiceNo @VisitNo, @ItemCode, @ItemCategoryID, @InvoiceNo, @ObjectName
  if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
return 0
end
go

/******************************************************************************************************
exec uspEditInvoiceDetails '1900004590', 'P16000002003', 'DRG0434', '7D', 'Items', 10, 1000.00, 0.00, 6000.00

******************************************************************************************************/
--- select * from Items where VisitNo = 'P16000002003'
-- select * from InvoiceDetails
-- delete from InvoiceDetails
-------------- Get InvoiceDetails ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInvoiceDetails')
	drop proc uspGetInvoiceDetails
go

create proc uspGetInvoiceDetails(
@InvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select dbo.FormatText(InvoiceDetails.InvoiceNo, 'Invoices', 'InvoiceNo') as InvoiceNo,	
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(InvoiceDetails.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, MainMemberName, ClaimReferenceNo, 
	InvoiceDetails.Quantity, InvoiceDetails.UnitPrice, Discount, Amount,
	(InvoiceDetails.Quantity* InvoiceDetails.UnitPrice) - Discount as DisplayAmount,
	dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, InvoiceDetails.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	InvoiceDetails.ItemCategoryID, dbo.GetLookupDataDes(InvoiceDetails.ItemCategoryID) as ItemCategory, ObjectName,
	dbo.GetItemName(InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode) as ItemName, 
	dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
	dbo.GetUnitMeasure(InvoiceDetails.ItemCategoryID,InvoiceDetails.ItemCode) as UnitMeasure,
	(case when (dbo.GetVATPercentage(InvoiceDetails.ItemCategoryID,InvoiceDetails.ItemCode)) <=0 then 'NO VAT' else 'VAT' end) as VATIdentifier, 
	dbo.IsReturnableOPDInventory(InvoiceDetails.VisitNo,InvoiceDetails.ItemCategoryID,InvoiceDetails.ItemCode) as IsReturnable,
	dbo.GetCreditNoteQuantity(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)  as ReturnQuantity,
    dbo.GetCreditNoteAmount(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)  as ReturnAmount,
	dbo.GetInvoiceItemBalanceQuantity(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)  as QuantityBalance,
    dbo.GetInvoiceItemBalanceAmount(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)  as AmountBalance,
	dbo.GetItemReceiptNo(InvoiceDetails.VisitNo,InvoiceDetails.ItemCategoryID,InvoiceDetails.ItemCode) as ReceiptNo,
	Items.UnitPrice as BillPrice, Items.Quantity as BillQuantity, Items.UnitPrice * Items.Quantity as BillAmount
	from InvoiceDetails
	inner join Items on Items.VisitNo = InvoiceDetails.VisitNo 
	and Items.ItemCode = InvoiceDetails.ItemCode and Items.ItemCategoryID = InvoiceDetails.ItemCategoryID
	inner join Visits on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where InvoiceDetails.InvoiceNo = @InvoiceNo
	order by VisitDate asc
return 0
end
go

/******************************************************************************************************
exec uspGetInvoiceDetails '1900004590'
exec uspGetInvoiceDetails '18172339' 

******************************************************************************************************/
-- select * from InvoiceDetails where InvoiceNo = '18172338'
-- select * from Items where VisitNo = 'P160026830011'
-- delete from InvoiceDetails


-------------- Get ToAdjustInvoiceDetails ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetToAdjustInvoiceDetails')
	drop proc uspGetToAdjustInvoiceDetails
go

create proc uspGetToAdjustInvoiceDetails(
@InvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select dbo.FormatText(InvoiceDetails.InvoiceNo, 'Invoices', 'InvoiceNo') as InvoiceNo,	
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(InvoiceDetails.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, MainMemberName, ClaimReferenceNo, 
	InvoiceDetails.Quantity, InvoiceDetails.UnitPrice, Discount, Amount,
	dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, InvoiceDetails.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	InvoiceDetails.ItemCategoryID, dbo.GetLookupDataDes(InvoiceDetails.ItemCategoryID) as ItemCategory,
	dbo.GetItemName(InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode) as ItemName, 
	dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
	dbo.GetUnitMeasure(InvoiceDetails.ItemCategoryID,InvoiceDetails.ItemCode) as UnitMeasure,
	(case when (dbo.GetVATPercentage(InvoiceDetails.ItemCategoryID,InvoiceDetails.ItemCode)) <=0 then 'NO VAT' else 'VAT' end) as VATIdentifier, 
	dbo.IsReturnableOPDInventory(InvoiceDetails.VisitNo,InvoiceDetails.ItemCategoryID,InvoiceDetails.ItemCode) as IsReturnable,
	dbo.GetCreditNoteQuantity(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)  as ReturnQuantity,
    dbo.GetCreditNoteAmount(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)  as ReturnAmount,
	dbo.GetInvoiceItemBalanceQuantity(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)  as QuantityBalance,
    dbo.GetInvoiceItemBalanceAmount(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)  as AmountBalance,
	dbo.GetItemReceiptNo(InvoiceDetails.VisitNo,InvoiceDetails.ItemCategoryID,InvoiceDetails.ItemCode) as ReceiptNo,
	Items.UnitPrice as BillPrice, Items.Quantity as BillQuantity, Items.UnitPrice * Items.Quantity as BillAmount
	from InvoiceDetails
	inner join Invoices on Invoices.InvoiceNo = InvoiceDetails.InvoiceNo
	inner join Items on Items.VisitNo = InvoiceDetails.VisitNo 
	and Items.ItemCode = InvoiceDetails.ItemCode and Items.ItemCategoryID = InvoiceDetails.ItemCategoryID
	inner join Visits on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where InvoiceDetails.InvoiceNo = @InvoiceNo and (Items.Quantity * Items.UnitPrice) > 0 and Cancelled = 0
	order by VisitDate asc
return 0
end
go

/******************************************************************************************************
exec uspGetToAdjustInvoiceDetails '18172370'
exec uspGetToAdjustInvoiceDetails '17000006' 

******************************************************************************************************/



-------------- Get Visit InvoiceDetails ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisitInvoiceDetails')
	drop proc uspGetVisitInvoiceDetails
go

create proc uspGetVisitInvoiceDetails(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @OPDVisitTypeID varchar(10)
set @OPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')

begin
	select dbo.FormatText(InvoiceDetails.InvoiceNo, 'Invoices', 'InvoiceNo') as InvoiceNo,	
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(InvoiceDetails.VisitNo, 'Visits', 'VisitNo') as VisitNo, PayNo,
	PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType,
	dbo.FormatDate(VisitDate) as VisitDate, dbo.FormatDate(InvoiceDate) as InvoiceDate, MemberCardNo, MainMemberName, ClaimReferenceNo, 
	InvoiceDetails.Quantity, InvoiceDetails.UnitPrice, Discount, Amount,
	dbo.GetMappedCustomCode(BillNo,Items.ItemCode,Items.ItemCategoryID) as MappedCustomCode,
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, InvoiceDetails.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	InvoiceDetails.ItemCategoryID, dbo.GetLookupDataDes(InvoiceDetails.ItemCategoryID) as ItemCategory,
	dbo.GetItemName(InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode) as ItemName, 
	dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
	dbo.GetUnitMeasure(InvoiceDetails.ItemCategoryID,InvoiceDetails.ItemCode) as UnitMeasure,
	(case when (dbo.GetVATPercentage(InvoiceDetails.ItemCategoryID,InvoiceDetails.ItemCode)) <=0 then 'NO VAT' else 'VAT' end) as VATIdentifier, 
	dbo.IsReturnableOPDInventory(InvoiceDetails.VisitNo,InvoiceDetails.ItemCategoryID,InvoiceDetails.ItemCode) as IsReturnable,
	dbo.GetCreditNoteQuantity(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)  as ReturnQuantity,
    dbo.GetCreditNoteAmount(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)  as ReturnAmount,
    dbo.GetInvoiceItemBalanceQuantity(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)  as QuantityBalance,
    dbo.GetInvoiceItemBalanceAmount(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)  as AmountBalance,
	dbo.GetItemReceiptNo(InvoiceDetails.VisitNo,InvoiceDetails.ItemCategoryID,InvoiceDetails.ItemCode) as ReceiptNo,
   	Items.UnitPrice as BillPrice, Items.Quantity as BillQuantity, Items.UnitPrice * Items.Quantity as BillAmount

	from InvoiceDetails
	inner join Items on Items.VisitNo = InvoiceDetails.VisitNo 
	and Items.ItemCode = InvoiceDetails.ItemCode and Items.ItemCategoryID = InvoiceDetails.ItemCategoryID
	inner join Visits on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	inner join Invoices on Invoices.InvoiceNo = InvoiceDetails.InvoiceNo
	where Invoices.PayNo = @VisitNo and VisitTypeID = @OPDVisitTypeID and Cancelled = 0
	and dbo.GetInvoiceItemBalanceAmount(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)>0

	order by VisitDate asc

return 0
end
go


/******************************************************************************************************
exec uspGetVisitInvoiceDetails '1214563002'

******************************************************************************************************/

/******************************************************************************************************
exec uspGetVisitInvoiceDetails '1214563002'

******************************************************************************************************/


-------------- Get InvoiceBillDetails ---------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetInvoiceBillDetails')
	drop proc uspGetInvoiceBillDetails
go

create proc uspGetInvoiceBillDetails(
@InvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @OPDVisitTypeID varchar(10)

set @OPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')

begin
	select dbo.FormatText(InvoiceDetails.InvoiceNo, 'Invoices', 'InvoiceNo') as InvoiceNo,
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(InvoiceDetails.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, ClaimReferenceNo, 
	dbo.GetFullName(LastName, MiddleName, FirstName) as FullName,
	dbo.GetBillCustomerName (BillNo) as BillCustomerName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	SUM(Amount) as VisitAmount, dbo.FormatMoney(dbo.GetVisitInvoiceBalanceAmount(InvoiceNo,InvoiceDetails.VisitNo, @OPDVisitTypeID)) as AmountBalance
	from InvoiceDetails
	inner join Visits on InvoiceDetails.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where InvoiceDetails.InvoiceNo = @InvoiceNo
	group by InvoiceDetails.InvoiceNo, Visits.PatientNo, InvoiceDetails.VisitNo,
	VisitDate,BillNo, MemberCardNo, ClaimReferenceNo, dbo.GetFullName(LastName, MiddleName, FirstName),
	dbo.GetLookupDataDes(GenderID), dbo.GetAge(BirthDate, getdate()), dbo.GetVisitInvoiceBalanceAmount(InvoiceNo,InvoiceDetails.VisitNo, @OPDVisitTypeID)
return 0
end
go
/******************************************************************************************************
exec uspGetInvoiceBillDetails '18000079'
exec uspGetInvoiceBillDetails '12000004'

******************************************************************************************************/
-- select * from InvoiceDetails
-- select * from InvoiceDetails
-- delete from InvoiceDetails


-------------- update ExtraBillItemInvoiceNo ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateExtraBillItemInvoiceNo')
	drop proc uspUpdateExtraBillItemInvoiceNo
go

create proc uspUpdateExtraBillItemInvoiceNo(
@ExtraBillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@InvoiceNo varchar(20),
@ObjectName varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @VisitBillPayTypeID varchar(10)
declare @IPDVisitTypeID varchar(10)
declare @ExtraBillItemsObjectName varchar(40)
declare @ExtraBillItemsCASHObjectName varchar(40)
declare @PayTpeID varchar(10)
declare @VisitTypeID varchar(10)


set @VisitBillPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')
set @ExtraBillItemsObjectName = 'ExtraBillItems'
set @ExtraBillItemsCASHObjectName = 'ExtraBillItemsCASH'
set @PayTpeID = (select PayTypeID from Invoices where InvoiceNo = @InvoiceNo)
set @VisitTypeID = (select VisitTypeID from Invoices where InvoiceNo = @InvoiceNo)

if not (exists(select InvoiceNo from Invoices where InvoiceNo = @InvoiceNo)) and not (@InvoiceNo is null or @InvoiceNo = '')
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter is not registered in table %s'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo, 'Invoices')
		return 1
	end

begin
	if @PayTpeID = @VisitBillPayTypeID and @VisitTypeID = @IPDVisitTypeID
	begin
	 if @ObjectName = @ExtraBillItemsObjectName
		 begin
		 update ExtraBillItems set InvoiceNo = @InvoiceNo 
		 where  ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
		 end

	 else if @ObjectName = @ExtraBillItemsCASHObjectName
		begin
		 update ExtraBillItemsCASH set InvoiceNo = @InvoiceNo 
		 where  ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
		end
	end
 return 0
 end
go

 -- select * from InvoiceExtraBillItems
 --- exec uspUpdateExtraBillItemInvoiceNo 'P160000200001', 'LAB010',  '7T', '18187061', 'ExtraBillItems'
 --- exec uspUpdateExtraBillItemInvoiceNo 'P160004150001', 'DRG0001',  '7D', '18187061', 'ExtraBillItemsCASH'
 -- select top 2 * from ExtraBillItems
  -- select top 2 * from ExtraBillItemsCASH

------------------------------------------------------------------------------------------------------
-------------- InvoiceExtraBillItems -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit InvoiceExtraBillItems ------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditInvoiceExtraBillItems')
	drop proc uspEditInvoiceExtraBillItems
go

create proc uspEditInvoiceExtraBillItems(
@InvoiceNo varchar(20),
@ExtraBillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ObjectName varchar(40),
@Quantity int,
@UnitPrice Money,
@Discount Money,
@Amount Money
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select InvoiceNo from Invoices where InvoiceNo = @InvoiceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo, 'Invoices')
		return 1
	end

if not exists(select ExtraBillNo from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'Extra Bill Items')
		return 1
	end

	
if not exists(select ObjectName from AccessObjects where ObjectName  = @ObjectName)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Object Name', @ObjectName, 'Access Objects')
		return 1
	end


begin
begin tran
insert into InvoiceExtraBillItems
(InvoiceNo, ExtraBillNo, ItemCode, ItemCategoryID, ObjectName, Quantity, UnitPrice, Discount, Amount)
values
(@InvoiceNo, @ExtraBillNo, @ItemCode, @ItemCategoryID, @ObjectName, @Quantity, @UnitPrice, @Discount, @Amount)

 exec uspUpdateExtraBillItemInvoiceNo @ExtraBillNo, @ItemCode, @ItemCategoryID, @InvoiceNo, @ObjectName
 if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
return 0
end
go

/******************************************************************************************************
exec uspEditInvoiceExtraBillItems '1900004590', 'P160000200001', 'LAB010', '7T', ExtraBillItems, 1, 5000.00, 0.00, 25000.00
exec uspEditInvoiceExtraBillItems '1900004590', 'P160000200001', 'LAB110', '7T', ExtraBillItems, 1, 20000.00, 0.00, 6000.00
exec uspEditInvoiceExtraBillItems '1900004590', 'P160000200002', 'DRG0060', '7D', ExtraBillItems, 1, 6000.00, 0.00, 6000.00

******************************************************************************************************/
-- select * from InvoiceExtraBillItems
-- delete from InvoiceExtraBillItems


-------------- GetInvoiceExtraBillItems ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInvoiceExtraBillItems')
	drop proc uspGetInvoiceExtraBillItems
go

create proc uspGetInvoiceExtraBillItems(
@InvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select dbo.FormatText(InvoiceExtraBillItems.InvoiceNo, 'Invoices', 'InvoiceNo') as InvoiceNo,	
	dbo.FormatText(InvoiceExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, 
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
	MemberCardNo, MainMemberName, MainMemberName, ClaimReferenceNo, 
	dbo.FormatDate(VisitDate) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate, 
	InvoiceExtraBillItems.Quantity, InvoiceExtraBillItems.UnitPrice, Discount, Amount, 
	(InvoiceExtraBillItems.Quantity * InvoiceExtraBillItems.UnitPrice) - Discount as DisplayAmount, 
	InvoiceExtraBillItems.ItemCode, dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode,	
	InvoiceExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(InvoiceExtraBillItems.ItemCategoryID) as ItemCategory,
	dbo.GetItemName(InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode) as ItemName, 
	dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
	dbo.GetUnitMeasure(InvoiceExtraBillItems.ItemCategoryID,InvoiceExtraBillItems.ItemCode) as UnitMeasure,
	(case when (dbo.GetVATPercentage(InvoiceExtraBillItems.ItemCategoryID,InvoiceExtraBillItems.ItemCode)) <= 0 then 'NO VAT' else 'VAT' end) as VATIdentifier,
	dbo.IsReturnableIPDInventory(InvoiceExtraBillItems.ExtraBillNo,InvoiceExtraBillItems.ItemCategoryID,InvoiceExtraBillItems.ItemCode) as IsReturnable,
	dbo.GetCreditNoteIPDQuantity(InvoiceExtraBillItems.InvoiceNo, InvoiceExtraBillItems.ExtraBillNo, InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode)  as ReturnQuantity,
    dbo.GetCreditNoteIPDAmount(InvoiceExtraBillItems.InvoiceNo, InvoiceExtraBillItems.ExtraBillNo, InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode)  as ReturnAmount,
	dbo.GetIPDInvoiceItemBalanceQuantity(InvoiceExtraBillItems.InvoiceNo, InvoiceExtraBillItems.ExtraBillNo, InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode)  as QuantityBalance,
    dbo.GetIPDInvoiceItemBalanceAmount(InvoiceExtraBillItems.InvoiceNo, InvoiceExtraBillItems.ExtraBillNo, InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode)  as AmountBalance,
	
	dbo.GetIPDItemReceiptNo(InvoiceExtraBillItems.ExtraBillNo,InvoiceExtraBillItems.ItemCategoryID,InvoiceExtraBillItems.ItemCode) as ReceiptNo,
	 ExtraBillItems.Quantity as BillQuantity,  ExtraBillItems.UnitPrice as BillPrice, ExtraBillItems.UnitPrice * ExtraBillItems.Quantity as BillAmount

	from InvoiceExtraBillItems	
	inner join ExtraBillItems on ExtraBillItems.ExtraBillNo = InvoiceExtraBillItems.ExtraBillNo 
	and ExtraBillItems.ItemCode = InvoiceExtraBillItems.ItemCode 
	and ExtraBillItems.ItemCategoryID = InvoiceExtraBillItems.ItemCategoryID
	inner join ExtraBills on InvoiceExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join Visits on ExtraBills.VisitNo = Visits.VisitNo							
	inner join Patients on Visits.PatientNo = Patients.PatientNo			
	where InvoiceExtraBillItems.InvoiceNo = @InvoiceNo
	order by VisitDate asc
return 0
end
go

/******************************************************************************************************
exec uspGetInvoiceExtraBillItems '12000004'

******************************************************************************************************/
-- select * from InvoiceExtraBillItems
-- delete from InvoiceExtraBillItems


-------------- GetInvoiceExtraBillItems ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetToAdjustInvoiceExtraBillItems')
	drop proc uspGetToAdjustInvoiceExtraBillItems
go

create proc uspGetToAdjustInvoiceExtraBillItems(
@InvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select dbo.FormatText(InvoiceExtraBillItems.InvoiceNo, 'Invoices', 'InvoiceNo') as InvoiceNo,	
	dbo.FormatText(InvoiceExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, 
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
	MemberCardNo, MainMemberName, MainMemberName, ClaimReferenceNo, 
	dbo.FormatDate(VisitDate) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate, 
	InvoiceExtraBillItems.Quantity, InvoiceExtraBillItems.UnitPrice, Discount, Amount, 
	InvoiceExtraBillItems.ItemCode, dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode,	
	InvoiceExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(InvoiceExtraBillItems.ItemCategoryID) as ItemCategory,
	dbo.GetItemName(InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode) as ItemName, 
	dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	ExtraBillItems.EntryModeID, dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode,
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
	dbo.GetUnitMeasure(InvoiceExtraBillItems.ItemCategoryID,InvoiceExtraBillItems.ItemCode) as UnitMeasure,
	(case when (dbo.GetVATPercentage(InvoiceExtraBillItems.ItemCategoryID,InvoiceExtraBillItems.ItemCode)) <= 0 then 'NO VAT' else 'VAT' end) as VATIdentifier,
	dbo.IsReturnableIPDInventory(InvoiceExtraBillItems.ExtraBillNo,InvoiceExtraBillItems.ItemCategoryID,InvoiceExtraBillItems.ItemCode) as IsReturnable,
	dbo.GetCreditNoteIPDQuantity(InvoiceExtraBillItems.InvoiceNo, InvoiceExtraBillItems.ExtraBillNo, InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode)  as ReturnQuantity,
    dbo.GetCreditNoteIPDAmount(InvoiceExtraBillItems.InvoiceNo, InvoiceExtraBillItems.ExtraBillNo, InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode)  as ReturnAmount,
	dbo.GetIPDInvoiceItemBalanceQuantity(InvoiceExtraBillItems.InvoiceNo, InvoiceExtraBillItems.ExtraBillNo, InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode)  as QuantityBalance,
    dbo.GetIPDInvoiceItemBalanceAmount(InvoiceExtraBillItems.InvoiceNo, InvoiceExtraBillItems.ExtraBillNo, InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode)  as AmountBalance,
	
	dbo.GetIPDItemReceiptNo(InvoiceExtraBillItems.ExtraBillNo,InvoiceExtraBillItems.ItemCategoryID,InvoiceExtraBillItems.ItemCode) as ReceiptNo,
	 ExtraBillItems.Quantity as BillQuantity,  ExtraBillItems.UnitPrice as BillPrice, ExtraBillItems.UnitPrice * ExtraBillItems.Quantity as BillAmount

	from InvoiceExtraBillItems	
	inner join Invoices on Invoices.InvoiceNo = InvoiceExtraBillItems.InvoiceNo
	inner join ExtraBillItems on ExtraBillItems.ExtraBillNo = InvoiceExtraBillItems.ExtraBillNo 
	and ExtraBillItems.ItemCode = InvoiceExtraBillItems.ItemCode 
	and ExtraBillItems.ItemCategoryID = InvoiceExtraBillItems.ItemCategoryID
	inner join ExtraBills on InvoiceExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join Visits on ExtraBills.VisitNo = Visits.VisitNo							
	inner join Patients on Visits.PatientNo = Patients.PatientNo			
	where InvoiceExtraBillItems.InvoiceNo = @InvoiceNo and (ExtraBillItems.Quantity * ExtraBillItems.UnitPrice)>0 and Cancelled = 0
	order by VisitDate asc
return 0
end
go


/******************************************************************************************************
exec uspGetToAdjustInvoiceExtraBillItems '18172372'

******************************************************************************************************/


-------------- Get InvoiceExtraBillDetails ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInvoiceExtraBillDetails')
	drop proc uspGetInvoiceExtraBillDetails
go

create proc uspGetInvoiceExtraBillDetails(
@InvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @IPDVisitTypeID varchar(10)
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')

begin
	select dbo.FormatText(InvoiceExtraBillItems.InvoiceNo, 'Invoices', 'InvoiceNo') as InvoiceNo,
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatDate(VisitDate) as VisitDate, MemberCardNo, ClaimReferenceNo, 
	dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age,
	dbo.GetBillCustomerName (BillNo) as BillCustomerName, SUM(Amount) as VisitAmount,
	dbo.GetVisitInvoiceBalanceAmount(InvoiceExtraBillItems.InvoiceNo, Visits.VisitNo, @IPDVisitTypeID) as AmountBalance 
	from InvoiceExtraBillItems
	inner join ExtraBills on InvoiceExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where InvoiceExtraBillItems.InvoiceNo = @InvoiceNo
	group by InvoiceExtraBillItems.InvoiceNo, Visits.PatientNo, Visits.VisitNo,BillNo,
	VisitDate, MemberCardNo, ClaimReferenceNo, dbo.GetFullName(LastName, MiddleName, FirstName),
	dbo.GetLookupDataDes(GenderID), dbo.GetAge(BirthDate, getdate()), 
	dbo.GetVisitInvoiceBalanceAmount(InvoiceExtraBillItems.InvoiceNo, Visits.VisitNo, @IPDVisitTypeID)
return 0
end
go

/******************************************************************************************************
exec uspGetInvoiceExtraBillDetails '15039763'
exec uspGetInvoiceExtraBillDetails '15039946'
select * from InvoiceExtraBillItemAdjustments where InvoiceNo = '15039946'

******************************************************************************************************/

/******************************************************************************************************
exec uspGetInvoiceExtraBillDetails '15039763'
exec uspGetInvoiceExtraBillDetails '15039946'
select * from InvoiceExtraBillItemAdjustments where InvoiceNo = '15039946'

******************************************************************************************************/
-- select * from InvoiceExtraBillItems
-- delete from InvoiceExtraBillItems




-------------- GetVisitInvoiceExtraBillItems ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisitInvoiceExtraBillItems')
	drop proc uspGetVisitInvoiceExtraBillItems
go

create proc uspGetVisitInvoiceExtraBillItems(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @IPDVisitTypeID varchar(10)

set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')
begin
	select dbo.FormatText(InvoiceExtraBillItems.InvoiceNo, 'Invoices', 'InvoiceNo') as InvoiceNo,	
	dbo.FormatText(InvoiceExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, PayNo,
	PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, dbo.FormatDate(InvoiceDate) as InvoiceDate,
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
	MemberCardNo, MainMemberName, MainMemberName, ClaimReferenceNo, 
	dbo.FormatDate(VisitDate) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate, 
	InvoiceExtraBillItems.Quantity, InvoiceExtraBillItems.UnitPrice, Discount, Amount, 
	InvoiceExtraBillItems.ItemCode, dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode,	
	InvoiceExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(InvoiceExtraBillItems.ItemCategoryID) as ItemCategory,
	dbo.GetItemName(InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode) as ItemName, 
	dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	ExtraBillItems.EntryModeID, dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode,
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
	dbo.GetUnitMeasure(InvoiceExtraBillItems.ItemCategoryID,InvoiceExtraBillItems.ItemCode) as UnitMeasure,
	(case when (dbo.GetVATPercentage(InvoiceExtraBillItems.ItemCategoryID,InvoiceExtraBillItems.ItemCode)) <=0 then 'NO VAT' else 'VAT' end) as VATIdentifier,
	dbo.IsReturnableIPDInventory(InvoiceExtraBillItems.ExtraBillNo,InvoiceExtraBillItems.ItemCategoryID,InvoiceExtraBillItems.ItemCode) as IsReturnable,
    dbo.GetCreditNoteIPDQuantity(InvoiceExtraBillItems.InvoiceNo, InvoiceExtraBillItems.ExtraBillNo, InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode)  as ReturnQuantity,
    dbo.GetCreditNoteIPDAmount(InvoiceExtraBillItems.InvoiceNo, InvoiceExtraBillItems.ExtraBillNo, InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode)  as ReturnAmount,
	dbo.GetIPDInvoiceItemBalanceQuantity(InvoiceExtraBillItems.InvoiceNo, InvoiceExtraBillItems.ExtraBillNo, InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode)  as QuantityBalance,
    dbo.GetIPDInvoiceItemBalanceAmount(InvoiceExtraBillItems.InvoiceNo, InvoiceExtraBillItems.ExtraBillNo, InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode)  as AmountBalance,
	dbo.GetIPDItemReceiptNo(InvoiceExtraBillItems.ExtraBillNo,InvoiceExtraBillItems.ItemCategoryID,InvoiceExtraBillItems.ItemCode) as ReceiptNo,
	ExtraBillItems.Quantity as BillQuantity,  ExtraBillItems.UnitPrice as BillPrice, ExtraBillItems.UnitPrice * ExtraBillItems.Quantity as BillAmount

	from InvoiceExtraBillItems	
	inner join ExtraBillItems on ExtraBillItems.ExtraBillNo = InvoiceExtraBillItems.ExtraBillNo 
	and ExtraBillItems.ItemCode = InvoiceExtraBillItems.ItemCode 
	and ExtraBillItems.ItemCategoryID = InvoiceExtraBillItems.ItemCategoryID
	inner join ExtraBills on InvoiceExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join Visits on ExtraBills.VisitNo = Visits.VisitNo							
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	inner join Invoices on Invoices.InvoiceNo = InvoiceExtraBillItems.InvoiceNo			
	where PayNo = @VisitNo and Invoices.VisitTypeID = @IPDVisitTypeID and Cancelled = 0
	and dbo.GetIPDInvoiceItemBalanceAmount(InvoiceExtraBillItems.InvoiceNo, InvoiceExtraBillItems.ExtraBillNo, InvoiceExtraBillItems.ItemCategoryID, InvoiceExtraBillItems.ItemCode)>0

	order by VisitDate asc
return 0
end
go

/******************************************************************************************************
exec uspGetVisitInvoiceExtraBillItems '044002'

******************************************************************************************************/



------------- Accounts -------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Accounts -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAccounts')
	drop proc uspInsertAccounts
go

create proc uspInsertAccounts(
@TranNo varchar(20),
@AccountBillModesID varchar(10),
@AccountBillNo varchar(20),
@ClientFullName varchar(100),
@TranDate smalldatetime,
@PayModesID varchar(10),
@AccountActionID varchar(10),
@Amount money,
@DocumentNo varchar(20),
@AmountWords varchar(200),
@CurrenciesID varchar(10),
@AmountTendered money,
@ExchangeRate money,
@Change money,
@AccountGroupID varchar(10),
@Notes varchar(100),
@EntryModeID varchar(10),
@ReferenceNo varchar(20)=null,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @TranID int
declare @CurrentYear as char(2)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedTranID int
declare @PassedTranNo varchar(20)

declare @CashBillModesID varchar(10)
declare @CashBillModes varchar(100)
declare @AccBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)
declare @BranchID varchar(10)
declare @CreditID varchar(10)
declare @DebitID varchar(10)

declare @Balance money

----------------------------------------------------------------------------
set @BranchID = dbo.GetMyCurrentBranch(@LoginID)
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @CashBillModes = dbo.GetLookupDataDes(@CashBillModesID)
set @AccBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')

set @CreditID = dbo.GetLookupDataID('AccountAction', 'CR')
set @DebitID = dbo.GetLookupDataID('AccountAction', 'DR')

set @Balance = 0 
----------------------------------------------------------------------------

if exists(select TranNo from Accounts where TranNo = @TranNo)
	begin
		set @ErrorMSG = 'The Transaction No: ' + @TranNo + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AccountBillModesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account Bill Modes ID', @AccountBillModesID, 'Lookup Data')
		return 1
	end

------------------------------------------------------------------------------------------------------------------
if (@AccountBillModesID = @InsuranceBillModesID)
	begin
		if not exists(select InsuranceNo from Insurances where InsuranceNo = @AccountBillNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Insurance No', @AccountBillNo, 'Insurances')
				return 1
			end
	end




if (@AccountBillModesID = @CashBillModesID)
	begin
		if not exists(select PatientNo from Patients where PatientNo = @AccountBillNo)
			begin
			 if not exists(select SupplierName from Suppliers where SupplierNo = @AccountBillNo)
			 begin
				set @ErrorMSG = 'The  %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Patient No', @AccountBillNo, 'Patients')
				return 1
			end
			end
	end

else if (@AccountBillModesID = @AccBillModesID)
	begin
		if (@AccountBillNo = @CashBillModes)
			begin
				set @ErrorMSG = 'Account Bill No for Bill Mode Account can''t be Cash!'
				raiserror(@ErrorMSG,16, 1)	
				return 1
			end

		if not exists(select AccountNo from BillCustomers where AccountNo = @AccountBillNo)
			begin
				set @ErrorMSG = 'The  %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Account No', @AccountBillNo, 'Bill Customers')	
				return 1
			end
	end


------------------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @PayModesID)
	begin
		set @ErrorMSG = 'The Pay Modes ID: ' + @PayModesID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AccountActionID)
	begin
		set @ErrorMSG = 'The Account Action ID: ' + @AccountActionID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CurrenciesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrenciesID, 'Lookup Data')
		return 1
	end

if not @AccountActionID in (@DebitID, @CreditID)
	begin
		set @ErrorMSG = 'Account Action ID must be only in 19DR for Debit or 19CR for Credit'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AccountGroupID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account Group ID', @AccountGroupID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EntryModeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Entry Mode ID', @EntryModeID, 'Lookup Data')
		return 1
	end


if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
begin

---------------------------------------------------------------------------------------------------------------------

select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'Accounts' and AutoColumnName = 'TranNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'Accounts' and AutoColumnName = 'TranNo'

set @CurrentYear = right(year(getdate()),2)

if (@AutoColumnLEN = len(@TranNo)) and (left(@TranNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedTranID = 1
	set @PassedTranNo = @TranNo
	set @PassedTranNo = ltrim(rtrim(substring(@PassedTranNo, len(@CurrentYear) + 1, @PaddingLEN)))

	if isnumeric(@PassedTranNo) = 1 set @PassedTranID = @PassedTranNo
	else set @PassedTranID = 1

	set @TranID = (select max(TranID) from Accounts where left(TranNo, len(@CurrentYear)) = @CurrentYear)
	set @TranID = dbo.GetNextAutoNumber('Accounts', 'TranNo', @TranID)

	if @PassedTranID < @TranID set @TranID = @PassedTranID
	if @PassedTranID > @TranID set @TranID = @PassedTranID

end else set @TranID = 1


---------------------------------------------------------------------------------------------------------------------------------
set @Balance = (select Balance from Accounts Where AccountID = (select Max(AccountID) from Accounts
				where AccountBillModesID = @AccountBillModesID and AccountBillNo = @AccountBillNo))

set @Balance = isnull(@Balance, 0)

if @AccountActionID = @CreditID	set @Balance = @Balance +  @Amount
if @AccountActionID = @DebitID	set @Balance = @Balance - @Amount
---------------------------------------------------------------------------------------------------------------------------------
begin tran

begin
	if (@AccountBillModesID = @CashBillModesID)
		begin update Patients set AccountBalance = @Balance where PatientNo = @AccountBillNo end
		
	else if (@AccountBillModesID = @AccBillModesID)
		begin update BillCustomers set AccountBalance = @Balance where AccountNo = @AccountBillNo end
end

---------------------------------------------------------------------------------------------------------------------------------
insert into Accounts
(TranID, TranNo,ClientFullName, AccountBillModesID, AccountBillNo, TranDate, PayModesID, AccountActionID, Amount, Balance, DocumentNo, 
AmountWords, CurrenciesID, AmountTendered, ExchangeRate, Change, AccountGroupID, Notes, EntryModeID,BranchID,ReferenceNo, LoginID, ClientMachine) 
values
(@TranID, @TranNo,@ClientFullName, @AccountBillModesID, @AccountBillNo, @TranDate, @PayModesID, @AccountActionID, @Amount, @Balance, @DocumentNo, 
@AmountWords, @CurrenciesID, @AmountTendered, @ExchangeRate, @Change, @AccountGroupID, @Notes, @EntryModeID,@BranchID,@ReferenceNo, @LoginID, @ClientMachine)
---------------------------------------------------------------------------------------------------------------------------------


if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran

end
return 0

go

/***************************************************************************************
--1---------------------------------------------------%-----------------------------------
exec uspInsertAccounts '001', '0600001A', '4 Nov 2005', '6CA', '19DR', 70000,
			'DOC No 1', 'Seventy Thousand','Debit the account', 'Admin'

exec uspInsertAccounts '005', '0600001A', '4 Nov 2005', '6CA', '19DR', 70000,
			'DOC No 1', 'Seventy Thousand','Debit the account', 'Admin'

exec uspInsertAccounts '003','0600001A', '4 Nov 2005', '6CA', '19CR', 80000,
			'DOC No 2',  'Eighty Thousand','Cbedit the account', 'Admin'

exec uspInsertAccounts '004','0600002A', '4 Nov 2005', '6CH', '19CR', 8000,
			'DOC No 2', 'Eight Thousand', 'Credit the account', 'Admin'
***************************************************************************************/

-- select *  from Accounts order by RecordDatetime desc
-- delete from Accounts

--------GetAccounts----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAccounts')
	drop proc uspGetAccounts
go

create proc uspGetAccounts(
@TranNo varchar(20) = null,
@StartDateTime smalldatetime = null,
@EndDateTime smalldatetime = null,
@VisitsBranch varchar(10) =null,
@LoginID varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@TranNo is null) and (@StartDateTime is null) and (@EndDateTime is null) and (@LoginID is null) and (@VisitsBranch is null)
	begin
		if not exists(select TranNo from Accounts where TranNo = @TranNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Tran No', @TranNo, 'Accounts')
				return 1
			end
		else
			begin
				select dbo.FormatText(TranNo, 'Accounts', 'TranNo') as TranNo, 
				dbo.GetLookupDataDes(AccountBillModesID) as AccountCategory, 
				dbo.FormatDate(TranDate) as TranDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
				AccountBillNo, ClientFullName as AccountName,
				dbo.GetLookupDataDes(AccountActionID) as AccountAction, Amount,
				dbo.FormatMoney(dbo.GetAccountAmount(TranNo)) as AccountAmount, DocumentNo, 
				CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
				AccountGroupID, dbo.GetLookupDataDes(AccountGroupID) as AccountGroup, 
				EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,dbo.GetLookupDataDes(BranchID) as BranchName, 
				AmountTendered, ExchangeRate, Change, Notes, LoginID,
				dbo.FormatDate(dbo.GetShortDate(dbo.GetAccountsRecordDateTime(TranNo))) as RecordDate,
		        dbo.GetTime(dbo.GetAccountsRecordDateTime(TranNo)) as RecordTime,
				dbo.FormatMoney(dbo.GetAccountBalance(AccountBillModesID, AccountBillNo)) as Balance
				from Accounts
				where TranNo = @TranNo
			end
	end	
else if (@TranNo is null) and (@VisitsBranch is null) and (@LoginID is null) and not(@StartDateTime is null) and not(@EndDateTime is null) 
	begin
		select dbo.FormatText(TranNo, 'Accounts', 'TranNo') as TranNo, 
		dbo.GetLookupDataDes(AccountBillModesID) as AccountCategory, 
		dbo.FormatDate(TranDate) as TranDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		AccountBillNo, ClientFullName as AccountName,
		dbo.GetLookupDataDes(AccountActionID) as AccountAction, Amount,
		dbo.FormatMoney(dbo.GetAccountAmount(TranNo)) as AccountAmount, DocumentNo, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AccountGroupID, dbo.GetLookupDataDes(AccountGroupID) as AccountGroup,  
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
		dbo.GetLookupDataDes(BranchID) as BranchName, 
		AmountTendered, ExchangeRate, Change, Notes, LoginID,
		dbo.FormatDate(dbo.GetShortDate(dbo.GetAccountsRecordDateTime(TranNo))) as RecordDate,
		dbo.GetTime(dbo.GetAccountsRecordDateTime(TranNo)) as RecordTime,
		dbo.FormatMoney(dbo.GetAccountBalance(AccountBillModesID, AccountBillNo)) as Balance
		from Accounts
		where dbo.GetAccountsRecordDateTime(TranNo) between @StartDateTime and @EndDateTime
		order by TranDate, RecordDateTime
	end
else if (@TranNo is null) and (@VisitsBranch is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null)
	begin
		select dbo.FormatText(TranNo, 'Accounts', 'TranNo') as TranNo, 
		dbo.GetLookupDataDes(AccountBillModesID) as AccountCategory, 
		dbo.FormatDate(TranDate) as TranDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		AccountBillNo, ClientFullName as AccountName,
		dbo.GetLookupDataDes(AccountActionID) as AccountAction, Amount,
		dbo.FormatMoney(dbo.GetAccountAmount(TranNo)) as AccountAmount, DocumentNo, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AccountGroupID, dbo.GetLookupDataDes(AccountGroupID) as AccountGroup,   
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
		dbo.GetLookupDataDes(BranchID) as BranchName, 
		AmountTendered, ExchangeRate, Change, Notes, LoginID,
		dbo.FormatDate(dbo.GetShortDate(dbo.GetAccountsRecordDateTime(TranNo))) as RecordDate,
		dbo.GetTime(dbo.GetAccountsRecordDateTime(TranNo)) as RecordTime,
		dbo.FormatMoney(dbo.GetAccountBalance(AccountBillModesID, AccountBillNo)) as Balance
		from Accounts
		where dbo.GetAccountsRecordDateTime(TranNo) between @StartDateTime and @EndDateTime and LoginID = @LoginID
		order by TranDate, RecordDateTime
	end


else if (@TranNo is null) and not (@VisitsBranch is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null)
	begin
		select dbo.FormatText(TranNo, 'Accounts', 'TranNo') as TranNo, 
		dbo.GetLookupDataDes(AccountBillModesID) as AccountCategory, 
		dbo.FormatDate(TranDate) as TranDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		AccountBillNo, ClientFullName as AccountName,
		dbo.GetLookupDataDes(AccountActionID) as AccountAction, Amount,
		dbo.FormatMoney(dbo.GetAccountAmount(TranNo)) as AccountAmount, DocumentNo, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AccountGroupID, dbo.GetLookupDataDes(AccountGroupID) as AccountGroup,   
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
		dbo.GetLookupDataDes(BranchID) as BranchName, 
		AmountTendered, ExchangeRate, Change, Notes, LoginID,
		dbo.FormatDate(dbo.GetShortDate(dbo.GetAccountsRecordDateTime(TranNo))) as RecordDate,
		dbo.GetTime(dbo.GetAccountsRecordDateTime(TranNo)) as RecordTime,
		dbo.FormatMoney(dbo.GetAccountBalance(AccountBillModesID, AccountBillNo)) as Balance
		from Accounts
		where dbo.GetAccountsRecordDateTime(TranNo) between @StartDateTime and @EndDateTime and LoginID = @LoginID and BranchID =@VisitsBranch
		order by TranDate, RecordDateTime
	end

	else if (@TranNo is null)and (@LoginID is null) and not (@VisitsBranch is null) and not(@StartDateTime is null) and not(@EndDateTime is null) 
	begin
		select dbo.FormatText(TranNo, 'Accounts', 'TranNo') as TranNo, 
		dbo.GetLookupDataDes(AccountBillModesID) as AccountCategory, 
		dbo.FormatDate(TranDate) as TranDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		AccountBillNo, ClientFullName as AccountName,
		dbo.GetLookupDataDes(AccountActionID) as AccountAction, Amount,
		dbo.FormatMoney(dbo.GetAccountAmount(TranNo)) as AccountAmount, DocumentNo, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AccountGroupID, dbo.GetLookupDataDes(AccountGroupID) as AccountGroup,   
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
		dbo.GetLookupDataDes(BranchID) as BranchName, 
		AmountTendered, ExchangeRate, Change, Notes, LoginID,
		dbo.FormatDate(dbo.GetShortDate(dbo.GetAccountsRecordDateTime(TranNo))) as RecordDate, 
		dbo.GetTime(dbo.GetAccountsRecordDateTime(TranNo)) as RecordTime,
		dbo.FormatMoney(dbo.GetAccountBalance(AccountBillModesID, AccountBillNo)) as Balance
		from Accounts
		where dbo.GetAccountsRecordDateTime(TranNo) between @StartDateTime and @EndDateTime and BranchID =@VisitsBranch
		order by TranDate, RecordDateTime
	end

else 
	begin
		select dbo.FormatText(TranNo, 'Accounts', 'TranNo') as TranNo, 
		dbo.GetLookupDataDes(AccountBillModesID) as AccountCategory, 
		dbo.FormatDate(TranDate) as TranDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
		AccountBillNo, ClientFullName as AccountName,
		dbo.GetLookupDataDes(AccountActionID) as AccountAction, Amount,
		dbo.FormatMoney(dbo.GetAccountAmount(TranNo)) as AccountAmount, DocumentNo, 
		CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AccountGroupID, dbo.GetLookupDataDes(AccountGroupID) as AccountGroup,   
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
		dbo.GetLookupDataDes(BranchID) as BranchName, 
		AmountTendered, ExchangeRate, Change, Notes, LoginID,
		dbo.FormatDate(dbo.GetShortDate(dbo.GetAccountsRecordDateTime(TranNo))) as RecordDate,
		dbo.GetTime(dbo.GetAccountsRecordDateTime(TranNo)) as RecordTime,
		dbo.FormatMoney(dbo.GetAccountBalance(AccountBillModesID, AccountBillNo)) as Balance
		from Accounts
	end	
return 0
go

/******************************************************************************************************
exec uspGetAccounts '18018066'
exec uspGetAccounts null, '1 Oct 2018', '24 Oct 2018'
exec uspGetAccounts null, '27 May 2012', '24 Jun 2012', 'Admin'
exec uspGetAccounts 
******************************************************************************************************/
-- select * from Accounts

--------GetNextTranID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextTranID')
	drop proc uspGetNextTranID
go

create proc uspGetNextTranID(
@TranID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()), 2)
set @TranID = (select max(TranID) from Accounts where left(TranNo, 2) = @CurrentYear)
set @TranID = dbo.GetNextAutoNumber('Accounts', 'TranNo', @TranID)

return 0

go

-- exec uspGetNextTranID
-- select * from Accounts

--------Get Account-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAccountBalance')
	drop proc uspGetAccountBalance
go

create proc uspGetAccountBalance(
@AccountBillModesID varchar(10),
@AccountBillNo varchar(20),
@Balance money = null output
)with encryption as

declare @ErrorMSG varchar(200)

----------------------------------------------------------------------------------------------
begin set @Balance = dbo.GetAccountBalance(@AccountBillModesID, @AccountBillNo) end
----------------------------------------------------------------------------------------------

return 0

go
-- select * from Accounts 
-- exec GetAccountBalance 'ACC1234567'

----------------Get Account Opening Balance---------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAccountOpeningBalance')
	drop proc uspGetAccountOpeningBalance
go

create proc uspGetAccountOpeningBalance(
@AccountBillNo varchar(20),
@AccountBillModesID varchar(10),
@RecordDateTime smalldatetime,
@Balance money = null output
)with encryption as

declare @ErrorMSG varchar(200)

----------------------------------------------------------------------------------------------
begin set @Balance = dbo.GetAccountOpeningBalance(@AccountBillNo,@AccountBillModesID,@RecordDateTime) end
----------------------------------------------------------------------------------------------

return 0

go
----------------------------------------------------------------------------------------------



------------- DoctorVisits ---------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Doctor Visits ------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertDoctorVisits')
	drop proc uspInsertDoctorVisits
go

create proc uspInsertDoctorVisits(
@VisitNo varchar(20),
@StaffNo varchar(10),
@ServiceCode varchar(10) = null,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @Closed bit

-------------------------------------------------------------------------------------
set @Closed = 0
-------------------------------------------------------------------------------------

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered Visits'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if exists(select VisitNo from DoctorVisits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Staff No', @StaffNo, 'Staff')	
		return 1
	end

if not (@ServiceCode is null or @ServiceCode = '') 
	begin
		if not exists(select ServiceCode from Services where ServiceCode  = @ServiceCode)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Services')
				return 1
			end
	end
else if (@ServiceCode is null or @ServiceCode = '')
begin set @ServiceCode = null end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
begin
insert into DoctorVisits
(VisitNo, StaffNo, ServiceCode, Closed, LoginID,ClientMachine) 
values
(@VisitNo, @StaffNo, @ServiceCode, @Closed, @LoginID,@ClientMachine)
return 0
end
go

/*********************************************************************
--1-------------------------------------------------------------------
exec uspInsertDoctorVisits '1014000002', '100', null, 'Admin'
exec uspInsertDoctorVisits '1014000003', '304', '10C', 'Admin'

*********************************************************************/

-- select *  from DoctorVisits
-- delete from DoctorVisits

---------Update Doctor Visits ------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateDoctorVisits')
	drop proc uspUpdateDoctorVisits
go

create proc uspUpdateDoctorVisits(
@VisitNo varchar(20),
@StaffNo varchar(10) = null,
@Closed bit = null
)with encryption as 

declare @ErrorMSG varchar(200)

-------------------------------------------------------------------------------------
set @Closed = isnull(@Closed, 0)
-------------------------------------------------------------------------------------

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered Visits'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select VisitNo from DoctorVisits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to update does not exist'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not (@StaffNo is null or @StaffNo = '') 
	begin
		if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
				return 1
			end
			else
			begin
				update DoctorVisits set StaffNo = @StaffNo where VisitNo = @VisitNo
				return 0
			end
	end
else if (@Closed = 1)
begin
	update DoctorVisits set Closed = @Closed where VisitNo = @VisitNo
	return 0
end

go

/*********************************************************************
--1-------------------------------------------------------------------
exec uspUpdateDoctorVisits '1109125001', 'D001', null
exec uspUpdateDoctorVisits '1014000003', '304', null
exec uspUpdateDoctorVisits '1109080002', null, 1

*********************************************************************/

-- select *  from DoctorVisits where VisitNo = '1109080002'
-- delete from DoctorVisits

--------Count Doctor Visit -------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountDoctorVisit')
	drop proc uspCountDoctorVisit
go

create proc uspCountDoctorVisit(
@VisitNo varchar(20),
@NoDoctorVisit tinyint = null output
)with encryption as

set @NoDoctorVisit = (select  count(VisitNo) from DoctorVisits where VisitNo = @VisitNo)
set @NoDoctorVisit = isnull(@NoDoctorVisit, 0)

return 0

go

-- exec uspCountDoctorVisit '110001001'

--------GetDoctorVisit-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDoctorVisit')
	drop proc uspGetDoctorVisit
go

create proc uspGetDoctorVisit(
@VisitNo varchar(20),
@StaffFullName varchar(60) = null output,
@ServiceCode varchar(10) = null output,
@Closed bit = 0 output
)with encryption as

begin
	set @StaffFullName = (select dbo.GetStaffFullName(StaffNo) as StaffFullName						  
						  from DoctorVisits where VisitNo= @VisitNo)
	set @ServiceCode = (select ServiceCode from DoctorVisits where VisitNo= @VisitNo)
	set @Closed = (select Closed from DoctorVisits where VisitNo = @VisitNo)	
end

return 0

go

-- exec uspGetDoctorVisit '1100001001'
-- select * from DoctorVisits

------------------------------------------------------------------------------------------------------
------------- ClinicalFindings -----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Edit Clinical Findings ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditClinicalFindings')
	drop proc uspEditClinicalFindings
go

create proc uspEditClinicalFindings(
@VisitNo varchar(20),
@PresentingComplaint varchar(1000),
@ClinicalNotes varchar(4000),
@ROS varchar(1000),
@PMH varchar(1000),
@POH varchar(1000),
@PGH varchar(1000),
@FSH varchar(1000),
@GeneralAppearance varchar(1000),
@Respiratory varchar(1000),
@CVS varchar(1000),
@ENT varchar(1000),
@Abdomen varchar(1000),
@CNS varchar(1000),
@EYE varchar(1000),
@MuscularSkeletal varchar(1000),
@Skin varchar(1000),
@PV varchar(1000),
@PsychologicalStatus varchar(1000),
@ProvisionalDiagnosis varchar(1000),
@TreatmentPlan varchar(1000),
@ClinicalImage image = null,
@LoginID varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered Visits'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if exists(select VisitNo from ClinicalFindings where VisitNo = @VisitNo)
begin
		--set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter already exists'
		--raiserror(@ErrorMSG,16,1)	
		--return 1

	update ClinicalFindings set 		
	PresentingComplaint = @PresentingComplaint, ClinicalNotes = @ClinicalNotes, ROS = @ROS, 
	PMH = @PMH, POH = @POH, PGH = @PGH, FSH = @FSH, GeneralAppearance = @GeneralAppearance, 
	Respiratory = @Respiratory, CVS = @CVS, ENT = @ENT, Abdomen = @Abdomen, CNS = @CNS, 
	EYE = @EYE, MuscularSkeletal = @MuscularSkeletal, Skin = @Skin, PV = @PV, 
	PsychologicalStatus = @PsychologicalStatus, ProvisionalDiagnosis = @ProvisionalDiagnosis,	
	TreatmentPlan = @TreatmentPlan, ClinicalImage = @ClinicalImage, LoginID = @LoginID
	where VisitNo = @VisitNo
	return 0
end
else
begin
insert into ClinicalFindings
(VisitNo, PresentingComplaint, ClinicalNotes, ROS, PMH, POH, PGH, FSH, GeneralAppearance, 
Respiratory, CVS, ENT, Abdomen, CNS, EYE, MuscularSkeletal, Skin, PV, PsychologicalStatus, 
ProvisionalDiagnosis, TreatmentPlan, ClinicalImage, LoginID) 
values
(@VisitNo, @PresentingComplaint, @ClinicalNotes, @ROS, @PMH, @POH, @PGH, @FSH, @GeneralAppearance, 
@Respiratory, @CVS, @ENT, @Abdomen, @CNS, @EYE, @MuscularSkeletal, @Skin, @PV, @PsychologicalStatus, 
@ProvisionalDiagnosis, @TreatmentPlan, @ClinicalImage, @LoginID)
return 0
end
go

/******************************************************************************************
--1----------------------------------------------------------------------------------------
exec uspEditClinicalFindings '100001001', 'History1', 'Notes', 'Respiratory',
								'General Appearance1', 'CVS1', 'Abdomen1','CNS1', 
								'Muscular Skeletal1', 'Psychological Status1',
								'Clinical Diagnosis1', null, 'Admin'
******************************************************************************************/

-- select *  from ClinicalFindings
-- delete from ClinicalFindings

--------Get ClinicalFindings-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetClinicalFindings')
	drop proc uspGetClinicalFindings
go

create proc uspGetClinicalFindings(
@VisitNo varchar(20)
)with encryption as

begin
	select VisitNo, PresentingComplaint, ClinicalNotes, ROS, PMH, POH, PGH, FSH, GeneralAppearance, Respiratory, CVS, ENT, 
	Abdomen, CNS, EYE, MuscularSkeletal, Skin, PV, PsychologicalStatus, ProvisionalDiagnosis, TreatmentPlan, ClinicalImage
 	from ClinicalFindings 
 	where VisitNo = @VisitNo	
end

return 0

go

-- select * from ClinicalFindings
-- exec uspGetClinicalFindings '100001001'

------------------------------------------------------------------------------------------------------
-------------- EyeAssessment -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditEyeAssessment')
	drop proc uspEditEyeAssessment
go
create proc uspEditEyeAssessment(
@VisitNo varchar(20),
@LeftPupil varchar(200),
@RightPupil varchar(200),
@LeftLidMargin varchar(200),
@RightLidMargin varchar(200),
@LeftConjuctiva varchar(200),
@RightConjuctiva varchar(200),
@LeftBulbarConjuctiva varchar(200),
@RightBulbarConjuctiva varchar(200),
@LeftCentralCornea varchar(200),
@RightCentralCornea varchar(200),
@LeftVerticalCornea varchar(200),
@RightVerticalCornea varchar(200),
@LeftAnteriorChamber varchar(200),
@RightAnteriorChamber varchar(200),
@LeftIrish varchar(200),
@RightIrish varchar(200),
@LeftAnteriorChamberAngle varchar(200),
@RightAnteriorChamberAngle varchar(200),
@LeftRetina varchar(200),
@RightRetina varchar(200),
@LeftMacular varchar(200),
@RightMacular varchar(200),
@LeftOpticDisc varchar(200),
@RightOpticDisc varchar(200),
@LeftIOP varchar(10),
@RightIOP varchar(10),
@LeftVitreous varchar(200),
@RightVitreous varchar(200),
@LeftLense varchar(200),
@RightLense varchar(200),
@EyeNotes varchar(200),
@LeftEyeBall varchar(200),
@RightEyeBall varchar(200),
@LeftOrbit varchar(200),
@RightOrbit varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
	
------------------------------------------------------------------------------------
if exists(select VisitNo from EyeAssessment where VisitNo = @VisitNo)
begin
update EyeAssessment set
 LeftPupil = @LeftPupil, RightPupil = @RightPupil, LeftLidMargin = @LeftLidMargin,
 RightLidMargin = @RightLidMargin, LeftConjuctiva = @LeftConjuctiva, RightConjuctiva = @RightConjuctiva, 
 LeftBulbarConjuctiva = @LeftBulbarConjuctiva, RightBulbarConjuctiva = @RightBulbarConjuctiva, 
 LeftCentralCornea = @LeftCentralCornea, RightCentralCornea = @RightCentralCornea, 
 LeftVerticalCornea = @LeftVerticalCornea, RightVerticalCornea = @RightVerticalCornea, 
 LeftAnteriorChamber = @LeftAnteriorChamber, RightAnteriorChamber = @RightAnteriorChamber, 
 LeftIrish = @LeftIrish, RightIrish = @RightIrish, LeftAnteriorChamberAngle = @LeftAnteriorChamberAngle,
 RightAnteriorChamberAngle = @RightAnteriorChamberAngle, LeftRetina = @LeftRetina, RightRetina = @RightRetina,
 LeftMacular = @LeftMacular, RightMacular = @RightMacular, LeftOpticDisc = @LeftOpticDisc, 
 RightOpticDisc = @RightOpticDisc, LeftIOP = @LeftIOP, RightIOP = @RightIOP, LeftVitreous = @LeftVitreous,
 RightVitreous = @RightVitreous, LeftLense = @LeftLense, RightLense = @RightLense, EyeNotes = @EyeNotes,
 LeftEyeBall = @LeftEyeBall, RightEyeBall = @RightEyeBall, LeftOrbit = @LeftOrbit, 
 RightOrbit = @RightOrbit, LoginID = @LoginID
where VisitNo = @VisitNo
return 0
end
else
begin
insert into EyeAssessment
(VisitNo, LeftPupil, RightPupil, LeftLidMargin, RightLidMargin, LeftConjuctiva, RightConjuctiva, 
 LeftBulbarConjuctiva, RightBulbarConjuctiva, LeftCentralCornea, RightCentralCornea, LeftVerticalCornea, 
 RightVerticalCornea, LeftAnteriorChamber, RightAnteriorChamber, LeftIrish, RightIrish, 
 LeftAnteriorChamberAngle, RightAnteriorChamberAngle, LeftRetina, RightRetina, LeftMacular,
 RightMacular, LeftOpticDisc, RightOpticDisc, LeftIOP, RightIOP, LeftVitreous, RightVitreous, 
 LeftLense, RightLense, EyeNotes, LeftEyeBall, RightEyeBall, LeftOrbit, RightOrbit, LoginID)
values
(@VisitNo, @LeftPupil, @RightPupil, @LeftLidMargin, @RightLidMargin, @LeftConjuctiva,
 @RightConjuctiva, @LeftBulbarConjuctiva, @RightBulbarConjuctiva, @LeftCentralCornea, @RightCentralCornea,
 @LeftVerticalCornea, @RightVerticalCornea, @LeftAnteriorChamber, @RightAnteriorChamber, @LeftIrish, @RightIrish,
 @LeftAnteriorChamberAngle, @RightAnteriorChamberAngle, @LeftRetina, @RightRetina, @LeftMacular, @RightMacular,
 @LeftOpticDisc, @RightOpticDisc, @LeftIOP, @RightIOP, @LeftVitreous, @RightVitreous, @LeftLense, @RightLense, 
 @EyeNotes, @LeftEyeBall, @RightEyeBall, @LeftOrbit, @RightOrbit, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspEditEyeAssessment 140035
******************************************************************************************************/

-- select * from EyeAssessment
-- delete from EyeAssessment

-------------- Get EyeAssessment ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetEyeAssessment')
	drop proc uspGetEyeAssessment
go

create proc uspGetEyeAssessment(
@VisitNo varchar(20)
)with encryption as

begin
select VisitNo, LeftPupil, RightPupil, LeftLidMargin, RightLidMargin, LeftConjuctiva, RightConjuctiva, 
LeftBulbarConjuctiva, RightBulbarConjuctiva, LeftCentralCornea, RightCentralCornea, LeftVerticalCornea,
 RightVerticalCornea, LeftAnteriorChamber, RightAnteriorChamber, LeftIrish, RightIrish, LeftAnteriorChamberAngle, 
 RightAnteriorChamberAngle, LeftRetina, RightRetina, LeftMacular, RightMacular, LeftOpticDisc, RightOpticDisc, 
 LeftIOP, RightIOP, LeftVitreous, RightVitreous, LeftLense, RightLense, EyeNotes, LeftEyeBall, RightEyeBall, 
 ClientMachine, RecordDateTime, LeftOrbit, RightOrbit, EyeAssessment.LoginID
from EyeAssessment where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetEyeAssessment 47477
******************************************************************************************************/
-- select * from EyeAssessment
-- delete from EyeAssessment

------------------------------------------------------------------------------------------------------
-------------- Orthoptics --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Orthoptics -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditOrthoptics')
	drop proc uspEditOrthoptics
go

create proc uspEditOrthoptics(
@VisitNo varchar(20),
@HeadPosture varchar(200),
@Fixation varchar(200),
@LeftHirschberg varchar(200),
@RightHirschberg varchar(200),
@RightEOM varchar(200),
@LeftEOM varchar(200),
@CoverTestID varchar(10),
@LeftAPCTGlasses varchar(200),
@RightAPCTGlasses varchar(200),
@LeftAPCTWithOutGlasses varchar(200),
@RightAPCTWithOutGlasses varchar(200),
@Correspondence varchar(200),
@PrismAdaptation varchar(200),
@FusionConvergence varchar(200),
@FusionDivergence varchar(200),
@FusionRange varchar(200),
@NearPointOfAccommodation varchar(200),
@NearPointOfConvergence varchar(200),
@OrthopticsNotes varchar(400),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @CoverTestID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CoverTestID', @CoverTestID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
------------------------------------------------------------------------------------
if exists(select VisitNo from Orthoptics where VisitNo = @VisitNo)
begin
update Orthoptics set
HeadPosture = @HeadPosture, Fixation = @Fixation, LeftHirschberg = @LeftHirschberg, 
RightHirschberg = @RightHirschberg, RightEOM = @RightEOM, LeftEOM = @LeftEOM, CoverTestID = @CoverTestID,
 LeftAPCTGlasses = @LeftAPCTGlasses, RightAPCTGlasses = @RightAPCTGlasses, LeftAPCTWithOutGlasses = @LeftAPCTWithOutGlasses,
  RightAPCTWithOutGlasses = @RightAPCTWithOutGlasses, Correspondence = @Correspondence, 
  PrismAdaptation = @PrismAdaptation, FusionConvergence = @FusionConvergence, FusionDivergence = @FusionDivergence,
   FusionRange = @FusionRange, NearPointOfAccommodation = @NearPointOfAccommodation, 
   NearPointOfConvergence = @NearPointOfConvergence, OrthopticsNotes = @OrthopticsNotes,
    LoginID = @LoginID
where VisitNo = @VisitNo
return 0
end
else
begin
insert into Orthoptics
(VisitNo, HeadPosture, Fixation, LeftHirschberg, RightHirschberg, RightEOM, LeftEOM, CoverTestID, 
LeftAPCTGlasses, RightAPCTGlasses, LeftAPCTWithOutGlasses, RightAPCTWithOutGlasses, Correspondence, 
PrismAdaptation, FusionConvergence, FusionDivergence, FusionRange, NearPointOfAccommodation, NearPointOfConvergence, 
OrthopticsNotes, LoginID)
values

(@VisitNo, @HeadPosture, @Fixation, @LeftHirschberg, @RightHirschberg, @RightEOM, @LeftEOM, @CoverTestID,
 @LeftAPCTGlasses, @RightAPCTGlasses, @LeftAPCTWithOutGlasses, @RightAPCTWithOutGlasses, @Correspondence,
  @PrismAdaptation, @FusionConvergence, @FusionDivergence, @FusionRange, @NearPointOfAccommodation, 
  @NearPointOfConvergence, @OrthopticsNotes, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspEditOrthoptics
******************************************************************************************************/
-- select * from Orthoptics
-- delete from Orthoptics

-------------- Get Orthoptics -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetOrthoptics')
	drop proc uspGetOrthoptics
go

create proc uspGetOrthoptics(
@VisitNo varchar(20)
)with encryption as

begin
	select VisitNo, HeadPosture, Fixation, LeftHirschberg, RightHirschberg, RightEOM, LeftEOM, 
	CoverTestID, dbo.GetLookupDataDes(CoverTestID) as CoverTestID, LeftAPCTGlasses, RightAPCTGlasses, 
	LeftAPCTWithOutGlasses, RightAPCTWithOutGlasses, Correspondence, PrismAdaptation, FusionConvergence, 
	FusionDivergence, FusionRange, NearPointOfAccommodation, NearPointOfConvergence, OrthopticsNotes, 
	Orthoptics.LoginID, ClientMachine, RecordDateTime
	from Orthoptics

	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetOrthoptics
******************************************************************************************************/
-- select * from Orthoptics
-- delete from Orthoptics


------------------------------------------------------------------------------------------------------
-------------- LowVision --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------


-------------- Insert LowVision -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditLowVision')
	drop proc uspEditLowVision
go

create proc uspEditLowVision(
@VisitNo varchar(20),
@BriefHistory varchar(200),
@Profession varchar(200),
@MajorOcularDiagnosisRE varchar(200),
@MajorOcularDiagnosisLE varchar(200),
@OtherOcularDiagnosisRE varchar(200),
@OtherOcularDiagnosisLE varchar(200),
@OphthalmologistSeenID varchar(10),
@OtherImpairmentsID varchar(200),
@OtherImpairments varchar(200),
@ExistingTreatmentFarRE varchar(200),
@ExistingTreatmentFarLE varchar(200),
@ExistingTreatmentNearRE varchar(200),
@ExistingTreatmentNearLE varchar(200),
@NewTreatmentFarRE varchar(200),
@NewTreatmentFarLE varchar(200),
@NewTreatmentNearRE varchar(200),
@NewTreatmentNearLE varchar(200),
@ExistingVisualAcuityFarLEID varchar(200),
@ExistingVisualAcuityFarREID varchar(200),
@ExistingVisualAcuityNearLEID varchar(200),
@ExistingVisualAcuityNearREID varchar(200),
@NewVisualAcuityFarLEID varchar(200),
@NewVisualAcuityFarREID varchar(200),
@NewVisualAcuityNearLEID varchar(200),
@NewVisualAcuityNearREID varchar(200),
@ExistingLVDsNear varchar(200),
@ExistingLVDsFar varchar(200),
@ProblemEncounteredLVDsNear varchar(200),
@ProblemEncounteredLVDsFar varchar(200),
@ColourVisionDefectID varchar(10),
@ColourVisionTestUsed varchar(200),
@ContrastSensitivityID varchar(10),
@ContrastSensitivityTestUsed varchar(200),
@VisualFieldDefectID varchar(10),
@VisualFieldDefectTestUsed varchar(200),
@LowVisionDevicesFar varchar(200),
@LowVisionDevicesNear varchar(200),
@NonOpticalAids varchar(200),
@Advice varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OphthalmologistSeenID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'OphthalmologistSeenID', @OphthalmologistSeenID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OtherImpairmentsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'OtherImpairmentsID', @OtherImpairmentsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ExistingVisualAcuityFarLEID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ExistingVisualAcuityFarLEID', @ExistingVisualAcuityFarLEID, 'Lookup Data')
		return 1
	end
if not exists(select DataID from LookupData where DataID = @ExistingVisualAcuityFarREID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ExistingVisualAcuityFarREID', @ExistingVisualAcuityFarREID, 'Lookup Data')
		return 1
	end
if not exists(select DataID from LookupData where DataID = @ExistingVisualAcuityNearLEID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ExistingVisualAcuityNearLEID', @ExistingVisualAcuityNearLEID, 'Lookup Data')
		return 1
	end
if not exists(select DataID from LookupData where DataID = @ExistingVisualAcuityNearREID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ExistingVisualAcuityNearREID', @ExistingVisualAcuityNearREID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @NewVisualAcuityFarLEID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'NewVisualAcuityFarLEID', @NewVisualAcuityFarLEID, 'Lookup Data')
		return 1
	end
if not exists(select DataID from LookupData where DataID = @NewVisualAcuityFarREID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'NewVisualAcuityFarREID', @NewVisualAcuityFarREID, 'Lookup Data')
		return 1
	end
if not exists(select DataID from LookupData where DataID = @NewVisualAcuityNearLEID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'NewVisualAcuityNearLEID', @NewVisualAcuityNearLEID, 'Lookup Data')
		return 1
	end
if not exists(select DataID from LookupData where DataID = @NewVisualAcuityNearREID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'NewVisualAcuityNearREID', @NewVisualAcuityNearREID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ColourVisionDefectID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ColourVisionDefectID', @ColourVisionDefectID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ContrastSensitivityID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ContrastSensitivityID', @ContrastSensitivityID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisualFieldDefectID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisualFieldDefectID', @VisualFieldDefectID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

if exists(select VisitNo from LowVision where VisitNo = @VisitNo)
	begin

update LowVision set
BriefHistory = @BriefHistory, Profession = @Profession, MajorOcularDiagnosisRE = @MajorOcularDiagnosisRE,
 MajorOcularDiagnosisLE = @MajorOcularDiagnosisLE, OtherOcularDiagnosisRE = @OtherOcularDiagnosisRE, 
 OtherOcularDiagnosisLE = @OtherOcularDiagnosisLE, OphthalmologistSeenID = @OphthalmologistSeenID,
  OtherImpairmentsID= @OtherImpairmentsID, OtherImpairments = @OtherImpairments, 
  ExistingTreatmentFarRE = @ExistingTreatmentFarRE, ExistingTreatmentFarLE = @ExistingTreatmentfarLE,
  ExistingTreatmentNearRE = @ExistingTreatmentNearRE, ExistingTreatmentNearLE = @ExistingTreatmentNearLE,
  NewTreatmentFarRE = @NewTreatmentFarRE, NewTreatmentFarLE = @NewTreatmentfarLE,
  NewTreatmentNearRE = @NewTreatmentNearRE, NewTreatmentNearLE = @NewTreatmentNearLE, 
  ExistingLVDsNear = @ExistingLVDsNear,ExistingLVDsFar = @ExistingLVDsFar, ProblemEncounteredLVDsNear = @ProblemEncounteredLVDsNear, ProblemEncounteredLVDsFar = @ProblemEncounteredLVDsFar,
    ColourVisionDefectID = @ColourVisionDefectID, 
	 ColourVisionTestUsed = @ColourVisionTestUsed, 
	ContrastSensitivityID = @ContrastSensitivityID, ContrastSensitivityTestUsed = @ContrastSensitivityTestUsed, VisualFieldDefectID = @VisualFieldDefectID, 
     VisualFieldDefectTestUsed = @VisualFieldDefectTestUsed,LowVisionDevicesFar = @LowVisionDevicesFar, LowVisionDevicesNear = @LowVisionDevicesNear, 
	 NonOpticalAids = @NonOpticalAids,  Advice = @Advice, 
	 LoginID = @LoginID, ClientMachine = @ClientMachine
where VisitNo = @VisitNo
return 0
end
else
begin
insert into LowVision
(VisitNo, BriefHistory, Profession, MajorOcularDiagnosisRE, MajorOcularDiagnosisLE,
 OtherOcularDiagnosisRE, OtherOcularDiagnosisLE, OphthalmologistSeenID,
 OtherImpairmentsID, OtherImpairments,
 ExistingTreatmentFarRE,ExistingTreatmentFarLE,ExistingTreatmentNearRE,ExistingTreatmentNearLE,
 NewTreatmentFarRE,NewTreatmentFarLE,NewTreatmentNearRE,NewTreatmentNearLE,
ExistingVisualAcuityFarLEID,ExistingVisualAcuityFarREID,ExistingVisualAcuityNearLEID,ExistingVisualAcuityNearREID,
NewVisualAcuityFarLEID,NewVisualAcuityFarREID,NewVisualAcuityNearLEID,NewVisualAcuityNearREID,
ExistingLVDsNear, ExistingLVDsFar,ProblemEncounteredLVDsNear, ProblemEncounteredLVDsFar,
 ColourVisionDefectID, ColourVisionTestUsed, ContrastSensitivityID,
	  ContrastSensitivityTestUsed, VisualFieldDefectID, VisualFieldDefectTestUsed, 
	  LowVisionDevicesFar, LowVisionDevicesNear, NonOpticalAids, Advice, LoginID, ClientMachine)
values
(@VisitNo, @BriefHistory, @Profession, @MajorOcularDiagnosisRE, @MajorOcularDiagnosisLE, 
@OtherOcularDiagnosisRE, @OtherOcularDiagnosisLE, @OphthalmologistSeenID, @OtherImpairmentsID,@OtherImpairments, 
 @ExistingTreatmentFarRE,@ExistingTreatmentFarLE,@ExistingTreatmentNearRE,@ExistingTreatmentNearLE,
@NewTreatmentFarRE,@NewTreatmentFarLE,@NewTreatmentNearRE,@NewTreatmentNearLE,
@ExistingVisualAcuityFarLEID,@ExistingVisualAcuityFarREID,@ExistingVisualAcuityNearLEID,@ExistingVisualAcuityNearREID,
@NewVisualAcuityFarLEID,@NewVisualAcuityFarREID,@NewVisualAcuityNearLEID,@NewVisualAcuityNearREID,
  @ExistingLVDsNear, @ExistingLVDsFar,@ProblemEncounteredLVDsNear,@ProblemEncounteredLVDsFar,
   @ColourVisionDefectID, @ColourVisionTestUsed, @ContrastSensitivityID, @ContrastSensitivityTestUsed,
	 @VisualFieldDefectID,  @VisualFieldDefectTestUsed, @LowVisionDevicesFar,
	  @LowVisionDevicesNear, @NonOpticalAids, @Advice, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertLowVision
******************************************************************************************************/
-- select * from LowVision
-- delete from LowVision

-------------- Get LowVision -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLowVision')
	drop proc uspGetLowVision
go

create proc uspGetLowVision(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
begin
	select VisitNo, BriefHistory, Profession, MajorOcularDiagnosisRE, MajorOcularDiagnosisLE, 
	OtherOcularDiagnosisRE, OtherOcularDiagnosisLE, OphthalmologistSeenID, 
	dbo.GetLookupDataDes(OphthalmologistSeenID) as [OphthalmologistSeenID],OtherImpairmentsID,dbo.GetLookupDataDes(OtherImpairmentsID) as [OtherImpairmentsID], 
	OtherImpairments,ExistingTreatmentFarRE,ExistingTreatmentFarLE,ExistingTreatmentNearRE,ExistingTreatmentNearLE,
     NewTreatmentFarRE,NewTreatmentFarLE,NewTreatmentNearRE,NewTreatmentNearLE,
     ExistingVisualAcuityFarLEID,dbo.GetLookupDataDes(ExistingVisualAcuityFarLEID) as [ExistingVisualAcuityFarLEID] ,ExistingVisualAcuityFarREID,dbo.GetLookupDataDes(ExistingVisualAcuityFarREID) as [ExistingVisualAcuityFarREID],
	 ExistingVisualAcuityNearLEID,dbo.GetLookupDataDes(ExistingVisualAcuityNearLEID) as [ExistingVisualAcuityNearLEID],ExistingVisualAcuityNearREID, dbo.GetLookupDataDes(ExistingVisualAcuityNearREID) as [ExistingVisualAcuityNearREID],
     NewVisualAcuityFarLEID,dbo.GetLookupDataDes(NewVisualAcuityFarLEID) as [NewVisualAcuityFarLEID],NewVisualAcuityFarREID,dbo.GetLookupDataDes(NewVisualAcuityFarREID) as [NewVisualAcuityFarREID],
	 NewVisualAcuityNearLEID,dbo.GetLookupDataDes(NewVisualAcuityNearLEID) as [NewVisualAcuityNearLEID],NewVisualAcuityNearREID,dbo.GetLookupDataDes(NewVisualAcuityNearREID) as [NewVisualAcuityNearREID],
	 dbo.GetLookupDataName(ExistingLVDsNear) as [ExistingLVDsNear],dbo.GetLookupDataName(ExistingLVDsFar) as [ExistingLVDsFar],
	 ProblemEncounteredLVDsNear,ProblemEncounteredLVDsFar, ColourVisionDefectID, dbo.GetLookupDataDes(ColourVisionDefectID) as [ColourVisionDefectID], 
	ColourVisionTestUsed, ContrastSensitivityID,dbo.GetLookupDataDes(ContrastSensitivityID) as [ContrastSensitivityID], ContrastSensitivityTestUsed, VisualFieldDefectID, dbo.GetLookupDataDes(VisualFieldDefectID) as [VisualFieldDefectID],
   VisualFieldDefectTestUsed,dbo.GetLookupDataName(LowVisionDevicesFar) as [LowVisionDevicesFar], dbo.GetLookupDataName(LowVisionDevicesNear) as [LowVisionDevicesNear], 
  dbo.GetLookupDataName(NonOpticalAids) as [NonOpticalAids],  Advice, LowVision.LoginID, ClientMachine, RecordDateTime
	from LowVision
	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetLowVision
******************************************************************************************************/
-- select * from LowVision
-- delete from LowVision



------------------------------------------------------------------------------------------------------
-------------- Optical -------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit Optical --------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditOptical')
	drop proc uspEditOptical
go

create proc uspEditOptical(
@VisitNo varchar(20),
@RightSPH varchar(200),
@RightCYL varchar(200),
@RightAXIS varchar(200),
@RightPRISM varchar(200),
@RightADD varchar(200),
@LeftSPH varchar(200),
@LeftCYL varchar(200),
@LeftAXIS varchar(200),
@LeftPRISM varchar(200),
@LeftADD varchar(200),
@LenseTypeID varchar(10),
@Pd smallint,
@Sg smallint,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered Visits'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LenseTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lense Type ID', @LenseTypeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end
	
------------------------------------------------------------------------------------
if @Pd < 0 set @Pd = null
if @Sg < 0 set @Sg = null
------------------------------------------------------------------------------------

if exists(select VisitNo from Optical where VisitNo = @VisitNo)
	begin
		update Optical set
		RightSPH = @RightSPH, RightCYL = @RightCYL, RightAXIS = @RightAXIS, RightPRISM = @RightPRISM, 
		RightADD = @RightADD, LeftSPH = @LeftSPH, LeftCYL = @LeftCYL, LeftAXIS = @LeftAXIS, LeftPRISM = @LeftPRISM, 
		LeftADD = @LeftADD, LenseTypeID = @LenseTypeID, Pd = @Pd, Sg = @Sg, LoginID = @LoginID
		where VisitNo = @VisitNo
		return 0
	end
else
begin
insert into Optical
(VisitNo, RightSPH, RightCYL, RightAXIS, RightPRISM, RightADD, LeftSPH, 
LeftCYL, LeftAXIS, LeftPRISM, LeftADD, LenseTypeID, Pd, Sg, LoginID)
values
(@VisitNo, @RightSPH, @RightCYL, @RightAXIS, @RightPRISM, @RightADD, @LeftSPH, 
@LeftCYL, @LeftAXIS, @LeftPRISM, @LeftADD, @LenseTypeID, @Pd, @Sg, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspEditOptical '1300301001', 'Right SPH', 'Right CYL', 'Right AXIS', 'Right PRISM', 'Right ADD', 
					'Left SPH', 'Left CYL', 'Left AXIS', 'Left PRISM', 'Left ADD', '11201', 'Admin'

******************************************************************************************************/
-- select * from Optical
-- delete from Optical

-------------- Get Optical --------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetOptical')
	drop proc uspGetOptical
go

create proc uspGetOptical(
@VisitNo varchar(20)
)with encryption as

begin
	select VisitNo, RightSPH, RightCYL, RightAXIS, RightPRISM, RightADD, LeftSPH, LeftCYL, LeftAXIS, 
	LeftPRISM, LeftADD, LenseTypeID, dbo.GetLookupDataDes(LenseTypeID) as LenseType, Pd, Sg
	from Optical
	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetOptical '1300301001'

******************************************************************************************************/
-- select * from Optical
-- delete from Optical

------------------------------------------------------------------------------------------------------
-------------- Referrals -----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Referrals ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertReferrals')
	drop proc uspInsertReferrals
go

create proc uspInsertReferrals(
@VisitNo varchar(20),
@ReferralDate smalldatetime,
@ReferredBy varchar(10),
@DoctorSpecialtyID varchar(10),
@ReferredTo varchar(10) = null,
@ReferralNotes varchar(4000),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select VisitNo from Referrals where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG,16, 1, 'Visit No', @VisitNo)	
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @ReferredBy)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Referred By', @ReferredBy, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DoctorSpecialtyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Doctor Specialty ID', @DoctorSpecialtyID, 'Lookup Data')
		return 1
	end

if not (@ReferredTo is null or @ReferredTo = '') 
	begin
		if not exists(select StaffNo from Staff where StaffNo  = @ReferredTo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Staff No', @ReferredTo, 'Staff')
				return 1
			end
	end
else if (@ReferredTo is null or @ReferredTo = '')
begin set @ReferredTo = null end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end
else
begin
	insert into Referrals
	(VisitNo, ReferralDate, ReferredBy, DoctorSpecialtyID, ReferredTo, ReferralNotes, LoginID)
	values
	(@VisitNo, @ReferralDate, @ReferredBy, @DoctorSpecialtyID, @ReferredTo, @ReferralNotes, @LoginID)
	return 0
end
go

/******************************************************************************************************
exec uspInsertReferrals '1011009004', '20 Dec 2010', '304', '100', 'Complex', 'Admin'
exec uspInsertReferrals '1014000001', '20 Dec 2010', '100', '304', 'Complex Too', 'Admin'

******************************************************************************************************/
-- select * from Referrals
-- delete from Referrals

-------------- Get Referrals -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetReferrals')
	drop proc uspGetReferrals
go

create proc uspGetReferrals(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select VisitNo, ReferralDate, ReferredBy, dbo.GetStaffFullName(ReferredBy) as ReferredByFullName, 
	DoctorSpecialtyID, dbo.GetLookupDataDes(DoctorSpecialtyID) as DoctorSpecialty,
	ReferredTo, dbo.GetStaffFullName(ReferredTo) as ReferredToFullName, ReferralNotes
	from Referrals
	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetReferrals '1011009004'

******************************************************************************************************/
-- select * from Referrals
-- delete from Referrals

if exists (select * from sysobjects where name = 'uspInsertExternalReferrals')
	drop proc uspInsertExternalReferrals
go

create proc uspInsertExternalReferrals(
@VisitNo varchar(20),
@ProcedurePaidBy varchar(200),
@EmployeeName varchar(200),
@ReferredTo varchar(200),
@DepartureTime varchar(8),
@DateOfReferral smalldatetime,
@HistoryAndSymptoms varchar(2000),
@Diagnosis varchar (2000),
@TreatmentGiven varchar(2000),
@ReasonForReferral varchar(2000),
@LabInvestigations varchar(2000),
@StaffNo varchar(10),
@AuthorisedBy varchar(200),
@TreatmentLimit money,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if exists(select VisitNo from ExternalReferrals where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo)
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Name Of Clinician', @StaffNo, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into ExternalReferrals
(VisitNo, ProcedurePaidBy, EmployeeName, ReferredTo, DepartureTime, DateOfReferral,
 HistoryAndSymptoms,Diagnosis, TreatmentGiven, ReasonForReferral,LabInvestigations,StaffNo, AuthorisedBy, 
 TreatmentLimit, LoginID)
values
(@VisitNo, @ProcedurePaidBy, @EmployeeName, @ReferredTo, @DepartureTime,
 @DateOfReferral, @HistoryAndSymptoms,@Diagnosis, @TreatmentGiven, @ReasonForReferral,
 @LabInvestigations, @StaffNo, @AuthorisedBy, @TreatmentLimit, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertExternalReferrals
******************************************************************************************************/
-- select * from ExternalReferrals
-- delete from ExternalReferrals


-------------- Update ExternalReferrals -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateExternalReferrals')
	drop proc uspUpdateExternalReferrals
go

create proc uspUpdateExternalReferrals(
@VisitNo varchar(20),
@ProcedurePaidBy varchar(200),
@EmployeeName varchar(200),
@ReferredTo varchar(200),
@DepartureTime varchar(8),
@DateOfReferral smalldatetime,
@HistoryAndSymptoms varchar(2000),
@Diagnosis varchar (2000),
@TreatmentGiven varchar(2000),
@ReasonForReferral varchar(2000),
@LabInvestigations varchar(2000),
@StaffNo varchar(10),
@AuthorisedBy varchar(200),
@TreatmentLimit money,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from ExternalReferrals where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'ExternalReferrals')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Name Of Clinician', @StaffNo, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update ExternalReferrals set
ProcedurePaidBy = @ProcedurePaidBy, EmployeeName = @EmployeeName, 
ReferredTo = @ReferredTo, DepartureTime = @DepartureTime, DateOfReferral = @DateOfReferral, 
HistoryAndSymptoms = @HistoryAndSymptoms, Diagnosis = @Diagnosis,TreatmentGiven = @TreatmentGiven,
LabInvestigations=@LabInvestigations, 
ReasonForReferral = @ReasonForReferral, StaffNo = @StaffNo, AuthorisedBy = @AuthorisedBy, 
TreatmentLimit = @TreatmentLimit, LoginID = @LoginID
where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateExternalReferrals
******************************************************************************************************/
-- select * from ExternalReferrals
-- delete from ExternalReferrals


-------------- Get ExternalReferrals -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExternalReferrals')
	drop proc uspGetExternalReferrals
go

create proc uspGetExternalReferrals(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from ExternalReferrals where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'ExternalReferrals')
		return 1
	end
else
begin
	select VisitNo, ProcedurePaidBy, EmployeeName, ReferredTo, DepartureTime, DateOfReferral, HistoryAndSymptoms,Diagnosis,
	LabInvestigations,
	 TreatmentGiven, ReasonForReferral, ExternalReferrals.StaffNo,dbo.GetStaffFullName(ExternalReferrals.StaffNo) as StaffFullName, AuthorisedBy, TreatmentLimit,
	  ExternalReferrals.LoginID, ExternalReferrals.ClientMachine, ExternalReferrals.RecordDateTime
	from ExternalReferrals
	inner join Staff on ExternalReferrals.StaffNo = Staff.StaffNo	

	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetExternalReferrals
******************************************************************************************************/
-- select * from ExternalReferrals
-- delete from ExternalReferrals

------------------------------------------------------------------------------------------------------
------------- LabTests -------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert LabTests------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertLabTests')
	drop proc uspInsertLabTests
go

create proc uspInsertLabTests(
@TestCode varchar(20) ,
@TestName varchar(100) ,
@SpecimenTypeID varchar(10),
@LabsID varchar(10) ,
@NormalRange varchar(800),
@UnitMeasureID varchar(10),
@UnitCost money,
@VATPercentage decimal,
@TestFee money,
@ResultDataTypeID varchar(10),
@Hidden bit = null,
@RequiresResultsApproval bit =null,
@TubeType varchar(200),
@TestDescription varchar(500),
@LoginID varchar(20) = null,
@ClientMachine varchar(40) = null
)with encryption as 

declare @ErrorMSG varchar(200)
declare @TestID Int
declare @TestCodePrefix varchar(1)

if exists(select TestCode from LabTests where TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The Test Code: ' + @TestCode + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @SpecimenTypeID)
	begin
		set @ErrorMSG = 'The Specimen Type ID: ' + @SpecimenTypeID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LabsID)
	begin
		set @ErrorMSG = 'The Labs ID: ' + @LabsID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @UnitMeasureID)
	begin
		set @ErrorMSG = 'The Unit Measure ID: ' + @UnitMeasureID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ResultDataTypeID)
	begin
		set @ErrorMSG = 'The Result Data Type ID: ' + @ResultDataTypeID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not (@LoginID is null or @LoginID = '') 
	begin
		if not exists(select LoginID from Logins where LoginID  = @LoginID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
				return 1
			end
	end
else if (@LoginID is null or @LoginID = '') begin set @LoginID = null end

begin

----------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
set @RequiresResultsApproval = isnull(@RequiresResultsApproval,0)
if (@ClientMachine is null or @ClientMachine = '') begin set @ClientMachine = host_name() end
----------------------------------------------------------------------------------------------
	set @TestCodePrefix = dbo.GetOptionValue('TestCodePrefix')
	set @TestID = (select max(TestID) from LabTests where left(TestCode, len(@TestCodePrefix)) = @TestCodePrefix)
	set @TestID = dbo.GetNextAutoNumber('LabTests', 'TestCode', @TestID)

insert into LabTests
(TestID, TestCode, TestName, SpecimenTypeID, LabsID, NormalRange, UnitMeasureID, 
UnitCost,VATPercentage, TestFee, ResultDataTypeID, Hidden,RequiresResultsApproval,TubeType,TestDescription, LoginID, ClientMachine) 
values
(@TestID, @TestCode, @TestName, @SpecimenTypeID, @LabsID, @NormalRange, @UnitMeasureID, 
@UnitCost,@VATPercentage, @TestFee, @ResultDataTypeID, @Hidden,@RequiresResultsApproval,@TubeType,@TestDescription,@LoginID, @ClientMachine)

return 0
end
go


/*********************************************************************
--1-------------------------------------------------------------------
exec uspInsertLabTests 'CD4T1', 'CD4', '14BLD', '5I', '400-1600', '8MM3', 0, 31.42, '3STR', 1

*********************************************************************/

-- select * from LabTests
-- delete from LabTests where testcode = 'CD4T1'


---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextTestID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextTestID')
	drop proc uspGetNextTestID
go
create proc uspGetNextTestID(
@TestID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @TestCodePrefix varchar(1)

set @TestCodePrefix =dbo.GetOptionValue('TestCodePrefix')

set @TestID = (select max(TestID) from LabTests where left(TestCode, len(@TestCodePrefix)) = @TestCodePrefix)
set @TestID =  dbo.GetNextAutoNumber('LabTests', 'TestCode', @TestID)

return 0
go





---------Update Lab Tests--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateLabTests')
	drop proc uspUpdateLabTests
go

create proc uspUpdateLabTests(
@TestCode varchar(20),
@TestName varchar(100),
@SpecimenTypeID varchar(10),
@LabsID varchar(10),
@NormalRange varchar(800),
@UnitMeasureID varchar(10),
@UnitCost money,
@VATPercentage decimal,
@TestFee money,
@ResultDataTypeID varchar(10),
@Hidden bit = null,
@RequiresResultsApproval bit =null,
@TubeType varchar(200),
@TestDescription varchar(500),
@LoginID varchar(20) = null,
@ClientMachine varchar(40) = null
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select TestCode from LabTests where TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The Test Code: %s, you''re trying to update does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, @TestCode, 'Lab Tests')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @SpecimenTypeID)
	begin
		set @ErrorMSG = 'The Specimen Type ID: ' + @SpecimenTypeID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LabsID)
	begin
		set @ErrorMSG = 'The Labs ID: ' + @LabsID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @UnitMeasureID)
	begin
		set @ErrorMSG = 'The Unit Measure ID: ' + @UnitMeasureID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ResultDataTypeID)
	begin
		set @ErrorMSG = 'The Result Data Type ID: ' + @ResultDataTypeID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not (@LoginID is null or @LoginID = '') 
	begin
		if not exists(select LoginID from Logins where LoginID  = @LoginID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
				return 1
			end
	end
else if (@LoginID is null or @LoginID = '') begin set @LoginID = null end

begin

----------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
set @RequiresResultsApproval = isnull(@RequiresResultsApproval,0)
if (@ClientMachine is null or @ClientMachine = '') begin set @ClientMachine = host_name() end
----------------------------------------------------------------------------------------------

update LabTests set 
TestName = @TestName, SpecimenTypeID = @SpecimenTypeID, LabsID = @LabsID, 
NormalRange = @NormalRange, UnitMeasureID = @UnitMeasureID, UnitCost = @UnitCost, VATPercentage=@VATPercentage,
TestFee = @TestFee, ResultDataTypeID = @ResultDataTypeID, Hidden = @Hidden,RequiresResultsApproval=@RequiresResultsApproval,TubeType=@TubeType,
TestDescription=@TestDescription,
LoginID = @LoginID, ClientMachine = @ClientMachine
where TestCode = @TestCode 

return 0
end
go


/**************************************************************************************
--1------------------------------------------------------------------------------------
exec uspUpdateLabTests 'CD4T1', 'CD4', '14BLD', '5I', '400-1600', '8MM3', 0, 31.42, '3BIT', 0

**************************************************************************************/
-- select * from LabTests
-- delete from LabTests

--------GetLabTests------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabTests')
	drop proc uspGetLabTests
go

create proc uspGetLabTests(
@TestCode varchar(20) = null,
@OnlyNumeric bit = null, 
@Hidden bit = null
)with encryption as

declare @ErrorMSG varchar(200)

declare @NumberDataTypeID varchar(10)
declare @DecimalDataTypeID varchar(10)

-------------------------------------------------------------------------------------
set @OnlyNumeric = isnull(@OnlyNumeric, 0)
set @Hidden = isnull(@Hidden, 0)

set @NumberDataTypeID = dbo.GetLookupDataID('SearchDataType', 'NUM')
set @DecimalDataTypeID = dbo.GetLookupDataID('SearchDataType', 'DEC')
-------------------------------------------------------------------------------------

if not (@TestCode is null)
begin
	if not exists(select TestCode from LabTests where TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG,16,1, 'Test Code', @TestCode, 'Lab Tests')	
			return 1
	end
	begin
		select TestCode, TestName, SpecimenTypeID, dbo.GetLookupDataDes(SpecimenTypeID) as SpecimenType,
		LabsID as LabID, dbo.GetLookupDataDes(LabsID) As Lab, NormalRange, UnitMeasureID, 
		dbo.GetLookupDataDes(UnitMeasureID) As UnitMeasure , dbo.FormatMoney(UnitCost) As UnitCost, 
		dbo.FormatMoney(TestFee) As TestFee,VATPercentage, ResultDataTypeID, dbo.GetLookupDataDes(ResultDataTypeID) as ResultDataType, 
		Hidden,RequiresResultsApproval, dbo.GetLookupDataName(TubeType) as TubeType,TestDescription,dbo.GetHasSubTests(TestCode) as HasSubTests, dbo.GetMergedNameCode(TestName, TestCode) as TestFullName
		from LabTests 
		where TestCode = @TestCode
	end
end
else
if (@TestCode is null) and (@OnlyNumeric = 1) 
	begin
		select TestCode, TestName, SpecimenTypeID, dbo.GetLookupDataDes(SpecimenTypeID) as SpecimenType,
		LabsID as LabID, dbo.GetLookupDataDes(LabsID) As Lab, NormalRange, UnitMeasureID, 
		dbo.GetLookupDataDes(UnitMeasureID) As UnitMeasure ,dbo.FormatMoney(UnitCost) As UnitCost,VATPercentage, dbo.FormatMoney(TestFee) As TestFee, 
		ResultDataTypeID, dbo.GetLookupDataDes(ResultDataTypeID) as ResultDataType, dbo.GetLookupDataName(TubeType) as TubeType,TestDescription, Hidden,
		dbo.GetHasSubTests(TestCode) as HasSubTests,RequiresResultsApproval, 
		dbo.GetMergedNameCode(TestName, TestCode) as TestFullName
		from LabTests 
		where (Hidden = @Hidden) and ((ResultDataTypeID = @NumberDataTypeID) or (ResultDataTypeID = @DecimalDataTypeID))
		order by TestName
	end
else
if (@TestCode is null) and (@OnlyNumeric = 0) 
	begin
		select TestCode, TestName, SpecimenTypeID, dbo.GetLookupDataDes(SpecimenTypeID) as SpecimenType,
		LabsID as LabID, dbo.GetLookupDataDes(LabsID) As Lab, NormalRange, UnitMeasureID, 
		dbo.GetLookupDataDes(UnitMeasureID) As UnitMeasure, dbo.FormatMoney(UnitCost) As UnitCost, VATPercentage, dbo.FormatMoney(TestFee) As TestFee ,
		ResultDataTypeID, dbo.GetLookupDataDes(ResultDataTypeID) as ResultDataType, Hidden, dbo.GetLookupDataName(TubeType) as TubeType,TestDescription,
		dbo.GetHasSubTests(TestCode) as HasSubTests,RequiresResultsApproval, 
		dbo.GetMergedNameCode(TestName, TestCode) as TestFullName
		from LabTests 
		where Hidden = @Hidden
		order by TestName
	end

--------------------------------------------------------------------------------------------------------------------------------

return 0

go


-- select * from LabTests
-- exec uspGetLabTests 'T001'
-- exec uspGetLabTests 'T129'
-- exec uspGetLabTests null, 0
-- exec uspGetLabTests null, 1


------------------------------------------------------------------------------------------------------------
--------GetLabResultsItemDetails ---------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabResultsItemDetails')
drop proc uspGetLabResultsItemDetails
go


create proc uspGetLabResultsItemDetails(
@SpecimenNo varchar(20),
@TestCode varchar(20)
)with encryption as

begin

--------------------------------------------------------------------------------------------
select ItemDetails from Items
inner join LabRequests on LabRequests.VisitNo = Items.VisitNo
inner join LabRequestDetails on LabRequestDetails.SpecimenNo =LabRequests.SpecimenNo and
LabRequestDetails.TestCode = Items.ItemCode
where LabRequestDetails.SpecimenNo =@SpecimenNo and TestCode =@TestCode
union 
select ItemDetails from IPDItems
inner join LabRequestsIPD on LabRequestsIPD.RoundNo = IPDItems.RoundNo
inner join LabRequestDetails on LabRequestDetails.SpecimenNo =LabRequestsIPD.SpecimenNo and
LabRequestDetails.TestCode = IPDItems.ItemCode
where LabRequestDetails.SpecimenNo =@SpecimenNo and TestCode =@TestCode
--------------------------------------------------------------------------------------------


return 0

end
go

------------------------------------------------------------------------------------------------------
-------------- LabPossibleResults --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit LabPossibleResults -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditLabPossibleResults')
	drop proc uspEditLabPossibleResults
go

create proc uspEditLabPossibleResults(
@TestCode varchar(20),
@PossibleResult varchar(200)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TestCode from LabTests where TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Test Code', @TestCode, 'LabTests')
		return 1
	end

if exists(select TestCode from LabPossibleResults where TestCode = @TestCode and PossibleResult = @PossibleResult)
	begin
		--update LabPossibleResults set		
		--where TestCode = @TestCode and PossibleResult = @PossibleResult
		return 0
	end
else
begin
insert into LabPossibleResults
(TestCode, PossibleResult)
values
(@TestCode, @PossibleResult)
return 0
end
go

/******************************************************************************************************
exec uspEditLabPossibleResults 'T190','Gram Positive Cocci (GPC)'
exec uspEditLabPossibleResults 'T190','Gram Positive Rods (GPR)'
exec uspEditLabPossibleResults 'T190','Gram Negative Cocci (GNC)'
exec uspEditLabPossibleResults 'T190','Gram Negative Rods (GNR)'

******************************************************************************************************/
-- select * from LabPossibleResults
-- delete from LabPossibleResults

-------------- Get LabPossibleResults -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabPossibleResults')
	drop proc uspGetLabPossibleResults
go

create proc uspGetLabPossibleResults(
@TestCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
begin
	select TestCode, PossibleResult 
	from LabPossibleResults
	where TestCode = @TestCode
return 0
end
go

/******************************************************************************************************
exec uspGetLabPossibleResults 'MICDSSZN'
******************************************************************************************************/
-- select * from LabPossibleResults
-- delete from LabPossibleResults

------------------------------------------------------------------------------------------------------
------------- LabTestsEXT ----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert LabTestsEXT---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditLabTestsEXT')
	drop proc uspEditLabTestsEXT
go

create proc uspEditLabTestsEXT(
@TestCode varchar(20),
@SubTestCode varchar(20),
@SubTestName varchar(100),
@NormalRange varchar(800),
@UnitMeasureID varchar(10),
@ResultDataTypeID varchar(10),
@Hidden bit = null
)with encryption as 

declare @ErrorMSG varchar(200)
declare @SortOrder tinyint

if not exists(select TestCode from LabTests where TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG,16,1, 'Test Code', @TestCode, 'Lab Tests')	
			return 1
	end

if not exists(select DataID from LookupData where DataID = @UnitMeasureID)
	begin
		set @ErrorMSG = 'The Unit Measure ID: ' + @UnitMeasureID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ResultDataTypeID)
	begin
		set @ErrorMSG = 'The Result Data Type ID: ' + @ResultDataTypeID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else

if exists(select TestCode from LabTestsEXT where TestCode = @TestCode and SubTestCode = @SubTestCode)
	begin
		--set @ErrorMSG = 'The Test Code: ' + @TestCode + ', you are trying to enter already exists'
		--raiserror(@ErrorMSG,16,1)	
		--return 1

		update LabTestsEXT set		
		SubTestName = @SubTestName, NormalRange = @NormalRange,
		UnitMeasureID = @UnitMeasureID, ResultDataTypeID = @ResultDataTypeID, Hidden = @Hidden
		where TestCode = @TestCode and SubTestCode = @SubTestCode
		return 0
	end
else
begin

	-------------------------------------------------------------------------------------------
	set @SortOrder = dbo.GetNextLabTestsEXTSortOrder(@TestCode)
	set @Hidden = isnull(@Hidden, 0)
	-------------------------------------------------------------------------------------------

	insert into LabTestsEXT
	(SortOrder, TestCode, SubTestCode, SubTestName, NormalRange, UnitMeasureID, ResultDataTypeID, Hidden) 
	values
	(@SortOrder, @TestCode, @SubTestCode, @SubTestName, @NormalRange, @UnitMeasureID, @ResultDataTypeID, @Hidden)
	return 0
end

go

/****************************************************************************************
--1--------------------------------------------------------------------------------------
exec uspEditLabTestsEXT 'T001', 'WBC1', 'WBC', '3.5-11', '8THSDMM3', '3DEC', 0
exec uspEditLabTestsEXT 'T001', 'LYMPHS', 'PERCENTAGE LYMPHS', '20-45', '8PCT', '3DEC'
exec uspEditLabTestsEXT 'T001', 'MONOS', 'PERCENTAGE MONOS', '4-11', '8PCT', '3DEC'
exec uspEditLabTestsEXT 'T001', 'RBC', 'RBC', '4.2-6.1', '8MILLMM3', '3DEC'
exec uspEditLabTestsEXT 'T001', 'HGB', 'HGB', '12-18', '8GRMSDL', '3DEC'
exec uspEditLabTestsEXT 'T001', 'HCT', 'HCT', '34-52', '8PCT', '3DEC'
exec uspEditLabTestsEXT 'T001', 'MCV', 'MCV', '82-97', '8FL', '3DEC'
exec uspEditLabTestsEXT 'T001', 'PLT', 'PLT', '150-550', '8THSDMM3', '3DEC'

exec uspEditLabTestsEXT 'URNCHEM', 'URNBILI', 'URINE BILIRUBIN', '', '8NA', '3STR'
exec uspEditLabTestsEXT 'URNCHEM', 'URNBLD', 'URINE BLOOD', '', '8NA', '3STR'

*****************************************************************************************/

-- select * from LabTestsEXT
-- delete from LabTestsEXT where testcode = 'CD4T1'

--------Get Lab Tests EXT------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabTestsEXT')
	drop proc uspGetLabTestsEXT
go

create proc uspGetLabTestsEXT(
@TestCode varchar(20),
@SubTestCode varchar(20) = null,
@Hidden bit = null
)with encryption as

declare @ErrorMSG varchar(200)

-----------------------------------------------------------------------------------------------------------------
--set @Hidden = isnull(@Hidden, 0)
-----------------------------------------------------------------------------------------------------------------

if not (@SubTestCode is null)
	begin
		if not exists(select TestCode from LabTestsEXT where TestCode = @TestCode and SubTestCode = @SubTestCode)
			begin
				set @ErrorMSG = 'The record with %s: %s and %s: %s , you''re trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Test Code', @TestCode, 'Sub Test Code', @SubTestCode, 'Lab Tests EXT')	
				return 0
			end
		else
			begin
				select TestCode, SubTestCode, SubTestName, NormalRange, 
				UnitMeasureID, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure,
				ResultDataTypeID, dbo.GetLookupDataDes(ResultDataTypeID) as ResultDataType, Hidden
				from LabTestsEXT where TestCode = @TestCode and SubTestCode = @SubTestCode
			end
		
	end
	else 
		if (@SubTestCode is null and @Hidden is null)
			begin
				select TestCode, SubTestCode, SubTestName, NormalRange, 
				UnitMeasureID, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure,
				ResultDataTypeID, dbo.GetLookupDataDes(ResultDataTypeID) as ResultDataType, Hidden
				from LabTestsEXT where TestCode = @TestCode
				order by SortOrder
			end
		else
			begin
				select TestCode, SubTestCode, SubTestName, NormalRange, 
				UnitMeasureID, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure,
				ResultDataTypeID, dbo.GetLookupDataDes(ResultDataTypeID) as ResultDataType, Hidden
				from LabTestsEXT where Hidden = @Hidden and TestCode = @TestCode
				order by SortOrder
		end

return 0
------------------------------------------------------------------------------------------------------
go

-- select * from LabTestsEXT
-- exec uspGetLabTestsEXT 'T001'
-- exec uspGetLabTestsEXT 'T138'
-- exec uspGetLabTestsEXT 'T138', 'HG'
-- exec uspGetLabTestsEXT 'T138', null, 0

------------------------------------------------------------------------------------------------------
------------- LabRequests ----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Lab Requests -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertLabRequests')
	drop proc uspInsertLabRequests
go

create proc uspInsertLabRequests(
@SpecimenNo varchar(20),
@SpecimenDes varchar(40),
@DrawnBy varchar(10),
@VisitNo varchar(20),
@DrawnDateTime smalldatetime,
@LoginID varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @RecordDateTime smalldatetime

declare @SpecimenID int
declare @PaddingLEN tinyint

declare @PassedSpecimenID int
declare @PassedSpecimenNo varchar(20)
declare @PassedPatientNo varchar(20)

declare @PatientNo varchar(20)

set @RecordDateTime = getdate()

if exists(select SpecimenNo from LabRequests where SpecimenNo = @SpecimenNo)
	begin
		set @ErrorMSG = 'The Specimen No: ' + @SpecimenNo + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @DrawnBy)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Staff (Drawn By)', @DrawnBy, 'Staff')	
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered Visits'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
begin

--------------------------------------------------------------------------------------------------------------

select @PaddingLEN = PaddingLEN from AutoNumbers where ObjectName = 'LabRequests' and AutoColumnName = 'SpecimenNo'

select @PatientNo = PatientNo from Visits where VisitNo = @VisitNo
set @PassedPatientNo = ltrim(rtrim(substring(@SpecimenNo, 1, len(@SpecimenNo) - @PaddingLEN)))

if (@PassedPatientNo = @PatientNo)

begin

	set @PassedSpecimenID = 1
	set @PassedSpecimenNo = @SpecimenNo

	set @PassedSpecimenNo = ltrim(rtrim(substring(@PassedSpecimenNo, len(@PassedPatientNo) + 1, @PaddingLEN)))

	if isnumeric(@PassedSpecimenNo) = 1 set @PassedSpecimenID = @PassedSpecimenNo
	else set @PassedSpecimenID = 1

	set @SpecimenID = (select max(SpecimenID) from LabRequests inner join Visits 
						on LabRequests.VisitNo = Visits.VisitNo where PatientNo = @PatientNo)
	set @SpecimenID = dbo.GetNextAutoNumber('LabRequests', 'SpecimenNo', @SpecimenID)

	if @PassedSpecimenID < @SpecimenID set @SpecimenID = @PassedSpecimenID
	if @PassedSpecimenID > @SpecimenID set @SpecimenID = @PassedSpecimenID

end else set @SpecimenID = 1

-----------------------------------------------------------------------------------------------------------------
insert into LabRequests
(SpecimenID ,SpecimenNo ,SpecimenDes, DrawnBy, VisitNo  ,DrawnDateTime ,LoginID, RecordDateTime ) 
values
(@SpecimenID ,@SpecimenNo ,@SpecimenDes, @DrawnBy, @VisitNo ,@DrawnDateTime ,@LoginID ,@RecordDateTime )

if exists (select SpecimenNo from RejectedSpecimens where SpecimenNo=@SpecimenNo and IsReAccepted=0)
begin update RejectedSpecimens set IsReAccepted=1 where SpecimenNo=@SpecimenNo end
-----------------------------------------------------------------------------------------------
return 0
end
go



/****************************************************************************************************
--1--------------------------------------------------------------------------------------------------

exec uspInsertLabRequests '060000102', 'Blood 01', '12', '06000001001', '1 May 2006 13:54' ,'Admin'
exec uspInsertLabRequests '060000201', 'Blood 01', '100', '06000001001', '1 May 2006 13:54' ,'Admin'
exec uspInsertLabRequests '060000101', 'Blood 01', '10', '06000001001', '1 May 2006 13:54' ,'Admin'

*****************************************************************************************************/

-- select *  from LabRequests
-- delete from LabRequests

---------Update Lab Requests -------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateLabRequests')
	drop proc uspUpdateLabRequests
go

create proc uspUpdateLabRequests(
@SpecimenNo varchar(20),
@SpecimenDes varchar(40),
@DrawnBy varchar(10),
@VisitNo varchar(20),
@DrawnDateTime smalldatetime,
@LoginID varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select SpecimenNo from LabRequests where SpecimenNo = @SpecimenNo)
	begin
		set @ErrorMSG = 'The Specimen No: ' + @SpecimenNo + ', you are trying to enter does not exist in the registered Lab Requests'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @DrawnBy)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Staff (Drawn By)', @DrawnBy, 'Staff')	
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered Visits'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
begin

Update LabRequests set 

SpecimenDes = @SpecimenDes, DrawnBy = @DrawnBy, VisitNo = @VisitNo ,DrawnDateTime = @DrawnDateTime
where SpecimenNo = @SpecimenNo

return 0
end
go


/****************************************************************************************************
----------------------------------------------------------------------------------------------------

exec uspUpdateLabRequests '060000102', 'Blood 08', '22', '06000001001', '1 May 2006', '1 May 2006 13:54' ,'Admin'
exec uspUpdateLabRequests '060000201', 'Blood 01', '100', '06000001001', '1 May 2006', '1 May 2006 13:54' ,'Admin'
exec uspUpdateLabRequests '060000101', 'Blood 01', '10', '06000001001', '1 May 2006', '1 May 2006 13:54' ,'Admin'

*****************************************************************************************************/

-- select *  from LabRequests

--------GetLabRequests-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabRequests')
	drop proc uspGetLabRequests
go

create proc uspGetLabRequests(
@SpecimenNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	--if not exists(select SpecimenNo from LabRequests where SpecimenNo = @SpecimenNo)
	--begin
	--	set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
	--	raiserror(@ErrorMSG,16,1, 'Specimen No', @SpecimenNo, 'Lab Requests')	
	--	return 1
	--end

	begin
		select SpecimenNo, SpecimenDes, LabRequests.VisitNo,Patients.Phone as PhoneNo,Patients.PatientNo,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,
		dbo.GetAge(BirthDate, getdate()) as Age, dbo.GetLookupDataDes(GenderID) as Gender,
		dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
		DrawnDateTime, dbo.GetStaffName(DrawnBy) as DrawnByName,
		dbo.GetAdmissionNo(LabRequests.VisitNo) as AdmissionNo,
		dbo.GetRoundNo(SpecimenNo) as RoundNo,
		BirthDate, 
		dbo.GetAttendingDoctorNo(dbo.GetRoundNo(SpecimenNo)) as AttendingDoctorNo,
		dbo.GetAttendingDoctor(dbo.GetRoundNo(SpecimenNo)) as AttendingDoctor,
		dbo.GetDoctorStaffNo(LabRequests.VisitNo) as DoctorStaffNo, 
		dbo.GetLastSeenDoctor(LabRequests.VisitNo, dbo.GetRoundNo(SpecimenNo)) as PrimaryDoctor,
		dbo.GetTotalLabRequestDetails(SpecimenNo) as TotalLabRequests,
		dbo.GetStaffFullName(DrawnBy) as DrawnByFullName,
		dbo.GetHasPackage(Patients.PatientNo, PackageNo) as HasIPDPackage,PackageNo,
		dbo.IsAdmitted(SpecimenNo,dbo.GetRoundNo(SpecimenNo)) as IsAdmitted 
		from LabRequests
		inner join Visits on LabRequests.VisitNo = Visits.VisitNo
		left outer join PackageVisits on Visits.VisitNo = PackageVisits.VisitNo
		inner join Patients on Visits.PatientNo = Patients.PatientNo
		where SpecimenNo = @SpecimenNo
	end
	return 0	
end
go

-- select * from LabRequests
-- exec uspGetLabRequests '001001'

--------GetSpecimenNo-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetSpecimenNo')
	drop proc uspGetSpecimenNo
go

create proc uspGetSpecimenNo(
@PatientNo varchar(20),
@VisitDate smalldatetime = null output,
@SpecimenNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)

if (@VisitDate is null)
begin
	if not exists(select PatientNo from LabRequests inner join Visits on LabRequests.VisitNo = Visits.VisitNo
													where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Patient No', @PatientNo, 'Lab Requests')	
		return 1
	end
	else
	begin
		set @SpecimenNo = (select top 1 SpecimenNo from LabRequests inner join Visits on LabRequests.VisitNo = Visits.VisitNo
							where PatientNo = @PatientNo
							and VisitDate = (select max(VisitDate) from LabRequests inner join Visits on LabRequests.VisitNo = Visits.VisitNo
							where PatientNo = @PatientNo)
							order by SpecimenID desc)
	end
end
else
if not (@VisitDate is null)
begin

if not exists(select PatientNo from LabRequests inner join Visits on LabRequests.VisitNo = Visits.VisitNo
								where PatientNo = @PatientNo and VisitDate = @VisitDate)
	begin
		set @ErrorMSG = '%s: %s and %s: ' + dbo.FormatDate(@VisitDate) + ', you are trying to enter does not exist %s'
		raiserror(@ErrorMSG,16,1, 'The record with Patient No', @PatientNo, 'Visit Date', 'in the registered Lab Requests')	
		return 1		
	end
	else
	begin
		set @SpecimenNo = (select top 1 SpecimenNo from LabRequests inner join Visits on LabRequests.VisitNo = Visits.VisitNo
								where PatientNo = @PatientNo and VisitDate = @VisitDate order by SpecimenID desc)
	end
end

return 0

go

-- select * from patients
-- exec  uspGetSpecimenNo '07022061'
-- exec uspGetSpecimenNo '07022061', '23 Jan 2007'

--------Get Next Specimen ID-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextSpecimenID')
	drop proc uspGetNextSpecimenID
go

create proc uspGetNextSpecimenID(
@VisitNo varchar(20) ,
@SpecimenID int = null output
)with encryption as

declare @VisitNoPaddingLEN tinyint

set @VisitNoPaddingLEN = (select PaddingLEN from AutoNumbers where ObjectName = 'Visits' and AutoColumnName = 'VisitNo')

set @SpecimenID = (select max(SpecimenID) from LabRequests where left(VisitNo,(len(VisitNo) - @VisitNoPaddingLEN)) = left(@VisitNo, (len(@VisitNo) - @VisitNoPaddingLEN)))
set @SpecimenID = dbo.GetNextAutoNumber('LabRequests', 'SpecimenNo', @SpecimenID)

return 0

go

-- exec uspGetNextSpecimenID 'TOP010093TM003'
-- select * from LabRequests

------------------------------------------------------------------------------------------------------
-------------- LabRequestsIPD ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert LabRequestsIPD -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertLabRequestsIPD')
	drop proc uspInsertLabRequestsIPD
go

create proc uspInsertLabRequestsIPD(
@SpecimenNo varchar(20),
@RoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SpecimenNo from LabRequests where SpecimenNo  = @SpecimenNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Specimen No', @SpecimenNo, 'Lab Requests')
		return 1
	end

if exists(select SpecimenNo from LabRequestsIPD where SpecimenNo = @SpecimenNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Specimen No', @SpecimenNo)
		return 1
	end

if not exists(select RoundNo from IPDDoctor where RoundNo  = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPD Doctor')
		return 1
	end

begin
insert into LabRequestsIPD
(SpecimenNo, RoundNo)
values
(@SpecimenNo, @RoundNo)
return 0
end
go


/******************************************************************************************************
exec uspInsertLabRequestsIPD '110223102', '11022310101'

******************************************************************************************************/
-- select * from LabRequestsIPD
-- delete from LabRequestsIPD

-------------- Update LabRequestsIPD -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateLabRequestsIPD')
	drop proc uspUpdateLabRequestsIPD
go

create proc uspUpdateLabRequestsIPD(
@SpecimenNo varchar(20),
@RoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SpecimenNo from LabRequestsIPD where SpecimenNo = @SpecimenNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Specimen No', @SpecimenNo, 'Lab Requests IPD')
		return 1
	end

if not exists(select RoundNo from IPDDoctor where RoundNo  = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPD Doctor')
		return 1
	end

begin
	update LabRequestsIPD set RoundNo = @RoundNo where SpecimenNo = @SpecimenNo
	return 0
end
go

/******************************************************************************************************
exec uspUpdateLabRequestsIPD '110223102', '11022310101'

******************************************************************************************************/
-- select * from LabRequestsIPD
-- delete from LabRequestsIPD

-------------- GetLabRequestsIPD --------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabRequestsIPD')
	drop proc uspGetLabRequestsIPD
go

create proc uspGetLabRequestsIPD(
@RoundNo varchar(20),
@SpecimenNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)

begin
	set @SpecimenNo = (select top 1 SpecimenNo from LabRequestsIPD where RoundNo = @RoundNo)
return 0
end
go

/******************************************************************************************************
exec uspGetLabRequestsIPD '10112000101'

******************************************************************************************************/
-- select * from LabRequestsIPD
-- delete from LabRequestsIPD

--------GetPendingIPDLabResults------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPendingIPDLabResults')
	drop proc uspGetPendingIPDLabResults
go

create proc uspGetPendingIPDLabResults(
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @ItemStatusID varchar(10)
set @ItemStatusID = dbo.GetLookupDataID('ItemStatus', 'R')

if not(@StartDate is null) and not(@EndDate is null)
begin
--------------------------------------------------------------------------------------------
	set @EndDate = dbo.GetShortDate(dateadd(day, 1, @EndDate))
--------------------------------------------------------------------------------------------

	select dbo.FormatText(PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo, 
			dbo.FormatText(SpecimenNo, 'LabRequests', 'SpecimenNo') as SpecimenNo, 
			TestName, dbo.FormatDateTime(RoundDateTime) as RoundDateTime, FullName, 
			Gender, Age, dbo.FormatDateTime(DrawnDateTime) as DrawnDateTime
	from IPDLabRequestSummaries
	where ItemStatusID = @ItemStatusID and RoundDateTime between @StartDate and @EndDate
	order by RoundDateTime, DrawnDateTime
end	
else
begin
	select dbo.FormatText(PatientNo, 'Patients', 'PatientNo') as PatientNo,
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo, 
			dbo.FormatText(SpecimenNo, 'LabRequests', 'SpecimenNo') as SpecimenNo, 
			TestName, dbo.FormatDateTime(RoundDateTime) as RoundDateTime, FullName, 
			Gender, Age, dbo.FormatDateTime(DrawnDateTime) as DrawnDateTime
	from IPDLabRequestSummaries
	where ItemStatusID = @ItemStatusID
	order by RoundDateTime, DrawnDateTime
end	
return 0

go

-- select * from LabRequestsIPD
-- exec uspGetPendingIPDLabResults
-- exec uspGetPendingIPDLabResults 'may 1, 2011', 'may 12, 2011'
-- exec uspGetPendingIPDLabResults 'Oct 1, 2013', 'Oct 1, 2013'
-- exec uspGetPendingIPDLabResults 'Oct 1, 2013', 'Oct 31, 2013'




if exists (select * from sysobjects where name = 'uspGetAllPendingLabResults')
	drop proc uspGetAllPendingLabResults
go

create proc uspGetAllPendingLabResults(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

declare @ItemStatusID varchar(10)
declare @ServicePointID varchar(10)
set @ItemStatusID = dbo.GetLookupDataID('ItemStatus', 'R')
set @ServicePointID = dbo.GetLookupDataID('ServicePoint', 'LAB')

begin		
	select dbo.FormatText(LabRequestSummaries.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(LabRequestSummaries.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo,FirstName,
			dbo.FormatText(SpecimenNo, 'LabRequests', 'SpecimenNo') as SpecimenNo, 
			TestName, dbo.FormatDate(VisitDate) as VisitDate, FullName, 
			Gender, Age, dbo.FormatDateTime(DrawnDateTime) as DrawnDateTime,
			dbo.IsAdmitted(LabRequestSummaries.SpecimenNo,'') as IsAdmitted,
			dbo.PatientAdmissionStatus(LabRequestSummaries.SpecimenNo) as PatientAdmissionStatus
	from LabRequestSummaries
	inner join Patients on LabRequestSummaries.PatientNo=Patients.PatientNo
	left outer join Queues on Queues.VisitNo=LabRequestSummaries.VisitNo and
	ServicePointID=@ServicePointID and QueueStatus=1
	where ItemStatusID = @ItemStatusID and DrawnDateTime between @StartDate and @EndDate	
	
	union
		select dbo.FormatText(IPDLabRequestSummaries.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo, TokenNo,FirstName, 
			dbo.FormatText(SpecimenNo, 'LabRequests', 'SpecimenNo') as SpecimenNo, 
			TestName, dbo.FormatDateTime(RoundDateTime) as RoundDateTime, FullName, 
			Gender, Age, dbo.FormatDateTime(DrawnDateTime) as DrawnDateTime,
				dbo.IsAdmitted(IPDLabRequestSummaries.SpecimenNo,IPDLabRequestSummaries.RoundNo) as IsAdmitted,
				dbo.PatientAdmissionStatus(IPDLabRequestSummaries.SpecimenNo) as PatientAdmissionStatus
	from IPDLabRequestSummaries
		inner join Patients on IPDLabRequestSummaries.PatientNo=Patients.PatientNo
	left outer join Queues on Queues.VisitNo=IPDLabRequestSummaries.RoundNo
	where ItemStatusID = @ItemStatusID and RoundDateTime between @StartDate and @EndDate
	order by  DrawnDateTime
	

	
end	
return 0
go


-- exec uspGetAllPendingLabResults 'March 1, 2018', 'March 21, 2018'
------------------------------------------------------------------------------------------------------
------------- LabRequestDetails ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Lab Request Tests --------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditLabRequestDetails')
	drop proc uspEditLabRequestDetails
go

create proc uspEditLabRequestDetails(
@SpecimenNo varchar(20),
@TestCode varchar(20),
@Notes varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select SpecimenNo from LabRequests where SpecimenNo = @SpecimenNo)
	begin
		set @ErrorMSG = 'The Specimen No: ' + @SpecimenNo + ', you are trying to enter does not exist in the registered Lab Requests'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select TestCode from LabTests where TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The Test Code: ' + @TestCode + ', you are trying to enter does not exist in the registered Lab Tests'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if exists(select SpecimenNo from LabRequestDetails where SpecimenNo = @SpecimenNo and TestCode = @TestCode)
	begin
		--set @ErrorMSG = 'The record with Specimen No: ' + @SpecimenNo + ' and Test Code: ' + @TestCode + ', you are trying to enter already exists'
		--raiserror(@ErrorMSG,16,1)	
		--return 1

		update LabRequestDetails set Notes = @Notes, LoginID = @LoginID, ClientMachine = @ClientMachine
		where SpecimenNo = @SpecimenNo and TestCode = @TestCode	
		return 0
	end
else
begin
	insert into LabRequestDetails
	(SpecimenNo, TestCode, Notes, LoginID, ClientMachine) 
	values
	(@SpecimenNo, @TestCode, @Notes, @LoginID, @ClientMachine)
	return 0
end
go

/*****************************************************************************************************
--1---------------------------------------------------------------------------------------------------
exec uspEditLabRequestDetails '060000101', 'CT', 'Noted'

******************************************************************************************************/

-- select *  from LabRequestDetails
-- delete from LabRequestDetails

--------Get Lab Request Tests----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabRequestDetails')
	drop proc uspGetLabRequestDetails
go

create proc uspGetLabRequestDetails( 
@SpecimenNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SpecimenNo from LabRequestDetails where SpecimenNo = @SpecimenNo)
begin
	set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
	raiserror(@ErrorMSG,16,1, 'Specimen No', @SpecimenNo, 'Lab Request Tests')	
	return 1
end
else
begin
	select SpecimenNo, TestCode, Notes from LabRequestDetails
	where SpecimenNo = @SpecimenNo
end	

return 0

go

-- select * from LabRequestDetails
-- exec uspGetLabRequestDetails '0600000401'PendingResults

--------GetPendingLabResults----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPendingLabResults')
	drop proc uspGetPendingLabResults
go

create proc uspGetPendingLabResults(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

declare @ItemStatusID varchar(10)
declare @ServicePointID varchar(10)
set @ItemStatusID = dbo.GetLookupDataID('ItemStatus', 'R')
set @ServicePointID = dbo.GetLookupDataID('ServicePoint', 'LAB')

begin		
	select dbo.FormatText(LabRequestSummaries.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(LabRequestSummaries.VisitNo, 'Visits', 'VisitNo') as VisitNo, TokenNo,FirstName,
			dbo.FormatText(SpecimenNo, 'LabRequests', 'SpecimenNo') as SpecimenNo, 
			TestName, dbo.FormatDate(VisitDate) as VisitDate, FullName, 
			Gender, Age, dbo.FormatDateTime(DrawnDateTime) as DrawnDateTime
	from LabRequestSummaries
	inner join Patients on LabRequestSummaries.PatientNo=Patients.PatientNo
	left outer join Queues on Queues.VisitNo=LabRequestSummaries.VisitNo and ServicePointID=@ServicePointID and QueueStatus=1
	where ItemStatusID = @ItemStatusID and DrawnDateTime between @StartDate and @EndDate	
	order by TokenNo asc, VisitDate, DrawnDateTime desc
	
end	
return 0
go

-- select * from LabRequestDetails
-- exec uspGetPendingLabResults 'Oct 1, 2013', 'Oct 1, 2013'
-- exec uspGetPendingLabResults 'Oct 1, 2013', 'Oct 31, 2013'

------------------------------------------------------------------------------------------------------
------------- LabResults -----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Lab Results --------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertLabResults')
	drop proc uspInsertLabResults
go

create proc uspInsertLabResults(
@SpecimenNo varchar(20),
@TestCode varchar(20),
@TestDateTime smalldatetime,
@Result varchar(200),
@UnitMeasure varchar(100),
@NormalRange varchar(800),
@ResultFlagID varchar(10),
@Report varchar(2000),
@LabTechnologist varchar(10),
@EntryModeID varchar(10),
@LoginID varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @ApprovedStatusID varchar(10)

if (dbo.GetOptionValue('ForceLabResultsVerification') > 0 and dbo.GetTestCodeRequiresResultsApproval(@TestCode) > 0)
begin
Set @ApprovedStatusID =dbo.GetLookupDataID('YesNo', 'N')
end
else
begin
Set @ApprovedStatusID =dbo.GetLookupDataID('YesNo', 'Y')
end

if not exists(select SpecimenNo from LabRequestDetails where SpecimenNo = @SpecimenNo and TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Specimen No', @SpecimenNo, 'Test Code', @TestCode, 'Lab Request Details')	
		return 1
	end

if exists(select SpecimenNo from LabResults where SpecimenNo = @SpecimenNo and  TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The record with Specimen No: ' + @SpecimenNo + ' and Test Code: ' + @TestCode + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ResultFlagID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Result Flag ID', @ResultFlagID, 'Lookup Data')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @LabTechnologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Staff (Lab Technologist)', @LabTechnologist, 'Staff')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EntryModeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Entry Mode ID', @EntryModeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
begin
insert into LabResults(
SpecimenNo ,TestCode ,TestDateTime ,Result, UnitMeasure, NormalRange, ResultFlagID ,Report, LabTechnologist, EntryModeID,ApprovedStatusID, LoginID) values
(@SpecimenNo ,@TestCode ,@TestDateTime ,@Result, @UnitMeasure, @NormalRange, @ResultFlagID ,@Report, @LabTechnologist, @EntryModeID,@ApprovedStatusID,@LoginID)

if exists (select SpecimenNo from RejectedSpecimens where SpecimenNo=@SpecimenNo and IsReAccepted=0)
begin
update RejectedSpecimens set IsReAccepted=1 where SpecimenNo=@SpecimenNo
end
return 0
end
go


/*********************************************************************
--1-------------------------------------------------------------------
exec uspInsertLabResults '060000101', 'CT', '1 May 2006', 'Result', 'Report', '', ''

*********************************************************************/

-- select *  from LabResults
-- delete from LabResults

---------Update Lab Results --------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateLabResults')
	drop proc uspUpdateLabResults
go

create proc uspUpdateLabResults(
@SpecimenNo varchar(20),
@TestCode varchar(20),
@TestDateTime smalldatetime,
@Result varchar(200),
@UnitMeasure varchar(100),
@NormalRange varchar(800),
@ResultFlagID varchar(10),
@Report varchar(2000),
@LabTechnologist varchar(10),
@EntryModeID varchar(10),
@LoginID varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select SpecimenNo from LabRequestDetails where SpecimenNo = @SpecimenNo and TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The record with Specimen No: %s and Test Code: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1,@SpecimenNo, @TestCode, 'Lab Request Tests')	
		return 1
	end


if not exists(select SpecimenNo from LabResults where SpecimenNo = @SpecimenNo and  TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The record with Specimen No: ' + @SpecimenNo + ' and Test Code: ' + @TestCode + ', you are trying to enter does not exist in the registered Lab results'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ResultFlagID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Result Flag ID', @ResultFlagID, 'Lookup Data')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @LabTechnologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Staff (Lab Technologist)', @LabTechnologist, 'Staff')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EntryModeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Entry Mode ID', @EntryModeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
begin
Update LabResults set 
TestDateTime = @TestDateTime, Result = @Result, UnitMeasure = @UnitMeasure, 
NormalRange = @NormalRange, ResultFlagID = @ResultFlagID, Report = @Report, 
LabTechnologist = @LabTechnologist, EntryModeID = @EntryModeID, LoginID = @LoginID
where SpecimenNo = @SpecimenNo and  TestCode = @TestCode
return 0
end
go


/*********************************************************************
--1-------------------------------------------------------------------
exec uspUpdateLabResults '0600000101', 'ABO', '11 Oct 2006', '16', 'Report', '', 'Kutegz'

*********************************************************************/

-- select * from LabResults

--------Get Lab Results------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabResults')
	drop proc uspGetLabResults
go

create proc uspGetLabResults(
@SpecimenNo varchar(20) = null,
@TestCode varchar(20) = null,
@VisitNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @ApprovedStatusID varchar(10)
declare @NotApprovedStatusID varchar(10)
Set @ApprovedStatusID =dbo.GetLookupDataID('YesNo', 'Y')
Set @NotApprovedStatusID =dbo.GetLookupDataID('YesNo', 'N')

if  (not @SpecimenNo is null and @TestCode is null and @VisitNo is null)
begin
	if not exists(select SpecimenNo from LabResults where SpecimenNo = @SpecimenNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Specimen No', @SpecimenNo, 'Lab Results')	
		return 1
	end

	if exists(select SpecimenNo from LabResults where SpecimenNo = @SpecimenNo and ApprovedStatusID =@NotApprovedStatusID )
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter has Test Results that are not yet Approved. Please Contact Lab Administrator'
		raiserror(@ErrorMSG,16,1, 'Specimen No', @SpecimenNo, 'Lab Results')	
		return 1
	end
	begin
		select SpecimenNo, LabResults.TestCode, TestName, TestDateTime, Result, Report, 
		LabTechnologist, dbo.GetHasSubResults(SpecimenNo, LabResults.TestCode) as HasSubResults, UnitMeasure,
		dbo.GetLabResultsEXT(SpecimenNo, LabResults.TestCode, Result) as Results, 
		LabResults.NormalRange, ResultFlagID, dbo.GetLookupDataDes(ResultFlagID) as ResultFlag,
		dbo.GetStaffName(LabTechnologist) as LabTechnologistName, dbo.GetRoundNo(SpecimenNo) as RoundNo, 
		dbo.GetStaffFullName(LabTechnologist)as LabTechnologistFullName,TestDescription,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode
		from LabResults 
		inner join LabTests on LabResults.TestCode = LabTests.TestCode
		where SpecimenNo = @SpecimenNo
		and LabResults.ApprovedStatusID =@ApprovedStatusID
	end	
end
else

if  (not @SpecimenNo is null and not @TestCode is null and @VisitNo is null)
begin
	if not exists(select SpecimenNo from LabResults where SpecimenNo = @SpecimenNo and TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The %s: %s and %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Specimen No', @SpecimenNo, 'Test Code', @TestCode, 'Lab Results')	
		return 1
	end

	begin
		select SpecimenNo, TestCode, TestDateTime, Result, Report, LabTechnologist, UnitMeasure,
		LabResults.NormalRange, ResultFlagID, dbo.GetLookupDataDes(ResultFlagID) as ResultFlag,
		dbo.GetHasSubResults(SpecimenNo, LabResults.TestCode) as HasSubResults, 
		dbo.GetStaffName(LabTechnologist) as LabTechnologistName, dbo.GetRoundNo(SpecimenNo) as RoundNo, 
		dbo.GetStaffFullName(LabTechnologist)as LabTechnologistFullName,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode
		from LabResults
		where SpecimenNo = @SpecimenNo and TestCode = @TestCode
	end	
end
else

if  (@SpecimenNo is null and @TestCode is null and not @VisitNo is null and (dbo.GetOptionValue('ForceLabResultsVerification') > 0))
begin	
	begin
		select LabResults.SpecimenNo, LabResults.TestCode, TestName, TestDateTime, 
		LabTests.ResultDataTypeID, dbo.GetLookupDataDes(LabTests.ResultDataTypeID) as ResultDataType, 
		dbo.GetLabResultsEXT(SpecimenNo, LabResults.TestCode, Result) as Result,
		LabResults.UnitMeasure, LabResults.NormalRange, Report, LabTechnologist,
		LabResults.ResultFlagID, dbo.GetLookupDataDes(LabResults.ResultFlagID) as ResultFlag,
		dbo.GetStaffName(LabTechnologist) as LabTechnologistName, 
		dbo.GetRoundNo(LabResults.SpecimenNo) as RoundNo, 
		dbo.GetStaffFullName(LabTechnologist)as LabTechnologistFullName,TestDescription
		from LabResults
		inner join LabTests on LabResults.TestCode = LabTests.TestCode
		where LabResults.SpecimenNo in (select SpecimenNo from LabRequests where VisitNo = @VisitNo)
		and LabResults.ApprovedStatusID =@ApprovedStatusID
		union
		select LabResultsEXT.SpecimenNo, LabResultsEXT.TestCode, LabTestsEXT.SubTestName as TestName, 
		TestDateTime, LabTestsEXT.ResultDataTypeID, dbo.GetLookupDataDes(LabTestsEXT.ResultDataTypeID) as ResultDataType, 
		LabResultsEXT.Result, LabResultsEXT.UnitMeasure, LabResultsEXT.NormalRange, LabResultsEXT.Report, LabTechnologist,
		LabResultsEXT.ResultFlagID, dbo.GetLookupDataDes(LabResultsEXT.ResultFlagID) as ResultFlag,
		dbo.GetStaffName(LabTechnologist) as LabTechnologistName, 
		dbo.GetRoundNo(LabResultsEXT.SpecimenNo) as RoundNo, 
		dbo.GetStaffFullName(LabTechnologist)as LabTechnologistFullName,TestDescription
		from LabResultsEXT
		inner join LabResults on LabResultsEXT.TestCode = LabResults.TestCode 
					and LabResultsEXT.SpecimenNo = LabResults.SpecimenNo
		inner join LabTestsEXT on LabResultsEXT.TestCode = LabTestsEXT.TestCode 
					and LabResultsEXT.SubTestCode = LabTestsEXT.SubTestCode
		inner join LabTests on LabResults.TestCode = LabTests.TestCode
		where LabResultsEXT.SpecimenNo in (select SpecimenNo from LabRequests where VisitNo = @VisitNo)
		and LabResults.ApprovedStatusID =@ApprovedStatusID
		order by LabResults.SpecimenNo, LabResults.TestCode
	end	
end
else

if  (@SpecimenNo is null and @TestCode is null and not @VisitNo is null and (dbo.GetOptionValue('ForceLabResultsVerification') <= 0))
begin	
	begin
		select LabResults.SpecimenNo, LabResults.TestCode, TestName, TestDateTime, 
		LabTests.ResultDataTypeID, dbo.GetLookupDataDes(LabTests.ResultDataTypeID) as ResultDataType, 
		dbo.GetLabResultsEXT(SpecimenNo, LabResults.TestCode, Result) as Result,
		LabResults.UnitMeasure, LabResults.NormalRange, Report, LabTechnologist,
		LabResults.ResultFlagID, dbo.GetLookupDataDes(LabResults.ResultFlagID) as ResultFlag,
		dbo.GetStaffName(LabTechnologist) as LabTechnologistName, 
		dbo.GetRoundNo(LabResults.SpecimenNo) as RoundNo, 
		dbo.GetStaffFullName(LabTechnologist)as LabTechnologistFullName,TestDescription
		from LabResults
		inner join LabTests on LabResults.TestCode = LabTests.TestCode
		where LabResults.SpecimenNo in (select SpecimenNo from LabRequests where VisitNo = @VisitNo)
		
		union
		select LabResultsEXT.SpecimenNo, LabResultsEXT.TestCode, LabTestsEXT.SubTestName as TestName, 
		TestDateTime, LabTestsEXT.ResultDataTypeID, dbo.GetLookupDataDes(LabTestsEXT.ResultDataTypeID) as ResultDataType, 
		LabResultsEXT.Result, LabResultsEXT.UnitMeasure, LabResultsEXT.NormalRange, LabResultsEXT.Report, LabTechnologist,
		LabResultsEXT.ResultFlagID, dbo.GetLookupDataDes(LabResultsEXT.ResultFlagID) as ResultFlag,
		dbo.GetStaffName(LabTechnologist) as LabTechnologistName, 
		dbo.GetRoundNo(LabResultsEXT.SpecimenNo) as RoundNo, 
		dbo.GetStaffFullName(LabTechnologist)as LabTechnologistFullName,TestDescription
		from LabResultsEXT
		inner join LabResults on LabResultsEXT.TestCode = LabResults.TestCode 
					and LabResultsEXT.SpecimenNo = LabResults.SpecimenNo
		inner join LabTestsEXT on LabResultsEXT.TestCode = LabTestsEXT.TestCode 
					and LabResultsEXT.SubTestCode = LabTestsEXT.SubTestCode
		inner join LabTests on LabResults.TestCode = LabTests.TestCode
		where LabResultsEXT.SpecimenNo in (select SpecimenNo from LabRequests where VisitNo = @VisitNo)
	
		order by LabResults.SpecimenNo, LabResults.TestCode
	end	
end
else


if  (@SpecimenNo is null and @TestCode is null and @VisitNo is null)

begin
	select SpecimenNo, LabResults.TestCode, TestName, TestDateTime, Result, Report, LabTechnologist,
	dbo.GetStaffName(LabTechnologist) as LabTechnologistName, 
	dbo.GetStaffFullName(LabTechnologist)as LabTechnologistFullName,TestDescription
	from LabResults
	inner join LabTests on LabResults.TestCode = LabTests.TestCode
end

return 0
go

-------------------------------------------------------------------------------------------------------

-- select * from LabResults
-- exec uspGetLabResults '121688301', null, null
-- exec uspGetLabResults '10000101', 'T001', null
-- exec uspGetLabResults  null, null, '100001001'
-- exec uspGetLabResults  null, null, '08022078003'
-- exec uspGetLabResults null, null, null
-------------------------------------------------------------------------------------------------------

--------GetLabResultsByPatientNo------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabResultsByPatientNo')
	drop proc uspGetLabResultsByPatientNo
go

create proc uspGetLabResultsByPatientNo(
@PatientNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select distinct PatientNo from LabResults 
			inner join LabRequests on LabRequests.SpecimenNo = LabResults.SpecimenNo
			inner join Visits on LabRequests.VisitNo = Visits.VisitNo where PatientNo = @PatientNo)
begin
	set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
	raiserror(@ErrorMSG,16,1, 'Patient No', @PatientNo, 'Lab Results')	
	return 1
end
else
begin
	select distinct LabRequests.SpecimenNo, VisitDate from LabResults 
	inner join LabRequests on LabRequests.SpecimenNo = LabResults.SpecimenNo
	inner join Visits on LabRequests.VisitNo = Visits.VisitNo
	where PatientNo = @PatientNo order by VisitDate, LabRequests.SpecimenNo
end
return 0
go

-- select * from LabResults
-- exec uspGetLabResultsByPatientNo '1010561'

--------GetDoneLabResults----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDoneLabResults')
	drop proc uspGetDoneLabResults
go

create proc uspGetDoneLabResults(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(LabRequests.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
			dbo.FormatText(LabRequestDetails.SpecimenNo, 'LabRequests', 'SpecimenNo') as SpecimenNo, 
			TestName, dbo.FormatDate(VisitDate) as VisitDate, 
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.FormatDateTime(TestDateTime) as TestDateTime
	from LabResults
	inner join LabTests on LabResults.TestCode = LabTests.TestCode
	inner join LabRequestDetails on LabResults.TestCode = LabRequestDetails.TestCode 
			and LabResults.SpecimenNo = LabRequestDetails.SpecimenNo 
	inner join LabRequests on LabRequestDetails.SpecimenNo = LabRequests.SpecimenNo
	inner join Visits on Visits.VisitNo = LabRequests.VisitNo 
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where VisitDate between @StartDate and @EndDate
	order by VisitDate, TestDateTime desc
end	
return 0
go

-- select * from LabRequestDetails
-- exec uspGetDoneLabResults 'jan 15, 2011', 'jan 31, 2011'

--------GetUnApprovedDoneLabResults----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetUnApprovedDoneLabResults')
	drop proc uspGetUnApprovedDoneLabResults
go

create proc uspGetUnApprovedDoneLabResults(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

declare @ApprovedStatusID varchar(10)
Set @ApprovedStatusID =dbo.GetLookupDataID('YesNo', 'N')

begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(LabRequests.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
			dbo.FormatText(LabRequestDetails.SpecimenNo, 'LabRequests', 'SpecimenNo') as SpecimenNo, 
			TestName, dbo.FormatDate(VisitDate) as VisitDate, 
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.FormatDateTime(TestDateTime) as TestDateTime
	from LabResults
	inner join LabTests on LabResults.TestCode = LabTests.TestCode
	inner join LabRequestDetails on LabResults.TestCode = LabRequestDetails.TestCode 
			and LabResults.SpecimenNo = LabRequestDetails.SpecimenNo 
	inner join LabRequests on LabRequestDetails.SpecimenNo = LabRequests.SpecimenNo
	inner join Visits on Visits.VisitNo = LabRequests.VisitNo 
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where VisitDate between @StartDate and @EndDate and LabResults.ApprovedStatusID =@ApprovedStatusID
	order by VisitDate, TestDateTime desc
end	
return 0
go

-- select * from LabRequestDetails
-- exec uspGetUnApprovedDoneLabResults 'jan 29 2018', 'jul 31 2018'



--------GetDoneLabResultsStatus----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDoneLabResultsStatus')
	drop proc uspGetDoneLabResultsStatus
go

create proc uspGetDoneLabResultsStatus(
@ApprovedStatusID varchar(10)
)with encryption as


begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(LabRequests.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
			dbo.FormatText(LabRequestDetails.SpecimenNo, 'LabRequests', 'SpecimenNo') as SpecimenNo, 
			TestName, dbo.FormatDate(VisitDate) as VisitDate, 
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.FormatDateTime(TestDateTime) as TestDateTime
	from LabResults
	inner join LabTests on LabResults.TestCode = LabTests.TestCode
	inner join LabRequestDetails on LabResults.TestCode = LabRequestDetails.TestCode 
			and LabResults.SpecimenNo = LabRequestDetails.SpecimenNo 
	inner join LabRequests on LabRequestDetails.SpecimenNo = LabRequests.SpecimenNo
	inner join Visits on Visits.VisitNo = LabRequests.VisitNo 
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where  LabResults.ApprovedStatusID =@ApprovedStatusID
	order by VisitDate, TestDateTime desc
end	
return 0
go

-- select * from LabRequestDetails
-- exec uspGetDoneLabResultsStatus 'jan 29 2018'

--------GetPendingLabRequestsDetails----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPendingLabRequestsDetails')
	drop proc uspGetPendingLabRequestsDetails
go

create proc uspGetPendingLabRequestsDetails(
@SpecimenNo varchar(20)
)with encryption as


begin

select SpecimenNo,LabRequestDetails.TestCode,TestName,LabRequestDetails.RecordDateTime,LabRequestDetails.LoginID,
dbo.FormatDate(LabRequestDetails.RecordDateTime) as RecordDate,
dbo.GetTime(LabRequestDetails.RecordDateTime) as RecordTime 
from LabRequestDetails
Inner join LabTests on LabTests.TestCode =LabRequestDetails.TestCode
WHERE SpecimenNo = @SpecimenNo and  NOT EXISTS (select SpecimenNo,TestCode from LabResults where LabResults.SpecimenNo =LabRequestDetails.SpecimenNo And
LabResults.TestCode=LabRequestDetails.TestCode )  
end	
return 0
go

-- select * from LabRequestDetails
-- exec uspGetPendingLabRequestsDetails '1308466003'


--------Get Up Approved Lab Results------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'UspGetUnApprovedLabResults')
	drop proc UspGetUnApprovedLabResults
go

create proc UspGetUnApprovedLabResults(
@SpecimenNo varchar(20) = null,
@TestCode varchar(20) = null,
@VisitNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @ApprovedStatusID varchar(10)

Set @ApprovedStatusID =dbo.GetLookupDataID('YesNo', 'N')

if  (not @SpecimenNo is null and @TestCode is null and @VisitNo is null)
begin
	if not exists(select SpecimenNo from LabResults where SpecimenNo = @SpecimenNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Specimen No', @SpecimenNo, 'Lab Results')	
		return 1
	end

	if not exists(select SpecimenNo from LabResults where SpecimenNo = @SpecimenNo and ApprovedStatusID =@ApprovedStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not any un Approved Lab Test Results'
		raiserror(@ErrorMSG,16,1, 'Specimen No', @SpecimenNo, 'Lab Results')	
		return 1
	end

	begin
		select SpecimenNo, LabResults.TestCode, TestName, TestDateTime, Result, Report, 
		LabTechnologist, dbo.GetHasSubResults(SpecimenNo, LabResults.TestCode) as HasSubResults, UnitMeasure,
		dbo.GetLabResultsEXT(SpecimenNo, LabResults.TestCode, Result) as Results, 
		LabResults.NormalRange, ResultFlagID, dbo.GetLookupDataDes(ResultFlagID) as ResultFlag,
		dbo.GetStaffName(LabTechnologist) as LabTechnologistName, dbo.GetRoundNo(SpecimenNo) as RoundNo, 
		dbo.GetStaffFullName(LabTechnologist)as LabTechnologistFullName,TestDescription,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode
		from LabResults 
		inner join LabTests on LabResults.TestCode = LabTests.TestCode
		where SpecimenNo = @SpecimenNo and LabResults.ApprovedStatusID =@ApprovedStatusID
	end	
end
else

if  (not @SpecimenNo is null and not @TestCode is null and @VisitNo is null)
begin
	if not exists(select SpecimenNo from LabResults where SpecimenNo = @SpecimenNo and TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The %s: %s and %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Specimen No', @SpecimenNo, 'Test Code', @TestCode, 'Lab Results')	
		return 1
	end

	begin
		select SpecimenNo, TestCode, TestDateTime, Result, Report, LabTechnologist, UnitMeasure,
		LabResults.NormalRange, ResultFlagID, dbo.GetLookupDataDes(ResultFlagID) as ResultFlag,
		dbo.GetHasSubResults(SpecimenNo, LabResults.TestCode) as HasSubResults, 
		dbo.GetStaffName(LabTechnologist) as LabTechnologistName, dbo.GetRoundNo(SpecimenNo) as RoundNo, 
		dbo.GetStaffFullName(LabTechnologist)as LabTechnologistFullName,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode
		from LabResults
		where SpecimenNo = @SpecimenNo and TestCode = @TestCode and LabResults.ApprovedStatusID =@ApprovedStatusID
	end	
end
else

if  (@SpecimenNo is null and @TestCode is null and not @VisitNo is null)
begin	
	begin
		select LabResults.SpecimenNo, LabResults.TestCode, TestName, TestDateTime, 
		LabTests.ResultDataTypeID, dbo.GetLookupDataDes(LabTests.ResultDataTypeID) as ResultDataType, 
		dbo.GetLabResultsEXT(SpecimenNo, LabResults.TestCode, Result) as Result,
		LabResults.UnitMeasure, LabResults.NormalRange, Report, LabTechnologist,
		LabResults.ResultFlagID, dbo.GetLookupDataDes(LabResults.ResultFlagID) as ResultFlag,
		dbo.GetStaffName(LabTechnologist) as LabTechnologistName, 
		dbo.GetRoundNo(LabResults.SpecimenNo) as RoundNo, 
		dbo.GetStaffFullName(LabTechnologist)as LabTechnologistFullName,TestDescription
		from LabResults
		inner join LabTests on LabResults.TestCode = LabTests.TestCode
		where LabResults.SpecimenNo in (select SpecimenNo from LabRequests where VisitNo = @VisitNo) and LabResults.ApprovedStatusID =@ApprovedStatusID
		union
		select LabResultsEXT.SpecimenNo, LabResultsEXT.TestCode, LabTestsEXT.SubTestName as TestName, 
		TestDateTime, LabTestsEXT.ResultDataTypeID, dbo.GetLookupDataDes(LabTestsEXT.ResultDataTypeID) as ResultDataType, 
		LabResultsEXT.Result, LabResultsEXT.UnitMeasure, LabResultsEXT.NormalRange, LabResultsEXT.Report, LabTechnologist,
		LabResultsEXT.ResultFlagID, dbo.GetLookupDataDes(LabResultsEXT.ResultFlagID) as ResultFlag,
		dbo.GetStaffName(LabTechnologist) as LabTechnologistName, 
		dbo.GetRoundNo(LabResultsEXT.SpecimenNo) as RoundNo, 
		dbo.GetStaffFullName(LabTechnologist)as LabTechnologistFullName,TestDescription
		from LabResultsEXT
		inner join LabResults on LabResultsEXT.TestCode = LabResults.TestCode 
					and LabResultsEXT.SpecimenNo = LabResults.SpecimenNo
		inner join LabTestsEXT on LabResultsEXT.TestCode = LabTestsEXT.TestCode 
					and LabResultsEXT.SubTestCode = LabTestsEXT.SubTestCode
		inner join LabTests on LabResults.TestCode = LabTests.TestCode
		where LabResultsEXT.SpecimenNo in (select SpecimenNo from LabRequests where VisitNo = @VisitNo) and LabResults.ApprovedStatusID =@ApprovedStatusID
		order by LabResults.SpecimenNo, LabResults.TestCode
	end	
end
else

if  (@SpecimenNo is null and @TestCode is null and @VisitNo is null)

begin
	select SpecimenNo, LabResults.TestCode, TestName, TestDateTime, Result, Report, LabTechnologist,
	dbo.GetStaffName(LabTechnologist) as LabTechnologistName, 
	dbo.GetStaffFullName(LabTechnologist)as LabTechnologistFullName,TestDescription
	from LabResults
	inner join LabTests on LabResults.TestCode = LabTests.TestCode and LabResults.ApprovedStatusID =@ApprovedStatusID
end

return 0
go

-------------------------------------------------------------------------------------------------------

-- select * from LabResults
-- exec UspGetUnApprovedLabResults '121688301', null, null
-- exec UspGetUnApprovedLabResults '10000101', 'T001', null
-- exec UspGetUnApprovedLabResults  null, null, '100001001'
-- exec UspGetUnApprovedLabResults  null, null, '08022078003'
-- exec UspGetUnApprovedLabResults null, null, null
-------------------------------------------------------------------------------------------------------

-------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCountUnApprovedLabResults')
	drop proc uspGetCountUnApprovedLabResults
go

create proc uspGetCountUnApprovedLabResults(
@Records int = null output
)with encryption as

---------------------------------------------------------------------------------------------
declare @ApprovedStatusID varchar(10)
Set @ApprovedStatusID =dbo.GetLookupDataID('YesNo', 'N')

begin
set @Records =(select count(SpecimenNo) as UnApproved from LabResults
where ApprovedStatusID =@ApprovedStatusID)
end
			
set @Records = isnull(@Records, 0)	


return 0
go




--------- GetDoneSelfRequestLabResults -------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDoneSelfRequestLabResults')
	drop proc uspGetDoneSelfRequestLabResults
go

create proc uspGetDoneSelfRequestLabResults
(@VisitNo varchar(20) = null)
with encryption as

declare @ErrorMSG varchar(200)

declare @SelfRequestVisitCategoryID varchar(10)
declare @RecordDateTime smalldatetime

set @SelfRequestVisitCategoryID = dbo.GetLookupDataID('VisitCategory', 'S')
set @RecordDateTime = dateadd(hour, -12, getdate())

begin
if not (@VisitNo is null or @VisitNo = '')
	begin
		if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
			return 1
		end
		else
		begin
		select Patients.PatientNo,Visits.VisitNo,dbo.GetFullName(LastName,MiddleName,FirstName) as FullName,
		dbo.GetLookupDataDes(GenderID) as Gender,dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.FormatDate(VisitDate) as VisitDate,dbo.FormatDate(TestDateTime) as TestDate,
		dbo.GetTime(LabResults.RecordDateTime) as SentTime, dbo.GetStaffName(DrawnBy) as DrawnBy 
		from Patients inner join visits on Patients.PatientNo = Visits.PatientNo
		inner join LabRequests on Visits.VisitNo = LabRequests.VisitNo
		inner join LabResults on LabResults.SpecimenNo = LabRequests.SpecimenNo
		where Visits.VisitCategoryID = @SelfRequestVisitCategoryID
		and Visits.VisitNo = @VisitNo and LabResults.RecordDateTime >= @RecordDateTime
		order by  TestDate desc,SentTime desc
		end
	end
else
	begin
		select Patients.PatientNo,Visits.VisitNo,dbo.GetFullName(LastName,MiddleName,FirstName) as FullName,
		dbo.GetLookupDataDes(GenderID) as Gender,dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.FormatDate(VisitDate) as VisitDate,dbo.FormatDate(TestDateTime) as TestDate,
		dbo.GetTime(LabResults.RecordDateTime) as SentTime, dbo.GetStaffName(DrawnBy) as DrawnBy 
		from Patients inner join visits on Patients.PatientNo = Visits.PatientNo
		inner join LabRequests on Visits.VisitNo = LabRequests.VisitNo
		inner join LabResults on LabResults.SpecimenNo = LabRequests.SpecimenNo
		where Visits.VisitCategoryID = @SelfRequestVisitCategoryID and LabResults.RecordDateTime >= @RecordDateTime
		order by  TestDate desc,SentTime desc
	end
end
return 0
go

-----------------------------------------------------
--exec uspGetDoneSelfRequestLabResults '1112541002'
--exec uspGetDoneSelfRequestLabResults
-----------------------------------------------------

------------------------------------------------------------------------------------------------------
------------- LabResultsEXT --------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert LabResultsEXT--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditLabResultsEXT')
	drop proc uspEditLabResultsEXT
go

create proc uspEditLabResultsEXT(
@SpecimenNo varchar(20),
@TestCode varchar(20),
@SubTestCode varchar(20),
@Result varchar(200),
@UnitMeasure varchar(100),
@NormalRange varchar(800),
@ResultFlagID varchar(10),
@Report varchar(2000)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select SpecimenNo from LabResults where SpecimenNo = @SpecimenNo and TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Specimen No', @SpecimenNo, 'Test Code', @TestCode, 'Lab Results')	
		return 1
	end

if not exists(select TestCode from LabTestsEXT where TestCode = @TestCode and SubTestCode = @SubTestCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Test Code', @TestCode, 'Sub Test Code', @SubTestCode, 'Lab Tests EXT')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ResultFlagID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Result Flag ID', @ResultFlagID, 'Lookup Data')
		return 1
	end
else

if exists(select TestCode from LabResultsEXT 
		  where SpecimenNo = @SpecimenNo and TestCode = @TestCode and SubTestCode = @SubTestCode)
	begin
		--set @ErrorMSG = 'The Test Code: ' + @TestCode + ', you are trying to enter already exists'
		--raiserror(@ErrorMSG,16,1)	
		--return 1
		update LabResultsEXT set		
		Result = @Result, UnitMeasure = @UnitMeasure, NormalRange = @NormalRange, ResultFlagID = @ResultFlagID, Report = @Report
		where SpecimenNo = @SpecimenNo and TestCode = @TestCode and SubTestCode = @SubTestCode
		return 0
	end
else
begin
	insert into LabResultsEXT
	(SpecimenNo, TestCode, SubTestCode, Result, UnitMeasure, NormalRange, ResultFlagID, Report) 
	values
	(@SpecimenNo, @TestCode, @SubTestCode, @Result, @UnitMeasure, @NormalRange, @ResultFlagID, @Report)
	return 0
end

go


/*********************************************************************
--1-------------------------------------------------------------------
exec uspEditLabResultsEXT 'R9625/06','CBC', 'HCT', 'Result 11', 'Report 11'
exec uspEditLabResultsEXT 'R9625/06','CBC', 'HGB', 'Result 2', 'Report 2'
exec uspEditLabResultsEXT 'R9625/06','CBC', 'INR', 'Result 3', 'Report 3'
exec uspEditLabResultsEXT '0802207801','CL', 'INR', 'Result 3', 'Report 3'

*********************************************************************/

-- select * from LabResultsEXT
-- delete from LabResultsEXT where testcode = 'CD4T1'

--------GetLabTests------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabResultsEXT')
	drop proc uspGetLabResultsEXT
go

create proc uspGetLabResultsEXT(
@SpecimenNo varchar(20),
@TestCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TestCode from LabResultsEXT where SpecimenNo = @SpecimenNo and TestCode = @TestCode)
	begin
		-- set @ErrorMSG = 'The record with %s: %s and %s: %s, you''re trying to enter does not exist in the registered %s'
		-- raiserror(@ErrorMSG,16,1, 'Specimen No', @SpecimenNo, 'Test Code', @TestCode, 'Lab Results EXT')	
		return 0
	end
	begin
		select SpecimenNo, LabResultsEXT.TestCode, LabResultsEXT.SubTestCode, SubTestName,
		LabResultsEXT.NormalRange, Result, ResultDataTypeID, dbo.GetLookupDataDes(ResultDataTypeID) as ResultDataType,
		UnitMeasure, ResultFlagID, dbo.GetLookupDataDes(ResultFlagID) as ResultFlag, Report
		from LabResultsEXT 
		inner join LabtestsEXT on  LabResultsEXT.TestCode = LabtestsEXT.TestCode
		and LabResultsEXT.SubTestCode = LabtestsEXT.SubTestCode
		where SpecimenNo = @SpecimenNo and LabResultsEXT.TestCode = @TestCode
		order by SortOrder
	end

return 0
go

-- select * from LabResultsEXT
-- exec uspGetLabResultsEXT 'R9625/06','CBC'
-- exec uspGetLabResultsEXT '0802207802','CBC'

------------------------------------------------------------------------------------------------------
-------------- PathologyExaminations -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PathologyExaminations ----------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPathologyExaminations')
	drop proc uspInsertPathologyExaminations
go

create proc uspInsertPathologyExaminations(
@ExamCode varchar(20),
@ExamName varchar(40),
@PathologyCategoriesID varchar(10),
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit,
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ExamID Int
declare @PathologyExamCodePrefix varchar(1)

if exists(select ExamCode from PathologyExaminations where ExamCode = @ExamCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Pathology Exam Code', @ExamCode)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PathologyCategoriesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pathology Categories', @PathologyCategoriesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
	set @PathologyExamCodePrefix = dbo.GetOptionValue('PathologyExamCodePrefix')
	set @ExamID = (select max(ExamID) from PathologyExaminations where left(ExamCode, len(@PathologyExamCodePrefix)) = @PathologyExamCodePrefix)
	set @ExamID = dbo.GetNextAutoNumber('PathologyExaminations', 'ExamCode', @ExamID)

insert into PathologyExaminations
(ExamID, ExamCode, ExamName, PathologyCategoriesID, UnitPrice,VATPercentage, Hidden, LoginID)
values
(@ExamID, @ExamCode, @ExamName, @PathologyCategoriesID, @UnitPrice,@VATPercentage, @Hidden, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertPathologyExaminations
******************************************************************************************************/
-- select * from PathologyExaminations
-- delete from PathologyExaminations


---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextPathologyExamID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextPathologyExamID')
	drop proc uspGetNextPathologyExamID
go
create proc uspGetNextPathologyExamID(
@ExamID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @PathologyExamCodePrefix varchar(1)

set @PathologyExamCodePrefix =dbo.GetOptionValue('PathologyExamCodePrefix')

set @ExamID = (select max(ExamID) from PathologyExaminations where left(ExamCode, len(@PathologyExamCodePrefix)) = @PathologyExamCodePrefix)
set @ExamID =  dbo.GetNextAutoNumber('PathologyExaminations', 'ExamCode', @ExamID)

return 0
go








-------------- Update PathologyExaminations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePathologyExaminations')
	drop proc uspUpdatePathologyExaminations
go

create proc uspUpdatePathologyExaminations(
@ExamCode varchar(20),
@ExamName varchar(40),
@PathologyCategoriesID varchar(10),
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit,
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ExamCode from PathologyExaminations where ExamCode = @ExamCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pathology Exam Code', @ExamCode, 'PathologyExaminations')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PathologyCategoriesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pathology Categories', @PathologyCategoriesID, 'Lookup Data')
		return 1
	end
	
if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update PathologyExaminations set
ExamName = @ExamName, PathologyCategoriesID = @PathologyCategoriesID,
UnitPrice = @UnitPrice, VATPercentage=@VATPercentage,Hidden = @Hidden, LoginID = @LoginID
where ExamCode = @ExamCode
return 0
end
go

/******************************************************************************************************
exec uspUpdatePathologyExaminations
******************************************************************************************************/
-- select * from PathologyExaminations
-- delete from PathologyExaminations

-------------- Get PathologyExaminations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPathologyExaminations')
	drop proc uspGetPathologyExaminations
go

create proc uspGetPathologyExaminations(
@ExamCode varchar(20) = null,
@Hidden bit = null
)with encryption as

declare @ErrorMSG varchar(200)

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

if not (@ExamCode is null)
begin
	if not exists(select ExamCode from PathologyExaminations where ExamCode = @ExamCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ExamCode, 'Pathology Examinations')
		return 1
	end
	begin
		select ExamCode, ExamName, dbo.GetMergedNameCode(ExamName,ExamCode) as ExamFullName,
		PathologyCategoriesID, dbo.GetLookupDataDes(PathologyCategoriesID) as PathologyCategories,
		UnitPrice,VATPercentage, Hidden,PathologyExaminations.LoginID, ClientMachine, RecordDateTime
		from PathologyExaminations
		where ExamCode = @ExamCode
	end
end
else
if  (@ExamCode is null)

begin
	select ExamCode, ExamName, dbo.GetMergedNameCode(ExamName, ExamCode) as ExamFullName,
	PathologyCategoriesID, dbo.GetLookupDataDes(PathologyCategoriesID) as PathologyCategories,
    UnitPrice,VATPercentage,Hidden,PathologyExaminations.LoginID, ClientMachine, RecordDateTime
	from PathologyExaminations
	where Hidden = @Hidden
	order by ExamName
end
return 0
go



/******************************************************************************************************
exec uspGetPathologyExaminations
******************************************************************************************************/
-- select * from PathologyExaminations
-- delete from PathologyExaminations

------------------------------------------------------------------------------------------------------
-------------- PathologyImages --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PathologyImages -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPathologyImages')
	drop proc uspInsertPathologyImages
go

create proc uspInsertPathologyImages(
@VisitNo varchar(20),
@ImageName varchar(20),
@PathologyImage Image = null,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if exists(select VisitNo from PathologyImages where VisitNo = @VisitNo and ImageName = @ImageName)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'ImageName', @ImageName)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into PathologyImages
(VisitNo, ImageName, PathologyImage, LoginID)
values
(@VisitNo, @ImageName, @PathologyImage, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertPathologyImages
******************************************************************************************************/
-- select * from PathologyImages
-- delete from PathologyImages


-------------- Update PathologyImages -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePathologyImages')
	drop proc uspUpdatePathologyImages
go

create proc uspUpdatePathologyImages(
@VisitNo varchar(20),
@ImageName varchar(20),
@PathologyImage Image =null,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into PathologyImages
(VisitNo, ImageName, PathologyImage, LoginID)
values
(@VisitNo, @ImageName, @PathologyImage, @LoginID)
return 0
end
go
/******************************************************************************************************
exec uspUpdatePathologyImages
******************************************************************************************************/
-- select * from PathologyImages
-- delete from PathologyImages


-------------- Get PathologyImages -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPathologyImages')
	drop proc uspGetPathologyImages
go

create proc uspGetPathologyImages(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
begin
	select VisitNo, ImageName, PathologyImage, PathologyImages.LoginID
	from PathologyImages

	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetPathologyImages
******************************************************************************************************/
-- select * from PathologyImages
-- delete from PathologyImages


------------------------------------------------------------------------------------------------------
-------------- PathologyReports --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PathologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPathologyReports')
	drop proc uspInsertPathologyReports
go

create proc uspInsertPathologyReports(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReportTypeID varchar(10),
@ExamDateTime smalldatetime,
@Indication varchar(4000),
@Diagnosis varchar(4000),
@Macroscopic varchar(4000),
@Microscopic varchar(4000),
@Pathologist varchar(10),
@PathologyTitleID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Items where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Items')
		return 1
	end

if not exists(select ItemCode from Items where ItemCode  = @ItemCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCode', @ItemCode, 'Items')
		return 1
	end

if not exists(select ItemCategoryID from Items where ItemCategoryID  = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCategory', @ItemCategoryID, 'Items')
		return 1
	end

if exists(select VisitNo from PathologyReports where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'ItemCode', @ItemCode, 'ItemCategory', @ItemCategoryID)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ReportTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ReportType', @ReportTypeID, 'Lookup Data')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Pathologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pathologist', @Pathologist, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PathologyTitleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PathologyTitle', @PathologyTitleID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into PathologyReports
(VisitNo, ItemCode, ItemCategoryID, ReportTypeID, ExamDateTime, 
Indication, Diagnosis,Macroscopic,Microscopic,Pathologist,PathologyTitleID, LoginID)
values
(@VisitNo, @ItemCode, @ItemCategoryID, @ReportTypeID, @ExamDateTime,
 @Indication, @Diagnosis,@Macroscopic,@Microscopic, @Pathologist, @PathologyTitleID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertPathologyReports
******************************************************************************************************/
-- select * from PathologyReports
-- delete from PathologyReports


-------------- Update PathologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePathologyReports')
	drop proc uspUpdatePathologyReports
go

create proc uspUpdatePathologyReports(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReportTypeID varchar(10),
@ExamDateTime smalldatetime,
@Indication varchar(4000),
@Diagnosis varchar(4000),
@Macroscopic varchar(4000),
@Microscopic varchar(4000),
@Pathologist varchar(10),
@PathologyTitleID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DataID from LookupData where DataID = @ReportTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ReportType', @ReportTypeID, 'Lookup Data')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Pathologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pathologist', @Pathologist, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PathologyTitleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PathologyTitle', @PathologyTitleID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update PathologyReports set
ReportTypeID = @ReportTypeID, ExamDateTime = @ExamDateTime, 
Indication = @Indication, Diagnosis = @Diagnosis,Macroscopic = @Macroscopic,@Microscopic = @Microscopic, Pathologist = @Pathologist,
 PathologyTitleID = @PathologyTitleID, LoginID = @LoginID
where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspUpdatePathologyReports
******************************************************************************************************/
-- select * from PathologyReports
-- delete from PathologyReports


-------------- Get PathologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPathologyReports')
	drop proc uspGetPathologyReports
go
create proc uspGetPathologyReports(
@VisitNo varchar(20),
@ItemCode varchar(20) = null,
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not @VisitNo is null and @ItemCode is null and @ItemCategoryID is null)
	begin
select PathologyReports.VisitNo, PathologyReports.ItemCode, PathologyReports.ItemCategoryID,
 ReportTypeID, dbo.GetLookupDataDes(ReportTypeID) as ReportType,Macroscopic,Microscopic, 
	ExamDateTime,dbo.GetItemName(ItemCategoryID, ItemCode) as ExamName ,Indication,
	 Diagnosis,dbo.GetStaffFullName(Pathologist)as PathologistFullName , 
	PathologyTitleID, dbo.GetLookupDataDes(PathologyTitleID) as PathologyTitle,
	PathologyReports.LoginID,
	 ClientMachine, RecordDateTime
	from PathologyReports	
  		where PathologyReports.VisitNo = @VisitNo
	end
else
if (not @VisitNo is null and not @ItemCode is null and not @ItemCategoryID is null)
begin
	if not exists(select VisitNo from PathologyReports where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Pathology Reports')
			return 1
		end
	else
	begin
select PathologyReports.VisitNo, PathologyReports.ItemCode, PathologyReports.ItemCategoryID,
 ReportTypeID, dbo.GetLookupDataDes(ReportTypeID) as ReportType,Macroscopic,Microscopic, 
	ExamDateTime,dbo.GetItemName(ItemCategoryID, ItemCode) as ExamName, Indication,
	 Diagnosis,dbo.GetStaffFullName(Pathologist)as PathologistFullName , 
	PathologyTitleID, dbo.GetLookupDataDes(PathologyTitleID) as PathologyTitle
	,PathologyReports.LoginID,
	 ClientMachine, RecordDateTime
	from PathologyReports	
   where PathologyReports.VisitNo = @VisitNo and PathologyReports.ItemCode = @ItemCode and PathologyReports.ItemCategoryID = @ItemCategoryID
end
end
return 0
go

/******************************************************************************************************
exec uspGetPathologyReports
******************************************************************************************************/
-- select * from PathologyReports
-- delete from PathologyReports

------------------------------------------------------------------------------------------------------
-------------- IPDPathologyReports --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert IPDPathologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertIPDPathologyReports')
	drop proc uspInsertIPDPathologyReports
go

create proc uspInsertIPDPathologyReports(
@RoundNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReportTypeID varchar(10),
@ExamDateTime smalldatetime,
@Indication varchar(4000),
@Diagnosis varchar(4000),
@Macroscopic varchar(4000),
@Microscopic varchar(4000),
@Pathologist varchar(10),
@PathologyTitleID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDItems where RoundNo  = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'RoundNo', @RoundNo, 'IPDItems')
		return 1
	end

if not exists(select ItemCode from IPDItems where ItemCode  = @ItemCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCode', @ItemCode, 'IPDItems')
		return 1
	end

if not exists(select ItemCategoryID from IPDItems where ItemCategoryID  = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCategory', @ItemCategoryID, 'IPDItems')
		return 1
	end

if exists(select RoundNo from IPDPathologyReports where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
       update IPDPathologyReports set ReportTypeID = @ReportTypeID, ExamDateTime = @ExamDateTime, Indication = @Indication,
	   Macroscopic = @Macroscopic,Microscopic = @Microscopic,
       Diagnosis = @Diagnosis, Pathologist = @Pathologist,PathologyTitleID = @PathologyTitleID, LoginID = @LoginID
       where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	end

if not exists(select DataID from LookupData where DataID = @ReportTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ReportType', @ReportTypeID, 'Lookup Data')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Pathologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pathologist', @Pathologist, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PathologyTitleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PathologyTitle', @PathologyTitleID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into IPDPathologyReports
(RoundNo, ItemCode, ItemCategoryID, ReportTypeID, ExamDateTime, Indication, Diagnosis,Macroscopic, Microscopic, Pathologist, PathologyTitleID, LoginID)
values
(@RoundNo, @ItemCode, @ItemCategoryID, @ReportTypeID, @ExamDateTime, @Indication, @Diagnosis,@Macroscopic, @Microscopic, @Pathologist, @PathologyTitleID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertIPDPathologyReports
******************************************************************************************************/
-- select * from IPDPathologyReports
-- delete from IPDPathologyReports


-------------- Update IPDPathologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDPathologyReports')
	drop proc uspUpdateIPDPathologyReports
go

create proc uspUpdateIPDPathologyReports(
@RoundNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReportTypeID varchar(10),
@ExamDateTime smalldatetime,
@Indication varchar(4000),
@Diagnosis varchar(4000),
@Macroscopic varchar(4000),
@Microscopic varchar(4000),
@Pathologist varchar(10),
@PathologyTitleID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDPathologyReports where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'RoundNo', @RoundNo, 'ItemCode', @ItemCode, 'ItemCategory', @ItemCategoryID, 'IPDPathologyReports')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ReportTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ReportType', @ReportTypeID, 'Lookup Data')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Pathologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pathologist', @Pathologist, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PathologyTitleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PathologyTitle', @PathologyTitleID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update IPDPathologyReports set
ReportTypeID = @ReportTypeID, ExamDateTime = @ExamDateTime, Indication = @Indication,
Diagnosis = @Diagnosis,Macroscopic = @Macroscopic, 
Microscopic = @Microscopic, Pathologist = @Pathologist,
 PathologyTitleID = @PathologyTitleID, LoginID = @LoginID
where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDPathologyReports
******************************************************************************************************/
-- select * from IPDPathologyReports
-- delete from IPDPathologyReports


-------------- Get IPDPathologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDPathologyReports')
drop proc uspGetIPDPathologyReports
go

create proc uspGetIPDPathologyReports(
@RoundNo varchar(20),
@ItemCode varchar(20)=null,
@ItemCategoryID varchar(10)=null
)with encryption as

declare @ErrorMSG varchar(200)

if (not @RoundNo is null and @ItemCode is null and @ItemCategoryID is null)
begin
select RoundNo, ItemCode, ItemCategoryID, 
dbo.GetStaffFullName(Pathologist)as PathologistFullName,
ReportTypeID, dbo.GetLookupDataDes(ReportTypeID) as [ReportType],dbo.GetItemName(ItemCategoryID, ItemCode) as ExamName,dbo.FormatDate(ExamDateTime) as ExamDateTime,
 Indication, Diagnosis,
Macroscopic, Microscopic,
IPDPathologyReports.Pathologist, PathologyTitleID, dbo.GetLookupDataDes(PathologyTitleID) as [PathologyTitle], IPDPathologyReports.LoginID,
ClientMachine, RecordDateTime
from IPDPathologyReports where IPDPathologyReports.RoundNo = @RoundNo
end
else
if (not @RoundNo is null and not @ItemCode is null and not @ItemCategoryID is null)
begin

if not exists(select RoundNo from IPDPathologyReports where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
begin

set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
raiserror(@ErrorMSG, 16, 1, 'RoundNo', @RoundNo, 'ItemCode', @ItemCode, 'ItemCategory', @ItemCategoryID, 'IPDPathologyReports')
return 1
end
else
begin
select RoundNo, ItemCode, ItemCategoryID, 
dbo.GetStaffFullName(Pathologist)as PathologistFullName,
ReportTypeID, dbo.GetLookupDataDes(ReportTypeID) as [ReportType],dbo.GetItemName(ItemCategoryID, ItemCode) as ExamName,dbo.FormatDate(ExamDateTime) as ExamDateTime, Indication, Diagnosis,
Macroscopic, Microscopic,IPDPathologyReports.Pathologist, PathologyTitleID, dbo.GetLookupDataDes(PathologyTitleID) as [PathologyTitle], IPDPathologyReports.LoginID,
ClientMachine, RecordDateTime
from IPDPathologyReports
where IPDPathologyReports.RoundNo = @RoundNo and IPDPathologyReports.ItemCode = @ItemCode and IPDPathologyReports.ItemCategoryID = @ItemCategoryID
end
end
return 0
go

/******************************************************************************************************
exec uspGetIPDPathologyReports
******************************************************************************************************/
-- select * from IPDPathologyReports
-- delete from IPDPathologyReports


------------------------------------------------------------------------------------------------------
-------------- HCTClientCard --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert HCTClientCard -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertHCTClientCard')
	drop proc uspInsertHCTClientCard
go

create proc uspInsertHCTClientCard(
@VisitNo Varchar(20),
@DistrictsID varchar(10),
@HealthUnitCode varchar(10),
@HSD Varchar(100),
@CenterTypeID varchar(10),
@TestingPointID varchar(10),
@AccompaniedByID Varchar(10),
@PreTestCounselingID Varchar(10),
@CounseledAsID Varchar(10),
@HCTEntryPoint Varchar(10),
@MaritalStatusID Varchar(10),
@SexualPatnerNo smallint,
@TestedHIVBeforeID varchar(10),
@HIVTestThreeMonthsID Varchar(10),
@HIVTestSixMonthsID Varchar(10),
@HIVTestTwelveMonthsID Varchar(10),
@ResultThreeMonthsID Varchar(10),
@ResultSixMonthsID Varchar(10),
@ResultTwelveMonthsID Varchar(10),
@NoTestsInTwelveMonthsID Varchar(10),
@PatnerTestedHIVID Varchar(10),
@PatnerTypeID Varchar(10),
@PatnerResultID Varchar(10),
@KnowAboutServiceID Varchar(200),
@ConsentID Varchar(10),
@NoConsentReasonID Varchar(200),
@HIVResultID Varchar(10),
@TestDoneBy Varchar(41),
@Designation Varchar(20),
@TestDate smalldatetime,
@ResultReceivedID Varchar(10),
@ResultReceivedAsCoupleID Varchar(10),
@CoupleResultsID Varchar(10),
@TBSuspicionID Varchar(10),
@STIID Varchar(10),
@StartedCotrimoxazoleID Varchar(10),
@LinkedToCareID Varchar(10),
@WhereLinkedToCareID Varchar(10),
@ReferralReason Varchar(200),
@CounselorName Varchar(41),
@CounselDate smalldatetime,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DistrictsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Districts ID', @DistrictsID, 'Lookup Data')
		return 1
	end

if not exists(select HealthUnitCode from HealthUnits where HealthUnitCode  = @HealthUnitCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Health Unit Code', @HealthUnitCode, 'HealthUnits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CenterTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Center Type ID', @CenterTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TestingPointID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Testing Point ID', @TestingPointID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AccompaniedByID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Accompanied By ID', @AccompaniedByID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PreTestCounselingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PreTest Counseling ID', @PreTestCounselingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CounseledAsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Counseled As ID', @CounseledAsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HCTEntryPoint)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'HCT Entry Point', @HCTEntryPoint, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @MaritalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Marital Status ID', @MaritalStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TestedHIVBeforeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Tested HIV Before ID', @TestedHIVBeforeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HIVTestThreeMonthsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'HIV Test Three Months ID', @HIVTestThreeMonthsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HIVTestSixMonthsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'HIV Test Six Months ID', @HIVTestSixMonthsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HIVTestTwelveMonthsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'HIV Test Twelve Months ID', @HIVTestTwelveMonthsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ResultThreeMonthsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Result Three Months ID', @ResultThreeMonthsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ResultSixMonthsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Result Six Months ID', @ResultSixMonthsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ResultTwelveMonthsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Result Twelve Months ID', @ResultTwelveMonthsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @NoTestsInTwelveMonthsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'No Tests In Twelve Months ID', @NoTestsInTwelveMonthsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PatnerTestedHIVID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patner Tested HIV ID', @PatnerTestedHIVID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PatnerTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patner Type ID', @PatnerTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PatnerResultID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patner Result ID', @PatnerResultID, 'Lookup Data')
		return 1
	end

--if not exists(select DataID from LookupData where DataID = @KnowAboutServiceID)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Know About Service ID', @KnowAboutServiceID, 'Lookup Data')
--		return 1
--	end

if not exists(select DataID from LookupData where DataID = @ConsentID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Consent ID', @ConsentID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HIVResultID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'HIV Result ID', @HIVResultID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ResultReceivedID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Result Received ID', @ResultReceivedID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ResultReceivedAsCoupleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Result Received As Couple ID', @ResultReceivedAsCoupleID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CoupleResultsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Couple Results ID', @CoupleResultsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TBSuspicionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TB Suspicion ID', @TBSuspicionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @STIID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'STI ID', @STIID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @StartedCotrimoxazoleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Started Cotrimoxazole ID', @StartedCotrimoxazoleID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LinkedToCareID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Linked To Care ID', @LinkedToCareID, 'Lookup Data')
		return 1
	end

if not exists(select HealthUnitCode from HealthUnits where HealthUnitCode  = @WhereLinkedToCareID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Health Unit Code', @WhereLinkedToCareID, 'Health Units')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select VisitNo from HCTClientCard where VisitNo = @VisitNo)
begin
	update HCTClientCard set
		DistrictsID = @DistrictsID, HealthUnitCode = @HealthUnitCode, HSD = @HSD, CenterTypeID = @CenterTypeID,
		TestingPointID = @TestingPointID, AccompaniedByID = @AccompaniedByID, PreTestCounselingID = @PreTestCounselingID, 
		CounseledAsID = @CounseledAsID, HCTEntryPoint = @HCTEntryPoint, MaritalStatusID = @MaritalStatusID, 
		SexualPatnerNo = @SexualPatnerNo, TestedHIVBeforeID = @TestedHIVBeforeID, HIVTestThreeMonthsID = @HIVTestThreeMonthsID,
		HIVTestSixMonthsID = @HIVTestSixMonthsID, HIVTestTwelveMonthsID = @HIVTestTwelveMonthsID,
		ResultThreeMonthsID = @ResultThreeMonthsID, ResultSixMonthsID = @ResultSixMonthsID, 
		ResultTwelveMonthsID = @ResultTwelveMonthsID, NoTestsInTwelveMonthsID = @NoTestsInTwelveMonthsID, 
		PatnerTestedHIVID = @PatnerTestedHIVID, PatnerTypeID = @PatnerTypeID, PatnerResultID = @PatnerResultID,
		KnowAboutServiceID = @KnowAboutServiceID, ConsentID = @ConsentID, NoConsentReasonID = @NoConsentReasonID, 
		HIVResultID = @HIVResultID, TestDoneBy = @TestDoneBy, Designation = @Designation, TestDate = @TestDate, 
		ResultReceivedID = @ResultReceivedID, ResultReceivedAsCoupleID = @ResultReceivedAsCoupleID, 
		CoupleResultsID = @CoupleResultsID, TBSuspicionID = @TBSuspicionID, STIID = @STIID,
		StartedCotrimoxazoleID = @StartedCotrimoxazoleID, LinkedToCareID = @LinkedToCareID, 
		WhereLinkedToCareID = @WhereLinkedToCareID, ReferralReason = @ReferralReason,
		CounselorName = @CounselorName, CounselDate = @CounselDate, LoginID = @LoginID,
		ClientMachine = @ClientMachine
	where VisitNo = @VisitNo
return 0
end
	
else 
begin
	insert into HCTClientCard
		(VisitNo, DistrictsID, HealthUnitCode, HSD, CenterTypeID, TestingPointID, AccompaniedByID, PreTestCounselingID, CounseledAsID, 
		HCTEntryPoint, MaritalStatusID, SexualPatnerNo, TestedHIVBeforeID, HIVTestThreeMonthsID, HIVTestSixMonthsID, HIVTestTwelveMonthsID,
		ResultThreeMonthsID, ResultSixMonthsID, ResultTwelveMonthsID, NoTestsInTwelveMonthsID, PatnerTestedHIVID, PatnerTypeID,
		PatnerResultID, KnowAboutServiceID, ConsentID, NoConsentReasonID, HIVResultID, TestDoneBy, Designation, TestDate,
		ResultReceivedID, ResultReceivedAsCoupleID, CoupleResultsID, TBSuspicionID, STIID, StartedCotrimoxazoleID, LinkedToCareID,
		WhereLinkedToCareID, ReferralReason, CounselorName, CounselDate, LoginID, ClientMachine)
	values
		(@VisitNo, @DistrictsID, @HealthUnitCode, @HSD, @CenterTypeID, @TestingPointID, @AccompaniedByID, @PreTestCounselingID,
		@CounseledAsID, @HCTEntryPoint, @MaritalStatusID, @SexualPatnerNo, @TestedHIVBeforeID, @HIVTestThreeMonthsID,
		@HIVTestSixMonthsID, @HIVTestTwelveMonthsID, @ResultThreeMonthsID, @ResultSixMonthsID, @ResultTwelveMonthsID, 
		@NoTestsInTwelveMonthsID, @PatnerTestedHIVID, @PatnerTypeID, @PatnerResultID, @KnowAboutServiceID, @ConsentID, 
		@NoConsentReasonID, @HIVResultID, @TestDoneBy, @Designation, @TestDate, @ResultReceivedID, @ResultReceivedAsCoupleID,
		@CoupleResultsID, @TBSuspicionID, @STIID, @StartedCotrimoxazoleID, @LinkedToCareID, @WhereLinkedToCareID, @ReferralReason,
		@CounselorName, @CounselDate, @LoginID, @ClientMachine)
return 0
end

go


/******************************************************************************************************
exec uspInsertHCTClientCard
******************************************************************************************************/
-- select * from HCTClientCard
-- delete from HCTClientCard


-------------- Get HCTClientCard -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetHCTClientCard')
	drop proc uspGetHCTClientCard
go

create proc uspGetHCTClientCard(
@VisitNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

--if not exists(select VisitNo from HCTClientCard where VisitNo = @VisitNo)
--	begin
--		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'HCTClientCard')
--		return 1
--	end
--else
--begin
	select VisitNo, HCTClientCard.DistrictsID, dbo.GetLookupDataDes(HCTClientCard.DistrictsID) as District, 
	HCTClientCard.HealthUnitCode, HSD, CenterTypeID, dbo.GetLookupDataDes(CenterTypeID) as CenterType, 
	TestingPointID, dbo.GetLookupDataDes(TestingPointID) as TestingPoint, AccompaniedByID,
	 dbo.GetLookupDataDes(AccompaniedByID) as AccompaniedBy, PreTestCounselingID,
	  dbo.GetLookupDataDes(PreTestCounselingID) as PreTestCounseling, CounseledAsID,
	   dbo.GetLookupDataDes(CounseledAsID) as CounseledAs, HCTEntryPoint as HCTEntryPointID, 
	   dbo.GetLookupDataDes(HCTEntryPoint) as HCTEntryPoint, MaritalStatusID, 
	   dbo.GetLookupDataDes(MaritalStatusID) as MaritalStatus, SexualPatnerNo, 
	   TestedHIVBeforeID, dbo.GetLookupDataDes(TestedHIVBeforeID) as TestedHIVBefore, 
	   HIVTestThreeMonthsID, dbo.GetLookupDataDes(HIVTestThreeMonthsID) as HIVTestThreeMonths, 
	   HIVTestSixMonthsID, dbo.GetLookupDataDes(HIVTestSixMonthsID) as HIVTestSixMonths, 
	   HIVTestTwelveMonthsID, dbo.GetLookupDataDes(HIVTestTwelveMonthsID) as HIVTestTwelveMonths, 
	   ResultThreeMonthsID, dbo.GetLookupDataDes(ResultThreeMonthsID) as ResultThreeMonths,
	    ResultSixMonthsID, dbo.GetLookupDataDes(ResultSixMonthsID) as ResultSixMonths, ResultTwelveMonthsID,
	     dbo.GetLookupDataDes(ResultTwelveMonthsID) as ResultTwelveMonths, NoTestsInTwelveMonthsID, 
	     dbo.GetLookupDataDes(NoTestsInTwelveMonthsID) as NoTestsInTwelveMonths, PatnerTestedHIVID, 
	     dbo.GetLookupDataDes(PatnerTestedHIVID) as PatnerTestedHIV, PatnerTypeID, 
	     dbo.GetLookupDataDes(PatnerTypeID) as PatnerType, PatnerResultID, 
	     dbo.GetLookupDataDes(PatnerResultID) as PatnerResult, KnowAboutServiceID, 
	     dbo.GetLookupDataName(KnowAboutServiceID) as KnowAboutService, ConsentID, 
	     dbo.GetLookupDataDes(ConsentID) as Consent, NoConsentReasonID, 
	     dbo.GetLookupDataName(NoConsentReasonID) as NoConsentReason, HIVResultID, 
	     dbo.GetLookupDataDes(HIVResultID) as HIVResult, TestDoneBy, Designation, TestDate, ResultReceivedID, 
	     dbo.GetLookupDataDes(ResultReceivedID) as ResultReceived, ResultReceivedAsCoupleID, 
	     dbo.GetLookupDataDes(ResultReceivedAsCoupleID) as ResultReceivedAsCouple, CoupleResultsID, 
	     dbo.GetLookupDataDes(CoupleResultsID) as CoupleResults, TBSuspicionID,
	      dbo.GetLookupDataDes(TBSuspicionID) as TBSuspicion, STIID, dbo.GetLookupDataDes(STIID) as STI, 
	      StartedCotrimoxazoleID, dbo.GetLookupDataDes(StartedCotrimoxazoleID) as StartedCotrimoxazole,
	       LinkedToCareID, dbo.GetLookupDataDes(LinkedToCareID) as LinkedToCare, 
	       HCTClientCard.WhereLinkedToCareID, ReferralReason, CounselorName, CounselDate, HCTClientCard.LoginID, 
	       ClientMachine, RecordDateTime
	from HCTClientCard
	inner join HealthUnits on HCTClientCard.HealthUnitCode = HealthUnits.HealthUnitCode	
	inner join Logins on HCTClientCard.LoginID = Logins.LoginID	

	where VisitNo = @VisitNo
return 0
--end
go

/******************************************************************************************************
exec uspGetHCTClientCard '1300001002'
******************************************************************************************************/
-- select * from HCTClientCard
-- delete from HCTClientCard


------------------------------------------------------------------------------------------------------
-------------- RadiologyExaminations -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert RadiologyExaminations ----------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertRadiologyExaminations')
	drop proc uspInsertRadiologyExaminations
go

create proc uspInsertRadiologyExaminations(
@ExamCode varchar(20),
@ExamName varchar(40),
@RadiologyCategoriesID varchar(10),
@RadiologySiteID varchar(10),
@UnitPrice money,
@VATPercentage decimal =null,
@Hidden bit = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @ExamID Int
declare @RadiologyExamCodePrefix varchar(1)

if exists(select ExamCode from RadiologyExaminations where ExamCode = @ExamCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ExamCode)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @RadiologyCategoriesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Radiology Categories ID', @RadiologyCategoriesID, 'Lookup Data')
		return 1
	end

begin

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
set @VATPercentage = isnull(@VATPercentage, 0)
-------------------------------------------------------------------------------------
	set @RadiologyExamCodePrefix = dbo.GetOptionValue('RadiologyExamCodePrefix')
	set @ExamID = (select max(ExamID) from RadiologyExaminations where left(ExamCode, len(@RadiologyExamCodePrefix)) = @RadiologyExamCodePrefix)
	set @ExamID = dbo.GetNextAutoNumber('RadiologyExaminations', 'ExamCode', @ExamID)

insert into RadiologyExaminations
(ExamID, ExamCode, ExamName, RadiologyCategoriesID,RadiologySiteID,VATPercentage, UnitPrice, Hidden)
values
(@ExamID, @ExamCode, @ExamName, @RadiologyCategoriesID,@RadiologySiteID,@VATPercentage, @UnitPrice, @Hidden)
return 0
end
go

/******************************************************************************************************
exec uspInsertRadiologyExaminations 'E001', 'Obs Scan', '37S', 6000, 1
exec uspInsertRadiologyExaminations 'E002', 'Abd Scan', '37S', 32000
exec uspInsertRadiologyExaminations 'E003', 'Pelvic Scan', '37US', 15000
exec uspInsertRadiologyExaminations 'E004', 'Superficial Scan', '37OT', 8750
exec uspInsertRadiologyExaminations 'E005', 'Chest XRay', '37XR', 120000

******************************************************************************************************/
-- select * from RadiologyExaminations
-- delete from RadiologyExaminations


---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextRadiologyExamID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextRadiologyExamID')
	drop proc uspGetNextRadiologyExamID
go
create proc uspGetNextRadiologyExamID(
@ExamID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @RadiologyExamCodePrefix varchar(1)

set @RadiologyExamCodePrefix =dbo.GetOptionValue('RadiologyExamCodePrefix')

set @ExamID = (select max(ExamID) from RadiologyExaminations where left(ExamCode, len(@RadiologyExamCodePrefix)) = @RadiologyExamCodePrefix)
set @ExamID =  dbo.GetNextAutoNumber('RadiologyExaminations', 'ExamCode', @ExamID)

return 0
go



-------------- Update RadiologyExaminations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateRadiologyExaminations')
	drop proc uspUpdateRadiologyExaminations
go

create proc uspUpdateRadiologyExaminations(
@ExamCode varchar(20),
@ExamName varchar(40),
@RadiologyCategoriesID varchar(10),
@RadiologySiteID varchar(10),
@VATPercentage decimal,
@UnitPrice money,
@Hidden bit = null
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ExamCode from RadiologyExaminations where ExamCode = @ExamCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ExamCode, 'Radiology Examinations')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @RadiologyCategoriesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Radiology Categories ID', @RadiologyCategoriesID, 'Lookup Data')
		return 1
	end

begin

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

update RadiologyExaminations set
ExamName = @ExamName, RadiologyCategoriesID = @RadiologyCategoriesID,RadiologySiteID=@RadiologySiteID,VATPercentage=@VATPercentage, 
UnitPrice = @UnitPrice, Hidden = @Hidden
where ExamCode = @ExamCode

return 0
end
go

/******************************************************************************************************
exec uspUpdateRadiologyExaminations 'E001', 'Superficial', '37S', 8700, 0

******************************************************************************************************/
-- select * from RadiologyExaminations
-- delete from RadiologyExaminations

-------------- Get RadiologyExaminations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRadiologyExaminations')
	drop proc uspGetRadiologyExaminations
go

create proc uspGetRadiologyExaminations(
@ExamCode varchar(20) = null,
@Hidden bit = null
)with encryption as

declare @ErrorMSG varchar(200)

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

if not (@ExamCode is null)
begin
	if not exists(select ExamCode from RadiologyExaminations where ExamCode = @ExamCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ExamCode, 'Radiology Examinations')
		return 1
	end
	begin
		select ExamCode, ExamName, dbo.GetMergedNameCode(ExamName, ExamCode) as ExamFullName,
		RadiologyCategoriesID, dbo.GetLookupDataDes(RadiologyCategoriesID) as RadiologyCategories,
		RadiologySiteID,dbo.GetLookupDataDes(RadiologySiteID) as RadiologySites,
		VATPercentage, UnitPrice, Hidden
		from RadiologyExaminations
		where ExamCode = @ExamCode
	end
end
else
if  (@ExamCode is null)

begin
	select ExamCode, ExamName, dbo.GetMergedNameCode(ExamName, ExamCode) as ExamFullName,
	RadiologyCategoriesID, dbo.GetLookupDataDes(RadiologyCategoriesID) as RadiologyCategories,
	RadiologySiteID,dbo.GetLookupDataDes(RadiologySiteID) as RadiologySites,
	VATPercentage, UnitPrice, Hidden
	from RadiologyExaminations
	where Hidden = @Hidden
	order by ExamName
end
return 0
go


/******************************************************************************************************
exec uspGetRadiologyExaminations 'E001'
exec uspGetRadiologyExaminations

******************************************************************************************************/
-- select * from RadiologyExaminations
-- delete from RadiologyExaminations

------------------------------------------------------------------------------------------------------
-------------- RadiologyReports ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert RadiologyReports ---------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertRadiologyReports')
	drop proc uspInsertRadiologyReports
go

create proc uspInsertRadiologyReports(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ExamDateTime smalldatetime,
@Indication varchar(4000),
@Report varchar(4000),
@Conclusion varchar(4000),
@Radiologist varchar(10),
@RadiologyTitleID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Items')
		return 1
	end

if exists(select VisitNo from RadiologyReports where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID)
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Radiologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Radiologist', @Radiologist, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @RadiologyTitleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Radiology Title ID', @RadiologyTitleID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into RadiologyReports
(VisitNo, ItemCode, ItemCategoryID, ExamDateTime, Indication, Report, Conclusion, Radiologist, RadiologyTitleID, LoginID)
values
(@VisitNo, @ItemCode, @ItemCategoryID, @ExamDateTime, @Indication, @Report, @Conclusion, @Radiologist, @RadiologyTitleID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertRadiologyReports 'MED02001', 'E001', '7R', '22 Sep 2010 14:45', 'Report', 'Conclusion',
							   '100', 'Admin'

exec uspInsertRadiologyReports 'MED02001', 'E002', '7R', '22 Sep 2010 14:45', 'Report', 'Conclusion',
							   '100', 'Admin'

exec uspInsertRadiologyReports '100054001', 'E001', '7R', '22 Sep 2010 14:45', 'Report', 'Conclusion',
							   '100', 'Admin'

******************************************************************************************************/
-- select * from RadiologyReports
-- delete from RadiologyReports

-------------- Update RadiologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateRadiologyReports')
	drop proc uspUpdateRadiologyReports
go

create proc uspUpdateRadiologyReports(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ExamDateTime smalldatetime,
@Indication varchar(4000),
@Report varchar(4000),
@Conclusion varchar(4000),
@Radiologist varchar(10),
@RadiologyTitleID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from RadiologyReports where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Radiology Reports')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Radiologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Radiologist', @Radiologist, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @RadiologyTitleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Radiology Title ID', @RadiologyTitleID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
	update RadiologyReports set
	ExamDateTime = @ExamDateTime, Indication = @Indication, Report = @Report, Conclusion = @Conclusion, 
	Radiologist = @Radiologist, RadiologyTitleID = @RadiologyTitleID, LoginID = @LoginID
	where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	return 0
end
go

/******************************************************************************************************
exec uspUpdateRadiologyReports '100054001', 'E001', '7R', '20 Sep 2010 11:45', 'Report2', 'Conclusion2',
							   '101', 'Admin'

******************************************************************************************************/
-- select * from RadiologyReports
-- delete from RadiologyReports

-------------- Get RadiologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRadiologyReports')
	drop proc uspGetRadiologyReports
go

create proc uspGetRadiologyReports(
@VisitNo varchar(20),
@ItemCode varchar(20) = null,
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not @VisitNo is null and @ItemCode is null and @ItemCategoryID is null)
	begin
		select VisitNo, ItemCode, ItemCategoryID, ExamDateTime, Indication, Report, Conclusion, Radiologist, 
		dbo.GetItemName(ItemCategoryID, ItemCode) as ExamName, dbo.GetStaffName(Radiologist)as RadiologistName,
		dbo.GetStaffFullName(Radiologist)as RadiologistFullName,
		RadiologyTitleID, dbo.GetLookupDataDes(RadiologyTitleID) as RadiologyTitle
		from RadiologyReports
		where VisitNo = @VisitNo
	end
else
if (not @VisitNo is null and not @ItemCode is null and not @ItemCategoryID is null)
begin
	if not exists(select VisitNo from RadiologyReports where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Radiology Reports')
			return 1
		end
	else
	begin
		select VisitNo, ItemCode, ItemCategoryID, ExamDateTime, Indication, Report, Conclusion, Radiologist, 
		dbo.GetItemName(ItemCategoryID, ItemCode) as ExamName, dbo.GetStaffName(Radiologist)as RadiologistName,
		dbo.GetStaffFullName(Radiologist)as RadiologistFullName,
		RadiologyTitleID, dbo.GetLookupDataDes(RadiologyTitleID) as RadiologyTitle
		from RadiologyReports
		where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	end
end
return 0
go

/******************************************************************************************************
exec uspGetRadiologyReports '100970002', 'E001', '7R'
exec uspGetRadiologyReports '100970002'

******************************************************************************************************/
-- select * from RadiologyReports
-- delete from RadiologyReports

--------- GetSelfRequestRadiologyReports -------------------------------------------

if exists (select * from sysobjects where name = 'uspGetSelfRequestRadiologyReports')
	drop proc uspGetSelfRequestRadiologyReports
go

create proc uspGetSelfRequestRadiologyReports
(@VisitNo varchar(20) = null)
with encryption as

declare @ErrorMSG varchar(200)

declare @SelfRequestVisitCategoryID varchar(10)
declare @RecordDateTime smalldatetime

set @SelfRequestVisitCategoryID = dbo.GetLookupDataID('VisitCategory', 'S')
set @RecordDateTime = dateadd(hour, -12, getdate())

begin
if not (@VisitNo is null or @VisitNo = '')
	begin
		if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
			return 1
		end
		else
		begin
			select Patients.PatientNo,Visits.VisitNo,dbo.GetFullName(LastName,MiddleName,FirstName) as FullName,
			dbo.GetLookupDataDes(GenderID) as Gender,dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.FormatDate(VisitDate) as VisitDate,dbo.FormatDate(ExamDateTime) as ExamDate,
			dbo.GetTime(RadiologyReports.RecordDateTime) as SentTime, dbo.GetStaffName(Radiologist) as Radiologist 
			from Patients inner join visits on Patients.PatientNo = Visits.PatientNo
			inner join RadiologyReports on Visits.VisitNo = RadiologyReports.VisitNo
			where Visits.VisitCategoryID = @SelfRequestVisitCategoryID
			and Visits.VisitNo = @VisitNo and RadiologyReports.RecordDateTime >= @RecordDateTime
			order by  ExamDate desc, SentTime desc
		end
	end
else
	begin
		select Patients.PatientNo,Visits.VisitNo,dbo.GetFullName(LastName,MiddleName,FirstName) as FullName,
		dbo.GetLookupDataDes(GenderID) as Gender,dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.FormatDate(VisitDate) as VisitDate,dbo.FormatDate(ExamDateTime) as ExamDate,
		dbo.GetTime(RadiologyReports.RecordDateTime) as SentTime, dbo.GetStaffName(Radiologist) as Radiologist 
		from Patients inner join visits on Patients.PatientNo = Visits.PatientNo
		inner join RadiologyReports on Visits.VisitNo = RadiologyReports.VisitNo
		where Visits.VisitCategoryID = @SelfRequestVisitCategoryID and RadiologyReports.RecordDateTime >= @RecordDateTime
		order by  ExamDate desc, SentTime desc
	end
end
return 0
go

-----------------------------------------------------
--exec uspGetSelfRequestRadiologyReports '1112541002'
--exec uspGetSelfRequestRadiologyReports
-----------------------------------------------------

------------------------------------------------------------------------------------------------------
-------------- DentalReports -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert DentalReports ------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertDentalReports')
	drop proc uspInsertDentalReports
go

create proc uspInsertDentalReports(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReportDate smalldatetime,
@Report varchar(2000),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Items')
		return 1
	end

if exists(select VisitNo from DentalReports where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into DentalReports
(VisitNo, ItemCode, ItemCategoryID, ReportDate, Report, LoginID)
values
(@VisitNo, @ItemCode, @ItemCategoryID, @ReportDate, @Report, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertDentalReports '1115396001', 'INS', '7N', 'Report', 'Admin'
exec uspInsertDentalReports '1115390001', 'INS', '7N', 'Report', 'Admin'
exec uspInsertDentalReports '1115390001', 'EXT', '7N', 'Report', 'Admin'

******************************************************************************************************/
-- select * from DentalReports
-- delete from DentalReports

-------------- Update DentalReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateDentalReports')
	drop proc uspUpdateDentalReports
go

create proc uspUpdateDentalReports(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReportDate smalldatetime,
@Report varchar(2000),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from DentalReports where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Dental Reports')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
	update DentalReports set ReportDate = @ReportDate, Report = @Report, LoginID = @LoginID
	where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	return 0
end
go

/******************************************************************************************************
exec uspUpdateDentalReports  '1115396001', 'INS', '7N', 'Reported', 'Admin'

******************************************************************************************************/
-- select * from DentalReports
-- delete from DentalReports

-------------- Get DentalReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDentalReports')
	drop proc uspGetDentalReports
go

create proc uspGetDentalReports(
@VisitNo varchar(20),
@ItemCode varchar(20) = null,
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not @VisitNo is null and @ItemCode is null and @ItemCategoryID is null)
	begin
		select VisitNo, ItemCode, ItemCategoryID, ReportDate, Report, 
			dbo.GetItemName(ItemCategoryID, ItemCode) as DentalName
		from DentalReports
		where VisitNo = @VisitNo
	end
else
if (not @VisitNo is null and not @ItemCode is null and not @ItemCategoryID is null)
begin
	if not exists(select VisitNo from DentalReports where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Dental Reports')
			return 1
		end
	else
	begin
		select VisitNo, ItemCode, ItemCategoryID, ReportDate, Report, 
				dbo.GetItemName(ItemCategoryID, ItemCode) as DentalName
		from DentalReports
		where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	end
end
return 0
go

/******************************************************************************************************
exec uspGetDentalReports '1115396001', 'INS', '7N'
exec uspGetDentalReports '1115390001', 'INS', '7N'
exec uspGetDentalReports '1115390001'

******************************************************************************************************/
-- select * from DentalReports
-- delete from DentalReports

------------------------------------------------------------------------------------------------------
-------------- IPDDentalReports ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert IPDDentalReports ---------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertIPDDentalReports')
	drop proc uspInsertIPDDentalReports
go

create proc uspInsertIPDDentalReports(
@RoundNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReportDate smalldatetime,
@Report varchar(2000),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDItems where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'IPD Items')
		return 1
	end

if exists(select RoundNo from IPDDentalReports where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into IPDDentalReports
(RoundNo, ItemCode, ItemCategoryID, ReportDate, Report, LoginID)
values
(@RoundNo, @ItemCode, @ItemCategoryID, @ReportDate, @Report, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertIPDDentalReports '1115396001', 'INS', '7N', 'Report', 'Admin'
exec uspInsertIPDDentalReports '1115390001', 'INS', '7N', 'Report', 'Admin'
exec uspInsertIPDDentalReports '1115390001', 'EXT', '7N', 'Report', 'Admin'

******************************************************************************************************/
-- select * from IPDDentalReports
-- delete from IPDDentalReports

-------------- Update IPDDentalReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDDentalReports')
	drop proc uspUpdateIPDDentalReports
go

create proc uspUpdateIPDDentalReports(
@RoundNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReportDate smalldatetime,
@Report varchar(2000),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDDentalReports where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'IPD Dental Reports')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
	update IPDDentalReports set ReportDate = @ReportDate, Report = @Report, LoginID = @LoginID
	where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDDentalReports  '1115396001', 'INS', '7N', 'Reported', 'Admin'

******************************************************************************************************/
-- select * from IPDDentalReports
-- delete from IPDDentalReports

-------------- Get IPDDentalReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDDentalReports')
	drop proc uspGetIPDDentalReports
go

create proc uspGetIPDDentalReports(
@RoundNo varchar(20),
@ItemCode varchar(20) = null,
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not @RoundNo is null and @ItemCode is null and @ItemCategoryID is null)
	begin
		select RoundNo, ItemCode, ItemCategoryID, ReportDate, Report, 
			dbo.GetItemName(ItemCategoryID, ItemCode) as DentalName
		from IPDDentalReports
		where RoundNo = @RoundNo
	end
else
if (not @RoundNo is null and not @ItemCode is null and not @ItemCategoryID is null)
begin
	if not exists(select RoundNo from IPDDentalReports where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'IPD Dental Reports')
			return 1
		end
	else
	begin
		select RoundNo, ItemCode, ItemCategoryID, ReportDate, Report, 
				dbo.GetItemName(ItemCategoryID, ItemCode) as DentalName
		from IPDDentalReports
		where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	end
end
return 0
go

/******************************************************************************************************
exec uspGetIPDDentalReports '1115396001', 'INS', '7N'
exec uspGetIPDDentalReports '1115390001', 'INS', '7N'
exec uspGetIPDDentalReports '1115390001'

******************************************************************************************************/
-- select * from IPDDentalReports
-- delete from IPDDentalReports

------------------------------------------------------------------------------------------------------
-------------- TheatreOperations ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert TheatreOperations --------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertTheatreOperations')
	drop proc uspInsertTheatreOperations
go

create proc uspInsertTheatreOperations(
@VisitNo varchar(20),
@OperationDateTime smalldatetime,
@LeadSurgeon varchar(10)= null,
@OtherSurgeon varchar(200),
@LeadAnaesthetist varchar(10)= null,
@OtherAnaesthetist varchar(200),
@LeadNurse varchar(10),
@OtherNurse varchar(200),
@AnaesthesiaTypeID varchar(10),
@OperationClassID varchar(10),
@PreoperativeDiagnosis varchar(2000),
@PlannedProcedures varchar(2000),
@Report varchar(2000),
@PostoperativeInstructions varchar(2000),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if exists(select VisitNo from TheatreOperations where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo)
		return 1
	end

--if not exists(select StaffNo from Staff where StaffNo = @LeadSurgeon)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Lead Surgeon', @LeadSurgeon, 'Staff')
--		return 1
--	end

--if not exists(select StaffNo from Staff where StaffNo = @LeadAnaesthetist)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Lead Anaesthetist', @LeadAnaesthetist, 'Staff')
--		return 1
--	end

--if not exists(select StaffNo from Staff where StaffNo = @LeadNurse)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Lead Nurse', @LeadNurse, 'Staff')
--		return 1
--	end

if not exists(select DataID from LookupData where DataID = @AnaesthesiaTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Anaesthesia Type ID', @AnaesthesiaTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OperationClassID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Operation Class ID', @OperationClassID, 'Lookup Data')
		return 1
	end

if not (@LeadSurgeon is null or @LeadSurgeon = '') 
	begin
		if not exists(select StaffNo from Staff where StaffNo  = @LeadSurgeon)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Lead Surgeon', @LeadSurgeon, 'LeadSurgeon')
				return 1
			end
	end
else if (@LeadSurgeon is null or @LeadSurgeon = '')
begin set @LeadSurgeon = null end

if not (@LeadAnaesthetist is null or @LeadAnaesthetist = '') 
	begin
		if not exists(select StaffNo from Staff where StaffNo  = @LeadAnaesthetist)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Lead Anaesthetist', @LeadAnaesthetist, 'LeadAnaesthetist')
				return 1
			end
	end
else if (@LeadAnaesthetist is null or @LeadAnaesthetist= '')
begin set @LeadAnaesthetist = null end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end


begin
insert into TheatreOperations
(VisitNo, OperationDateTime, LeadSurgeon, OtherSurgeon, LeadAnaesthetist, OtherAnaesthetist, LeadNurse, OtherNurse, 
AnaesthesiaTypeID, OperationClassID, PreoperativeDiagnosis, PlannedProcedures, Report, PostoperativeInstructions, LoginID)
values
(@VisitNo, @OperationDateTime, @LeadSurgeon, @OtherSurgeon, @LeadAnaesthetist, @OtherAnaesthetist, @LeadNurse, @OtherNurse, 
@AnaesthesiaTypeID, @OperationClassID, @PreoperativeDiagnosis, @PlannedProcedures, @Report, @PostoperativeInstructions, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertTheatreOperations '1306964001', '30 apr 2013 14:30', '100', 'Other Surgeon', '102', 'Other ANA',
								'362', 'Other NUR', '10801', '10901', 'Pre Diag', 'Planned Proc', 'Report',
								'Instructions', 'Admin'

exec uspInsertTheatreOperations '1306964002', '30 apr 2013 14:30', '100', 'Other Surgeon', '102', 'Other ANA',
								'362', 'Other NUR', '10801', '10901', 'Pre Diag', 'Planned Proc', 'Report',
								'Instructions', 'Admin'

******************************************************************************************************/
-- select * from TheatreOperations
-- delete from TheatreOperationsf

-------------- Update TheatreOperations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateTheatreOperations')
	drop proc uspUpdateTheatreOperations
go

create proc uspUpdateTheatreOperations(
@VisitNo varchar(20),
@OperationDateTime smalldatetime,
@LeadSurgeon varchar(10) = null,
@OtherSurgeon varchar(200),
@LeadAnaesthetist varchar(10) = null,
@OtherAnaesthetist varchar(200),
@LeadNurse varchar(10),
@OtherNurse varchar(200),
@AnaesthesiaTypeID varchar(10),
@OperationClassID varchar(10),
@PreoperativeDiagnosis varchar(2000),
@PlannedProcedures varchar(2000),
@Report varchar(2000),
@PostoperativeInstructions varchar(2000),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from TheatreOperations where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Theatre Operations')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @AnaesthesiaTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Anaesthesia Type ID', @AnaesthesiaTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OperationClassID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Operation Class ID', @OperationClassID, 'Lookup Data')
		return 1
	end

if not (@LeadSurgeon is null or @LeadSurgeon = '') 
	begin
		if not exists(select StaffNo from Staff where StaffNo  = @LeadSurgeon)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Lead Surgeon', @LeadSurgeon, 'LeadSurgeon')
				return 1
			end
	end
else if (@LeadSurgeon is null or @LeadSurgeon = '')
begin set @LeadSurgeon = null end

if not (@LeadAnaesthetist is null or @LeadAnaesthetist = '') 
	begin
		if not exists(select StaffNo from Staff where StaffNo  = @LeadAnaesthetist)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Lead Anaesthetist', @LeadAnaesthetist, 'LeadAnaesthetist')
				return 1
			end
	end
else if (@LeadAnaesthetist is null or @LeadAnaesthetist= '')
begin set @LeadAnaesthetist = null end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update TheatreOperations set
OperationDateTime = @OperationDateTime, LeadSurgeon = @LeadSurgeon, OtherSurgeon = @OtherSurgeon, 
LeadAnaesthetist = @LeadAnaesthetist, OtherAnaesthetist = @OtherAnaesthetist, LeadNurse = @LeadNurse, 
OtherNurse = @OtherNurse, AnaesthesiaTypeID = @AnaesthesiaTypeID, OperationClassID = @OperationClassID, 
PreoperativeDiagnosis = @PreoperativeDiagnosis, PlannedProcedures = @PlannedProcedures, Report = @Report, 
PostoperativeInstructions = @PostoperativeInstructions, LoginID = @LoginID
where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateTheatreOperations '1306964002', '25 apr 2013 14:30', '100', 'Other Surgeon1', '430', 'Other ANA1',
								'361', 'Other NUR1', '10802', '10902', 'Pre Diag2', 'Planned Proc2', 'Report2',
								'Instructions2', 'Admin'
								
******************************************************************************************************/
-- select * from TheatreOperations
-- delete from TheatreOperations

-------------- Get TheatreOperations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTheatreOperations')
	drop proc uspGetTheatreOperations
go

create proc uspGetTheatreOperations(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select VisitNo, OperationDateTime, LeadSurgeon, dbo.GetStaffFullName(LeadSurgeon) as SurgeonFullName,
	OtherSurgeon, LeadAnaesthetist, dbo.GetStaffFullName(LeadAnaesthetist) as AnaesthetistFullName, 
	OtherAnaesthetist, LeadNurse, dbo.GetStaffFullName(LeadNurse) as NurseFullName, OtherNurse, 
	AnaesthesiaTypeID, dbo.GetLookupDataDes(AnaesthesiaTypeID) as AnaesthesiaType, 
	OperationClassID, dbo.GetLookupDataDes(OperationClassID) as OperationClass, 
	PreoperativeDiagnosis, PlannedProcedures, Report, PostoperativeInstructions
	from TheatreOperations
	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetTheatreOperations '1306964002'

******************************************************************************************************/
-- select * from TheatreOperations
-- delete from TheatreOperations

-----------DeleteTheatreOperations--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspDeleteTheatreOperations')
	drop proc uspDeleteTheatreOperations
go

create proc uspDeleteTheatreOperations(
@VisitNo varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @ItemStatusID varchar(10)
declare @ProcedureID varchar(10)
declare @TheatreID varchar(10)

set @ItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')

if not exists(select VisitNo from TheatreOperations where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16, 1, 'Visit No', @VisitNo, 'Theatre Operations')	
		return 1
	end

if  exists(select VisitNo from Items where VisitNo = @VisitNo and ItemStatusID <> @ItemStatusID
							and (ItemCategoryID = @ProcedureID or ItemCategoryID = @TheatreID)) 
	begin	
		set @ErrorMSG = 'The %s: %s, has procedure(s) and/or theatre service(s) that are not pending. You can''t delete this %s'
			raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo, 'Theatre Operations')
			return 1
	end
else
begin tran
	delete TheatreOperations where VisitNo = @VisitNo
if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
return 0
go

-- exec uspDeleteTheatreOperations '1012350009'
-- select * from TheatreOperations

------------------------------------------------------------------------------------------------------
-------------- IPDTheatreOperations ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert IPDTheatreOperations -----------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertIPDTheatreOperations')
	drop proc uspInsertIPDTheatreOperations
go

create proc uspInsertIPDTheatreOperations(
@RoundNo varchar(20),
@OperationDateTime smalldatetime,
@LeadSurgeon varchar(10),
@OtherSurgeon varchar(200),
@LeadAnaesthetist varchar(10) ,
@OtherAnaesthetist varchar(200),
@LeadNurse varchar(10),
@OtherNurse varchar(200),
@AnaesthesiaTypeID varchar(10),
@OperationClassID varchar(10),
@PreoperativeDiagnosis varchar(2000),
@PlannedProcedures varchar(2000),
@Report varchar(2000),
@PostoperativeInstructions varchar(2000),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDDoctor where RoundNo  = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'RoundNo', @RoundNo, 'IPD Doctor')
		return 1
	end

if exists(select RoundNo from IPDTheatreOperations where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'RoundNo', @RoundNo)
		return 1
	end


if not exists(select StaffNo from Staff where StaffNo = @LeadNurse)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lead Nurse', @LeadNurse, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AnaesthesiaTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Anaesthesia Type ID', @AnaesthesiaTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OperationClassID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Operation Class ID', @OperationClassID, 'Lookup Data')
		return 1
	end

--if not (@LeadSurgeon is null or @LeadSurgeon = '') 
--	begin
--		if not exists(select StaffNo from Staff where StaffNo  = @LeadSurgeon)
--			begin
--				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--				raiserror(@ErrorMSG, 16, 1, 'Lead Surgeon', @LeadSurgeon, 'LeadSurgeon')
--				return 1
--			end
--	end
--else if (@LeadSurgeon is null or @LeadSurgeon = '')
--begin set @LeadSurgeon = null end

--if not (@LeadAnaesthetist is null or @LeadAnaesthetist = '') 
--	begin
--		if not exists(select StaffNo from Staff where StaffNo  = @LeadAnaesthetist)
--			begin
--				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--				raiserror(@ErrorMSG, 16, 1, 'Lead Anaesthetist', @LeadAnaesthetist, 'LeadAnaesthetist')
--				return 1
--			end
--	end
--else if (@LeadAnaesthetist is null or @LeadAnaesthetist= '')
--begin set @LeadAnaesthetist = null end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into IPDTheatreOperations
(RoundNo, OperationDateTime, LeadSurgeon, OtherSurgeon, LeadAnaesthetist, OtherAnaesthetist, LeadNurse, OtherNurse, 
AnaesthesiaTypeID, OperationClassID, PreoperativeDiagnosis, PlannedProcedures, Report, PostoperativeInstructions, LoginID)
values
(@RoundNo, @OperationDateTime, @LeadSurgeon, @OtherSurgeon, @LeadAnaesthetist, @OtherAnaesthetist, @LeadNurse, @OtherNurse, 
@AnaesthesiaTypeID, @OperationClassID, @PreoperativeDiagnosis, @PlannedProcedures, @Report, @PostoperativeInstructions, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertIPDTheatreOperations '1064730102', '30 apr 2013 14:30', '100', 'Other Surgeon', '102', 'Other ANA',
								'362', 'Other NUR', '10801', '10901', 'Pre Diag', 'Planned Proc', 'Report',
								'Instructions', 'Admin'

exec uspInsertIPDTheatreOperations '13072070105', '30 apr 2013 14:30', '100', 'Other Surgeon', '102', 'Other ANA',
								'362', 'Other NUR', '10801', '10901', 'Pre Diag', 'Planned Proc', 'Report',
								'Instructions', 'Admin'

******************************************************************************************************/
-- select * from IPDTheatreOperations
-- delete from IPDTheatreOperationsf

-------------- Update IPDTheatreOperations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDTheatreOperations')
	drop proc uspUpdateIPDTheatreOperations
go

create proc uspUpdateIPDTheatreOperations(
@RoundNo varchar(20),
@OperationDateTime smalldatetime,
@LeadSurgeon varchar(10),
@OtherSurgeon varchar(200),
@LeadAnaesthetist varchar(10),
@OtherAnaesthetist varchar(200),
@LeadNurse varchar(10),
@OtherNurse varchar(200),
@AnaesthesiaTypeID varchar(10),
@OperationClassID varchar(10),
@PreoperativeDiagnosis varchar(2000),
@PlannedProcedures varchar(2000),
@Report varchar(2000),
@PostoperativeInstructions varchar(2000),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDTheatreOperations where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'RoundNo', @RoundNo, 'IPD Theatre Operations')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @LeadSurgeon)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lead Surgeon', @LeadSurgeon, 'Staff')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @LeadAnaesthetist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lead Anaesthetist', @LeadAnaesthetist, 'Staff')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @LeadNurse)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lead Nurse', @LeadNurse, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AnaesthesiaTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Anaesthesia Type ID', @AnaesthesiaTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OperationClassID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Operation Class ID', @OperationClassID, 'Lookup Data')
		return 1
	end

--if not (@LeadSurgeon is null or @LeadSurgeon = '') 
--	begin
--		if not exists(select StaffNo from Staff where StaffNo  = @LeadSurgeon)
--			begin
--				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--				raiserror(@ErrorMSG, 16, 1, 'Lead Surgeon', @LeadSurgeon, 'LeadSurgeon')
--				return 1
--			end
--	end
--else if (@LeadSurgeon is null or @LeadSurgeon = '')
--begin set @LeadSurgeon = null end

--if not (@LeadAnaesthetist is null or @LeadAnaesthetist = '') 
--	begin
--		if not exists(select StaffNo from Staff where StaffNo  = @LeadAnaesthetist)
--			begin
--				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--				raiserror(@ErrorMSG, 16, 1, 'Lead Anaesthetist', @LeadAnaesthetist, 'LeadAnaesthetist')
--				return 1
--			end
--	end
--else if (@LeadAnaesthetist is null or @LeadAnaesthetist= '')
--begin set @LeadAnaesthetist = null end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update IPDTheatreOperations set
OperationDateTime = @OperationDateTime, LeadSurgeon = @LeadSurgeon, OtherSurgeon = @OtherSurgeon, 
LeadAnaesthetist = @LeadAnaesthetist, OtherAnaesthetist = @OtherAnaesthetist, LeadNurse = @LeadNurse, 
OtherNurse = @OtherNurse, AnaesthesiaTypeID = @AnaesthesiaTypeID, OperationClassID = @OperationClassID, 
PreoperativeDiagnosis = @PreoperativeDiagnosis, PlannedProcedures = @PlannedProcedures, Report = @Report, 
PostoperativeInstructions = @PostoperativeInstructions, LoginID = @LoginID
where RoundNo = @RoundNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDTheatreOperations '13072070105', '25 apr 2013 14:30', '100', 'Other Surgeon1', '430', 'Other ANA1',
								'361', 'Other NUR1', '10802', '10902', 'Pre Diag2', 'Planned Proc2', 'Report2',
								'Instructions2', 'Admin'
								
******************************************************************************************************/
-- select * from IPDTheatreOperations
-- delete from IPDTheatreOperations

-------------- Get IPDTheatreOperations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDTheatreOperations')
	drop proc uspGetIPDTheatreOperations
go

create proc uspGetIPDTheatreOperations(
@RoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDTheatreOperations where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'RoundNo', @RoundNo, 'IPD Theatre Operations')
		return 1
	end
else
begin
	select RoundNo, OperationDateTime, LeadSurgeon, dbo.GetStaffFullName(LeadSurgeon) as SurgeonFullName,
	OtherSurgeon, LeadAnaesthetist, dbo.GetStaffFullName(LeadAnaesthetist) as AnaesthetistFullName, 
	OtherAnaesthetist, LeadNurse, dbo.GetStaffFullName(LeadNurse) as NurseFullName, OtherNurse, 
	AnaesthesiaTypeID, dbo.GetLookupDataDes(AnaesthesiaTypeID) as AnaesthesiaType, 
	OperationClassID, dbo.GetLookupDataDes(OperationClassID) as OperationClass, 
	PreoperativeDiagnosis, PlannedProcedures, Report, PostoperativeInstructions
	from IPDTheatreOperations
	where RoundNo = @RoundNo
return 0
end
go

/******************************************************************************************************
exec uspGetIPDTheatreOperations '1306964002'

******************************************************************************************************/
-- select * from IPDTheatreOperations
-- delete from IPDTheatreOperations

-----------DeleteIPDTheatreOperations------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspDeleteIPDTheatreOperations')
	drop proc uspDeleteIPDTheatreOperations
go

create proc uspDeleteIPDTheatreOperations(
@RoundNo varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @ItemStatusID varchar(10)
declare @ProcedureID varchar(10)
declare @TheatreID varchar(10)

set @ItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')

if not exists(select RoundNo from IPDTheatreOperations where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16, 1, 'Round No', @RoundNo, 'IPD Theatre Operations')	
		return 1
	end

if  exists(select RoundNo from IPDItems where RoundNo = @RoundNo and ItemStatusID <> @ItemStatusID
							and (ItemCategoryID = @ProcedureID or ItemCategoryID = @TheatreID)) 
	begin	
		set @ErrorMSG = 'The %s: %s, has procedure(s) and/or theatre service(s) that are not pending. You can''t delete this %s'
			raiserror(@ErrorMSG,16,1, 'Round No', @RoundNo, 'IPD Theatre Operations')
			return 1
	end
else
begin tran
	delete IPDTheatreOperations where RoundNo = @RoundNo
if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
return 0
go

-- exec uspDeleteIPDTheatreOperations '1012350009'
-- select * from IPDTheatreOperations

------------------------------------------------------------------------------------------------------
-------------- ExtraChargeItems ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ExtraChargeItems ---------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertExtraChargeItems')
	drop proc uspInsertExtraChargeItems
go

create proc uspInsertExtraChargeItems(
@ExtraItemCode varchar(20),
@ExtraItemName varchar(40),
@ExtraChargeCategoryID varchar(10),
@RevenueStreamCode  varchar(20),
@UnitCost money,
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
declare @ExtraItemID Int
declare @ExtraItemCodePrefix varchar(1)

if exists(select ExtraItemCode from ExtraChargeItems where ExtraItemCode = @ExtraItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ExtraItemCode)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ExtraChargeCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra Charge Category ID', @ExtraChargeCategoryID, 'Lookup Data')
		return 1
	end
begin
	set @ExtraItemCodePrefix = dbo.GetOptionValue('ExtraItemCodePrefix')
	set @ExtraItemID = (select max(ExtraItemID) from ExtraChargeItems where left(ExtraItemCode, len(@ExtraItemCodePrefix)) = @ExtraItemCodePrefix)
	set @ExtraItemID = dbo.GetNextAutoNumber('ExtraChargeItems', 'ExtraItemCode', @ExtraItemID)

insert into ExtraChargeItems
(ExtraItemID, ExtraItemCode, ExtraItemName, ExtraChargeCategoryID,RevenueStreamCode, UnitCost, UnitPrice,VATPercentage, Hidden)
values
(@ExtraItemID, @ExtraItemCode, @ExtraItemName, @ExtraChargeCategoryID,@RevenueStreamCode, @UnitCost, @UnitPrice,@VATPercentage, @Hidden)

return 0
end
go

/******************************************************************************************************
exec uspInsertExtraChargeItems 'FIL', 'File', 5000
exec uspInsertExtraChargeItems 'TOP', 'Top Up Fees', 25000

******************************************************************************************************/
-- select * from ExtraChargeItems
-- delete from ExtraChargeItems

---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextExtraItemID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextExtraItemID')
	drop proc uspGetNextExtraItemID
go
create proc uspGetNextExtraItemID(
@ExtraItemID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @ExtraItemCodePrefix varchar(1)

set @ExtraItemCodePrefix =dbo.GetOptionValue('ExtraItemCodePrefix')

set @ExtraItemID = (select max(ExtraItemID) from ExtraChargeItems where left(ExtraItemCode, len(@ExtraItemCodePrefix)) = @ExtraItemCodePrefix)
set @ExtraItemID =  dbo.GetNextAutoNumber('ExtraChargeItems', 'ExtraItemCode', @ExtraItemID)

return 0
go




-------------- Update ExtraChargeItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateExtraChargeItems')
	drop proc uspUpdateExtraChargeItems
go

create proc uspUpdateExtraChargeItems(
@ExtraItemCode varchar(20),
@ExtraItemName varchar(40),
@ExtraChargeCategoryID varchar(10),
@RevenueStreamCode varchar(20),
@UnitCost money,
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ExtraItemCode from ExtraChargeItems where ExtraItemCode = @ExtraItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ExtraItemCode, 'Extra Charge Items')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ExtraChargeCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra Charge Category ID', @ExtraChargeCategoryID, 'Lookup Data')
		return 1
	end
begin
update ExtraChargeItems set
ExtraItemName = @ExtraItemName, ExtraChargeCategoryID = @ExtraChargeCategoryID,RevenueStreamCode=@RevenueStreamCode, 
UnitCost = @UnitCost, UnitPrice = @UnitPrice,VATPercentage=@VATPercentage, Hidden = @Hidden
where ExtraItemCode = @ExtraItemCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateExtraChargeItems 'top', 'Top Up Fee', 45000

******************************************************************************************************/
-- select * from ExtraChargeItems
-- delete from ExtraChargeItems

-------------- Get ExtraChargeItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExtraChargeItems')
	drop proc uspGetExtraChargeItems
go

create proc uspGetExtraChargeItems(
@ExtraItemCode varchar(20) = null,
@Hidden bit = 0 
)with encryption as

declare @ErrorMSG varchar(200)

if not (@ExtraItemCode is null)
begin
	if not exists(select ExtraItemCode from ExtraChargeItems where ExtraItemCode = @ExtraItemCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Item Code', @ExtraItemCode, 'Extra Charge Items')
			return 1
		end
		begin
			select ExtraItemCode, ExtraItemName, ExtraChargeCategoryID, 
			dbo.GetLookupDataDes(ExtraChargeCategoryID) as ExtraChargeCategory, 
			ExtraChargeItems.RevenueStreamCode as RevenueStreamCode, RevenueStreams.Name as Name,UnitCost, UnitPrice, VATPercentage, 
			ExtraChargeItems.Hidden as Hidden,
			dbo.GetMergedNameCode(ExtraItemName, ExtraItemCode) as ExtraItemFullName 
			from ExtraChargeItems
			left outer join RevenueStreams on ExtraChargeItems.RevenueStreamCode=RevenueStreams.RevenueStreamCode
			where ExtraItemCode = @ExtraItemCode
		end
end 
else
if  (@ExtraItemCode is null)
	begin
		select ExtraItemCode, ExtraItemName, ExtraChargeCategoryID, 
		dbo.GetLookupDataDes(ExtraChargeCategoryID) as ExtraChargeCategory, 
		ExtraChargeItems.RevenueStreamCode as RevenueStreamCode, RevenueStreams.Name as Name,UnitCost, UnitPrice,VATPercentage, 
		ExtraChargeItems.Hidden as Hidden, dbo.GetMergedNameCode(ExtraItemName, ExtraItemCode) as ExtraItemFullName 
		from ExtraChargeItems
			left outer join RevenueStreams on ExtraChargeItems.RevenueStreamCode=RevenueStreams.RevenueStreamCode

		where ExtraChargeItems.Hidden = @Hidden
	end
return 0
go

/******************************************************************************************************
exec uspGetExtraChargeItems 'FIL'
exec uspGetExtraChargeItems
exec uspGetExtraChargeItems null, 1

******************************************************************************************************/
-- select * from ExtraChargeItems
-- delete from ExtraChargeItems

------------------------------------------------------------------------------------------------------
------------- Appointments ---------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Appointments--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAppointments')
	drop proc uspInsertAppointments
go

create proc uspInsertAppointments(
@PatientNo varchar(20) ,
@StartDate smalldatetime,
@AppointmentPrecisionID varchar(10) ,
@StartTime varchar(8) ,
@Duration smallint ,
@EndDate smalldatetime ,
@DoctorSpecialtyID varchar(10),
@StaffNo varchar(10) = null,
@AppointmentCategoryID varchar(10) = null,
@CommunityID varchar(10),
@AppointmentDes varchar(100) ,
@AppointmentStatusID varchar(10),
@LoginID varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

declare @PatientStatusID varchar(10)
declare @DeceasedStatusID varchar(10)
declare @InactiveStatusID varchar(10)

declare @RangePrecisionID varchar(10)
declare @ExactPrecisionID varchar(10)

if not exists(select PatientNo from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The Patient No: ' + @PatientNo + ', you are trying to enter does not exist in the registered patients'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AppointmentPrecisionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Appointment Precision ID', @AppointmentPrecisionID, 'Lookup Data')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DoctorSpecialtyID)
	begin
		set @ErrorMSG = 'The Doctor Specialty ID: ' + @DoctorSpecialtyID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not (@StaffNo is null or @StaffNo = '') 
	begin
		if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
				return 1
			end
	end
else if (@StaffNo is null or @StaffNo = '')
begin set @StaffNo = null end

if not (@AppointmentCategoryID is null or @AppointmentCategoryID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @AppointmentCategoryID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG,16,1, 'Appointment Category', @AppointmentCategoryID, 'Lookup Data')	
				return 1
			end
	end
else if (@AppointmentCategoryID is null or @AppointmentCategoryID = '')
begin set @AppointmentCategoryID = null end

if not exists(select DataID from LookupData where DataID = @CommunityID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Community ID', @CommunityID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AppointmentStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Appointment Status ID', @AppointmentStatusID, 'Lookup Data')	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if exists(select PatientNo from Appointments where PatientNo = @PatientNo and StartDate = @StartDate)
	begin
		set @ErrorMSG = 'The record with Patient No: %s and Start Date: ' + dbo.FormatDate(@StartDate) + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1, @PatientNo)	
		return 1
	end

 if @EndDate < @StartDate
	begin
		set @ErrorMSG = 'End Date can''t be before Start Date!'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if exists(select PatientNo from Appointments 
	  where (PatientNo = @PatientNo) and (@StartDate >= StartDate) and (@StartDate <= EndDate))
	begin
		set @ErrorMSG = 'Start Date falls in an appointment range that''s already registered!'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if exists(select PatientNo from Appointments 
	  where (PatientNo = @PatientNo) and (@EndDate >= StartDate) and (@EndDate <= EndDate))
	begin
		set @ErrorMSG = 'End Date falls in an appointment range that''s already registered!'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if exists(select PatientNo from Appointments 
	  where (PatientNo = @PatientNo) and (@StartDate <= StartDate) and (@EndDate >= EndDate))
	begin
		set @ErrorMSG = 'Entered range has an inner appointment range that''s already registered!'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else

----------------------------------------------------------------------------------------------------------
-- Ensure that Patient is not Deceased or Inactive

set @PatientStatusID = (select StatusID from Patients where PatientNo = @PatientNo)
set @DeceasedStatusID = dbo.GetLookupDataID('Status', 'D')
set @InactiveStatusID = dbo.GetLookupDataID('Status', 'I')

if (@PatientStatusID = @DeceasedStatusID) or (@PatientStatusID = @InactiveStatusID)
	begin
		set @ErrorMSG = 'The Patient No: ' + @PatientNo + ', you are trying to enter is not Active'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else

----------------------------------------------------------------------------------------------------------

begin

	set @RangePrecisionID = dbo.GetLookupDataID('AppointmentPrecision', 'R')
	set @ExactPrecisionID = dbo.GetLookupDataID('AppointmentPrecision', 'E')

	if @AppointmentPrecisionID = @RangePrecisionID
	begin
		set @StartTime = null
		set @Duration = null
	end
	--------------------------------------------------------------------------

	insert into Appointments
	(PatientNo, StartDate, AppointmentPrecisionID, StartTime, Duration, EndDate, 
	DoctorSpecialtyID, StaffNo, AppointmentDes,AppointmentCategoryID,CommunityID, AppointmentStatusID, LoginID) 
	values
	(@PatientNo, @StartDate, @AppointmentPrecisionID, @StartTime, @Duration, @EndDate, 
	@DoctorSpecialtyID, @StaffNo, @AppointmentDes,@AppointmentCategoryID,@CommunityID, @AppointmentStatusID, @LoginID)

	return 0
end
go

/*****************************************************************************************************************************
--1---------------------------------------------------------------------------------------------------------------------------

exec uspInsertAppointments '07000001', '29 Aug 2007', '26R', '02:30 PM', 0, '29 Aug 2007', '39GEN', '106', 'Routine Checkup', '21WT', 'Kutegz'
exec uspInsertAppointments '07000001', '25 Feb 2006', '26R', '02:30 PM', 0, '25 May 2006', '39GEN', '106', 'Routine Checkup', '21WT', 'Kutegz'

exec uspInsertAppointments '07000001', '20 Aug 2006', '26E', '10:30 PM', 30, '20 Aug 2006', '39GEN', '106', 'Routine Checkup', '21WT', 'Kutegz'
exec uspInsertAppointments '07000001', '21 Aug 2006', '26E', '03:00 PM', 60, '21 Dec 2006', '39GEN', '106', 'Routine Checkup', '21WT', 'Kutegz'

****************************************************************************************************************************/

-- select * from Appointments
-- delete from Appointments

---------Update Appointments-------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateAppointments')
	drop proc uspUpdateAppointments
go

create proc uspUpdateAppointments(
@PatientNo varchar(20) ,
@StartDate smalldatetime ,
@AppointmentPrecisionID varchar(10) ,
@StartTime varchar(8) ,
@Duration smallint ,
@EndDate smalldatetime ,
@DoctorSpecialtyID varchar(10),
@StaffNo varchar(10) = null,
@AppointmentCategoryID varchar(10) = null,
@CommunityID varchar(10),
@AppointmentDes varchar(100) ,
@AppointmentStatusID varchar(10),
@LoginID varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The Patient No: ' + @PatientNo + ', you are trying to enter does not exist in the registered patients'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AppointmentPrecisionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Appointment Precision ID', @AppointmentPrecisionID, 'Lookup Data')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DoctorSpecialtyID)
	begin
		set @ErrorMSG = 'The Doctor Specialty ID: ' + @DoctorSpecialtyID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not (@StaffNo is null or @StaffNo = '') 
	begin
		if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
				return 1
			end
	end
else if (@StaffNo is null or @StaffNo = '')
begin set @StaffNo = null end


if not (@AppointmentCategoryID is null or @AppointmentCategoryID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @AppointmentCategoryID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG,16,1, 'Appointment Category', @AppointmentCategoryID, 'Lookup Data')	
				return 1
			end
	end
else if (@AppointmentCategoryID is null or @AppointmentCategoryID = '')
begin set @AppointmentCategoryID = null end

if not exists(select DataID from LookupData where DataID = @CommunityID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Community ID', @CommunityID, 'Lookup Data')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @AppointmentStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Appointment Status ID', @AppointmentStatusID, 'Lookup Data')	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select PatientNo from Appointments where PatientNo = @PatientNo and StartDate = @StartDate)
	begin
		set @ErrorMSG = '%s: %s and %s: ' + dbo.FormatDate(@StartDate) + ', you are trying to enter does not exist %s'
		raiserror(@ErrorMSG,16,1, 'The record with Patient No', @PatientNo, 'Start Date', 'in the registered Appointments')	
		return 1		
	end

 if @EndDate < @StartDate
	begin
		set @ErrorMSG = 'End Date can''t be before Start Date!'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
begin
	update Appointments set
	--EndDate = @EndDate, 
	DoctorSpecialtyID = @DoctorSpecialtyID, StaffNo = @StaffNo, AppointmentStatusID = @AppointmentStatusID , AppointmentCategoryID= @AppointmentCategoryID,
	CommunityID= @CommunityID,AppointmentDes = @AppointmentDes, LoginID = @LoginID
	where PatientNo = @PatientNo and StartDate = @StartDate
	return 0
end
go

/*************************************************************************************
--1-----------------------------------------------------------------------------------
exec uspUpdateAppointments '07000001', '20 Aug 2006', '26E', '10:30 PM', 30, '20 Aug 2006', 
							'39GEN', '10', 'Monthly Checkup', '21WT', 'Admin'

*************************************************************************************/

-- select * from Appointments
-- delete from Appointments

--------Get Appointments-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAppointments')
	drop proc uspGetAppointments
go

create proc uspGetAppointments(
@PatientNo varchar(20),
@StartDate smalldatetime = null
)with encryption as

declare @ErrorMSG varchar(200)

exec uspUpdateMissedAppointments

if not (@StartDate is null)
begin
	if not exists(select PatientNo from Appointments where PatientNo = @PatientNo and StartDate = @StartDate)
		begin
			set @ErrorMSG = 'The Patient No: %s and Start Date: ' + dbo.FormatDate(@StartDate) + ', you''re trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG,16,1, @PatientNo, 'Appointments')	
			return 1
		end
	begin
		select PatientNo, dbo.FormatDate(StartDate) as StartDate, 
		AppointmentPrecisionID, dbo.GetLookupDataDes(AppointmentPrecisionID) as AppointmentPrecision, 
		StartTime, Duration, dbo.FormatDate(EndDate) as EndDate, 
		Appointments.DoctorSpecialtyID, dbo.GetLookupDataDes(Appointments.DoctorSpecialtyID) as DoctorSpecialty,
		Appointments.StaffNo, dbo.GetStaffFullName(Appointments.StaffNo) as StaffFullName, 
		AppointmentCategoryID,  dbo.GetLookupDataDes(AppointmentCategoryID) as AppointmentCategory,
		CommunityID,dbo.GetLookupDataDes(CommunityID) as Community,		
		AppointmentDes, AppointmentStatusID, dbo.GetLookupDataDes(AppointmentStatusID) as AppointmentStatus
		from Appointments	
		where PatientNo = @PatientNo and StartDate = @StartDate
	end
end
else

if (@StartDate is null)
	begin
		select  PatientNo, dbo.FormatDate(StartDate) as StartDate, 
		AppointmentPrecisionID, dbo.GetLookupDataDes(AppointmentPrecisionID) as AppointmentPrecision, 
		StartTime, Duration, dbo.FormatDate(EndDate) as EndDate, 
		Appointments.DoctorSpecialtyID, dbo.GetLookupDataDes(Appointments.DoctorSpecialtyID) as DoctorSpecialty,
		Appointments.StaffNo, dbo.GetStaffFullName(Appointments.StaffNo) as StaffFullName,
		AppointmentCategoryID,  dbo.GetLookupDataDes(AppointmentCategoryID) as AppointmentCategory,
		CommunityID,dbo.GetLookupDataDes(CommunityID) as Community,		
		AppointmentDes, AppointmentStatusID, dbo.GetLookupDataDes(AppointmentStatusID) as AppointmentStatus
		from Appointments 	
		where PatientNo = @PatientNo
	end

return 0

go

-- select * from Appointments
-- exec uspGetAppointments '07022060', null
-- exec uspGetAppointments '07000001', '20 Aug 2006'

-- dbo.GetMergedNameCode(AppointmentStatus.DataDes, AppointmentStatusID) as AppointmentStatus

----------------------------------------------------------------------------------------------------------------
-------------- GetTodayAppointments ----------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTodayAppointments')
	drop proc uspGetTodayAppointments
go

create proc uspGetTodayAppointments(
@StaffLoginID varchar(20) = null
)with encryption as

if not (@StaffLoginID is null)	
	begin
		select dbo.FormatText(Appointments.PatientNo, 'Patients', 'PatientNo') as PatientNo, 
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		Phone, dbo.FormatDate(StartDate) as StartDate, 
		dbo.GetLookupDataDes(AppointmentPrecisionID) as AppointmentPrecision, 
		StartTime, Duration, dbo.FormatDate(EndDate) as EndDate, 
		dbo.GetLookupDataDes(Appointments.DoctorSpecialtyID) as ToSeeSpecialty,
		AppointmentCategoryID,  dbo.GetLookupDataDes(Appointments.AppointmentCategoryID) as AppointmentCategory,
		Appointments.CommunityID,dbo.GetLookupDataDes(Appointments.CommunityID) as Community,		
		dbo.GetStaffName(Appointments.StaffNo) as ToSeeDoctor, AppointmentDes
		from Appointments 
		inner join Patients on Appointments.PatientNo = Patients.PatientNo
		where ((dbo.GetToVisitToday(StartDate, EndDate, AppointmentStatusID, getdate()) = 1 and 
				dbo.GetStaffLoginID(Appointments.StaffNo) = @StaffLoginID) or
			  (dbo.GetToVisitToday(StartDate, EndDate, AppointmentStatusID, getdate()) = 1 
			  and DoctorSpecialtyID = dbo.GetDoctorSpecialtyID(@StaffLoginID) and Appointments.StaffNo is null))
	end
else
begin
	select dbo.FormatText(Appointments.PatientNo, 'Patients', 'PatientNo') as PatientNo, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	Phone, dbo.FormatDate(StartDate) as StartDate, 
	dbo.GetLookupDataDes(AppointmentPrecisionID) as AppointmentPrecision, 
	StartTime, Duration, dbo.FormatDate(EndDate) as EndDate, 
	dbo.GetLookupDataDes(Appointments.DoctorSpecialtyID) as ToSeeSpecialty,
	AppointmentCategoryID,  dbo.GetLookupDataDes(Appointments.AppointmentCategoryID) as AppointmentCategory,
	Appointments.CommunityID,dbo.GetLookupDataDes(Appointments.CommunityID) as Community,
	dbo.GetStaffName(Appointments.StaffNo) as ToSeeDoctor, AppointmentDes
	from Appointments
	inner join Patients on Appointments.PatientNo = Patients.PatientNo
	where dbo.GetToVisitToday(StartDate, EndDate, AppointmentStatusID, getdate()) = 1
end

return 0
go

/***************************************************************************************************************
exec uspGetTodayAppointments
exec uspGetTodayAppointments 'Admin'

****************************************************************************************************************/
-- select * from Appointments


------------------------------------------------------------------------------------------------------
-------------- IPDPackageConsumption --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert IPDPackageConsumption -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertIPDPackageConsumption')
	drop proc uspInsertIPDPackageConsumption
go

create proc uspInsertIPDPackageConsumption(
@ExtraBillNo varchar(20),
@VisitNo varchar(20),
@PackageNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ItemStatusID varchar(10),
@Quantity int,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

declare @PackageVisitNo varchar(20)

----------------------------------------------------------------------------------------------------------------
set @PackageVisitNo = (select PackageVisitNo from PackageVisits where VisitNo = @VisitNo
and PackageNo = @PackageNo)
----------------------------------------------------------------------------------------------------------------
if not (@PackageNo is null or @PackageNo = '')	
	begin

if not exists(select ExtraBillNo from ExtraBillItems where ExtraBillNo  = @ExtraBillNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ExtraBillNo', @ExtraBillNo, 'ExtraBillItems')
		return 1
	end

if not exists(select PackageNo from Packages where PackageNo  = @PackageNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PackageNo', @PackageNo, 'Packages')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCategoryID', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if exists(select ExtraBillNo from IPDPackageConsumption where ExtraBillNo = @ExtraBillNo and PackageNo = @PackageNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'ExtraBillNo', @ExtraBillNo, 'PackageNo', @PackageNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID)
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemStatusID', @ItemStatusID, 'Lookup Data')
		return 1
	end

begin
insert into IPDPackageConsumption
(ExtraBillNo, VisitNo, PackageNo, ItemCode, ItemCategoryID,PackageVisitNo, ItemStatusID, Quantity, LoginID)
values
(@ExtraBillNo, @VisitNo, @PackageNo, @ItemCode, @ItemCategoryID,@PackageVisitNo, @ItemStatusID, @Quantity, @LoginID)
return 0
end
end
go

/******************************************************************************************************
exec uspInsertIPDPackageConsumption @ExtraBillNo, @VisitNo, @PackageNo, @ItemCode, @ItemCategoryID, @ItemStatusID, @Quantity, @LoginID
******************************************************************************************************/
-- select * from IPDPackageConsumption
-- delete from IPDPackageConsumption


-------------- Update IPDPackageConsumption -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDPackageConsumption')
	drop proc uspUpdateIPDPackageConsumption
go

create proc uspUpdateIPDPackageConsumption(
@ExtraBillNo varchar(20),
@VisitNo varchar(20),
@PackageNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ItemStatusID varchar(10),
@Quantity int,
@LoginID varchar(20),
@ClientMachine varchar(41),
@RecordDateTime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ExtraBillNo from IPDPackageConsumption where ExtraBillNo = @ExtraBillNo and PackageNo = @PackageNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ExtraBillNo', @ExtraBillNo, 'PackageNo', @PackageNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'IPDPackageConsumption')
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemStatusID', @ItemStatusID, 'Lookup Data')
		return 1
	end

begin
update IPDPackageConsumption set
VisitNo = @VisitNo, ItemStatusID = @ItemStatusID, Quantity = @Quantity, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
where ExtraBillNo = @ExtraBillNo and PackageNo = @PackageNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDPackageConsumption
******************************************************************************************************/
-- select * from IPDPackageConsumption
-- delete from IPDPackageConsumption


-------------- Get IPDPackageConsumption -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDPackageConsumption')
	drop proc uspGetIPDPackageConsumption
go

create proc uspGetIPDPackageConsumption(
@ExtraBillNo varchar(20),
@PackageNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ExtraBillNo from IPDPackageConsumption where ExtraBillNo = @ExtraBillNo and PackageNo = @PackageNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ExtraBillNo', @ExtraBillNo, 'PackageNo', @PackageNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'IPDPackageConsumption')
		return 1
	end
else
begin
	select ExtraBillNo, IPDPackageConsumption.VisitNo, PackageNo, ItemCode, ItemCategoryID, ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as [ItemStatusID], Quantity, LoginID, ClientMachine, RecordDateTime
	from IPDPackageConsumption
	
return 0
end
go

/******************************************************************************************************
exec uspGetIPDPackageConsumption
******************************************************************************************************/
-- select * from IPDPackageConsumption
-- delete from IPDPackageConsumption


------------------------------------------------------------------------------------------------------
-------------- ExtraBillsINT --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ExtraBillsINT -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditExtraBillsINT')
	drop proc uspEditExtraBillsINT
go


create proc uspEditExtraBillsINT(
@ExtraBillNo varchar(20),
@SyncStatus varchar(20),
@AgentID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select ExtraBillNo from ExtraBillsINT where ExtraBillNo = @ExtraBillNo)
begin
 
update ExtraBillsINT set
SyncStatus = @SyncStatus, RecordDateTime = getdate()
where ExtraBillNo = @ExtraBillNo and AgentID = @AgentID
end

else

begin
insert into ExtraBillsINT
(ExtraBillNo, SyncStatus, AgentID)
values
(@ExtraBillNo, @SyncStatus, @AgentID)

return 0
end
go

/******************************************************************************************************
exec uspInsertExtraBillsINT '478',0,'NAV'
******************************************************************************************************/
-- select * from ExtraBillsINT
-- delete from ExtraBillsINT




------------------------------------------------------------------------------------------------------
-------------- ExtraBills ----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ExtraBills ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertExtraBills')
	drop proc uspInsertExtraBills
go

create proc uspInsertExtraBills(
@ExtraBillNo varchar(20),
@VisitNo varchar(20),
@ExtraBillDate smalldatetime,
@VisitTypeID varchar(10) =null,
@StaffNo varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ExtraBillID int
declare @PaddingLEN tinyint

declare @PassedExtraBillID int
declare @PassedExtraBillNo varchar(20)
declare @PassedPatientNo varchar(20)

declare @AdmissionNo varchar(20)
declare @SmartAgentNo varchar(10)
declare @NAVisitTypeID varchar(10)

declare @PatientNo varchar(20)
set @NAVisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')
set @AdmissionNo = (select AdmissionNo from ExtraBills inner join  Admissions on Admissions.VisitNo = ExtraBills.VisitNo where ExtraBillNo  = @ExtraBillNo)
set @SmartAgentNo = dbo.GetLookupDataID('IntegrationAgent', 'SMART')

if exists(select ExtraBillNo from ExtraBills where ExtraBillNo = @ExtraBillNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo)
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if not (@VisitTypeID is null or @VisitTypeID = '') 
	begin
		if not exists(select DataID from LookupData where DataID = @VisitTypeID)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Visit Type ID', @VisitTypeID, 'Lookup Data')
				return 1
			end
	end
else if (@VisitTypeID is null or @VisitTypeID = '') begin set @VisitTypeID = @NAVisitTypeID end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

--------------------------------------------------------------------------------------------------------------

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'ExtraBills' and AutoColumnName = 'ExtraBillNo'

select @PatientNo = PatientNo from Visits where VisitNo = @VisitNo
set @PassedPatientNo = ltrim(rtrim(substring(@ExtraBillNo, 1, len(@ExtraBillNo) - @PaddingLEN)))

if (@PassedPatientNo = @PatientNo)

begin

	set @PassedExtraBillID = 1
	set @PassedExtraBillNo = @ExtraBillNo

	set @PassedExtraBillNo = ltrim(rtrim(substring(@PassedExtraBillNo, len(@PassedPatientNo) + 1, @PaddingLEN)))

	if isnumeric(@PassedExtraBillNo) = 1 set @PassedExtraBillID = @PassedExtraBillNo
	else set @PassedExtraBillID = 1

	set @ExtraBillID = (select max(ExtraBillID) from ExtraBills inner join Visits 
						on ExtraBills.VisitNo = Visits.VisitNo where PatientNo = @PatientNo)
	set @ExtraBillID = dbo.GetNextAutoNumber('ExtraBills', 'ExtraBillNo', @ExtraBillID)

	if @PassedExtraBillID < @ExtraBillID set @ExtraBillID = @PassedExtraBillID
	if @PassedExtraBillID > @ExtraBillID set @ExtraBillID = @PassedExtraBillID

end else set @ExtraBillID = 1

-----------------------------------------------------------------------------------------------------------------

insert into ExtraBills
(ExtraBillID, ExtraBillNo, VisitNo, ExtraBillDate,VisitTypeID, StaffNo, LoginID)
values
(@ExtraBillID, @ExtraBillNo, @VisitNo, @ExtraBillDate,@VisitTypeID, @StaffNo, @LoginID)

if dbo.GetOptionValue('ForceSmartCardProcessing') = 1 
begin 
if exists(select AdmissionNo from INTAdmissions where AgentNo = @SmartAgentNo and AdmissionNo = @AdmissionNo)
begin 
   exec uspEditINTExtraBills @SmartAgentNo, @ExtraBillNo, 0
end
end
return 0
end
go


/******************************************************************************************************
exec uspInsertExtraBills '120150401', '1201504001', '1 Feb 2012', 'Admin'
exec uspInsertExtraBills '120150402', '1201504001', '2 Feb 2012', 'Admin'
exec uspInsertExtraBills '120150403', '1201504001', '2 Feb 2012', 'Admin'

exec uspInsertExtraBills '110751101', '1107511005', '1 Feb 2012', 'Admin'

*******************************************************************************************************/
-- select * from ExtraBills
-- delete from ExtraBills

-------------- Update ExtraBills ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateExtraBills')
	drop proc uspUpdateExtraBills
go

create proc uspUpdateExtraBills(
@ExtraBillNo varchar(20),
@VisitNo varchar(20),
@ExtraBillDate smalldatetime,
@StaffNo varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ExtraBillNo from ExtraBills where ExtraBillNo = @ExtraBillNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Extra Bills')
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update ExtraBills set --VisitNo = @VisitNo, 
ExtraBillDate = @ExtraBillDate, StaffNo = @StaffNo, LoginID = @LoginID
where ExtraBillNo = @ExtraBillNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateExtraBills '120150403', '1201504001', '3 Feb 2012', 'Admin'

*******************************************************************************************************/
-- select * from ExtraBills
-- delete from ExtraBills

-------------- Get ExtraBills ------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExtraBills')
	drop proc uspGetExtraBills
go

create proc uspGetExtraBills(
@ExtraBillNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ExtraBillNo from ExtraBills where ExtraBillNo = @ExtraBillNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Extra Bills')
		return 1
	end
else
begin
	select ExtraBillID, ExtraBills.ExtraBillNo, ExtraBillDate, 
	ExtraBills.StaffNo, dbo.GetStaffName(ExtraBills.StaffNo) as StaffName, 
	dbo.GetStaffFullName(ExtraBills.StaffNo) as StaffFullName, 
	dbo.FormatText(ExtraBills.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatDate(Admissions.AdmissionDateTime) as VisitDate, dbo.FormatDate(JoinDate) as JoinDate,
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetAge(BirthDate, getdate()) as Age, dbo.GetLookupDataDes(GenderID) as Gender, 
	dbo.GetLookupDataDes(BillModesID) as BillMode, BillNo, 
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
	dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, 
    dbo.FormatMoney(dbo.GetCashAccountBalance(Patients.PatientNo)) as CashAccountBalance,
	dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	dbo.GetLookupDataDes(dbo.GetPatientVisitStatusID(Admissions.VisitNo)) as VisitStatus,
	dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo
	from ExtraBills
	left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
	inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
	inner join Patients on Admissions.PatientNo = Patients.PatientNo
	where ExtraBills.ExtraBillNo = @ExtraBillNo
	return 0
end
go

/******************************************************************************************************
exec uspGetExtraBills '140032312'

******************************************************************************************************/
-- select * from ExtraBills
-- delete from ExtraBills

--------GetExtraBillsByVisitNo------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExtraBillsByVisitNo')
	drop proc uspGetExtraBillsByVisitNo
go

create proc uspGetExtraBillsByVisitNo(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from ExtraBills where VisitNo = @VisitNo)
begin
	set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
	raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo, 'Extra Bills')	
	return 1
end
else
begin
	select ExtraBillDate, ExtraBillNo from ExtraBills
	where ExtraBills.VisitNo = @VisitNo order by ExtraBillDate, ExtraBillID, ExtraBillNo
end
return 0
go

-- select * from ExtraBills
-- exec uspGetExtraBillsByVisitNo '1203133001'

--------GetPeriodicExtraBills----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicExtraBills')
	drop proc uspGetPeriodicExtraBills
go

create proc uspGetPeriodicExtraBills(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as
begin
	select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,
		dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,			
		dbo.FormatText(ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,
		dbo.FormatDate(AdmissionDateTime) as VisitDate,
		dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
		dbo.GetStaffFullName(ExtraBills.StaffNo) as StaffFullName, 
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,
		dbo.GetLookupDataDes(GenderID) as Gender,
		dbo.GetAge(BirthDate, getdate()) as Age,
		dbo.GetLookupDataDes(BillModesID) as BillMode,
		dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
		dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue, 
		dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
		dbo.FormatDate(Admissions.RecordDateTime) as RecordDate,
		dbo.GetTime(Admissions.RecordDateTime) as RecordTime
	from ExtraBills
	inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
	inner join Patients on Admissions.PatientNo = Patients.PatientNo
	where ExtraBillDate between @StartDate and @EndDate
	order by ExtraBillDate desc, ExtraBillNo desc
end
return 0
go

-- select * from ExtraBills
-- exec uspGetPeriodicExtraBills 'Jan 1, 2012', 'Jan 30, 2013'

--------Get NextExtraBillID-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextExtraBillID')
	drop proc uspGetNextExtraBillID
go

create proc uspGetNextExtraBillID(
@VisitNo varchar(20) ,
@ExtraBillID int = null output
)with encryption as

declare @VisitNoPaddingLEN tinyint

set @VisitNoPaddingLEN = (select PaddingLEN from AutoNumbers where ObjectName = 'Visits' and AutoColumnName = 'VisitNo')

set @ExtraBillID = (select max(ExtraBillID) from ExtraBills where left(VisitNo,(len(VisitNo) - @VisitNoPaddingLEN)) = left(@VisitNo, (len(@VisitNo) - @VisitNoPaddingLEN)))
set @ExtraBillID = dbo.GetNextAutoNumber('ExtraBills', 'ExtraBillNo', @ExtraBillID)

return 0

go

-- exec uspGetNextExtraBillID '100468001'
-- select * from ExtraBills

--------Get ExtraBillNo-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExtraBillNo')
	drop proc uspGetExtraBillNo
go

create proc uspGetExtraBillNo(
@PatientNo varchar(20),
@ExtraBillDate smalldatetime = null output,
@ExtraBillNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)

if (@ExtraBillDate is null)
begin
	if not exists(select PatientNo from ExtraBills inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
													where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Patient No', @PatientNo, 'Extra Bills')	
		return 1
	end
	else
	begin
		set @ExtraBillNo = (select top 1 ExtraBillNo from ExtraBills inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
							where PatientNo = @PatientNo
							and ExtraBillDate = (select max(ExtraBillDate) from ExtraBills inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
							where PatientNo = @PatientNo)
							order by ExtraBillID desc)
	end
end
else
if not (@ExtraBillDate is null)
begin

if not exists(select PatientNo from ExtraBills inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
								where PatientNo = @PatientNo and ExtraBillDate = @ExtraBillDate)
	begin
		set @ErrorMSG = '%s: %s and %s: ' + dbo.FormatDate(@ExtraBillDate) + ', you are trying to enter does not exist %s'
		raiserror(@ErrorMSG,16,1, 'The record with Patient No', @PatientNo, 'Extra Bill Date', 'in the registered Extra Bills')	
		return 1
	end
	else
	begin
		set @ExtraBillNo = (select top 1 ExtraBillNo from ExtraBills inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
								where PatientNo = @PatientNo and ExtraBillDate = @ExtraBillDate order by ExtraBillID desc)
	end
end

return 0

go

-- select * from patients
-- exec  uspGetExtraBillNo '07022061'
-- exec uspGetExtraBillNo '07022061', '23 Jan 2007'

--------CountBillsExtraBillDate-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountBillsExtraBillDate')
	drop proc uspCountBillsExtraBillDate
go

create proc uspCountBillsExtraBillDate(
@VisitNo varchar(20),
@ExtraBillDate smalldatetime,
@Records tinyint = null output
)with encryption as

set @Records = (select count(ExtraBillNo) from ExtraBills 
				where VisitNo = @VisitNo and ExtraBillDate = @ExtraBillDate)
set @Records = isnull(@Records, 0)

return 0

go

-- exec uspCountBillsExtraBillDate '123', '19 Oct 2011'

--------CountAdmissionBillDate-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountAdmissionBillDate')
	drop proc uspCountAdmissionBillDate
go

create proc uspCountAdmissionBillDate(
@VisitNo varchar(20),
@ExtraBillDate smalldatetime,
@Records tinyint = null output
)with encryption as

declare @ItemCategoryID varchar(10)
set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'A')

set @Records = (select count(ExtraBillItems.ExtraBillNo) from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				where VisitNo = @VisitNo and ExtraBillDate = @ExtraBillDate and ItemCategoryID = @ItemCategoryID)
								
set @Records = isnull(@Records, 0)

return 0

go

-- exec uspCountAdmissionBillDate '1319200002', '28 Dec 2013'

------------------------------------------------------------------------------------------------------
-------------- ExtraBillsEXT -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ExtraBillsEXT ------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertExtraBillsEXT')
	drop proc uspInsertExtraBillsEXT
go

create proc uspInsertExtraBillsEXT(
@ExtraBillNo varchar(20),
@RoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ExtraBillNo from ExtraBills where ExtraBillNo  = @ExtraBillNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Extra Bills')
		return 1
	end

if not exists(select RoundNo from IPDDoctor where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPD Doctor')	
		return 1
	end

if exists(select ExtraBillNo from ExtraBillsEXT where ExtraBillNo = @ExtraBillNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo)
		return 1
	end

begin
insert into ExtraBillsEXT
(ExtraBillNo, RoundNo)
values
(@ExtraBillNo, @RoundNo)
return 0
end
go

/******************************************************************************************************
exec uspInsertExtraBillsEXT
******************************************************************************************************/
-- select * from ExtraBillsEXT
-- delete from ExtraBillsEXT

-------------- Update ExtraBillsEXT ------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateExtraBillsEXT')
	drop proc uspUpdateExtraBillsEXT
go

create proc uspUpdateExtraBillsEXT(
@ExtraBillNo varchar(20),
@RoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ExtraBillNo from ExtraBillsEXT where ExtraBillNo = @ExtraBillNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Extra Bills EXT')
		return 1
	end

begin
	update ExtraBillsEXT set RoundNo = @RoundNo
	where ExtraBillNo = @ExtraBillNo
	return 0
end
go

/******************************************************************************************************
exec uspUpdateExtraBillsEXT
******************************************************************************************************/
-- select * from ExtraBillsEXT
-- delete from ExtraBillsEXT

-------------- Get ExtraBillsEXT -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExtraBillsEXT')
	drop proc uspGetExtraBillsEXT
go

create proc uspGetExtraBillsEXT(
@ExtraBillNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ExtraBillNo from ExtraBillsEXT where ExtraBillNo = @ExtraBillNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Extra Bills EXT')
		return 1
	end
else
begin
	select ExtraBillNo, RoundNo
	from ExtraBillsEXT
	where ExtraBillNo = @ExtraBillNo
return 0
end
go

/******************************************************************************************************
exec uspGetExtraBillsEXT
******************************************************************************************************/
-- select * from ExtraBillsEXT
-- delete from ExtraBillsEXT

-------------- GetExtraBillsEXTExtraBillNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExtraBillsEXTExtraBillNo')
	drop proc uspGetExtraBillsEXTExtraBillNo
go

create proc uspGetExtraBillsEXTExtraBillNo(
@RoundNo varchar(20),
@ExtraBillNo varchar(20) = null output
)with encryption as

begin
	set @ExtraBillNo = (select top 1 ExtraBillNo from ExtraBillsEXT where RoundNo = @RoundNo)
	return 0
end
go

/******************************************************************************************************
exec uspGetExtraBillsEXTExtraBillNo
******************************************************************************************************/
-- select * from ExtraBillsEXT
-- delete from ExtraBillsEXT


-------------- ExtraBillItems ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ExtraBillItems -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditExtraBillItems')
	drop proc uspEditExtraBillItems
go

create proc uspEditExtraBillItems(
@ExtraBillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Quantity int,
@UnitPrice money,
@Notes varchar(200),
@LastUpdate smalldatetime,
@PayStatusID varchar(10),
@EntryModeID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40) = null,
@CreatorLoginID varchar(20),
@CreatorClientMachine varchar(40)

)with encryption as

declare @ErrorMSG varchar(200)
declare @NotPaidPayStatusID  varchar(10)
declare @ManualEntryModeID varchar(10)
declare @UnitCost money
declare @ItemName varchar(800)
declare @UnitMeasure varchar(100)
declare @VATValue money
declare @VisitNo varchar(20)
declare @PackageNo varchar(20)
declare @ItemStatusID varchar(10)
declare @NAPayStatusID varchar(10)

set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @ManualEntryModeID = dbo.GetLookupDataID('EntryMode', 'MAN')
set @VATValue= dbo.GetVATValue(@ItemCategoryID, @ItemCode, @Quantity,@UnitPrice)
set @ItemStatusID = dbo.GetLookupDataID('Itemstatus', 'O')
set @NAPayStatusID = dbo.GetLookupDataID('PayStatus', 'NA')
------------------------------------------------------------------------------------------------------------
set @ItemName = dbo.GetItemName(@ItemCategoryID, @ItemCode)
set @UnitMeasure = dbo.GetUnitMeasure(@ItemCategoryID,@ItemCode)

--------------------------------------------------------------------------------------------------
set @UnitCost = dbo.GetItemUnitCost(@ItemCategoryID, @ItemCode)
declare @AdmissionNo varchar(20)
declare @SmartAgentNo varchar(10)

declare @PatientNo varchar(20)
set @AdmissionNo = (select AdmissionNo from ExtraBills inner join  Admissions on Admissions.VisitNo = ExtraBills.VisitNo where ExtraBillNo  = @ExtraBillNo)
set @SmartAgentNo = 'SMART'

if  (@ClientMachine is null or @ClientMachine = '') begin set @ClientMachine = host_name() end
--------------------------------------------------------------------------------------------------

if not exists(select ExtraBillNo from ExtraBills where ExtraBillNo = @ExtraBillNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Extra Bills')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Lookup Data')
		return 1
	end
	
if not exists(select DataID from LookupData where DataID = @PayStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pay Status ID', @PayStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EntryModeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Entry Mode ID', @EntryModeID, 'Lookup Data')
		return 1
	end


if not exists(select LoginID from Logins where LoginID = @CreatorLoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @CreatorLoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end


if exists(select ExtraBillNo from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		
		set @ErrorMSG = 'The record with %s: %s and  %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', already exists!'
		raiserror(@ErrorMSG,16,1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode , 'Item Category')	
		return 1
	end
else
begin
insert into ExtraBillItems
(ExtraBillNo, ItemCode, ItemCategoryID,ItemName,UnitMeasure, Quantity, UnitCost, UnitPrice,VATValue, Notes, LastUpdate, PayStatusID, EntryModeID, 
OriginalQuantity, OriginalPrice, LoginID, ClientMachine,CreatorLoginID,CreatorClientMachine)
values
(@ExtraBillNo, @ItemCode, @ItemCategoryID,@ItemName,@UnitMeasure, @Quantity, @UnitCost, @UnitPrice,@VATValue, @Notes, @LastUpdate, @PayStatusID, @EntryModeID,
 @Quantity, @UnitPrice, @LoginID, @ClientMachine,@CreatorLoginID,@CreatorClientMachine)

-------------------------------------------------------------------------------------------
set @VisitNo =dbo.GetExtraBillVisitNo(@ExtraBillNo)
set @PackageNo = dbo.GetVisitPackageNo(@VisitNo)
-------------------------------------------------------------------------------------------

if (@PayStatusID = @NAPayStatusID) and not (@PackageNo is null or @PackageNo = '')
begin
 exec uspInsertIPDPackageConsumption @ExtraBillNo, @VisitNo, @PackageNo, @ItemCode, @ItemCategoryID, @ItemStatusID, @Quantity, @LoginID
end


if dbo.GetOptionValue('ForceSmartCardProcessing') = 1
begin
if exists(select AdmissionNo from INTAdmissions where AgentNo = @SmartAgentNo and AdmissionNo = @AdmissionNo)
begin 
   exec uspEditINTExtraBillItems @SmartAgentNo, @ExtraBillNo, @ItemCategoryID, @ItemCode, 0
end
end

return 0
end
go
/******************************************************************************************************
exec uspEditExtraBillItems '120150401', '10C', '7S', 1, 10000, '', '18 Feb 2012', '12NP', 'Admin'
exec uspEditExtraBillItems '120150401', 'MEX', '7S', 1, 12000, '', '18 Feb 2012', '12NP', 'Admin'

exec uspEditExtraBillItems '120150401', 'M031', '7D', 8, 2000, '', '18 Feb 2012', '12NP', 'Admin'
exec uspEditExtraBillItems '120150401', 'M012', '7D', 3, 9500, '', '18 Feb 2012', '12NP', 'Admin'

exec uspEditExtraBillItems '120150401', 'T138', '7T', 1, 21000, '', '18 Feb 2012', '12NP', 'Admin'
exec uspEditExtraBillItems '120150401', 'T106', '7T', 1, 30500, '', '18 Feb 2012', '12NP', 'Admin'
exec uspEditExtraBillItems '120150401', 'T117', '7T', 1, 55100, '', '18 Feb 2012', '12NP', 'Admin'

exec uspEditExtraBillItems '120150401', 'R006', '7R', 1, 2000, '', '18 Feb 2012', '12NP', 'Admin'
exec uspEditExtraBillItems '120150401', 'R016', '7R', 1, 4500, '', '18 Feb 2012', '12NP', 'Admin'

exec uspEditExtraBillItems '120150401', '040', '7P', 1, 3000, '', '18 Feb 2012', '12NP', 'Admin'
exec uspEditExtraBillItems '120150401', '011', '7P', 1, 1500, '', '18 Feb 2012', '12NP', 'Admin'

exec uspEditExtraBillItems '120150401', '6.3', '7N', 2, 3000, '', '18 Feb 2012', '12NP', 'Admin'
exec uspEditExtraBillItems '120150401', '9.3', '7N', 3, 8500, '', '18 Feb 2012', '12NP', 'Admin'

exec uspEditExtraBillItems '120150401', 'IMM', '7E', 1, 4200, '', '18 Feb 2012', '12NP', 'Admin'
exec uspEditExtraBillItems '120150401', 'ADM', '7E', 1, 1500, '', '18 Feb 2012', '12NP', 'Admin'

exec uspEditExtraBillItems '110751101', '10C', '7S', 1, 10000, '', '18 Feb 2012', '12NP', 'Admin'

******************************************************************************************************/
-- select * from ExtraBillItems
-- delete from ExtraBillItems
-- select * from ExtraBills

-----------------Update ExtraBillItems--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateExtraBillItems')
	drop proc uspUpdateExtraBillItems
go

create proc uspUpdateExtraBillItems(
@ExtraBillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@LastUpdate smalldatetime ,
@PayStatusID varchar(10),
@LoginID varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @NotPaidPayStatus  varchar(10)

set @NotPaidPayStatus = dbo.GetLookupDataID('PayStatus', 'NP')

if not exists(select ExtraBillNo from ExtraBillItems where ExtraBillNo = @ExtraBillNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with Extra Bill No: %s and Item Code: %s and Item Category: %s, does not exist in registered %s'
		raiserror(@ErrorMSG, 16, 1, @ExtraBillNo, @ItemCode, @ItemCategoryID, 'Extra Bill Items')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayStatusID)
	begin
		set @ErrorMSG = 'The Pay Status ID: ' + @PayStatusID + ', you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lookup Data')	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16, 1, 'Logins')	
		return 1
	end
else

begin
	if not exists(select ExtraBillNo from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode 
				  and ItemCategoryID = @ItemCategoryID and PayStatusID = @NotPaidPayStatus)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', is already ' + dbo.GetLookupDataDes(@PayStatusID) + ''
			raiserror(@ErrorMSG,16,1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category')	
			return 1
		end

	update ExtraBillItems 
	set LastUpdate = @LastUpdate, PayStatusID = @PayStatusID , LoginID = @LoginID 
	where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
end

return 0
go

/*--------------------------------------------------------------------------------------------------------
-- select * from ExtraBillItems
-- exec uspUpdateExtraBillItems '110751101', '10C', '7S', '18 Feb 2012', '12PF', 'Admin'
---------------------------------------------------------------------------------------------------------*/

-------------- Get ExtraBillItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExtraBillItems')
	drop proc uspGetExtraBillItems
go

create proc uspGetExtraBillItems(
@ExtraBillNo varchar(20) = null,
@ItemCategoryID varchar(10) = null,
@VisitNo varchar(20) = null,
@PayStatusID varchar(10)= null,
@BillAccount varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)


if not (@ExtraBillNo is null) and not (@ItemCategoryID is null) 
	and (@VisitNo is null) and (@PayStatusID is null) and (@BillAccount is null)
	begin
		select ExtraBillNo, ItemCode,ItemName, ExtraBillItems.InvoiceNo, UnitMeasure,
		dbo.GetMergedNameCode(dbo.GetItemName(ItemCategoryID, ItemCode), ItemCode) as ItemFullName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, UnitPrice, 
		Quantity,  Quantity* UnitPrice as Amount, Notes, LastUpdate, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode
		from ExtraBillItems
		where ExtraBillNo = @ExtraBillNo and ItemCategoryID = @ItemCategoryID
	end
else if exists(select AdmissionNo from Admissions where Admissions.VisitNo = @VisitNo)
	and  (@ExtraBillNo is null) and (@ItemCategoryID is null) 
	and not (@VisitNo is null) and not (@PayStatusID is null) and not (@BillAccount is null)
	begin
		select BillNo, dbo.FormatText(ExtraBills.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		ExtraBillDate, ExtraBillItems.ItemCode,ItemName, ExtraBillItems.InvoiceNo,
		ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, UnitPrice, 
        Quantity,  Quantity* UnitPrice as Amount, Notes, LastUpdate, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, CashAmount,
		CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus, 
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo
		from ExtraBillItems
		left outer join ExtraBillItemsCASH on ExtraBillItemsCASH.ExtraBillNo = ExtraBillItems.ExtraBillNo 
		and ExtraBillItemsCASH.ItemCode = ExtraBillItems.ItemCode and ExtraBillItemsCASH.ItemCategoryID = ExtraBillItems.ItemCategoryID
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo					
		where ExtraBills.VisitNo = @VisitNo and PayStatusID = @PayStatusID and BillNo = @BillAccount
	end

	else if not exists(select AdmissionNo from Admissions where Admissions.VisitNo = @VisitNo)
	and (@ExtraBillNo is null) and (@ItemCategoryID is null) 
	and not (@VisitNo is null) and not (@PayStatusID is null) and not (@BillAccount is null)
	begin
		select BillNo, dbo.FormatText(ExtraBills.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		ExtraBillDate, ExtraBillItems.ItemCode,ItemName, ExtraBillItems.InvoiceNo,
		ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, UnitPrice, 
        Quantity,  Quantity* UnitPrice as Amount, Notes, LastUpdate, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, CashAmount,
		CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus, 
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo
		from ExtraBillItems
		left outer join ExtraBillItemsCASH on ExtraBillItemsCASH.ExtraBillNo = ExtraBillItems.ExtraBillNo 
		and ExtraBillItemsCASH.ItemCode = ExtraBillItems.ItemCode and ExtraBillItemsCASH.ItemCategoryID = ExtraBillItems.ItemCategoryID
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		left outer join Visits on ExtraBills.VisitNo = Visits.VisitNo					
		where ExtraBills.VisitNo = @VisitNo and PayStatusID = @PayStatusID and BillNo = @BillAccount
	end

return 0

go
/******************************************************************************************************
exec uspGetExtraBillItems '111012901', '7D'
exec uspGetExtraBillItems '120460201', '7D'
exec uspGetExtraBillItems null, null, '180015001', '12NP', 'Cash'
exec uspGetExtraBillItems null, null, '10605001', '12NP', 'A180022'


******************************************************************************************************/
-- select * from ExtraBillItems
-- delete from ExtraBillItems


--------Get Visit ExtraBillItems By Invoice Status----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisitExtraBillItemsByInvoiceStatus')
	drop proc uspGetVisitExtraBillItemsByInvoiceStatus
go

create proc uspGetVisitExtraBillItemsByInvoiceStatus(
@VisitNo varchar(20),
@InvoiceStatus bit= 0
)with encryption as

declare @NotPaidPayStatusID varchar(10)

--------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
--------------------------------------------------------------------------
if exists(select AdmissionNo from Admissions where Admissions.VisitNo = @VisitNo)
begin
if @InvoiceStatus = 0
begin
	select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, InvoiceNo,
	dbo.FormatDate(ExtraBillDate) as ExtraBillDate,dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, 
	Quantity, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice,
	UnitPrice, Quantity * UnitPrice as Amount, MemberCardNo, MainMemberName, ClaimReferenceNo, 
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
	dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
	dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode,
	dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
	dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
	from ExtraBillItems 
	inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo							
	inner join Patients on Admissions.PatientNo = Patients.PatientNo
			
	where  (InvoiceNo ='' or InvoiceNo is null) and Admissions.VisitNo = @VisitNo and PayStatusID = @NotPaidPayStatusID
	order by ExtraBills.ExtraBillNo desc
	
end

else if @InvoiceStatus = 1
begin
	select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, InvoiceNo,
	dbo.FormatDate(ExtraBillDate) as ExtraBillDate,dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, 
	Quantity, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice,
     UnitPrice, Quantity*UnitPrice as Amount, MemberCardNo, MainMemberName, ClaimReferenceNo, 
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
	dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
	dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode,
	dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
	dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
	from ExtraBillItems 
	inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo							
	inner join Patients on Admissions.PatientNo = Patients.PatientNo
	where not (InvoiceNo ='' or InvoiceNo is null) and Admissions.VisitNo = @VisitNo and  PayStatusID = @NotPaidPayStatusID
	order by ExtraBills.ExtraBillNo desc
	

end
end
if not exists(select AdmissionNo from Admissions where Admissions.VisitNo = @VisitNo)
begin

if @InvoiceStatus = 0
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, InvoiceNo,
	dbo.FormatDate(ExtraBillDate) as ExtraBillDate,dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, 
	Quantity, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice,
	UnitPrice, Quantity * UnitPrice as Amount, MemberCardNo, MainMemberName, ClaimReferenceNo, 
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
	dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode,
	dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
	dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
	from ExtraBillItems 
	inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join Visits on ExtraBills.VisitNo = Visits.VisitNo							
	inner join Patients on Visits.PatientNo = Patients.PatientNo
			
	where  (InvoiceNo ='' or InvoiceNo is null) and Visits.VisitNo = @VisitNo and PayStatusID = @NotPaidPayStatusID
	order by ExtraBills.ExtraBillNo desc
	
end

else if @InvoiceStatus = 1
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, InvoiceNo,
	dbo.FormatDate(ExtraBillDate) as ExtraBillDate,dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, 
	Quantity, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice,
     UnitPrice, Quantity*UnitPrice as Amount, MemberCardNo, MainMemberName, ClaimReferenceNo, 
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
	dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode,
	dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
	dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
	from ExtraBillItems 
	inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join Visits on ExtraBills.VisitNo = Visits.VisitNo							
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where not (InvoiceNo ='' or InvoiceNo is null) and Visits.VisitNo = @VisitNo and  PayStatusID = @NotPaidPayStatusID
	order by ExtraBills.ExtraBillNo desc
	

end
end

return 0
go

-- select * from ExtraBillItems order by RecordDateTime desc
-- exec uspGetVisitExtraBillItemsByInvoiceStatus '10605001', 0
-- exec uspGetVisitExtraBillItemsByInvoiceStatus '10605001', 1



--------GetIPDSales----------------------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetIPDSales')
	drop proc uspGetIPDSales
go

create proc uspGetIPDSales(
@StartDateTime smalldatetime=null,
@EndDateTime smalldatetime = null,
@BranchID varchar(10)=null,
@ItemCategoryID varchar(10) = null,
@ItemCode varchar(10)=null,
@BillModesID varchar(10) =null,
@PayStatusID varchar(10) =null,
@LoginID varchar(20) = null

)with encryption as

declare @ErrorMSG varchar(200)
declare @ItemOfferedID varchar(10)
declare @ItemDoneID varchar(10)

set @ItemOfferedID = dbo.GetLookupDataID('ExtraBillItemstatus', 'O')
set @ItemDoneID = dbo.GetLookupDataID('ExtraBillItemstatus', 'D')

if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end


		else if  (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		 ------------------------------------------------------------only ItemCategoryID not selected---------------------------------------------------------------
	else if  not (@BranchID is null) and  (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		 ------------------------------------------------------------Only ItemCode---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and  BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------only BillMode null---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and  (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode 
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only PayStatus null---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only LoginID null---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------All selected---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID,  dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end
		--only five ExtraBillItems Selected (only one not selected) End---------------------------------------------------------------------------
		---------------------------------------------------------------------------------------------------------------------------------

		--only four ExtraBillItems Selected (only two not selected) ---------------------------------------------------------------------------
		---------------------------------------------------------------------------------------------------------------------------------
		------------------------------------------------------------BranchID and ItemCategory not selected---------------------------------------------------------------
	else if  (@BranchID is null) and(@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID,  dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end
		------------------------------------------------------------Only BranchID and ItemCode not selected-------------------------------------------------------
	else if (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			 and ItemCategoryID=@ItemCategoryID and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only BranchID and BillMode not selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode 
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only BranchID and PayStatus---------------------------------------------------------------
	else if (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only Branch and LoginID not selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID 
			order by ExtraBillItems.RecordDateTime
		end
		------------------------------------------------------------Only ItemCategory and ItemCode not selected---------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only ItemCategory and BillMode not selected---------------------------------------------------------------
	else if not (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and  (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCode=@ItemCode  
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only ItemCategory and PayStatus not sected---------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only ItemCategory and LoginID not selected---------------------------------------------------------------
	else if not (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID  and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------only ItemCode and BillMode not selected---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and  (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID 
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only ItemCode and PayStatus not selected--------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and BillModesID=@BillModesID 
			and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		-----------------------------------------------------------Only ItemCode and LoginID not selected---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only BillMode and PayStatus not selected---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

------------------------------------------------------------Only BillMode and Login------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode 
			and PayStatusID=@PayStatusID 
			order by ExtraBillItems.RecordDateTime
		end

		---------------------------------------------------------PayStatus and LoginID not selected---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			order by ExtraBillItems.RecordDateTime
		end

		--only four ExtraBillItems Selected (only two not selected)End ---------------------------------------------------------------------------
		---------------------------------------------------------------------------------------------------------------------------------

		--only 3 ExtraBillItems Selected (only 3 not selected) ---------------------------------------------------------------------------
		-------------------------------------------------------------------------------------------------------------------------
		-----------------------------------------------------------Branch and ItemCategory and ItemCode selected-----------------
	else if not(@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID,  dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode
			order by ExtraBillItems.RecordDateTime
		end


		---------------------------------------------------BranchID and ItemCategory BillMode selected-------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID,  dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID and  BillModesID=@BillModesID 
			
			order by ExtraBillItems.RecordDateTime
		end
		--------------------------------------------------------BranchID and ItemCategory and PayStatus---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID 
			and PayStatusID=@PayStatusID 
			order by ExtraBillItems.RecordDateTime
		end

		-------------------------------------------------------Only BranchID  and ItemCategory and LoginID -----------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID
			and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end
		
		------------------------------------------------------------BranchID and ItemCode and BillMode  selected---------------------------------------------------------------
	else if not (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID  and ItemCode=@ItemCode and BillModesID=@BillModesID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------BranchID, ItemCode and PayStatus---------------------------------------------------------------
	else if not (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCode=@ItemCode 
			and PayStatusID=@PayStatusID
			order by ExtraBillItems.RecordDateTime
		end


		------------------------------------------------------------Only BranchID,ItemCode and Login selected--------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and  (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID  and ItemCode=@ItemCode and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end
		------------------------------------------------------------Only BranchID, BillMode and PayStatus selected---------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and BillModesID=@BillModesID and PayStatusID=@PayStatusID
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only BranchID, BillModes, LoginID selected--------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and  not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID  and BillModesID=@BillModesID and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		-----------------------------------------------------Only BranchID, PayMode and Login selected---------------------------------------------------------------
	else if not (@BranchID is null) and (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end


------------------------------------------------------------Only ItemCategory, ItemCode and BillMode selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and BillModesID=@BillModesID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only ItemCategory, ItemCode and PayStatus selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and  not(@ItemCode is null) 
	and  (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			 and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode 
			and PayStatusID=@PayStatusID 
			order by ExtraBillItems.RecordDateTime
		end

------------------------------------------------------------Only ItemCategory, ItemCode and LoginID---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID,  dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end


		------------------------------------------------------------Only ItemCategory, BillMode and PayStatus selected--------------------------------------------------------------
	else if  (@BranchID is null) and  not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID
			order by ExtraBillItems.RecordDateTime
		end

		---------------------------------------------------------Only ItemCategory, BillMode and LoginID selected--------------------------------------------------------------
	else if (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and BillModesID=@BillModesID 
			 and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only ItemCategory, PayStatus and Login selected---------------------------------------------------------------
	else if (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only ItemCode, BillMode and PayStatus selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID
			order by ExtraBillItems.RecordDateTime
		end

		--------------------------------------------------------Only ItemCode, BillMode and LoginID selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode and BillModesID=@BillModesID 
			and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end
		---------------------------------------------------------Only ItemCode, PayStatus and LoginID selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and not(@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		---------------------------------------------------------Only Billmode, PayStatus and LoginID selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BillModesID=@BillModesID 
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		--only 3 ExtraBillItems Selected (only 3 not selected) End---------------------------------------------------------------------------
		---------------------------------------------------------------------------------------------------------------------------------

		--only 2 ExtraBillItems Selected (only 4 not selected) ---------------------------------------------------------------------------
		-----------------------------------------------------------------------------------------------------------------------------

		------------------------------------------------------------On BranchID and ItemCategory selected---------------------------------------------------------------
	else if not (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ItemCategoryID=@ItemCategoryID
			order by ExtraBillItems.RecordDateTime
		end
		---------------------------------------------------------Only BranchID and ItemCode selected---------------------------------------------------------------
	else if not (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and  (@BillModesID is null) and(@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID  and ItemCode=@ItemCode 
			order by ExtraBillItems.RecordDateTime
		end

		-----------------------------------------------------------Only BranchID and BillMode selected---------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and BillModesID=@BillModesID 
			order by ExtraBillItems.RecordDateTime
		end

		--------------------------------------------------------Only BranchID and PayStatus selected---------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID  
			and PayStatusID=@PayStatusID
			order by ExtraBillItems.RecordDateTime
		end

		----------------------------------------------------------Only BranchID and LoginID selected---------------------------------------------------------------
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and  (@BillModesID is null) and  (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		----------------------------------------------------------Only ItemCategory and ItemCode selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and  not (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only ItemCategory and BillMode selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and  (@ItemCode is null) 
	and  not (@BillModesID is null) and  (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and BillModesID=@BillModesID 
			order by ExtraBillItems.RecordDateTime
		end
		------------------------------------------------------------Only ItemCategory and PayStatus selected---------------------------------------------------------------
	else if  (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			 and ItemCategoryID=@ItemCategoryID 
			and PayStatusID=@PayStatusID
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only ItemCategory and LoginID selected---------------------------------------------------------------
	else if (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and  (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only ItemCode and BillMode selected---------------------------------------------------------------
	else if (@BranchID is null) and  (@ItemCategoryID is null) and not (@ItemCode is null) 
	and not (@BillModesID is null) and  (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			 and ItemCode=@ItemCode and BillModesID=@BillModesID 
			order by ExtraBillItems.RecordDateTime
		end

		----------------------------------------------------------Only ItemCode and PayStatus selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode 
			and PayStatusID=@PayStatusID
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only ItemCode and LoginID selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end

		----------------------------------------------------------Only BillModes and PayStatus selected---------------------------------------------------------------
	else if (@BranchID is null) and  (@ItemCategoryID is null) and (@ItemCode is null) 
	and not (@BillModesID is null) and not (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			 and BillModesID=@BillModesID and PayStatusID=@PayStatusID
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only BillMode and LoginID selected---------------------------------------------------------------
	else if  (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID,  dbo.GetLookupDataDes(BranchID) as BranchName,
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BillModesID=@BillModesID and ExtraBillItems.LoginID=@LoginID
			order by ExtraBillItems.RecordDateTime
		end

		----------------------------------------------------------Only PayStatus and LoginID---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and PayStatusID=@PayStatusID  and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end
		
		--only 2 ExtraBillItems Selected (only 4 not selected) End---------------------------------------------------------------------------
		---------------------------------------------------------------------------------------------------------------------------------

		--only 1 ExtraBillItems Selected (only 5 not selected) ---------------------------------------------------------------------------
		---------------------------------------------------------------------------------------------------------------------------------
		
		-----------------------------------------------------------Only BranchID selected--------------------------------------------------------------
	
	else if not (@BranchID is null) and  (@ItemCategoryID is null) and  (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and BranchID=@BranchID
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only ItemCategory selected---------------------------------------------------------------
	else if (@BranchID is null) and not (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCategoryID=@ItemCategoryID order by ExtraBillItems.RecordDateTime
		end
		------------------------------------------------------------Only ItemCode selected--------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and not (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ItemCode=@ItemCode order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only BillMode selected---------------------------------------------------------------
	else if  (@BranchID is null) and  (@ItemCategoryID is null) and (@ItemCode is null) 
	and not (@BillModesID is null) and (@PayStatusID is null) and (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
		and BillModesID=@BillModesID order by ExtraBillItems.RecordDateTime
		end

		-----------------------------------------------------------Only PayStatus selected---------------------------------------------------------------
	else if (@BranchID is null) and (@ItemCategoryID is null) and (@ItemCode is null) 
	and (@BillModesID is null) and not (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime  and PayStatusID=@PayStatusID 
			order by ExtraBillItems.RecordDateTime
		end

		------------------------------------------------------------Only LoginID selected---------------------------------------------------------------
	else if  (@BranchID is null) and (@ItemCategoryID is null) and  (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and not (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, dbo.GetLookupDataDes(BranchID) as BranchName, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where 
			ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			and ExtraBillItems.LoginID = @LoginID 
			order by ExtraBillItems.RecordDateTime
		end
		--only 1 ExtraBillItems Selected (only 5 not selected) End----------------------------------------------------------------------------------------
		-----------------------------------------------------------------------------------------------------------------------------------------
    
	---------------------------------------------------------------------------------------------------------------------------------------------
	------------------------------------------------------------nothing is selected---------------------------------------------------------------
	else if  (@BranchID is null) and (@ItemCategoryID is null) and  (@ItemCode is null) 
	and (@BillModesID is null) and (@PayStatusID is null) and  (@LoginID is null) 

		begin
			select ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemCode, ItemName,ExtraBills.VisitNo, UnitPrice, Quantity,
					 (UnitPrice*Quantity) as AmountBeforeVAT, VATValue,  ((UnitPrice*Quantity)-VATValue) as AmountAfterVAT,BranchID, 
					 PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, BillModesID,dbo.GetLookupDataDes(BillModesID) as BillMode, dbo.GetLookupDataDes(BranchID) as BranchName,
					 dbo.FormatDate(ExtraBillItems.RecordDateTime) as RecordDate, dbo.GetTime(ExtraBillItems.RecordDateTime) as RecordTime,ExtraBillItems.LoginID
					from ExtraBillItems
					inner join  ExtraBills  on ExtraBills.ExtraBillNo=ExtraBillItems.ExtraBillNo inner join visits on ExtraBills.VisitNo=Visits.Visitno
			where ExtraBillItems.RecordDateTime between @StartDateTime and @EndDateTime 
			order by ExtraBillItems.RecordDateTime
		end

go
-------------- Get ToReturnExtraBillItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetToReturnExtraBillItems')
	drop proc uspGetToReturnExtraBillItems
go

create proc uspGetToReturnExtraBillItems(
@ExtraBillNo varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)
declare @SystemEntryModeID varchar(10)

--------------------------------------------------------------------------------------------------
set @SystemEntryModeID = dbo.GetLookupDataID('EntryMode', 'SYS')
--------------------------------------------------------------------------------------------------

	begin
		select ExtraBillNo, ItemCode,ItemName,
		dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
		Quantity, UnitPrice, PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode
		from ExtraBillItems
		where EntryModeID = @SystemEntryModeID and ExtraBillNo = @ExtraBillNo and ItemCategoryID = @ItemCategoryID
	end

return 0

go

/******************************************************************************************************
exec uspGetToReturnExtraBillItems '140032312', '7D'
exec uspGetToReturnExtraBillItems '140032312', '7T'

******************************************************************************************************/
-- select * from ExtraBillItems
-- delete from ExtraBillItems

--------GetNotPaidExtraBillItems----------------------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetNotPaidExtraBillItems')
	drop proc uspGetNotPaidExtraBillItems
go

create proc uspGetNotPaidExtraBillItems(
@BillModesID varchar(10),
@BillNo varchar(20),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null,
@CompanyNo varchar(20) = null
)with encryption as

declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)
declare @NotPaidPayStatusID varchar(10)

--------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
--------------------------------------------------------------------------

if not(@StartDate is null) and not(@EndDate is null)
begin
	if (@BillNo = 'CASH' and @BillModesID = @CashBillModesID) -- Bill Cash
		begin
			select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
			dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 			
			 Quantity, UnitPrice, ItemName,
			dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 			
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
			from ExtraBillItems 		
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo	
			inner join Patients on Admissions.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and BillNo = @BillNo and ExtraBillDate between @StartDate and @EndDate
			union
			select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
			dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 			
		    Quantity, UnitPrice, ItemName,
			dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(CashPayStatusID) as PayStatus, 			
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
			from ExtraBillItems				
			inner join ExtraBillItemsCASH on ExtraBillItemsCASH.ExtraBillNo = ExtraBillItems.ExtraBillNo 
			and ExtraBillItemsCASH.ItemCode = ExtraBillItems.ItemCode 
			and ExtraBillItemsCASH.ItemCategoryID = ExtraBillItems.ItemCategoryID
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo	
			inner join Patients on Admissions.PatientNo = Patients.PatientNo
			where CashPayStatusID = @NotPaidPayStatusID	and (Quantity*UnitPrice)>0 
			and ExtraBillDate between @StartDate and @EndDate

			union
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
			dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 			
			 Quantity, UnitPrice, ItemName,
			dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 			
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
			
			from ExtraBillItems 		
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Visits on ExtraBills.VisitNo = Visits.VisitNo	
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and BillNo = @BillNo and ExtraBillDate between @StartDate and @EndDate
			union
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
			dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 			
		    Quantity, UnitPrice, ItemName,
			dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(CashPayStatusID) as PayStatus, 			
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
			from ExtraBillItems				
			inner join ExtraBillItemsCASH on ExtraBillItemsCASH.ExtraBillNo = ExtraBillItems.ExtraBillNo 
			and ExtraBillItemsCASH.ItemCode = ExtraBillItems.ItemCode 
			and ExtraBillItemsCASH.ItemCategoryID = ExtraBillItems.ItemCategoryID
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Visits on ExtraBills.VisitNo = Visits.VisitNo	
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			where CashPayStatusID = @NotPaidPayStatusID	and (Quantity*UnitPrice)>0 
			and ExtraBillDate between @StartDate and @EndDate
		end

	else if (@BillModesID = @AccountBillModesID) -- Bill Account 
		 if not(@CompanyNo is null)
			begin
				select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
				dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
				dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
				Quantity, MemberCardNo,	MainMemberName, ClaimReferenceNo,
				UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
				ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
				ItemName, 
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
				dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
				EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
				dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
				dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		
				(dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)) as ReturnedAmount,
				dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            	dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
				inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
				inner join Patients on Admissions.PatientNo = Patients.PatientNo
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and (BillNo = @CompanyNo and InsuranceNo = @BillNo) 
				and ExtraBillDate between @StartDate and @EndDate
				union
				select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
				dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
				dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
				Quantity, MemberCardNo,	MainMemberName, ClaimReferenceNo,
				UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
				ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
				ItemName, 
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
				dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
				EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
				dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
				dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		
				(dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)) as ReturnedAmount,
				dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            	dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
				inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and (BillNo = @CompanyNo and InsuranceNo = @BillNo) 
				and ExtraBillDate between @StartDate and @EndDate
				
			end 
		else
		begin
			select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 			
			Quantity, MemberCardNo, MainMemberName, ClaimReferenceNo, 
			UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
			CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 			
			dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor, 
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount,
			dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
			from ExtraBillItems 
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
			inner join Patients on Admissions.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID 
			and (BillNo = @BillNo or InsuranceNo = @BillNo) and (Quantity*UnitPrice)>0
			and ExtraBillDate between @StartDate and @EndDate
			union
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 			
			Quantity, MemberCardNo, MainMemberName, ClaimReferenceNo, 
			UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
			CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 			
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor, 
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount,
			dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
			from ExtraBillItems 
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID 
			and (BillNo = @BillNo or InsuranceNo = @BillNo) and (Quantity*UnitPrice)>0
			and ExtraBillDate between @StartDate and @EndDate

		end

	else if (@BillModesID = @InsuranceBillModesID) -- Bill Insurance
		 if not(@CompanyNo is null)
			begin
				select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
				dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
				dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
				Quantity, MemberCardNo,	MainMemberName, ClaimReferenceNo, 
               	UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
				ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName,
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
				dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
				EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
				dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
				dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
				dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount,
				dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            	dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
				inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
				inner join Patients on Admissions.PatientNo = Patients.PatientNo
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo and ExtraBillDate between @StartDate and @EndDate
				and dbo.GetSchemeCompanyNo(BillNo) = @CompanyNo
				union
				select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
				dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
				dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
				Quantity, MemberCardNo,	MainMemberName, ClaimReferenceNo, 
               	UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
				ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName,
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
				dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
				EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
				dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
				dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
				dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount,
				dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            	dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
				inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
				inner join Patients on Visits.PatientNo = Patients.PatientNo
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
				and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo and ExtraBillDate between @StartDate and @EndDate
				and dbo.GetSchemeCompanyNo(BillNo) = @CompanyNo

			end
		else
		begin
			select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
				dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
				dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
				Quantity, MemberCardNo,	MainMemberName, ClaimReferenceNo, 
               	UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
				ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName,
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
				dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
				EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
				dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
				dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
				dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount,
				dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            	dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
			from ExtraBillItems 
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
			inner join Patients on Admissions.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo and ExtraBillDate between @StartDate and @EndDate
			union
				select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
				dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
				dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
				Quantity, MemberCardNo,	MainMemberName, ClaimReferenceNo, 
               	UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
				ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName,
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
				dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
				EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
				dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
				dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
				dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount,
				dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            	dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
			from ExtraBillItems 
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo and ExtraBillDate between @StartDate and @EndDate

		end	
end
else
begin

if (@BillNo = 'CASH' and @BillModesID = @CashBillModesID) -- Bill Cash
	begin
		select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
		dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
		dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 			
		 Quantity, UnitPrice, 
		ItemName, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetLookupDataDes(PayStatusID) as PayStatus, 			
		dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
		dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		(dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)) as ReturnedAmount
		from ExtraBillItems 		
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo	
		inner join Patients on Admissions.PatientNo = Patients.PatientNo
		where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
		and BillNo = @BillNo
		union
		select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
		dbo.FormatDate(ExtraBillDate) as ExtraBillDate, 			
        Quantity, UnitPrice, dbo.GetItemBillPrice(ExtraBills.VisitNo, ExtraBillItems.ItemCode, ExtraBillItems.ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
		dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetLookupDataDes(CashPayStatusID) as PayStatus, 			
		dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
		dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
		dbo.GetMappedCustomCode(BillNo, ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
		from ExtraBillItems				
		inner join ExtraBillItemsCASH on ExtraBillItemsCASH.ExtraBillNo = ExtraBillItems.ExtraBillNo 
		and ExtraBillItemsCASH.ItemCode = ExtraBillItems.ItemCode 
		and ExtraBillItemsCASH.ItemCategoryID = ExtraBillItems.ItemCategoryID
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo	
		inner join Patients on Admissions.PatientNo = Patients.PatientNo
		where CashPayStatusID = @NotPaidPayStatusID and (Quantity*UnitPrice)>0
		union
		select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
		dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
		dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 			
		 Quantity, UnitPrice, 
		ItemName, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetLookupDataDes(PayStatusID) as PayStatus, 			
		dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
		dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		(dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)) as ReturnedAmount
		from ExtraBillItems 		
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		inner join Visits on ExtraBills.VisitNo = Visits.VisitNo	
		inner join Patients on Visits.PatientNo = Patients.PatientNo
		where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
		and BillNo = @BillNo
		union
		select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
		dbo.FormatDate(ExtraBillDate) as ExtraBillDate, 			
        Quantity, UnitPrice, dbo.GetItemBillPrice(ExtraBills.VisitNo, ExtraBillItems.ItemCode, ExtraBillItems.ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
		dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetLookupDataDes(CashPayStatusID) as PayStatus, 			
		dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
		dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
		dbo.GetMappedCustomCode(BillNo, ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
		from ExtraBillItems				
		inner join ExtraBillItemsCASH on ExtraBillItemsCASH.ExtraBillNo = ExtraBillItems.ExtraBillNo 
		and ExtraBillItemsCASH.ItemCode = ExtraBillItems.ItemCode 
		and ExtraBillItemsCASH.ItemCategoryID = ExtraBillItems.ItemCategoryID
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		inner join Visits on ExtraBills.VisitNo = Visits.VisitNo	
		inner join Patients on Visits.PatientNo = Patients.PatientNo
		where CashPayStatusID = @NotPaidPayStatusID and (Quantity*UnitPrice)>0
	end


else if (@BillModesID = @AccountBillModesID) -- Bill Account 
	 if not(@CompanyNo is null)
		begin
			select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
			 Quantity,MemberCardNo,	MainMemberName, ClaimReferenceNo, 
			 UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
			 dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
			 CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
			dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount,
			dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
			from ExtraBillItems 
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
			inner join Patients on Admissions.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and (BillNo = @CompanyNo and InsuranceNo = @BillNo) 		
			union
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
			 Quantity,MemberCardNo,	MainMemberName, ClaimReferenceNo, 
			 UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
			 dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
			 CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount,
			dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
			from ExtraBillItems 
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and (BillNo = @CompanyNo and InsuranceNo = @BillNo) 		

		end
	else
	begin
		select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
		dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
		 Quantity, MemberCardNo, MainMemberName, ClaimReferenceNo, UnitPrice,
		dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice,
		dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
		ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetLookupDataDes(PayStatusID) as PayStatus, 			
		dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
        dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
		from ExtraBillItems 
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
		inner join Patients on Admissions.PatientNo = Patients.PatientNo
		where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
		and (BillNo = @BillNo or InsuranceNo = @BillNo) 
	    union
		select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
		dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
		 Quantity, MemberCardNo, MainMemberName, ClaimReferenceNo, UnitPrice,
		dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice,
		dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
		ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetLookupDataDes(PayStatusID) as PayStatus, 			
		dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
        dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
		from ExtraBillItems 
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
		inner join Patients on Visits.PatientNo = Patients.PatientNo
		where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
		and (BillNo = @BillNo or InsuranceNo = @BillNo) 

	end
else if (@BillModesID = @InsuranceBillModesID) -- Bill Insurance
	 if not(@CompanyNo is null)
		begin
			select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
			Quantity, 			
			MemberCardNo, MainMemberName, ClaimReferenceNo, 
			UnitPrice, dbo.GetItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
			CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
			dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount,
			dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
			from ExtraBillItems 
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
			inner join Patients on Admissions.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo
			and dbo.GetSchemeCompanyNo(BillNo) = @CompanyNo
			union
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
			Quantity, 			
			MemberCardNo, MainMemberName, ClaimReferenceNo, 
			UnitPrice, dbo.GetItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
			CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount,
			dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
			from ExtraBillItems 
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo
			and dbo.GetSchemeCompanyNo(BillNo) = @CompanyNo

		end
	else
	begin
		select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
		dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
		Quantity, MemberCardNo, MainMemberName, ClaimReferenceNo, 
		UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
		dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
		ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetLookupDataDes(PayStatusID) as PayStatus, 	
		dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount,
		dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
         dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
		from ExtraBillItems 
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
		inner join Patients on Admissions.PatientNo = Patients.PatientNo
		where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
		and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo
		union
				select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
		dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
		Quantity, MemberCardNo, MainMemberName, ClaimReferenceNo, 
		UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
		dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
		ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetLookupDataDes(PayStatusID) as PayStatus, 	
		dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount,
		dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
         dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo
		from ExtraBillItems 
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
		inner join Patients on Visits.PatientNo = Patients.PatientNo
		where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
		and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo

	end	
end
return 0
go

/*************************************************************************************************************************************************
-- select * from ExtraBillItems

exec uspGetNotPaidExtraBillItems '17C', 'CASH', 'apr 15, 2011', 'apr 30, 2013'
exec uspGetNotPaidExtraBillItems '17A', '100041A', 'apr 1, 2013', 'apr 30, 2013'
exec uspGetNotPaidExtraBillItems '17A', '100041A', 'apr 1, 2013', 'apr 30, 2013', 'A120056'
exec uspGetNotPaidExtraBillItems '17I', 'CMC', 'apr 1, 2013', 'may 15, 2013'
exec uspGetNotPaidExtraBillItems '17I', 'CMC', 'may 1, 2013', 'may 15, 2013', 'URA'

exec uspGetNotPaidExtraBillItems '17A', '100041A', null, null, 'A120056'
*************************************************************************************************************************************************/

--------GetInvoicedNotPaidExtraBillItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInvoicedNotPaidExtraBillItems')
	drop proc uspGetInvoicedNotPaidExtraBillItems
go

create proc uspGetInvoicedNotPaidExtraBillItems(
@BillModesID varchar(10),
@BillNo varchar(20),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null,
@CompanyNo varchar(20) = null
)with encryption as

declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)
declare @NotPaidPayStatusID varchar(10)

--------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
--------------------------------------------------------------------------

if not(@StartDate is null) and not(@EndDate is null)
begin
	if (@BillNo = 'CASH' and @BillModesID = @CashBillModesID) -- Bill Cash
		begin
			select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
			dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 			
		    Quantity,UnitPrice,ItemName,
			dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 			
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
	        dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
			
            from ExtraBillItems 		
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo	
			inner join Patients on Admissions.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID 
			and BillNo = @BillNo and (Quantity*UnitPrice)>0 and ExtraBillDate between @StartDate and @EndDate
            and dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)> 0
			union
			select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
			dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, Quantity, 
			UnitPrice,ItemName,
			dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(CashPayStatusID) as PayStatus, 			
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
	        dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* UnitPrice) as ReturnedAmount
			from ExtraBillItems				
			inner join ExtraBillItemsCASH on ExtraBillItemsCASH.ExtraBillNo = ExtraBillItems.ExtraBillNo 
			and ExtraBillItemsCASH.ItemCode = ExtraBillItems.ItemCode 
			and ExtraBillItemsCASH.ItemCategoryID = ExtraBillItems.ItemCategoryID
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo	
			inner join Patients on Admissions.PatientNo = Patients.PatientNo
			where CashPayStatusID = @NotPaidPayStatusID and (Quantity*UnitPrice)>0 	and ExtraBillDate between @StartDate and @EndDate
            and dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)> 0
		end
	else if (@BillModesID = @AccountBillModesID) -- Bill Account 
		 if not(@CompanyNo is null)
			begin
				select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
				dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
				dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
			    Quantity, MemberCardNo,	MainMemberName, ClaimReferenceNo,
	        	UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
				ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
				ItemName, 
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
				dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
				EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		 		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
                dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            	dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo,
				dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			    (dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
				inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
				inner join Patients on Admissions.PatientNo = Patients.PatientNo
				where PayStatusID = @NotPaidPayStatusID and (Quantity*UnitPrice)>0 and BillModesID = @BillModesID 
				and (BillNo = @CompanyNo and InsuranceNo = @BillNo) 
				and ExtraBillDate between @StartDate and @EndDate
                and dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)> 0
				order by ExtraBillItems.ExtraBillNo desc
			end 
		else
		begin
			select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 			
			Quantity, MemberCardNo, MainMemberName, ClaimReferenceNo, 
			UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
			CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 			
			dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
            dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
	        dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount
			from ExtraBillItems 
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
			inner join Patients on Admissions.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and (BillNo = @BillNo or InsuranceNo = @BillNo) 
			and ExtraBillDate between @StartDate and @EndDate
            and dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)> 0
			order by ExtraBillItems.ExtraBillNo desc		
		end
	else if (@BillModesID = @InsuranceBillModesID) -- Bill Insurance
		 if not(@CompanyNo is null)
			begin
				select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
				dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
				dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
				dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, Quantity, 
				MemberCardNo,	MainMemberName, ClaimReferenceNo, 
				UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
				dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
				CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
				ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName,
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
				dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
				EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
				dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
                dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
            	dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo,
				dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		  	   (dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
				inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
				inner join Patients on Admissions.PatientNo = Patients.PatientNo
				where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0 
				and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo and ExtraBillDate between @StartDate and @EndDate
				and dbo.GetSchemeCompanyNo(BillNo) = @CompanyNo
                and dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)> 0
				order by ExtraBillItems.ExtraBillNo desc
			end
		else
		begin
			select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, Quantity,			
			MemberCardNo, MainMemberName, ClaimReferenceNo, 
			UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
			CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 	
			dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
            dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
        	dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount
			from ExtraBillItems 
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
			inner join Patients on Admissions.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo and ExtraBillDate between @StartDate and @EndDate
            and dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)> 0
			order by ExtraBillItems.ExtraBillNo desc
		end	
end
else
begin
if (@BillNo = 'CASH' and @BillModesID = @CashBillModesID) -- Bill Cash
	begin
		select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
		dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
		dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, Quantity, 
		UnitPrice,ItemName,
		dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetLookupDataDes(PayStatusID) as PayStatus, 			
		dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
		dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
        dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
	    dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* UnitPrice) as ReturnedAmount
		from ExtraBillItems 		
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo	
		inner join Patients on Admissions.PatientNo = Patients.PatientNo
		where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID 
		and BillNo = @BillNo
        and dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)> 0
		union
		select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, 
		dbo.FormatDate(ExtraBillDate) as ExtraBillDate, Quantity, UnitPrice,ItemName,
		dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetLookupDataDes(CashPayStatusID) as PayStatus, 			
		dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
		dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
        dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
	    dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo,

		dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		(dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)) as ReturnedAmount
		from ExtraBillItems				
		inner join ExtraBillItemsCASH on ExtraBillItemsCASH.ExtraBillNo = ExtraBillItems.ExtraBillNo 
		and ExtraBillItemsCASH.ItemCode = ExtraBillItems.ItemCode 
		and ExtraBillItemsCASH.ItemCategoryID = ExtraBillItems.ItemCategoryID
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo	
		inner join Patients on Admissions.PatientNo = Patients.PatientNo
		where CashPayStatusID = @NotPaidPayStatusID and (Quantity*UnitPrice)>0
        and dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)> 0
	end
else if (@BillModesID = @AccountBillModesID) -- Bill Account 
	 if not(@CompanyNo is null)
		begin
			select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
            Quantity, 			
			MemberCardNo, MainMemberName, ClaimReferenceNo, 
			UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
			CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
			dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
            dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
        	dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo,         
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount
			from ExtraBillItems 
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
			inner join Patients on Admissions.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
			and (BillNo = @CompanyNo and InsuranceNo = @BillNo) 
            and dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)> 0		
			order by ExtraBillItems.ExtraBillNo desc
		end
	else
	begin
		select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
		dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
        Quantity, 		
		MemberCardNo, MainMemberName, ClaimReferenceNo, 
		UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
		dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
		ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetLookupDataDes(PayStatusID) as PayStatus, 			
		dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
        dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
    	dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount
		from ExtraBillItems 
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
		inner join Patients on Admissions.PatientNo = Patients.PatientNo
		where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
		and (BillNo = @BillNo or InsuranceNo = @BillNo) 
        and dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)> 0
		order by ExtraBillItems.ExtraBillNo desc		
	end
else if (@BillModesID = @InsuranceBillModesID) -- Bill Insurance
	 if not(@CompanyNo is null)
		begin
			select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
			dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
            Quantity, 			
			MemberCardNo,	MainMemberName, ClaimReferenceNo, 
		    UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
			CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
			ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 				
			dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
			EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
			dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
            dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
         	dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo,
			dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
			(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount
			from ExtraBillItems 
			inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
			left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
			inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
			inner join Patients on Admissions.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0 
			and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo
			and dbo.GetSchemeCompanyNo(BillNo) = @CompanyNo
            and dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)> 0
			order by ExtraBillItems.ExtraBillNo desc
		end
	else
	begin
		select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.FormatDate(ExtraBillDate) as ExtraBillDate,
		dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode, 
		Quantity, MemberCardNo, MainMemberName, ClaimReferenceNo, 
		UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
		dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
		CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
		ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetLookupDataDes(PayStatusID) as PayStatus, 	
		dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
		dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
        dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceAmount,
    	dbo.GetIPDItemInvoiceNo(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode) as InvoiceNo,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		(dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID)* dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as ReturnedAmount
		from ExtraBillItems 
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
		inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
		inner join Patients on Admissions.PatientNo = Patients.PatientNo
		where PayStatusID = @NotPaidPayStatusID and BillModesID = @BillModesID and (Quantity*UnitPrice)>0
		and dbo.GetSchemeInsuranceNo(BillNo) = @BillNo
        and dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)> 0
		order by ExtraBillItems.ExtraBillNo desc
	end	
end
return 0
go

-- select * from ExtraBillItems

-- exec uspGetInvoicedNotPaidExtraBillItems '17C', 'CASH', 'dec 31, 2017', 'jan 30, 2018'
-- exec uspGetInvoicedNotPaidExtraBillItems '17A', '100041A', 'jan 1, 2018', 'jan 30, 2018'
-- exec uspGetInvoicedNotPaidExtraBillItems '17A', '100041A', 'apr 1, 2013', 'apr 30, 2013', 'A120056'
-- exec uspGetInvoicedNotPaidExtraBillItems '17I', 'CMC', 'apr 1, 2013', 'may 15, 2013'
-- exec uspGetInvoicedNotPaidExtraBillItems '17I', 'CMC', 'may 1, 2013', 'may 15, 2013', 'URA'





-------------- usp Get IPD Visit No By InvoiceNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDVisitNoByInvoiceNo')
	drop proc uspGetIPDVisitNoByInvoiceNo
go

create proc uspGetIPDVisitNoByInvoiceNo(
@InvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select top 1 InvoiceNo from InvoiceExtraBillItems where InvoiceNo = @InvoiceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered In-patient %s'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo, 'Invoices')
		return 1
	end
else
begin
	select top 1 Invoices.InvoiceNo,dbo.FormatText(InvoiceExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, 
    dbo.FormatText(ExtraBills.VisitNo, 'Visits', 'VisitNo') as VisitNo,InvoiceDate,  dbo.GetInvoiceBillNo(PayTypeID, PayNo)as BIllNo,ExtraBillDate
	from Invoices
    inner join InvoiceExtraBillItems on InvoiceExtraBillItems.InvoiceNo = Invoices.InvoiceNo
	inner join ExtraBills on InvoiceExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	where Invoices.InvoiceNo=@InvoiceNo

return 0
end
go

/******************************************************************************************************
exec uspGetIPDVisitNoByInvoiceNo '18004028'

******************************************************************************************************/


--------GetNotPaidExtraBillItemsCASH--------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNotPaidExtraBillItemsCASH')
	drop proc uspGetNotPaidExtraBillItemsCASH
go

create proc uspGetNotPaidExtraBillItemsCASH(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @NotPaidCashPayStatusID varchar(10)

set @NotPaidCashPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')

begin
	select BillNo, dbo.FormatText(ExtraBills.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,
	dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode,	
    Quantity, UnitPrice, CashAmount as Amount, ExtraBillDate, ExtraBillItems.ItemCode,ItemName, ExtraBillItemsCASH.InvoiceNo,
	ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,
	Notes, LastUpdate, PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
	EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode, 
	CashPayStatusID,  dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus, 
	dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo
	from ExtraBillItems
	inner join ExtraBillItemsCASH on ExtraBillItemsCASH.ExtraBillNo = ExtraBillItems.ExtraBillNo 
	and ExtraBillItemsCASH.ItemCode = ExtraBillItems.ItemCode 
	and ExtraBillItemsCASH.ItemCategoryID = ExtraBillItems.ItemCategoryID
	inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
	inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo					
	where ExtraBills.VisitNo = @VisitNo and CashPayStatusID = @NotPaidCashPayStatusID and (Quantity*UnitPrice)>0
end


return 0
go

-- exec uspGetNotPaidExtraBillItemsCASH '10605001'
-- select * from ExtraBillItems
-- select * from ExtraBillItemsCASH
-- select * from Visits
---select * from EXtraBills where ExtraBillNo = 'PLH393999001'

--------GetNotPaidExtraBillItemsByVisitNo----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNotPaidExtraBillItemsByVisitNo')
	drop proc uspGetNotPaidExtraBillItemsByVisitNo
go

create proc uspGetNotPaidExtraBillItemsByVisitNo(
@VisitNo varchar(20)
)with encryption as

declare @NotPaidPayStatusID varchar(10)

--------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
--------------------------------------------------------------------------
if exists(select AdmissionNo from Admissions where Admissions.VisitNo = @VisitNo)
begin
	select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, 
	dbo.FormatDate(ExtraBillDate) as ExtraBillDate, dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, 
	Quantity, MemberCardNo, MainMemberName, ClaimReferenceNo, UnitPrice,
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
	dbo.GetDoctorFullName(Admissions.VisitNo) as PrimaryDoctor,
	dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode,
	dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
	dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
	from ExtraBillItems 
	inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo							
	inner join Patients on Admissions.PatientNo = Patients.PatientNo
	where PayStatusID = @NotPaidPayStatusID and (Quantity*UnitPrice)>0 and Admissions.VisitNo = @VisitNo 
	order by Admissions.VisitNo desc
	end
	else
	begin
	select dbo.FormatText(Patients.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
	dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo,
	dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, 
	dbo.FormatDate(ExtraBillDate) as ExtraBillDate, dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate, 
	Quantity, MemberCardNo, MainMemberName, ClaimReferenceNo, UnitPrice,
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, ExtraBillItems.ItemCode, 
	CoPayTypeID, dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	ExtraBillItems.ItemCategoryID, dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory,ItemName, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
	dbo.GetMappedCustomCode(BillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as MappedCustomCode,
	dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
	dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
	from ExtraBillItems 
	inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join Visits on ExtraBills.VisitNo = Visits.VisitNo							
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where PayStatusID = @NotPaidPayStatusID and (Quantity*UnitPrice)>0 and Visits.VisitNo = @VisitNo 
	order by VisitNo desc



end
return 0
go

-- select * from Visits
-- exec uspGetNotPaidExtraBillItemsByVisitNo '005002'

-------------- GetExtraBillItemsByVisitNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExtraBillItemsByVisitNo')
	drop proc uspGetExtraBillItemsByVisitNo
go

create proc uspGetExtraBillItemsByVisitNo(
@VisitNo varchar(20),
@PayStatusID varchar(10)= null
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select AdmissionNo from Admissions where Admissions.VisitNo = @VisitNo) and not (@PayStatusID is null)
	begin
		select 	dbo.FormatText(ExtraBills.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		ExtraBillDate, dbo.GetStaffName(ExtraBills.StaffNo) as AttendingDoctor, 
		ItemCode,ItemName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
		Quantity, UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
        Quantity * UnitPrice as Amount,
	    Notes, LastUpdate, PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
		from ExtraBillItems
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		inner Join Admissions on Admissions.VisitNo = ExtraBills.VisitNo
		where ExtraBills.VisitNo = @VisitNo and PayStatusID = @PayStatusID
	end

else if not exists(select AdmissionNo from Admissions where Admissions.VisitNo = @VisitNo) and not (@PayStatusID is null)
	begin
		select 	dbo.FormatText(ExtraBills.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		ExtraBillDate, dbo.GetStaffName(ExtraBills.StaffNo) as AttendingDoctor, 
		ItemCode,ItemName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
		Quantity, UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
        Quantity * UnitPrice as Amount,
	    Notes, LastUpdate, PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
		from ExtraBillItems
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		inner Join Visits on Visits.VisitNo = ExtraBills.VisitNo
		where ExtraBills.VisitNo = @VisitNo and PayStatusID = @PayStatusID
	end

else 
begin
		select 	dbo.FormatText(ExtraBills.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		ExtraBillDate, dbo.GetStaffName(ExtraBills.StaffNo) as AttendingDoctor, 
		ItemCode,ItemName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
		Quantity, UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
        Quantity * UnitPrice as Amount,
	    Notes, LastUpdate, PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
		from ExtraBillItems
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		inner Join Admissions on Admissions.VisitNo = ExtraBills.VisitNo
		where ExtraBills.VisitNo = @VisitNo
		union
		select 	dbo.FormatText(ExtraBills.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		ExtraBillDate, dbo.GetStaffName(ExtraBills.StaffNo) as AttendingDoctor, 
		ItemCode,ItemName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
		Quantity, UnitPrice, dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as BillPrice, 
        Quantity * dbo.GetExtraBillItemBillPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as Amount,
	    Notes, LastUpdate, PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedQuantity,
		dbo.GetExtraBillItemReturnAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCode,ExtraBillItems.ItemCategoryID) as ReturnedAmount
		from ExtraBillItems
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		inner Join Visits on Visits.VisitNo = ExtraBills.VisitNo
		where ExtraBills.VisitNo = @VisitNo
	end



go
/******************************************************************************************************
exec uspGetExtraBillItemsByVisitNo '10605001'
exec uspGetExtraBillItemsByVisitNo '1022001', '12NP'
exec uspGetExtraBillItemsByVisitNo '1203133001'
exec uspGetExtraBillItemsByVisitNo '10605001', '12NP'

******************************************************************************************************/
-- select * from ExtraBillItems
-- delete from ExtraBillItems

-------------- uspGetUniqueExtraBillItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetUniqueExtraBillItems')
	drop proc uspGetUniqueExtraBillItems
go

create proc uspGetUniqueExtraBillItems(
@VisitNo varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

begin
	select distinct ItemName
	from ExtraBillItems
	inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	where VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID
end

return 0

go

/******************************************************************************************************
exec uspGetUniqueExtraBillItems '1010248029', '7D'
exec uspGetUniqueExtraBillItems '1010717007', '7R'
exec uspGetUniqueExtraBillItems '1011618006', '7T'
******************************************************************************************************/

-------------- uspGetUniqueDrugExtraBillItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetUniqueDrugExtraBillItems')
	drop proc uspGetUniqueDrugExtraBillItems
go

create proc uspGetUniqueDrugExtraBillItems(
@VisitNo varchar(20)
)with encryption as

declare @DrugID varchar(10)
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')

begin

	select distinct ItemName
	from ExtraBillItems
	inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	left outer join ExtraBillsEXT on ExtraBills.ExtraBillNo = ExtraBillsEXT.ExtraBillNo
	where (VisitNo = @VisitNo and ItemCategoryID = @DrugID and RoundNo is null) or 
	(VisitNo = @VisitNo and ItemCategoryID = @DrugID and RoundNo not in 
	(select RoundNo from Discharges where not RoundNo = '' and RoundNo is not null))
end

return 0

go

/******************************************************************************************************
exec uspGetUniqueDrugExtraBillItems '1010248029'
exec uspGetUniqueDrugExtraBillItems '1010717007'
exec uspGetUniqueDrugExtraBillItems '1011618006'
******************************************************************************************************/

------------------------------------------------------------------------------------------------------
-------------- ExtraBillItemsCASH --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ExtraBillItemsCASH ---------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditExtraBillItemsCASH')
	drop proc uspEditExtraBillItemsCASH
go

create proc uspEditExtraBillItemsCASH(
@ExtraBillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@CashAmount money,
@CashPayStatusID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)
declare @NotPaidPayStatus  varchar(10)

set @NotPaidPayStatus = dbo.GetLookupDataID('PayStatus', 'NP')

if not exists(select ExtraBillNo from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with Extra Bill No: %s and Item Code: %s and Item Category: %s, does not  exist in registered Extra Bill Items'
		raiserror(@ErrorMSG, 16, 1, @ExtraBillNo, @ItemCode, @ItemCategoryID)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CashPayStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cash Pay Status ID', @CashPayStatusID, 'Lookup Data')
		return 1
	end

if exists(select ExtraBillNo from ExtraBillItemsCASH where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin

		if  exists(select ExtraBillNo from ExtraBillItemsCASH where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and
												ItemCategoryID = @ItemCategoryID and CashPayStatusID = @NotPaidPayStatus) 
			
		begin
			update ExtraBillItemsCASH set CashAmount = @CashAmount, CashPayStatusID = @CashPayStatusID
			where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
			return 0
		end
		else
		set @ErrorMSG = 'The record with %s: %s and  %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', has been paid for. You can''t update this record!'
		raiserror(@ErrorMSG,16,1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode , 'Item Category')	
		return 1
	end
else
begin
insert into ExtraBillItemsCASH
(ExtraBillNo, ItemCode, ItemCategoryID, CashAmount, CashPayStatusID)
values
(@ExtraBillNo, @ItemCode, @ItemCategoryID, @CashAmount, @CashPayStatusID)
return 0
end
go

/******************************************************************************************************
exec uspEditExtraBillItemsCASH '120150401', 'M031', '7D', 200, '12PF'
exec uspEditExtraBillItemsCASH '110751101', '10C', '7S', 8000, '12NP'

******************************************************************************************************/
-- select * from ExtraBillItemsCASH
-- delete from ExtraBillItemsCASH

-------------- Update ExtraBillItemsCASH -----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateExtraBillItemsCASH')
	drop proc uspUpdateExtraBillItemsCASH
go

create proc uspUpdateExtraBillItemsCASH(
@ExtraBillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)
declare @PaidForPayStatusID  varchar(10)
declare @CopayTypeID varchar(10)
declare @ValueCoPayTypeID as varchar(10)
declare @ExtraChargeItemCategoryID varchar(10)
declare @CoPayItemCode varchar(20)

set @PaidForPayStatusID = dbo.GetLookupDataID('PayStatus', 'PF')
set @ValueCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'VAL')
set @ExtraChargeItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'E')
set @CoPayItemCode = 'CPV'
set @CopayTypeID= (select top 1 CopayTypeID from Admissions
                   inner join ExtraBills on ExtraBills.VisitNo = Admissions.VisitNo
				    where ExtraBillNo = @ExtraBillNo)

if not exists(select ExtraBillNo from ExtraBillItems where ExtraBillNo = @ExtraBillNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with Extra Bill No: %s and Item Code: %s and Item Category: %s, does not  exist in registered Extra Bill Items CASH'
		raiserror(@ErrorMSG, 16, 1, @ExtraBillNo, @ItemCode, @ItemCategoryID)	
		return 1
	end
else
begin
	update ExtraBillItemsCASH set CashPayStatusID = @PaidForPayStatusID
	where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	return 0
end
go

/******************************************************************************************************
exec uspUpdateExtraBillItemsCASH '120150401', 'M031', '7D'
exec uspUpdateExtraBillItemsCASH '110751101', '10C', '7S'
******************************************************************************************************/
-- select * from ExtraBillItemsCASH
-- delete from ExtraBillItemsCASH

-------------- Get ExtraBillItemsCASH -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExtraBillItemsCASH')
	drop proc uspGetExtraBillItemsCASH
go

create proc uspGetExtraBillItemsCASH(
@ExtraBillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ExtraBillNo from ExtraBillItemsCASH where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Extra Bill Items CASH')
		return 1
	end
else
begin
	select ExtraBillNo, ItemCode, ItemCategoryID, CashAmount, 
	CashPayStatusID, dbo.GetLookupDataDes(CashPayStatusID) as CashPayStatus
	from ExtraBillItemsCASH
	where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetExtraBillItemsCASH
******************************************************************************************************/
-- select * from ExtraBillItemsCASH
-- delete from ExtraBillItemsCASH

/**********************************************************************************************/


-------------- Update ExtraBillItemsCASHInvoiceNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateExtraBillItemsCASHInvoiceNo')
	drop proc uspUpdateExtraBillItemsCASHInvoiceNo
go

create proc uspUpdateExtraBillItemsCASHInvoiceNo(
@ExtraBillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@InvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ExtraBillNo from ExtraBillItemsCASH where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'ExtraBillItemsCASH')
		return 1
	end



begin
update ExtraBillItemsCASH set
InvoiceNo = @InvoiceNo
where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspUpdateExtraBillItemsCASHInvoiceNo 'P160004150001', 'DRG0001', '7D', '1900001'
******************************************************************************************************/
-- select * from ExtraBillItemsCASH
-- delete from ExtraBillItemsCASH


------------------------------------------------------------------------------------------------------
------------- ExtraBillItemAdjustments -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ExtraBillItemAdjustments -----------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditExtraBillItemAdjustments')
	drop proc uspEditExtraBillItemAdjustments
go

create proc uspEditExtraBillItemAdjustments(
@AdjustmentNo varchar(20),
@ExtraBillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Quantity int,
@Amount money,
@NewPrice money,
@Acknowledgeable bit,
@EntryLevelID varchar(10),
@Notes varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @PaidPayStatusID varchar(10)
declare @SystemEntryModeID varchar(10)


declare @TransactionDate smallDatetime
declare @BillFormReturnsEntryLevel varchar(10)
declare @RefundEntryLevelID varchar(10)
declare @InvoiceAdjustmentEntryLevelID varchar(10)
declare @AdjustmentTypeID varchar(10)
declare @DownAdjustmentTypeID varchar(10)
declare @UpAdjustmentTypeID varchar(10)
declare @ItemCategory varchar(100)
declare @ItemAdjustments int
declare @BillQuantity int
declare @BillPrice money
declare @QuantityBalance int
--------------------------------------------------------------------------------------------------
set @PaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'PF')
set @SystemEntryModeID = dbo.GetLookupDataID('EntryMode', 'SYS')
set @TransactionDate = getDate()
set @BillFormReturnsEntryLevel = dbo.GetLookupDataID('DocumentType', 'BFR')
set @RefundEntryLevelID = dbo.GetLookupDataID('DocumentType', 'REF')
set @InvoiceAdjustmentEntryLevelID = dbo.GetLookupDataID('DocumentType', 'CRDNT')
set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'D')
set @UPAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'U')
set @ItemCategory = dbo.GetLookupDataDes(@ItemCategoryID)

set @AdjustmentTypeID = (select AdjustmentTypeID from BillAdjustments where AdjustmentNo = @AdjustmentNo)

set @BillQuantity = (select Quantity from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID) 
set @BillPrice = (select UnitPrice from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID) 

if @AdjustmentTypeID = @DownAdjustmentTypeID 
begin set @QuantityBalance = @BillQuantity - @Quantity end
else set @QuantityBalance = @BillQuantity
--------------------------------------------------------------------------------------------------

if not exists(select ExtraBillNo from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1,  'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'Extra Bill Items')
		return 1
	end

if not exists(select DataID from LookupData where DataID  = @EntryLevelID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'EntryLevelID', @EntryLevelID, 'LookupData')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end
	
------------------------------------------------------------------------------------------------------------------------------

if  exists(select ExtraBillNo from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and
				ItemCategoryID = @ItemCategoryID and PayStatusID = @PaidPayStatusID)
				 and not @EntryLevelID = @RefundEntryLevelID
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', is already paid for. This record will be auto saved when the item is refunded at Cashier. You can''t save this record.'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category')
		return 1
	end

	if  exists(select ExtraBillNo from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and 
				ItemCategoryID = @ItemCategoryID and len(InvoiceNo) > 0)
				 and not (@EntryLevelID=@RefundEntryLevelID or @EntryLevelID=@InvoiceAdjustmentEntryLevelID )
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', is already invoiced. It will be auto saved when the item is an invoice adjustment is made against its Invoice. You can''t save this record.'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category')
		return 1
	end



if @Quantity > @BillQuantity
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', has more returned items than consumed items.'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category')
		return 1
	end	

	if (@NewPrice > @BillPrice) and (@AdjustmentTypeID = @DownAdjustmentTypeID)
	begin
		set @ErrorMSG = 'The adjusted price cannot be greater than the unit price for %s: %s and %s: %s and %s :%s for '+dbo.GetLookupDataDes(@DownAdjustmentTypeID)+' Adjustment'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategory)
		return 1
	end	
	
	if (@Quantity > 0) and (@AdjustmentTypeID = @UpAdjustmentTypeID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s cannot be adjusted upwards'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category')
		return 1
	end		

	if (@NewPrice < @BillPrice) and (@AdjustmentTypeID = @UpAdjustmentTypeID)
	begin
		set @ErrorMSG = 'The adjusted price cannot be less than the unit price for %s: %s and %s: %s and %s :%s for '+dbo.GetLookupDataDes(@UpAdjustmentTypeID) +' Adjustment'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategory)
		return 1
	end		

-------------------------------------------------------------------------------------------------------
begin
begin tran

insert into ExtraBillItemAdjustments
(AdjustmentNo,ExtraBillNo, ItemCode, ItemCategoryID, Quantity, Amount, Acknowledgeable, EntryLevelID, Notes, LoginID, ClientMachine)
values
(@AdjustmentNo,@ExtraBillNo, @ItemCode, @ItemCategoryID, @Quantity, @Amount, @Acknowledgeable, @EntryLevelID, @Notes, @LoginID, @ClientMachine)

 exec uspUpdateIPDItemUnitPriceQuantity  @ExtraBillNo, @ItemCode, @ItemCategoryID, @NewPrice, @QuantityBalance

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
return 0
end
go


/********************************************************************************************************************
uspEditExtraBillItemAdjustments '1700222001001', '1700222001', 'B4', '7A' ,1, 50000, 50000, 0, '201BFR', 'Na', 'Admin', 'ClinicMaster13'
select * from ExtraBillItems
select * from ExtraBillItemAdjustments
*********************************************************************************************************************/
-------------- Get ExtraBillItemAdjustments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExtraBillItemAdjustments')
	drop proc uspGetExtraBillItemAdjustments
go

create proc uspGetExtraBillItemAdjustments(
@ExtraBillNo varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

--------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------

begin
	select ExtraBillItemAdjustments.AdjustmentNo, ExtraBillItemAdjustments.ExtraBillNo, ExtraBillItemAdjustments.ItemCode, ExtraBillItemAdjustments.ItemCategoryID, 
	dbo.GetLookupDataDes(ExtraBillItemAdjustments.ItemCategoryID) as ItemCategory, dbo.FormatDate(AdjustmentDate) as AdjustmentDate, 
	dbo.GetItemName(ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode) as ItemName,
	dbo.GetMergedNameCode(dbo.GetItemName(ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode), ExtraBillItemAdjustments.ItemCode) as ItemFullName,
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
	ExtraBillItems.Quantity as DispensedQuantity, ExtraBillItemAdjustments.Quantity as ReturnedQuantity, UnitPrice, ExtraBillItemAdjustments.Notes
	from ExtraBillItemAdjustments
	inner join ExtraBillItems on ExtraBillItems.ExtraBillNo = ExtraBillItemAdjustments.ExtraBillNo and
	ExtraBillItems.ItemCode = ExtraBillItemAdjustments.ItemCode and 
	ExtraBillItems.ItemCategoryID = ExtraBillItemAdjustments.ItemCategoryID
	inner join BillAdjustments on BillAdjustments.AdjustmentNo = ExtraBillItemAdjustments.AdjustmentNo
	where ExtraBillItemAdjustments.ExtraBillNo = @ExtraBillNo and ExtraBillItemAdjustments.ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetExtraBillItemAdjustments '1467765004','7d'
******************************************************************************************************/
-- select * from ExtraBillItemAdjustments
-- delete from ExtraBillItemAdjustments

-------------- Get ExtraBillItemsByExtraBillNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExtraBillItemsByExtraBillNo')
	drop proc uspGetExtraBillItemsByExtraBillNo
go

create proc uspGetExtraBillItemsByExtraBillNo(
@ExtraBillNo varchar(20),
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @SystemEntryModeID varchar(10)

--------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------
if @ItemCategoryID is not null
	begin
		select ExtraBillNo, ItemCode,ItemName, dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, Quantity, UnitPrice, 
		(UnitPrice*Quantity) as Amount, PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, EntryModeID, 
		dbo.GetLookupDataDes(EntryModeID) as EntryMode, dbo.IsExtraBillItemReturnable(ExtraBillNo, ItemCategoryID, ItemCode) as Returnable,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillNo, ItemCategoryID, ItemCode) as TotalReturnQuantity,
		dbo.GetExtraBillItemReturnAmount(ExtraBillNo, ItemCategoryID, ItemCode) as TotalReturnAmount 
		from ExtraBillItems
		where ExtraBillNo = @ExtraBillNo and ItemCategoryID = @ItemCategoryID
	end
	else
		begin
		select ExtraBillNo, ItemCode,ItemName, dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, Quantity, UnitPrice, 
		(UnitPrice*Quantity) as Amount, PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, EntryModeID, 
		dbo.GetLookupDataDes(EntryModeID) as EntryMode, dbo.IsExtraBillItemReturnable(ExtraBillNo, ItemCategoryID, ItemCode) as Returnable,
		dbo.GetExtraBillItemReturnQuantity(ExtraBillNo, ItemCategoryID, ItemCode) as TotalReturnQuantity,
		dbo.GetExtraBillItemReturnAmount(ExtraBillNo, ItemCategoryID, ItemCode) as TotalReturnAmount 
		from ExtraBillItems
		where ExtraBillNo = @ExtraBillNo
	end

return 0

go

/******************************************************************************************************
exec uspGetExtraBillItemsByExtraBillNo '1010028001', '7D'
exec uspGetExtraBillItemsByExtraBillNo '1010028003', '7T'
exec uspGetExtraBillItemsByExtraBillNo '044002', '7A'
exec uspGetExtraBillItemsByExtraBillNo '015004', '7A'
select * from ExtraBillItems WHERE EntryModeID = '46SYS' and ItemCategoryID = '7D'

******************************************************************************************************/


-------------- Get ExtraBillToAckwnoledgeExtraBillItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExtraBillToAckwnoledgeExtraBillItems')
	drop proc uspGetExtraBillToAckwnoledgeExtraBillItems
go

create proc uspGetExtraBillToAckwnoledgeExtraBillItems(
@ExtraBillNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @DownAdjustmentTypeID varchar(10)
--------------------------------------------------------------------------------------------------
set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'D')

begin

		begin
			select BillAdjustments.AdjustmentNo, ExtraBillItemAdjustments.ExtraBillNo as ExtrabillNo, ExtraBillItemAdjustments.ItemCode, ExtraBillItemAdjustments.ItemCategoryID, 
			dbo.GetLookupDataDes(ExtraBillItemAdjustments.ItemCategoryID) as ItemCategory, dbo.FormatDate(AdjustmentDate) as AdjustmentDate, 
			dbo.GetItemName(ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode) as ItemName, isAcknowledged, Acknowledgeable,
			dbo.GetMergedNameCode(dbo.GetItemName(ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode), ExtraBillItemAdjustments.ItemCode) as ItemFullName,
			PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
			ExtraBillItems.Quantity as DispensedQuantity, ExtraBillItemAdjustments.Quantity as ReturnedQuantity, UnitPrice, ExtraBillItemAdjustments.Notes,
			dbo.GetInventoryBatchNo(null, ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode) as InventoryBatchNo,
			dbo.GetInventoryExpiryDate(null, ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode) as InventoryExpiryDate
			from ExtraBillItemAdjustments
			inner join ExtraBillItems on ExtraBillItems.ExtraBillNo = ExtraBillItemAdjustments.ExtraBillNo and
			ExtraBillItems.ItemCode = ExtraBillItemAdjustments.ItemCode and 
			ExtraBillItems.ItemCategoryID = ExtraBillItemAdjustments.ItemCategoryID
			inner join BillAdjustments on BillAdjustments.AdjustmentNo = ExtraBillItemAdjustments.AdjustmentNo
			where  ExtraBillItemAdjustments.ExtraBillNo = @ExtraBillNo and Acknowledgeable = 1 and IsAcknowledged = 0 and AdjustmentTypeID =@DownAdjustmentTypeID
			order by ExtraBillItemAdjustments.RecordDateTime desc
		end

return 0
end
go

/******************************************************************************************************
exec uspGetExtraBillToAckwnoledgeExtraBillItems '1010161032'

select * from ExtraBillItemAdjustments
******************************************************************************************************/
-- select * from ExtraBillItemAdjustments
-- delete from ExtraBillItemAdjustments

-------------- Get PeriodicToAckwnoledgeExtraBillItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicToAckwnoledgeExtraBillItems')
	drop proc uspGetPeriodicToAckwnoledgeExtraBillItems
go

create proc uspGetPeriodicToAckwnoledgeExtraBillItems(
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @DownAdjustmentTypeID varchar(10)

set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'D')

--------------------------------------------------------------------------------------------------
if not(@StartDate is null) and not(@EndDate is null)
		begin 
			select ExtraBillItemAdjustments.AdjustmentNo, ExtraBillItemAdjustments.ExtraBillNo as ExtrabillNo, ExtraBillItemAdjustments.ItemCode, ExtraBillItemAdjustments.ItemCategoryID, 
			dbo.GetLookupDataDes(ExtraBillItemAdjustments.ItemCategoryID) as ItemCategory, dbo.FormatDate(AdjustmentDate) as AdjustmentDate, 
			dbo.GetItemName(ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode) as ItemName, isAcknowledged, Acknowledgeable,
			dbo.GetMergedNameCode(dbo.GetItemName(ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode), ExtraBillItemAdjustments.ItemCode) as ItemFullName,
			PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
			ExtraBillItems.Quantity as DispensedQuantity, ExtraBillItemAdjustments.Quantity as ReturnedQuantity, UnitPrice, ExtraBillItemAdjustments.Notes,
			dbo.GetInventoryBatchNo(null, ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode) as InventoryBatchNo,
			dbo.GetInventoryExpiryDate(null, ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode) as InventoryExpiryDate
			from ExtraBillItemAdjustments
			inner join ExtraBillItems on ExtraBillItems.ExtraBillNo = ExtraBillItemAdjustments.ExtraBillNo and
			ExtraBillItems.ItemCode = ExtraBillItemAdjustments.ItemCode and 
			ExtraBillItems.ItemCategoryID = ExtraBillItemAdjustments.ItemCategoryID
			inner join BillAdjustments on BillAdjustments.AdjustmentNo = ExtraBillItemAdjustments.AdjustmentNo
			where Acknowledgeable = 1 and IsAcknowledged =0 and ExtraBillItemAdjustments.Quantity > 0 and AdjustmentTypeID = @DownAdjustmentTypeID
			and AdjustmentDate between @StartDate and @EndDate 
			order by ExtraBillItemAdjustments.RecordDateTime desc
		end
else 
		begin
			select ExtraBillItemAdjustments.AdjustmentNo, ExtraBillItemAdjustments.ExtraBillNo as ExtrabillNo, ExtraBillItemAdjustments.ItemCode, ExtraBillItemAdjustments.ItemCategoryID, 
			dbo.GetLookupDataDes(ExtraBillItemAdjustments.ItemCategoryID) as ItemCategory, dbo.FormatDate(AdjustmentDate) as AdjustmentDate, 
			dbo.GetItemName(ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode) as ItemName,isAcknowledged, Acknowledgeable,
			dbo.GetMergedNameCode(dbo.GetItemName(ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode), ExtraBillItemAdjustments.ItemCode) as ItemFullName,
			PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
			ExtraBillItems.Quantity as DispensedQuantity, ExtraBillItemAdjustments.Quantity as ReturnedQuantity, UnitPrice, ExtraBillItemAdjustments.Notes,
			dbo.GetInventoryBatchNo(null, ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode) as InventoryBatchNo,
			dbo.GetInventoryExpiryDate(null, ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode) as InventoryExpiryDate
			from ExtraBillItemAdjustments
			inner join ExtraBillItems on ExtraBillItems.ExtraBillNo = ExtraBillItemAdjustments.ExtraBillNo and
			ExtraBillItems.ItemCode = ExtraBillItemAdjustments.ItemCode and 
			ExtraBillItems.ItemCategoryID = ExtraBillItemAdjustments.ItemCategoryID
			inner join BillAdjustments on BillAdjustments.AdjustmentNo = ExtraBillItemAdjustments.AdjustmentNo
			where Acknowledgeable = 1 and IsAcknowledged =0 and ExtraBillItemAdjustments.Quantity > 0 and AdjustmentTypeID = @DownAdjustmentTypeID
			order by ExtraBillItemAdjustments.RecordDateTime desc
		end
return 0
go

/******************************************************************************************************
exec uspGetPeriodicToAckwnoledgeExtraBillItems '31 july 2018','7 Aug 2018'
exec uspGetPeriodicToAckwnoledgeExtraBillItems

select * from ExtraBillItemAdjustments
******************************************************************************************************/
-- select * from ExtraBillItemAdjustments
-- delete from ExtraBillItemAdjustments


-------------- update PendingExtraBillItemAdjustments -----------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePendingExtraBillItemAdjustments')
	drop proc uspUpdatePendingExtraBillItemAdjustments
go

create proc uspUpdatePendingExtraBillItemAdjustments(
@AdjustmentNo varchar(20),
@ExtraBillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as
-------------------------------------------------------------------------------------------------
declare @ErrorMSG varchar(200)
declare @TransactionDate smallDatetime

--------------------------------------------------------------------------------------------------

set @TransactionDate = getDate()

--------------------------------------------------------------------------------------------------

if not exists(select ExtraBillNo from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'Extra Bill Items')
		return 1
	end


if not exists(select ExtraBillNo from ExtraBillItemAdjustments where AdjustmentNo = @AdjustmentNo and ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)

begin
set @ErrorMSG = 'The with %s: %s and %s: %s and %s: %s and %s: %s you are trying to update does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Adjustment No', @AdjustmentNo, 'ExtraBill No', @extraBillNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Returned ExtraBill items')
		return 1
end

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Lookup Data')
		return 1
	end
	
------------------------------------------------------------------------------------------------------------------------------

begin
		update ExtraBillItemAdjustments set TransactionDate = @TransactionDate, IsAcknowledged = 1
		where AdjustmentNo = @AdjustmentNo and ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID 
	
		return 0
end

go

/******************************************************************************************************
exec uspUpdatePendingExtraBillItemAdjustments
exec uspUpdatePendingExtraBillItemAdjustments

******************************************************************************************************/
-------------- GetExtraBillItemAdjustmentsByVisitNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExtraBillItemAdjustmentsByVisitNo')
	drop proc uspGetExtraBillItemAdjustmentsByVisitNo
go

create proc uspGetExtraBillItemAdjustmentsByVisitNo(
@VisitNo varchar(20),
@PayStatusID varchar(10)= null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@PayStatusID is null)
	begin
		select 	dbo.FormatText(ExtraBills.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItemAdjustments.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		ExtraBillDate, dbo.GetStaffName(ExtraBills.StaffNo) as AttendingDoctor, 
		ExtraBillItemAdjustments.ItemCode, ExtraBillItemAdjustments.ItemCategoryID, 
		dbo.GetItemName(ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode) as ItemName,
		AdjustmentTypeID, dbo.GetLookupDataDes(AdjustmentTypeID) as AdjustmentType,	
		dbo.GetLookupDataDes(ExtraBillItemAdjustments.ItemCategoryID) as ItemCategory, dbo.FormatDate(AdjustmentDate) as AdjustmentDate, 
		ExtraBillItemAdjustments.Quantity, UnitPrice, ExtraBillItemAdjustments.Quantity * UnitPrice as Amount, 
		ExtraBillItemAdjustments.Notes, LastUpdate, PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode
		from ExtraBillItemAdjustments
		inner join BillAdjustments on BillAdjustments.AdjustmentNo = ExtraBillItemAdjustments.AdjustmentNo
		inner join ExtraBillItems on ExtraBillItems.ExtraBillNo = ExtraBillItemAdjustments.ExtraBillNo and
		ExtraBillItems.ItemCode = ExtraBillItemAdjustments.ItemCode and 
		ExtraBillItems.ItemCategoryID = ExtraBillItemAdjustments.ItemCategoryID
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		where ExtraBills.VisitNo = @VisitNo and PayStatusID = @PayStatusID
	end
else
	begin
		select 	dbo.FormatText(ExtraBills.VisitNo, 'Visits', 'VisitNo') as VisitNo,
		dbo.FormatText(ExtraBillItemAdjustments.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo,	
		ExtraBillDate, dbo.GetStaffName(ExtraBills.StaffNo) as AttendingDoctor, 
		ExtraBillItemAdjustments.ItemCode, ExtraBillItemAdjustments.ItemCategoryID, 
		dbo.GetItemName(ExtraBillItemAdjustments.ItemCategoryID, ExtraBillItemAdjustments.ItemCode) as ItemName,
		AdjustmentTypeID, dbo.GetLookupDataDes(AdjustmentTypeID) as AdjustmentType,	
		dbo.GetLookupDataDes(ExtraBillItemAdjustments.ItemCategoryID) as ItemCategory, dbo.FormatDate(AdjustmentDate) as AdjustmentDate, 
		ExtraBillItemAdjustments.Quantity, UnitPrice, ExtraBillItemAdjustments.Quantity * UnitPrice as Amount, 
		ExtraBillItemAdjustments.Notes, LastUpdate, PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
		EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode
		from ExtraBillItemAdjustments
		inner join BillAdjustments on BillAdjustments.AdjustmentNo = ExtraBillItemAdjustments.AdjustmentNo
		inner join ExtraBillItems on ExtraBillItems.ExtraBillNo = ExtraBillItemAdjustments.ExtraBillNo and
		ExtraBillItems.ItemCode = ExtraBillItemAdjustments.ItemCode and 
		ExtraBillItems.ItemCategoryID = ExtraBillItemAdjustments.ItemCategoryID
		inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
		where ExtraBills.VisitNo = @VisitNo
	end
go

/******************************************************************************************************
exec uspGetExtraBillItemAdjustmentsByVisitNo '1400323005'
exec uspGetExtraBillItemAdjustmentsByVisitNo '1400323005', '12PF'
exec uspGetExtraBillItemAdjustmentsByVisitNo '1110129005'
exec uspGetExtraBillItemAdjustmentsByVisitNo '1110129005', '12NP'

******************************************************************************************************/



------------------------------------------------------------------------------------------------------
---------------------- ItemAdjustments -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ItemAdjustments -----------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditItemAdjustments')
	drop proc uspEditItemAdjustments
go

create proc uspEditItemAdjustments(
@AdjustmentNo varchar(20),
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Quantity int,
@EntryLevelID varchar(10),
@Notes varchar(200),
@Amount money,
@NewPrice money,
@Acknowledgeable bit,
@IsAcknowledged bit = 0,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @PaidPayStatusID varchar(10)

declare @OfferedItemStatusID varchar(10)
declare @TransactionDate smallDatetime
declare @OPDEntryLevel varchar(10)
declare @RefundEntryLevel varchar(10)
declare @CreditNoteEntryLevel varchar(10)
declare @QuantityBalance int
declare @AdjustmentTypeID varchar(10)
declare @DownAdjustmentTypeID varchar(10)
declare @UpAdjustmentTypeID varchar(10)
declare @ItemCategory varchar(100)
declare @ItemAdjustments int
declare @BillQuantity int
declare @BillPrice money
--------------------------------------------------------------------------------------------------
set @PaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'PF')
set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')
set @TransactionDate = getDate()
set @OPDEntryLevel=dbo.GetLookupDataID('DocumentType', 'OPDR')
set @RefundEntryLevel=dbo.GetLookupDataID('DocumentType', 'REF')
set @CreditNoteEntryLevel=dbo.GetLookupDataID('DocumentType', 'CRDNT')

set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'D')
set @UPAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'U')
set @ItemCategory = dbo.GetLookupDataDes(@ItemCategoryID)

set @AdjustmentTypeID = (select AdjustmentTypeID from BillAdjustments where AdjustmentNo = @AdjustmentNo)
set @BillQuantity = (select Quantity from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID) 
set @BillPrice = (select UnitPrice from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID) 

if @AdjustmentTypeID = @DownAdjustmentTypeID                  
set @QuantityBalance = @BillQuantity - @Quantity
else set @QuantityBalance = @BillQuantity
--------------------------------------------------------------------------------------------------

if not exists(select VisitNo from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'Items')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end
	
------------------------------------------------------------------------------------------------------------------------------

if  exists(select VisitNo from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and 
				ItemCategoryID = @ItemCategoryID and PayStatusID = @PaidPayStatusID) 
				 and not @EntryLevelID = @RefundEntryLevel
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', is already paid for. It will be auto saved when a refund is made at cashier. You can''t save this record.'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category')
		return 1
	end

	if  exists(select ItemCode from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and 
				ItemCategoryID = @ItemCategoryID and len(InvoiceNo) > 0)
				 and not (@EntryLevelID = @RefundEntryLevel or @EntryLevelID = @CreditNoteEntryLevel )
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ',  is already invoiced. It will be auto saved when the An Invoice Adjustment is made against its Invoice. You can''t save this record.'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category')
		return 1
	end



if  @Quantity > @BillQuantity
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', can''t have more returned than dispensed items .'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category')
		return 1
	end	
	
	

	if (@NewPrice > @BillPrice) and (@AdjustmentTypeID = @DownAdjustmentTypeID)
	begin
		set @ErrorMSG = 'The adjusted price cannot be greater than the unit price for %s: %s and %s: %s and %s :%s for '+dbo.GetLookupDataDes(@DownAdjustmentTypeID)+' Adjustment'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategory)
		return 1
	end	
	
	if (@Quantity > 0) and (@AdjustmentTypeID = @UpAdjustmentTypeID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s cannot be adjusted upwards'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategory)
		return 1
	end		

	if (@NewPrice < @BillPrice) and (@AdjustmentTypeID = @UpAdjustmentTypeID)
	begin
		set @ErrorMSG = 'The adjusted price cannot be less than the unit price for %s: %s and %s: %s and %s :%s for '+dbo.GetLookupDataDes(@UpAdjustmentTypeID) +' Adjustment'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategory)
		return 1
	end		

-------------------------------------------------------------------------------------------------------	
------------------------------------------------------------------------------------------------------------------------------

	begin
	begin tran
		insert into ItemAdjustments
		(AdjustmentNo,VisitNo, ItemCode, ItemCategoryID, Quantity, EntryLevelID, Notes, Amount, Acknowledgeable, IsAcknowledged, LoginID, ClientMachine)
		values
		(@AdjustmentNo,@VisitNo, @ItemCode, @ItemCategoryID, @Quantity,@EntryLevelID, @Notes,@Amount, @Acknowledgeable, @IsAcknowledged, @LoginID, @ClientMachine)
		

		 exec uspUpdateItemUnitPriceQuantity  @VisitNo, @ItemCode, @ItemCategoryID, @NewPrice, @QuantityBalance
		  	if @@error > 0
				begin
					rollback tran
					return 1		
				end
			commit tran
		return 0
	end
go

/******************************************************************************************************/
/******************************************************************************************************
exec uspEditItemAdjustments
exec uspEditItemAdjustments

******************************************************************************************************/
-- select * from ItemAdjustments
-- delete from ItemAdjustments

-------------- Get ItemAdjustments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetItemAdjustments')
	drop proc uspGetItemAdjustments
go

create proc uspGetItemAdjustments(
@VisitNo varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select ItemAdjustments.AdjustmentNo,ItemAdjustments.VisitNo, ItemAdjustments.ItemCode, ItemAdjustments.ItemCategoryID, 
	dbo.GetLookupDataDes(ItemAdjustments.ItemCategoryID) as ItemCategory, dbo.FormatDate(AdjustmentDate) as AdjustmentDate, 
	dbo.GetItemName(ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode) as ItemName,
	dbo.GetMergedNameCode(dbo.GetItemName(ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode), ItemAdjustments.ItemCode) as ItemFullName,
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, Items.Quantity as DispensedQuantity, Amount, Acknowledgeable, IsAcknowledged, 
	ItemAdjustments.Quantity as ReturnedQuantity, EntryLevelID, dbo.GetLookupDataDes(EntryLevelID) as EntryLevel, UnitPrice, ItemAdjustments.Notes
	from ItemAdjustments
	inner join Items on Items.VisitNo = ItemAdjustments.VisitNo and
	Items.ItemCode = ItemAdjustments.ItemCode and 
	Items.ItemCategoryID = ItemAdjustments.ItemCategoryID
	inner join BillAdjustments on BillAdjustments.AdjustmentNo = ItemAdjustments.AdjustmentNo
	where ItemAdjustments.VisitNo = @VisitNo and ItemAdjustments.ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetItemAdjustments '1467765004','7d'
******************************************************************************************************/
-- select * from ItemAdjustments
-- delete from ItemAdjustments


-------------- Get ToReturnItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetToReturnItems')
	drop proc uspGetToReturnItems
go

create proc uspGetToReturnItems(
@VisitNo varchar(20),
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)
 declare @OfferedItemStatusID varchar(10)
 declare @DrugItemCategoryID varchar(10)
 declare @ConsumableItemCategoryID varchar(10)
 declare @Returnable bit

--------------------------------------------------------------------------------------------------
set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')
set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')
set @Returnable = 1
--------------------------------------------------------------------------------------------------
if @ItemCategoryID is not null
	begin
		select VisitNo, ItemCode,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName,
		dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
		dbo.GetReturnedItemQuantity(Items.VisitNo,Items.ItemCode,Items.ItemCategoryID) as TotalReturnQuantity,
		(dbo.GetReturnedItemQuantity(Items.VisitNo,Items.ItemCode,Items.ItemCategoryID) * UnitPrice) as TotalReturnAmount,
		@Returnable as Returnable, Quantity, UnitPrice, (Quantity* UnitPrice) as Amount, PayStatusID, 
		dbo.GetLookupDataDes(PayStatusID) as PayStatus
		from Items
		where VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID
	end

	else
	begin
		select VisitNo, ItemCode,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName,
		dbo.GetMergedNameCode(Items.ItemName, Items.ItemCode) as ItemFullName,
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
		dbo.GetReturnedItemQuantity(Items.VisitNo,Items.ItemCode,Items.ItemCategoryID) as TotalReturnQuantity,
		(dbo.GetReturnedItemQuantity(Items.VisitNo,Items.ItemCode,Items.ItemCategoryID) * UnitPrice) as TotalReturnAmount,
		@Returnable as Returnable, Quantity, UnitPrice, (Quantity* UnitPrice) as Amount, PayStatusID, 
		dbo.GetLookupDataDes(PayStatusID) as PayStatus
		from Items
		where VisitNo = @VisitNo
		
	end

return 0

go

/******************************************************************************************************
exec uspGetToReturnItems '1012136005', '7C'
exec uspGetToReturnItems '140032312', '7T'

******************************************************************************************************/
-- select * from Items where VisitNo = '001005'
-- delete from Items



-------------- update PendingItemAdjustments -----------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePendingItemAdjustments')
	drop proc uspUpdatePendingItemAdjustments
go

create proc uspUpdatePendingItemAdjustments(
@AdjustmentNo varchar(20),
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as
-------------------------------------------------------------------------------------------------
declare @ErrorMSG varchar(200)
declare @TransactionDate smallDatetime


--------------------------------------------------------------------------------------------------

set @TransactionDate = getDate()

--------------------------------------------------------------------------------------------------

if not exists(select VisitNo from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Items')
		return 1
	end


if not exists(select VisitNo from ItemAdjustments where AdjustmentNo = @AdjustmentNo and VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)

begin
set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to update does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'AdjustmentNo', @AdjustmentNo, 'Visit No', @VisitNo,'ItemCode', @ItemCode,'Item Category ID', @ItemCategoryID, 'Returned items')
		return 1
end


	
------------------------------------------------------------------------------------------------------------------------------

	begin
		update ItemAdjustments set TransactionDate = @TransactionDate, IsAcknowledged =1
		where AdjustmentNo = @AdjustmentNo and VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID 
		
		return 0
	end
go

/******************************************************************************************************
exec uspUpdatePendingItemAdjustments
exec uspUpdatePendingItemAdjustments
select * from ItemAdjustments order by TransactionDate desc
select * from Inventory order by RecordDateTime desc
******************************************************************************************************/


-------------- Get PeriodicToAcknowledgeItemAdjustments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicToAcknowledgeItemAdjustments')
	drop proc uspGetPeriodicToAcknowledgeItemAdjustments
go

create proc uspGetPeriodicToAcknowledgeItemAdjustments(
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @ErrorMSG varchar(200)

--------------------------------------------------------------------------------------------------

if not(@StartDate is null) and not(@EndDate is null)
		begin
			select  ItemAdjustments.AdjustmentNo, ItemAdjustments.VisitNo as VisitNo, ItemAdjustments.ItemCode, ItemAdjustments.ItemCategoryID, 
			dbo.GetLookupDataDes(ItemAdjustments.ItemCategoryID) as ItemCategory, dbo.FormatDate(AdjustmentDate) as AdjustmentDate, 
			dbo.GetItemName(ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode) as ItemName, isAcknowledged, Acknowledgeable,
			dbo.GetMergedNameCode(dbo.GetItemName(ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode), ItemAdjustments.ItemCode) as ItemFullName,
			PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, Items.Quantity as DispensedQuantity, 
			ItemAdjustments.Quantity as ReturnedQuantity, UnitPrice, ItemAdjustments.Notes,
			dbo.GetInventoryBatchNo(null, ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode) as InventoryBatchNo,
			dbo.GetInventoryExpiryDate(null, ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode) as InventoryExpiryDate
			from ItemAdjustments
			inner join Items on Items.VisitNo = ItemAdjustments.VisitNo and Items.ItemCode = ItemAdjustments.ItemCode and Items.ItemCategoryID = ItemAdjustments.ItemCategoryID
			inner join BillAdjustments on BillAdjustments.AdjustmentNo = ItemAdjustments.AdjustmentNo
			where Acknowledgeable = 1 and IsAcknowledged =0 and AdjustmentDate between @StartDate and @EndDate 
			order by AdjustmentDate, ItemAdjustments.RecordDateTime desc
		end
else
	begin
		select BillAdjustments.AdjustmentNo, ItemAdjustments.VisitNo as VisitNo, ItemAdjustments.ItemCode, ItemAdjustments.ItemCategoryID, 
			dbo.GetLookupDataDes(ItemAdjustments.ItemCategoryID) as ItemCategory, dbo.FormatDate(AdjustmentDate) as AdjustmentDate, 
			dbo.GetItemName(ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode) as ItemName, isAcknowledged, Acknowledgeable,
			dbo.GetMergedNameCode(dbo.GetItemName(ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode), ItemAdjustments.ItemCode) as ItemFullName,
			PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, Items.Quantity as DispensedQuantity, 
			ItemAdjustments.Quantity as ReturnedQuantity, UnitPrice, ItemAdjustments.Notes,
			dbo.GetInventoryBatchNo(null, ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode) as InventoryBatchNo,
			dbo.GetInventoryExpiryDate(null, ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode) as InventoryExpiryDate
			from ItemAdjustments
			inner join Items on Items.VisitNo = ItemAdjustments.VisitNo and Items.ItemCode = ItemAdjustments.ItemCode and Items.ItemCategoryID = ItemAdjustments.ItemCategoryID
		inner join BillAdjustments on BillAdjustments.AdjustmentNo = ItemAdjustments.AdjustmentNo

			where   Acknowledgeable = 1 and IsAcknowledged =0 order by AdjustmentDate, ItemAdjustments.RecordDateTime desc
	end
return 0
go

/******************************************************************************************************
exec uspGetPeriodicToAcknowledgeItemAdjustments '1 Jan 2018','20 Jul 2018'
exec uspGetPeriodicToAcknowledgeItemAdjustments
select * from ItemAdjustments
******************************************************************************************************/
-- select * from ItemAdjustments
-- delete from ItemAdjustments

-------------- Get VisitToAcknowkedgeItemAdjustments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisitToAcknowkedgeItemAdjustments')
	drop proc uspGetVisitToAcknowkedgeItemAdjustments
go

create proc uspGetVisitToAcknowkedgeItemAdjustments(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


--------------------------------------------------------------------------------------------------

begin
	
		select ItemAdjustments.AdjustmentNo, ItemAdjustments.VisitNo as VisitNo, ItemAdjustments.ItemCode, ItemAdjustments.ItemCategoryID, 
		dbo.GetLookupDataDes(ItemAdjustments.ItemCategoryID) as ItemCategory, dbo.FormatDate(AdjustmentDate) as AdjustmentDate, 
		dbo.GetItemName(ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode) as ItemName, isAcknowledged, Acknowledgeable,
		dbo.GetMergedNameCode(dbo.GetItemName(ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode), ItemAdjustments.ItemCode) as ItemFullName,
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
		Items.Quantity as DispensedQuantity, ItemAdjustments.Quantity as ReturnedQuantity, UnitPrice, ItemAdjustments.Notes,
		dbo.GetInventoryBatchNo(null, ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode) as InventoryBatchNo,
		dbo.GetInventoryExpiryDate(null, ItemAdjustments.ItemCategoryID, ItemAdjustments.ItemCode) as InventoryExpiryDate
		from ItemAdjustments
		inner join Items on Items.VisitNo = ItemAdjustments.VisitNo and Items.ItemCode = ItemAdjustments.ItemCode and  Items.ItemCategoryID = ItemAdjustments.ItemCategoryID
		inner join BillAdjustments on BillAdjustments.AdjustmentNo = ItemAdjustments.AdjustmentNo
		where ItemAdjustments.VisitNo = @VisitNo and Acknowledgeable = 1 and IsAcknowledged =0
		order by ItemAdjustments.RecordDateTime desc

return 0
end
go

/******************************************************************************************************
exec uspGetVisitToAcknowkedgeItemAdjustments '10 10390006'
select * from ItemAdjustments
******************************************************************************************************/
-- select * from ItemAdjustments
-- delete from ItemAdjustments




------------------------- GetInventoryBatchNo ---------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetInventoryBatchNo')
	drop proc uspGetInventoryBatchNo
go

create proc uspGetInventoryBatchNo(
@LocationID varchar(10) = null, 
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@BatchNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @DrugCategoryID varchar(10)
declare @ConsumableCategoryID varchar(10)

-------------------------------------------------------------------------------------------------------------------
set @DrugCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')
-------------------------------------------------------------------------------------------------------------------

if (@ItemCategoryID = @DrugCategoryID) and (not exists(select DrugNo from Drugs where DrugNo = @ItemCode)) -- Drugs
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Drugs')	
			return 1
		end
	
else if (@ItemCategoryID = @ConsumableCategoryID) and 
		(not exists(select ConsumableNo from ConsumableItems where ConsumableNo  = @ItemCode)) -- Consumable Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Consumable Items')	
			return 1
		end
		
begin set @BatchNo = dbo.GetInventoryBatchNo(@LocationID, @ItemCategoryID, @ItemCode) end

return 0
go

------------------------- GetInventoryExpiryDate ---------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetInventoryExpiryDate')
	drop proc uspGetInventoryExpiryDate
go

create proc uspGetInventoryExpiryDate(
@LocationID varchar(10) = null, 
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@ExpiryDate smalldatetime = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @DrugCategoryID varchar(10)
declare @ConsumableCategoryID varchar(10)

-------------------------------------------------------------------------------------------------------------------
set @DrugCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')
-------------------------------------------------------------------------------------------------------------------

if (@ItemCategoryID = @DrugCategoryID) and (not exists(select DrugNo from Drugs where DrugNo = @ItemCode)) -- Drugs
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Drugs')	
			return 1
		end
	
else if (@ItemCategoryID = @ConsumableCategoryID) and 
		(not exists(select ConsumableNo from ConsumableItems where ConsumableNo  = @ItemCode)) -- Consumable Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Consumable Items')	
			return 1
		end
		
begin set @ExpiryDate = dbo.GetInventoryExpiryDate(@LocationID, @ItemCategoryID, @ItemCode) end

return 0
go



------------------------------------------------------------------------------------------------------
------------- PaymentExtraBillItems ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert PaymentExtraBillItems ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPaymentExtraBillItems')
	drop proc uspInsertPaymentExtraBillItems
go

create proc uspInsertPaymentExtraBillItems(
@ReceiptNo varchar(20),
@ExtraBillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Quantity int,
@UnitPrice money,
@Discount money ,
@Amount money 
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select ReceiptNo from Payments where ReceiptNo = @ReceiptNo)
	begin
		set @ErrorMSG = 'The Receipt No: ' + @ReceiptNo + ', you are trying to enter does not exist in the registered Payments'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select ExtraBillNo from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'Extra Bill Items')
		return 1
	end

if exists(select ReceiptNo from PaymentExtraBillItems where ReceiptNo = @ReceiptNo and ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID)
		return 1
	end

else
begin
insert into PaymentExtraBillItems
(ReceiptNo, ExtraBillNo, ItemCode, ItemCategoryID, Quantity, UnitPrice, Discount, Amount) 
values
(@ReceiptNo, @ExtraBillNo, @ItemCode, @ItemCategoryID, @Quantity, @UnitPrice, @Discount, @Amount)
return 0
end
go


if exists (select * from sysobjects where name = 'uspGetPaymentExtraBillItems')
	drop proc uspGetPaymentExtraBillItems
go

create proc uspGetPaymentExtraBillItems(
@ReceiptNo varchar(20),
@ItemCategoryID varchar(10)=null
)with encryption as

declare @ErrorMSG varchar(200)
declare @IPDVisitTypeID varchar(10)
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')

  if not exists(select ReceiptNo from PaymentExtraBillItems where ReceiptNo = @ReceiptNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not have entries in %s'
			raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payment Extra Bill Items')
			return 1
		end

 if @ItemCategoryID is null
  begin
			select PaymentExtraBillItems.ReceiptNo, dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,
	dbo.FormatDate(ExtraBillDate) as ExtraBillDate, 
	dbo.FormatText(PaymentExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, 
	dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
	dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, PaymentExtraBillItems.ItemCode, 
	dbo.GetItemName(PaymentExtraBillItems.ItemCategoryID, PaymentExtraBillItems.ItemCode) as ItemName, MemberCardNo, ClaimReferenceNo, PaymentExtraBillItems.ItemCategoryID, 
	dbo.GetLookupDataDes(PaymentExtraBillItems.ItemCategoryID) as ItemCategory, PaymentExtraBillItems.Quantity,
	 PaymentExtraBillItems.UnitPrice, Discount, 
	Amount, dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, CoPayTypeID, 
	dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	dbo.IsReturnableIPDInventory(Admissions.VisitNo, PaymentExtraBillItems.ItemCategoryID, PaymentExtraBillItems.ItemCode) as IsReturnable,
	dbo.FormatMoney(dbo.GetIPDRefundItemAmount(PaymentExtraBillItems.ReceiptNo,PaymentExtraBillItems.ExtraBillNo,PaymentExtraBillItems.ItemCode,PaymentExtraBillItems.ItemCategoryID)) as RefundedAmount,
	dbo.GetIPDRefundItemQuantity(PaymentExtraBillItems.ReceiptNo,PaymentExtraBillItems.ExtraBillNo, PaymentExtraBillItems.ItemCode, PaymentExtraBillItems.ItemCategoryID) as RefundedQuantity,
	ExtraBillItems.InvoiceNo as InvoiceNo, ExtraBillItems.Quantity as BillQuantity, ExtraBillItems.UnitPrice as BillPrice,
	(Amount - dbo.GetIPDRefundItemAmount(PaymentExtraBillItems.ReceiptNo,PaymentExtraBillItems.ExtraBillNo,PaymentExtraBillItems.ItemCode,PaymentExtraBillItems.ItemCategoryID)) as AmountBalance
	from PaymentExtraBillItems	
	inner join Payments on PaymentExtraBillItems.ReceiptNo = Payments.ReceiptNo	
	inner join ExtraBills on PaymentExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join ExtraBillItems on ExtraBillItems.ExtraBillNo = PaymentExtraBillItems.ExtraBillNo 
	and ExtraBillItems.ItemCategoryID = PaymentExtraBillItems.ItemCategoryID and ExtraBillItems.ItemCode = PaymentExtraBillItems.ItemCode
	inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo							
	inner join Patients on Admissions.PatientNo = Patients.PatientNo					
			where PaymentExtraBillItems.ReceiptNo = @ReceiptNo

	end

else if not @ItemCategoryID is null 
begin
	select PaymentExtraBillItems.ReceiptNo, dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,
	dbo.FormatDate(ExtraBillDate) as ExtraBillDate, 
	dbo.FormatText(PaymentExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, 
	dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
	dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, PaymentExtraBillItems.ItemCode, 
	dbo.GetItemName(PaymentExtraBillItems.ItemCategoryID, PaymentExtraBillItems.ItemCode) as ItemName, MemberCardNo, ClaimReferenceNo, PaymentExtraBillItems.ItemCategoryID, 
	dbo.GetLookupDataDes(PaymentExtraBillItems.ItemCategoryID) as ItemCategory, PaymentExtraBillItems.Quantity, PaymentExtraBillItems.UnitPrice, Discount, 
	Amount, dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, CoPayTypeID, 
	dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	dbo.IsReturnableIPDInventory(Admissions.VisitNo, PaymentExtraBillItems.ItemCategoryID, PaymentExtraBillItems.ItemCode) as IsReturnable,
	dbo.FormatMoney(dbo.GetIPDRefundItemAmount(PaymentExtraBillItems.ReceiptNo,PaymentExtraBillItems.ExtraBillNo,PaymentExtraBillItems.ItemCode,PaymentExtraBillItems.ItemCategoryID)) as RefundedAmount,
	dbo.GetIPDRefundItemQuantity(PaymentExtraBillItems.ReceiptNo,PaymentExtraBillItems.ExtraBillNo, PaymentExtraBillItems.ItemCode, PaymentExtraBillItems.ItemCategoryID) as RefundedQuantity,
	ExtraBillItems.InvoiceNo as InvoiceNo, ExtraBillItems.Quantity as BillQuantity, ExtraBillItems.UnitPrice as BillPrice,
	(Amount - dbo.GetIPDRefundItemAmount(PaymentExtraBillItems.ReceiptNo,PaymentExtraBillItems.ExtraBillNo,PaymentExtraBillItems.ItemCode,PaymentExtraBillItems.ItemCategoryID)) as AmountBalance

	from PaymentExtraBillItems	
	inner join Payments on PaymentExtraBillItems.ReceiptNo = Payments.ReceiptNo	
	inner join ExtraBills on PaymentExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join ExtraBillItems on ExtraBillItems.ExtraBillNo = PaymentExtraBillItems.ExtraBillNo 
	and ExtraBillItems.ItemCategoryID = PaymentExtraBillItems.ItemCategoryID and ExtraBillItems.ItemCode = PaymentExtraBillItems.ItemCode
	inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo							
	inner join Patients on Admissions.PatientNo = Patients.PatientNo					
	where PaymentExtraBillItems.ReceiptNo = @ReceiptNo and PaymentExtraBillItems.ItemCategoryID = @ItemCategoryID
end
return 0
go


/******************************************************************************************************
exec uspGetPaymentExtraBillItems '13032788','7R'
exec uspGetPaymentExtraBillItems '170061546',null
exec uspGetPaymentExtraBillItems '13032788',null

******************************************************************************************************/
-- select * from PaymentExtraBillItems
-- delete from PaymentExtraBillItems



if exists (select * from sysobjects where name = 'uspGetVisitPaymentExtraBillItems')
	drop proc uspGetVisitPaymentExtraBillItems
go

create proc uspGetVisitPaymentExtraBillItems(
@ReceiptNo varchar(20),
@VisitNo varchar(20),
@ItemCategoryID varchar(10)=null
)with encryption as

declare @ErrorMSG varchar(200)
declare @IPDVisitTypeID varchar(10)
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')

  if not exists(select ReceiptNo from PaymentExtraBillItems where ReceiptNo = @ReceiptNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not have entries in %s'
			raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payment Extra Bill Items')
			return 1
		end

 if @ItemCategoryID is null
  begin
			select PaymentExtraBillItems.ReceiptNo, dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,
	dbo.FormatDate(ExtraBillDate) as ExtraBillDate, 
	dbo.FormatText(PaymentExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, 
	dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
	dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, PaymentExtraBillItems.ItemCode, 
	dbo.GetItemName(PaymentExtraBillItems.ItemCategoryID, PaymentExtraBillItems.ItemCode) as ItemName, MemberCardNo, ClaimReferenceNo, PaymentExtraBillItems.ItemCategoryID, 
	dbo.GetLookupDataDes(PaymentExtraBillItems.ItemCategoryID) as ItemCategory, PaymentExtraBillItems.Quantity, PaymentExtraBillItems.UnitPrice, Discount, 
	Amount, dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, CoPayTypeID, 
	dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	dbo.IsReturnableIPDInventory(Admissions.VisitNo, PaymentExtraBillItems.ItemCategoryID, PaymentExtraBillItems.ItemCode) as IsReturnable,
	dbo.FormatMoney(dbo.GetIPDRefundItemAmount(PaymentExtraBillItems.ReceiptNo,PaymentExtraBillItems.ExtraBillNo,PaymentExtraBillItems.ItemCode,PaymentExtraBillItems.ItemCategoryID)) as RefundedAmount,
	dbo.GetIPDRefundItemQuantity(PaymentExtraBillItems.ReceiptNo,PaymentExtraBillItems.ExtraBillNo, PaymentExtraBillItems.ItemCode, PaymentExtraBillItems.ItemCategoryID) as RefundedQuantity,
	ExtraBillItems.InvoiceNo as InvoiceNo, ExtraBillItems.Quantity as BillQuantity, ExtraBillItems.UnitPrice as BillPrice,
	(Amount - dbo.GetIPDRefundItemAmount(PaymentExtraBillItems.ReceiptNo,PaymentExtraBillItems.ExtraBillNo,PaymentExtraBillItems.ItemCode,PaymentExtraBillItems.ItemCategoryID)) as AmountBalance

	from PaymentExtraBillItems	
	inner join Payments on PaymentExtraBillItems.ReceiptNo = Payments.ReceiptNo	
	inner join ExtraBills on PaymentExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join ExtraBillItems on ExtraBillItems.ExtraBillNo = PaymentExtraBillItems.ExtraBillNo 
	and ExtraBillItems.ItemCategoryID = PaymentExtraBillItems.ItemCategoryID and ExtraBillItems.ItemCode = PaymentExtraBillItems.ItemCode
	inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo							
	inner join Patients on Admissions.PatientNo = Patients.PatientNo					
			where PaymentExtraBillItems.ReceiptNo = @ReceiptNo and PaymentExtraBillItems.ExtraBillNo = @VisitNo

	end

else if not @ItemCategoryID is null 
begin
	select PaymentExtraBillItems.ReceiptNo, dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,
	dbo.FormatDate(ExtraBillDate) as ExtraBillDate, 
	dbo.FormatText(PaymentExtraBillItems.ExtraBillNo, 'ExtraBills', 'ExtraBillNo') as ExtraBillNo, 
	dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
	dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, PaymentExtraBillItems.ItemCode, 
	dbo.GetItemName(PaymentExtraBillItems.ItemCategoryID, PaymentExtraBillItems.ItemCode) as ItemName, MemberCardNo, ClaimReferenceNo, PaymentExtraBillItems.ItemCategoryID, 
	dbo.GetLookupDataDes(PaymentExtraBillItems.ItemCategoryID) as ItemCategory, PaymentExtraBillItems.Quantity, PaymentExtraBillItems.UnitPrice, Discount, 
	Amount, dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, CoPayTypeID, 
	dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue,
	dbo.IsReturnableIPDInventory(Admissions.VisitNo, PaymentExtraBillItems.ItemCategoryID, PaymentExtraBillItems.ItemCode) as IsReturnable,
	dbo.FormatMoney(dbo.GetIPDRefundItemAmount(PaymentExtraBillItems.ReceiptNo,PaymentExtraBillItems.ExtraBillNo,PaymentExtraBillItems.ItemCode,PaymentExtraBillItems.ItemCategoryID)) as RefundedAmount,
	dbo.GetIPDRefundItemQuantity(PaymentExtraBillItems.ReceiptNo,PaymentExtraBillItems.ExtraBillNo, PaymentExtraBillItems.ItemCode, PaymentExtraBillItems.ItemCategoryID) as RefundedQuantity,
	ExtraBillItems.InvoiceNo as InvoiceNo, ExtraBillItems.Quantity as BillQuantity, ExtraBillItems.UnitPrice as BillPrice,
	(Amount - dbo.GetIPDRefundItemAmount(PaymentExtraBillItems.ReceiptNo,PaymentExtraBillItems.ExtraBillNo,PaymentExtraBillItems.ItemCode,PaymentExtraBillItems.ItemCategoryID)) as AmountBalance

	from PaymentExtraBillItems	
	inner join Payments on PaymentExtraBillItems.ReceiptNo = Payments.ReceiptNo	
	inner join ExtraBills on PaymentExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join ExtraBillItems on ExtraBillItems.ExtraBillNo = PaymentExtraBillItems.ExtraBillNo 
	and ExtraBillItems.ItemCategoryID = PaymentExtraBillItems.ItemCategoryID and ExtraBillItems.ItemCode = PaymentExtraBillItems.ItemCode
	inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo							
	inner join Patients on Admissions.PatientNo = Patients.PatientNo					
	where PaymentExtraBillItems.ReceiptNo = @ReceiptNo and PaymentExtraBillItems.ExtraBillNo = @VisitNo 
	and PaymentExtraBillItems.ItemCategoryID = @ItemCategoryID
end
return 0
go


/******************************************************************************************************
exec uspGetVisitPaymentExtraBillItems '180008027', '1013855018','7R'
exec uspGetVisitPaymentExtraBillItems '180008027', '1013855018', null

******************************************************************************************************/
-- select VisitNo, * from PaymentExtraBillItems inner join ExtraBills on ExtraBills.ExtraBillNo = PaymentExtraBillItems.ExtraBillNo
-- delete from PaymentExtraBillItems




------------------------------------------------------------------------------------------------------
-------------- Claims --------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Claims -------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertClaims')
	drop proc uspInsertClaims
go

create proc uspInsertClaims(
@ClaimNo varchar(20),
@MedicalCardNo varchar(20),
@PatientNo varchar(20),
@VisitDate smalldatetime,
@VisitTime varchar(8),
@HealthUnitCode varchar(10) = null,
@PrimaryDoctor varchar(41),
@ClaimStatusID varchar(10),
@ClaimEntryID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ClaimID int

declare @PaddingLEN tinyint

declare @PassedClaimID int
declare @PassedClaimNo varchar(20)
declare @PassedMedicalCardNo varchar(20)

if exists(select ClaimNo from Claims where ClaimNo = @ClaimNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo)
		return 1
	end

if not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo  = @MedicalCardNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @MedicalCardNo, 'Scheme Members')
		return 1
	end

if not (@HealthUnitCode is null or @HealthUnitCode = '') 
	begin
		if not exists(select HealthUnitCode from HealthUnits where HealthUnitCode  = @HealthUnitCode)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Health Unit Code', @HealthUnitCode, 'Health Units')
				return 1
			end
	end
else if (@HealthUnitCode is null or @HealthUnitCode = '')
begin set @HealthUnitCode = null end

if not exists(select DataID from LookupData where DataID = @ClaimStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim Status ID', @ClaimStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ClaimEntryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim Entry ID', @ClaimEntryID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

----------------------------------------------------------------------------------------------------------

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'Claims' and AutoColumnName = 'ClaimNo'

set @PassedMedicalCardNo = ltrim(rtrim(substring(@ClaimNo, 1, len(@ClaimNo) - @PaddingLEN)))

if (@PassedMedicalCardNo = @MedicalCardNo)

begin

	set @PassedClaimID = 1
	set @PassedClaimNo = @ClaimNo

	set @PassedClaimNo = ltrim(rtrim(substring(@PassedClaimNo, len(@PassedMedicalCardNo) + 1, @PaddingLEN)))

	if isnumeric(@PassedClaimNo) = 1 set @PassedClaimID = @PassedClaimNo
	else set @PassedClaimID = 1

	set @ClaimID = (select max(ClaimID) from Claims where MedicalCardNo = @MedicalCardNo)
	set @ClaimID = dbo.GetNextAutoNumber('Claims', 'ClaimNo', @ClaimID)

	if @PassedClaimID < @ClaimID set @ClaimID = @PassedClaimID
	if @PassedClaimID > @ClaimID set @ClaimID = @PassedClaimID

end else set @ClaimID = 1

----------------------------------------------------------------------------------------------------------

insert into Claims
(ClaimID, ClaimNo, MedicalCardNo, PatientNo, VisitDate, VisitTime, 
HealthUnitCode, PrimaryDoctor, ClaimStatusID, ClaimEntryID, LoginID)
values
(@ClaimID, @ClaimNo, @MedicalCardNo, @PatientNo, @VisitDate, @VisitTime, 
@HealthUnitCode, @PrimaryDoctor, @ClaimStatusID, @ClaimEntryID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertClaims '123001', '123', '', '19 oct 2011', '13:45:00', 'HU01', '', '45AP', '46MAN', 'Admin'
exec uspInsertClaims '123002', '123', '', '19 oct 2011', '13:45:00', 'HU01', '', '45AP', '46SYS', 'Admin'
exec uspInsertClaims 'M01023482001', 'M01023482', '', '19 oct 2011', '13:45:00', 'HU01', 'Byarugaba S', '45AP', '46SYS', 'Admin'
exec uspInsertClaims 'M01023482002', 'M01023482', '', '19 oct 2011', '13:45:00', 'HU01', '', '45AP', '46MAN', 'Admin'

*******************************************************************************************************/
-- select * from Claims
-- delete from Claims

-------------- Update Claims -------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateClaims')
	drop proc uspUpdateClaims
go

create proc uspUpdateClaims(
@ClaimNo varchar(20),
@MedicalCardNo varchar(20),
@PatientNo varchar(20),
@VisitDate smalldatetime,
@VisitTime varchar(8),
@HealthUnitCode varchar(10),
@PrimaryDoctor varchar(41),
@ClaimStatusID varchar(10),
@ClaimEntryID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ManualEntryID varchar(10)

-------------------------------------------------------------------------------------
set @ManualEntryID = dbo.GetLookupDataID('ClaimEntry', 'MAN')
-------------------------------------------------------------------------------------

if not exists(select ClaimNo from Claims where ClaimNo = @ClaimNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo, 'Claims')
		return 1
	end

--if exists(select ClaimNo from Claims where ClaimNo = @ClaimNo and not ClaimEntryID = @ManualEntryID)
--	begin
--		set @ErrorMSG = 'This Claim is not user entered. You can''t update it'
--		raiserror(@ErrorMSG, 16, 1)	
--		return 1
--	end

--if not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo  = @MedicalCardNo)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @MedicalCardNo, 'Scheme Members')
--		return 1
--	end

if not exists(select HealthUnitCode from HealthUnits where HealthUnitCode  = @HealthUnitCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Health Unit Code', @HealthUnitCode, 'Health Units')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ClaimStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim Status ID', @ClaimStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ClaimEntryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim Entry ID', @ClaimEntryID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update Claims set --MedicalCardNo = @MedicalCardNo, 
PatientNo = @PatientNo, VisitDate = @VisitDate, VisitTime = @VisitTime, HealthUnitCode = @HealthUnitCode, 
PrimaryDoctor = @PrimaryDoctor, ClaimStatusID = @ClaimStatusID, ClaimEntryID = @ClaimEntryID, LoginID = @LoginID
where ClaimNo = @ClaimNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateClaims '123002', '123666', '2', '12 oct 2011', '12:45:00', 'HU02', '2', '45RD', '46MAN', 'Admin'

******************************************************************************************************/
-- select * from Claims
-- delete from Claims

-------------- Get Claims -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetClaims')
	drop proc uspGetClaims
go

create proc uspGetClaims(
@ClaimNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ClaimNo from Claims where ClaimNo = @ClaimNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo, 'Claims')
		return 1
	end
else
begin
	select Claims.ClaimNo, Claims.MedicalCardNo, PatientNo, CompanyName, 
	PolicyName, Insurances.InsuranceNo, InsuranceName, Surname, FirstName, 
	MiddleName, dbo.GetFullName(Surname, MiddleName, FirstName) as FullName, 
	BirthDate, dbo.GetAge(BirthDate, getdate()) as Age, Photo,
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender, VisitNo, HealthUnitName,
	JoinDate, MemberTypeID, dbo.GetLookupDataDes(MemberTypeID) as MemberType, 
	MainMemberNo, dbo.GetSchemeMemberName(MainMemberNo) as MainMemberName,
	MemberStatusID, dbo.GetLookupDataDes(MemberStatusID) as MemberStatus,
	PolicyStartDate, PolicyEndDate, VisitDate, VisitTime, Claims.HealthUnitCode, 
	PrimaryDoctor, ClaimStatusID, dbo.GetLookupDataDes(ClaimStatusID) as ClaimStatus, 
	ClaimEntryID, dbo.GetLookupDataDes(ClaimEntryID) as ClaimEntry
	from Claims
	left outer join ClaimsEXT on Claims.ClaimNo = ClaimsEXT.ClaimNo
	inner join SchemeMembers on Claims.MedicalCardNo = SchemeMembers.MedicalCardNo	
	inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
	and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
	inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
	inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
	inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
	left outer join HealthUnits on Claims.HealthUnitCode = HealthUnits.HealthUnitCode
	where Claims.ClaimNo = @ClaimNo
return 0
end
go

/******************************************************************************************************
exec uspGetClaims '123002'

******************************************************************************************************/
-- select * from Claims
-- delete from Claims



------------------------------------------------------------------------------------------------------
-------------- ClaimPayments --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ClaimPayments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertClaimPayments')
	drop proc uspInsertClaimPayments
go

create proc uspInsertClaimPayments(
@ClaimNo varchar(20),
@PaymentDateTime smallDatetime,
@PayStatusID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ClaimNo from Claims where ClaimNo  = @ClaimNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo, 'Claims')
		return 1
	end

if exists(select ClaimNo from ClaimPayments where ClaimNo = @ClaimNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pay Status ID', @PayStatusID, 'Lookup Data')
		return 1
	end

begin
insert into ClaimPayments
(ClaimNo, PaymentDateTime, PayStatusID, LoginID)
values
(@ClaimNo, @PaymentDateTime, @PayStatusID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertClaimPayments
******************************************************************************************************/
-- select * from ClaimPayments
-- delete from ClaimPayments

-------------------------------------------------------------------------------------------------
-------------- Claim Summaries By Company ----------------------------------------------------------
-------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetClaimsGeneralConsumption')
	drop proc uspGetClaimsGeneralConsumption
go

create proc uspGetClaimsGeneralConsumption(
@StartDate smalldatetime,
@EndDate smalldatetime,
@InsuranceNo varchar(20),
@CompanyNo varchar(20) = null
) with encryption as

if (@CompanyNo is null or @CompanyNo = '')
begin

SELECT dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, Claims.PatientNo,
InsurancePolicies.InsuranceNo,InsuranceName,SchemeMembers.MedicalCardNo,
SchemeMembers.CompanyNo,CompanyName,
SchemeMembers.PolicyNo,PolicyName,dbo.FormatDate(PolicyStartDate) as PolicyStartDate,dbo.FormatDate(PolicyEndDate) as PolicyEndDate,
MainMemberNo,dbo.GetLookupDataDes(MemberTypeID) as MemberType,AnnualPremium,MemberPremium,isnull(sum(Amount),0) as Totalamount FROM Claims
inner join ClaimDetails ON CLAIMS.ClaimNo =ClaimDetails.ClaimNo
inner join ClaimsEXT on ClaimsEXT.ClaimNo =ClaimDetails.ClaimNo
inner join Patients on Patients.PatientNo = Claims.PatientNo
inner join SchemeMembers on SchemeMembers.MedicalCardNo = Claims.MedicalCardNo
inner join Companies on Companies.CompanyNo = SchemeMembers.CompanyNo
inner join InsurancePolicies on InsurancePolicies.PolicyNo = SchemeMembers.PolicyNo
inner join InsuranceSchemes on InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo and InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
inner join Insurances on Insurances.InsuranceNo=InsurancePolicies.InsuranceNo
where Claims.VisitDate between @StartDate and @EndDate and InsurancePolicies.InsuranceNo = @InsuranceNo 
group by Patients.FirstName,Patients.lastname,Patients.MiddleName, Claims.PatientNo,InsurancePolicies.InsuranceNo,InsuranceName,SchemeMembers.MedicalCardNo,SchemeMembers.CompanyNo,CompanyName,SchemeMembers.PolicyNo,
PolicyName,MainMemberNo,MemberTypeID,PolicyStartDate,PolicyEndDate,MemberPremium,AnnualPremium
order by MainMemberNo,MemberTypeID asc
end

else
begin

SELECT dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, Claims.PatientNo,
InsurancePolicies.InsuranceNo,InsuranceName,SchemeMembers.MedicalCardNo,
SchemeMembers.CompanyNo,CompanyName,
SchemeMembers.PolicyNo,PolicyName,dbo.FormatDate(PolicyStartDate) as PolicyStartDate,dbo.FormatDate(PolicyEndDate) as PolicyEndDate,
MainMemberNo,dbo.GetLookupDataDes(MemberTypeID) as MemberType,AnnualPremium,MemberPremium,isnull(sum(Amount),0) as Totalamount FROM Claims
inner join ClaimDetails ON Claims.ClaimNo =ClaimDetails.ClaimNo
inner join ClaimsEXT on ClaimsEXT.ClaimNo =ClaimDetails.ClaimNo
inner join Patients on Patients.PatientNo = Claims.PatientNo
inner join SchemeMembers on SchemeMembers.MedicalCardNo = Claims.MedicalCardNo
inner join Companies on Companies.CompanyNo = SchemeMembers.CompanyNo
inner join InsurancePolicies on InsurancePolicies.PolicyNo = SchemeMembers.PolicyNo
inner join InsuranceSchemes on InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo and InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
inner join Insurances on Insurances.InsuranceNo=InsurancePolicies.InsuranceNo
where Claims.VisitDate between @StartDate and @EndDate and InsurancePolicies.InsuranceNo = @InsuranceNo and SchemeMembers.CompanyNo = @CompanyNo
group by Patients.FirstName,Patients.lastname,Patients.MiddleName, Claims.PatientNo,InsurancePolicies.InsuranceNo,InsuranceName,SchemeMembers.MedicalCardNo,SchemeMembers.CompanyNo,CompanyName,SchemeMembers.PolicyNo,
PolicyName,MainMemberNo,MemberTypeID,PolicyStartDate,PolicyEndDate,MemberPremium,AnnualPremium
order by MainMemberNo,MemberTypeID asc
end
return 0
go

-------------- Update ClaimPayments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateClaimPayments')
	drop proc uspUpdateClaimPayments
go

create proc uspUpdateClaimPayments(
@ClaimNo varchar(20),
@PaymentDateTime smallDatetime,
@PayStatusID varchar(20),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ClaimNo from ClaimPayments where ClaimNo = @ClaimNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo, 'ClaimPayments')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pay Status ID', @PayStatusID, 'Lookup Data')
		return 1
	end

begin
update ClaimPayments set
PaymentDateTime = @PaymentDateTime, LoginID = @LoginID, PayStatusID = @PayStatusID
where ClaimNo = @ClaimNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateClaimPayments
******************************************************************************************************/
-- select * from ClaimPayments
-- delete from ClaimPayments


-------------- Get ClaimPayments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetClaimPayments')
	drop proc uspGetClaimPayments
go

create proc uspGetClaimPayments(
@ClaimNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ClaimNo from ClaimPayments where ClaimNo = @ClaimNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo, 'ClaimPayments')
		return 1
	end
else
begin
	select ClaimNo, PaymentDateTime, ClaimPayments.LoginID, ClientMachine, 
	RecordDateTime, PayStatusID, dbo.GetLookupDataDes(PayStatusID) as [Pay Status ID]
	from ClaimPayments
	inner join Logins on ClaimPayments.LoginID = Logins.LoginID	

	where ClaimNo = @ClaimNo
return 0
end
go

/******************************************************************************************************
exec uspGetClaimPayments
******************************************************************************************************/
-- select * from ClaimPayments
-- delete from ClaimPayments


--------GetWaitngPeriodicClaims----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetWaitingPeriodicClaims')
	drop proc uspGetWaitingPeriodicClaims
go

create proc uspGetWaitingPeriodicClaims(
@ClaimPaymentsAlertDays integer
)with encryption as

declare @StartDate datetime
declare @EndDate datetime
declare @SystemEntryModeID varchar(10)
declare @ManualEntryModeID varchar(10)
declare @ApprovedClaimStatusID varchar(10)
--------------------------------------------------------------------------------------------------
set @StartDate = GETDATE()- @ClaimPaymentsAlertDays
set @EndDate = GETDATE()
set @SystemEntryModeID = dbo.GetLookupDataID('EntryMode', 'SYS')
set @ManualEntryModeID = dbo.GetLookupDataID('EntryMode', 'MAN')
set @ApprovedClaimStatusID = dbo.GetLookupDataID('ClaimStatus', 'AP')
--------------------------------------------------------------------------------------------------


begin	
	select Claims.ClaimNo, Claims.MedicalCardNo, PatientNo, CompanyName, 
	PolicyName, Insurances.InsuranceNo, InsuranceName, Surname, FirstName, 
	MiddleName, dbo.GetFullName(Surname, MiddleName, FirstName) as FullName, 
	BirthDate, dbo.GetAge(BirthDate, getdate()) as Age, Photo,
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender, VisitNo, HealthUnitName,
	JoinDate, MemberTypeID, dbo.GetLookupDataDes(MemberTypeID) as MemberType, 
	MainMemberNo, dbo.GetSchemeMemberName(MainMemberNo) as MainMemberName,
	MemberStatusID, dbo.GetLookupDataDes(MemberStatusID) as MemberStatus,
	PolicyStartDate, PolicyEndDate, VisitDate, VisitTime, Claims.HealthUnitCode, 
	PrimaryDoctor, ClaimStatusID, dbo.GetLookupDataDes(ClaimStatusID) as ClaimStatus, 
	ClaimEntryID, dbo.GetLookupDataDes(ClaimEntryID) as ClaimEntry,
	dbo.FormatDate(Claims.RecordDateTime) as RecordDate,
	dbo.GetTime(Claims.RecordDateTime) as RecordTime	
	from Claims
	left outer join ClaimsEXT on Claims.ClaimNo = ClaimsEXT.ClaimNo
	inner join SchemeMembers on Claims.MedicalCardNo = SchemeMembers.MedicalCardNo	
	inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
	and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
	inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
	inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
	inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
	left outer join HealthUnits on Claims.HealthUnitCode = HealthUnits.HealthUnitCode
	left outer join ClaimPayments on Claims.ClaimNo = ClaimPayments.ClaimNo
	where Claims.RecordDateTime between @StartDate and @EndDate
	and not exists (select * from ClaimPayments where ClaimPayments.claimNo = Claims.ClaimNo)
	and ((Claims.ClaimEntryID = @SystemEntryModeID) or (Claims.ClaimEntryID = @SystemEntryModeID and Claims.ClaimStatusID = @ApprovedClaimStatusID))
	order by VisitDate desc, VisitNo desc
end
return 0
go
/*
 select * from Claims
 exec uspEditOptions 'ClaimPaymentsAlertDays', 300, '3NUM', 3, 0
 exec uspGetWaitingPeriodicClaims '300'
 */



--------GetPeriodicClaimsPerInsurancePerHealthUnitPerCompanyPerMedicalCardNo----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicClaimsPerInsurancePerHealthUnitPerCompanyPerMedicalCardNo')
	drop proc uspGetPeriodicClaimsPerInsurancePerHealthUnitPerCompanyPerMedicalCardNo
go

create proc uspGetPeriodicClaimsPerInsurancePerHealthUnitPerCompanyPerMedicalCardNo(
@StartDate datetime, 
@EndDate datetime,
@InsuranceNo varchar(20),
@HealthUnitCode varchar(10)= null,
@CompanyNo varchar(20) = null,
@MedicalCardNo varchar(20) = null
)with encryption as


declare @SystemEntryModeID varchar(10)
declare @ManualEntryModeID varchar(10)
declare @ApprovedClaimStatusID varchar(10)
declare @ErrorMSG varchar(200)
--------------------------------------------------------------------------------------------------
set @SystemEntryModeID = dbo.GetLookupDataID('EntryMode', 'SYS')
set @ManualEntryModeID = dbo.GetLookupDataID('EntryMode', 'MAN')
set @ApprovedClaimStatusID = dbo.GetLookupDataID('ClaimStatus', 'AP')
--------------------------------------------------------------------------------------------------

if not exists(select InsuranceNo from Insurances where @InsuranceNo = @InsuranceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Insurance No', @InsuranceNo, 'Insurances')
		return 1
	end
if not (@HealthUnitCode is null or @HealthUnitCode ='')
begin
	if not exists(select HealthUnitCode from HealthUnits where HealthUnitCode  = @HealthUnitCode)
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Health UnitCode', @HealthUnitCode, 'HealthUnits')
			return 1
		end
end
if not (@CompanyNo is null or @CompanyNo = '')
	begin
		if not exists(select CompanyNo from Companies where CompanyNo  = @CompanyNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'CompanyNo', @CompanyNo, 'Companies')
				return 1
			end	
	end
	
if not (@MedicalCardNo is null)
begin
			if not exists(select @MedicalCardNo from claims where MedicalCardNo  = @MedicalCardNo)
					begin
						set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
						raiserror(@ErrorMSG, 16, 1, 'MedicalCardNo', @MedicalCardNo, 'Claims')
						return 1
					end	
					
			if ((@CompanyNo is not null) and (@StartDate is not null) and (@EndDate is not null) and (@InsuranceNo is not null) and (@HealthUnitCode is not null))
				begin	
				select Claims.ClaimNo, Claims.MedicalCardNo, PatientNo, companies.CompanyNo, CompanyName,  
				PolicyName, Insurances.InsuranceNo, InsuranceName, Surname, FirstName, 
				MiddleName, dbo.GetFullName(Surname, MiddleName, FirstName) as FullName, 
				BirthDate, dbo.GetAge(BirthDate, getdate()) as Age, Photo,
				GenderID, dbo.GetLookupDataDes(GenderID) as Gender, VisitNo, HealthUnitName,
				JoinDate, MemberTypeID, dbo.GetLookupDataDes(MemberTypeID) as MemberType, 
				MainMemberNo, dbo.GetSchemeMemberName(MainMemberNo) as MainMemberName,
				MemberStatusID, dbo.GetLookupDataDes(MemberStatusID) as MemberStatus,
				PolicyStartDate, PolicyEndDate, VisitDate, VisitTime, Claims.HealthUnitCode, 
				PrimaryDoctor, ClaimStatusID, dbo.GetLookupDataDes(ClaimStatusID) as ClaimStatus, 
				ClaimEntryID, dbo.GetLookupDataDes(ClaimEntryID) as ClaimEntry,
				dbo.FormatMoney(dbo.GetConsumedAmountPerClaimNo(Claims.ClaimNo)) as TotalConsumedAmount,
				dbo.FormatDate(Claims.RecordDateTime) as RecordDate,
				dbo.GetTime(Claims.RecordDateTime) as RecordTime	
				from Claims
				left outer join ClaimsEXT on Claims.ClaimNo = ClaimsEXT.ClaimNo
				inner join SchemeMembers on Claims.MedicalCardNo = SchemeMembers.MedicalCardNo	
				inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
				and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
				inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
				inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
				inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
				left outer join HealthUnits on Claims.HealthUnitCode = HealthUnits.HealthUnitCode
				left outer join ClaimPayments on Claims.ClaimNo = ClaimPayments.ClaimNo
				where Claims.RecordDateTime between @StartDate and @EndDate
				and not exists (select * from ClaimPayments where ClaimPayments.claimNo = Claims.ClaimNo)
				and ((Claims.ClaimEntryID = @SystemEntryModeID) or (Claims.ClaimEntryID = @SystemEntryModeID and Claims.ClaimStatusID = @ApprovedClaimStatusID))
				and Insurances.InsuranceNo = @InsuranceNo 
				and Claims.HealthUnitCode = @HealthUnitCode 
				and companies.CompanyNo = @CompanyNo 
				and claims.MedicalCardNo = @MedicalCardNo
				order by VisitDate desc, VisitNo desc
			end

		 if ((@CompanyNo is null) and (@StartDate is not null) and (@EndDate is not null) and (@InsuranceNo is not null) and (@HealthUnitCode is not null))
				begin
						select Claims.ClaimNo, Claims.MedicalCardNo, PatientNo, companies.CompanyNo, CompanyName,  
						PolicyName, Insurances.InsuranceNo, InsuranceName, Surname, FirstName, 
						MiddleName, dbo.GetFullName(Surname, MiddleName, FirstName) as FullName, 
						BirthDate, dbo.GetAge(BirthDate, getdate()) as Age, Photo,
						GenderID, dbo.GetLookupDataDes(GenderID) as Gender, VisitNo, HealthUnitName,
						JoinDate, MemberTypeID, dbo.GetLookupDataDes(MemberTypeID) as MemberType, 
						MainMemberNo, dbo.GetSchemeMemberName(MainMemberNo) as MainMemberName,
						MemberStatusID, dbo.GetLookupDataDes(MemberStatusID) as MemberStatus,
						PolicyStartDate, PolicyEndDate, VisitDate, VisitTime, Claims.HealthUnitCode, 
						PrimaryDoctor, ClaimStatusID, dbo.GetLookupDataDes(ClaimStatusID) as ClaimStatus, 
						ClaimEntryID, dbo.GetLookupDataDes(ClaimEntryID) as ClaimEntry,
						dbo.FormatMoney(dbo.GetConsumedAmountPerClaimNo(Claims.ClaimNo)) as TotalConsumedAmount,
						dbo.FormatDate(Claims.RecordDateTime) as RecordDate,
						dbo.GetTime(Claims.RecordDateTime) as RecordTime	
						from Claims
						left outer join ClaimsEXT on Claims.ClaimNo = ClaimsEXT.ClaimNo
						inner join SchemeMembers on Claims.MedicalCardNo = SchemeMembers.MedicalCardNo	
						inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
						and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
						inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
						inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
						inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
						left outer join HealthUnits on Claims.HealthUnitCode = HealthUnits.HealthUnitCode
						left outer join ClaimPayments on Claims.ClaimNo = ClaimPayments.ClaimNo
						where Claims.RecordDateTime between @StartDate and @EndDate
						and not exists (select * from ClaimPayments where ClaimPayments.claimNo = Claims.ClaimNo)
						and ((Claims.ClaimEntryID = @SystemEntryModeID) or (Claims.ClaimEntryID = @SystemEntryModeID and Claims.ClaimStatusID = @ApprovedClaimStatusID))
						and Insurances.InsuranceNo = @InsuranceNo 
						and Claims.HealthUnitCode = @HealthUnitCode 
						and claims.medicalCardNo = @MedicalCardNo
						--and companies.CompanyNo = @CompanyNo 
						order by VisitDate desc, VisitNo desc
					end
			end

else if(@medicalCardNo is null)
begin
	if ((@CompanyNo is not null) and (@StartDate is not null) and (@EndDate is not null) and (@InsuranceNo is not null) and (@HealthUnitCode is not null))
		begin	
		select Claims.ClaimNo, Claims.MedicalCardNo, PatientNo, companies.CompanyNo, CompanyName,  
		PolicyName, Insurances.InsuranceNo, InsuranceName, Surname, FirstName, 
		MiddleName, dbo.GetFullName(Surname, MiddleName, FirstName) as FullName, 
		BirthDate, dbo.GetAge(BirthDate, getdate()) as Age, Photo,
		GenderID, dbo.GetLookupDataDes(GenderID) as Gender, VisitNo, HealthUnitName,
		JoinDate, MemberTypeID, dbo.GetLookupDataDes(MemberTypeID) as MemberType, 
		MainMemberNo, dbo.GetSchemeMemberName(MainMemberNo) as MainMemberName,
		MemberStatusID, dbo.GetLookupDataDes(MemberStatusID) as MemberStatus,
		PolicyStartDate, PolicyEndDate, VisitDate, VisitTime, Claims.HealthUnitCode, 
		PrimaryDoctor, ClaimStatusID, dbo.GetLookupDataDes(ClaimStatusID) as ClaimStatus, 
		ClaimEntryID, dbo.GetLookupDataDes(ClaimEntryID) as ClaimEntry,
		dbo.FormatMoney(dbo.GetConsumedAmountPerClaimNo(Claims.ClaimNo)) as TotalConsumedAmount,
		dbo.FormatDate(Claims.RecordDateTime) as RecordDate,
		dbo.GetTime(Claims.RecordDateTime) as RecordTime	
		from Claims
		left outer join ClaimsEXT on Claims.ClaimNo = ClaimsEXT.ClaimNo
		inner join SchemeMembers on Claims.MedicalCardNo = SchemeMembers.MedicalCardNo	
		inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
		and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
		inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
		inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
		inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
		left outer join HealthUnits on Claims.HealthUnitCode = HealthUnits.HealthUnitCode
		left outer join ClaimPayments on Claims.ClaimNo = ClaimPayments.ClaimNo
		where Claims.RecordDateTime between @StartDate and @EndDate
		and not exists (select * from ClaimPayments where ClaimPayments.claimNo = Claims.ClaimNo)
		and ((Claims.ClaimEntryID = @SystemEntryModeID) or (Claims.ClaimEntryID = @SystemEntryModeID and Claims.ClaimStatusID = @ApprovedClaimStatusID))
		and Insurances.InsuranceNo = @InsuranceNo 
		and Claims.HealthUnitCode = @HealthUnitCode 
		and companies.CompanyNo = @CompanyNo 
		order by VisitDate desc, VisitNo desc
	end

 if ((@CompanyNo is null) and (@StartDate is not null) and (@EndDate is not null) and (@InsuranceNo is not null) and (@HealthUnitCode is not null))
		begin
				select Claims.ClaimNo, Claims.MedicalCardNo, PatientNo, companies.CompanyNo, CompanyName,  
				PolicyName, Insurances.InsuranceNo, InsuranceName, Surname, FirstName, 
				MiddleName, dbo.GetFullName(Surname, MiddleName, FirstName) as FullName, 
				BirthDate, dbo.GetAge(BirthDate, getdate()) as Age, Photo,
				GenderID, dbo.GetLookupDataDes(GenderID) as Gender, VisitNo, HealthUnitName,
				JoinDate, MemberTypeID, dbo.GetLookupDataDes(MemberTypeID) as MemberType, 
				MainMemberNo, dbo.GetSchemeMemberName(MainMemberNo) as MainMemberName,
				MemberStatusID, dbo.GetLookupDataDes(MemberStatusID) as MemberStatus,
				PolicyStartDate, PolicyEndDate, VisitDate, VisitTime, Claims.HealthUnitCode, 
				PrimaryDoctor, ClaimStatusID, dbo.GetLookupDataDes(ClaimStatusID) as ClaimStatus, 
				ClaimEntryID, dbo.GetLookupDataDes(ClaimEntryID) as ClaimEntry,
				dbo.FormatMoney(dbo.GetConsumedAmountPerClaimNo(Claims.ClaimNo)) as TotalConsumedAmount,
				dbo.FormatDate(Claims.RecordDateTime) as RecordDate,
				dbo.GetTime(Claims.RecordDateTime) as RecordTime	
				from Claims
				left outer join ClaimsEXT on Claims.ClaimNo = ClaimsEXT.ClaimNo
				inner join SchemeMembers on Claims.MedicalCardNo = SchemeMembers.MedicalCardNo	
				inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
				and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
				inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
				inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
				inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
				left outer join HealthUnits on Claims.HealthUnitCode = HealthUnits.HealthUnitCode
				left outer join ClaimPayments on Claims.ClaimNo = ClaimPayments.ClaimNo
				where Claims.RecordDateTime between @StartDate and @EndDate
				and not exists (select * from ClaimPayments where ClaimPayments.claimNo = Claims.ClaimNo)
				and ((Claims.ClaimEntryID = @SystemEntryModeID) or (Claims.ClaimEntryID = @SystemEntryModeID and Claims.ClaimStatusID = @ApprovedClaimStatusID))
				and Insurances.InsuranceNo = @InsuranceNo 
				and Claims.HealthUnitCode = @HealthUnitCode 
				--and companies.CompanyNo = @CompanyNo 
				order by VisitDate desc, VisitNo desc
			end
 if ((@CompanyNo is null) and (@StartDate is not null) and (@EndDate is not null) and (@InsuranceNo is not null) and (@HealthUnitCode is  null))
		begin
				select Claims.ClaimNo, Claims.MedicalCardNo, PatientNo, companies.CompanyNo, CompanyName,  
				PolicyName, Insurances.InsuranceNo, InsuranceName, Surname, FirstName, 
				MiddleName, dbo.GetFullName(Surname, MiddleName, FirstName) as FullName, 
				BirthDate, dbo.GetAge(BirthDate, getdate()) as Age, Photo,
				GenderID, dbo.GetLookupDataDes(GenderID) as Gender, VisitNo, HealthUnitName,
				JoinDate, MemberTypeID, dbo.GetLookupDataDes(MemberTypeID) as MemberType, 
				MainMemberNo, dbo.GetSchemeMemberName(MainMemberNo) as MainMemberName,
				MemberStatusID, dbo.GetLookupDataDes(MemberStatusID) as MemberStatus,
				PolicyStartDate, PolicyEndDate, VisitDate, VisitTime, Claims.HealthUnitCode, 
				PrimaryDoctor, ClaimStatusID, dbo.GetLookupDataDes(ClaimStatusID) as ClaimStatus, 
				ClaimEntryID, dbo.GetLookupDataDes(ClaimEntryID) as ClaimEntry,
				dbo.FormatMoney(dbo.GetConsumedAmountPerClaimNo(Claims.ClaimNo)) as TotalConsumedAmount,
				dbo.FormatDate(Claims.RecordDateTime) as RecordDate,
				dbo.GetTime(Claims.RecordDateTime) as RecordTime	
				from Claims
				left outer join ClaimsEXT on Claims.ClaimNo = ClaimsEXT.ClaimNo
				inner join SchemeMembers on Claims.MedicalCardNo = SchemeMembers.MedicalCardNo	
				inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
				and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
				inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
				inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
				inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
				left outer join HealthUnits on Claims.HealthUnitCode = HealthUnits.HealthUnitCode
				left outer join ClaimPayments on Claims.ClaimNo = ClaimPayments.ClaimNo
				where Claims.RecordDateTime between @StartDate and @EndDate
				and not exists (select * from ClaimPayments where ClaimPayments.claimNo = Claims.ClaimNo)
				and ((Claims.ClaimEntryID = @SystemEntryModeID) or (Claims.ClaimEntryID = @SystemEntryModeID and Claims.ClaimStatusID = @ApprovedClaimStatusID))
				and Insurances.InsuranceNo = @InsuranceNo 
				--and Claims.HealthUnitCode = @HealthUnitCode 
				--and companies.CompanyNo = @CompanyNo 
				order by VisitDate desc, VisitNo desc
		end
			
	end

		
return 0
go
/*
 select * from Claims
 exec uspEditOptions 'ClaimPaymentsAlertDays', 300, '3NUM', 3, 0
 exec uspGetPeriodicClaimsPerInsurancePerHealthUnitPerCompanyPerMedicalCardNo '2015-10-20','2016-01-25','I14001','MH01','C14787','14006900'
 exec uspGetPeriodicClaimsPerInsurancePerHealthUnitPerCompanyPerMedicalCardNo '2014-01-01','2016-01-25','I14001','MH01',null,null
 */ 
  
 --------GetMedicalCardNoPerInsurancePerHealthUnitPerCompany----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetMedicalCardNoPerInsurancePerHealthUnitPerCompany')
	drop proc uspGetMedicalCardNoPerInsurancePerHealthUnitPerCompany
go

create proc uspGetMedicalCardNoPerInsurancePerHealthUnitPerCompany(
@StartDate datetime, 
@EndDate datetime,
@InsuranceNo varchar(20),
@HealthUnitCode varchar(10),
@CompanyNo varchar(20)
)with encryption as


declare @SystemEntryModeID varchar(10)
declare @ManualEntryModeID varchar(10)
declare @ApprovedClaimStatusID varchar(10)
declare @ErrorMSG varchar(200)
--------------------------------------------------------------------------------------------------
set @SystemEntryModeID = dbo.GetLookupDataID('EntryMode', 'SYS')
set @ManualEntryModeID = dbo.GetLookupDataID('EntryMode', 'MAN')
set @ApprovedClaimStatusID = dbo.GetLookupDataID('ClaimStatus', 'AP')
--------------------------------------------------------------------------------------------------

if not exists(select InsuranceNo from Insurances where @InsuranceNo = @InsuranceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Insurance No', @InsuranceNo, 'Insurances')
		return 1
	end

if not exists(select HealthUnitCode from HealthUnits where HealthUnitCode  = @HealthUnitCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Health UnitCode', @HealthUnitCode, 'HealthUnits')
		return 1
	end
if not (@CompanyNo is null)
	begin
		if not exists(select CompanyNo from Companies where CompanyNo  = @CompanyNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'CompanyNo', @CompanyNo, 'Companies')
				return 1
			end	
	end

if ((@CompanyNo is not null) and (@StartDate is not null) and (@EndDate is not null) and (@InsuranceNo is not null) and (@HealthUnitCode is not null))
	begin
		begin	
		select distinct Claims.MedicalCardNo
		from Claims
		left outer join ClaimsEXT on Claims.ClaimNo = ClaimsEXT.ClaimNo
		inner join SchemeMembers on Claims.MedicalCardNo = SchemeMembers.MedicalCardNo	
		inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
		and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
		inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
		inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
		inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
		left outer join HealthUnits on Claims.HealthUnitCode = HealthUnits.HealthUnitCode
		left outer join ClaimPayments on Claims.ClaimNo = ClaimPayments.ClaimNo
		where Claims.RecordDateTime between @StartDate and @EndDate
		and not exists (select * from ClaimPayments where ClaimPayments.claimNo = Claims.ClaimNo)
		and ((Claims.ClaimEntryID = @SystemEntryModeID) or (Claims.ClaimEntryID = @SystemEntryModeID and Claims.ClaimStatusID = @ApprovedClaimStatusID))
		and Insurances.InsuranceNo = @InsuranceNo 
		and Claims.HealthUnitCode = @HealthUnitCode 
		and companies.CompanyNo = @CompanyNo 
		order by Claims.MedicalCardNo asc
	end

 if ((@CompanyNo is null) and (@StartDate is not null) and (@EndDate is not null) and (@InsuranceNo is not null) and (@HealthUnitCode is not null))
		begin
				select distinct Claims.MedicalCardNo
				from Claims
				left outer join ClaimsEXT on Claims.ClaimNo = ClaimsEXT.ClaimNo
				inner join SchemeMembers on Claims.MedicalCardNo = SchemeMembers.MedicalCardNo	
				inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
				and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
				inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
				inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
				inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
				left outer join HealthUnits on Claims.HealthUnitCode = HealthUnits.HealthUnitCode
				left outer join ClaimPayments on Claims.ClaimNo = ClaimPayments.ClaimNo
				where Claims.RecordDateTime between @StartDate and @EndDate
				and not exists (select * from ClaimPayments where ClaimPayments.claimNo = Claims.ClaimNo)
				and ((Claims.ClaimEntryID = @SystemEntryModeID) or (Claims.ClaimEntryID = @SystemEntryModeID and Claims.ClaimStatusID = @ApprovedClaimStatusID))
				and Insurances.InsuranceNo = @InsuranceNo 
				and Claims.HealthUnitCode = @HealthUnitCode 
				--and companies.CompanyNo = @CompanyNo 
				order by Claims.MedicalCardNo asc
			end
		end
return 0
go
/*
 select * from Claims
 exec uspEditOptions 'ClaimPaymentsAlertDays', 300, '3NUM', 3, 0
 exec uspGetMedicalCardNoPerInsurancePerHealthUnitPerCompany '2015-10-20','2016-01-25','I14001','MH01','C14787'
 exec uspGetMedicalCardNoPerInsurancePerHealthUnitPerCompany '2014-10-20','2016-10-25','I14001','MH01',null
 */




 --------GetPeriodicClaimsPerClaimNo----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicClaimsPerClaimNo')
	drop proc uspGetPeriodicClaimsPerClaimNo
go

create proc uspGetPeriodicClaimsPerClaimNo(
@claimNo varchar(20)
)with encryption as


declare @SystemEntryModeID varchar(10)
declare @ManualEntryModeID varchar(10)
declare @ApprovedClaimStatusID varchar(10)
declare @ErrorMSG varchar(200)
--------------------------------------------------------------------------------------------------
set @SystemEntryModeID = dbo.GetLookupDataID('EntryMode', 'SYS')
set @ManualEntryModeID = dbo.GetLookupDataID('EntryMode', 'MAN')
set @ApprovedClaimStatusID = dbo.GetLookupDataID('ClaimStatus', 'AP')
--------------------------------------------------------------------------------------------------

if not exists(select ClaimNo from Claims where ClaimNo = @ClaimNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo, 'Claims')
		return 1
	end
else
begin
		select Claims.ClaimNo, Claims.MedicalCardNo, PatientNo, companies.CompanyNo, CompanyName,  
				PolicyName, Insurances.InsuranceNo, InsuranceName, Surname, FirstName, 
				MiddleName, dbo.GetFullName(Surname, MiddleName, FirstName) as FullName, 
				BirthDate, dbo.GetAge(BirthDate, getdate()) as Age, Photo,
				GenderID, dbo.GetLookupDataDes(GenderID) as Gender, VisitNo, HealthUnitName,
				JoinDate, MemberTypeID, dbo.GetLookupDataDes(MemberTypeID) as MemberType, 
				MainMemberNo, dbo.GetSchemeMemberName(MainMemberNo) as MainMemberName,
				MemberStatusID, dbo.GetLookupDataDes(MemberStatusID) as MemberStatus,
				PolicyStartDate, PolicyEndDate, VisitDate, VisitTime, Claims.HealthUnitCode, 
				PrimaryDoctor, ClaimStatusID, dbo.GetLookupDataDes(ClaimStatusID) as ClaimStatus, 
				ClaimEntryID, dbo.GetLookupDataDes(ClaimEntryID) as ClaimEntry,
				dbo.FormatMoney(dbo.GetConsumedAmountPerClaimNo(Claims.ClaimNo)) as TotalConsumedAmount,
				dbo.FormatDate(Claims.RecordDateTime) as RecordDate,
				dbo.GetTime(Claims.RecordDateTime) as RecordTime	
		from  claims
		left outer join ClaimsEXT on Claims.ClaimNo = ClaimsEXT.ClaimNo
		inner join SchemeMembers on Claims.MedicalCardNo = SchemeMembers.MedicalCardNo	
		inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
		and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
		inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
		inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
		inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
		left outer join HealthUnits on Claims.HealthUnitCode = HealthUnits.HealthUnitCode
		left outer join ClaimPayments on Claims.ClaimNo = ClaimPayments.ClaimNo
		where
		not exists (select * from ClaimPayments where ClaimPayments.claimNo = Claims.ClaimNo)
		and ((Claims.ClaimEntryID = @SystemEntryModeID) or (Claims.ClaimEntryID = @SystemEntryModeID and Claims.ClaimStatusID = @ApprovedClaimStatusID))
		and Claims.ClaimNo = @ClaimNo 
		
end

return 0
go
/*
 select * from Claims
 exec uspEditOptions 'ClaimPaymentsAlertDays', 300, '3NUM', 3, 0
 exec uspGetPeriodicClaimsPerClaimNo '14013701005'
 */


--------GetPeriodicClaims----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicClaims')
	drop proc uspGetPeriodicClaims
go

create proc uspGetPeriodicClaims(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as
begin	
	select Claims.ClaimNo, Claims.MedicalCardNo, PatientNo, CompanyName, 
	PolicyName, Insurances.InsuranceNo, InsuranceName, Surname, FirstName, 
	MiddleName, dbo.GetFullName(Surname, MiddleName, FirstName) as FullName, 
	BirthDate, dbo.GetAge(BirthDate, getdate()) as Age, Photo,
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender, VisitNo, HealthUnitName,
	JoinDate, MemberTypeID, dbo.GetLookupDataDes(MemberTypeID) as MemberType, 
	MainMemberNo, dbo.GetSchemeMemberName(MainMemberNo) as MainMemberName,
	MemberStatusID, dbo.GetLookupDataDes(MemberStatusID) as MemberStatus,
	PolicyStartDate, PolicyEndDate, VisitDate, VisitTime, Claims.HealthUnitCode, 
	PrimaryDoctor, ClaimStatusID, dbo.GetLookupDataDes(ClaimStatusID) as ClaimStatus, 
	ClaimEntryID, dbo.GetLookupDataDes(ClaimEntryID) as ClaimEntry,
	dbo.FormatDate(Claims.RecordDateTime) as RecordDate,
	dbo.GetTime(Claims.RecordDateTime) as RecordTime	
	from Claims
	left outer join ClaimsEXT on Claims.ClaimNo = ClaimsEXT.ClaimNo
	inner join SchemeMembers on Claims.MedicalCardNo = SchemeMembers.MedicalCardNo	
	inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
	and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
	inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
	inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
	inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
	left outer join HealthUnits on Claims.HealthUnitCode = HealthUnits.HealthUnitCode
	where VisitDate between @StartDate and @EndDate
	order by VisitDate desc, VisitNo desc
end
return 0
go

-- select * from Claims
-- exec uspGetPeriodicClaims 'Jan 15, 2013', 'Jan 30, 2013'

--------GetClaimsByMedicalCardNo------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetClaimsByMedicalCardNo')
	drop proc uspGetClaimsByMedicalCardNo
go

create proc uspGetClaimsByMedicalCardNo(
@MedicalCardNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select MedicalCardNo from Claims where MedicalCardNo = @MedicalCardNo)
begin
	set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
	raiserror(@ErrorMSG,16,1, 'Medical Card No', @MedicalCardNo, 'Claims')	
	return 1
end
else
begin
	select VisitDate, ClaimNo from Claims
	where MedicalCardNo = @MedicalCardNo order by VisitDate, ClaimID, ClaimNo
end
return 0
go

-- select * from Claims
-- exec uspGetClaimsByMedicalCardNo '123'

----------------------------------------------------------------------------------------------------------------
-------- GetClaimNo --------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetClaimNo')
	drop proc uspGetClaimNo
go

create proc uspGetClaimNo(
@MedicalCardNo varchar(20),
@VisitDate smalldatetime = null output,
@ClaimNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)

if (@VisitDate is null)
begin
	if not exists(select MedicalCardNo from Claims where MedicalCardNo = @MedicalCardNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Medical Card No', @MedicalCardNo, 'Claims')	
		return 1
	end
	else
	begin
		set @ClaimNo = (select top 1 ClaimNo from Claims where MedicalCardNo = @MedicalCardNo
						and VisitDate = (select max(VisitDate) from Claims where MedicalCardNo = @MedicalCardNo)
										 order by ClaimID desc)
	end
end
else
if not (@VisitDate is null)
begin

if not exists(select MedicalCardNo from Claims where MedicalCardNo = @MedicalCardNo and VisitDate = @VisitDate)
	begin
		set @ErrorMSG = '%s: %s and %s: ' + dbo.FormatDate(@VisitDate) + ', you are trying to enter does not exist %s'
		raiserror(@ErrorMSG,16,1, 'The record with Medical Card No', @MedicalCardNo, 'Visit Date', 'in the registered Claims')	
		return 1		
	end
	else
	begin
		set @ClaimNo = (select top 1 ClaimNo from Claims where MedicalCardNo = @MedicalCardNo
											and VisitDate = @VisitDate order by ClaimID desc)
	end
end

return 0

go

-- select * from SchemeMembers
-- exec  uspGetClaimNo '123'
-- exec uspGetClaimNo '123', '19 Oct 2011'

--------CountMemberVisitDate-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountMemberVisitDate')
	drop proc uspCountMemberVisitDate
go

create proc uspCountMemberVisitDate(
@MedicalCardNo varchar(20),
@VisitDate smalldatetime,
@Records tinyint = null output
)with encryption as

set @Records = (select count(ClaimNo) from Claims 
				where MedicalCardNo = @MedicalCardNo and VisitDate = @VisitDate)
set @Records = isnull(@Records, 0)

return 0

go

-- exec uspCountMemberVisitDate '123', '19 Oct 2011'

--------GetNextClaimID -----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextClaimID')
	drop proc uspGetNextClaimID
go

create proc uspGetNextClaimID(
@MedicalCardNo varchar(20) ,
@ClaimID int = null output
)with encryption as

set @ClaimID = (select max(ClaimID) from Claims where MedicalCardNo = @MedicalCardNo)
set @ClaimID = dbo.GetNextAutoNumber('Claims', 'ClaimNo', @ClaimID)

return 0

go

-- exec uspGetNextClaimID '08022077'
-- select * from Claims where MedicalCardNo = '08022077'


------------------------------------------------------------------------------------------------------
-------------- ClaimsEXT -----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ClaimsEXT ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertClaimsEXT')
	drop proc uspInsertClaimsEXT
go

create proc uspInsertClaimsEXT(
@ClaimNo varchar(20),
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ClaimNo from Claims where ClaimNo  = @ClaimNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo, 'Claims')
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')	
		return 1
	end

if exists(select ClaimNo from ClaimsEXT where ClaimNo = @ClaimNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo)
		return 1
	end

begin
insert into ClaimsEXT
(ClaimNo, VisitNo)
values
(@ClaimNo, @VisitNo)
return 0
end
go

/******************************************************************************************************
exec uspInsertClaimsEXT
******************************************************************************************************/
-- select * from ClaimsEXT
-- delete from ClaimsEXT

-------------- Update ClaimsEXT -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateClaimsEXT')
	drop proc uspUpdateClaimsEXT
go

create proc uspUpdateClaimsEXT(
@ClaimNo varchar(20),
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ClaimNo from ClaimsEXT where ClaimNo = @ClaimNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo, 'Claims EXT')
		return 1
	end

begin
	update ClaimsEXT set VisitNo = @VisitNo
	where ClaimNo = @ClaimNo
	return 0
end
go

/******************************************************************************************************
exec uspUpdateClaimsEXT
******************************************************************************************************/
-- select * from ClaimsEXT
-- delete from ClaimsEXT

-------------- Get ClaimsEXT -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetClaimsEXT')
	drop proc uspGetClaimsEXT
go

create proc uspGetClaimsEXT(
@ClaimNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ClaimNo from ClaimsEXT where ClaimNo = @ClaimNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo, 'Claims EXT')
		return 1
	end
else
begin
	select ClaimNo, VisitNo from ClaimsEXT
	where ClaimNo = @ClaimNo
return 0
end
go

/******************************************************************************************************
exec uspGetClaimsEXT
******************************************************************************************************/
-- select * from ClaimsEXT
-- delete from ClaimsEXT

-------------- GetClaimsEXTClaimNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetClaimsEXTClaimNo')
	drop proc uspGetClaimsEXTClaimNo
go

create proc uspGetClaimsEXTClaimNo(
@VisitNo varchar(20),
@ClaimNo varchar(20) = null output
)with encryption as

begin
	set @ClaimNo = (select top 1 ClaimNo from ClaimsEXT where VisitNo = @VisitNo)
return 0
end
go

/******************************************************************************************************
exec uspGetClaimsEXTClaimNo
******************************************************************************************************/
-- select * from ClaimsEXT
-- delete from ClaimsEXT

------------------------------------------------------------------------------------------------------
-------------- ClaimDiagnosis ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ClaimDiagnosis -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditClaimDiagnosis')
	drop proc uspEditClaimDiagnosis
go

create proc uspEditClaimDiagnosis(
@ClaimNo varchar(20),
@DiseaseCode varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ClaimNo from Claims where ClaimNo = @ClaimNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo, 'Claims')
		return 1
	end

if not exists(select DiseaseCode from Diseases where DiseaseCode = @DiseaseCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Disease Code', @DiseaseCode, 'Diseases')	
		return 1
	end

if exists(select ClaimNo from ClaimDiagnosis where ClaimNo = @ClaimNo and DiseaseCode = @DiseaseCode)
	begin return 0 end
else
begin
insert into ClaimDiagnosis
(ClaimNo, DiseaseCode)
values
(@ClaimNo, @DiseaseCode)
return 0
end
go

/******************************************************************************************************
exec uspEditClaimDiagnosis 'M01023482001', 'A00.0B'
exec uspEditClaimDiagnosis 'M01023482001', 'A00.9B'
exec uspEditClaimDiagnosis '123001', 'A00.0B'

******************************************************************************************************/
-- select * from ClaimsDiagnosis
-- delete from ClaimDiagnosis

-------------- Get ClaimDiagnosis -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetClaimDiagnosis')
	drop proc uspGetClaimDiagnosis
go

create proc uspGetClaimDiagnosis(
@ClaimNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select ClaimNo, ClaimDiagnosis.DiseaseCode, DiseaseName, DiseaseCategoriesID, 
	dbo.GetLookupDataDes(DiseaseCategoriesID) as DiseaseCategories
	from ClaimDiagnosis
	inner join Diseases on ClaimDiagnosis.DiseaseCode = Diseases.DiseaseCode
	where ClaimNo = @ClaimNo
return 0
end
go

/******************************************************************************************************
exec uspGetClaimDiagnosis 'M01023482001'
exec uspGetClaimDiagnosis '123001'

******************************************************************************************************/
-- select * from ClaimDiagnosis
-- delete from ClaimDiagnosis

------------------------------------------------------------------------------------------------------
-------------- ClaimDetails --------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ClaimDetails ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditClaimDetails')
	drop proc uspEditClaimDetails
go

create proc uspEditClaimDetails(
@ClaimNo varchar(20),
@ItemName varchar(100),
@BenefitCode varchar(20),
@Quantity int,
@UnitPrice money,
@Adjustment money = 0,
@Amount money,
@Notes varchar(400),
@LimitAmount money,
@ConsumedAmount money,
@LimitBalance money
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ClaimNo from Claims where ClaimNo = @ClaimNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Claim No', @ClaimNo, 'Claims')
		return 1
	end
	
if not exists(select BenefitCode from MemberBenefits where BenefitCode = @BenefitCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Benefit Code', @BenefitCode, 'Member Benefits')
		return 1
	end

if exists(select ClaimNo from ClaimDetails where ClaimNo = @ClaimNo and ItemName = @ItemName)
	begin
		update ClaimDetails set BenefitCode = @BenefitCode, Quantity = @Quantity, UnitPrice = @UnitPrice, 
		Adjustment = @Adjustment, Amount = @Amount, Notes = @Notes, LimitAmount = @LimitAmount, 
		ConsumedAmount = @ConsumedAmount, LimitBalance = @LimitBalance
		where ClaimNo = @ClaimNo and ItemName = @ItemName
		return 0
	end
else
begin
insert into ClaimDetails
(ClaimNo, ItemName, BenefitCode, Quantity, UnitPrice, Adjustment, Amount, Notes, LimitAmount, ConsumedAmount, LimitBalance)
values
(@ClaimNo, @ItemName, @BenefitCode, @Quantity, @UnitPrice, @Adjustment, @Amount, @Notes, @LimitAmount, @ConsumedAmount, @LimitBalance)
return 0
end
go

/******************************************************************************************************
exec uspEditClaimDetails 'M01023482001', 'Consultation', '7S', 1, 7900, 7900, ''
exec uspEditClaimDetails 'M01023482001', 'Panadol', '7D', 2, 900, 1800, ''
exec uspEditClaimDetails '123001', 'Consultation', '7S', 1, 8500, 8500, ''

******************************************************************************************************/
-- select * from ClaimDetails
-- delete from ClaimDetails

-------------- Get ClaimDetails ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetClaimDetails')
	drop proc uspGetClaimDetails
go

create proc uspGetClaimDetails(
@ClaimNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select ClaimNo, ItemName, ClaimDetails.BenefitCode, BenefitName, Quantity, 
	UnitPrice, Adjustment, Amount, Notes, LimitAmount, ConsumedAmount, LimitBalance
	from ClaimDetails
	inner join MemberBenefits on ClaimDetails.BenefitCode = MemberBenefits.BenefitCode
	where ClaimNo = @ClaimNo
return 0
end
go

/******************************************************************************************************
exec uspGetClaimDetails 'M01023482001'
exec uspGetClaimDetails '07001'

******************************************************************************************************/
-- select * from ClaimDetails
-- delete from ClaimDetails

--------GetPolicyConsumedAmount--------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPolicyConsumedAmount')
	drop proc uspGetPolicyConsumedAmount
go

create proc uspGetPolicyConsumedAmount(
@MedicalCardNo varchar(20), 
@BenefitCode varchar(20),
@PolicyConsumedAmount money = null output
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @MedicalCardNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @MedicalCardNo, 'Scheme Members')
		return 1
	end

if not exists(select BenefitCode from MemberBenefits where BenefitCode = @BenefitCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Benefit Code', @BenefitCode, 'Member Benefits')
		return 1
	end 
	
else begin set @PolicyConsumedAmount = dbo.GetPolicyConsumedAmount(@MedicalCardNo, @BenefitCode) end

return 0
go

-- exec uspGetPolicyConsumedAmount 'IDI215/1', '7S'

------------------------------------------------------------------------------------------------------
-------------- Allergies -----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Allergies ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAllergies')
	drop proc uspInsertAllergies
go

create proc uspInsertAllergies(
@AllergyNo varchar(20),
@AllergyName varchar(60),
@AllergyCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select AllergyNo from Allergies where AllergyNo = @AllergyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Allergy No', @AllergyNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AllergyCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Allergy Category ID', @AllergyCategoryID, 'Lookup Data')
		return 1
	end

begin
insert into Allergies
(AllergyNo, AllergyName, AllergyCategoryID)
values
(@AllergyNo, @AllergyName, @AllergyCategoryID)
return 0
end
go

/******************************************************************************************************
exec uspInsertAllergies 'A001', 'Sulphur', '10101'
exec uspInsertAllergies 'A002', 'Fish', '10102'
exec uspInsertAllergies 'A003', 'Alcer', '10103'
exec uspInsertAllergies 'A004', 'Millet', '10102'

******************************************************************************************************/
-- select * from Allergies
-- delete from Allergies

-------------- Update Allergies -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateAllergies')
	drop proc uspUpdateAllergies
go

create proc uspUpdateAllergies(
@AllergyNo varchar(20),
@AllergyName varchar(60),
@AllergyCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AllergyNo from Allergies where AllergyNo = @AllergyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Allergy No', @AllergyNo, 'Allergies')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AllergyCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Allergy Category ID', @AllergyCategoryID, 'Lookup Data')
		return 1
	end

begin
update Allergies set
AllergyName = @AllergyName, AllergyCategoryID = @AllergyCategoryID
where AllergyNo = @AllergyNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateAllergies 'A002', 'Fish1', '10103'

******************************************************************************************************/
-- select * from Allergies
-- delete from Allergies

-------------- Get Allergies -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAllergies')
	drop proc uspGetAllergies
go

create proc uspGetAllergies(
@AllergyNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not(@AllergyNo is null)
begin
	if not exists(select AllergyNo from Allergies where AllergyNo = @AllergyNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Allergy No', @AllergyNo, 'Allergies')
			return 1
		end
	else
	begin
		select AllergyNo, AllergyName, AllergyCategoryID, 
		dbo.GetLookupDataDes(AllergyCategoryID) as AllergyCategory,
		 dbo.GetMergedNameCode(AllergyName,AllergyNo) as AllergyFullName
		from Allergies
		where AllergyNo = @AllergyNo
	end
end
else 
if @AllergyNo is null
begin
	select AllergyNo, AllergyName, AllergyCategoryID, 
	dbo.GetLookupDataDes(AllergyCategoryID) as AllergyCategory,
		 dbo.GetMergedNameCode(AllergyName,AllergyNo) as AllergyFullName
	from Allergies
end
return 0
go

/******************************************************************************************************
exec uspGetAllergies 'A001'
exec uspGetAllergies

******************************************************************************************************/
-- select * from Allergies
-- delete from Allergies

------------------------------------------------------------------------------------------------------
-------------- AllergyDrugs --------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit AllergyDrugs ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditAllergyDrugs')
	drop proc uspEditAllergyDrugs
go

create proc uspEditAllergyDrugs(
@AllergyNo varchar(20),
@DrugNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AllergyNo from Allergies where AllergyNo = @AllergyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Allergy No', @AllergyNo, 'Allergies')
		return 1
	end
else

if not exists(select DrugNo from Drugs where DrugNo = @DrugNo)
	begin
		set @ErrorMSG = 'The Drug No: %s, you''re trying to update does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, @DrugNo, 'Drugs')	
		return 1
	end
else

if exists(select AllergyNo from AllergyDrugs where AllergyNo = @AllergyNo and DrugNo = @DrugNo)
	begin return 0 end
else
begin
insert into AllergyDrugs
(AllergyNo, DrugNo)
values
(@AllergyNo, @DrugNo)
return 0
end
go

/******************************************************************************************************
exec uspEditAllergyDrugs 'A001', 'M125'
exec uspEditAllergyDrugs 'A001', 'M126'
exec uspEditAllergyDrugs 'A002', 'M125'
exec uspEditAllergyDrugs 'A002', 'M189'

******************************************************************************************************/
-- select * from AllergyDrugs
-- delete from AllergyDrugs

-------------- Get AllergyDrugs ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAllergyDrugs')
	drop proc uspGetAllergyDrugs
go

create proc uspGetAllergyDrugs(
@AllergyNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
begin
	select AllergyNo, DrugNo from AllergyDrugs
	where AllergyNo = @AllergyNo
return 0
end
go

/******************************************************************************************************
exec uspGetAllergyDrugs 'A001'

******************************************************************************************************/
-- select * from AllergyDrugs
-- delete from AllergyDrugs

------------------------------------------------------------------------------------------------------
-------------- PatientAllergies ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit PatientAllergies -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditPatientAllergies')
	drop proc uspEditPatientAllergies
go

create proc uspEditPatientAllergies(
@PatientNo varchar(20),
@AllergyNo varchar(20),
@Reaction varchar(200)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Patients')	
		return 1
	end
else

if not exists(select AllergyNo from Allergies where AllergyNo = @AllergyNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Allergy No', @AllergyNo, 'Allergies')
		return 1
	end
else

if exists(select PatientNo from PatientAllergies where PatientNo = @PatientNo and AllergyNo = @AllergyNo)
	begin
		update PatientAllergies set Reaction = @Reaction
		where PatientNo = @PatientNo and AllergyNo = @AllergyNo
		return 0
	end
else
begin
insert into PatientAllergies
(PatientNo, AllergyNo, Reaction)
values
(@PatientNo, @AllergyNo, @Reaction)
return 0
end
go

/******************************************************************************************************
exec uspEditPatientAllergies '1213480', 'A001', 'Rush'
exec uspEditPatientAllergies '1213480', 'A002', 'Swelling'
exec uspEditPatientAllergies '1213485', 'A001', 'Rush'

******************************************************************************************************/
-- select * from PatientAllergies
-- delete from PatientAllergies

-------------- Get PatientAllergies -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatientAllergies')
	drop proc uspGetPatientAllergies
go

create proc uspGetPatientAllergies(
@PatientNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select PatientNo, PatientAllergies.AllergyNo, Reaction,AllergyName, AllergyCategoryID, 
	dbo.GetLookupDataDes(AllergyCategoryID) as AllergyCategory
	from PatientAllergies
	inner join Allergies on PatientAllergies.AllergyNo = Allergies.AllergyNo
	where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspGetPatientAllergies '160017'

******************************************************************************************************/
-- select * from PatientAllergies
-- delete from PatientAllergies

------------------------------------------------------------------------------------------------------
-------------- FamilyMembers -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit FamilyMembers --------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditFamilyMembers')
	drop proc uspEditFamilyMembers
go

create proc uspEditFamilyMembers(
@PatientNo varchar(20),
@MemberName varchar(41),
@Age tinyint,
@HIVStatusID varchar(10),
@HIVCareID varchar(10),
@UniqueNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Patients')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HIVStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'HIV Status ID', @HIVStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HIVCareID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'HIV Care ID', @HIVCareID, 'Lookup Data')
		return 1
	end

if exists(select PatientNo from FamilyMembers where PatientNo = @PatientNo and MemberName = @MemberName)
	begin
		update FamilyMembers set
		Age = @Age, HIVStatusID = @HIVStatusID, HIVCareID = @HIVCareID, UniqueNo = @UniqueNo
		where PatientNo = @PatientNo and MemberName = @MemberName
		return 0
	end
else
begin
insert into FamilyMembers
(PatientNo, MemberName, Age, HIVStatusID, HIVCareID, UniqueNo)
values
(@PatientNo, @MemberName, @Age, @HIVStatusID, @HIVCareID, @UniqueNo)
return 0
end
go

/******************************************************************************************************
exec uspEditFamilyMembers '0800001', 'Member Name1', 5, '53POS', '54Y', 'U0001'
exec uspEditFamilyMembers '0800001', 'Member Name2', 5, '53POS', '54Y', 'U0002'
exec uspEditFamilyMembers '0800001', 'Member Name3', 8, '53NEG', '54N', 'U0003'

exec uspEditFamilyMembers '0800002', 'Member Name', 5, '53POS', '54Y', 'U0001'

*******************************************************************************************************/
-- select * from FamilyMembers
-- delete from FamilyMembers

-------------- Get FamilyMembers ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetFamilyMembers')
	drop proc uspGetFamilyMembers
go

create proc uspGetFamilyMembers(
@PatientNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select PatientNo, MemberName, Age, 
	HIVStatusID, dbo.GetLookupDataDes(HIVStatusID) as HIVStatus, 
	HIVCareID, dbo.GetLookupDataDes(HIVCareID) as HIVCare, UniqueNo
	from FamilyMembers
	where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspGetFamilyMembers '0800002'

******************************************************************************************************/
-- select * from FamilyMembers
-- delete from FamilyMembers

------------------------------------------------------------------------------------------------------
-------------- ExposedInfants ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ExposedInfants -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditExposedInfants')
	drop proc uspEditExposedInfants
go

create proc uspEditExposedInfants(
@PatientNo varchar(20),
@InfantName varchar(41),
@BirthDate smalldatetime,
@InfantFeedingID varchar(10),
@CTXStarted varchar(41),
@HIVTestTypeID varchar(10),
@TestResultsID varchar(10),
@InfantStatusID varchar(10),
@UniqueNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Patients')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @InfantFeedingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Infant Feeding ID', @InfantFeedingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HIVTestTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'HIV Test Type ID', @HIVTestTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TestResultsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Test Results ID', @TestResultsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @InfantStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Infant Status ID', @InfantStatusID, 'Lookup Data')
		return 1
	end

if exists(select PatientNo from ExposedInfants where PatientNo = @PatientNo and InfantName = @InfantName)
	begin
		update ExposedInfants set
		BirthDate = @BirthDate, InfantFeedingID = @InfantFeedingID, CTXStarted = @CTXStarted, HIVTestTypeID = @HIVTestTypeID, 
		TestResultsID = @TestResultsID, InfantStatusID = @InfantStatusID, UniqueNo = @UniqueNo
		where PatientNo = @PatientNo and InfantName = @InfantName
		return 0
	end
else
begin
insert into ExposedInfants
(PatientNo, InfantName, BirthDate, InfantFeedingID, CTXStarted, HIVTestTypeID, TestResultsID, InfantStatusID, UniqueNo)
values
(@PatientNo, @InfantName, @BirthDate, @InfantFeedingID, @CTXStarted, @HIVTestTypeID, @TestResultsID, @InfantStatusID, @UniqueNo)
return 0
end
go

/******************************************************************************************************
exec uspEditExposedInfants '0800001', 'Kawaya Rose', '12 May 1985', '55EBF', 'CTX Started', '5601', 
						   '52', '57POS', 'U009'

exec uspEditExposedInfants '0800001', 'Kawaya Mary', '11 May 1985', '55EBF', 'CTX Started1', '5602', 
						   '56', '57NEG', 'U009'

exec uspEditExposedInfants '0800002', 'Kawaya Rose', '12 May 1985', '55EBF', 'CTX Started', '5601', 
						   '52', '57POS', 'U009'

******************************************************************************************************/
-- select * from ExposedInfants
-- delete from ExposedInfants

-------------- Get ExposedInfants -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExposedInfants')
	drop proc uspGetExposedInfants
go

create proc uspGetExposedInfants(
@PatientNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select PatientNo, InfantName, BirthDate, InfantFeedingID, 
	dbo.GetLookupDataDes(InfantFeedingID) as InfantFeeding, CTXStarted, 
	HIVTestTypeID, dbo.GetLookupDataDes(HIVTestTypeID) as HIVTestType, 
	TestResultsID, dbo.GetLookupDataDes(TestResultsID) as TestResults, 
	InfantStatusID, dbo.GetLookupDataDes(InfantStatusID) as InfantStatus, UniqueNo
	from ExposedInfants
	where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspGetExposedInfants '0800001'

******************************************************************************************************/
-- select * from ExposedInfants
-- delete from ExposedInfants

------------------------------------------------------------------------------------------------------
-------------- PriorARTDetails -----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit PriorARTDetails ------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditPriorARTDetails')
	drop proc uspEditPriorARTDetails
go

create proc uspEditPriorARTDetails(
@PatientNo varchar(20),
@PriorARTID varchar(10),
@ARTDate smalldatetime,
@ARTWhere varchar(41),
@Combination varchar(30)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Patients')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PriorARTID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Prior ART ID', @PriorARTID, 'Lookup Data')
		return 1
	end

if not exists(select Combination from DrugCombinations where Combination  = @Combination)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Combination', @Combination, 'Drug Combinations')
		return 1
	end

if exists(select PatientNo from PriorARTDetails where PatientNo = @PatientNo and PriorARTID = @PriorARTID)
	begin
		update PriorARTDetails set
		ARTDate = @ARTDate, ARTWhere = @ARTWhere, Combination = @Combination
		where PatientNo = @PatientNo and PriorARTID = @PriorARTID
		return 0
	end
else
begin
insert into PriorARTDetails
(PatientNo, PriorARTID, ARTDate, ARTWhere, Combination)
values
(@PatientNo, @PriorARTID, @ARTDate, @ARTWhere, @Combination)
return 0
end
go

/******************************************************************************************************
exec uspEditPriorARTDetails '0800001', '58PEP', '12 AUG 2009', 'Kanungu', 'D4T+3TC+NVP'
exec uspEditPriorARTDetails '0800001', '58PMT', '12 AUG 2009', 'Kanungu', 'D4T+3TC+NVP'
exec uspEditPriorARTDetails '0800002', '58PEP', '11 AUG 2009', 'Kanungu1', 'LPV/R+CBV'

******************************************************************************************************/
-- select * from PriorARTDetails
-- delete from PriorARTDetails


-------------- Get PriorARTDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPriorARTDetails')
	drop proc uspGetPriorARTDetails
go

create proc uspGetPriorARTDetails(
@PatientNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select PatientNo, PriorARTID, ARTDate, ARTWhere, PriorARTDetails.Combination
	from PriorARTDetails
	where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspGetPriorARTDetails '0800002'

******************************************************************************************************/
-- select * from PriorARTDetails
-- delete from PriorARTDetails


------------------------------------------------------------------------------------------------------
------------- Diagnosis ------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Diagnosis ----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditDiagnosis')
	drop proc uspEditDiagnosis
go

create proc uspEditDiagnosis(
@VisitNo varchar(20) ,
@DiseaseCode varchar(10) ,
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')	
		return 1
	end

if not exists(select DiseaseCode from Diseases where DiseaseCode = @DiseaseCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Disease Code', @DiseaseCode, 'Diseases')	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if exists(select VisitNo from Diagnosis where VisitNo = @VisitNo and DiseaseCode = @DiseaseCode)
	begin
		update Diagnosis set Notes = @Notes, LoginID = @LoginID
		where VisitNo = @VisitNo and DiseaseCode = @DiseaseCode
		return 0
	end

else
begin
insert into Diagnosis
(VisitNo, DiseaseCode, Notes, LoginID)
values
(@VisitNo, @DiseaseCode, @Notes, @LoginID)
return 0
end
go

/********************************************************************************************
exec uspEditDiagnosis '1100345001', '33001', 'Patient reported', 'Admin'

********************************************************************************************/

-- select *  from Diagnosis
-- delete from Diagnosis

--------Get Diagnosis-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDiagnosis')
	drop proc uspGetDiagnosis
go

create proc uspGetDiagnosis(
@VisitNo as varchar(20) = null 
)with encryption as

if not (@VisitNo is null)
	begin
		select  VisitNo, Diagnosis.DiseaseCode, DiseaseName, DiseaseCategoriesID, 
		dbo.GetLookupDataDes(DiseaseCategoriesID) as DiseaseCategories, Notes,
		dbo.GetStaffFullNameWithLoginID(LoginID) as CreatorFullName 
		from Diagnosis
		inner join Diseases on Diagnosis.DiseaseCode = Diseases.DiseaseCode
		where VisitNo = @VisitNo	
	end

if (@VisitNo is null)
	begin
		select  VisitNo, Diagnosis.DiseaseCode, DiseaseName, DiseaseCategoriesID, 
		dbo.GetLookupDataDes(DiseaseCategoriesID) as DiseaseCategories, Notes,
		dbo.GetStaffFullNameWithLoginID(LoginID) as CreatorFullName 
		from Diagnosis
		inner join Diseases on Diagnosis.DiseaseCode = Diseases.DiseaseCode
	end

return 0

go

-- select * from Diagnosis
-- exec uspGetDiagnosis '1100345001'
------------------------------------------------------------------------------------------------------
----------------------- Get general diagnosis -----------------------------

if exists(select * from sysobjects where name ='uspGetDeathGeneralDiagnosis')
drop proc uspGetDeathGeneralDiagnosis
go

create proc uspGetDeathGeneralDiagnosis(
@PatientNo varchar(20),
@StartDate smalldatetime =null,
@EndDate smalldatetime = null
)
with encryption
as 
Declare @ErrorMSG varchar(200)

begin
	if not exists(select * from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG='The %s: %s you''ve entred does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Patients')
		return 1
	end
if not(@StartDate is null) and not(@EndDate is null)
	begin
		select FirstName,LastName,MiddleName,Diagnosis.VisitNo,visitdate,diagnosis.DiseaseCode,DiseaseName,DiseaseCategoriesID,dbo.GetLookupDataDes(DiseaseCategoriesID) 
		as DiseaseCategory,dbo.GetLookupDataDes(DoctorSpecialtyID)as DoctorSpeciality,Notes,Diagnosis.RecordDateTime
		from Diseases
		inner join 
		Diagnosis on Diagnosis.DiseaseCode = Diseases.DiseaseCode
		inner join 
		visits on diagnosis.visitno = visits.visitno
		inner join 
		Patients on Visits.PatientNo = Patients.PatientNo where visits.PatientNo=@PatientNo
		and VisitDate between @StartDate and @EndDate
	end
else
	begin
		select FirstName,LastName,MiddleName,Diagnosis.VisitNo,visitdate,diagnosis.DiseaseCode,DiseaseName,DiseaseCategoriesID,dbo.GetLookupDataDes(DiseaseCategoriesID) 
		as DiseaseCategory,dbo.GetLookupDataDes(DoctorSpecialtyID)as DoctorSpeciality,Notes,Diagnosis.RecordDateTime
		from Diseases
		inner join 
		Diagnosis on Diagnosis.DiseaseCode = Diseases.DiseaseCode
		inner join 
		visits on diagnosis.visitno = visits.visitno
		inner join 
		Patients on Visits.PatientNo = Patients.PatientNo where visits.PatientNo=@PatientNo
	end
return 0
end
go

----------------------- Get cancer diagnosis -----------------------------

if exists(select * from sysobjects where name ='uspGetDeathCancerDiagnosis')
drop proc uspGetDeathCancerDiagnosis
go

create proc uspGetDeathCancerDiagnosis(
@PatientNo varchar(20),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)
with encryption
as 
Declare @ErrorMSG varchar(200)

begin
	if not exists(select * from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG='The %s: %s you''ve entred does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Patients')
		return 1
	end

if not(@StartDate is null) and not (@EndDate is null)
	begin
		select FirstName,LastName,MiddleName,CancerDiagnosis.VisitNo,visitdate,CancerDiseases.DiseaseCode,DiseaseName,CancerDiseaseCategoriesID,dbo.GetLookupDataDes(CancerDiseaseCategoriesID) 
		as DiseaseCategory,dbo.GetLookupDataDes(DoctorSpecialtyID)as DoctorSpeciality,Notes,CancerDiagnosis.RecordDateTime
		from CancerDiseases
		inner join 
		CancerDiagnosis on CancerDiagnosis.DiseaseNo = CancerDiseases.DiseaseNo
		inner join 
		visits on CancerDiagnosis.visitno = visits.visitno
		inner join 
		Patients on Visits.PatientNo = Patients.PatientNo where visits.PatientNo=@PatientNo
		and VisitDate between @StartDate and @EndDate
	end
else
	begin
		select FirstName,LastName,MiddleName,CancerDiagnosis.VisitNo,visitdate,CancerDiseases.DiseaseCode,DiseaseName,CancerDiseaseCategoriesID,dbo.GetLookupDataDes(CancerDiseaseCategoriesID) 
		as DiseaseCategory,dbo.GetLookupDataDes(DoctorSpecialtyID)as DoctorSpeciality,Notes,CancerDiagnosis.RecordDateTime
		from CancerDiseases
		inner join 
		CancerDiagnosis on CancerDiagnosis.DiseaseNo = CancerDiseases.DiseaseNo
		inner join 
		visits on CancerDiagnosis.visitno = visits.visitno
		inner join 
		Patients on Visits.PatientNo = Patients.PatientNo where visits.PatientNo=@PatientNo
	end
return 0
end
go
-------------- CancerDiseases --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert CancerDiseases -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertCancerDiseases')
	drop proc uspInsertCancerDiseases
go

create proc uspInsertCancerDiseases(
@DiseaseNo varchar(20),
@DiseaseCode varchar(10),
@DiseaseName varchar(800),
@CancerDiseaseCategoriesID varchar(10),
@Hidden bit,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @DiseaseID int

declare @PaddingLEN tinyint

declare @PassedDiseaseID int
declare @PassedDiseaseNo varchar(20)
declare @PassedDiseaseCode varchar(20)

if exists(select DiseaseNo from CancerDiseases where DiseaseNo = @DiseaseNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Disease No', @DiseaseNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CancerDiseaseCategoriesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cancer Disease Category', @CancerDiseaseCategoriesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
--------------------------------------------------------------------------------------------------------------

select @PaddingLEN = PaddingLEN from AutoNumbers where ObjectName = 'CancerDiseases' and AutoColumnName = 'DiseaseNo'
   set @PassedDiseaseNo = ltrim(rtrim(substring(@DiseaseNo, 1, len(@DiseaseNo) - @PaddingLEN)))

set @DiseaseID = CONVERT(int,ltrim(rtrim(right(@DiseaseNo,@PaddingLEN))))

--------------------------------------------------------------------------------------------------------------

insert into CancerDiseases
(DiseaseID, DiseaseNo, DiseaseCode, DiseaseName, CancerDiseaseCategoriesID, Hidden, LoginID)
values
(@DiseaseID, @DiseaseNo, @DiseaseCode, @DiseaseName, @CancerDiseaseCategoriesID, @Hidden, @LoginID)
return 0
end
go


/******************************************************************************************************
exec uspInsertCancerDiseases
******************************************************************************************************/
-- select * from CancerDiseases
-- delete from CancerDiseases


-------------- Update CancerDiseases -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateCancerDiseases')
	drop proc uspUpdateCancerDiseases
go

create proc uspUpdateCancerDiseases(
@DiseaseNo varchar(20),
@DiseaseCode varchar(10),
@DiseaseName varchar(800),
@CancerDiseaseCategoriesID varchar(10),
@Hidden bit,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DiseaseNo from CancerDiseases where DiseaseNo = @DiseaseNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Disease No', @DiseaseNo, 'CancerDiseases')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CancerDiseaseCategoriesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cancer Disease Category', @CancerDiseaseCategoriesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update CancerDiseases set
DiseaseCode = @DiseaseCode, DiseaseName = @DiseaseName, CancerDiseaseCategoriesID = @CancerDiseaseCategoriesID, 
Hidden = @Hidden, LoginID = @LoginID
where DiseaseNo = @DiseaseNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateCancerDiseases
******************************************************************************************************/
-- select * from CancerDiseases
-- delete from CancerDiseases


-------------- Get CancerDiseases -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCancerDiseases')
	drop proc uspGetCancerDiseases
go

create proc uspGetCancerDiseases(
@DiseaseNo varchar(20)= null ,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
if not (@DiseaseNo is null)
begin

if not exists(select DiseaseNo from CancerDiseases where DiseaseNo = @DiseaseNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Disease No', @DiseaseNo, 'CancerDiseases')
		return 1
	end
else
begin
	select DiseaseNo, DiseaseCode, DiseaseName, CancerDiseaseCategoriesID,
	 dbo.GetLookupDataDes(CancerDiseaseCategoriesID) as CancerDiseaseCategory,
	  dbo.GetMergedNameCode(DiseaseName,DiseaseNo) as DiseaseFullName, Hidden, 
	 CancerDiseases.LoginID, ClientMachine, RecordDateTime
	from CancerDiseases

	where DiseaseNo = @DiseaseNo
end
end

else
if (@DiseaseNo is null)
begin
begin
	select DiseaseNo, DiseaseCode, DiseaseName, CancerDiseaseCategoriesID,
	 dbo.GetLookupDataDes(CancerDiseaseCategoriesID) as CancerDiseaseCategory, 
	  dbo.GetMergedNameCode(DiseaseName,DiseaseNo) as DiseaseFullName,Hidden, 
	 CancerDiseases.LoginID, ClientMachine, RecordDateTime
	from CancerDiseases
    where Hidden = @Hidden
	order by DiseaseName
end
end
go

--------GetNextDiseaseID--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextCancerDiseaseID')
	drop proc uspGetNextCancerDiseaseID
go

create proc uspGetNextCancerDiseaseID(
@DiseaseCode varchar(20),
@DiseaseID int = null output
)with encryption as

declare @Increment int

set @Increment= (select Increment from AutoNumbers where ObjectName = 'CancerDiseases')
set @DiseaseID = (select max(DiseaseID)+ @Increment from CancerDiseases where DiseaseCode = @DiseaseCode)

return 0

go
-- exec uspGetNextDiseaseID '08022077'
/******************************************************************************************************
exec uspGetCancerDiseases
******************************************************************************************************/

------------------------------------------------------------------------------------------------------
-------------- CancerDiagnosis --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit CancerDiagnosis -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditCancerDiagnosis')
	drop proc uspEditCancerDiagnosis
go

create proc uspEditCancerDiagnosis(
@VisitNo varchar(20),
@DiseaseNo varchar(20),
@TopographicalNo varchar(20),
@BasisOfDiagnosisID varchar(10),
@CancerStageID varchar(10),
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DiseaseNo from CancerDiseases where DiseaseNo  = @DiseaseNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'DiseaseNo', @DiseaseNo, 'CancerDiseases')
		return 1
	end
if not exists(select TopographicalNo from TopologySites where TopographicalNo  = @TopographicalNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Topology', @TopographicalNo, 'TopologySites')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BasisOfDiagnosisID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Basis Of Diagnosis', @BasisOfDiagnosisID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CancerStageID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cancer Stage', @CancerStageID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
	
if exists(select VisitNo from CancerDiagnosis where VisitNo = @VisitNo and DiseaseNo = @DiseaseNo)
begin

update CancerDiagnosis set
TopographicalNo = @TopographicalNo, BasisOfDiagnosisID = @BasisOfDiagnosisID, CancerStageID = @CancerStageID, 
Notes = @Notes, LoginID = @LoginID
where VisitNo = @VisitNo and DiseaseNo = @DiseaseNo
end
else

begin
insert into CancerDiagnosis (VisitNo, DiseaseNo, TopographicalNo, BasisOfDiagnosisID,CancerStageID, Notes, LoginID)
values
(@VisitNo, @DiseaseNo, @TopographicalNo, @BasisOfDiagnosisID, @CancerStageID, @Notes, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertCancerDiagnosis
******************************************************************************************************/
-- select * from CancerDiagnosis
-- delete from CancerDiagnosis


-------------- Get CancerDiagnosis -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCancerDiagnosis')
	drop proc uspGetCancerDiagnosis
go

create proc uspGetCancerDiagnosis(
@VisitNo varchar(20) = null
)with encryption as
declare @ErrorMSG varchar(200)
if not (@VisitNo is null)
begin
	select VisitNo, CancerDiseases.DiseaseNo, TopologySites.TopographicalNo, 
	BasisOfDiagnosisID, dbo.GetLookupDataDes(BasisOfDiagnosisID) as BasisOfDiagnosis
	, CancerStageID, dbo.GetLookupDataDes(CancerStageID) as CancerStage, Notes,DiseaseCode
	,CancerDiseaseCategoriesID, dbo.GetLookupDataDes(CancerDiseaseCategoriesID) as CancerDiseaseCategories,
	CancerDiagnosis.LoginID, CancerDiseases.ClientMachine,CancerDiseases.RecordDateTime
	from CancerDiagnosis
	inner join CancerDiseases on CancerDiagnosis.DiseaseNo = CancerDiseases.DiseaseNo
	inner join TopologySites on CancerDiagnosis.TopographicalNo = TopologySites.TopographicalNo
	where VisitNo = @VisitNo
end

if (@VisitNo is null)

	begin
	
select VisitNo, CancerDiseases.DiseaseNo, TopologySites.TopographicalNo, 
	BasisOfDiagnosisID, dbo.GetLookupDataDes(BasisOfDiagnosisID) as BasisOfDiagnosis
	, CancerStageID, dbo.GetLookupDataDes(CancerStageID) as CancerStage, Notes,DiseaseCode,
	CancerDiseaseCategoriesID, dbo.GetLookupDataDes(CancerDiseaseCategoriesID) as CancerDiseaseCategories,
	CancerDiagnosis.LoginID, CancerDiseases.ClientMachine,CancerDiseases.RecordDateTime
	from CancerDiagnosis
	inner join CancerDiseases on CancerDiagnosis.DiseaseNo = CancerDiseases.DiseaseNo
	inner join TopologySites on CancerDiagnosis.TopographicalNo = TopologySites.TopographicalNo
end
go

/******************************************************************************************************
exec uspGetCancerDiagnosis
******************************************************************************************************/
-- select * from CancerDiagnosis
-- delete from CancerDiagnosis

------------------------------------------------------------------------------------------------------
-------------- TopologySites --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert TopologySites -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertTopologySites')
	drop proc uspInsertTopologySites
go

create proc uspInsertTopologySites(
@TopographicalNo varchar(20),
@TopologySiteCodeID varchar(10),
@TopologySiteName varchar(800),
@Hidden bit,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select TopographicalNo from TopologySites where TopographicalNo = @TopographicalNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'TopographicalNo', @TopographicalNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TopologySiteCodeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Topology Site', @TopologySiteCodeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into TopologySites
(TopographicalNo, TopologySiteCodeID, TopologySiteName, Hidden, LoginID)
values
(@TopographicalNo, @TopologySiteCodeID, @TopologySiteName, @Hidden, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertTopologySites
******************************************************************************************************/
-- select * from TopologySites
-- delete from TopologySites


-------------- Update TopologySites -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateTopologySites')
	drop proc uspUpdateTopologySites
go

create proc uspUpdateTopologySites(
@TopographicalNo varchar(20),
@TopologySiteCodeID varchar(10),
@TopologySiteName varchar(800),
@Hidden bit,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TopographicalNo from TopologySites where TopographicalNo = @TopographicalNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TopographicalNo', @TopographicalNo, 'TopologySites')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TopologySiteCodeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Topology Site', @TopologySiteCodeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update TopologySites set
TopologySiteCodeID = @TopologySiteCodeID,
 TopologySiteName = @TopologySiteName,
 Hidden = @Hidden, LoginID = @LoginID
where TopographicalNo = @TopographicalNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateTopologySites
******************************************************************************************************/
-- select * from TopologySites
-- delete from TopologySites


-------------- Get TopologySites -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTopologySites')
	drop proc uspGetTopologySites
go

create proc uspGetTopologySites(
@TopographicalNo varchar(20) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
if not (@TopographicalNo is null)
begin

if not exists(select TopographicalNo from TopologySites where TopographicalNo = @TopographicalNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TopographicalNo', @TopographicalNo, 'TopologySites')
		return 1
	end
else
begin
	select TopographicalNo, TopologySiteCodeID, dbo.GetLookupDataDes(TopologySiteCodeID) as TopologySite,
	 TopologySiteName,dbo.GetMergedNameCode(dbo.GetLookupDataDes(TopologySiteCodeID), TopologySiteName) as TopologyFullName,
	 dbo.GetMergedNameCode(TopologySiteName,TopographicalNo) as TopologySiteFullName, Hidden, TopologySites.LoginID, ClientMachine, RecordDateTime
	from TopologySites
    where TopographicalNo = @TopographicalNo order by dbo.GetLookupDataDes(TopologySiteCodeID) asc
end
end

else
if (@TopographicalNo is null)
begin
begin
select TopographicalNo, TopologySiteCodeID, dbo.GetLookupDataDes(TopologySiteCodeID) as TopologySite,
	 TopologySiteName,dbo.GetMergedNameCode(dbo.GetLookupDataDes(TopologySiteCodeID), TopologySiteName) as TopologyFullName, 
	 dbo.GetMergedNameCode(TopologySiteName,TopographicalNo) as TopologySiteFullName,Hidden, TopologySites.LoginID, ClientMachine, RecordDateTime
	from TopologySites
	where Hidden = @Hidden
	order by dbo.GetLookupDataDes(TopologySiteCodeID) asc
end
end
go


/******************************************************************************************************
exec uspGetTopologySites
******************************************************************************************************/
-- select * from TopologySites
-- delete from TopologySites


------------------------------------------------------------------------------------------------------
-------------- Rooms ---------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Rooms --------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertRooms')
	drop proc uspInsertRooms
go

create proc uspInsertRooms(
@RoomNo varchar(20),
@RoomName varchar(41),
@WardsID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select RoomNo from Rooms where RoomNo = @RoomNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Room No', @RoomNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @WardsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Ward', @WardsID, 'Lookup Data')
		return 1
	end

begin
insert into Rooms
(RoomNo, RoomName, WardsID)
values
(@RoomNo, @RoomName, @WardsID)
return 0
end
go

/******************************************************************************************************
exec uspInsertRooms '001', 'Room 1', '40PRI'
exec uspInsertRooms '002', 'Room 2', '40GEN'
exec uspInsertRooms '003', 'Room 3', '40PRI'

*******************************************************************************************************/
-- select * from Rooms
-- delete from Rooms

-------------- Update Rooms --------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateRooms')
	drop proc uspUpdateRooms
go

create proc uspUpdateRooms(
@RoomNo varchar(20),
@RoomName varchar(41),
@WardsID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoomNo from Rooms where RoomNo = @RoomNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Room No', @RoomNo, 'Rooms')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @WardsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Ward', @WardsID, 'Lookup Data')
		return 1
	end

begin
update Rooms set
RoomName = @RoomName, WardsID = @WardsID
where RoomNo = @RoomNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateRooms '002', 'Room 2', '40GEN'

******************************************************************************************************/

-- select * from Rooms
-- delete from Rooms

-------------- Get Rooms ----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRooms')
	drop proc uspGetRooms
go

create proc uspGetRooms(
@RoomNo varchar(20) = null,
@WardsID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@RoomNo is null) and (@WardsID is null))
begin
	if not exists(select RoomNo from Rooms where RoomNo = @RoomNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Room No', @RoomNo, 'Rooms')
			return 1
		end
	else
	begin
		select RoomNo, RoomName, WardsID, dbo.GetLookupDataDes(WardsID) as Ward,dbo.GetMergedNameCode(RoomName,RoomNo) as RoomFullName
		from Rooms
		where RoomNo = @RoomNo
	end
end
else
if  ((@RoomNo is null) and not (@WardsID is null))
begin
		select RoomNo, RoomName, WardsID, dbo.GetLookupDataDes(WardsID) as Ward,dbo.GetMergedNameCode(RoomName,RoomNo) as RoomFullName
		from Rooms
		where WardsID = @WardsID
end
else
if  ((@RoomNo is null) and (@WardsID is null))
begin
		select RoomNo, RoomName, WardsID, dbo.GetLookupDataDes(WardsID) as Ward,dbo.GetMergedNameCode(RoomName,RoomNo) as RoomFullName
		from Rooms
end
return 0
go

/******************************************************************************************************
exec uspGetRooms
exec uspGetRooms '001'
exec uspGetRooms null, '40PRI'

******************************************************************************************************/
-- select * from Rooms
-- delete from Rooms

------------------------------------------------------------------------------------------------------
-------------- Beds ----------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Beds ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertBeds')
	drop proc uspInsertBeds
go

create proc uspInsertBeds(
@BedNo varchar(20),
@BedName varchar(41),
@RoomNo varchar(20),
@UnitCost money,
@VATPercentage decimal,
@UnitPrice money,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)
declare @BedID Int
declare @BedNoPrefix varchar(1)

if exists(select BedNo from Beds where BedNo = @BedNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Bed No', @BedNo)
		return 1
	end

if not exists(select RoomNo from Rooms where RoomNo  = @RoomNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Room No', @RoomNo, 'Rooms')
		return 1
	end

begin
	set @BedNoPrefix = dbo.GetOptionValue('BedNoPrefix')
	set @BedID = (select max(BedID) from Beds where left(BedNo, len(@BedNoPrefix)) = @BedNoPrefix)
	set @BedID = dbo.GetNextAutoNumber('Beds', 'BedNo', @BedID)

insert into Beds
(BedID, BedNo, BedName, RoomNo, UnitCost, UnitPrice,VATPercentage, Hidden)
values
(@BedID, @BedNo, @BedName, @RoomNo, @UnitCost, @UnitPrice,@VATPercentage, @Hidden)
return 0
end
go

/******************************************************************************************************
exec uspInsertBeds '001', 'Sinlge 1', '001', 5000
exec uspInsertBeds '002', 'Double 1', '001', 6000
exec uspInsertBeds '003', 'Sinlge 3', '001', 8000
exec uspInsertBeds '004', 'Double 4', '002', 12000
exec uspInsertBeds '005', 'Sinlge 5', '002', 4000

******************************************************************************************************/
-- select * from Beds
-- delete from Beds

---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextBedID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextBedID')
	drop proc uspGetNextBedID
go
create proc uspGetNextBedID(
@BedID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @BedNoPrefix varchar(1)

set @BedNoPrefix =dbo.GetOptionValue('BedNoPrefix')

set @BedID = (select max(BedID) from Beds where left(BedNo, len(@BedNoPrefix)) = @BedNoPrefix)
set @BedID =  dbo.GetNextAutoNumber('Beds', 'BedNo', @BedID)

return 0
go



-------------- Update Beds -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateBeds')
	drop proc uspUpdateBeds
go

create proc uspUpdateBeds(
@BedNo varchar(20),
@BedName varchar(41),
@RoomNo varchar(20),
@UnitCost money,
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select BedNo from Beds where BedNo = @BedNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bed No', @BedNo, 'Beds')
		return 1
	end

if not exists(select RoomNo from Rooms where RoomNo  = @RoomNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Room No', @RoomNo, 'Rooms')
		return 1
	end

begin
update Beds set
BedName = @BedName, RoomNo = @RoomNo, UnitCost = @UnitCost, UnitPrice = @UnitPrice, VATPercentage=@VATPercentage,Hidden = @Hidden
where BedNo = @BedNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateBeds '003', 'Sinlge 3', '003', 8300

******************************************************************************************************/
-- select * from Beds
-- delete from Beds

-------------- Get Beds --------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBeds')
	drop proc uspGetBeds
go

create proc uspGetBeds(
@BedNo varchar(20)= null,
@RoomNo varchar(20) = null,
@Hidden bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@BedNo is null) and (@RoomNo is null))
begin
	if not exists(select BedNo from Beds where BedNo = @BedNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Bed No', @BedNo, 'Beds')
			return 1
		end
	else
	begin
		select BedNo, BedName, Beds.RoomNo, RoomName, UnitCost, UnitPrice,VATPercentage,
			dbo.GetMergedNameCode(BedName, BedNo) as BedFullName, 		
			WardsID, dbo.GetLookupDataDes(WardsID) as Ward, Hidden
		from Beds
		inner join Rooms on Beds.RoomNo = Rooms.RoomNo		
		where BedNo = @BedNo
	end
end
else
if ((@BedNo is null) and not (@RoomNo is null))
begin
		select BedNo, BedName, Beds.RoomNo, RoomName, UnitCost, UnitPrice, VATPercentage, 
			dbo.GetMergedNameCode(BedName, BedNo) as BedFullName, 		
			WardsID, dbo.GetLookupDataDes(WardsID) as Ward, Hidden
		from Beds
		inner join Rooms on Beds.RoomNo = Rooms.RoomNo	
		where Beds.RoomNo = @RoomNo and Hidden = @Hidden
end
else
if  ((@BedNo is null) and (@RoomNo is null))
begin
		select BedNo, BedName, Beds.RoomNo, RoomName, UnitCost, UnitPrice, VATPercentage,
			dbo.GetMergedNameCode(BedName, BedNo) as BedFullName, 		
			WardsID, dbo.GetLookupDataDes(WardsID) as Ward, Hidden
		from Beds
		inner join Rooms on Beds.RoomNo = Rooms.RoomNo	
		where Hidden = @Hidden
end

return 0
go


/******************************************************************************************************
exec uspGetBeds '2B'
exec uspGetBeds null, '002'
exec uspGetBeds 
******************************************************************************************************/
-- select * from Beds
-- delete from Beds

------------------------------------------------------------------------------------------------------
-------------- Admissions ----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Admissions ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAdmissions')
	drop proc uspInsertAdmissions
go

create proc uspInsertAdmissions(
@AdmissionNo varchar(20),
@VisitNo varchar(20),
@StaffNo varchar(10),
@BedNo varchar(20),
@AdmissionDateTime smalldatetime,
@ServiceCode varchar(10) = null,
@BillModesID varchar(10),
@BillNo varchar(20),
@InsuranceNo varchar(20),
@AssociatedBillNo varchar(20) = null,
@MemberCardNo varchar(30),
@MainMemberName varchar(41),
@ClaimReferenceNo varchar(30),
@CoPayTypeID varchar(10),
@CoPayPercent decimal(5,2),
@CoPayValue money,
@ProvisionalDiagnosis varchar(2000) = null,
@AdmissionNotes varchar(2000),
@AdmissionStatusID varchar(10),
@ChartNumber varchar(20),
@AccessCashServices bit,
@SmartCardApplicable bit,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

declare @InWardAdmissionStatusID varchar(10)

declare @AdmissionID int
declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @CurrentYear as char(2)
declare @CurrentMonth as char(2)
declare @WardInitial as varchar(1)
declare @AdmissionNoPrefix as varchar(5)

declare @PassedAdmissionID int
declare @PassedAdmissionNo varchar(20)
declare @PassedPatientNo varchar(20)

declare @PatientNo varchar(20)

----------------------------------------------------------------------------------------------------------------
set @InWardAdmissionStatusID = dbo.GetLookupDataID('AdmissionStatus', 'I')
set @PatientNo = (select PatientNo from Visits where VisitNo = @VisitNo)
----------------------------------------------------------------------------------------------------------------

if exists(select AdmissionNo from Admissions where AdmissionNo = @AdmissionNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Admission No', @AdmissionNo)
		return 1
	end

if exists(select VisitNo from Admissions where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter has an admission already'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo)
		return 1
	end

if exists(select AdmissionNo from Admissions
		  where PatientNo = @PatientNo and AdmissionStatusID = @InWardAdmissionStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, is known to have an active admission. You can''t register new admission before discharging the previous one.'
		raiserror(@ErrorMSG, 16, 1, 'Patient with No', @PatientNo)	
		return 1
	end


if not (@AssociatedBillNo is null or @AssociatedBillNo = '') 
	begin
		if not exists(select AccountNo from BillCustomers where AccountNo  = @AssociatedBillNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Associated Bill No', @AssociatedBillNo, 'To-Bill Customers')
				return 1
			end
	end
else if (@AssociatedBillNo is null or @AssociatedBillNo = '') 
begin set @AssociatedBillNo = null end

if not (@ServiceCode is null or @ServiceCode = '') 
	begin
		if not exists(select ServiceCode from Services where ServiceCode  = @ServiceCode)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Services')
				return 1
			end
	end
else if (@ServiceCode is null or @ServiceCode = '')
begin set @ServiceCode = null end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
		return 1
	end

if not exists(select BedNo from Beds where BedNo  = @BedNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bed No', @BedNo, 'Beds')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AdmissionStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Admission Status ID', @AdmissionStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

--------------------------------------------------------------------------------------------------------------
if (dbo.GetOptionValue('AllowCustomAdmissionNoFormat') > 0)
	begin 
		select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
				where ObjectName = 'Admissions' and AutoColumnName = 'AdmissionNo'

		select @PaddingLEN = PaddingLEN from AutoNumbers 
				where ObjectName = 'Admissions' and AutoColumnName = 'AdmissionNo'
				
		set @WardInitial = dbo.GetWardInitial(dbo.GetWardName(@BedNo))
		set @CurrentYear = right(year(getdate()), 2)
		set @CurrentMonth = month(getdate())

		set @AdmissionNoPrefix = @WardInitial + @CurrentYear + dbo.PadLeft(@CurrentMonth, 2)
		
		if (@AutoColumnLEN = len(@AdmissionNo)) and (left(@AdmissionNo, len(@AdmissionNoPrefix)) = @AdmissionNoPrefix)

			begin

				set @PassedAdmissionID = 1
				set @PassedAdmissionNo = @AdmissionNo
				set @PassedAdmissionNo = ltrim(rtrim(substring(@PassedAdmissionNo, len(@AdmissionNoPrefix) + 1, @PaddingLEN)))

				if isnumeric(@PassedAdmissionNo) = 1 set @PassedAdmissionID = @PassedAdmissionNo
				else set @PassedAdmissionID = 1
				
				set @AdmissionID = (select max(AdmissionID) from Admissions where left(AdmissionNo, len(@AdmissionNoPrefix)) = @AdmissionNoPrefix)
				set @AdmissionID = dbo.GetNextAutoNumber('Admissions', 'AdmissionNo', @AdmissionID)

				if @PassedAdmissionID < @AdmissionID set @AdmissionID = @PassedAdmissionID
				if @PassedAdmissionID > @AdmissionID set @AdmissionID = @PassedAdmissionID

			end else set @AdmissionID = 1
	end
else 
	begin 

		select @PaddingLEN = PaddingLEN from AutoNumbers 
				where ObjectName = 'Admissions' and AutoColumnName = 'AdmissionNo'

		set @PassedPatientNo = ltrim(rtrim(substring(@AdmissionNo, 1, len(@AdmissionNo) - @PaddingLEN)))

		if (@PassedPatientNo = @PatientNo)

		begin

			set @PassedAdmissionID = 1
			set @PassedAdmissionNo = @AdmissionNo

			set @PassedAdmissionNo = ltrim(rtrim(substring(@PassedAdmissionNo, len(@PassedPatientNo) + 1, @PaddingLEN)))

			if isnumeric(@PassedAdmissionNo) = 1 set @PassedAdmissionID = @PassedAdmissionNo
			else set @PassedAdmissionID = 1

			set @AdmissionID = (select max(AdmissionID) from Admissions where PatientNo = @PatientNo)
			set @AdmissionID = dbo.GetNextAutoNumber('Admissions', 'AdmissionNo', @AdmissionID)

			if @PassedAdmissionID < @AdmissionID set @AdmissionID = @PassedAdmissionID
			if @PassedAdmissionID > @AdmissionID set @AdmissionID = @PassedAdmissionID

		end else set @AdmissionID = 1
	end
-----------------------------------------------------------------------------------------------------------------

insert into Admissions
(AdmissionID, AdmissionNo, VisitNo,PatientNo, StaffNo, BedNo, AdmissionDateTime, 
AdmissionNotes,ProvisionalDiagnosis, AdmissionStatusID,ChartNumber,AccessCashServices,SmartCardApplicable,ServiceCode,BillModesID, BillNo, InsuranceNo, AssociatedBillNo,MemberCardNo, MainMemberName,
ClaimReferenceNo,CoPayTypeID, CoPayPercent, CoPayValue, LoginID, ClientMachine)
values
(@AdmissionID, @AdmissionNo, @VisitNo,@PatientNo, @StaffNo, @BedNo, @AdmissionDateTime, 
@AdmissionNotes,@ProvisionalDiagnosis, @AdmissionStatusID,@ChartNumber,@AccessCashServices,@SmartCardApplicable,@ServiceCode,@BillModesID, @BillNo, @InsuranceNo, @AssociatedBillNo,@MemberCardNo, @MainMemberName,
@ClaimReferenceNo,@CoPayTypeID, @CoPayPercent, @CoPayValue, @LoginID, @ClientMachine)

return 0
end
go

/******************************************************************************************************
exec uspInsertAdmissions '11000101', '110001001', '001', '15 May 2010', 'Admin Notes', '34I', 'Admin'
exec uspInsertAdmissions '110000102', '1100001001', '002', '15 May 2010', 'Admin Notes', '34I', 'Admin'

******************************************************************************************************/
-- select * from Admissions
-- delete from Admissions

-------------- Update Admissions ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateAdmissions')
	drop proc uspUpdateAdmissions
go

create proc uspUpdateAdmissions(
@AdmissionNo varchar(20),
@VisitNo varchar(20),
@StaffNo varchar(10),
@BedNo varchar(20),
@AdmissionDateTime smalldatetime = null,
@ServiceCode varchar(10) = null,
@BillModesID varchar(10) = null,
@BillNo varchar(20) = null,
@InsuranceNo varchar(20) = null,
@AssociatedBillNo varchar(20) = null,
@MemberCardNo varchar(30) = null,
@MainMemberName varchar(41) = null,
@ClaimReferenceNo varchar(30) = null,
@CoPayTypeID varchar(10) = null,
@CoPayPercent decimal(5,2),
@CoPayValue money = null,
@ProvisionalDiagnosis varchar(2000) =null,
@AdmissionNotes varchar(2000) = null,
@AdmissionStatusID varchar(10) = null,
@ChartNumber varchar(20) = null,
@AccessCashServices bit =null,
@SmartCardApplicable bit = null,
@LoginID varchar(20) = null,
@ClientMachine varchar(40) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @PayStatusID varchar(10)
declare @NAPayStatusID varchar(10)
declare @PatientNo varchar(20)
declare @CashBillModesID varchar(10)
declare @CashBillModes varchar(100)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)
----------------------------------------------------------------------------

set @PayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @NAPayStatusID = dbo.GetLookupDataID('PayStatus', 'NA')
set @PatientNo = (select PatientNo from Visits where VisitNo = @VisitNo)
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')


if not exists(select AdmissionNo from Admissions where AdmissionNo = @AdmissionNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Admission No', @AdmissionNo, 'Admissions')
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
		return 1
	end

if not exists(select BedNo from Beds where BedNo  = @BedNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bed No', @BedNo, 'Beds')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AdmissionStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Admission Status ID', @AdmissionStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if not (@AssociatedBillNo is null or @AssociatedBillNo = '') 
	begin
		if not exists(select AccountNo from BillCustomers where AccountNo  = @AssociatedBillNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Associated Bill No', @AssociatedBillNo, 'To-Bill Customers')
				return 1
			end
	end
else if (@AssociatedBillNo is null or @AssociatedBillNo = '') 
begin set @AssociatedBillNo = null end

if ( not(@LoginID is null or @LoginID = '') and not(@AdmissionDateTime is null) and not(@AccessCashServices is null) 
	 and not(@BillModesID is null) and not(@BillNo is null) and not (@SmartCardApplicable is null))
	begin
	
		------------------------------------------------------------------------------------------------------------------
		if (@BillModesID = @AccountBillModesID) and (@BillNo = @CashBillModes)
			begin
				set @ErrorMSG = 'Default Bill No for Bill Mode Account can''t be Cash!'
				raiserror(@ErrorMSG,16, 1)	
				return 1
			end

		if (@BillModesID = @InsuranceBillModesID)
			begin
				if not exists(select MedicalCardNo from SchemeMembers where MedicalCardNo = @BillNo)
					begin
						set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
						raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @BillNo, 'Scheme Members')
						return 1
					end

				if not exists(select PatientNo from Patients where PatientNo = @PatientNo and DefaultBillNo = @BillNo)
					begin
						if exists(select PatientNo from Patients where DefaultBillModesID = @InsuranceBillModesID and DefaultBillNo = @BillNo)
							begin
								set @ErrorMSG = 'The %s: %s, you are trying to enter is already assigned to another Patient'
								raiserror(@ErrorMSG, 16, 1, 'Medical Card No', @BillNo)
								return 1
							end
					end
			end
		else 
			begin 
				if not exists(select AccountNo from BillCustomers where AccountNo = @BillNo)
					begin
						set @ErrorMSG = 'The  %s: %s, you are trying to enter does not exist in the registered %s'
						raiserror(@ErrorMSG, 16, 1, 'Account No', @BillNo, 'Bill Customers')	
						return 1
					end
			end

	---------------------------------------------------------------------------------------------------------------------
		
if  exists(select VisitNo from ExtraBillItems
	inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
	where VisitNo = @VisitNo and PayStatusID Not in (@NAPayStatusID,@PayStatusID)) 
	begin	
		set @ErrorMSG = 'The %s: %s, has bill form item(s) that have been paid for. You can''t update this visit to another bill!'
			raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo)
			return 1
	end
					
if  exists(select VisitNo from IPDItems
	inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
	inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
	where VisitNo = @VisitNo and PayStatusID Not in (@NAPayStatusID,@PayStatusID)) 
	begin	
		set @ErrorMSG = 'The %s: %s, has IPD item(s) that have been paid for. You can''t update this visit to another bill!'
			raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo)
			return 1
	end

if not (@ServiceCode is null or @ServiceCode = '') 
	begin
		if not exists(select ServiceCode from Services where ServiceCode  = @ServiceCode)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Service Code', @ServiceCode, 'Services')
				return 1
			end
	end

else if (@ServiceCode is null or @ServiceCode = '')
begin set @ServiceCode = null end	

				
if  exists(select VisitNo from ExtraBillItemsCASH
	inner join ExtraBills on ExtraBillItemsCASH.ExtraBillNo = ExtraBills.ExtraBillNo
	where VisitNo = @VisitNo) 
	begin	
		set @ErrorMSG = 'The %s: %s, has bill form Co-Pay item(s) that can''t be re-called. You can''t update this visit!'
			raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo)
			return 1
	end
	end
	---------------------------------------------------------------------------------------------------------------------		


begin
update Admissions set
VisitNo = @VisitNo,PatientNo=@PatientNo, StaffNo = @StaffNo, BedNo = @BedNo, AdmissionDateTime = @AdmissionDateTime, AdmissionNotes = @AdmissionNotes, 
AdmissionStatusID = @AdmissionStatusID,ChartNumber=@ChartNumber ,ProvisionalDiagnosis=@ProvisionalDiagnosis,
BillModesID = @BillModesID,ServiceCode=@ServiceCode, BillNo = @BillNo, InsuranceNo = @InsuranceNo, AssociatedBillNo = @AssociatedBillNo, MemberCardNo = @MemberCardNo, 
MainMemberName = @MainMemberName, ClaimReferenceNo = @ClaimReferenceNo,CoPayTypeID = @CoPayTypeID, CoPayPercent = @CoPayPercent, CoPayValue = @CoPayValue,
LoginID = @LoginID, ClientMachine = @ClientMachine,AccessCashServices=@AccessCashServices,SmartCardApplicable = @SmartCardApplicable
where AdmissionNo = @AdmissionNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateAdmissions '11000101', '110001001', '001', '15 May 2010', 'Admin Notes', '34I', 'Admin'

******************************************************************************************************/
-- select * from Admissions
-- delete from Admissions
-------------- Get Admissions -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAdmissions')
	drop proc uspGetAdmissions
go

create proc uspGetAdmissions(
@AdmissionNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AdmissionNo from Admissions where AdmissionNo = @AdmissionNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Admission No', @AdmissionNo, 'Admissions')
		return 1
	end
else
begin
	select AdmissionNo, Admissions.VisitNo, Patients.PatientNo, FirstName, LastName, Photo,
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, BirthDate, JoinDate, 
	dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,	dbo.GetAge(BirthDate, getdate()) as Age, 
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender,Admissions.ServiceCode, ServiceName,
	VisitStatusID, dbo.GetLookupDataDes(VisitStatusID) as VisitStatus,
	dbo.FormatMoney(dbo.GetCashAccountBalance(Patients.PatientNo)) as CashAccountBalance,
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor, Admissions.AccessCashServices,	
	dbo.GetTotalIPDDoctorRounds(AdmissionNo) as TotalIPDDoctorRounds, Admissions.MemberCardNo,
	Admissions.MainMemberName,Admissions.ProvisionalDiagnosis, 
	isnull(dbo.GetLastRoundDateTime(AdmissionNo), AdmissionDateTime) as LastRoundDateTime,	
	WardsID, dbo.GetLookupDataDes(WardsID) as Ward, Admissions.BedNo, BedName, Beds.RoomNo, 
	RoomName, UnitPrice, VisitCategoryID, dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, 
	Admissions.ServiceCode,ServiceName, Admissions.BillModesID, dbo.GetLookupDataDes(Admissions.BillModesID) as BillMode, Admissions.BillNo, 
	Admissions.CoPayTypeID, dbo.GetLookupDataDes(Admissions.CoPayTypeID) as CoPayType, Admissions.CoPayPercent, Admissions.CoPayValue,	
	Admissions.StaffNo, dbo.GetStaffFullName(Admissions.StaffNo) as StaffFullName, 
	dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, AdmissionDateTime, AdmissionNotes, 
	dbo.GetInsuranceName(Admissions.BillModesID, Admissions.InsuranceNo) as InsuranceName, Admissions.AssociatedBillNo,
	dbo.GetBillCustomerName(Admissions.AssociatedBillNo) as AssociatedBillCustomer, Admissions.SmartCardApplicable,Admissions.InsuranceNo,
	AdmissionStatusID, dbo.GetLookupDataDes(AdmissionStatusID) as AdmissionStatus,ChartNumber,dbo.GetCurrentPackage(PackageNo) as PackageName,
	Patients.ChronicDiseases as ChronicDiseases,dbo.GetHasPackage(Patients.PatientNo,PackageNo) as HasPackage,PackageNo,
	dbo.IsBillReconciled(Visits.VisitNo) as BillReconciled,Admissions.MainMemberName,Admissions.ClaimReferenceNo,
	dbo.GetBillCustomerFullName(Admissions.AssociatedBillNo) as AssociatedFullBillCustomer,
	Admissions.SmartCardApplicable,Admissions.AccessCashServices,
	NOKName, NOKPhone,dbo.GetLookupDataDes(TribeID) as Tribe,Patients.Address as [Address],
	dbo.GetLookupDataDes(ReligionID) as Religion, Patients.Phone as [Phone]
	from Admissions
	inner join Beds on Admissions.BedNo = Beds.BedNo
	inner join Rooms on Beds.RoomNo = Rooms.RoomNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo

	left outer join PackageVisits on Visits.VisitNo = PackageVisits.VisitNo	
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Services on Admissions.ServiceCode = Services.ServiceCode
	where AdmissionNo = @AdmissionNo
return 0
end
go

/******************************************************************************************************
exec uspGetAdmissions 'SR1800001001'
exec uspGetAdmissions '1012001'

******************************************************************************************************/
-- select * from Admissions order by RecordDateTime desc
-- delete from Admissions

--------GetInWardAdmissions----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInWardAdmissions')
	drop proc uspGetInWardAdmissions
go

create proc uspGetInWardAdmissions(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

declare @InWardAdmissionStatusID varchar(10)
set @InWardAdmissionStatusID = dbo.GetLookupDataID('AdmissionStatus', 'I')

begin
	select dbo.FormatText(Admissions.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
			dbo.FormatText(Admissions.AdmissionNo, 'Admissions', 'AdmissionNo') as AdmissionNo, 
			dbo.GetLookupDataDes(WardsID) as Ward, Admissions.BedNo, BedName, 
			Beds.RoomNo, RoomName, dbo.FormatDateTime(AdmissionDateTime) as AdmissionDateTime,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate
	from Admissions
	inner join Beds on Admissions.BedNo = Beds.BedNo
	inner join Rooms on Beds.RoomNo = Rooms.RoomNo
	--inner join Visits on Admissions.VisitNo = Visits.VisitNo	
	inner join Patients on Admissions.PatientNo = Patients.PatientNo
	where AdmissionStatusID = @InWardAdmissionStatusID 
	and dbo.GetPatientVisitDate(Admissions.VisitNo) between @StartDate and @EndDate
	order by dbo.GetPatientVisitDate(Admissions.VisitNo), AdmissionDateTime
end	
return 0
go

-- select * from Admissions
-- exec uspGetInWardAdmissions 'Apr 1, 2011', 'Apr 20, 2011'


-------------- Get Over Stayed Admissions -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetOverStayedAdmissions')
	drop proc uspGetOverStayedAdmissions
go

create proc uspGetOverStayedAdmissions(
@StartDate smalldatetime =null,
@EndDate smalldatetime =null
)with encryption as

declare @ErrorMSG varchar(200)
declare @AdmissionDays int
declare @AdmissionStatusID varchar(10)


---------------------------------------------------------------------------------------------------------------------
set @Admissiondays = isnull(dbo.GetOptionValue('AdmissionMaxDays'),0)
set @AdmissionStatusID =dbo.GetLookupDataID('AdmissionStatus', 'I')

---------------------------------------------------------------------------------------------------------------------
if (not (@StartDate is null) and not(@EndDate is null))
begin

select dbo.GetFullName(LastName,MiddleName,FirstName) as FullName,Phone,Admissions.VisitNo,AdmissionNo,AdmissionNotes,Beds.BedNo,
BedName,RoomName,
dbo.FormatDate(Visits.RecordDateTime) as VisitDate,dbo.FormatDate(Admissions.RecordDateTime) as AdmissionDate,AdmissionStatusID,
DATEDIFF(day,Admissions.RecordDateTime, GETDATE()) as DaysOnWard from 
Admissions
inner join Visits on Visits.VisitNo=Admissions.VisitNo
inner join Patients on Patients.PatientNo =Visits.PatientNo
inner join Beds on Beds.BedNo= Admissions.BedNo
inner join Rooms on Rooms.RoomNo = Beds.RoomNo 
where DATEDIFF(day,Admissions.RecordDateTime, GETDATE()) >= @AdmissionDays
and AdmissionStatusID=@AdmissionStatusID
and Admissions.RecordDateTime between @StartDate and @EndDate
Order by DATEDIFF(day,Admissions.RecordDateTime, GETDATE()) desc
end
else
begin
select dbo.GetFullName(LastName,MiddleName,FirstName) as FullName,Phone,Admissions.VisitNo,AdmissionNo,AdmissionNotes,Beds.BedNo,
BedName,RoomName,
dbo.FormatDate(Visits.RecordDateTime) as VisitDate,dbo.FormatDate(Admissions.RecordDateTime) as AdmissionDate,AdmissionStatusID,
DATEDIFF(day,Admissions.RecordDateTime, GETDATE()) as DaysOnWard from 
Admissions
inner join Visits on Visits.VisitNo=Admissions.VisitNo
inner join Patients on Patients.PatientNo =Visits.PatientNo
inner join Beds on Beds.BedNo= Admissions.BedNo
inner join Rooms on Rooms.RoomNo = Beds.RoomNo 
where DATEDIFF(day,Admissions.RecordDateTime, GETDATE()) >= @AdmissionDays
and AdmissionStatusID=@AdmissionStatusID
Order by DATEDIFF(day,Admissions.RecordDateTime, GETDATE()) desc
end
go

---------------------------------------------------------------------------------------------------------------------


------ exec uspGetOverStayedAdmissions '1 jan 2017 12:00 AM','31 dec 2017 11:59 PM'


--------GetcountOverStayedAdmission-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetcountOverStayedAdmission')
	drop proc uspGetcountOverStayedAdmission
go

create proc uspGetcountOverStayedAdmission
with encryption as
begin

declare @AdmissionDays int
declare @AdmissionStatusID varchar(10)


---------------------------------------------------------------------------------------------------------------------
set @Admissiondays = isnull(dbo.GetOptionValue('AdmissionMaxDays'),0)
set @AdmissionStatusID =dbo.GetLookupDataID('AdmissionStatus', 'I')
---------------------------------------------------------------------------------------------------------------------

select AdmissionNo from 
Admissions
inner join Visits on Visits.VisitNo=Admissions.VisitNo
inner join Patients on Patients.PatientNo =Visits.PatientNo
inner join Beds on Beds.BedNo= Admissions.BedNo
inner join Rooms on Rooms.RoomNo = Beds.RoomNo 
where DATEDIFF(day,Admissions.RecordDateTime, GETDATE()) >= @AdmissionDays
and AdmissionStatusID=@AdmissionStatusID
Order by DATEDIFF(day,Admissions.RecordDateTime, GETDATE()) desc
end
return 0
go

-- select * from Admissions
-- exec uspGetcountOverStayedAdmission


------ exec uspGetOverStayedAdmissions '1 jan 2017 12:00 AM','31 dec 2017 11:59 PM'

--------Get NextAdmissionID-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextAdmissionID')
	drop proc uspGetNextAdmissionID
go

create proc uspGetNextAdmissionID(
@VisitNo varchar(20),
@AdmissionID int = null output
)with encryption as

declare @VisitNoPaddingLEN tinyint

set @VisitNoPaddingLEN = (select PaddingLEN from AutoNumbers where ObjectName = 'Visits' and AutoColumnName = 'VisitNo')

set @AdmissionID = (select max(AdmissionID) from Admissions 
					where left(VisitNo,(len(VisitNo) - @VisitNoPaddingLEN)) = left(@VisitNo, (len(@VisitNo) - @VisitNoPaddingLEN)))
set @AdmissionID = dbo.GetNextAutoNumber('Admissions', 'AdmissionNo', @AdmissionID)

return 0

go

-- exec uspGetNextAdmissionID '100468001'
-- select * from Admissions

--------GetNextCustomAdmissionID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextCustomAdmissionID')
	drop proc uspGetNextCustomAdmissionID
go

create proc uspGetNextCustomAdmissionID(
@WardInitial as varchar(1),
@AdmissionID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CurrentYear as char(2)
declare @CurrentMonth as char(2)
declare @AdmissionNoPrefix as varchar(5)

set @CurrentYear = right(year(getdate()), 2)
set @CurrentMonth = month(getdate())

set @AdmissionNoPrefix = @WardInitial + @CurrentYear + dbo.PadLeft(@CurrentMonth, 2)

set @AdmissionID = (select max(AdmissionID) from Admissions where left(AdmissionNo, len(@AdmissionNoPrefix)) = @AdmissionNoPrefix)
set @AdmissionID = dbo.GetNextAutoNumber('Admissions', 'AdmissionNo', @AdmissionID)

return 0
go

-- exec uspGetNextCustomAdmissionID 'N'
-- exec uspGetNextCustomAdmissionID 'M'
-- exec uspGetNextCustomAdmissionID 'H'
-- select * from Admissions

--------Get AdmissionNo-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAdmissionNo')
	drop proc uspGetAdmissionNo
go

create proc uspGetAdmissionNo(
@PatientNo varchar(20),
@VisitDate smalldatetime = null output,
@AdmissionNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)

if (@VisitDate is null)
begin
	if not exists(select Admissions.PatientNo from Admissions inner join Visits on Admissions.VisitNo = Visits.VisitNo
													where Admissions.PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Patient No', @PatientNo, 'Admissions')	
		return 1
	end
	else
	begin
		set @AdmissionNo = (select top 1 AdmissionNo from Admissions inner join Visits on Admissions.VisitNo = Visits.VisitNo
							where Admissions.PatientNo = @PatientNo
							and VisitDate = (select max(VisitDate) from Admissions inner join Visits on Admissions.VisitNo = Visits.VisitNo
							where Admissions.PatientNo = @PatientNo)
							order by AdmissionID desc)
	end
end
else
if not (@VisitDate is null)
begin

if not exists(select Admissions.PatientNo from Admissions inner join Visits on Admissions.VisitNo = Visits.VisitNo
								where Admissions.PatientNo = @PatientNo and VisitDate = @VisitDate)
	begin
		set @ErrorMSG = '%s: %s and %s: ' + dbo.FormatDate(@VisitDate) + ', you are trying to enter does not exist %s'
		raiserror(@ErrorMSG,16,1, 'The record with Patient No', @PatientNo, 'Visit Date', 'in the registered Admissions')	
		return 1		
	end
	else
	begin
		set @AdmissionNo = (select top 1 AdmissionNo from Admissions inner join Visits on Admissions.VisitNo = Visits.VisitNo
								where Admissions.PatientNo = @PatientNo and VisitDate = @VisitDate order by AdmissionID desc)
	end
end

return 0

go

-- select * from patients
-- exec uspGetAdmissionNo '07022061'
-- exec uspGetAdmissionNo '07022061', '23 Jan 2007'

-------- Get WardInitial -------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetWardInitial')
	drop proc uspGetWardInitial
go

create proc uspGetWardInitial(
@WardName varchar(100),
@WardInitial varchar(1) = null output
)with encryption as

begin set @WardInitial = dbo.GetWardInitial(@WardName) end

return 0

go

--------------------------------------------------------------------------------------------------------------------
-- exec uspGetWardInitial 'Labour Ward'
-- exec uspGetWardInitial 'Nursery'
-- exec uspGetWardInitial 'Children''s Ward'
-- exec uspGetWardInitial null
--------------------------------------------------------------------------------------------------------------------
	
if exists (select * from sysobjects where name = 'uspGetAdmissionsDetails')
drop proc uspGetAdmissionsDetails
go

create proc uspGetAdmissionsDetails(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
begin
set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered visits'
raiserror(@ErrorMSG,16,1)	
return 1
end
else
begin

if exists(select AdmissionNo from Admissions where Admissions.VisitNo = @VisitNo)
begin
select AdmissionNo, Admissions.VisitNo, Patients.PatientNo, FirstName, LastName, Photo,
dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, BirthDate, JoinDate, 
dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,	dbo.GetAge(BirthDate, getdate()) as Age, 
GenderID, dbo.GetLookupDataDes(GenderID) as Gender,Visits.VisitDate, ReferenceNo,
Patients.Phone as [Phone], isnull(dbo.GetLastVisitDate(Patients.PatientNo),JoinDate) as LastVisitDate,
dbo.GetTotalVisits(Patients.PatientNo) as TotalVisits, ReferredBy, FingerprintVerified,
dbo.FormatMoney(dbo.GetCashAccountBalance(Patients.PatientNo)) as CashAccountBalance,
VisitStatusID, dbo.GetLookupDataDes(VisitStatusID) as VisitStatus, ServiceName,
dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor, Admissions.AccessCashServices,	
dbo.GetTotalIPDDoctorRounds(AdmissionNo) as TotalIPDDoctorRounds, Admissions.MemberCardNo,
Admissions.MainMemberName, 
isnull(dbo.GetLastRoundDateTime(AdmissionNo), AdmissionDateTime) as LastRoundDateTime,	
WardsID, dbo.GetLookupDataDes(WardsID) as Ward, Admissions.BedNo, BedName, Beds.RoomNo, 
RoomName, UnitPrice, VisitCategoryID, dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, 
Visits.ServiceCode, Admissions.BillModesID, dbo.GetLookupDataDes(Admissions.BillModesID) as BillMode, Admissions.BillNo, 
Admissions.CoPayTypeID, dbo.GetLookupDataDes(Admissions.CoPayTypeID) as CoPayType, Admissions.CoPayPercent, Admissions.CoPayValue,	

Visits.BillModesID as OPDBillModesID, dbo.GetLookupDataDes(Visits.BillModesID) as OPDBillMode, Visits.BillNo as OPDBillNo, 
Visits.CoPayTypeID as OPDCoPayTypeID, dbo.GetLookupDataDes(Visits.CoPayTypeID) as OPDCoPayType,  Visits.CoPayPercent as OPDCoPayPercent, Visits.CoPayValue as OPDCopayValue,

Admissions.StaffNo, dbo.GetStaffFullName(Admissions.StaffNo) as StaffFullName, 
dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, AdmissionDateTime, AdmissionNotes, 
dbo.GetInsuranceName(Admissions.BillModesID, Admissions.InsuranceNo) as InsuranceName, Admissions.AssociatedBillNo,
dbo.GetBillCustomerName(Admissions.AssociatedBillNo) as AssociatedBillCustomer, Admissions.SmartCardApplicable,Admissions.InsuranceNo,
AdmissionStatusID, dbo.GetLookupDataDes(AdmissionStatusID) as AdmissionStatus,ChartNumber,dbo.GetCurrentPackage(PackageVisits.PackageNo) as PackageName,
Patients.ChronicDiseases as ChronicDiseases,dbo.GetHasPackage(Patients.PatientNo,PackageVisits.PackageNo) as HasPackage,PackageVisits.PackageNo,
dbo.IsBillReconciled(Visits.VisitNo) as BillReconciled,Admissions.MainMemberName,Admissions.ClaimReferenceNo,
dbo.GetBillCustomerFullName(Admissions.AssociatedBillNo) as AssociatedFullBillCustomer,
dbo.GetHasPackage(Patients.PatientNo,PackageVisits.PackageNo) as IPDHasPackage,
dbo.FormatMoney(dbo.GetOutstandingBalance(Patients.PatientNo)) as OutstandingBalance,
dbo.FormatMoney(dbo.GetCashAccountBalance(Patients.PatientNo)) as CashAccountBalance,
Admissions.MemberCardNo,Admissions.ClaimReferenceNo
from Visits
inner join Admissions on Admissions.VisitNo = Visits.VisitNo
left outer join Beds on Admissions.BedNo = Beds.BedNo
left outer join Rooms on Beds.RoomNo = Rooms.RoomNo
inner join Patients on Visits.PatientNo = Patients.PatientNo
left outer join Services on Visits.ServiceCode = Services.ServiceCode
left outer join PackageVisits on PackageVisits.VisitNo = Visits.VisitNo
where Visits.VisitNo = @VisitNo


end

else if not exists(select AdmissionNo from Admissions where Admissions.VisitNo = @VisitNo)
begin

select Visits.VisitNo, Patients.PatientNo, FirstName, LastName, Photo,
dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, BirthDate, JoinDate, 
dbo.FormatDate(dbo.GetPatientVisitDate(Visits.VisitNo)) as VisitDate,	dbo.GetAge(BirthDate, getdate()) as Age, 
GenderID, dbo.GetLookupDataDes(GenderID) as Gender,Visits.VisitDate, ReferenceNo,
Patients.Phone as [Phone], isnull(dbo.GetLastVisitDate(Patients.PatientNo),JoinDate) as LastVisitDate,
dbo.GetTotalVisits(Patients.PatientNo) as TotalVisits, ReferredBy, FingerprintVerified,

dbo.FormatMoney(dbo.GetCashAccountBalance(Patients.PatientNo)) as CashAccountBalance,
VisitStatusID, dbo.GetLookupDataDes(VisitStatusID) as VisitStatus, ServiceName,
dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
VisitCategoryID, dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, 

Visits.ServiceCode, Visits.BillModesID, dbo.GetLookupDataDes(Visits.BillModesID) as BillMode, Visits.BillNo, 
Visits.CoPayTypeID, dbo.GetLookupDataDes(Visits.CoPayTypeID) as CoPayType, Visits.CoPayPercent, Visits.CoPayValue,	

dbo.GetBillCustomerName(AssociatedBillNo) as AssociatedBillCustomer,SmartCardApplicable,InsuranceNo
,dbo.GetCurrentPackage(PackageVisits.PackageNo) as PackageName,
Patients.ChronicDiseases as ChronicDiseases,dbo.GetHasPackage(Patients.PatientNo,PackageVisits.PackageNo) as HasPackage,PackageVisits.PackageNo,
dbo.IsBillReconciled(Visits.VisitNo) as BillReconciled,
dbo.FormatMoney(dbo.GetOutstandingBalance(Patients.PatientNo)) as OutstandingBalance,
dbo.FormatMoney(dbo.GetCashAccountBalance(Patients.PatientNo)) as CashAccountBalance,
dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName,
AssociatedBillNo, dbo.GetBillCustomerName(AssociatedBillNo) as AssociatedBillCustomer,
'' as AdmissionNo,MemberCardNo,MainMemberName,
Visits.BillModesID as OPDBillModesID, dbo.GetLookupDataDes(Visits.BillModesID) as OPDBillMode, Visits.BillNo as OPDBillNo,ClaimReferenceNo
from Visits
inner join Patients on Visits.PatientNo = Patients.PatientNo
left outer join Services on Visits.ServiceCode = Services.ServiceCode
left outer join PackageVisits on PackageVisits.VisitNo = Visits.VisitNo
where Visits.VisitNo = @VisitNo
end

end
return 0
go

/******************************************************************************************************
select * from Visits
exec uspGetAdmissionsDetails 'ZAIN312/06011'
exec uspGetAdmissionsDetails '10605001'

******************************************************************************************************/


------------------------------------------------------------------------------------------------------
-------------- IPDDoctor -----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert IPDDoctor ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertIPDDoctor')
	drop proc uspInsertIPDDoctor
go

create proc uspInsertIPDDoctor(
@RoundNo varchar(20),
@AdmissionNo varchar(20),
@StaffNo varchar(10),
@RoundDateTime smalldatetime,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @RoundID int

declare @PaddingLEN tinyint

declare @PassedRoundID int
declare @PassedRoundNo varchar(20)
declare @PassedAdmissionNo varchar(20)

if exists(select RoundNo from IPDDoctor where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo)
		return 1
	end

if not exists(select AdmissionNo from Admissions where AdmissionNo  = @AdmissionNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Admission No', @AdmissionNo, 'Admissions')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

----------------------------------------------------------------------------------------------------------

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'IPDDoctor' and AutoColumnName = 'RoundNo'

set @PassedAdmissionNo = ltrim(rtrim(substring(@RoundNo, 1, len(@RoundNo) - @PaddingLEN)))

if (@PassedAdmissionNo = @AdmissionNo)

begin

	set @PassedRoundID = 1
	set @PassedRoundNo = @RoundNo

	set @PassedRoundNo = ltrim(rtrim(substring(@PassedRoundNo, len(@PassedAdmissionNo) + 1, @PaddingLEN)))

	if isnumeric(@PassedRoundNo) = 1 set @PassedRoundID = @PassedRoundNo
	else set @PassedRoundID = 1

	set @RoundID = (select max(RoundID) from IPDDoctor where AdmissionNo = @AdmissionNo)
	set @RoundID = dbo.GetNextAutoNumber('IPDDoctor', 'RoundNo', @RoundID)

	if @PassedRoundID < @RoundID set @RoundID = @PassedRoundID
	if @PassedRoundID > @RoundID set @RoundID = @PassedRoundID

end else set @RoundID = 1

----------------------------------------------------------------------------------------------------------

insert into IPDDoctor
(RoundID, RoundNo, AdmissionNo, StaffNo, RoundDateTime, LoginID,ClientMachine)
values
(@RoundID, @RoundNo, @AdmissionNo, @StaffNo, @RoundDateTime, @LoginID,@ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertIPDDoctor '11022650101', '110226501', '305', '14 Feb 2011', 'Notes', 'Admin'
exec uspInsertIPDDoctor '11022650121', '110226501', '305', '14 Feb 2011', 'Notes', 'Admin'
exec uspInsertIPDDoctor '11022650103', '110226501', '305', '14 Feb 2011', 'Notes', 'Admin'
exec uspInsertIPDDoctor '11022650101', '110226501', '305', '14 Feb 2011', 'Notes', 'Admin'

******************************************************************************************************/
-- select * from IPDDoctor
-- delete from IPDDoctor

-------------- Update IPDDoctor ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDDoctor')
	drop proc uspUpdateIPDDoctor
go

create proc uspUpdateIPDDoctor(
@RoundNo varchar(20),
@AdmissionNo varchar(20),
@StaffNo varchar(10),
@RoundDateTime smalldatetime,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDDoctor where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPDDoctor')
		return 1
	end

if not exists(select AdmissionNo from Admissions where AdmissionNo  = @AdmissionNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Admission No', @AdmissionNo, 'Admissions')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update IPDDoctor set
--AdmissionNo = @AdmissionNo, 
StaffNo = @StaffNo, RoundDateTime = @RoundDateTime, LoginID = @LoginID,ClientMachine=@ClientMachine
where RoundNo = @RoundNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDDoctor '11022650101', '110226501', '100', '12 Feb 2011', 'Notes1', 'Admin'

******************************************************************************************************/
-- select * from IPDDoctor
-- delete from IPDDoctor


-------------- GetIPDDoctor ------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDDoctor')
	drop proc uspGetIPDDoctor
go

create proc uspGetIPDDoctor(
@RoundNo varchar(20)= null,
@AdmissionNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@RoundNo is null) and (@AdmissionNo is null))
begin
	if not exists(select RoundNo from IPDDoctor where RoundNo = @RoundNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPD Doctor')
			return 1
		end
	else
	begin
		select RoundNo, IPDDoctor.AdmissionNo, IPDDoctor.StaffNo, 
		dbo.GetStaffFullName(IPDDoctor.StaffNo) as StaffFullName, 
		RoundDateTime, Admissions.VisitNo, Patients.PatientNo, FirstName, LastName, Photo,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, BirthDate, JoinDate, 
		dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,	dbo.GetAge(BirthDate, getdate()) as Age, 
		GenderID, dbo.GetLookupDataDes(GenderID) as Gender, Admissions.BillModesID, Admissions.AccessCashServices,
		dbo.GetLookupDataDes(Admissions.CoPayTypeID) as CoPayType, Admissions.CoPayPercent, Admissions.CoPayValue,
		dbo.GetLookupDataDes(Admissions.BillModesID) as BillMode, Admissions.BillNo, Admissions.AssociatedBillNo,
		dbo.GetBillCustomerName(Admissions.AssociatedBillNo) as AssociatedBillCustomer,
		dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
		dbo.GetInsuranceName(Admissions.BillModesID, Admissions.InsuranceNo) as InsuranceName, 
		VisitCategoryID, dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, 
		VisitStatusID, dbo.GetLookupDataDes(VisitStatusID) as VisitStatus,
		dbo.GetProvisionalIPDDiagnosis(RoundNo) as ProvisionalIPDDiagnosis, 
		dbo.GetTotalIPDCardiologyRequests(RoundNo) as TotalIPDCardiologyRequests,
		 
		dbo.GetTotalIPDRadiologyRequests(RoundNo) as TotalIPDRadiologyRequests,
		dbo.GetTotalIPDPathologyRequests(RoundNo) as TotalIPDPathologyRequests,
		dbo.GetTotalIPDDentalRequests(RoundNo) as TotalIPDDentalRequests,
		dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor,
		dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact, AdmissionDateTime, 
		AdmissionStatusID, dbo.GetLookupDataDes(AdmissionStatusID) as AdmissionStatus,
		dbo.GetCurrentPackage(PackageNo) as PackageName,dbo.GetHasPackage(Patients.PatientNo,PackageNo) as HasPackage,PackageNo
		from IPDDoctor
		inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
		inner join Visits on Admissions.VisitNo = Visits.VisitNo
		left outer join PackageVisits on Visits.VisitNo = PackageVisits.VisitNo	
		inner join Patients on Visits.PatientNo = Patients.PatientNo
		where RoundNo = @RoundNo
	end
end
else
if ((@RoundNo is null) and not (@AdmissionNo is null))
begin
		select RoundNo, AdmissionNo, RoundDateTime
		from IPDDoctor
		where AdmissionNo = @AdmissionNo
		order by RoundNo desc
end
else
if  ((@RoundNo is null) and (@AdmissionNo is null))
begin
		select RoundNo, IPDDoctor.AdmissionNo, IPDDoctor.StaffNo, 
		dbo.GetStaffFullName(IPDDoctor.StaffNo) as StaffFullName, 
		RoundDateTime, Admissions.VisitNo, Patients.PatientNo, FirstName, LastName, Photo,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, BirthDate, JoinDate, 
		dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,	dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetLookupDataDes(Admissions.CoPayTypeID) as CoPayType, Admissions.CoPayPercent, Admissions.CoPayValue,
		GenderID, dbo.GetLookupDataDes(GenderID) as Gender, Admissions.BillModesID, Admissions.AccessCashServices, 
		dbo.GetLookupDataDes(Admissions.BillModesID) as BillMode, Admissions.BillNo, Admissions.AssociatedBillNo,
		dbo.GetBillCustomerName(Admissions.AssociatedBillNo) as AssociatedBillCustomer,
		dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
		dbo.GetInsuranceName(Admissions.BillModesID, Admissions.InsuranceNo) as InsuranceName, 
		VisitCategoryID, dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, 
		VisitStatusID, dbo.GetLookupDataDes(VisitStatusID) as VisitStatus, 
		dbo.GetTotalIPDCardiologyRequests(RoundNo) as TotalIPDCardiologyRequests,
		dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact,
		dbo.GetTotalIPDRadiologyRequests(RoundNo) as TotalIPDRadiologyRequests,
		dbo.GetTotalIPDPathologyRequests(RoundNo) as TotalIPDPathologyRequests,
		dbo.GetTotalIPDDentalRequests(RoundNo) as TotalIPDDentalRequests,
		dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor, AdmissionDateTime, 
		AdmissionStatusID, dbo.GetLookupDataDes(AdmissionStatusID) as AdmissionStatus,
		dbo.GetCurrentPackage(PackageNo) as PackageName,dbo.GetHasPackage(Patients.PatientNo,PackageNo) as HasPackage,PackageNo
		from IPDDoctor
		inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
		inner join Visits on Admissions.VisitNo = Visits.VisitNo
		left outer join PackageVisits on Visits.VisitNo = PackageVisits.VisitNo	
		inner join Patients on Visits.PatientNo = Patients.PatientNo
end

return 0

go

/******************************************************************************************************
exec uspGetIPDDoctor 'SR1800000301002'
exec uspGetIPDDoctor null, '110327502'
exec uspGetIPDDoctor 

******************************************************************************************************/
-- select * from IPDDoctor
-- delete from IPDDoctor


--------GetIPDDoctorByAdmissionNo------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDDoctorByAdmissionNo')
	drop proc uspGetIPDDoctorByAdmissionNo
go

create proc uspGetIPDDoctorByAdmissionNo(
@AdmissionNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AdmissionNo from IPDDoctor where AdmissionNo = @AdmissionNo)
begin
	set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
	raiserror(@ErrorMSG,16,1, 'Admission No', @AdmissionNo, 'IPD Doctor')	
	return 1
end
else
begin
	select RoundDateTime, RoundNo from IPDDoctor
	where AdmissionNo = @AdmissionNo order by RoundDateTime, RoundID, RoundNo
end
return 0
go

-- select * from IPDDoctor
-- exec uspGetIPDDoctorByAdmissionNo '110183801'

--------GetIPDDoctorRounds----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDDoctorRounds')
	drop proc uspGetIPDDoctorRounds
go

create proc uspGetIPDDoctorRounds(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

begin
--------------------------------------------------------------------------------------------
	set @EndDate = dbo.GetShortDate(dateadd(day, 1, @EndDate))
--------------------------------------------------------------------------------------------

	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
		dbo.FormatText(IPDDoctor.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
		dbo.FormatDateTime(RoundDateTime) as RoundDateTime,
		dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
		dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor,
		dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact,
		dbo.GetCurrentPackage(PackageNo) as PackageName,
        dbo.GetHasPackage(Patients.PatientNo,PackageNo) as HasPackage,PackageNo
	from IPDDoctor
	inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo	
	left outer join PackageVisits on Visits.VisitNo = PackageVisits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	and RoundDateTime between @StartDate and @EndDate
	order by RoundDateTime
end	
return 0
go

-- select * from IPDDoctor
-- exec uspGetIPDDoctorRounds 'FEB 1, 2019', 'May 20, 2019'

--------Count IPDDoctor -------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountIPDDoctor')
	drop proc uspCountIPDDoctor
go

create proc uspCountIPDDoctor(
@RoundNo varchar(20),
@NoIPDDoctor tinyint = null output
)with encryption as

set @NoIPDDoctor = (select  count(RoundNo) from IPDDoctor where RoundNo = @RoundNo)
set @NoIPDDoctor = isnull(@NoIPDDoctor,0)

return 0

go

-- exec uspCountIPDDoctor '110001001'

--------GetNextRoundID -----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextRoundID')
	drop proc uspGetNextRoundID
go

create proc uspGetNextRoundID(
@AdmissionNo varchar(20),
@RoundID int = null output
)with encryption as

set @RoundID = (select max(RoundID) from IPDDoctor where AdmissionNo = @AdmissionNo)
set @RoundID = dbo.GetNextAutoNumber('IPDDoctor', 'RoundNo', @RoundID)

print @RoundID
return 0

go

-- exec uspGetNextRoundID '110226501'
-- select * from IPDDoctor where AdmissionNo = '08022077'

--------GetRoundNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRoundNo')
	drop proc uspGetRoundNo
go

create proc uspGetRoundNo(
@AdmissionNo varchar(20),
@RoundDateTime smalldatetime = null output,
@RoundNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)

if (@RoundDateTime is null)
begin
	if not exists(select AdmissionNo from IPDDoctor where AdmissionNo = @AdmissionNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Admission No', @AdmissionNo, 'IPD Doctor')	
		return 1
	end
	else
	begin
		set @RoundNo = (select top 1 RoundNo from IPDDoctor where AdmissionNo = @AdmissionNo
						and RoundDateTime = (select max(RoundDateTime) from IPDDoctor where AdmissionNo = @AdmissionNo)
						order by RoundID desc)
	end
end
else
if not (@RoundDateTime is null)
begin

if not exists(select AdmissionNo from IPDDoctor where AdmissionNo = @AdmissionNo and RoundDateTime = @RoundDateTime)
	begin
		set @ErrorMSG = '%s: %s and %s: ' + dbo.FormatDateTime(@RoundDateTime) + ', you are trying to enter does not exist %s'
		raiserror(@ErrorMSG,16,1, 'The record with Admission No', @AdmissionNo, 'Round Date Time', 'in the registered IPDDoctor')	
		return 1		
	end
	else
	begin
		set @RoundNo = (select top 1 RoundNo from IPDDoctor where AdmissionNo = @AdmissionNo
						and RoundDateTime = @RoundDateTime order by RoundID desc)
	end
end

return 0

go

-- select * from Admissions
-- select * from IPDDoctor
-- exec  uspGetRoundNo '110226501'
-- exec uspGetRoundNo '110226501', '22 Feb 2011 09:53:00'

------------------------------------------------------------------------------------------------------
-------------- IPDClinicalFindings -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit IPDClinicalFindings --------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditIPDClinicalFindings')
	drop proc uspEditIPDClinicalFindings
go

create proc uspEditIPDClinicalFindings(
@RoundNo varchar(20),
@Weight decimal(5,2),
@Temperature decimal(5,2),
@Height decimal(5,2),
@Pulse tinyint,
@BloodPressure varchar(10),
@HeadCircum decimal(5,2),
@BodySurfaceArea decimal(10,2),
@History varchar(100),
@ClinicalNotes varchar(4000),
@Respiratory varchar(100),
@GeneralAppearance varchar(100),
@CVS varchar(100),
@Abdomen varchar(100),
@CNS varchar(100),
@MuscularSkeletal varchar(100),
@PsychologicalStatus varchar(100),
@ClinicalDiagnosis varchar(100),
@ClinicalImage image = null,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDDoctor where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPD Doctor')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

-----------------------------------------------------------------------------------
if @Weight < 0 set @Weight = null
if @Temperature < 0 set @Temperature = null
if @Height < 0 set @Height = null
if @Pulse <= 0 set @Pulse = null
if @HeadCircum < 0 set @HeadCircum = null
if @BodySurfaceArea < 0 set @BodySurfaceArea = null
-----------------------------------------------------------------------------------

if exists(select RoundNo from IPDClinicalFindings where RoundNo = @RoundNo)
	begin
		update IPDClinicalFindings set
		Weight = @Weight, Temperature = @Temperature, Height = @Height, Pulse = @Pulse, 
		BloodPressure = @BloodPressure, HeadCircum = @HeadCircum, BodySurfaceArea = @BodySurfaceArea, 
		History = @History, ClinicalNotes = @ClinicalNotes, Respiratory = @Respiratory, 
		GeneralAppearance = @GeneralAppearance, CVS = @CVS, Abdomen = @Abdomen, CNS = @CNS, 
		MuscularSkeletal = @MuscularSkeletal, PsychologicalStatus = @PsychologicalStatus, 
		ClinicalDiagnosis = @ClinicalDiagnosis, ClinicalImage = @ClinicalImage, LoginID = @LoginID
		where RoundNo = @RoundNo
		return 0
	end
else
begin
insert into IPDClinicalFindings
(RoundNo, Weight, Temperature, Height, Pulse, BloodPressure, HeadCircum, BodySurfaceArea, 
History, ClinicalNotes, Respiratory, GeneralAppearance, CVS, Abdomen, CNS, 
MuscularSkeletal, PsychologicalStatus, ClinicalDiagnosis, ClinicalImage, LoginID)
values
(@RoundNo, @Weight, @Temperature, @Height, @Pulse, @BloodPressure, @HeadCircum, @BodySurfaceArea, 
@History, @ClinicalNotes, @Respiratory, @GeneralAppearance, @CVS, @Abdomen, @CNS, 
@MuscularSkeletal, @PsychologicalStatus, @ClinicalDiagnosis, @ClinicalImage, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspEditIPDClinicalFindings '11018380101', 78, 39.02, 89.36, 75.56, '78/95', 80, null, 
								'History1', 'Notes', 'Respiratory', 'General Appearance1', 'CVS1', 
								'Abdomen1','CNS1','Muscular Skeletal1', 'Psychological Status1',
								'Clinical Diagnosis1', null, 'Admin'

******************************************************************************************************/
-- select * from IPDClinicalFindings
-- delete from IPDClinicalFindings

-------------- Get IPDClinicalFindings --------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDClinicalFindings')
	drop proc uspGetIPDClinicalFindings
go

create proc uspGetIPDClinicalFindings(
@RoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select RoundNo, Weight, Temperature, Height, Pulse, BloodPressure, HeadCircum, 
	BodySurfaceArea, History, ClinicalNotes, Respiratory, GeneralAppearance, CVS, Abdomen, 
	CNS, MuscularSkeletal, PsychologicalStatus, ClinicalDiagnosis, ClinicalImage
	from IPDClinicalFindings where RoundNo = @RoundNo
return 0
end
go

/******************************************************************************************************
exec uspGetIPDClinicalFindings '1'

******************************************************************************************************/
-- select * from IPDClinicalFindings
-- delete from IPDClinicalFindings

------------------------------------------------------------------------------------------------------
-------------- IPDEyeAssessment -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditIPDEyeAssessment')
	drop proc uspEditIPDEyeAssessment
go
create proc uspEditIPDEyeAssessment(
@RoundNo varchar(20),
@LeftPupil varchar(200),
@RightPupil varchar(200),
@LeftLidMargin varchar(200),
@RightLidMargin varchar(200),
@LeftConjuctiva varchar(200),
@RightConjuctiva varchar(200),
@LeftBulbarConjuctiva varchar(200),
@RightBulbarConjuctiva varchar(200),
@LeftCentralCornea varchar(200),
@RightCentralCornea varchar(200),
@LeftVerticalCornea varchar(200),
@RightVerticalCornea varchar(200),
@LeftAnteriorChamber varchar(200),
@RightAnteriorChamber varchar(200),
@LeftIrish varchar(200),
@RightIrish varchar(200),
@LeftAnteriorChamberAngle varchar(200),
@RightAnteriorChamberAngle varchar(200),
@LeftRetina varchar(200),
@RightRetina varchar(200),
@LeftMacular varchar(200),
@RightMacular varchar(200),
@LeftOpticDisc varchar(200),
@RightOpticDisc varchar(200),
@LeftIOP varchar(10),
@RightIOP varchar(10),
@LeftVitreous varchar(200),
@RightVitreous varchar(200),
@LeftLense varchar(200),
@RightLense varchar(200),
@EyeNotes varchar(200),
@LeftEyeBall varchar(200),
@RightEyeBall varchar(200),
@LeftOrbit varchar(200),
@RightOrbit varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDDoctor where RoundNo  = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPD Doctor')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
	
------------------------------------------------------------------------------------
if exists(select RoundNo from IPDEyeAssessment where RoundNo = @RoundNo)
begin
update IPDEyeAssessment set
 LeftPupil = @LeftPupil, RightPupil = @RightPupil, LeftLidMargin = @LeftLidMargin,
 RightLidMargin = @RightLidMargin, LeftConjuctiva = @LeftConjuctiva, RightConjuctiva = @RightConjuctiva, 
 LeftBulbarConjuctiva = @LeftBulbarConjuctiva, RightBulbarConjuctiva = @RightBulbarConjuctiva, 
 LeftCentralCornea = @LeftCentralCornea, RightCentralCornea = @RightCentralCornea, 
 LeftVerticalCornea = @LeftVerticalCornea, RightVerticalCornea = @RightVerticalCornea, 
 LeftAnteriorChamber = @LeftAnteriorChamber, RightAnteriorChamber = @RightAnteriorChamber, 
 LeftIrish = @LeftIrish, RightIrish = @RightIrish, LeftAnteriorChamberAngle = @LeftAnteriorChamberAngle,
 RightAnteriorChamberAngle = @RightAnteriorChamberAngle, LeftRetina = @LeftRetina, RightRetina = @RightRetina,
 LeftMacular = @LeftMacular, RightMacular = @RightMacular, LeftOpticDisc = @LeftOpticDisc, 
 RightOpticDisc = @RightOpticDisc, LeftIOP = @LeftIOP, RightIOP = @RightIOP, LeftVitreous = @LeftVitreous,
 RightVitreous = @RightVitreous, LeftLense = @LeftLense, RightLense = @RightLense, EyeNotes = @EyeNotes,
 LeftEyeBall = @LeftEyeBall, RightEyeBall = @RightEyeBall, LeftOrbit = @LeftOrbit, 
 RightOrbit = @RightOrbit, LoginID = @LoginID
where RoundNo = @RoundNo
return 0
end
else
begin
insert into IPDEyeAssessment
(RoundNo, LeftPupil, RightPupil, LeftLidMargin, RightLidMargin, LeftConjuctiva, RightConjuctiva, 
 LeftBulbarConjuctiva, RightBulbarConjuctiva, LeftCentralCornea, RightCentralCornea, LeftVerticalCornea, 
 RightVerticalCornea, LeftAnteriorChamber, RightAnteriorChamber, LeftIrish, RightIrish, 
 LeftAnteriorChamberAngle, RightAnteriorChamberAngle, LeftRetina, RightRetina, LeftMacular,
 RightMacular, LeftOpticDisc, RightOpticDisc, LeftIOP, RightIOP, LeftVitreous, RightVitreous, 
 LeftLense, RightLense, EyeNotes, LeftEyeBall, RightEyeBall, LeftOrbit, RightOrbit, LoginID)
values
(@RoundNo, @LeftPupil, @RightPupil, @LeftLidMargin, @RightLidMargin, @LeftConjuctiva,
 @RightConjuctiva, @LeftBulbarConjuctiva, @RightBulbarConjuctiva, @LeftCentralCornea, @RightCentralCornea,
 @LeftVerticalCornea, @RightVerticalCornea, @LeftAnteriorChamber, @RightAnteriorChamber, @LeftIrish, @RightIrish,
 @LeftAnteriorChamberAngle, @RightAnteriorChamberAngle, @LeftRetina, @RightRetina, @LeftMacular, @RightMacular,
 @LeftOpticDisc, @RightOpticDisc, @LeftIOP, @RightIOP, @LeftVitreous, @RightVitreous, @LeftLense, @RightLense, 
 @EyeNotes, @LeftEyeBall, @RightEyeBall, @LeftOrbit, @RightOrbit, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDEyeAssessment
******************************************************************************************************/
-- select * from IPDEyeAssessment
-- delete from IPDEyeAssessment


-------------- Get IPDEyeAssessment -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDEyeAssessment')
	drop proc uspGetIPDEyeAssessment
go

create proc uspGetIPDEyeAssessment(
@RoundNo varchar(20)
)with encryption as
declare @ErrorMSG varchar(200)
begin
	select RoundNo, LeftPupil, RightPupil, LeftLidMargin, RightLidMargin, LeftConjuctiva, RightConjuctiva, 
	LeftBulbarConjuctiva, RightBulbarConjuctiva, LeftCentralCornea, RightCentralCornea, LeftVerticalCornea, 
	RightVerticalCornea, LeftAnteriorChamber, RightAnteriorChamber, LeftIrish, RightIrish, LeftAnteriorChamberAngle,
	 RightAnteriorChamberAngle, LeftRetina, RightRetina, LeftMacular, RightMacular, LeftOpticDisc, RightOpticDisc, 
	 LeftIOP, RightIOP, LeftVitreous, RightVitreous, LeftLense, RightLense, EyeNotes, LeftEyeBall, RightEyeBall,
	  ClientMachine, RecordDateTime, LeftOrbit, RightOrbit, IPDEyeAssessment.LoginID
	from IPDEyeAssessment

	where RoundNo = @RoundNo
return 0
end
go

/******************************************************************************************************
exec uspGetIPDEyeAssessment
******************************************************************************************************/
-- select * from IPDEyeAssessment
-- delete from IPDEyeAssessment
------------------------------------------------------------------------------------------------------
-------------- IPDOrthoptics --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert IPDOrthoptics -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditIPDOrthoptics')
	drop proc uspEditIPDOrthoptics
go

create proc uspEditIPDOrthoptics(
@RoundNo varchar(20),
@HeadPosture varchar(200),
@Fixation varchar(200),
@LeftHirschberg varchar(200),
@RightHirschberg varchar(200),
@RightEOM varchar(200),
@LeftEOM varchar(200),
@CoverTestID varchar(10),
@LeftAPCTGlasses varchar(200),
@RightAPCTGlasses varchar(200),
@LeftAPCTWithOutGlasses varchar(200),
@RightAPCTWithOutGlasses varchar(200),
@Correspondence varchar(200),
@PrismAdaptation varchar(200),
@FusionConvergence varchar(200),
@FusionDivergence varchar(200),
@FusionRange varchar(200),
@NearPointOfAccommodation varchar(200),
@NearPointOfConvergence varchar(200),
@OrthopticsNotes varchar(400),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDDoctor where RoundNo  = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'RoundNo', @RoundNo, 'IPDDoctor')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CoverTestID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CoverTestID', @CoverTestID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
------------------------------------------------------------------------------------

if exists(select RoundNo from IPDOrthoptics where RoundNo = @RoundNo)
begin
update IPDOrthoptics set
HeadPosture = @HeadPosture, Fixation = @Fixation, LeftHirschberg = @LeftHirschberg, 
RightHirschberg = @RightHirschberg, RightEOM = @RightEOM, LeftEOM = @LeftEOM, CoverTestID = @CoverTestID,
LeftAPCTGlasses = @LeftAPCTGlasses, RightAPCTGlasses = @RightAPCTGlasses,
LeftAPCTWithOutGlasses = @LeftAPCTWithOutGlasses, RightAPCTWithOutGlasses = @RightAPCTWithOutGlasses,
Correspondence = @Correspondence, PrismAdaptation = @PrismAdaptation, FusionConvergence = @FusionConvergence,
FusionDivergence = @FusionDivergence, FusionRange = @FusionRange,
NearPointOfAccommodation = @NearPointOfAccommodation, NearPointOfConvergence = @NearPointOfConvergence,
OrthopticsNotes = @OrthopticsNotes, LoginID = @LoginID
where RoundNo = @RoundNo
return 0
end
else
begin
insert into IPDOrthoptics
(RoundNo, HeadPosture, Fixation, LeftHirschberg, RightHirschberg, RightEOM, LeftEOM, CoverTestID, 
LeftAPCTGlasses, RightAPCTGlasses, LeftAPCTWithOutGlasses, RightAPCTWithOutGlasses, Correspondence,
PrismAdaptation, FusionConvergence, FusionDivergence, FusionRange, NearPointOfAccommodation, 
NearPointOfConvergence, OrthopticsNotes, LoginID)
values
(@RoundNo, @HeadPosture, @Fixation, @LeftHirschberg, @RightHirschberg, @RightEOM, @LeftEOM, @CoverTestID,
 @LeftAPCTGlasses, @RightAPCTGlasses, @LeftAPCTWithOutGlasses, @RightAPCTWithOutGlasses, @Correspondence,
 @PrismAdaptation, @FusionConvergence, @FusionDivergence, @FusionRange, @NearPointOfAccommodation,
 @NearPointOfConvergence, @OrthopticsNotes, @LoginID)
 return 0
end
go
/******************************************************************************************************
exec uspInsertIPDOrthoptics
******************************************************************************************************/
-- select * from IPDOrthoptics
-- delete from IPDOrthoptics


/******************************************************************************************************
exec uspUpdateIPDOrthoptics
******************************************************************************************************/
-- select * from IPDOrthoptics
-- delete from IPDOrthoptics


-------------- Get IPDOrthoptics -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDOrthoptics')
	drop proc uspGetIPDOrthoptics
go
create proc uspGetIPDOrthoptics(
@RoundNo varchar(20)
)with encryption as
begin
	select RoundNo, HeadPosture, Fixation, LeftHirschberg, RightHirschberg,
	 RightEOM, LeftEOM, CoverTestID, dbo.GetLookupDataDes(CoverTestID) as CoverTestID, 
	 LeftAPCTGlasses, RightAPCTGlasses, LeftAPCTWithOutGlasses, RightAPCTWithOutGlasses, Correspondence, 
	 PrismAdaptation, FusionConvergence, FusionDivergence, FusionRange, NearPointOfAccommodation, 
	 NearPointOfConvergence, OrthopticsNotes, IPDOrthoptics.LoginID, ClientMachine, RecordDateTime
	from IPDOrthoptics

	where RoundNo = @RoundNo
return 0
end
go

/******************************************************************************************************
exec uspGetIPDOrthoptics
******************************************************************************************************/
-- select * from IPDOrthoptics
-- delete from IPDOrthoptics



------------------------------------------------------------------------------------------------------
------------- IPDItems -------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert IPDItems---------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertIPDItems')
	drop proc uspInsertIPDItems
go

create proc uspInsertIPDItems(
@RoundNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Quantity int,
@UnitPrice money,
@ItemDetails varchar(800),
@LastUpdate smalldatetime,
@ItemStatusID varchar(10),
@PayStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40) = null,
@CreatorLoginID varchar(20),
@CreatorClientMachine varchar(40)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @ItemStatus varchar(10)
declare @PayStatus  varchar(10)
declare @VisitLockedStatus varchar(20)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

declare @PatientNo varchar(20)

declare @BillModesID varchar(10)
declare @BillNo varchar(20)
declare @InsuranceNo varchar(20)
declare @CompanyNo varchar(20)
declare @PolicyNo varchar(20)

declare @UnitCost money

declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)
declare @PackageID varchar(10)
declare @ItemName varchar(800)
declare @UnitMeasure varchar(100)
declare @PackageNo varchar(20)
declare @PackageQuantity int
declare @PackageVisitNo varchar(20)
declare @VisitNo varchar(20)
declare @PackageRemainingQuantity varchar(20)

set @ItemStatus = dbo.GetLookupDataID('ItemStatus', 'P')
set @PayStatus = dbo.GetLookupDataID('PayStatus', 'NP')

set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')

set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')
set @PackageID = dbo.GetLookupDataID('ItemCategory', 'G')


set @ItemName = dbo.GetItemName(@ItemCategoryID, @ItemCode)
set @UnitMeasure = dbo.GetUnitMeasure(@ItemCategoryID,@ItemCode)
-----------------------------------------------------------------------------------------------------------
set @UnitCost = dbo.GetItemUnitCost(@ItemCategoryID, @ItemCode)
if  (@ClientMachine is null or @ClientMachine = '') begin set @ClientMachine = host_name() end
-----------------------------------------------------------------------------------------------------------
set @VisitNo =(select Visits.VisitNo from IPDDoctor
					inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
					inner join Visits on Admissions.VisitNo = Visits.VisitNo	
					inner join Patients on Visits.PatientNo = Patients.PatientNo 
					where RoundNo = @RoundNo)
set @BillModesID =(select Admissions.BillModesID from IPDDoctor
					inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
					inner join Visits on Admissions.VisitNo = Visits.VisitNo	
					inner join Patients on Visits.PatientNo = Patients.PatientNo 
					where RoundNo = @RoundNo)
					
set @BillNo = (select Admissions.BillNo from IPDDoctor
					inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
					inner join Visits on Admissions.VisitNo = Visits.VisitNo	
					inner join Patients on Visits.PatientNo = Patients.PatientNo 
					where RoundNo = @RoundNo)
					
set @InsuranceNo = (select Admissions.InsuranceNo from IPDDoctor
					inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
					inner join Visits on Admissions.VisitNo = Visits.VisitNo	
					inner join Patients on Visits.PatientNo = Patients.PatientNo 
					where RoundNo = @RoundNo)

set @CompanyNo = (select CompanyNo from SchemeMembers where MedicalCardNo = @BillNo)
set @PolicyNo = (select PolicyNo from SchemeMembers where MedicalCardNo = @BillNo)

------------------------------------------------------------------------------------------------------------
if (@DrugID = @ItemCategoryID) and (exists(select PatientNo from PatientAllergies
	inner join AllergyDrugs on PatientAllergies.AllergyNo = AllergyDrugs.AllergyNo 
	where PatientNo = (select Patients.PatientNo from IPDDoctor
	inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo	
	inner join Patients on Visits.PatientNo = Patients.PatientNo 
	where RoundNo = @RoundNo) and DrugNo = @ItemCode))
	begin
		set @PatientNo = (select top 1 PatientNo from PatientAllergies
			inner join AllergyDrugs on PatientAllergies.AllergyNo = AllergyDrugs.AllergyNo 
			where PatientNo = (select Patients.PatientNo from IPDDoctor
			inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
			inner join Visits on Admissions.VisitNo = Visits.VisitNo	
			inner join Patients on Visits.PatientNo = Patients.PatientNo 
			where RoundNo = @RoundNo) and DrugNo = @ItemCode)
		set @ErrorMSG = 'Patient No: %s, is allergic to Drug No: %s, you can’t prescribe this drug'
		raiserror(@ErrorMSG,16,1, @PatientNo, @ItemCode)	
		return 1
	end




----------------------------------------------------------------------------------------------------------------------------------------

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @ServiceID)-- Services
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Service Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @ServiceID)-- Services
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Service Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Service Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @DrugID)-- Drugs
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @DrugID)-- Drugs
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @ConsumableID)-- Consumable Items
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @ConsumableID)-- Consumable Items
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @ProcedureID)-- Procedure
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @ProcedureID)-- Procedure
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Procedure Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end	
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @DentalID)-- Dental
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Dental Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @DentalID)-- Dental
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Dental Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Dental Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @TheatreID)-- Theatre
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @TheatreID)-- Theatre
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Theatre Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @OpticalID)-- Optical
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Optical Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @OpticalID)-- Optical
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Optical Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Optical Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @MaternityID)-- Maternity
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @MaternityID)-- Maternity
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Maternity Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @ICUID)-- ICU
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @ICUID)-- ICU
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'ICU Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @TestID)-- Test
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Test Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @TestID)-- Test
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Test Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Test Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end

else 
if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @CardiologyID)-- Cardiology
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Cardiology Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @CardiologyID)-- Cardiology
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Cardiology Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Cardiology Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end


else 
if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @RadiologyID)-- Radiology
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Radiology Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end

else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @RadiologyID)-- Radiology
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Radiology Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Radiology Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @PathologyID)-- Pathology
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Pathology Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @PathologyID)-- Pathology
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Pathology Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Pathology Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @EyeID)-- Eye
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Eye Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @EyeID)-- Eye
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Eye Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Eye Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @AdmissionID)-- Admission
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Bed No', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @AdmissionID)-- Admission
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Bed No', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Bed No', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end
else

if (@BillModesID = @AccountBillModesID and @ItemCategoryID = @ExtrasID)-- Extras
	begin
		if ((exists(select AccountNo from BillExcludedItems where AccountNo = @BillNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)) or
			(exists(select AccountNo from BillExcludedItems where AccountNo = @InsuranceNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)))
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Extra Item Code', @ItemCode, 'Account No', @BillNo)	
				return 1
			end	
	end
else if (@BillModesID = @InsuranceBillModesID and @ItemCategoryID = @ExtrasID)-- Extras
	begin
		if exists(select CompanyNo from InsuranceExcludedItems where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo 
					and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s and %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Extra Item Code', @ItemCode, 'Company No', @CompanyNo, 'Policy No', @PolicyNo)	
				return 1
			end	
		else if exists(select InsuranceNo from InsuranceExclusions 
			where InsuranceNo = @InsuranceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
			begin
				set @ErrorMSG = '%s: %s, is an exclusion on %s: %s. You can''t save this record!'
				raiserror(@ErrorMSG, 16, 1, 'Extra Item Code', @ItemCode, 'Insurance No', @InsuranceNo)	
				return 1
			end	
	end

----------------------------------------------------------------------------------------------------------------------------------------

if not exists(select RoundNo from IPDDoctor where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The Round No: ' + @RoundNo + ', you are trying to enter does not exist in the registered IPD Doctor'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end




if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The Item Category ID: ' + @ItemCategoryID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemStatusID)
	begin
		set @ErrorMSG = 'The Item Status ID: ' + @ItemStatusID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayStatusID)
	begin
		set @ErrorMSG = 'The Pay Status ID: ' + @PayStatusID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

------------------------------------------------------------------------------------------------------------
set @PackageNo = (select PackageNo from PackageVisits where VisitNo = dbo.GetRoundVisitNo(@RoundNo))

set @PackageVisitNo = (select PackageVisitNo from PackageVisits where VisitNo = @VisitNo
and PackageNo = @PackageNo)

set @PackageRemainingQuantity= dbo.GetPackageRemainingQuantities(@PackageVisitNo,@PackageNo,@ItemCode,@ItemCategoryID)

------------------------------------------------------------------------------------------------------------

-- Ensure that Invoice is not Created already

----------------------------------------------------------------------------------------------------------

set @VisitLockedStatus = (select top 1 PayNo from Invoices where PayNo =dbo.GetIPDVisitNo(@RoundNo))
	
if (dbo.GetOptionValue('LockVisitUponInvoiceCreation') > 0) and (len(@VisitLockedStatus) > 0) 
	begin
		set @ErrorMSG = 'The Patient With Round No: ' + @RoundNo + ', you are trying to add Items to has an Existing Invoice and is Locked please Contact the administrator'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end
----------------------------------------------------------------------------------------------------------


---- Check if Quantity given is in range with Package Quantity

if not (@PackageNo is null or @PackageNo = '') and not (@Quantity is null or @Quantity = '')
begin
if exists(select ItemCode from PackagesEXT where PackageNo =@PackageNo and ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode)
begin

set @PackageQuantity= (select Quantity from PackagesEXT where PackageNo =@PackageNo and ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode)

if  (@Quantity > @PackageQuantity)
begin

set @ErrorMSG = 'The %s: %s, you are trying to enter has Quantities exceeding the Package defined quantities. You Can''t save this record'
raiserror(@ErrorMSG,16,1,'Item Code',@ItemCode,'Packages')	
return 1

end
end
end


----------------------------------------------------------------------------------------------------------------------------------------

---- Check if Quantity given doesn't exceed  Package Quantity

if not (@PackageNo is null or @PackageNo = '') and not (@Quantity is null or @Quantity = '')
begin

if exists(select ItemCode from PackagesEXT where PackageNo =@PackageNo and ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode)
begin

if exists (select Top 1 PatientNo from PackageCheck where PackageNo =@PackageNo and PackageVisitNo =@PackageVisitNo)
begin

if  (@Quantity > @PackageRemainingQuantity)
begin
set @ErrorMSG = 'The %s: %s, you are trying to enter has ' + (cast(@PackageRemainingQuantity as varchar(20))) + ' Remaining quantity on this Package You Can''t save this record'
raiserror(@ErrorMSG,16,1,'Item Code',@ItemCode,'Packages')
	
return 1
end
end
end
end

----------------------------------------------------------------------------------------------------------------------------------------
---- Check if Package has this Item

--if not (@PackageNo is null or @PackageNo = '') and not (@ItemCode is null or @ItemCode = '') and not( @ItemCategoryID=@PackageID)
--begin

--if not exists (select Itemcode from PackagesEXT where PackageNo =@PackageNo and ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode)
--    begin
--set @ErrorMSG = 'The %s: %s, you are trying to enter is an Exclusion on this Patient Package. You Can''t save this record'
--raiserror(@ErrorMSG,16,1,'Item Code',@ItemCode,'PackagesEXT')	
--return 1
--      end

--end
----------------------------------------------------------------------------------------------------------------------------------------


if exists(select RoundNo from IPDItems where RoundNo = @RoundNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		if  exists(select RoundNo from IPDItems where RoundNo = @RoundNo and  ItemCode = @ItemCode and
			ItemCategoryID = @ItemCategoryID and ItemStatusID = @ItemStatus and PayStatusID = @PayStatus) 
			
		begin
			update IPDItems set
			Quantity = @Quantity, UnitCost = @UnitCost, UnitPrice = @UnitPrice, ItemDetails = @ItemDetails, LastUpdate = @LastUpdate, 
			ItemName =@ItemName,UnitMeasure =@UnitMeasure,ItemStatusID = @ItemStatusID, PayStatusID = @PayStatusID, LoginID  = @LoginID, ClientMachine = @ClientMachine
			where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID	
			return 0
		end
		else
		
		set @ErrorMSG = 'The record with %s: %s and  %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', is not pending or has been paid for. You can''t update this record!'
		raiserror(@ErrorMSG,16,1, 'Round No', @RoundNo, 'Item Code', @ItemCode , 'Item Category')	
		return 1
	end

else
begin
insert into IPDItems
(RoundNo ,ItemCode,ItemName,UnitMeasure, ItemCategoryID, Quantity, UnitCost, UnitPrice, ItemDetails, 
LastUpdate, ItemStatusID ,PayStatusID, OriginalQuantity, OriginalPrice, LoginID, ClientMachine,CreatorLoginID,CreatorClientMachine) 
values
(@RoundNo, @ItemCode,@ItemName,@UnitMeasure, @ItemCategoryID, @Quantity, @UnitCost, @UnitPrice, @ItemDetails, 
@LastUpdate, @ItemStatusID, @PayStatusID, @Quantity, @UnitPrice, @LoginID, @ClientMachine,@CreatorLoginID,@CreatorClientMachine)
return 0
end
go

/*******************************************************************************************
--1-----------------------------------------------------------------------------------------
exec uspInsertIPDItems '11022650101', '10C', '7S', 1, 500, '1 X 4', '12 Nov 2005', '11P','12NP', 'Admin'
*******************************************************************************************/

-- select * from IPDItems
-- delete from IPDItems
-- select * from IPDDoctor

-----------------Update IPDItems--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDItems')
	drop proc uspUpdateIPDItems
go

create proc uspUpdateIPDItems(
@RoundNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@LastUpdate smalldatetime ,
@PayStatusID varchar(10) = null,
@LoginID varchar(20),
@ItemStatusID varchar(10) = null,
@ClientMachine varchar(40) = null
)with encryption as 

declare @ErrorMSG varchar(200)

declare @NotPaidPayStatus  varchar(10)
declare @DrugItemCategoryID  varchar(10)
declare @ProcedureItemCategoryID  varchar(10)
declare @TheatreItemCategoryID  varchar(10)
declare @PendingItemStatusID varchar(10)

set @NotPaidPayStatus = dbo.GetLookupDataID('PayStatus', 'NP')
set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ProcedureItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TheatreItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'H')
set @PendingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')

-----------------------------------------------------------------------------------------------
if  (@ClientMachine is null or @ClientMachine = '') begin set @ClientMachine = host_name() end
-----------------------------------------------------------------------------------------------

if not exists(select RoundNo from IPDItems where RoundNo = @RoundNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with Round No: %s and Item Code: %s and Item Category: %s, does not  exist in registered items'
		raiserror(@ErrorMSG,16,1, @RoundNo, @ItemCode, @ItemCategoryID)	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end
else

if (@ItemStatusID is null)
begin

	if not exists(select RoundNo from IPDItems where RoundNo = @RoundNo and ItemCode = @ItemCode 
				  and ItemCategoryID = @ItemCategoryID and PayStatusID = @NotPaidPayStatus)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', is already ' + dbo.GetLookupDataDes(@PayStatusID) + ''
			raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category')	
			return 1
		end

	if not exists(select DataID from LookupData where DataID = @PayStatusID)
		begin
			set @ErrorMSG = 'The Pay Status ID: ' + @PayStatusID + ', you are trying to enter does not exist in the registered Lookup Data'
			raiserror(@ErrorMSG, 16, 1)	
			return 1
		end

	update IPDItems 
	set LastUpdate = @LastUpdate, PayStatusID = @PayStatusID , LoginID = @LoginID, ClientMachine = @ClientMachine
	where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
end

else
begin

if (@ItemCategoryID = @DrugItemCategoryID or @ItemCategoryID = @ProcedureItemCategoryID or @ItemCategoryID = @TheatreItemCategoryID)
	begin	
		if not exists(select RoundNo from IPDItems where RoundNo = @RoundNo and ItemCode = @ItemCode 
					  and ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID)
			begin
				set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', is already ' + dbo.GetLookupDataDes(@ItemStatusID) + ''
				raiserror(@ErrorMSG,16,1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category')	
				return 1
			end
	end

if not exists(select DataID from LookupData where DataID = @ItemStatusID)
	begin
		set @ErrorMSG = 'The Item Status ID: ' + @ItemStatusID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

	update IPDItems set 
	LastUpdate = @LastUpdate, LoginID = @LoginID, ItemStatusID = @ItemStatusID, ClientMachine = @ClientMachine
	where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
end

return 0
go

/*--------------------------------------------------------------------------------------------------------
-- select * from IPDItems
-- exec uspUpdateIPDItems '06000001002', '10C', '7S', '11 Oct 2005', '12NP', 'Admin'
-- exec uspUpdateIPDItems '06000001002', '10C', '7S', '11 Oct 2005', null, 'Admin', '11P'
---------------------------------------------------------------------------------------------------------*/

----------------Delete Item-------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspDeleteIPDItem')
	drop proc uspDeleteIPDItem
go

create proc uspDeleteIPDItem(
@RoundNo varchar(20) ,
@ItemCode varchar(20) ,
@ItemCategoryID varchar(10)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @ItemStatusID varchar(10)
declare @PayStatusID varchar(10)
declare @NAPayStatusID varchar(10)

set @ItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @PayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @NAPayStatusID = dbo.GetLookupDataID('PayStatus', 'NA')


if exists(select RoundNo from IPDItems where RoundNo = @RoundNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		if  exists(select RoundNo from IPDItems where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID 
								and ItemStatusID = @ItemStatusID and PayStatusID IN (@NAPayStatusID,@PayStatusID)) 
			
		begin				
			delete IPDItems where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
			return 0
		end
		else
			set @ErrorMSG = 'The record with %s: %s, %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', is not pending or has been paid for. You can''t delete this record!'
			raiserror(@ErrorMSG,16,1, 'Round No', @RoundNo, 'Item Code', @ItemCode , 'Item Category')
			return 1
	end
else
		set @ErrorMSG = 'The record with %s: %s, %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', does not exist!'
		raiserror(@ErrorMSG,16,1, 'Round No', @RoundNo, 'Item Code', @ItemCode , 'Item Category')
		return 1

return 0

go

-- exec uspDeleteIPDItem '000001BA21078001', '10C','7S'

-- select * from IPDItems

--------Get IPDItems--------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDItems')
	drop proc uspGetIPDItems
go

create proc uspGetIPDItems(
@RoundNo varchar(20) = null,
@ItemCategoryID varchar(10) = null,
@ItemStatusID varchar(10) = null,
@PayStatusID varchar(10)= null,
@BillAccount varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @BillModesID varchar(10)

declare @CashID varchar(10)
declare @AccountID varchar(10)

set @CashID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountID = dbo.GetLookupDataID('BillModes', 'A')

if not (@RoundNo is null)
begin
	if not exists(select RoundNo from IPDItems where RoundNo = @RoundNo)
		begin
			--set @ErrorMSG = 'The Round No: ' + cast(@RoundNo as varchar) + ', you are trying to enter does not exist in the registered IPDItems'
			--raiserror(@ErrorMSG,16,1)	
			return 1
		end
end

if not (@RoundNo is null) and (@ItemCategoryID is null) and (@ItemStatusID is null) 
	and not (@PayStatusID is null) and not (@BillAccount is null)
	begin
		select IPDItems.RoundNo, Admissions.BillNo, IPDItems.ItemCode, Quantity, 
		UnitPrice, Quantity * UnitPrice as Amount, ItemDetails, 
		IPDItems.ItemCategoryID, dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
		dbo.GetIPDLabApprovedStatusID(IPDItems.RoundNo,IPDItems.ItemCode) as LabApprovedStatusID, 
		dbo.GetRejectionStatus(IPDItems.RoundNo,IPDItems.ItemCategoryID) as RejectionStatus,
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,ItemName,
		dbo.GetUnitMeasure(IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitMeasure, Dosage, Duration,
		dbo.GetStaffFullNameWithLoginID(CreatorLoginID) as CreatorFullName,
		dbo.GetItemLabTestTubeType(IPDItems.ItemCode) as TubeType
		from IPDItems
		left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
		and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
		inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
		inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
		inner join Visits on Admissions.VisitNo = Visits.VisitNo
		where IPDItems.RoundNo = @RoundNo and PayStatusID = @PayStatusID and Admissions.BillNo = @BillAccount
	end

else

if not (@RoundNo is null) and not (@ItemCategoryID is null) and (@ItemStatusID is null) and (@PayStatusID is null)
	begin
		select  IPDItems.RoundNo, IPDItems.ItemCode, Quantity, 
		UnitPrice, Quantity * UnitPrice as Amount, ItemDetails, 
		IPDItems.ItemCategoryID, dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
		dbo.GetIPDLabApprovedStatusID(IPDItems.RoundNo,IPDItems.ItemCode) as LabApprovedStatusID, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,ItemName,
		dbo.GetRejectionStatus(IPDItems.RoundNo,IPDItems.ItemCategoryID) as RejectionStatus,
		dbo.GetUnitMeasure(IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitMeasure, Dosage, Duration,
		dbo.GetMergedNameCode(dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode), IPDItems.ItemCode) as ItemFullName, 
		ItemDetails,dbo.GetStaffFullNameWithLoginID(CreatorLoginID) as CreatorFullName,
		dbo.GetItemLabTestTubeType(IPDItems.ItemCode) as TubeType from IPDItems
		left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
		and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
		where IPDItems.RoundNo = @RoundNo and IPDItems.ItemCategoryID = @ItemCategoryID
	end
else

if not (@RoundNo is null) and not (@ItemCategoryID is null) and not (@ItemStatusID is null) and (@PayStatusID is null)
	begin
		select  IPDItems.RoundNo, IPDItems.ItemCode, Quantity, 
		UnitPrice, Quantity * UnitPrice as Amount, ItemDetails, 
		IPDItems.ItemCategoryID, dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
		dbo.GetIPDLabApprovedStatusID(IPDItems.RoundNo,IPDItems.ItemCode) as LabApprovedStatusID, 
		dbo.GetRejectionStatus(IPDItems.RoundNo,IPDItems.ItemCategoryID) as RejectionStatus,
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,ItemName,
		dbo.GetUnitMeasure(IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitMeasure, Dosage, Duration,
		dbo.GetMergedNameCode(dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode), IPDItems.ItemCode) as ItemFullName,
		dbo.GetItemLabTestTubeType(IPDItems.ItemCode) as TubeType, 
		ItemDetails,dbo.GetStaffFullNameWithLoginID(CreatorLoginID) as CreatorFullName from IPDItems
		left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
		and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
		where IPDItems.RoundNo = @RoundNo and IPDItems.ItemCategoryID = @ItemCategoryID and IPDItems.ItemStatusID = @ItemStatusID
	end

else

begin

set @BillModesID = (select Admissions.BillModesID from IPDDoctor 
						inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
						inner join Visits on Admissions.VisitNo = Visits.VisitNo 
						where RoundNo = @RoundNo)

	if @BillModesID = @CashID
	begin
		select  IPDItems.RoundNo, Admissions.BillNo, IPDItems.ItemCode, Quantity, 
		UnitPrice, Quantity * UnitPrice as Amount, ItemDetails, 
		IPDItems.ItemCategoryID, dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
		dbo.GetIPDLabApprovedStatusID(IPDItems.RoundNo,IPDItems.ItemCode) as LabApprovedStatusID,
		dbo.GetRejectionStatus(IPDItems.RoundNo,IPDItems.ItemCategoryID) as RejectionStatus,
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,ItemName,
		dbo.GetItemLabTestTubeType(IPDItems.ItemCode) as TubeType,
		dbo.GetUnitMeasure(IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitMeasure, Dosage, Duration,
		dbo.GetMergedNameCode(dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode), IPDItems.ItemCode) as ItemFullName, 
		ItemStatusID,dbo.GetStaffFullNameWithLoginID(CreatorLoginID) as CreatorFullName from IPDItems
		left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
		and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
		inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
		inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
		inner join Visits on Admissions.VisitNo = Visits.VisitNo
		where IPDItems.RoundNo = @RoundNo and PayStatusID = @PayStatusID
		and IPDItems.ItemCategoryID = @ItemCategoryID and ItemStatusID = @ItemStatusID
	end
	else

	if @BillModesID = @AccountID
	begin
		select IPDItems.RoundNo, Admissions.BillNo, IPDItems.ItemCode, Quantity, UnitPrice, ItemDetails, 
		IPDItems.ItemCategoryID, dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
		dbo.GetIPDLabApprovedStatusID(IPDItems.RoundNo,IPDItems.ItemCode) as LabApprovedStatusID,
		dbo.GetRejectionStatus(IPDItems.RoundNo,IPDItems.ItemCategoryID) as RejectionStatus,
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,ItemName,
		dbo.GetItemLabTestTubeType(IPDItems.ItemCode) as TubeType,
		dbo.GetUnitMeasure(IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitMeasure, Dosage, Duration,
		dbo.GetMergedNameCode(dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode), IPDItems.ItemCode) as ItemFullName, 
		ItemStatusID,dbo.GetStaffFullNameWithLoginID(CreatorLoginID) as CreatorFullName from IPDItems
		left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
		and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
		inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
		inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
		inner join Visits on Admissions.VisitNo = Visits.VisitNo
		where IPDItems.RoundNo = @RoundNo and IPDItems.ItemCategoryID = @ItemCategoryID and ItemStatusID = @ItemStatusID
	end
	
end

return 0
go


-- exec uspGetIPDItems null, null, null, '12NP', 'Cash'
-- exec uspGetIPDItems null, null, null, '12NP', 'Account'
-- exec uspGetIPDItems null, null, null, '12NP', 'SHARP'
-- exec uspGetIPDItems null, '7P', '11P', '12NP', null
-- exec uspGetIPDItems '0600001002', null, null, '12NP', 'Cash'
-- exec uspGetIPDItems '0600001002', '7T', '11R', '12PF'
-- exec uspGetIPDItems '07022068001', '7P', null, null
-- select * from IPDItems
-- select * from Visits


-- exec uspGetIPDItems null, null, null, '12NP', 'Cash'
-- exec uspGetIPDItems null, null, null, '12NP', 'Account'
-- exec uspGetIPDItems null, null, null, '12NP', 'SHARP'
-- exec uspGetIPDItems null, '7P', '11P', '12NP', null
-- exec uspGetIPDItems '0600001002', null, null, '12NP', 'Cash'
-- exec uspGetIPDItems '0600001002', '7T', '11R', '12PF'
-- exec uspGetIPDItems '07022068001', '7P', null, null
-- select * from IPDItems
-- select * from Visits

--------GetDentalIPDItems--------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDentalIPDItems')
	drop proc uspGetDentalIPDItems
go

create proc uspGetDentalIPDItems(
@RoundNo varchar(20),
@DentalCategory varchar(100)
)with encryption as

declare @ErrorMSG varchar(200)
declare @DentalID varchar(10)

set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')

if not exists(select RoundNo from IPDItems where RoundNo = @RoundNo)
	begin
		--set @ErrorMSG = 'The Round No: ' + cast(@RoundNo as varchar) + ', you are trying to enter does not exist in the registered IPD Items'
		--raiserror(@ErrorMSG,16,1)	
		return 1
	end
else
	begin
		select  IPDItems.RoundNo, ItemCode, Quantity, UnitPrice, ItemDetails, 
		dbo.GetDentalCategory(ItemCode) as DentalCategory, Quantity * UnitPrice as Amount, 
		IPDItems.ItemCategoryID, dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,ItemName,
		dbo.GetUnitMeasure(IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitMeasure,
		dbo.GetMergedNameCode(IPDItems.ItemName, ItemCode) as ItemFullName, 
		ItemDetails from IPDItems
		where IPDItems.RoundNo = @RoundNo and IPDItems.ItemCategoryID = @DentalID 
		and dbo.GetDentalCategory(ItemCode) = @DentalCategory
	end
return 0
go

-- exec uspGetDentalIPDItems '1100709009', 'Service'
-- select * from IPDItems
-- select * from Visits

--------Get NotDoneOrOfferedIPDItems--------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNotDoneOrOfferedIPDItems')
	drop proc uspGetNotDoneOrOfferedIPDItems
go

create proc uspGetNotDoneOrOfferedIPDItems(
@VisitNo varchar(20) 
)with encryption as

declare @ErrorMSG varchar(200)
declare @OfferedItemStatusID varchar(10)
declare @DoneItemStatusID varchar(10)

set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')
set @DoneItemStatusID = dbo.GetLookupDataID('ItemStatus', 'D')

begin
	select  Admissions.VisitNo, IPDItems.RoundNo, IPDItems.RecordDateTime as RoundDateTime, 
			IPDItems.ItemCode,ItemName,
			IPDItems.ItemCategoryID, dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory,
			Quantity, UnitPrice, Quantity * UnitPrice as Amount,
			PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 		
			ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor,
			dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact
			from IPDItems		
			inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
			inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
			inner join Visits on Admissions.VisitNo = Visits.VisitNo
			where Admissions.VisitNo = @VisitNo 
			and not (IPDItems.ItemStatusID = @OfferedItemStatusID or IPDItems.ItemStatusID = @DoneItemStatusID)
end

return 0
go

-- exec uspGetNotDoneOrOfferedIPDItems '15016374002'16-005683-001


--------Get NotPaidNotDoneOrOfferedIPDItems--------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNotPaidNotDoneOrOfferedIPDItems')
	drop proc uspGetNotPaidNotDoneOrOfferedIPDItems
go

create proc uspGetNotPaidNotDoneOrOfferedIPDItems(
@VisitNo varchar(20) 
)with encryption as

declare @ErrorMSG varchar(200)
declare @OfferedItemStatusID varchar(10)
declare @DoneItemStatusID varchar(10)
declare @NotPaidPayStatusID varchar(10)

set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')
set @DoneItemStatusID = dbo.GetLookupDataID('ItemStatus', 'D')
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')

begin
	select  Admissions.VisitNo, IPDItems.RoundNo, IPDItems.RecordDateTime as RoundDateTime, 
			IPDItems.ItemCode,ItemName,
			IPDItems.ItemCategoryID, dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory,
			Quantity, UnitPrice, Quantity * UnitPrice as Amount,
			PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 		
			ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus
						
			from IPDItems		
			inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
			inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
			inner join Visits on Admissions.VisitNo = Visits.VisitNo
			where Admissions.VisitNo = @VisitNo and IPDItems.PayStatusID = @NotPaidPayStatusID
			and not (IPDItems.ItemStatusID = @OfferedItemStatusID or IPDItems.ItemStatusID = @DoneItemStatusID)
			
end

return 0
go

-- exec uspGetNotPaidNotDoneOrOfferedIPDItems '15016374002'
-- exec uspGetNotPaidNotDoneOrOfferedIPDItems '16005683001'






--------GetNotPaidIPDItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNotPaidIPDItems')
	drop proc uspGetNotPaidIPDItems
go

create proc uspGetNotPaidIPDItems(
@BillAccount varchar(20),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @NotPaidPayStatusID varchar(10)
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')

if not(@StartDate is null) and not(@EndDate is null)
begin
	if @BillAccount = 'Cash' -- Bill Cash
		begin
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(IPDItems.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
				dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,ItemName,
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age,
				dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
				dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor,
				dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact,
				dbo.FormatDate(IPDItems.RecordDateTime) as RecordDate, 
				dbo.GetTime(IPDItems.RecordDateTime) as RecordTime
			from IPDItems 
			inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
			inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
			inner join Visits on Admissions.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and Admissions.BillNo = @BillAccount
			and VisitDate between @StartDate and @EndDate
			order by RoundDateTime, IPDItems.RecordDateTime
		end
	else
	if @BillAccount = 'Account' -- Bill Account
		begin
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(IPDItems.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.GetMergedNameCode(dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo), Admissions.BillNo) as BillCustomerFullName,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor,
			dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact,
			dbo.FormatDate(IPDItems.RecordDateTime) as RecordDate, 
			dbo.GetTime(IPDItems.RecordDateTime) as RecordTime
	 		from IPDItems 
			inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
			inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
			inner join Visits on Admissions.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			where PayStatusID = @NotPaidPayStatusID and not Admissions.BillNo = 'Cash'
			and VisitDate between @StartDate and @EndDate
			order by RoundDateTime, IPDItems.RecordDateTime
		end
end
else
begin
	if @BillAccount = 'Cash' -- Bill Cash
		begin
			select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(IPDItems.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor,
			dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact,
			dbo.FormatDate(IPDItems.RecordDateTime) as RecordDate, 
			dbo.GetTime(IPDItems.RecordDateTime) as RecordTime
			from IPDItems 
			inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
			inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
			inner join Visits on Admissions.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo 
			where PayStatusID = @NotPaidPayStatusID and Admissions.BillNo = @BillAccount
			order by RoundDateTime, IPDItems.RecordDateTime
		end
	else
	if @BillAccount = 'Account' -- Bill Account
		begin
			select distinct Admissions.BillNo, dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.GetMergedNameCode(dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo), Admissions.BillNo) as BillCustomerFullName  
			from IPDItems 
			inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
			inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
			inner join Visits on Admissions.VisitNo = Visits.VisitNo
			where PayStatusID = @NotPaidPayStatusID and not Admissions.BillNo = 'Cash'
		end
	else
	if not @BillAccount = 'Cash' and not @BillAccount = 'Account' 
		begin
			select  IPDItems.RoundNo, VisitDate, Admissions.BillNo, IPDItems.ItemCode, Quantity, UnitPrice, 
			dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName,
			ItemDetails, IPDItems.ItemCategoryID, dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, 
			dbo.GetUnitMeasure(IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitMeasure,ItemName, Dosage, Duration,
			dbo.GetMergedNameCode(IPDItems.ItemName, IPDItems.ItemCode) as ItemFullName, 
			ItemStatusID from IPDItems 
			left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
			and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
			inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
			inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
			inner join Visits on Admissions.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo		
			where PayStatusID = @NotPaidPayStatusID and Admissions.BillNo = @BillAccount
			order by VisitDate desc, IPDItems.RoundNo asc
		end
end	
return 0
go

-- select * from Visits
-- exec uspGetNotPaidIPDItems 'CM00130'
-- exec uspGetNotPaidIPDItems 'CM00130', 'apr 15, 2011', 'apr 30, 2011'

--------GetPendingIPDItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPendingIPDItems')
	drop proc uspGetPendingIPDItems
go

create proc uspGetPendingIPDItems(
@ItemCategoryID varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @PendingItemStatusID varchar(10)
set @PendingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')

if not(@StartDate is null) and not(@EndDate is null)
begin
--------------------------------------------------------------------------------------------
	set @EndDate = dbo.GetShortDate(dateadd(day, 1, @EndDate))
--------------------------------------------------------------------------------------------

	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(IPDItems.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.FormatDateTime(RoundDateTime) as RoundDateTime,
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus,
			dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact, 
			dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor,
			dbo.FormatDate(IPDItems.RecordDateTime) as RecordDate, 
			dbo.GetTime(IPDItems.RecordDateTime) as RecordTime
	from IPDItems 
	inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
	inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	and RoundDateTime between @StartDate and @EndDate
	order by RoundDateTime, IPDItems.RecordDateTime
end
else
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(IPDItems.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.FormatDateTime(RoundDateTime) as RoundDateTime,
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus,
			dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact, 
			dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor,
			dbo.FormatDate(IPDItems.RecordDateTime) as RecordDate, 
			dbo.GetTime(IPDItems.RecordDateTime) as RecordTime
	from IPDItems 
	inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
	inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	order by RoundDateTime, IPDItems.RecordDateTime
end	
return 0
go

-- select * from Visits
-- exec uspGetPendingIPDItems '7T'
-- exec uspGetPendingIPDItems '7T', 'apr 15, 2011', 'apr 30, 2011'

--------GetProcessingIPDItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetProcessingIPDItems')
	drop proc uspGetProcessingIPDItems
go

create proc uspGetProcessingIPDItems(
@ItemCategoryID varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @ProcessingItemStatusID varchar(10)
set @ProcessingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'R')

if not(@StartDate is null) and not(@EndDate is null)
begin
--------------------------------------------------------------------------------------------
	set @EndDate = dbo.GetShortDate(dateadd(day, 1, @EndDate))
--------------------------------------------------------------------------------------------

	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(IPDItems.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.FormatDateTime(RoundDateTime) as RoundDateTime,
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus,
			dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact, 
			dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor,
			dbo.FormatDate(IPDItems.RecordDateTime) as RecordDate, 
			dbo.GetTime(IPDItems.RecordDateTime) as RecordTime
	from IPDItems
	inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
	inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @ProcessingItemStatusID
	and RoundDateTime between @StartDate and @EndDate
	order by RoundDateTime, IPDItems.RecordDateTime
end
else
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(IPDItems.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.FormatDateTime(RoundDateTime) as RoundDateTime,
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus,
			dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact, 
			dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor,
			dbo.FormatDate(IPDItems.RecordDateTime) as RecordDate, 
			dbo.GetTime(IPDItems.RecordDateTime) as RecordTime
	from IPDItems 
	inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
	inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @ProcessingItemStatusID
	order by RoundDateTime, IPDItems.RecordDateTime
end	
return 0
go

-- select * from Visits
-- exec uspGetProcessingIPDItems '7R'
-- exec uspGetProcessingIPDItems '7R', 'apr 3, 2014', 'Apr 4, 2014'

--------GetDoneIPDItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDoneIPDItems')
	drop proc uspGetDoneIPDItems
go

create proc uspGetDoneIPDItems(
@ItemCategoryID varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @DoneItemStatusID varchar(10)
set @DoneItemStatusID = dbo.GetLookupDataID('ItemStatus', 'D')

if not(@StartDate is null) and not(@EndDate is null)
begin
--------------------------------------------------------------------------------------------
	set @EndDate = dbo.GetShortDate(dateadd(day, 1, @EndDate))
--------------------------------------------------------------------------------------------

	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(IPDItems.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.FormatDateTime(RoundDateTime) as RoundDateTime,
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus,
			dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact, 
			dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor
	from IPDItems 
	inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
	inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @DoneItemStatusID
	and RoundDateTime between @StartDate and @EndDate
	order by RoundNo desc
end
else
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(IPDItems.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.FormatDateTime(RoundDateTime) as RoundDateTime,
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus,
			dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact, 
			dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor
	from IPDItems 
	inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
	inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @DoneItemStatusID
	order by RoundNo desc
end	
return 0
go

-- select * from Visits
-- exec uspGetDoneIPDItems '7R'
-- exec uspGetDoneIPDItems '7R', 'oct 12, 2011', 'oct 30, 2011'

--------GetDoctorIPDItems----------------------------------------------------------------------------------------------------------------

--------GetDoctorIPDItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDoctorIPDItems')
	drop proc uspGetDoctorIPDItems
go

create proc uspGetDoctorIPDItems(
@ItemCategoryID varchar(10),
@StaffLoginID varchar(20),
@ShowOnlyPending bit,
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @PendingItemStatusID varchar(10)
declare @LastDate smalldatetime

set @PendingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')

if (@ShowOnlyPending = 1) and not(@StartDate is null) and not(@EndDate is null)
begin
	set @LastDate = dateadd(day, 1, @EndDate)
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(IPDItems.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.FormatDateTime(RoundDateTime) as RoundDateTime,
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, Quantity, UnitPrice, DrQuantity,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
			dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact,
			dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor
	from IPDItems 
	left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
	and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
	inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
	inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where IPDItems.ItemCategoryID = @ItemCategoryID and ItemStatusID = @PendingItemStatusID
	and dbo.GetStaffLoginID(IPDDoctor.StaffNo) = @StaffLoginID 
	and RoundDateTime >= @StartDate and RoundDateTime < @LastDate
	order by RoundNo desc
end
else if (@ShowOnlyPending = 0) and not(@StartDate is null) and not(@EndDate is null)
begin
	set @LastDate = dateadd(day, 1, @EndDate)
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(IPDItems.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
			dbo.FormatDateTime(RoundDateTime) as RoundDateTime,
			dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, Quantity, UnitPrice, DrQuantity,ItemName,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
			dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact, 
			dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor
	from IPDItems 
	left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
	and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
	inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
	inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where IPDItems.ItemCategoryID = @ItemCategoryID
	and dbo.GetStaffLoginID(IPDDoctor.StaffNo) = @StaffLoginID 
	and RoundDateTime >= @StartDate and RoundDateTime < @LastDate
	order by RoundNo desc
end
else if (@ShowOnlyPending = 1) 
	begin
		select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(IPDItems.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
				dbo.FormatDateTime(RoundDateTime) as RoundDateTime,
				dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, Quantity, UnitPrice, DrQuantity,ItemName,
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
				dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact, 
				dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor
		from IPDItems 
		left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
		and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
		inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
		inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
		inner join Visits on Admissions.VisitNo = Visits.VisitNo
		inner join Patients on Visits.PatientNo = Patients.PatientNo
		where IPDItems.ItemCategoryID = @ItemCategoryID  and ItemStatusID = @PendingItemStatusID
		and dbo.GetStaffLoginID(IPDDoctor.StaffNo) = @StaffLoginID 
		order by RoundNo desc
	end	
else
	begin
		select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
				dbo.FormatText(IPDItems.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo,
				dbo.FormatDateTime(RoundDateTime) as RoundDateTime,
				dbo.FormatDate(dbo.GetPatientVisitDate(Admissions.VisitNo)) as VisitDate, Quantity, UnitPrice, DrQuantity,ItemName,
				dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
				dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
				dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
				dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
				dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
				dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact, 
				dbo.GetStaffName(IPDDoctor.StaffNo) as AttendingDoctor
		from IPDItems 
		left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
		and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
		inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
		inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
		inner join Visits on Admissions.VisitNo = Visits.VisitNo
		inner join Patients on Visits.PatientNo = Patients.PatientNo
		where IPDItems.ItemCategoryID = @ItemCategoryID and dbo.GetStaffLoginID(IPDDoctor.StaffNo) = @StaffLoginID 
		order by RoundNo desc
	end	
return 0
go

-- select * from IPDDoctor
-- exec uspGetDoctorIPDItems '7D', 'Admin', 0
-- exec uspGetDoctorIPDItems '7D', 'Admin', 1
-- exec uspGetDoctorIPDItems '7D', 'Admin', 0, 'apr 15, 2011', 'may 30, 2011'
-- exec uspGetDoctorIPDItems '7D', 'Admin', 1, 'apr 15, 2011', 'may 30, 2011'

----------------Get IPDItem-------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDItem')
	drop proc uspGetIPDItem
go

create proc uspGetIPDItem(
@RoundNo varchar(20) ,
@ItemCode varchar(20) ,
@ItemCategoryID varchar(10)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDItems where RoundNo = @RoundNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s, %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', does not exist!'
		raiserror(@ErrorMSG,16,1, 'Round No', @RoundNo, 'Item Code', @ItemCode , 'Item Category')
		return 1
	end
else
begin
		select  RoundNo, ItemCode, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, Quantity, UnitPrice, ItemDetails
		from IPDItems 
		where RoundNo = @RoundNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
end
return 0

go

-- exec uspGetIPDItem '000001BA21078001', '10C','7S'

-- select UnitPrice, * from IPDItems

------------------------------------------------------------------------------------------------------
-------------- IPDItemsEXT ---------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit IPDItemsEXT ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditIPDItemsEXT')
	drop proc uspEditIPDItemsEXT
go

create proc uspEditIPDItemsEXT(
@RoundNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Dosage varchar(100),
@Duration int,
@DrQuantity int
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDItems where RoundNo = @RoundNo and  ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with Round No: %s and Item Code: %s and Item Category: %s, does not  exist in registered items'
		raiserror(@ErrorMSG,16,1, @RoundNo, @ItemCode, @ItemCategoryID)	
		return 1
	end

if exists(select RoundNo from IPDItemsEXT where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		update IPDItemsEXT set
		Dosage = @Dosage, Duration = @Duration, DrQuantity = @DrQuantity
		where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
		return 0
	end
else
begin
insert into IPDItemsEXT
(RoundNo, ItemCode, ItemCategoryID, Dosage, Duration, DrQuantity)
values
(@RoundNo, @ItemCode, @ItemCategoryID, @Dosage, @Duration, @DrQuantity)
return 0
end
go

/******************************************************************************************************
exec uspEditIPDItemsEXT '000001BA21078001', 'M 0011B', '7D', '2X3', 5
exec uspEditIPDItemsEXT '000001BA21078001', 'M 0188', '7D', '2X3', 5
exec uspEditIPDItemsEXT '000001BA21078002', 'M 0070', '7D', '2X2', 3

******************************************************************************************************/
-- select * from IPDItemsEXT
-- delete from IPDItemsEXT

-------------- Update IPDItemsEXT -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDItemsEXT')
	drop proc uspUpdateIPDItemsEXT
go

create proc uspUpdateIPDItemsEXT(
@RoundNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Pharmacist varchar(10),
@LocationID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @IssueDateTime smalldatetime

set @IssueDateTime = GETDATE()

if not exists(select RoundNo from IPDItemsEXT where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'IPD Items EXTRA')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Pharmacist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pharmacist', @Pharmacist, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update IPDItemsEXT set
IssueDateTime = @IssueDateTime, Pharmacist = @Pharmacist, LocationID = @LocationID, 
LoginID = @LoginID, ClientMachine = @ClientMachine
where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDItemsEXT '10153710501', 'M1390', '7D', '22 Oct 2012', 'P001', 'Admin'

******************************************************************************************************/
-- select * from IPDItemsEXT
-- delete from IPDItemsEXT

------------------------------------------------------------------------------------------------------
------------- IPDDiagnosis ---------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert IPDDiagnosis -------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditIPDDiagnosis')
	drop proc uspEditIPDDiagnosis
go

create proc uspEditIPDDiagnosis(
@RoundNo varchar(20) ,
@DiseaseCode varchar(10) ,
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDDoctor where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The Round No: ' + @RoundNo + ', you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16, 1, 'IPD Doctor')	
		return 1
	end

if not exists(select DiseaseCode from Diseases where DiseaseCode = @DiseaseCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Disease Code', @DiseaseCode, 'Diseases')	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16, 1, 'Logins')	
		return 1
	end

if exists(select RoundNo from IPDDiagnosis where RoundNo = @RoundNo and DiseaseCode = @DiseaseCode)
	begin
		update IPDDiagnosis set Notes = @Notes, LoginID = @LoginID
		where RoundNo = @RoundNo and DiseaseCode = @DiseaseCode
		return 0
	end

else
begin
insert into IPDDiagnosis
(RoundNo, DiseaseCode, Notes, LoginID)
values
(@RoundNo, @DiseaseCode, @Notes, @LoginID)
return 0
end
go

/********************************************************************************************
exec uspEditIPDDiagnosis '10131540102', '33001', 'Patient reported1', 'Admin'
exec uspEditIPDDiagnosis '10131540102', '33002', 'Patient reported2', 'Admin'
exec uspEditIPDDiagnosis '10131540102', '33004', 'Patient reported4', 'Admin'
exec uspEditIPDDiagnosis '10134210101', '33001', 'Patient reported', 'Admin'

********************************************************************************************/
-- select * from IPDDoctor
-- select *  from IPDDiagnosis
-- delete from IPDDiagnosis

--------Get IPDDiagnosis-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDDiagnosis')
	drop proc uspGetIPDDiagnosis
go

create proc uspGetIPDDiagnosis(
@RoundNo as varchar(20) = null 
)with encryption as

if not (@RoundNo is null)
	begin
		select  RoundNo, IPDDiagnosis.DiseaseCode, DiseaseName, DiseaseCategoriesID, 
		dbo.GetLookupDataDes(DiseaseCategoriesID) as DiseaseCategories, Notes,
		dbo.GetStaffFullNameWithLoginID(LoginID) as CreatorFullName 
		from IPDDiagnosis
		inner join Diseases on IPDDiagnosis.DiseaseCode = Diseases.DiseaseCode
		where RoundNo = @RoundNo	
	end

if (@RoundNo is null)
	begin
		select  RoundNo, IPDDiagnosis.DiseaseCode, DiseaseName, DiseaseCategoriesID, 
		dbo.GetLookupDataDes(DiseaseCategoriesID) as DiseaseCategories, Notes,
		dbo.GetStaffFullNameWithLoginID(LoginID) as CreatorFullName 
		from IPDDiagnosis
		inner join Diseases on IPDDiagnosis.DiseaseCode = Diseases.DiseaseCode
	end
return 0

go

-- select * from IPDDiagnosis
-- exec uspGetIPDDiagnosis '10131540102'

--------GetIPDUniqueDiagnosis-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDUniqueDiagnosis')
	drop proc uspGetIPDUniqueDiagnosis
go

create proc uspGetIPDUniqueDiagnosis(
@AdmissionNo as varchar(20) = null 
)with encryption as

begin
	select distinct DiseaseName	from IPDDiagnosis
	inner join Diseases on IPDDiagnosis.DiseaseCode = Diseases.DiseaseCode
	inner join IPDDoctor on IPDDoctor.RoundNo = IPDDiagnosis.RoundNo
	where AdmissionNo = @AdmissionNo	
end

return 0

go

-- select * from IPDDiagnosis
-- exec uspGetIPDUniqueDiagnosis '111437001'

--------GetAdmissionDiagnosis-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAdmissionDiagnosis')
	drop proc uspGetAdmissionDiagnosis
go

create proc uspGetAdmissionDiagnosis(
@VisitNo as varchar(20)
)with encryption as

begin
	select IPDDiagnosis.DiseaseCode, DiseaseName	from IPDDiagnosis
	inner join Diseases on IPDDiagnosis.DiseaseCode = Diseases.DiseaseCode
	inner join IPDDoctor on IPDDoctor.RoundNo = IPDDiagnosis.RoundNo
	inner join Admissions on Admissions.AdmissionNo =IPDDoctor.AdmissionNo
	where VisitNo = @VisitNo	
end

return 0

go

/*select * from IPDDoctor
exec uspGetAdmissionDiagnosis 'P170000016001'
select * from  Admissions where AdmissionNo ='H1707001'
*/

------------------------------------------------------------------------------------------------------
-------------- IPDRadiologyReports -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert IPDRadiologyReports ------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertIPDRadiologyReports')
	drop proc uspInsertIPDRadiologyReports
go

create proc uspInsertIPDRadiologyReports(
@RoundNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ExamDateTime smalldatetime,
@Indication varchar(4000),
@Report varchar(4000),
@Conclusion varchar(4000),
@Radiologist varchar(10),
@RadiologyTitleID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDItems where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'IPD Items')
		return 1
	end

if exists(select RoundNo from IPDRadiologyReports where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID)
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Radiologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Radiologist', @Radiologist, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @RadiologyTitleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Radiology Title ID', @RadiologyTitleID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into IPDRadiologyReports
(RoundNo, ItemCode, ItemCategoryID, ExamDateTime, Indication, Report, Conclusion, Radiologist, RadiologyTitleID, LoginID)
values
(@RoundNo, @ItemCode, @ItemCategoryID, @ExamDateTime, @Indication, @Report, @Conclusion, @Radiologist, @RadiologyTitleID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertIPDRadiologyReports 'MED02001', 'E001', '7R', '22 Sep 2010 14:45', 'Report', 'Conclusion',
							   '100', 'Admin'

exec uspInsertIPDRadiologyReports 'MED02001', 'E002', '7R', '22 Sep 2010 14:45', 'Report', 'Conclusion',
							   '100', 'Admin'

exec uspInsertIPDRadiologyReports '100054001', 'E001', '7R', '22 Sep 2010 14:45', 'Report', 'Conclusion',
							   '100', 'Admin'

******************************************************************************************************/
-- select * from IPDRadiologyReports
-- delete from IPDRadiologyReports

-------------- Update IPDRadiologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDRadiologyReports')
	drop proc uspUpdateIPDRadiologyReports
go

create proc uspUpdateIPDRadiologyReports(
@RoundNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ExamDateTime smalldatetime,
@Indication varchar(4000),
@Report varchar(4000),
@Conclusion varchar(4000),
@Radiologist varchar(10),
@RadiologyTitleID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDRadiologyReports where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Radiology Reports')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Radiologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Radiologist', @Radiologist, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @RadiologyTitleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Radiology Title ID', @RadiologyTitleID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
	update IPDRadiologyReports set
	ExamDateTime = @ExamDateTime, Indication = @Indication, Report = @Report, Conclusion = @Conclusion, 
	Radiologist = @Radiologist, RadiologyTitleID = @RadiologyTitleID, LoginID = @LoginID
	where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDRadiologyReports '100054001', 'E001', '7R', '20 Sep 2010 11:45', 'Report2', 'Conclusion2',
							   '101', 'Admin'

******************************************************************************************************/
-- select * from IPDRadiologyReports
-- delete from IPDRadiologyReports

-------------- Get IPDRadiologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDRadiologyReports')
	drop proc uspGetIPDRadiologyReports
go

create proc uspGetIPDRadiologyReports(
@RoundNo varchar(20),
@ItemCode varchar(20) = null,
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not @RoundNo is null and @ItemCode is null and @ItemCategoryID is null)
	begin
		select RoundNo, ItemCode, ItemCategoryID, ExamDateTime, Indication, Report, Conclusion, Radiologist, 
		dbo.GetItemName(ItemCategoryID, ItemCode) as ExamName, dbo.GetStaffName(Radiologist)as RadiologistName,
		dbo.GetStaffFullName(Radiologist)as RadiologistFullName,
		RadiologyTitleID, dbo.GetLookupDataDes(RadiologyTitleID) as RadiologyTitle
		from IPDRadiologyReports
		where RoundNo = @RoundNo
	end
else
if (not @RoundNo is null and not @ItemCode is null and not @ItemCategoryID is null)
begin
	if not exists(select RoundNo from IPDRadiologyReports where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Radiology Reports')
			return 1
		end
	else
	begin
		select RoundNo, ItemCode, ItemCategoryID, ExamDateTime, Indication, Report, Conclusion, Radiologist, 
		dbo.GetItemName(ItemCategoryID, ItemCode) as ExamName, dbo.GetStaffName(Radiologist)as RadiologistName,
		dbo.GetStaffFullName(Radiologist)as RadiologistFullName,
		RadiologyTitleID, dbo.GetLookupDataDes(RadiologyTitleID) as RadiologyTitle
		from IPDRadiologyReports
		where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	end
end
return 0
go

/******************************************************************************************************
exec uspGetIPDRadiologyReports '100970002', 'E001', '7R'
exec uspGetIPDRadiologyReports '100970002'

******************************************************************************************************/
-- select * from IPDRadiologyReports
-- delete from IPDRadiologyReports

------------------------------------------------------------------------------------------------------
-------------- Discharges ----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Discharges ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertDischarges')
	drop proc uspInsertDischarges
go

create proc uspInsertDischarges(
@AdmissionNo varchar(20),
@StaffNo varchar(10),
@RoundNo varchar(20),
@DischargeDateTime smalldatetime,
@DischargeNotes varchar(2000),
@DischargeStatusID varchar(10),
@ReviewDate smalldatetime,
@History varchar(400) = null,
@Examination varchar(400) = null,
@KeyFindingsInvestigation varchar(400) = null,
@TreatmentOnWard varchar(400) = null,
@OutcomeOfTreatment varchar(400) = null,
@KeyRecommendations varchar(400) = null,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AdmissionNo from Admissions where AdmissionNo  = @AdmissionNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Admission No', @AdmissionNo, 'Admissions')
		return 1
	end

if exists(select AdmissionNo from Discharges where AdmissionNo = @AdmissionNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Admission No', @AdmissionNo)
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
		return 1
	end
	
if not (@RoundNo is null or @RoundNo = '') 
	begin
		if not exists(select RoundNo from IPDDoctor where RoundNo  = @RoundNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPD Doctor')
				return 1
			end
	end
else if (@RoundNo is null or @RoundNo = '')
begin set @RoundNo = null end

if not exists(select DataID from LookupData where DataID = @DischargeStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Discharge Status ID', @DischargeStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into Discharges
(AdmissionNo, StaffNo, RoundNo, DischargeDateTime, DischargeNotes, DischargeStatusID, ReviewDate,History,
Examination, KeyFindingsInvestigation, TreatmentOnWard, OutcomeOfTreatment, KeyRecommendations, LoginID)
values
(@AdmissionNo, @StaffNo, @RoundNo, @DischargeDateTime, @DischargeNotes, @DischargeStatusID, @ReviewDate,@History,
@Examination, @KeyFindingsInvestigation, @TreatmentOnWard, @OutcomeOfTreatment, @KeyRecommendations, @LoginID)

------------------------------------------------------------------------------------------------------------------
	declare @AdmissionStatusID varchar(10)		
	set @AdmissionStatusID = dbo.GetLookupDataID('AdmissionStatus', 'D')

	update Admissions set AdmissionStatusID = @AdmissionStatusID where AdmissionNo = @AdmissionNo	
------------------------------------------------------------------------------------------------------------------
return 0
end
go

/******************************************************************************************************
exec uspInsertDischarges '131105501', 'D001', '13110550102', '21 July 2013 15:04', 'Got Better', '35G', '24Jul13', 'Admin'
exec uspInsertDischarges '10046801', '15May10', 'Got Better', '35G', 'Admin'
exec uspInsertDischarges '10046802', '15May10', 'Got Better', '35G', 'Admin'

*******************************************************************************************************/
-- select * from Discharges
-- delete from Discharges

-- select * from Admissions 

-------------- Update Discharges ---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateDischarges')
	drop proc uspUpdateDischarges
go

create proc uspUpdateDischarges(
@AdmissionNo varchar(20),
@StaffNo varchar(10),
@RoundNo varchar(20),
@DischargeDateTime smalldatetime,
@DischargeNotes varchar(2000),
@DischargeStatusID varchar(10),
@ReviewDate smalldatetime,
@History varchar(400) = null,
@Examination varchar(400) = null,
@KeyFindingsInvestigation varchar(400) = null,
@TreatmentOnWard varchar(400) = null,
@OutcomeOfTreatment varchar(400) = null,
@KeyRecommendations varchar(400) = null,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AdmissionNo from Discharges where AdmissionNo = @AdmissionNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Admission No', @AdmissionNo, 'Discharges')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
		return 1
	end
	
if not (@RoundNo is null or @RoundNo = '') 
	begin
		if not exists(select RoundNo from IPDDoctor where RoundNo  = @RoundNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPD Doctor')
				return 1
			end
	end
else if (@RoundNo is null or @RoundNo = '')
begin set @RoundNo = null end

if not exists(select DataID from LookupData where DataID = @DischargeStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Discharge Status ID', @DischargeStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update Discharges set -- RoundNo = @RoundNo, 
StaffNo = @StaffNo, DischargeDateTime = @DischargeDateTime, DischargeNotes = @DischargeNotes, 
DischargeStatusID = @DischargeStatusID, ReviewDate = @ReviewDate, History = @History, 
Examination = @Examination, KeyFindingsInvestigation = @KeyFindingsInvestigation,
TreatmentOnWard = @TreatmentOnWard, OutcomeOfTreatment = @OutcomeOfTreatment, 
KeyRecommendations = @KeyRecommendations, LoginID = @LoginID
where AdmissionNo = @AdmissionNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateDischarges '131105501', 'D001', '13110550102', '21 July 2013 15:04', 'Got Better', '35G', '24Jul13', 'Admin'

*******************************************************************************************************/
-- select * from Discharges
-- delete from Discharges

-------------- Get Discharges ------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDischarges')
	drop proc uspGetDischarges
go

create proc uspGetDischarges(
@AdmissionNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AdmissionNo from Discharges where AdmissionNo = @AdmissionNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Admission No', @AdmissionNo, 'Discharges')
		return 1
	end
else
begin
	select AdmissionNo, StaffNo, dbo.GetStaffFullName(StaffNo) as StaffFullName, 
	dbo.FormatText(RoundNo, 'IPDDoctor', 'RoundNo') as RoundNo, DischargeDateTime, 
	DischargeStatusID, dbo.GetLookupDataDes(DischargeStatusID) as DischargeStatus, 
	DischargeNotes, dbo.FormatDate(dbo.GetNullDateValue(ReviewDate)) as ReviewDate,
	History, Examination, KeyFindingsInvestigation, TreatmentOnWard, 
	OutcomeOfTreatment, KeyRecommendations
	from Discharges
	where AdmissionNo = @AdmissionNo
return 0
end
go

/******************************************************************************************************
exec uspGetDischarges '131105501'

******************************************************************************************************/
-- select * from Discharges
-- delete from Discharges

------------------------------------------------------------------------------------------------------
------------- Deaths ---------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
----------Insert Deaths--------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertDeaths')
	drop proc uspInsertDeaths
go

create proc uspInsertDeaths(
@PatientNo varchar(20),
@DeathDate smalldatetime,
@Notes varchar(200),
@LoginID varchar(20),
@StaffNo varchar(10),
@TimeOfDeath varchar(8),
@PrimaryCauseOfDeath varchar(200),
@SecondaryCauseOfDeath varchar(200),
@OtherCauseOfDeath varchar(200)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Patients where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The Patient No: ' + @PatientNo + ', you are trying to enter does not exist in the registered patients'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if exists(select PatientNo from Deaths where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with Patient No: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1, @PatientNo)	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

 if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
            begin
                set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
                raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
                return 1
            end

else
begin
	insert into Deaths
	(PatientNo, DeathDate, Notes, LoginID,StaffNo, TimeOfDeath, PrimaryCauseOfDeath, SecondaryCauseOfDeath, OtherCauseOfDeath)
	values
	(@PatientNo, @DeathDate, @Notes, @LoginID,@StaffNo, @TimeOfDeath, @PrimaryCauseOfDeath, @SecondaryCauseOfDeath, @OtherCauseOfDeath)

--------------------------------------------------------------------------------------
	declare @DeceasedStatusID varchar(10)		
	set @DeceasedStatusID = dbo.GetLookupDataID('Status', 'D')
	
	update Patients set StatusID = @DeceasedStatusID where PatientNo = @PatientNo	
--------------------------------------------------------------------------------------
	return 0
end
go

/*************************************************************************************
--1-----------------------------------------------------------------------------------
exec uspInsertDeaths '071565', '22 Nov 2006', 'Very Ill', 'Kutegz','Staff001','12:05PM','Malaria','Headache','dehydration'
**************************************************************************************/
-- select * from Deaths where patientno = '0023/15'
-- delete from Deaths 

---------Update Deaths--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateDeaths')
	drop proc uspUpdateDeaths
go

create proc uspUpdateDeaths(
@PatientNo varchar(20),
@DeathDate smalldatetime,
@Notes varchar(200),
@LoginID varchar(20),
@StaffNo varchar(10),
@TimeOfDeath varchar(8),
@PrimaryCauseOfDeath varchar(200),
@SecondaryCauseOfDeath varchar(200),
@OtherCauseOfDeath varchar(200)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Deaths where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Patient No', @PatientNo, 'Deaths')	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end
 if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
            begin
                set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
                raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
                return 1
            end
else
begin
	Update Deaths set
	DeathDate = @DeathDate, Notes = @Notes, LoginID = @LoginID,StaffNo=@StaffNo, TimeOfDeath=@TimeOfDeath, PrimaryCauseOfDeath=@PrimaryCauseOfDeath, SecondaryCauseOfDeath=@SecondaryCauseOfDeath, OtherCauseOfDeath=@OtherCauseOfDeath
	where PatientNo = @PatientNo
	return 0
end
go

/*************************************************************************************
--1-----------------------------------------------------------------------------------
exec uspUpdateDeaths '071565', '22 Nov 2006', 'Very Ill', 'Kutegz','Staff001','12:05PM','Malaria','Headache','dehydration'
*************************************************************************************/
-- select * from Deaths
-- delete from Deaths


---------Delete Deaths--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspDeleteDeaths')
	drop proc uspDeleteDeaths
go

create proc uspDeleteDeaths(
@PatientNo varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Deaths where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Patient No', @PatientNo, 'Deaths')	
		return 1
	end
else

begin tran

delete Deaths where (PatientNo = @PatientNo)

--------------------------------------------------------------------------------------
	declare @TransferredOutStatusID varchar(10)		
	set @TransferredOutStatusID = dbo.GetLookupDataID('Status', 'A')
	
	update Patients set StatusID = @TransferredOutStatusID where PatientNo = @PatientNo	
--------------------------------------------------------------------------------------

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran

return 0
go

-- exec uspDeleteDeaths '114730'
-- select * from Deaths

--------Get Deaths-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDeaths')
	drop proc uspGetDeaths
go

create proc uspGetDeaths(
@PatientNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Deaths where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The Patient No: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, @PatientNo, 'Deaths')	
		return 1
	end
else
begin
	select PatientNo, DeathDate , Notes,StaffNo, TimeOfDeath, PrimaryCauseOfDeath, SecondaryCauseOfDeath, OtherCauseOfDeath,dbo.GetStaffFullName(Deaths.StaffNo) as StaffFullName
	from Deaths	
	where PatientNO = @PatientNo
end

return 0
go

-- select * from Deaths
-- exec uspGetDeaths '001289AM52744'

------------------------------------------------------------------------------------------------------
-------------- PurchaseOrders ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PurchaseOrders -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPurchaseOrders')
	drop proc uspInsertPurchaseOrders
go

create proc uspInsertPurchaseOrders(
@PurchaseOrderNo varchar(20),
@OrderDate smalldatetime,
@DocumentNo varchar(20),
@SupplierNo varchar(20),
@ShipAddress varchar(300),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @PurchaseOrderID int
declare @CurrentYear as char(2)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedPurchaseOrderID int
declare @PassedPurchaseOrderNo varchar(20)

if exists(select PurchaseOrderNo from PurchaseOrders where PurchaseOrderNo = @PurchaseOrderNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Purchase Order No', @PurchaseOrderNo)
		return 1
	end

if not exists(select SupplierNo from Suppliers where SupplierNo  = @SupplierNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Supplier No', @SupplierNo, 'Suppliers')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

---------------------------------------------------------------------------------------------------------------------
select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'PurchaseOrders' and AutoColumnName = 'PurchaseOrderNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'PurchaseOrders' and AutoColumnName = 'PurchaseOrderNo'

set @CurrentYear = right(year(getdate()),2)

if (@AutoColumnLEN = len(@PurchaseOrderNo)) and (left(@PurchaseOrderNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedPurchaseOrderID = 1
	set @PassedPurchaseOrderNo = @PurchaseOrderNo
	set @PassedPurchaseOrderNo = ltrim(rtrim(substring(@PassedPurchaseOrderNo, len(@CurrentYear) + 1, @PaddingLEN)))

	if isnumeric(@PassedPurchaseOrderNo) = 1 set @PassedPurchaseOrderID = @PassedPurchaseOrderNo
	else set @PassedPurchaseOrderID = 1

	set @PurchaseOrderID = (select max(PurchaseOrderID) from PurchaseOrders where left(PurchaseOrderNo, len(@CurrentYear)) = @CurrentYear)
	set @PurchaseOrderID = dbo.GetNextAutoNumber('PurchaseOrders', 'PurchaseOrderNo', @PurchaseOrderID)

	if @PassedPurchaseOrderID < @PurchaseOrderID set @PurchaseOrderID = @PassedPurchaseOrderID
	if @PassedPurchaseOrderID > @PurchaseOrderID set @PurchaseOrderID = @PassedPurchaseOrderID

end else set @PurchaseOrderID = 1

---------------------------------------------------------------------------------------------------------------------------

insert into PurchaseOrders
(PurchaseOrderID, PurchaseOrderNo, OrderDate, DocumentNo, SupplierNo, ShipAddress, LoginID, ClientMachine)
values
(@PurchaseOrderID, @PurchaseOrderNo, @OrderDate, @DocumentNo, @SupplierNo, @ShipAddress, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertPurchaseOrders

******************************************************************************************************/
-- select * from PurchaseOrders
-- delete from PurchaseOrders

-------------- Update PurchaseOrders -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePurchaseOrders')
	drop proc uspUpdatePurchaseOrders
go

create proc uspUpdatePurchaseOrders(
@PurchaseOrderNo varchar(20),
@OrderDate smalldatetime,
@DocumentNo varchar(20),
@SupplierNo varchar(20),
@ShipAddress varchar(300),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PurchaseOrderNo from PurchaseOrders where PurchaseOrderNo = @PurchaseOrderNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Purchase Order No', @PurchaseOrderNo, 'Purchase Orders')
		return 1
	end

if (dbo.GetIsPurchaseOrderReceived(@PurchaseOrderNo) = 1) 
	begin
		set @ErrorMSG = '%s: %s, is already received. You can''t update such an order!'
		raiserror(@ErrorMSG, 16, 1, 'Purchase Order No', @PurchaseOrderNo)
		return 1
	end

if not exists(select SupplierNo from Suppliers where SupplierNo  = @SupplierNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Supplier No', @SupplierNo, 'Suppliers')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update PurchaseOrders set
OrderDate = @OrderDate, DocumentNo = @DocumentNo, SupplierNo = @SupplierNo, 
ShipAddress = @ShipAddress, LoginID = @LoginID, ClientMachine = @ClientMachine
where PurchaseOrderNo = @PurchaseOrderNo
return 0
end
go

/******************************************************************************************************
exec uspUpdatePurchaseOrders
******************************************************************************************************/
-- select * from PurchaseOrders
-- delete from PurchaseOrders

-------------- Get PurchaseOrders -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPurchaseOrders')
	drop proc uspGetPurchaseOrders
go

create proc uspGetPurchaseOrders(
@PurchaseOrderNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PurchaseOrderNo from PurchaseOrders where PurchaseOrderNo = @PurchaseOrderNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Purchase Order No', @PurchaseOrderNo, 'Purchase Orders')
		return 1
	end
else
begin
	select PurchaseOrderNo, OrderDate, DocumentNo, SupplierNo, dbo.GetSupplierName(SupplierNo) as SupplierName, 
	dbo.GetSupplierFullName(SupplierNo) as SupplierFullName, ShipAddress
	from PurchaseOrders
	where PurchaseOrderNo = @PurchaseOrderNo
return 0
end
go

/******************************************************************************************************
exec uspGetPurchaseOrders
******************************************************************************************************/
-- select * from PurchaseOrders
-- delete from PurchaseOrders

--------GetNextPurchaseOrderID---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextPurchaseOrderID')
	drop proc uspGetNextPurchaseOrderID
go

create proc uspGetNextPurchaseOrderID(
@PurchaseOrderID int = null output
)with encryption as

declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @PurchaseOrderID = (select max(PurchaseOrderID) from PurchaseOrders where left(PurchaseOrderNo, 2) = @CurrentYear)
set @PurchaseOrderID = dbo.GetNextAutoNumber('PurchaseOrders', 'PurchaseOrderNo', @PurchaseOrderID)

return 0

go

-- exec uspGetNextPurchaseOrderID
-- select * from PurchaseOrders

-------- CountPurchaseOrderReceived -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountPurchaseOrderReceived')
	drop proc uspCountPurchaseOrderReceived
go

create proc uspCountPurchaseOrderReceived(
@PurchaseOrderNo varchar(20),
@NoOrderReceived tinyint = null output
)with encryption as

	set @NoOrderReceived = (select count(PurchaseOrderNo) from GoodsReceivedNote where PurchaseOrderNo = @PurchaseOrderNo)
	set @NoOrderReceived = isnull(@NoOrderReceived, 0)
	
return 0
go

-- exec uspCountPurchaseOrderReceived '0005'

--------GetPeriodicPurchaseOrders----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicPurchaseOrders')
	drop proc uspGetPeriodicPurchaseOrders
go

create proc uspGetPeriodicPurchaseOrders(
@StartDate smalldatetime,
@EndDate smalldatetime,
@IncludeReceived bit = 1
)with encryption as

declare @NotPaidID varchar(10)
declare @PaidID varchar(10)

set @NotPaidID =  dbo.GetLookupDataID('PayStatus', 'NP')
set @PaidID =  dbo.GetLookupDataID('PayStatus', 'PF')

if (@IncludeReceived = 0)
	begin
		select PurchaseOrderNo, dbo.FormatDate(OrderDate) as OrderDate,
		DocumentNo, dbo.GetSupplierName(SupplierNo) as SupplierName, 
		dbo.FormatMoney(dbo.GetPurchaseOrderAmount(PurchaseOrderNo)) as OrderAmount,	
		dbo.GetIsPurchaseOrderReceived(PurchaseOrderNo) as IsPurchaseOrderReceived,
		dbo.FormatMoney(dbo.GetPurchaseOrderPayAmount(PurchaseOrderNo,@NotPaidID)) as NotPaidAmount,
		dbo.FormatMoney(dbo.GetPurchaseOrderPayAmount(PurchaseOrderNo,@PaidID)) as PaidAmount,	
		dbo.FormatDate(PurchaseOrders.RecordDateTime) as RecordDate,
		dbo.GetTime(PurchaseOrders.RecordDateTime) as RecordTime
		from PurchaseOrders
		where OrderDate between @StartDate and @EndDate and (dbo.GetIsPurchaseOrderReceived(PurchaseOrderNo) = @IncludeReceived)
		order by OrderDate desc, PurchaseOrderNo desc
	end
else
	begin
		select PurchaseOrderNo, dbo.FormatDate(OrderDate) as OrderDate, 
		DocumentNo, dbo.GetSupplierName(SupplierNo) as SupplierName, 
		dbo.FormatMoney(dbo.GetPurchaseOrderAmount(PurchaseOrderNo)) as OrderAmount,
		dbo.FormatMoney(dbo.GetPurchaseOrderPayAmount(PurchaseOrderNo,@NotPaidID)) as NotPaidAmount,
		dbo.FormatMoney(dbo.GetPurchaseOrderPayAmount(PurchaseOrderNo,@PaidID)) as PaidAmount,	
		dbo.GetIsPurchaseOrderReceived(PurchaseOrderNo) as IsPurchaseOrderReceived,		
		dbo.FormatDate(PurchaseOrders.RecordDateTime) as RecordDate,
		dbo.GetTime(PurchaseOrders.RecordDateTime) as RecordTime
		from PurchaseOrders
		where OrderDate between @StartDate and @EndDate
		order by OrderDate desc, PurchaseOrderNo desc
	end
return 0
go

-- select * from PurchaseOrders
-- exec uspGetPeriodicPurchaseOrders 'May 12, 2015', 'May 13, 2017'
-- exec uspGetPeriodicPurchaseOrders 'May 12, 2015', 'May 13, 2017', 1


--------GetPurchaseOrdersNotPaidFor----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPurchaseOrdersNotPaidFor')
	drop proc uspGetPurchaseOrdersNotPaidFor
go

create proc uspGetPurchaseOrdersNotPaidFor(
@StartDate smalldatetime,
@EndDate smalldatetime,
@IncludeReceived bit = 1
)with encryption as

declare @CashBillModesID varchar(10)
declare @NotPaidID varchar(10)
declare @PaidID varchar(10)

set @NotPaidID =  dbo.GetLookupDataID('PayStatus', 'NP')
set @PaidID =  dbo.GetLookupDataID('PayStatus', 'PF')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')

	begin
		select GRNNo, PurchaseOrders.PurchaseOrderNo, dbo.FormatDate(OrderDate) as OrderDate, 
		DocumentNo, dbo.GetSupplierName(SupplierNo) as SupplierName, 
		dbo.FormatMoney(dbo.GetPurchaseOrderAmount(PurchaseOrders.PurchaseOrderNo)) as OrderAmount,
		dbo.FormatMoney(dbo.GetPurchaseOrderPayAmount(PurchaseOrders.PurchaseOrderNo,@NotPaidID)) as NotPaidAmount,
		dbo.FormatMoney(dbo.GetPurchaseOrderPayAmount(PurchaseOrders.PurchaseOrderNo,@PaidID)) as PaidAmount,	
		dbo.GetIsPurchaseOrderReceived(PurchaseOrders.PurchaseOrderNo) as IsPurchaseOrderReceived,		
		dbo.FormatDate(PurchaseOrders.RecordDateTime) as RecordDate,
		dbo.GetTime(PurchaseOrders.RecordDateTime) as RecordTime,
		dbo.FormatMoney(dbo.GetAccountBalance(@CashBillModesID, SupplierNo)) as AccountBalance
		from PurchaseOrders
		inner join GoodsReceivedNote on GoodsReceivedNote.PurchaseOrderNo =PurchaseOrders.PurchaseOrderNo
		where OrderDate between @StartDate and @EndDate
		and dbo.GetPurchaseOrderPayAmount(PurchaseOrders.PurchaseOrderNo,@NotPaidID) > 0
		order by OrderDate desc, PurchaseOrders.PurchaseOrderNo desc
	end
return 0
go

-- select * from PurchaseOrders
-- exec uspGetPurchaseOrdersNotPaidFor 'May 12, 2015', 'May 13, 2017'



------------------------------------------------------------------------------------------------------
-------------- PurchaseOrderDetails ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit PurchaseOrderDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditPurchaseOrderDetails')
	drop proc uspEditPurchaseOrderDetails
go

create proc uspEditPurchaseOrderDetails(
@PurchaseOrderNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@ItemName varchar(800),
@UnitMeasure varchar(100),
@ItemGroup varchar(100),
@Quantity int,
@Rate money,
@PackID varchar(10),
@PackSize int,
@VATValue money,
@Amount money,
@Notes varchar(200),
@StockStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

declare @DrugID varchar(10)
declare @ConsumableID varchar(10)

set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')

----------------------------------------------------------------------------------------------------------------------

if (@ItemCategoryID = @DrugID) and 
	(not exists(select DrugNo from Drugs where DrugNo = @ItemCode)) -- Drugs
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Drugs')	
			return 1
		end
	
else if (@ItemCategoryID = @ConsumableID) and 
	(not exists(select ConsumableNo from ConsumableItems where ConsumableNo  = @ItemCode)) -- Consumable Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Consumable Items')	
			return 1
		end
		
----------------------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @StockStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Stock Status ID', @StockStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @StockStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Stock Status ID', @StockStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select PurchaseOrderNo from PurchaseOrderDetails 
		where PurchaseOrderNo = @PurchaseOrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		---------------------------------------------------------------------------------------------------------
		update PurchaseOrderDetails set ItemName = @ItemName, UnitMeasure = @UnitMeasure, 
		ItemGroup = @ItemGroup, Quantity = @Quantity, Rate = @Rate, PackID=@PackID, PackSize=@PackSize, Amount = @Amount,VATValue=@VATValue, Notes = @Notes, 
		StockStatusID = @StockStatusID, LoginID = @LoginID, ClientMachine = @ClientMachine
		where PurchaseOrderNo = @PurchaseOrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
		return 0
		---------------------------------------------------------------------------------------------------------
	end
else
begin
insert into PurchaseOrderDetails
(PurchaseOrderNo, ItemCategoryID, ItemCode, ItemName, UnitMeasure, ItemGroup, 
Quantity, Rate,PackID, PackSize, Amount,VATValue,Notes, StockStatusID, LoginID, ClientMachine)
values
(@PurchaseOrderNo, @ItemCategoryID, @ItemCode, @ItemName, @UnitMeasure, @ItemGroup, 
@Quantity, @Rate, @PackID, @PackSize,@Amount,@VATValue, @Notes, @StockStatusID, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspEditPurchaseOrderDetails
******************************************************************************************************/
-- select * from PurchaseOrderDetails
-- delete from PurchaseOrderDetails

-------------- Get PurchaseOrderDetails -------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetPurchaseOrderDetails')
	drop proc uspGetPurchaseOrderDetails
go

create proc uspGetPurchaseOrderDetails(
@PurchaseOrderNo varchar(20),
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (@ItemCategoryID is null or @ItemCategoryID = '') 
begin
	select PurchaseOrderDetails.PurchaseOrderNo, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	ItemCode, ItemName, dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName, UnitMeasure, ItemGroup,Notes, 
	Quantity, Rate, PackID, dbo.GetLookUpDataDes(PackID) as Pack, PackSize, dbo.GetTotalOrdered(PurchaseOrderDetails.PurchaseOrderNo, ItemCategoryID,ItemCode) as TotalOrdered,
	dbo.GetVATPercentage(ItemCategoryID,ItemCode) as VATPercentage, ((Quantity*Rate*dbo.GetVATPercentage(ItemCategoryID,ItemCode))/100) as VATValue, Amount, Notes, StockStatusID, dbo.GetLookupDataDes(StockStatusID) as StockStatus 
	from PurchaseOrderDetails
	inner join PurchaseOrders on PurchaseOrderDetails.PurchaseOrderNo = PurchaseOrders.PurchaseOrderNo
	where PurchaseOrderDetails.PurchaseOrderNo = @PurchaseOrderNo
end
else
begin
	select PurchaseOrderDetails.PurchaseOrderNo, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	ItemCode, ItemName, dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName, UnitMeasure, ItemGroup,Notes, 
	Quantity, Rate, PackID,dbo.GetLookUpDataDes(PackID) as Pack, PackSize,dbo.GetTotalOrdered(PurchaseOrderDetails.PurchaseOrderNo, ItemCategoryID,ItemCode) as TotalOrdered,
	dbo.GetVATPercentage(ItemCategoryID,ItemCode) as VATPercentage, 
	((Quantity*Rate*dbo.GetVATPercentage(ItemCategoryID,ItemCode))/100) as VATValue, Amount, Notes, StockStatusID, dbo.GetLookupDataDes(StockStatusID) as StockStatus 
	from PurchaseOrderDetails
	inner join PurchaseOrders on PurchaseOrderDetails.PurchaseOrderNo = PurchaseOrders.PurchaseOrderNo
	where PurchaseOrderDetails.PurchaseOrderNo = @PurchaseOrderNo and ItemCategoryID = @ItemCategoryID
end	
return 0
go
go

/******************************************************************************************************
exec uspGetPurchaseOrderDetails '0004'
exec uspGetPurchaseOrderDetails '0004', '7D'
******************************************************************************************************/


if exists (select * from sysobjects where name = 'uspInsertGoodsReceivedNote')
	drop proc uspInsertGoodsReceivedNote
go

create proc uspInsertGoodsReceivedNote(
@GRNNo varchar(20),
@PurchaseOrderNo varchar(20),
@ReceivedDate smalldatetime,
@AdviceNoteNo varchar(20),
@DeliveryLocationID varchar(10),
@DiscountTotal money,
@TotalVAT money,
@AmountWords varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @GRNID int

if exists(select GRNNo from GoodsReceivedNote where GRNNo = @GRNNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'GRN No', @GRNNo)
		return 1
	end

if not exists(select PurchaseOrderNo from PurchaseOrders where PurchaseOrderNo  = @PurchaseOrderNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Purchase Order No', @PurchaseOrderNo, 'PurchaseOrders')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DeliveryLocationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Delivery Location ID', @DeliveryLocationID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

----------------------------------------------------------------------------------------------------
set @GRNID = (select max(GRNID) from GoodsReceivedNote)
set @GRNID = dbo.GetNextAutoNumber('GoodsReceivedNote', 'GRNNo', @GRNID)
----------------------------------------------------------------------------------------------------

insert into GoodsReceivedNote
(GRNID, GRNNo, PurchaseOrderNo, ReceivedDate, AdviceNoteNo, DeliveryLocationID, 
DiscountTotal,TotalVAT, AmountWords, LoginID, ClientMachine)
values
(@GRNID, @GRNNo, @PurchaseOrderNo, @ReceivedDate, @AdviceNoteNo, @DeliveryLocationID, 
@DiscountTotal, @TotalVAT, @AmountWords, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertGoodsReceivedNote

******************************************************************************************************/
-- select * from GoodsReceivedNote
-- delete from GoodsReceivedNote

-------------- Update GoodsReceivedNote -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateGoodsReceivedNote')
	drop proc uspUpdateGoodsReceivedNote
go

create proc uspUpdateGoodsReceivedNote(
@GRNNo varchar(20),
@PurchaseOrderNo varchar(20),
@ReceivedDate smalldatetime,
@AdviceNoteNo varchar(20),
@DeliveryLocationID varchar(10),
@DiscountTotal money,
@TotalVAT money,
@AmountWords varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select GRNNo from GoodsReceivedNote where GRNNo = @GRNNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'GRN No', @GRNNo, 'Goods Received Note')
		return 1
	end

if not exists(select PurchaseOrderNo from PurchaseOrders where PurchaseOrderNo  = @PurchaseOrderNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Purchase Order No', @PurchaseOrderNo, 'Purchase Orders')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DeliveryLocationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Delivery Location ID', @DeliveryLocationID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update GoodsReceivedNote set
PurchaseOrderNo = @PurchaseOrderNo, ReceivedDate = @ReceivedDate, AdviceNoteNo = @AdviceNoteNo, 
DeliveryLocationID = @DeliveryLocationID, DiscountTotal = @DiscountTotal,
 TotalVAT = @TotalVAT, 
AmountWords = @AmountWords, LoginID = @LoginID, 
ClientMachine = @ClientMachine
where GRNNo = @GRNNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateGoodsReceivedNote
******************************************************************************************************/
-- select * from GoodsReceivedNote
-- delete from GoodsReceivedNote

-------------- Get GoodsReceivedNote -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetGoodsReceivedNote')
	drop proc uspGetGoodsReceivedNote
go

create proc uspGetGoodsReceivedNote(
@GRNNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @NotPaidID varchar(10)
declare @PaidID varchar(10)

set @NotPaidID =  dbo.GetLookupDataID('PayStatus', 'NP')
set @PaidID =  dbo.GetLookupDataID('PayStatus', 'PF')

if not exists(select GRNNo from GoodsReceivedNote where GRNNo = @GRNNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'GRN No', @GRNNo, 'Goods Received Note')
		return 1
	end
else
begin
	select GRNNo, GoodsReceivedNote.PurchaseOrderNo, ReceivedDate, AdviceNoteNo, 
	DeliveryLocationID, dbo.GetLookupDataDes(DeliveryLocationID) as DeliveryLocation,
	supplierNo, 
	OrderDate, dbo.GetSupplierName(PurchaseOrders.SupplierNo) as SupplierName, 
	dbo.GetGoodsReceivedNoteTotalAmount(GoodsReceivedNote.GRNNo) as GrossAmount, DiscountTotal, 
	TotalVAT, dbo.GetGoodsReceivedNoteNetAmount(GoodsReceivedNote.GRNNo) as GRNAmount, AmountWords,
	dbo.FormatMoney(dbo.GetPurchaseOrderPayAmount(PurchaseOrders.PurchaseOrderNo,@NotPaidID)) as NotPaidAmount,
	dbo.FormatMoney(dbo.GetPurchaseOrderPayAmount(PurchaseOrders.PurchaseOrderNo,@PaidID)) as PaidAmount,
	dbo.FormatMoney(dbo.GetTotalGoodsReturnedAmount(GoodsReceivedNote.GRNNo)) as ReturnAmount,
	dbo.FormatMoney(dbo.GetPurchaseOrderPayAmount(PurchaseOrders.PurchaseOrderNo,@NotPaidID) -
	dbo.GetTotalGoodsReturnedAmount(GoodsReceivedNote.GRNNo)) as NetNotPaidAmount,
	dbo.FormatMoney(dbo.GetCashAccountBalance(supplierNo)) as CashAccountBalance,
	dbo.FormatMoney(dbo.GetOutstandingBalance(supplierNo)) as OutstandingBalance	
	from GoodsReceivedNote
	inner join PurchaseOrders on GoodsReceivedNote.PurchaseOrderNo = PurchaseOrders.PurchaseOrderNo	
	where GRNNo = @GRNNo
return 0
end
go

/******************************************************************************************************
exec uspGetGoodsReceivedNote '1700010001'
******************************************************************************************************/
-- select * from GoodsReceivedNote
-- delete from GoodsReceivedNote

--------GetNextGRNID-------------------------------------------------------------------------------------


if exists (select * from sysobjects where name = 'uspGetNextGRNID')
	drop proc uspGetNextGRNID
go

create proc uspGetNextGRNID(
@PurchaseOrderNo varchar(20),
@GRNID int = null output
)with encryption as

set @GRNID = (select max(GRNID) from GoodsReceivedNote where PurchaseOrderNo = @PurchaseOrderNo)
set @GRNID = dbo.GetNextAutoNumber('GoodsReceivedNote', 'GRNNo', @GRNID)

return 0

go

-- exec uspGetNextGRNID
-- select * from GoodsReceivedNote


------------GetPeriodicGoodsReceivedNote----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicGoodsReceivedNote')
	drop proc uspGetPeriodicGoodsReceivedNote
go

create proc uspGetPeriodicGoodsReceivedNote(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

begin
	select GRNNo, GoodsReceivedNote.PurchaseOrderNo, dbo.FormatDate(ReceivedDate) as ReceivedDate, 
	dbo.GetSupplierName(PurchaseOrders.SupplierNo) as SupplierName, 
	AdviceNoteNo, dbo.GetLookupDataDes(DeliveryLocationID) as DeliveryLocation, 
	dbo.FormatMoney(dbo.GetGoodsReceivedNoteTotalAmount(GoodsReceivedNote.GRNNo)) as GrossAmount, 
	dbo.FormatMoney(dbo.GetGoodsReceivedNoteNetAmount(GoodsReceivedNote.GRNNo)) as GRNAmount,
	dbo.FormatDate(GoodsReceivedNote.RecordDateTime) as RecordDate, 
	dbo.GetTime(GoodsReceivedNote.RecordDateTime) as RecordTime
	from GoodsReceivedNote
	inner join PurchaseOrders on GoodsReceivedNote.PurchaseOrderNo = PurchaseOrders.PurchaseOrderNo
	where ReceivedDate between @StartDate and @EndDate
	order by ReceivedDate desc, GRNNo desc
return 0
end
go
		
-- select * from GoodsReceivedNote
-- exec uspGetPeriodicGoodsReceivedNote 'May 12, 2015', 'May 13, 2016'

------------------------------------------------------------------------------------------------------
-------------- GoodsReceivedNoteDetails --------------------------------------------------------------
------------------------------------------------------------------------------------------------------


-------------- Edit GoodsReceivedNoteDetails ---------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditGoodsReceivedNoteDetails')
	drop proc uspEditGoodsReceivedNoteDetails
go

create proc uspEditGoodsReceivedNoteDetails(
@GRNNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@ItemName varchar(800),
@UnitMeasure varchar(100),
@OrderedQuantity int,
@ReceivedQuantity int,
@BonusQuantity int,
@Rate money,
@PackID varchar(10),
@PackSize int,
@Discount money,
@VATValue money,
@Amount money,
@PaystatusID varchar(10),
@BatchNo varchar(20),
@ExpiryDate smalldatetime,
@Notes varchar(100),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ReceivedStockStatusID varchar(10)
declare @PurchaseOrderNo varchar(20)
declare @OfferedItemStatus varchar(10)
declare @PendingItemStatus varchar(10)
declare @Balance int

----------------------------------------------------------------------------------------------------
set @ReceivedStockStatusID = dbo.GetLookupDataID('StockType', 'R')
set @PurchaseOrderNo = (select PurchaseOrderNo from GoodsReceivedNote where GRNNo = @GRNNo)
set @PurchaseOrderNo = isnull(@PurchaseOrderNo, '') 
--set @OfferedItemStatus = dbo.GetLookupDataID('ItemStatus', 'O')
--set @PendingItemStatus = dbo.GetLookupDataID('ItemStatus', 'P')
set @Balance = dbo.GetPurchaseOrderDetailsItemBalance(@PurchaseOrderNo, @ItemCategoryID, @ItemCode)
----------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Lookup Data')
		return 1
	end

	if not exists(select DataID from LookupData where DataID = @PackID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pack ID', @PackID, 'Lookup Data')
		return 1
	end

	if not exists(select DataID from LookupData where DataID = @PaystatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pay Status', @PaystatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select GRNNo from GoodsReceivedNoteDetails 
		where GRNNo = @GRNNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		---------------------------------------------------------------------------------------------------------
		update GoodsReceivedNoteDetails set ItemName = @ItemName, UnitMeasure = @UnitMeasure, OrderedQuantity = @OrderedQuantity, 
		ReceivedQuantity = @ReceivedQuantity, BonusQuantity = @BonusQuantity, Rate = @Rate,PackID=@PackID, PackSize=@PackSize,
		 Discount = @Discount, VATValue=@VATValue, 
		 Amount = @Amount,PaystatusID= @PaystatusID,
		BatchNo = @BatchNo, ExpiryDate = @ExpiryDate, Notes = @Notes, LoginID = @LoginID, ClientMachine = @ClientMachine										
		where GRNNo = @GRNNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
		return 0
		---------------------------------------------------------------------------------------------------------
	end
else

begin tran

--------------------------------------------------------------------------------------------------------------------
insert into GoodsReceivedNoteDetails
(GRNNo, ItemCategoryID, ItemCode, ItemName, UnitMeasure, OrderedQuantity, ReceivedQuantity, 
BonusQuantity, Rate, PackID, PackSize, Discount,VATValue, Amount,PaystatusID,BatchNo, ExpiryDate, Notes, LoginID, ClientMachine)
values
(@GRNNo, @ItemCategoryID, @ItemCode, @ItemName, @UnitMeasure, @OrderedQuantity, @ReceivedQuantity, 
@BonusQuantity, @Rate, @PackID,@PackSize, @Discount,@VATValue, @Amount,@PaystatusID, @BatchNo, @ExpiryDate, @Notes, @LoginID, @ClientMachine)
--------------------------------------------------------------------------------------------------------------------
if(@Balance > @ReceivedQuantity)
	begin
		update PurchaseOrderDetails set StockStatusID = @ReceivedStockStatusID
		where PurchaseOrderNo = @PurchaseOrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
	end
else if((@Balance = @ReceivedQuantity) and not(@Balance < @ReceivedQuantity))
	begin
		update PurchaseOrderDetails set StockStatusID = @ReceivedStockStatusID
		where PurchaseOrderNo = @PurchaseOrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
	end

--------------------------------------------------------------------------------------------------------------------


if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran

return 0

go


/******************************************************************************************************
exec uspEditGoodsReceivedNoteDetails
******************************************************************************************************/
-- select * from GoodsReceivedNoteDetails
-- delete from GoodsReceivedNoteDetails

-------------- Get GoodsReceivedNoteDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetGoodsReceivedNoteDetails')
	drop proc uspGetGoodsReceivedNoteDetails
go

create proc uspGetGoodsReceivedNoteDetails(
@GRNNo varchar(20),
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (@ItemCategoryID is null or @ItemCategoryID = '') 
begin
	select dbo.FormatDate(ReceivedDate) as ReceivedDate, GoodsReceivedNoteDetails.GRNNo, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	ItemCode, ItemName, dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName, UnitMeasure, OrderedQuantity,
	dbo.GetTotalOrdered (GoodsReceivedNote.PurchaseOrderNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalOrdered, 
	ReceivedQuantity, dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	 BonusQuantity, Rate,PackID, dbo.GetLookupDataDes(PackID) as Pack, PackSize, Discount, VATValue,Amount,
	 BatchNo, dbo.FormatDate(ExpiryDate) as ExpiryDate, Notes,
	dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode) as ReturnQuantity	
	from GoodsReceivedNoteDetails
	inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo = GoodsReceivedNote.GRNNo
	where GoodsReceivedNoteDetails.GRNNo = @GRNNo
end
else
begin
	select dbo.FormatDate(ReceivedDate) as ReceivedDate,GoodsReceivedNoteDetails.GRNNo, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) 
	as ItemCategory, ItemCode, ItemName, dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName, UnitMeasure, OrderedQuantity,
	dbo.GetTotalOrdered (GoodsReceivedNote.PurchaseOrderNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalOrdered, 
	ReceivedQuantity, dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	BonusQuantity, Rate,PackID,dbo.GetLookupDataDes(PackID) as Pack, PackSize, Discount, VATValue,Amount, BatchNo, 
	dbo.FormatDate(ExpiryDate) as ExpiryDate, Notes,
	dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode) as ReturnQuantity
	from GoodsReceivedNoteDetails
	inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo = GoodsReceivedNote.GRNNo
	where GoodsReceivedNoteDetails.GRNNo = @GRNNo and ItemCategoryID = @ItemCategoryID
end	
return 0
go

-----------------Update Paid Goods Received Note Details--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePaidGoodsReceivedNoteDetails')
	drop proc uspUpdatePaidGoodsReceivedNoteDetails
go

create proc uspUpdatePaidGoodsReceivedNoteDetails(
@GRNNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@PaystatusID varchar(10)
)with encryption as 

declare @ErrorMSG varchar(200)

if exists(select GRNNo from GoodsReceivedNoteDetails 
		where GRNNo = @GRNNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		---------------------------------------------------------------------------------------------------------
		update GoodsReceivedNoteDetails set PaystatusID= @PaystatusID
		where GRNNo = @GRNNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
		return 0
		---------------------------------------------------------------------------------------------------------
	end

return 0
go



-------------- Get Not Paid GoodsReceivedNoteDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNotPaidGoodsReceivedNoteDetails')
	drop proc uspGetNotPaidGoodsReceivedNoteDetails
go

create proc uspGetNotPaidGoodsReceivedNoteDetails(
@GRNNo varchar(20),
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @NotPaidPayStatus varchar(10)
set @NotPaidPayStatus = dbo.GetLookupDataID('PayStatus', 'NP')


begin
	select dbo.FormatDate(ReceivedDate) as ReceivedDate, GoodsReceivedNoteDetails.GRNNo, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	ItemCode, ItemName, dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName, UnitMeasure, OrderedQuantity,
	dbo.GetTotalOrdered (GoodsReceivedNote.PurchaseOrderNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalOrdered, 
	ReceivedQuantity, dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	 BonusQuantity, Rate,PackID, dbo.GetLookupDataDes(PackID) as Pack, PackSize, Discount, VATValue,Amount,
	 BatchNo, dbo.FormatDate(ExpiryDate) as ExpiryDate, Notes,
	dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode) as ReturnQuantity	
	from GoodsReceivedNoteDetails
	inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo = GoodsReceivedNote.GRNNo
	where GoodsReceivedNoteDetails.GRNNo = @GRNNo and PayStatusID =@NotPaidPayStatus
end

return 0
go

-- exec uspGetNotPaidGoodsReceivedNoteDetails

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGoodsReceivedDetailsSupplierHistory')
	drop proc uspGoodsReceivedDetailsSupplierHistory
go

create proc uspGoodsReceivedDetailsSupplierHistory(
@StartDate smalldatetime,
@EndDate smalldatetime,
@SupplierNo varchar(20)=null,
@ItemCategoryID varchar(10) = null,
@ItemCode varchar(20)=null
)with encryption as

declare @ErrorMSG varchar(200)
-------------------- All not null
if not @SupplierNo is null and not @ItemCategoryID is null and not @ItemCode is null 
begin
	select  Suppliers.SupplierNo as SupplierNo,SupplierName,ContactPerson,Address,Phone, dbo.FormatDate(ReceivedDate) as ReceivedDate, GoodsReceivedNoteDetails.GRNNo as GRNNo,
	 ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
	ItemCode, ItemName, UnitMeasure,BonusQuantity, Rate,PackID, dbo.GetLookupDataDes(PackID) as Pack, PackSize, Discount, Rate, VATValue, 
	dbo.GetTotalOrdered (GoodsReceivedNote.PurchaseOrderNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalOrdered, 
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode) as ReturnQuantity,
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode)*Rate as ReceivedAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) as TotalReceivedAmount,
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as ReturnAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) -
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as NetAmount, BatchNo, dbo.FormatDate(ExpiryDate) as ExpiryDate, Notes,
	dbo.FormatDateTime(GoodsReceivedNoteDetails.RecordDateTime) as RecordDateTime, GoodsReceivedNoteDetails.LoginID as LoginID
		
	from GoodsReceivedNoteDetails
	inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo  = GoodsReceivedNote.GRNNo
	inner join PurchaseOrders on GoodsReceivedNote.PurchaseOrderNo=PurchaseOrders.PurchaseOrderNo
	inner join Suppliers on Suppliers.SupplierNo=PurchaseOrders.SupplierNo
	where GoodsReceivedNoteDetails.RecordDateTime between @StartDate and @EndDate 
	and Suppliers.SupplierNo=@SupplierNo and GoodsReceivedNoteDetails.ItemCategoryID=@ItemCategoryID
	and GoodsReceivedNoteDetails.ItemCode=@ItemCode
end

------------------only GRRN nulll

else if  @SupplierNo is null and not @ItemCategoryID is null and not @ItemCode is null 
begin
	select  Suppliers.SupplierNo as SupplierNo,SupplierName,ContactPerson,Address,Phone, dbo.FormatDate(ReceivedDate) as ReceivedDate, GoodsReceivedNoteDetails.GRNNo as GRNNo,
	 ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
	ItemCode, ItemName, UnitMeasure,BonusQuantity, Rate,PackID, dbo.GetLookupDataDes(PackID) as Pack, PackSize, Discount, Rate, VATValue, 
	dbo.GetTotalOrdered (GoodsReceivedNote.PurchaseOrderNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalOrdered, 
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode) as ReturnQuantity,
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode)*Rate as ReceivedAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) as TotalReceivedAmount,
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as ReturnAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) -
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as NetAmount, BatchNo, dbo.FormatDate(ExpiryDate) as ExpiryDate, Notes,
	dbo.FormatDateTime(GoodsReceivedNoteDetails.RecordDateTime) as RecordDateTime, GoodsReceivedNoteDetails.LoginID as LoginID
		
	from GoodsReceivedNoteDetails
	inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo  = GoodsReceivedNote.GRNNo
	inner join PurchaseOrders on GoodsReceivedNote.PurchaseOrderNo=PurchaseOrders.PurchaseOrderNo
	inner join Suppliers on Suppliers.SupplierNo=PurchaseOrders.SupplierNo
	where GoodsReceivedNoteDetails.RecordDateTime between @StartDate and @EndDate 
	and  GoodsReceivedNoteDetails.ItemCategoryID=@ItemCategoryID
	and GoodsReceivedNoteDetails.ItemCode=@ItemCode
end

-------------------Only ItemCategory null
else if not @SupplierNo is null and  @ItemCategoryID is null and not @ItemCode is null 
begin
	select  Suppliers.SupplierNo as SupplierNo,SupplierName,ContactPerson,Address,Phone, dbo.FormatDate(ReceivedDate) as ReceivedDate, GoodsReceivedNoteDetails.GRNNo as GRNNo,
	 ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
	ItemCode, ItemName, UnitMeasure,BonusQuantity, Rate,PackID, dbo.GetLookupDataDes(PackID) as Pack, PackSize, Discount, Rate, VATValue, 
	dbo.GetTotalOrdered (GoodsReceivedNote.PurchaseOrderNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalOrdered, 
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode) as ReturnQuantity,
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode)*Rate as ReceivedAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) as TotalReceivedAmount,
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as ReturnAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) -
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as NetAmount, BatchNo, dbo.FormatDate(ExpiryDate) as ExpiryDate, Notes,
	dbo.FormatDateTime(GoodsReceivedNoteDetails.RecordDateTime) as RecordDateTime, GoodsReceivedNoteDetails.LoginID as LoginID
		
	from GoodsReceivedNoteDetails
	inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo  = GoodsReceivedNote.GRNNo
	inner join PurchaseOrders on GoodsReceivedNote.PurchaseOrderNo=PurchaseOrders.PurchaseOrderNo
	inner join Suppliers on Suppliers.SupplierNo=PurchaseOrders.SupplierNo
	where GoodsReceivedNoteDetails.RecordDateTime between @StartDate and @EndDate 
	and Suppliers.SupplierNo=@SupplierNo and GoodsReceivedNoteDetails.ItemCode=@ItemCode
end

--------------------------Only ItemCode null

else if not @SupplierNo is null and not @ItemCategoryID is null and  @ItemCode is null 
begin
	select  Suppliers.SupplierNo as SupplierNo,SupplierName,ContactPerson,Address,Phone, dbo.FormatDate(ReceivedDate) as ReceivedDate, GoodsReceivedNoteDetails.GRNNo as GRNNo,
	 ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
	ItemCode, ItemName, UnitMeasure,BonusQuantity, Rate,PackID, dbo.GetLookupDataDes(PackID) as Pack, PackSize, Discount, Rate, VATValue, 
	dbo.GetTotalOrdered (GoodsReceivedNote.PurchaseOrderNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalOrdered, 
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode) as ReturnQuantity,
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode)*Rate as ReceivedAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) as TotalReceivedAmount,
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as ReturnAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) -
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as NetAmount, BatchNo, dbo.FormatDate(ExpiryDate) as ExpiryDate, Notes,
	dbo.FormatDateTime(GoodsReceivedNoteDetails.RecordDateTime) as RecordDateTime, GoodsReceivedNoteDetails.LoginID as LoginID
		
	from GoodsReceivedNoteDetails
	inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo  = GoodsReceivedNote.GRNNo
	inner join PurchaseOrders on GoodsReceivedNote.PurchaseOrderNo=PurchaseOrders.PurchaseOrderNo
	inner join Suppliers on Suppliers.SupplierNo=PurchaseOrders.SupplierNo
	where GoodsReceivedNoteDetails.RecordDateTime between @StartDate and @EndDate 
	and Suppliers.SupplierNo=@SupplierNo and GoodsReceivedNoteDetails.ItemCategoryID=@ItemCategoryID
end

-------------------- GRRNO not null
else if not @SupplierNo is null and  @ItemCategoryID is null and  @ItemCode is null 
begin
	select  Suppliers.SupplierNo as SupplierNo,SupplierName,ContactPerson,Address,Phone, dbo.FormatDate(ReceivedDate) as ReceivedDate, GoodsReceivedNoteDetails.GRNNo as GRNNo,
	 ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
	ItemCode, ItemName, UnitMeasure,BonusQuantity, Rate,PackID, dbo.GetLookupDataDes(PackID) as Pack, PackSize, Discount, Rate, VATValue, 
	dbo.GetTotalOrdered (GoodsReceivedNote.PurchaseOrderNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalOrdered, 
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode) as ReturnQuantity,
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode)*Rate as ReceivedAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) as TotalReceivedAmount,
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as ReturnAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) -
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as NetAmount, BatchNo, dbo.FormatDate(ExpiryDate) as ExpiryDate, Notes,
	dbo.FormatDateTime(GoodsReceivedNoteDetails.RecordDateTime) as RecordDateTime, GoodsReceivedNoteDetails.LoginID as LoginID
		
	from GoodsReceivedNoteDetails
	inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo  = GoodsReceivedNote.GRNNo
	inner join PurchaseOrders on GoodsReceivedNote.PurchaseOrderNo=PurchaseOrders.PurchaseOrderNo
	inner join Suppliers on Suppliers.SupplierNo=PurchaseOrders.SupplierNo
	where GoodsReceivedNoteDetails.RecordDateTime between @StartDate and @EndDate 
	and Suppliers.SupplierNo=@SupplierNo 
end

-------------------- Only ItemCategory not null
else if  @SupplierNo is null and not @ItemCategoryID is null and  @ItemCode is null 
begin
	select  Suppliers.SupplierNo as SupplierNo,SupplierName,ContactPerson,Address,Phone, dbo.FormatDate(ReceivedDate) as ReceivedDate, GoodsReceivedNoteDetails.GRNNo as GRNNo,
	 ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
	ItemCode, ItemName, UnitMeasure,BonusQuantity, Rate,PackID, dbo.GetLookupDataDes(PackID) as Pack, PackSize, Discount, Rate, VATValue, 
	dbo.GetTotalOrdered (GoodsReceivedNote.PurchaseOrderNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalOrdered, 
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode) as ReturnQuantity,
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode)*Rate as ReceivedAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) as TotalReceivedAmount,
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as ReturnAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) -
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as NetAmount, BatchNo, dbo.FormatDate(ExpiryDate) as ExpiryDate, Notes,
	dbo.FormatDateTime(GoodsReceivedNoteDetails.RecordDateTime) as RecordDateTime, GoodsReceivedNoteDetails.LoginID as LoginID
		
	from GoodsReceivedNoteDetails
	inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo  = GoodsReceivedNote.GRNNo
	inner join PurchaseOrders on GoodsReceivedNote.PurchaseOrderNo=PurchaseOrders.PurchaseOrderNo
	inner join Suppliers on Suppliers.SupplierNo=PurchaseOrders.SupplierNo
	where GoodsReceivedNoteDetails.RecordDateTime between @StartDate and @EndDate 
	 and GoodsReceivedNoteDetails.ItemCategoryID=@ItemCategoryID
end

-------------------- ItemCode not null
else if  @SupplierNo is null and  @ItemCategoryID is null and not @ItemCode is null 
begin
	select  Suppliers.SupplierNo as SupplierNo,SupplierName,ContactPerson,Address,Phone, dbo.FormatDate(ReceivedDate) as ReceivedDate, GoodsReceivedNoteDetails.GRNNo as GRNNo,
	 ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
	ItemCode, ItemName, UnitMeasure,BonusQuantity, Rate,PackID, dbo.GetLookupDataDes(PackID) as Pack, PackSize, Discount, Rate, VATValue, 
	dbo.GetTotalOrdered (GoodsReceivedNote.PurchaseOrderNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalOrdered, 
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode) as ReturnQuantity,
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode)*Rate as ReceivedAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) as TotalReceivedAmount,
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as ReturnAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) -
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as NetAmount, BatchNo, dbo.FormatDate(ExpiryDate) as ExpiryDate, Notes,
	dbo.FormatDateTime(GoodsReceivedNoteDetails.RecordDateTime) as RecordDateTime, GoodsReceivedNoteDetails.LoginID as LoginID
		
	from GoodsReceivedNoteDetails
	inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo  = GoodsReceivedNote.GRNNo
	inner join PurchaseOrders on GoodsReceivedNote.PurchaseOrderNo=PurchaseOrders.PurchaseOrderNo
	inner join Suppliers on Suppliers.SupplierNo=PurchaseOrders.SupplierNo
	where GoodsReceivedNoteDetails.RecordDateTime between @StartDate and @EndDate 
	and GoodsReceivedNoteDetails.ItemCode=@ItemCode
end



	-------------------- All null
else
begin
	select  Suppliers.SupplierNo as SupplierNo,SupplierName,ContactPerson,Address,Phone, dbo.FormatDate(ReceivedDate) as ReceivedDate, GoodsReceivedNoteDetails.GRNNo as GRNNo,
	 ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
	ItemCode, ItemName, UnitMeasure,BonusQuantity, Rate,PackID, dbo.GetLookupDataDes(PackID) as Pack, PackSize, Discount, Rate, VATValue, 
	dbo.GetTotalOrdered (GoodsReceivedNote.PurchaseOrderNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalOrdered, 
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode) as ReturnQuantity,
	dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode)*Rate as ReceivedAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) as TotalReceivedAmount,
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as ReturnAmount,
	(((dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID
	,GoodsReceivedNoteDetails.ItemCode)*Rate)+VATValue)-Discount) -
	(dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,ItemCode)*Rate) as NetAmount, BatchNo, dbo.FormatDate(ExpiryDate) as ExpiryDate, Notes,
	dbo.FormatDateTime(GoodsReceivedNoteDetails.RecordDateTime) as RecordDateTime, GoodsReceivedNoteDetails.LoginID as LoginID
		
	from GoodsReceivedNoteDetails
	inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo  = GoodsReceivedNote.GRNNo
	inner join PurchaseOrders on GoodsReceivedNote.PurchaseOrderNo=PurchaseOrders.PurchaseOrderNo
	inner join Suppliers on Suppliers.SupplierNo=PurchaseOrders.SupplierNo
	where GoodsReceivedNoteDetails.RecordDateTime between @StartDate and @EndDate
end

return 0
go

----exec uspGoodsReceivedDetailsSupplierHistory 'jan 6 2016 23:00', 'jan 6 2017 23:00', 'S16005','7C','C00673'
----exec uspGoodsReceivedDetailsSupplierHistory 'jan 6 2016 23:00', 'jan 6 2017 23:00', 'S16005','7C',null
----exec uspGoodsReceivedDetailsSupplierHistory 'jan 6 2016 23:00', 'jan 6 2017 23:00', 'S16005',null,null
----exec uspGoodsReceivedDetailsSupplierHistory 'jan 6 2016 23:00', 'jan 6 2017 23:00', 'S16005',null,'C00673'
----exec uspGoodsReceivedDetailsSupplierHistory 'jan 6 2016 23:00', 'jan 6 2017 23:00', null,'7C','C00673'

----exec uspGoodsReceivedDetailsSupplierHistory 'jan 6 2016 23:00', 'jan 6 2017 23:00', 'S16002',null,'C00673'
----exec uspGoodsReceivedDetailsSupplierHistory 'jan 6 2016 23:00', 'jan 6 2017 23:00', null,null,'C00673'
----exec uspGoodsReceivedDetailsSupplierHistory 'jan 6 2016 23:00', 'jan 6 2017 23:00', 'S16005','7C',null
----exec uspGoodsReceivedDetailsSupplierHistory 'jan 6 2016 23:00', 'jan 6 2017 23:00', null,null,null


/******************************************************************************************************
exec uspGetGoodsReceivedNoteDetails '0004'
exec uspGetGoodsReceivedNoteDetails '0004', '7D'
******************************************************************************************************/
-- select * from GoodsReceivedNoteDetails
-- delete from GoodsReceivedNoteDetails


------------------------------------------------------------------------------------------------------
------------- Inventory ------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Inventory ----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertInventory')
	drop proc uspInsertInventory
go

create proc uspInsertInventory(
@LocationID varchar(10),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@TranDate smalldatetime,
@StockTypeID varchar(10),
@Quantity int,
@Details varchar(100),
@EntryModeID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40),
@BatchNo varchar(20) = null,
@ExpiryDate smalldatetime = null
)with encryption as 

declare @ErrorMSG varchar(200)
declare @ReceivedID varchar(10)
declare @IssuedID varchar(10)
declare @DrugCategoryID varchar(10)
declare @ConsumableCategoryID varchar(10)
declare @OtherItemsID varchar(10)
declare @OpticalCategoryID varchar(10)
declare @Balance int
declare @LocationUnits int
declare @TranID int

declare @LocationBatchNo varchar(20)
declare @LocationExpiryDate smalldatetime

declare @UnitCost money
declare @BranchID varchar(10)
declare @WeightedCostAverage money
declare @ManualEntryModeID varchar(10)

-------------------------------------------------------------
set @ReceivedID = dbo.GetLookupDataID('StockType', 'R')
set @IssuedID = dbo.GetLookupDataID('StockType', 'I')
set @DrugCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')
set @OtherItemsID = dbo.GetLookupDataID('ItemCategory', 'NM')
set @OpticalCategoryID = dbo.GetLookupDataID('ItemCategory', 'O')

set @Balance = 0 
set @LocationUnits = 0 
set @UnitCost= dbo.GetItemUnitCost(@ItemCategoryID, @ItemCode)
set @BranchID=dbo.GetMyCurrentBranch(@LoginID)
set @ManualEntryModeID= dbo.GetLookupDataID('EntryMode', 'MAN')

----------------------------------------------------------------------------------------------------------------------

if (@ItemCategoryID = @DrugCategoryID) and (not exists(select DrugNo from Drugs where DrugNo = @ItemCode)) -- Drugs
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Drugs')	
			return 1
		end
	
else if (@ItemCategoryID = @ConsumableCategoryID) and 
		(not exists(select ConsumableNo from ConsumableItems where ConsumableNo  = @ItemCode)) -- Consumable Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Consumable Items')	
			return 1
		end


else if (@ItemCategoryID = @OtherItemsID) and 
		(not exists(select ItemCode from OtherItems where ItemCode  = @ItemCode)) -- Other Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Other Items')	
			return 1
		end


else if (@ItemCategoryID = @OpticalCategoryID) and 
		(not exists(select OpticalCode from OpticalServices where OpticalCode  = @ItemCode)) -- Optical Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Optical Services')	
			return 1
		end
	
if (dbo.GetShortDate(@TranDate) > GetDate())
	begin		
		set @ErrorMSG = 'The %s: ' + ltrim(rtrim(dbo.FormatDate(dbo.GetShortDate(@TranDate)))) + ', you are trying to enter can''t be ahead of today’s date as set by server administrator'
		raiserror(@ErrorMSG, 16, 1, 'Transaction Date')
	 	return 1
	end

if not exists(select DataID from LookupData where DataID = @StockTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Stock Type ID', @EntryModeID, 'Lookup Data')	
		return 1
	end


if not exists(select DataID from LookupData where DataID = @EntryModeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Entry Mode ID', @EntryModeID, 'Lookup Data')
		return 1
	end

if not @StockTypeID in (@IssuedID, @ReceivedID)
	begin
		set @ErrorMSG = 'Stock Type must be only in 13I for Issued or 13R for Received'
		raiserror(@ErrorMSG, 16, 1)	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG, 16, 1, 'Login (Checked By) ID', @LoginID, 'Logins')	
		return 1
	end

else

begin tran

set @Balance = (select Balance from Inventory Where TranID = (select Max(TranID) 
				from Inventory where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode))

set @LocationUnits = (select LocationUnits from Inventory Where TranID = (select Max(TranID) from Inventory 
					where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode))

set @Balance = isnull(@Balance, 0)

set @LocationUnits = isnull(@LocationUnits, 0) 

---------------------------------------------------------------------------------------------------------------------------
set @LocationBatchNo = dbo.GetInventoryBatchNo(@LocationID, @ItemCategoryID, @ItemCode)
set @LocationExpiryDate = dbo.GetInventoryExpiryDate(@LocationID, @ItemCategoryID, @ItemCode)
set @WeightedCostAverage= @UnitCost --dbo.GetWeightedCostAverage(@ItemCategoryID,@ItemCode,@StockTypeID, @Quantity)
---------------------------------------------------------------------------------------------------------------------------

if @StockTypeID = @ReceivedID 
begin
	set @Balance = @Balance + @Quantity
	set @LocationUnits = @LocationUnits + @Quantity
end

if @StockTypeID = @IssuedID 
begin
	set @Balance = @Balance - @Quantity
	set @LocationUnits = @LocationUnits - @Quantity
end


---------------------------------------------------------------------------------------------------------------------------
if ((@StockTypeID = @ReceivedID) and not (@BatchNo is null or @BatchNo = ''))
begin 
	if (@ItemCategoryID = @DrugCategoryID) 
		begin
			update Drugs set UnitsInStock = @Balance, BatchNo = @BatchNo, ExpiryDate = @ExpiryDate, UnitCost = @UnitCost 
			where DrugNo = @ItemCode 
		end
		
	else if (@ItemCategoryID = @ConsumableCategoryID) 
		begin
			update ConsumableItems set UnitsInStock = @Balance, BatchNo = @BatchNo, ExpiryDate = @ExpiryDate, UnitCost = @UnitCost 
			where ConsumableNo = @ItemCode 
		end

	else if (@ItemCategoryID = @OtherItemsID) 
		begin
			update OtherItems set Quantity = @Balance, BatchNo = @BatchNo, ExpiryDate = @ExpiryDate, UnitCost = @UnitCost 
			where ItemCode = @ItemCode 
		end

     else if (@ItemCategoryID = @OpticalCategoryID) 
		begin
			update OtherItems set Quantity = @Balance, BatchNo = @BatchNo, ExpiryDate = @ExpiryDate, UnitCost = @UnitCost 
			where ItemCode = @ItemCode 
		end
	-------------------------------------------------------------------------------------------------------------
	exec uspEditInventoryLocation @LocationID, @ItemCategoryID, @ItemCode, @LocationUnits, @BatchNo, @ExpiryDate
	-------------------------------------------------------------------------------------------------------------
end 
else if (@Balance > 0) 
	begin
		if (@ItemCategoryID = @DrugCategoryID) 
			begin update Drugs set UnitsInStock = @Balance, UnitCost= @UnitCost where DrugNo = @ItemCode end
			
		else if (@ItemCategoryID = @ConsumableCategoryID) 
			begin update ConsumableItems set UnitsInStock = @Balance, UnitCost=@UnitCost where ConsumableNo = @ItemCode end	

			else if (@ItemCategoryID = @OtherItemsID) 
			begin update OtherItems set Quantity = @Balance, UnitCost=@UnitCost where ItemCode = @ItemCode end	
		---------------------------------------------------------------------------------------------------------
		if (@LocationUnits > 0)
			begin exec uspEditInventoryLocation @LocationID, @ItemCategoryID, @ItemCode, @LocationUnits end
		else begin exec uspEditInventoryLocation @LocationID, @ItemCategoryID, @ItemCode, @LocationUnits, 
											     @LocationBatchNo, @LocationExpiryDate end		 
		---------------------------------------------------------------------------------------------------------
	end
else 
begin
	if (@ItemCategoryID = @DrugCategoryID) 
		begin 
			update Drugs set UnitsInStock = @Balance, BatchNo = dbo.GetInventoryBatchNo(null, @ItemCategoryID, @ItemCode), 
			ExpiryDate = dbo.GetInventoryExpiryDate(null, @ItemCategoryID, @ItemCode), UnitCost=@UnitCost where DrugNo = @ItemCode 
		end
		
	else if (@ItemCategoryID = @ConsumableCategoryID) 
		begin 
			update ConsumableItems set UnitsInStock = @Balance, BatchNo = dbo.GetInventoryBatchNo(null, @ItemCategoryID, @ItemCode), 
			ExpiryDate = dbo.GetInventoryExpiryDate(null, @ItemCategoryID, @ItemCode), UnitCost=@UnitCost where ConsumableNo = @ItemCode 
		end

			else if (@ItemCategoryID = @OtherItemsID) 
		begin 
			update OtherItems set Quantity = @Balance, BatchNo = dbo.GetInventoryBatchNo(null, @ItemCategoryID, @ItemCode), 
			ExpiryDate = dbo.GetInventoryExpiryDate(null, @ItemCategoryID, @ItemCode), UnitCost=@UnitCost where ItemCode = @ItemCode 
		end
	
	-----------------------------------------------------------------------------------------------------------------------
	 if  (@LocationUnits > 0) 
		begin exec uspEditInventoryLocation @LocationID, @ItemCategoryID, @ItemCode, @LocationUnits end
	else begin exec uspEditInventoryLocation @LocationID, @ItemCategoryID, @ItemCode, @LocationUnits, 
											 @LocationBatchNo, @LocationExpiryDate end
	-----------------------------------------------------------------------------------------------------------------------	
end
---------------------------------------------------------------------------------------------------------------------------

insert into Inventory
(BranchID,LocationID, ItemCategoryID, ItemCode, UnitCost, TranDate, StockTypeID, Quantity, 
LocationUnits, Balance, WeightedCostAverage, Details, EntryModeID, LoginID, ClientMachine)
values
(@BranchID,@LocationID, @ItemCategoryID, @ItemCode,@UnitCost, @TranDate, @StockTypeID, @Quantity, 
@LocationUnits, @Balance, @WeightedCostAverage, @Details, @EntryModeID, @LoginID, @ClientMachine)

if ((@StockTypeID = @ReceivedID) and not (@BatchNo is null or @BatchNo = ''))
begin
	set @TranID = (select max(TranID) from Inventory where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	insert into InventoryReceiving (TranID, BatchNo, ExpiryDate) values (@TranID, @BatchNo, @ExpiryDate)
end

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran

return 0
go



/***********************************************************************************************************
------------------------------------------------------------------------------------------------------------
exec uspInsertInventory 'D001', '1 May 2012', '13I', 500, 'Stock Issued', 'Admin', 'BTN009', '1 May 2012'
exec uspInsertInventory 'D001', '1 May 2012', '13R', 800, 'Stock Received', 'Admin'
exec uspInsertInventory 'D001', '1 May 2012', '13R', 1000, 'Stock Received', 'Admin', 'BTN009', '1 May 2012'

***********************************************************************************************************/

-- select * from Inventory
-- select * from InventoryReceiving
-- delete from Inventory

--------GetInventoryBalance-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInventoryBalance')
	drop proc uspGetInventoryBalance
go

create proc uspGetInventoryBalance(
@LocationID varchar(10) = null, 
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@Balance int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @DrugCategoryID varchar(10)
declare @ConsumableCategoryID varchar(10)
declare @OtherItemsID varchar(10)
-------------------------------------------------------------------------------------------------------------------
set @DrugCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')
set @OtherItemsID = dbo.GetLookupDataID('ItemCategory', 'NM')
-------------------------------------------------------------------------------------------------------------------

if (@ItemCategoryID = @DrugCategoryID) and (not exists(select DrugNo from Drugs where DrugNo = @ItemCode)) -- Drugs
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Drugs')	
			return 1
		end
	
else if (@ItemCategoryID = @ConsumableCategoryID) and 
		(not exists(select ConsumableNo from ConsumableItems where ConsumableNo  = @ItemCode)) -- Consumable Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Consumable Items')	
			return 1
		end

else if (@ItemCategoryID = @OtherItemsID) and 
		(not exists(select ItemCode from OtherItems where ItemCode  = @ItemCode)) -- Other Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Other Items')	
			return 1
		end
		
begin set @Balance = dbo.GetInventoryBalance(@LocationID, @ItemCategoryID, @ItemCode) end

return 0
go

-- exec uspGetInventoryBalance '11701', '7D', 'M516'

--------GetAvailableStock------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAvailableStock')
	drop proc uspGetAvailableStock
go

create proc uspGetAvailableStock(
@DrugNo varchar(20),
@Balance int = null output
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DrugNo  from Drugs where DrugNo  = @DrugNo )
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered Drugs'
		raiserror(@ErrorMSG, 16, 1, 'Drug No', @DrugNo)	
		return 1
	end
else

begin
	set @Balance = dbo.GetAvailableStock(@DrugNo, getdate())
end
return 0
go

-- exec uspGetAvailableStock 'M112'


--------GetInventoryLogins----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInventoryLogins')
	drop proc uspGetInventoryLogins
go

create proc uspGetInventoryLogins(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime
)with encryption as

begin
	select distinct LoginID from 
	(select RecordDateTime, LoginID from Inventory
	union select RecordDateTime, LoginID from InventoryAcknowledges
	union select RecordDateTime, LoginID from InventoryOrderDetails
	union select RecordDateTime, LoginID from InventoryOrders
	union select RecordDateTime, LoginID from InventoryTransferDetails		
    union select RecordDateTime, LoginID from InventoryTransfers		
	) as InventoryLogins
	where RecordDateTime between @StartDateTime and @EndDateTime
end

return 0
go

/******************************************************************************************************
exec uspGetInventoryLogins '1 Aug 2013', '2 Sep 2013'
******************************************************************************************************/


-------- Get Available To Pay For Drugs ------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAvailableToPayForDrugs')
	drop proc uspGetAvailableToPayForDrugs
go

create proc uspGetAvailableToPayForDrugs(
@DrugNo varchar(20),
@Balance int = null output
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DrugNo  from Drugs where DrugNo  = @DrugNo )
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered Drugs'
		raiserror(@ErrorMSG, 16, 1, 'Drug No', @DrugNo)	
		return 1
	end
else

begin
	set @Balance = dbo.GetAvailableToPayForDrugs(@DrugNo, getdate())
end
return 0
go

-- exec uspGetAvailableToPayForDrugs 'DRG0014', '7'
------------------------------------------------------------------------------------------------------

-------------- InventoryLocation ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Get InventoryLocation -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInventoryLocation')
	drop proc uspGetInventoryLocation
go

create proc uspGetInventoryLocation(
@LocationID varchar(10) = null,
@ItemCategoryID varchar(10),
@ItemCode varchar(20) =null
)with encryption as

declare @ErrorMSG varchar(200)

if (@LocationID is null or @LocationID = '') 
	begin
		select LocationID, dbo.GetLookupDataDes(LocationID) as Location, 
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode, 
		dbo.GetItemName(ItemCategoryID,ItemCode) as ItemName,
		 dbo.GetMergedNameCode(dbo.GetItemName(ItemCategoryID,ItemCode),ItemCode) as ItemFullName,
		UnitsAtHand, BatchNo, dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)) as ExpiryDate
		from InventoryLocation
		where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
	end
	
	else
	if (@ItemCode is null or @ItemCode = '') 
	begin
		select LocationID, dbo.GetLookupDataDes(LocationID) as Location, 
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode, 
		dbo.GetItemName(ItemCategoryID,ItemCode) as ItemName,
		 dbo.GetMergedNameCode(dbo.GetItemName(ItemCategoryID,ItemCode),ItemCode) as ItemFullName,
		UnitsAtHand, BatchNo, dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)) as ExpiryDate
		from InventoryLocation
		where ItemCategoryID = @ItemCategoryID
	end

else
	begin
		select LocationID, dbo.GetLookupDataDes(LocationID) as Location, 
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
		ItemCode, dbo.GetItemName(ItemCategoryID,ItemCode) as ItemName,
		 dbo.GetMergedNameCode(dbo.GetItemName(ItemCategoryID,ItemCode),ItemCode) as ItemFullName, 
		UnitsAtHand, BatchNo, dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)) as ExpiryDate
		from InventoryLocation
		where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
	end
	
return 0
go
/******************************************************************************************************
exec uspGetInventoryLocation null, '7D', 'M423'
exec uspGetInventoryLocation '11702', '7D', 'M423'
exec uspGetInventoryLocation '11702', '7D', null
exec uspGetInventoryLocation null, null, null
******************************************************************************************************/
-- select * from InventoryLocation
-- delete from InventoryLocation

-------------- uspGetInventoryItemsLocation -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInventoryItemsLocation')
	drop proc uspGetInventoryItemsLocation
go

create proc uspGetInventoryItemsLocation(
@LocationID varchar(10),
@ItemCategoryID varchar(10),
@ItemCode varchar(20) =null
)with encryption as
if (@ItemCode is null or @ItemCode = '') 
	begin
		select LocationID, dbo.GetLookupDataDes(LocationID) as Location, 
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode, 
		dbo.GetItemName(ItemCategoryID,ItemCode) as ItemName,
		 dbo.GetMergedNameCode(dbo.GetItemName(ItemCategoryID,ItemCode),ItemCode) as ItemFullName,
		UnitsAtHand, BatchNo, dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)) as ExpiryDate
		from InventoryLocation
		where ItemCategoryID = @ItemCategoryID and ItemCategoryID = @ItemCategoryID
	end

else
	begin
		select LocationID, dbo.GetLookupDataDes(LocationID) as Location, 
		ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
		ItemCode, dbo.GetItemName(ItemCategoryID,ItemCode) as ItemName,
		 dbo.GetMergedNameCode(dbo.GetItemName(ItemCategoryID,ItemCode),ItemCode) as ItemFullName, 
		UnitsAtHand, BatchNo, dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)) as ExpiryDate
		from InventoryLocation
		where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
	end
	
return 0
go
/******************************************************************************************************
exec uspGetInventoryItemsLocation 11702, '7D', ''
exec uspGetInventoryItemsLocation 11702, '7C', null
******************************************************************************************************/
-- select * from InventoryLocation
-- delete from InventoryLocation


--------DistintInventoryLocationItemCategory---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDistintInventoryLocationItemCategory')
	drop proc uspGetDistintInventoryLocationItemCategory

go

create proc uspGetDistintInventoryLocationItemCategory
with encryption as

select distinct ItemCategoryID, dbo.GetLookUpDataDes(ItemCategoryID) as ItemCategory from InventoryLocation

return 0
go

----------------- exec uspGetDistintInventoryLocationItemCategory

--------GetDistintInventoryLocations---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDistintInventoryLocations')
	drop proc uspGetDistintInventoryLocations

go

create proc uspGetDistintInventoryLocations
with encryption as

select distinct LocationID, dbo.GetLookUpDataDes(LocationID) as Location from InventoryLocation

return 0
go

----------------- exec uspGetDistintInventoryLocations

-------------- Count To Order Inventory Location -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountToOrderInventoryLocation')
	drop proc uspCountToOrderInventoryLocation
go

create proc uspCountToOrderInventoryLocation(
@ItemCategoryID varchar(20), 
@LocationID varchar(20) = null,
@Hidden bit = 0,
@Records int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @itemDrug varchar(10)
declare @itemConsumable varchar(10)
---------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
set @itemDrug = dbo.GetLookupDataID('ItemCategory', 'D')
set @itemConsumable = dbo.GetLookupDataID('ItemCategory', 'C')
---------------------------------------------------------------------------------------------


begin
  if (not (@LocationID is null) and not(@ItemCategoryID =@itemConsumable) and (@ItemCategoryID = @itemDrug))
  
  begin
	set @Records = 	    (select Count(ItemCode) from InventoryLocation 
						inner join Drugs on Drugs.DrugNo = InventoryLocation.ItemCode	
						where Drugs.Hidden = @Hidden 
						and Drugs.OrderLevel >= dbo.GetInventoryBalance(null,@ItemCategoryID, DrugNo)
						and InventoryLocation.LocationID = @LocationID )					
  end
  else   if (not (@LocationID is null) and (@ItemCategoryID =@itemConsumable) and not(@ItemCategoryID = @itemDrug))
  
  begin
	set @Records = 	    (select Count(ItemCode) from InventoryLocation 
						inner join ConsumableItems on ConsumableItems.ConsumableNo = InventoryLocation.ItemCode	
						where ConsumableItems.Hidden = @Hidden 
						and ConsumableItems.OrderLevel >= dbo.GetInventoryBalance(null,@ItemCategoryID, ConsumableNo)
						and InventoryLocation.LocationID = @LocationID )					
  end
else if ( (@LocationID is null) and not(@ItemCategoryID =@itemConsumable) and (@ItemCategoryID = @itemDrug))
    begin
	set @Records =  (select Count(ItemCode) from InventoryLocation 
						inner join Drugs on Drugs.DrugNo = InventoryLocation.ItemCode	
						where Drugs.Hidden = @Hidden 
						and Drugs.OrderLevel >= dbo.GetInventoryBalance(null,@ItemCategoryID, DrugNo))
						
	end
	else if ( (@LocationID is null) and (@ItemCategoryID =@itemConsumable) and not(@ItemCategoryID = @itemDrug))
    begin
	set @Records =  (select Count(ItemCode) from InventoryLocation 
						inner join ConsumableItems on ConsumableItems.ConsumableNo = InventoryLocation.ItemCode	
						where ConsumableItems.Hidden = @Hidden 
						and ConsumableItems.OrderLevel >= dbo.GetInventoryBalance(null,@ItemCategoryID, ConsumableNo))
						
						
	end
	set @Records = isnull(@Records, 0)	
	print @records
	
end
return 0
go


--------GetPeriodicInventory-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicInventory')
	drop proc uspGetPeriodicInventory
go

create proc uspGetPeriodicInventory(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime,
@ItemCategoryID varchar(10)=null,
@ItemCode varchar(20) = null,
@BranchID varchar(10)=null,
@LocationID varchar(10) = null,
@LoginID varchar(20) = null
)with encryption as

--------------------------------------All not null-----------------------------------------

if not (@ItemCategoryID is null) and  not (@ItemCode is null) and not( @BranchID is null) and not (@LocationID is null)and not (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  ItemCategoryID=@ItemCategoryID and 
						ItemCode = @ItemCode and BranchID=@BranchID and LocationID=@LocationID and LoginID=@LoginID 
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	--------------------------------------only ItemCategory is null-----------------------------------------
else if (@ItemCategoryID is null) and  not (@ItemCode is null) and not( @BranchID is null) and not (@LocationID is null)and not (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 ItemCode = @ItemCode and BranchID=@BranchID and LocationID=@LocationID and LoginID=@LoginID  
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	
	--------------------------------------only ItemCode is null-----------------------------------------
else if not(@ItemCategoryID is null) and   (@ItemCode is null) and not( @BranchID is null) and not (@LocationID is null) and not (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 ItemCategoryID=@ItemCategoryID 
		and  BranchID=@BranchID and LocationID=@LocationID and LoginID=@LoginID  
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end
	--------------------------------------only BranchID is null-----------------------------------------

else if not (@ItemCategoryID is null) and  not (@ItemCode is null) and (@BranchID is null) and not (@LocationID is null)and not (@LoginID is null) 
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  ItemCategoryID=@ItemCategoryID and 
		ItemCode = @ItemCode and LocationID=@LocationID and LoginID=@LoginID 
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	--------------------------------------only LocationID is null-----------------------------------------
else if not (@ItemCategoryID is null) and  not (@ItemCode is null) and not (@BranchID is null) 
and  (@LocationID is null) and not (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 ItemCategoryID=@ItemCategoryID 
		and ItemCode = @ItemCode and BranchID=@BranchID and LoginID=@LoginID
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	--------------------------------------only LoginID is null-----------------------------------------
else if not (@ItemCategoryID is null) and  not (@ItemCode is null) and not (@BranchID is null) 
and not  (@LocationID is null) and  (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 ItemCategoryID=@ItemCategoryID 
		and ItemCode = @ItemCode and BranchID=@BranchID and LocationID=@LocationID
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end
	--------------------------------------ItemCategory and ItemCode not null -----------------------------------------
else if not (@ItemCategoryID is null) and  not (@ItemCode is null) and (@BranchID is null) and  (@LocationID is null) and  (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	--------------------------------------ItemCategory and BranchID not null-----------------------------------------

else if not (@ItemCategoryID is null) and   (@ItemCode is null) and not( @BranchID is null) and (@LocationID is null)  and (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode,@EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  ItemCategoryID=@ItemCategoryID  and BranchID=@BranchID
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	

--------------------------------------Only ItemCategoryID and LocationID not null-----------------------------------------

else if not (@ItemCategoryID is null) and   (@ItemCode is null) and (@BranchID is null) and not (@LocationID is null) and (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 ItemCategoryID=@ItemCategoryID and LocationID=@LocationID 
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end


	--------------------------------------Only ItemCategoryID and LoginID not null-----------------------------------------

else if not (@ItemCategoryID is null) and   (@ItemCode is null) and (@BranchID is null) and  (@LocationID is null) and not (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 ItemCategoryID=@ItemCategoryID and LoginID=@LoginID 
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	--------------------------------------ItemCode and BranchID not null -----------------------------------------
else if  (@ItemCategoryID is null) and  not (@ItemCode is null) and not(@BranchID is null) and  (@LocationID is null) and  (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode,@EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 BranchID=@BranchID and ItemCode=@ItemCode
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	--------------------------------------ItemCode and LocationID not null-----------------------------------------

else if  (@ItemCategoryID is null) and   not(@ItemCode is null) and (@BranchID is null) and not(@LocationID is null)  and (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode,@EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  ItemCode=@ItemCode  and LocationID=@LocationID
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	

--------------------------------------Only ItemCode and LoginID not null-----------------------------------------

else if (@ItemCategoryID is null) and not(@ItemCode is null) and (@BranchID is null) and  (@LocationID is null) and  not(@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 ItemCode=@ItemCode and LoginID=@LoginID 
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end



	--------------------------------------BranchID and LocationID not null -----------------------------------------
else if  (@ItemCategoryID is null) and   (@ItemCode is null) and not(@BranchID is null) and  not(@LocationID is null) and  (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 BranchID=@BranchID and LocationID=@LocationID
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	--------------------------------------BranchID and LoginID not null-----------------------------------------

else if  (@ItemCategoryID is null) and   (@ItemCode is null) and not(@BranchID is null) and (@LocationID is null)  and not(@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  BranchID=@BranchID  and LoginID=@LoginID
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

--------------------------------------LocationID and LoginID not null -----------------------------------------
else if  (@ItemCategoryID is null) and   (@ItemCode is null) and (@BranchID is null) and  not(@LocationID is null) and  not (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 LocationID=@LocationID and LoginID=@LoginID
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	-----------------------------ItemCategory and ItemCode  null -----------------------------------------
else if  (@ItemCategoryID is null) and   (@ItemCode is null) and not (@BranchID is null) and  not (@LocationID is null) and  not (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode,@EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  BranchID=@BranchID and LocationID=@LocationID and LoginID=@LoginID 
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	--------------------------------------ItemCategory and BranchID  null-----------------------------------------

else if  (@ItemCategoryID is null) and   not (@ItemCode is null) and ( @BranchID is null) and not (@LocationID is null)  and not (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  ItemCode = @ItemCode and LocationID=@LocationID and LoginID=@LoginID 
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	

--------------------------------------Only ItemCategoryID and LocationID  null-----------------------------------------

else if (@ItemCategoryID is null) and   not (@ItemCode is null) and not (@BranchID is null) and  (@LocationID is null) and not (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 ItemCode = @ItemCode and BranchID=@BranchID and LoginID=@LoginID 
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end


	--------------------------------------Only ItemCategoryID and LoginID  null-----------------------------------------

else if  (@ItemCategoryID is null) and  not (@ItemCode is null) and not(@BranchID is null) and  not(@LocationID is null) and  (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 ItemCode = @ItemCode and BranchID=@BranchID and LocationID=@LocationID
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	--------------------------------------ItemCode and BranchID  null -----------------------------------------
else if not (@ItemCategoryID is null) and   (@ItemCode is null) and (@BranchID is null) and not (@LocationID is null) and  not (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  ItemCategoryID=@ItemCategoryID and LocationID=@LocationID and LoginID=@LoginID 
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	--------------------------------------ItemCode and LocationID  null-----------------------------------------

else if  not (@ItemCategoryID is null) and   (@ItemCode is null) and not(@BranchID is null) and (@LocationID is null)  and not (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  ItemCategoryID=@ItemCategoryID  and BranchID=@BranchID  and LoginID=@LoginID 
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	

--------------------------------------Only ItemCode and LoginID null-----------------------------------------

else if not (@ItemCategoryID is null) and (@ItemCode is null) and not (@BranchID is null) and  not (@LocationID is null) and (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  ItemCategoryID=@ItemCategoryID and BranchID=@BranchID and LocationID=@LocationID  
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end



	--------------------------------------BranchID and LocationID  null -----------------------------------------
else if  not(@ItemCategoryID is null) and   not(@ItemCode is null) and (@BranchID is null) and  (@LocationID is null) and  not(@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  ItemCategoryID=@ItemCategoryID and ItemCode = @ItemCode and LoginID=@LoginID 
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	--------------------------------------BranchID and LoginID null-----------------------------------------

else if  not (@ItemCategoryID is null) and   not(@ItemCode is null) and (@BranchID is null) and not (@LocationID is null)  and (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  ItemCategoryID=@ItemCategoryID and
		 ItemCode = @ItemCode  and LocationID=@LocationID order by dbo.GetItemName(ItemCategoryID, ItemCode)
end
--------------------------------------LocationID and LoginID null -----------------------------------------
else if not (@ItemCategoryID is null) and   not(@ItemCode is null) and not(@BranchID is null) and  (@LocationID is null) and  (@LoginID is null)
	
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  ItemCategoryID=@ItemCategoryID and ItemCode = @ItemCode and BranchID=@BranchID 
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end


	--------------------------------------------Only ItemCategoryID not null-----------------------------------------

else if not (@ItemCategoryID is null) and   (@ItemCode is null) and ( @BranchID is null) and  (@LocationID is null) and  (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						  ItemCategoryID=@ItemCategoryID
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	--------------------------------------Only ItemCode not null-----------------------------------------

else if  (@ItemCategoryID is null) and  not (@ItemCode is null)  and (@BranchID is null) and  (@LocationID is null) and  (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						   ItemCode = @ItemCode
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end
	--------------------------------------Only BranchID not null-----------------------------------------

else if  (@ItemCategoryID is null) and   (@ItemCode is null)  and not (@BranchID is null) and  (@LocationID is null) and  (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						   @BranchID = @BranchID
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

	--------------------------------------Only LocationID not null-----------------------------------------

else if  (@ItemCategoryID is null) and   (@ItemCode is null)  and (@BranchID is null) and not (@LocationID is null) and  (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						 LocationID = @LocationID
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end


	--------------------------------------Only LoginID  not null-----------------------------------------

else if  (@ItemCategoryID is null) and   (@ItemCode is null)  and (@BranchID is null) and (@LocationID is null) and  not (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory 
		where TranID=dbo.GetMaxInventoryTransID(LocationID,ItemCategoryID,ItemCode, @EndDateTime) and  
						   LoginID  = @LoginID 
		order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end


--------------------------------------all null-----------------------------------------

else if  (@ItemCategoryID is null) and  (@ItemCode is null)  and (@BranchID is null) and  (@LocationID is null) and  (@LoginID is null)
	begin
		select distinct ItemCode, dbo.FormatDate(TranDate) as TranDate,dbo.GetLookupDataDes(dbo.GetMyCurrentBranch(LoginID)) as BranchName,LoginID,ItemCode,ItemCategoryID, 
		dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ItemCode,
		 LocationID,dbo.GetLookupDataDes(LocationID)as Location,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, dbo.FormatMoney(UnitCost) as UnitCost, 
		Quantity,StockTypeID, dbo.GetLookupDataDes(StockTypeID) as StockType,Balance,dbo.FormatMoney(WeightedCostAverage*Balance) as StockCostValue,
		dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime) as StartBalance,
		dbo.FormatMoney(dbo.GetInventoryStartBalance(LocationID, ItemCategoryID, ItemCode, @StartDateTime)*WeightedCostAverage) as StartCostValue,
		dbo.FormatMoney(dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime)*WeightedCostAverage) as EndCostValue,
		dbo.GetInventoryEndBalance(LocationID, ItemCategoryID, ItemCode, @EndDateTime) as EndBalance,
		dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalReceived,
		dbo.FormatMoney(dbo.GetInventoryTotalReceived(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalReceivedCostValue,
		dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalIssued,
		dbo.FormatMoney(dbo.GetInventoryTotalIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime)*WeightedCostAverage) as TotalIssuedCostValue,
		dbo.GetInventoryTotalManualIssued(LocationID, ItemCategoryID, ItemCode, @StartDateTime, @EndDateTime) as TotalManualIssued,WeightedCostAverage,
		dbo.FormatDate(RecordDateTime) as RecordDate,dbo.FormatDateTime(RecordDateTime) as RecordDateTime
		from Inventory order by dbo.GetItemName(ItemCategoryID, ItemCode)
	end

go
/******************************************************************************************************/
-- select distinct ItemCode, * from Inventory order by RecordDateTime desc
-- exec uspGetPeriodicInventory '2014-08-30 00:26:00', '2016-12-30 00:36:00','7C','C224','177NA','11702','admin'
-- exec uspGetPeriodicInventory '2014-07-30 00:26:00', '2014-08-30 00:36:00', null,null,'177NA','11702','admin'





-- select * from Drugs
-- exec uspCountToOrderInventoryLocation drugs,'11701',4000, null
-- exec uspCountToOrderInventoryLocation 60, 0
--exec uspCountToOrderInventoryLocation '7d','11719',365

----------------CountToExpireInventoryLocation----------------------------------------------

if exists (select * from sysobjects where name = 'uspCountToExpireInventoryLocation')
	drop proc uspCountToExpireInventoryLocation
go

create proc uspCountToExpireInventoryLocation(
@ItemCategoryID varchar(20), 
@LocationID varchar(20) = null,
@ExpiryWarningDays int,
@Hidden bit = 0,
@Records int = null output
)with encryption as

declare @ErrorMSG varchar(200)

---------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
---------------------------------------------------------------------------------------------

begin
  if (not (@LocationID is null) )
  begin
	set @Records = (select Count(ItemCode) from InventoryLocation 
					where ItemCategoryID = @ItemCategoryID and LocationID = @LocationID  and UnitsAtHand > 0 
					and	dbo.GetIsItemHidden(@ItemCategoryID, ItemCode) = @Hidden
					and not dbo.GetNullDateValue(InventoryLocation.ExpiryDate) is null
					and (dbo.GetExpiryRemainingDays(getdate(), InventoryLocation.ExpiryDate) <= @ExpiryWarningDays)) 

end
else if ( (@LocationID is null) )
  begin
	set @Records = (select Count(ItemCode) from InventoryLocation 
					where ItemCategoryID = @ItemCategoryID  and UnitsAtHand > 0 
					and	dbo.GetIsItemHidden(@ItemCategoryID, ItemCode) = @Hidden
					and not dbo.GetNullDateValue(InventoryLocation.ExpiryDate) is null
					and (dbo.GetExpiryRemainingDays(getdate(), InventoryLocation.ExpiryDate) <= @ExpiryWarningDays)) 
	end
	set @Records = isnull(@Records, 0)	
	print @records
end

return 0

go

-- select * from Drugs
-- exec uspCountToExpireInventoryLocation drugs,'11701',4000, null
-- exec uspCountToExpireInventoryLocation 60, 0
--exec uspCountToExpireInventoryLocation '7c','11719',365


----------------CountToOrderInventoryLocation----------------------------------------------

if exists (select * from sysobjects where name = 'uspCountToOrderInventoryLocation')
	drop proc uspCountToOrderInventoryLocation
go

create proc uspCountToOrderInventoryLocation(
@ItemCategoryID varchar(20), 
@LocationID varchar(20) = null,
@Hidden bit = 0,
@Records int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @itemDrug varchar(10)
declare @itemConsumable varchar(10)
---------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
set @itemDrug = dbo.GetLookupDataID('ItemCategory', 'D')
set @itemConsumable = dbo.GetLookupDataID('ItemCategory', 'C')
---------------------------------------------------------------------------------------------

  if (not (@LocationID is null) )
  begin
	set @Records = 	   (select Count(InventoryLocation.ItemCode) from InventoryLocation 
						inner join ItemLocationOrderLevels on ItemLocationOrderLevels.ItemCode = InventoryLocation.ItemCode		
	                    where InventoryLocation.ItemCategoryID = @ItemCategoryID 
	                    and InventoryLocation.LocationID = @LocationID 
	                    and ItemLocationOrderLevels.LocationID = @LocationID 
	                    and UnitsAtHand <= ItemLocationOrderLevels.LocationOrderLevel)						
								
  end
  
  else if ( (@LocationID is null) )
  begin 
	set @Records = (select Count(DrugNo) from Drugs where Hidden = @Hidden 
					and OrderLevel >= dbo.GetInventoryBalance(null, @ItemCategoryID , DrugNo))
  end
	set @Records = isnull(@Records, 0)	
	print @records
	

return 0
go

-- select * from Drugs
-- exec uspCountToOrderInventoryLocation drugs,'11701',4000, null
-- exec uspCountToOrderInventoryLocation 60, 0
--exec uspCountToOrderInventoryLocation '7d','11719',365
--exec uspCountToOrderInventoryLocation '7d',11701
--exec uspCountToOrderInventoryLocation '7d',null

----------------Count To Expire Inventory Location----------------------------------------------

if exists (select * from sysobjects where name = 'uspCountToExpireInventoryLocation')
	drop proc uspCountToExpireInventoryLocation
go

create proc uspCountToExpireInventoryLocation(
@ItemCategoryID varchar(20), 
@LocationID varchar(20) = null,
@ExpiryWarningDays int,
@Hidden bit = 0,
@Records int = null output
)with encryption as

declare @ErrorMSG varchar(200)

---------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
---------------------------------------------------------------------------------------------

begin
  if (not (@LocationID is null) )
  begin
	set @Records = (select Count(ItemCode) from InventoryLocation 
					where ItemCategoryID = @ItemCategoryID and LocationID = @LocationID  and UnitsAtHand > 0 
					and	dbo.GetIsItemHidden(@ItemCategoryID, ItemCode) = @Hidden
					and not dbo.GetNullDateValue(InventoryLocation.ExpiryDate) is null
					and (dbo.GetExpiryRemainingDays(getdate(), InventoryLocation.ExpiryDate) <= @ExpiryWarningDays)) 

end
else if ( (@LocationID is null) )
  begin
	set @Records = (select Count(ItemCode) from InventoryLocation 
					where ItemCategoryID = @ItemCategoryID  and UnitsAtHand > 0 
					and	dbo.GetIsItemHidden(@ItemCategoryID, ItemCode) = @Hidden
					and not dbo.GetNullDateValue(InventoryLocation.ExpiryDate) is null
					and (dbo.GetExpiryRemainingDays(getdate(), InventoryLocation.ExpiryDate) <= @ExpiryWarningDays)) 
	end
	set @Records = isnull(@Records, 0)	
	print @records
end

return 0

go

-- select * from Drugs
-- exec uspCountToExpireInventoryLocation drugs,'11701',4000, null
-- exec uspCountToExpireInventoryLocation 60, 0
--exec uspCountToExpireInventoryLocation '7c','11701',60

----------------Count To Order Inventory Location----------------------------------------------

if exists (select * from sysobjects where name = 'uspCountToOrderInventoryLocation')
	drop proc uspCountToOrderInventoryLocation
go

create proc uspCountToOrderInventoryLocation(
@ItemCategoryID varchar(20), 
@LocationID varchar(20) = null,
@Hidden bit = 0,
@Records int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
---------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
---------------------------------------------------------------------------------------------
  if ((not (@LocationID is null)) and ((@ItemCategoryID = @DrugID)or(@ItemCategoryID = @ConsumableID)))
  begin
	set @Records = 	   (select Count(InventoryLocation.ItemCode) from InventoryLocation 
	
	                    where InventoryLocation.ItemCategoryID = @ItemCategoryID 
	                    and InventoryLocation.LocationID = @LocationID 
	                    and UnitsAtHand <= dbo.GetItemLocationOrderLevel(@LocationID, @ItemCategoryID, InventoryLocation.ItemCode))						
								
  end
  
  else if ( (@LocationID is null) and ((@ItemCategoryID = @DrugID)or(@ItemCategoryID = @ConsumableID)))
  begin 
	set @Records = (select Count(DrugNo) from Drugs where Hidden = @Hidden 
					and OrderLevel >= dbo.GetInventoryBalance(null, @ItemCategoryID , DrugNo))
  end
  else if ( (@LocationID is null) and not((@ItemCategoryID = @DrugID)or(@ItemCategoryID = @ConsumableID)))
  begin
   set @records = null
 end
 
 else if ( not(@LocationID is null) and not((@ItemCategoryID = @DrugID)or(@ItemCategoryID = @ConsumableID)))
  begin
   set @records = null
 end
	set @Records = isnull(@Records, 0)	
	print @records
	

return 0
go

-- select * from Drugs
-- exec uspCountToOrderInventoryLocation drugs,'11701',4000, null
-- exec uspCountToOrderInventoryLocation 60, 0
--exec uspCountToOrderInventoryLocation '7d','11719',365
--exec uspCountToOrderInventoryLocation '7d',11717
--exec uspCountToOrderInventoryLocation '7d',null
--------GetToCountToExpireInventoryLocation-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetToCountToExpireInventoryLocation')
	drop proc uspGetToCountToExpireInventoryLocation
go

create proc uspGetToCountToExpireInventoryLocation(
@LocationID varchar(20) = null,
@ItemCategoryID varchar(10),
@ExpiryWarningDays int,
@Hidden bit = 0
--@ItemCode varchar(20),
--@Balance int = null output
)with encryption as 


------------------------------------------------------------------------------------------------------------
declare @ErrorMSG varchar(200)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
------------------------------------------------------------------------------------------------------------
if ((not (@LocationID is null)) and ((@ItemCategoryID = @DrugID)or(@ItemCategoryID = @ConsumableID)))
  begin
(select 
dbo.GetLookupDataDes(InventoryLocation.LocationID) as Location, ItemCode,
dbo.GetItemName(inventoryLocation.ItemCategoryID, inventoryLocation.ItemCode) as ItemName,		
dbo.GetUnitMeasure(inventoryLocation.ItemCategoryID, inventoryLocation.ItemCode) as UnitMeasure,		
dbo.GetMergedNameCode(dbo.GetItemName(inventoryLocation.ItemCategoryID, inventoryLocation.ItemCode), inventoryLocation.ItemCode) as ItemFullName,
UnitsAtHand,
dbo.GetItemLocationOrderLevel(@LocationID, @ItemCategoryID, ItemCode) as OrderLevel,
dbo.GetItemUnitCost(@ItemCategoryID, InventoryLocation.ItemCode) as UnitCost,
ExpiryDate, BatchNo,
dbo.GetExpiryRemainingDays(getdate(),InventoryLocation.ExpiryDate) as ExpiryRemainingDays
-- dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure
from InventoryLocation
where ItemCategoryID = @ItemCategoryID and LocationID = @LocationID
and UnitsAtHand > 0 
and	dbo.GetIsItemHidden(@ItemCategoryID, ItemCode) = @Hidden
and not dbo.GetNullDateValue(ExpiryDate) is null
and (dbo.GetExpiryRemainingDays(getdate(),InventoryLocation.ExpiryDate) <= @ExpiryWarningDays))
							
  end
  
 
  else   if (((@LocationID is null)) and ((@ItemCategoryID = @DrugID)or(@ItemCategoryID = @ConsumableID)))
  begin
(select 
dbo.GetLookupDataDes(InventoryLocation.LocationID) as Location, ItemCode,
dbo.GetItemName(inventoryLocation.ItemCategoryID, inventoryLocation.ItemCode) as ItemName,		
dbo.GetUnitMeasure(inventoryLocation.ItemCategoryID, inventoryLocation.ItemCode) as UnitMeasure,		
dbo.GetMergedNameCode(dbo.GetItemName(inventoryLocation.ItemCategoryID, inventoryLocation.ItemCode), inventoryLocation.ItemCode) as ItemFullName,
UnitsAtHand,
dbo.GetItemLocationOrderLevel(@LocationID, @ItemCategoryID, ItemCode) as OrderLevel,
dbo.GetItemUnitCost(@ItemCategoryID, InventoryLocation.ItemCode) as UnitCost,
ExpiryDate, BatchNo,
dbo.GetExpiryRemainingDays(getdate(),InventoryLocation.ExpiryDate) as ExpiryRemainingDays
-- dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure
from InventoryLocation
where ItemCategoryID = @ItemCategoryID 
and UnitsAtHand > 0 and	dbo.GetIsItemHidden(@ItemCategoryID, ItemCode) = @Hidden
and not dbo.GetNullDateValue(ExpiryDate) is null
and (dbo.GetExpiryRemainingDays(getdate(),InventoryLocation.ExpiryDate) <= @ExpiryWarningDays))
  end
	
return 0
go

-- exec uspGetToCountToExpireInventoryLocation '11701', 'consumables', 'M516'
-- exec uspGetToCountToExpireInventoryLocation, 'drugs', 'M516'
-- exec uspGetToCountToExpireInventoryLocation '11701','7d',60





--------GetToCountToOrderInventoryLocation-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetToCountToOrderInventoryLocation')
	drop proc uspGetToCountToOrderInventoryLocation
	
go

create proc uspGetToCountToOrderInventoryLocation(
@LocationID varchar(20) = null,
@ItemCategoryID varchar(10) 
--@ItemCode varchar(20),
--@Balance int = null output
)with encryption as 


------------------------------------------------------------------------------------------------------------
declare @ErrorMSG varchar(200)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
------------------------------------------------------------------------------------------------------------
  if ((not (@LocationID is null)) and ((@ItemCategoryID = @DrugID)or(@ItemCategoryID = @ConsumableID)))
  begin
(select 
dbo.GetLookupDataDes(InventoryLocation.LocationID) as Location, ItemCode,
dbo.GetItemName(inventoryLocation.ItemCategoryID, inventoryLocation.ItemCode) as ItemName,		
dbo.GetUnitMeasure(inventoryLocation.ItemCategoryID, inventoryLocation.ItemCode) as UnitMeasure,		
dbo.GetMergedNameCode(dbo.GetItemName(inventoryLocation.ItemCategoryID, inventoryLocation.ItemCode), inventoryLocation.ItemCode) as ItemFullName,
UnitsAtHand,
dbo.GetItemLocationOrderLevel(@LocationID, @ItemCategoryID, ItemCode) as OrderLevel,
dbo.GetItemUnitCost(@ItemCategoryID, InventoryLocation.ItemCode) as UnitCost,
ExpiryDate, BatchNo,
dbo.GetExpiryRemainingDays(getdate(),InventoryLocation.ExpiryDate) as ExpiryRemainingDays
-- dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure
from InventoryLocation
where ItemCategoryID = @ItemCategoryID and LocationID = @LocationID
and UnitsAtHand <= dbo.GetItemLocationOrderLevel(@LocationID, @ItemCategoryID , InventoryLocation.ItemCode))					
								
  end
  
  else   if (((@LocationID is null)) and ((@ItemCategoryID = @DrugID)or(@ItemCategoryID = @ConsumableID)))
  begin
(select 
dbo.GetLookupDataDes(InventoryLocation.LocationID) as Location, ItemCode,
dbo.GetItemName(inventoryLocation.ItemCategoryID, inventoryLocation.ItemCode) as ItemName,		
dbo.GetUnitMeasure(inventoryLocation.ItemCategoryID, inventoryLocation.ItemCode) as UnitMeasure,		
dbo.GetMergedNameCode(dbo.GetItemName(inventoryLocation.ItemCategoryID, inventoryLocation.ItemCode), inventoryLocation.ItemCode) as ItemFullName,
UnitsAtHand,
dbo.GetItemLocationOrderLevel(@LocationID, @ItemCategoryID, ItemCode) as OrderLevel,
dbo.GetItemUnitCost(@ItemCategoryID, InventoryLocation.ItemCode) as UnitCost,
ExpiryDate, BatchNo,
dbo.GetExpiryRemainingDays(getdate(),InventoryLocation.ExpiryDate) as ExpiryRemainingDays
-- dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure
from InventoryLocation
where ItemCategoryID = @ItemCategoryID 
and UnitsAtHand <= dbo.GetItemLocationOrderLevel(@LocationID, @ItemCategoryID , InventoryLocation.ItemCode))					
								
  end
return 0
go

-- exec uspGetToCountToOrderInventoryLocation '11701', 'consumables', 'M516'
-- exec uspGetToCountToOrderInventoryLocation, 'drugs', 'M516'
--exec uspGetToCountToOrderInventoryLocation 11701,'7d'

-------------- Get Get AllLocations -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAllLocations')
	drop proc uspGetAllLocations
go

create proc uspGetAllLocations(
@ObjectID int=null,
@DataID varchar(10)=null
)with encryption as

 if @ObjectID is null And @DataID is null
 begin
  select ObjectID, DataID, dbo.GetLookupDataDes(DataID) as DataDes
   FROM AllLocations

 end
              
else if  not @ObjectID is null  and @DataID is null
 begin
  select ObjectID, DataID, dbo.GetLookupDataDes(DataID) as DataDes
   FROM AllLocations 
   where ObjectID=@ObjectID

 end

 else if  @ObjectID is null  and not @DataID is null
 begin
  select ObjectID, DataID, dbo.GetLookupDataDes(DataID) as DataDes
   FROM AllLocations 
   where DataID=@DataID
 end

else 
	 begin
	  select ObjectID, DataID, dbo.GetLookupDataDes(DataID) as DataDes
	   FROM AllLocations 
	   where ObjectID=@ObjectID and DataID=@DataID

	 end

go

---EXEC uspGetAllLocations '11701','117'
------------------------------------------------------------------------------------------------------
-------------- InventoryOrders -----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------


-------------- Insert InventoryOrders ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertInventoryOrders')
	drop proc uspInsertInventoryOrders
go

create proc uspInsertInventoryOrders(
@OrderNo varchar(20),
@OrderDate smalldatetime,
@OrderTypeID varchar(10),
@FromLocationID varchar(10),
@ToLocationID varchar(10),
@TransferReasonID varchar(10),
@StockCost money,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @OrderID int
declare @CurrentYear as char(2)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedOrderID int
declare @PassedOrderNo varchar(20)

if exists(select OrderNo from InventoryOrders where OrderNo = @OrderNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Order No', @OrderNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @FromLocationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'From Location ID', @FromLocationID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ToLocationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'To Location ID', @ToLocationID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TransferReasonID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Transfer Reason', @TransferReasonID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

---------------------------------------------------------------------------------------------------------------------

select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'InventoryOrders' and AutoColumnName = 'OrderNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'InventoryOrders' and AutoColumnName = 'OrderNo'

set @CurrentYear = right(year(getdate()),2)

if (@AutoColumnLEN = len(@OrderNo)) and (left(@OrderNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedOrderID = 1
	set @PassedOrderNo = @OrderNo
	set @PassedOrderNo = ltrim(rtrim(substring(@PassedOrderNo, len(@CurrentYear) + 1, @PaddingLEN)))

	if isnumeric(@PassedOrderNo) = 1 set @PassedOrderID = @PassedOrderNo
	else set @PassedOrderID = 1

	set @OrderID = (select max(OrderID) from InventoryOrders where left(OrderNo, len(@CurrentYear)) = @CurrentYear)
	set @OrderID = dbo.GetNextAutoNumber('InventoryOrders', 'OrderNo', @OrderID)

	if @PassedOrderID < @OrderID set @OrderID = @PassedOrderID
	if @PassedOrderID > @OrderID set @OrderID = @PassedOrderID

end else set @OrderID = 1

---------------------------------------------------------------------------------------------------------------------------

insert into InventoryOrders
(OrderID, OrderNo,  OrderDate, OrderTypeID, FromLocationID,StockCost, ToLocationID,TransferReasonID, LoginID, ClientMachine)
values
(@OrderID, @OrderNo, @OrderDate,@OrderTypeID, @FromLocationID,@StockCost, @ToLocationID,@TransferReasonID, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertInventoryOrders

******************************************************************************************************/
-- select * from InventoryOrders
-- delete from InventoryOrders

-------------- Update InventoryOrders -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateInventoryOrders')
	drop proc uspUpdateInventoryOrders
go

create proc uspUpdateInventoryOrders(
@OrderNo varchar(20),
@OrderDate smalldatetime,
@OrderTypeID varchar(10),
@ToLocationID varchar(10),
@TransferReasonID varchar(10),
@StockCost money,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select OrderNo from InventoryOrders where OrderNo = @OrderNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Order No', @OrderNo, 'Inventory Orders')
		return 1
	end
	
if exists(select OrderNo from InventoryTransfers where OrderNo = @OrderNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, is already transfered. You can''t update this record.'
		raiserror(@ErrorMSG, 16, 1, 'Order No', @OrderNo)
		return 1
	end
	
if not exists(select DataID from LookupData where DataID = @ToLocationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'To Location ID', @ToLocationID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TransferReasonID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Transfer Reason', @TransferReasonID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update InventoryOrders set
OrderDate = @OrderDate,OrderTypeID=@OrderTypeID, ToLocationID = @ToLocationID,TransferReasonID = @TransferReasonID, StockCost=@StockCost,
 LoginID = @LoginID, ClientMachine = @ClientMachine
where OrderNo = @OrderNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateInventoryOrders
******************************************************************************************************/
-- select * from InventoryOrders
-- delete from InventoryOrders

-------------- Get InventoryOrders -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInventoryOrders')
	drop proc uspGetInventoryOrders
go

create proc uspGetInventoryOrders(
@OrderNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select OrderNo from InventoryOrders where OrderNo = @OrderNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Order No', @OrderNo, 'Inventory Orders')
		return 1
	end
else
begin
	select OrderNo, OrderDate, OrderTypeID,dbo.GetLookupDataDes(OrderTypeID) as OrderType,FromLocationID, dbo.GetLookupDataDes(FromLocationID) as FromLocation,
	ToLocationID, dbo.GetLookupDataDes(ToLocationID) as ToLocation, TransferReasonID, dbo.GetLookupDataDes(TransferReasonID) as TransferReason, StockCost
	from InventoryOrders
	where OrderNo = @OrderNo
return 0
end
go

/******************************************************************************************************
exec uspGetInventoryOrders
******************************************************************************************************/
-- select * from InventoryOrders
-- delete from InventoryOrders

--------GetNextOrderID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextOrderID')
	drop proc uspGetNextOrderID
go

create proc uspGetNextOrderID(
@OrderID int = null output
)with encryption as

declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @OrderID = (select max(OrderID) from InventoryOrders where left(OrderNo, 2) = @CurrentYear)
set @OrderID = dbo.GetNextAutoNumber('InventoryOrders', 'OrderNo', @OrderID)

return 0

go

-- exec uspGetNextOrderID
-- select * from InventoryOrders
	
-------- CountOrderTransferred -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountOrderTransferred')
	drop proc uspCountOrderTransferred
go

create proc uspCountOrderTransferred(
@OrderNo varchar(20),
@NoOrderTransferred tinyint = null output
)with encryption as

	set @NoOrderTransferred = (select count(OrderNo) from InventoryTransfers where OrderNo = @OrderNo)
	set @NoOrderTransferred = isnull(@NoOrderTransferred, 0)
	
return 0
go

-- exec uspCountOrderTransferred '0005'

--------GetPeriodicInventoryOrders----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicInventoryOrders')
	drop proc uspGetPeriodicInventoryOrders
go

create proc uspGetPeriodicInventoryOrders(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

begin
	select OrderNo, dbo.FormatDate(OrderDate) as OrderDate,
	dbo.GetLookupDataDes(OrderTypeID) as OrderType,OrderTypeID, 
	dbo.GetLookupDataDes(FromLocationID) as FromLocation,
	dbo.GetLookupDataDes(ToLocationID) as ToLocation, 
	dbo.GetLookupDataDes(TransferReasonID) as TransferReason, 
	dbo.FormatDate(InventoryOrders.RecordDateTime) as RecordDate,
	dbo.GetTime(InventoryOrders.RecordDateTime) as RecordTime
	from InventoryOrders
	where OrderDate between @StartDate and @EndDate
	order by OrderDate desc, OrderNo desc
return 0
end
go

-- select * from InventoryOrders
-- exec uspGetPeriodicInventoryOrders 'Jan 12, 2015', 'May 20, 2015'

-----------------------------------------------------------------------------------------------------
-------------- InventoryOrderDetails -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit InventoryOrderDetails ------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditInventoryOrderDetails')
	drop proc uspEditInventoryOrderDetails
go

create proc uspEditInventoryOrderDetails(
@OrderNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@PackID varchar(10),
@PackSize int,
@UnitCost money,
@Quantity int,
@ItemStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @PendingItemStatusID varchar(10)

declare @DrugID varchar(10)
declare @ConsumableID varchar(10)

set @PendingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')

set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')

----------------------------------------------------------------------------------------------------------------------

if (@ItemCategoryID = @DrugID) and 
	(not exists(select DrugNo from Drugs where DrugNo = @ItemCode)) -- Drugs
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Drugs')	
			return 1
		end
	
else if (@ItemCategoryID = @ConsumableID) and 
	(not exists(select ConsumableNo from ConsumableItems where ConsumableNo  = @ItemCode)) -- Consumable Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Consumable Items')	
			return 1
		end
		
----------------------------------------------------------------------------------------------------------------------

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select OrderNo from InventoryOrderDetails 
		where OrderNo = @OrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		----------------------------------------------------------------------------------------------------------------------------------
		if exists(select OrderNo from InventoryOrderDetails 
			where OrderNo = @OrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode and ItemStatusID = @PendingItemStatusID)
			begin
				update InventoryOrderDetails set PackID=@PackID,PackSize=@PackSize, UnitCost=@UnitCost, Quantity = @Quantity, LoginID = @LoginID, ClientMachine = @ClientMachine
				where OrderNo = @OrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
				return 0
			end
		else
		----------------------------------------------------------------------------------------------------------------------------------
			set @ErrorMSG = 'The record with %s: %s, %s: %s, and  %s: %s is not pending. You can''t update such a record!'
			raiserror(@ErrorMSG, 16, 1, 'Order No', @OrderNo, 'Item Category ID', @ItemCategoryID, 'Item Code', @ItemCode)
			return 1
		----------------------------------------------------------------------------------------------------------------------------------
	end
else
begin
insert into InventoryOrderDetails
(OrderNo, ItemCategoryID, ItemCode,PackID,PackSize, UnitCost, Quantity, ItemStatusID, LoginID, ClientMachine)
values
(@OrderNo, @ItemCategoryID, @ItemCode,@PackID,@PackSize, @UnitCost, @Quantity, @ItemStatusID, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspEditInventoryOrderDetails
******************************************************************************************************/
-- select * from InventoryOrderDetails
-- delete from InventoryOrderDetails

---------------- DeleteInventoryOrderDetails ---------------------------------------------------------

if exists (select * from sysobjects where name = 'uspDeleteInventoryOrderDetails')
	drop proc uspDeleteInventoryOrderDetails
go

create proc uspDeleteInventoryOrderDetails(
@OrderNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @PendingItemStatusID varchar(10)

set @PendingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')

if exists(select OrderNo from InventoryOrderDetails where OrderNo = @OrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		----------------------------------------------------------------------------------------------------------------------------------
		if exists(select OrderNo from InventoryOrderDetails 
			where OrderNo = @OrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode and ItemStatusID = @PendingItemStatusID)
			begin
				delete InventoryOrderDetails where OrderNo = @OrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
				return 0
			end
		else
		----------------------------------------------------------------------------------------------------------------------------------
			set @ErrorMSG = 'The record with %s: %s, %s: %s, and  %s: %s is not pending. You can''t delete such a record!'
			raiserror(@ErrorMSG, 16, 1, 'Order No', @OrderNo, 'Item Category ID', @ItemCategoryID, 'Item Code', @ItemCode)
			return 1
		----------------------------------------------------------------------------------------------------------------------------------
	end
else
begin
	set @ErrorMSG = 'The record with %s: %s, %s: %s, and  %s: %s, does not exist!'
	raiserror(@ErrorMSG, 16, 1, 'Order No', @OrderNo, 'Item Category ID', @ItemCategoryID, 'Item Code', @ItemCode)
	return 1
end
go

-- exec uspDeleteInventoryOrderDetails '001', '7S', '10C'
-- select * from InventoryOrderDetails

-------------- Get InventoryOrderDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInventoryOrderDetails')
	drop proc uspGetInventoryOrderDetails
go

create proc uspGetInventoryOrderDetails(
@OrderNo varchar(20),
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (@ItemCategoryID is null or @ItemCategoryID = '') 
begin
	select InventoryOrderDetails.OrderNo, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	ItemCode, PackID,dbo.GetLookUpDataDes(PackID) as Pack, PackSize,UnitCost,(Quantity*PackSize) as TotalUnits,
	(Quantity*PackSize*UnitCost) as TotalCost,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, 
	dbo.GetMergedNameCode(dbo.GetItemName(ItemCategoryID, ItemCode), ItemCode) as ItemFullName,
	dbo.GetInventoryBalance(ToLocationID, ItemCategoryID, ItemCode) as LocationBalance, Quantity,
	ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus
	from InventoryOrderDetails
	inner join InventoryOrders on InventoryOrderDetails.OrderNo = InventoryOrders.OrderNo
	where InventoryOrderDetails.OrderNo = @OrderNo
end
else
begin
	select InventoryOrderDetails.OrderNo, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	ItemCode,PackID,dbo.GetLookUpDataDes(PackID) as Pack, PackSize, UnitCost,(Quantity*PackSize) as TotalUnits,
	(Quantity*PackSize*UnitCost) as TotalCost,
	 dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, 
	dbo.GetMergedNameCode(dbo.GetItemName(ItemCategoryID, ItemCode), ItemCode) as ItemFullName,
	dbo.GetInventoryBalance(ToLocationID, ItemCategoryID, ItemCode) as LocationBalance, Quantity,
	ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus
	from InventoryOrderDetails
	inner join InventoryOrders on InventoryOrderDetails.OrderNo = InventoryOrders.OrderNo
	where InventoryOrderDetails.OrderNo = @OrderNo and ItemCategoryID = @ItemCategoryID
end	
return 0
go

/******************************************************************************************************
exec uspGetInventoryOrderDetails '0004'
exec uspGetInventoryOrderDetails '0004', '7D'
******************************************************************************************************/
-- select * from InventoryOrderDetails
-- delete from InventoryOrderDetails

--------GetPendingInventoryOrderDetails----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPendingInventoryOrderDetails')
	drop proc uspGetPendingInventoryOrderDetails
go

create proc uspGetPendingInventoryOrderDetails(
@ToLocationID varchar(10) = null,
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

if (@ToLocationID is null or @ToLocationID = '') 
begin
	select InventoryOrderDetails.OrderNo, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
		ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, 
		dbo.FormatDate(OrderDate) as OrderDate, 
		dbo.GetLookupDataDes(FromLocationID) as FromLocation, 
		dbo.GetLookupDataDes(ToLocationID) as ToLocation, Quantity,dbo.GetLookUpDataDes(PackID) as Pack, PackSize, UnitCost,(Quantity*PackSize) as TotalUnits,
	(Quantity*PackSize*UnitCost) as TotalCost, 
		dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
		dbo.FormatDate(InventoryOrderDetails.RecordDateTime) as RecordDate, 
		dbo.GetTime(InventoryOrderDetails.RecordDateTime) as RecordTime
	from InventoryOrderDetails
	inner join InventoryOrders on InventoryOrderDetails.OrderNo = InventoryOrders.OrderNo
	where InventoryOrderDetails.OrderNo not in (select isnull(OrderNo, '') from InventoryTransfers) 
		and OrderDate between @StartDate and @EndDate
	order by OrderDate, InventoryOrderDetails.RecordDateTime
end
else
begin
	select InventoryOrderDetails.OrderNo, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
		ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, 
		dbo.FormatDate(OrderDate) as OrderDate, 
		dbo.GetLookupDataDes(FromLocationID) as FromLocation, 
		dbo.GetLookupDataDes(ToLocationID) as ToLocation, Quantity,dbo.GetLookUpDataDes(PackID) as Pack, PackSize, UnitCost,(Quantity*PackSize) as TotalUnits,
	(Quantity*PackSize*UnitCost) as TotalCost, 
		dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
		dbo.FormatDate(InventoryOrderDetails.RecordDateTime) as RecordDate, 
		dbo.GetTime(InventoryOrderDetails.RecordDateTime) as RecordTime
	from InventoryOrderDetails
	inner join InventoryOrders on InventoryOrderDetails.OrderNo = InventoryOrders.OrderNo
	where InventoryOrderDetails.OrderNo not in (select isnull(OrderNo, '') from InventoryTransfers) 
		and ToLocationID = @ToLocationID and OrderDate between @StartDate and @EndDate
	order by OrderDate, InventoryOrderDetails.RecordDateTime
end	
return 0
go

-- select * from InventoryOrderDetails
-- exec uspGetPendingInventoryOrderDetails null, '07 Aug 2014', '09 Aug 2014'
-- exec uspGetPendingInventoryOrderDetails '11701', '01 Aug 2014', '09 Aug 2014'

------------------------------------------------------------------------------------------------------
-------------- InventoryTransfers --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert InventoryTransfers -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertInventoryTransfers')
	drop proc uspInsertInventoryTransfers
go

create proc uspInsertInventoryTransfers(
@TransferNo varchar(20),
@TransferDate smalldatetime,
@FromLocationID varchar(10),
@ToLocationID varchar(10),
@StockCost money,
@OrderNo varchar(20) = null,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @TransferID int
declare @CurrentYear as char(2)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedTransferID int
declare @PassedTransferNo varchar(20)

if exists(select TransferNo from InventoryTransfers where TransferNo = @TransferNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Transfer No', @TransferNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @FromLocationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'From Location ID', @FromLocationID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ToLocationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'To Location ID', @ToLocationID, 'Lookup Data')
		return 1
	end
	
----------------------------------------------------------------------------------------------------------
if not (@OrderNo is null or @OrderNo = '') 
	begin
		if not exists(select OrderNo from InventoryOrders where OrderNo = @OrderNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Order No', @OrderNo, 'Inventory Orders')
				return 1
			end
			
		if exists(select OrderNo from InventoryTransfers where OrderNo = @OrderNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter already transfered'
				raiserror(@ErrorMSG, 16, 1, 'Order No', @OrderNo)
				return 1
			end
	end
else if (@OrderNo is null or @OrderNo = '')
begin set @OrderNo = null end
----------------------------------------------------------------------------------------------------------

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

---------------------------------------------------------------------------------------------------------------------

select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'InventoryTransfers' and AutoColumnName = 'TransferNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'InventoryTransfers' and AutoColumnName = 'TransferNo'

set @CurrentYear = right(year(getdate()),2)

if (@AutoColumnLEN = len(@TransferNo)) and (left(@TransferNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedTransferID = 1
	set @PassedTransferNo = @TransferNo
	set @PassedTransferNo = ltrim(rtrim(substring(@PassedTransferNo, len(@CurrentYear) + 1, @PaddingLEN)))

	if isnumeric(@PassedTransferNo) = 1 set @PassedTransferID = @PassedTransferNo
	else set @PassedTransferID = 1

	set @TransferID = (select max(TransferID) from InventoryTransfers where left(TransferNo, len(@CurrentYear)) = @CurrentYear)
	set @TransferID = dbo.GetNextAutoNumber('InventoryTransfers', 'TransferNo', @TransferID)

	if @PassedTransferID < @TransferID set @TransferID = @PassedTransferID
	if @PassedTransferID > @TransferID set @TransferID = @PassedTransferID

end else set @TransferID = 1

---------------------------------------------------------------------------------------------------------------------------

insert into InventoryTransfers
(TransferID, TransferNo, TransferDate, FromLocationID, ToLocationID,StockCost, OrderNo, LoginID, ClientMachine)
values
(@TransferID, @TransferNo, @TransferDate, @FromLocationID, @ToLocationID,@StockCost, @OrderNo, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertInventoryTransfers

******************************************************************************************************/
-- select * from InventoryTransfers
-- delete from InventoryTransfers

-------------- Update InventoryTransfers -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateInventoryTransfers')
	drop proc uspUpdateInventoryTransfers
go

create proc uspUpdateInventoryTransfers(
@TransferNo varchar(20),
@TransferDate smalldatetime,
@ToLocationID varchar(10),
@StockCost money,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TransferNo from InventoryTransfers where TransferNo = @TransferNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Transfer No', @TransferNo, 'Inventory Transfers')
		return 1
	end
	
if not exists(select DataID from LookupData where DataID = @ToLocationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'To Location ID', @ToLocationID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update InventoryTransfers set
TransferDate = @TransferDate, ToLocationID = @ToLocationID,StockCost=@StockCost, LoginID = @LoginID, ClientMachine = @ClientMachine
where TransferNo = @TransferNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateInventoryTransfers
*******************************************************************************************************/
-- select * from InventoryTransfers
-- delete from InventoryTransfers

-------------- Get InventoryTransfers -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInventoryTransfers')
	drop proc uspGetInventoryTransfers
go

create proc uspGetInventoryTransfers(
@TransferNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TransferNo from InventoryTransfers where TransferNo = @TransferNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Transfer No', @TransferNo, 'Inventory Transfers')
		return 1
	end
else
begin
	select TransferNo, TransferDate,InventoryTransfers.StockCost, InventoryTransfers.FromLocationID as FromLocationID , 
	dbo.GetLookupDataDes(InventoryTransfers.FromLocationID) as FromLocation,
	InventoryTransfers.ToLocationID as ToLocationID, dbo.GetLookupDataDes(InventoryTransfers.ToLocationID) as ToLocation,
	 InventoryTransfers.OrderNo, OrderTypeID, dbo.GetLookupDataDes(OrderTypeID) as OrderType,
	 TransferReasonID, dbo.GetLookupDataDes(TransferReasonID) as TransferReason
	from InventoryTransfers
	inner join InventoryOrders on InventoryOrders.OrderNo= InventoryTransfers.OrderNo
	where TransferNo = @TransferNo
return 0
end
go

/******************************************************************************************************
exec uspGetInventoryTransfers '150005'
******************************************************************************************************/
-- select * from InventoryTransfers
-- delete from InventoryTransfers


------------------------------------------------------------------------------------------------------
-------------- InventoryTransferDetails --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit InventoryTransferDetails ---------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditInventoryTransferDetails')
	drop proc uspEditInventoryTransferDetails
go

create proc uspEditInventoryTransferDetails(
@TransferNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@Quantity int,
@PackID varchar(10),
@PackSize int,
@UnitCost money,
@BatchNo varchar(20),
@ExpiryDate smalldatetime,
@StockStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ReceivedID varchar(10)
declare @OrderNo varchar(20)
declare @ProcessingItemStatusID varchar(10)

-------------------------------------------------------------------------------------------------------------------
set @ReceivedID = dbo.GetLookupDataID('StockType', 'R')
set @ProcessingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'R')
set @OrderNo = (select OrderNo from InventoryTransfers where TransferNo = @TransferNo)
set @OrderNo = isnull(@OrderNo, '') 
-------------------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @StockStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Stock Status ID', @StockStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select TransferNo from InventoryTransferDetails 
		where TransferNo = @TransferNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
	
		if exists(select TransferNo from InventoryTransferDetails where TransferNo = @TransferNo and 
					ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode and StockStatusID = @ReceivedID)
			begin
				set @ErrorMSG = 'Transferred unit(s) received already. You can''t update this record.'
				raiserror(@ErrorMSG, 16, 1)
				return 1
			end
		------------------------------------------------------------------------------------------------------------
		update InventoryTransferDetails set
		PackID=@PackID,PackSize=@PackSize, UnitCost=@UnitCost, Quantity = @Quantity, BatchNo = @BatchNo, ExpiryDate = @ExpiryDate, 
		StockStatusID = @StockStatusID, LoginID = @LoginID, ClientMachine = @ClientMachine
		where TransferNo = @TransferNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
		return 0
		------------------------------------------------------------------------------------------------------------
	end
else

begin tran

--------------------------------------------------------------------------------------------------------------------
insert into InventoryTransferDetails
(TransferNo, ItemCategoryID, ItemCode,PackID,PackSize,UnitCost, Quantity, BatchNo, ExpiryDate, StockStatusID, LoginID, ClientMachine)
values
(@TransferNo, @ItemCategoryID, @ItemCode,@PackID,@PackSize,@UnitCost, @Quantity, @BatchNo, @ExpiryDate, @StockStatusID, @LoginID, @ClientMachine)
--------------------------------------------------------------------------------------------------------------------
update InventoryOrderDetails set ItemStatusID = @ProcessingItemStatusID
where OrderNo = @OrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
--------------------------------------------------------------------------------------------------------------------

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran

return 0

go

/******************************************************************************************************
exec uspEditInventoryTransferDetails
******************************************************************************************************/
-- select * from InventoryTransferDetails
-- delete from InventoryTransferDetails

-------------- Get InventoryTransferDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInventoryTransferDetails')
	drop proc uspGetInventoryTransferDetails
go

create proc uspGetInventoryTransferDetails(
@TransferNo varchar(20),
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @IssuedID varchar(10)

set @IssuedID = dbo.GetLookupDataID('StockType', 'I')

if (@ItemCategoryID is null or @ItemCategoryID = '') 
begin
	select InventoryTransferDetails.TransferNo, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName,PackID, dbo.GetLookUpDataDes(PackID) as Pack,
	 PackSize, UnitCost,(Quantity*PackSize) as TotalUnits,(Quantity*PackSize*UnitCost) as TotalCost, 
	dbo.GetMergedNameCode(dbo.GetItemName(ItemCategoryID, ItemCode), ItemCode) as ItemFullName,
	dbo.GetInventoryBalance(FromLocationID, ItemCategoryID, ItemCode) as FromLocationBalance, 
	dbo.GetInventoryBalance(ToLocationID, ItemCategoryID, ItemCode) as ToLocationBalance, 		
	Quantity, BatchNo, ExpiryDate, StockStatusID, dbo.GetLookupDataDes(StockStatusID) as StockStatus
	from InventoryTransferDetails
	inner join InventoryTransfers on InventoryTransferDetails.TransferNo = InventoryTransfers.TransferNo
	where InventoryTransferDetails.TransferNo = @TransferNo and StockStatusID = @IssuedID
end
else
begin
	select InventoryTransferDetails.TransferNo, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName,PackID, dbo.GetLookUpDataDes(PackID) as Pack, PackSize,
	 UnitCost,(Quantity*PackSize) as TotalUnits,(Quantity*PackSize*UnitCost) as TotalCost, 
	dbo.GetMergedNameCode(dbo.GetItemName(ItemCategoryID, ItemCode), ItemCode) as ItemFullName,
	dbo.GetInventoryBalance(FromLocationID, ItemCategoryID, ItemCode) as FromLocationBalance, 
	dbo.GetInventoryBalance(ToLocationID, ItemCategoryID, ItemCode) as ToLocationBalance, 	
	Quantity, BatchNo, ExpiryDate, StockStatusID, dbo.GetLookupDataDes(StockStatusID) as StockStatus
	from InventoryTransferDetails
	inner join InventoryTransfers on InventoryTransferDetails.TransferNo = InventoryTransfers.TransferNo
	where InventoryTransferDetails.TransferNo = @TransferNo and ItemCategoryID = @ItemCategoryID
end	
return 0
go

/******************************************************************************************************
exec uspGetInventoryTransferDetails '0004'
exec uspGetInventoryTransferDetails '0004', '7D'
******************************************************************************************************/
-- select * from InventoryTransferDetails
-- delete from InventoryTransferDetails

--------GetIssuedInventoryTransferDetails----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIssuedInventoryTransferDetails')
	drop proc uspGetIssuedInventoryTransferDetails
go

create proc uspGetIssuedInventoryTransferDetails(
@ToLocationID varchar(10) = null,
@OrderTypeID varchar(10)=null,
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

declare @IssuedID varchar(10)
set @IssuedID = dbo.GetLookupDataID('StockType', 'I')

if (@ToLocationID is null or @ToLocationID = '') and (@OrderTypeID is null or @OrderTypeID = '') 
begin
	select InventoryTransferDetails.TransferNo as TransferNo, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
		ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, 
		dbo.FormatDate(TransferDate) as TransferDate, 
		dbo.GetLookupDataDes(InventoryTransfers.FromLocationID) as FromLocation, 
		dbo.GetLookupDataDes(InventoryTransfers.ToLocationID) as ToLocation, Quantity, 
		PackID,dbo.GetLookUpDataDes(PackID) as Pack, PackSize, UnitCost,(Quantity*PackSize) as TotalUnits,
	(Quantity*PackSize*UnitCost) as TotalCost, BatchNo, 
		dbo.FormatDate(ExpiryDate) as ExpiryDate, 
		dbo.GetLookupDataDes(StockStatusID) as StockStatus,
		dbo.FormatDate(InventoryTransferDetails.RecordDateTime) as RecordDate, 
		dbo.GetTime(InventoryTransferDetails.RecordDateTime) as RecordTime
	from InventoryTransferDetails
	inner join InventoryTransfers on InventoryTransferDetails.TransferNo = InventoryTransfers.TransferNo
	inner join InventoryOrders on InventoryOrders.OrderNo = InventoryTransfers.OrderNo 
	where StockStatusID = @IssuedID and TransferDate between @StartDate and @EndDate
	order by TransferDate, InventoryTransferDetails.RecordDateTime
end


else if not (@ToLocationID is null or @ToLocationID = '') and (@OrderTypeID is null or @OrderTypeID = '') 
begin
	select InventoryTransferDetails.TransferNo, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
		ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, 
		dbo.FormatDate(TransferDate) as TransferDate, 
		dbo.GetLookupDataDes(InventoryTransfers.FromLocationID) as FromLocation, 
		dbo.GetLookupDataDes(InventoryTransfers.ToLocationID) as ToLocation, PackID,Quantity,
		dbo.GetLookUpDataDes(PackID) as Pack, PackSize, UnitCost,(Quantity*PackSize) as TotalUnits,
	(Quantity*PackSize*UnitCost) as TotalCost,  BatchNo, 
		dbo.FormatDate(ExpiryDate) as ExpiryDate, 
		dbo.GetLookupDataDes(StockStatusID) as StockStatus,
		dbo.FormatDate(InventoryTransferDetails.RecordDateTime) as RecordDate, 
		dbo.GetTime(InventoryTransferDetails.RecordDateTime) as RecordTime
	from InventoryTransferDetails
	inner join InventoryTransfers on InventoryTransferDetails.TransferNo = InventoryTransfers.TransferNo
	inner join InventoryOrders on InventoryOrders.OrderNo = InventoryTransfers.OrderNo
	where InventoryTransfers.ToLocationID = @ToLocationID and StockStatusID = @IssuedID and TransferDate between @StartDate and @EndDate
	order by TransferDate, InventoryTransferDetails.RecordDateTime
end


else if not (@ToLocationID is null or @ToLocationID = '') and not (@OrderTypeID is null or @OrderTypeID = '') 
begin
	select InventoryTransferDetails.TransferNo, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
		ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, 
		dbo.FormatDate(TransferDate) as TransferDate, 
		dbo.GetLookupDataDes(InventoryTransfers.FromLocationID) as FromLocation, 
		dbo.GetLookupDataDes(InventoryTransfers.ToLocationID) as ToLocation, PackID,Quantity,
		dbo.GetLookUpDataDes(PackID) as Pack, PackSize, UnitCost,(Quantity*PackSize) as TotalUnits,
	(Quantity*PackSize*UnitCost) as TotalCost,  BatchNo, 
		dbo.FormatDate(ExpiryDate) as ExpiryDate, 
		dbo.GetLookupDataDes(StockStatusID) as StockStatus,
		dbo.FormatDate(InventoryTransferDetails.RecordDateTime) as RecordDate, 
		dbo.GetTime(InventoryTransferDetails.RecordDateTime) as RecordTime
	from InventoryTransferDetails
	inner join InventoryTransfers on InventoryTransferDetails.TransferNo = InventoryTransfers.TransferNo
	inner join InventoryOrders on InventoryOrders.OrderNo = InventoryTransfers.OrderNo and OrderTypeID=@OrderTypeID 
	where InventoryTransfers.ToLocationID = @ToLocationID and StockStatusID = @IssuedID and TransferDate between @StartDate and @EndDate
	order by TransferDate, InventoryTransferDetails.RecordDateTime
end


else if (@ToLocationID is null or @ToLocationID = '') and not (@OrderTypeID is null or @OrderTypeID = '') 
begin
	select InventoryTransferDetails.TransferNo, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
		ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, 
		dbo.FormatDate(TransferDate) as TransferDate, 
		dbo.GetLookupDataDes(InventoryTransfers.FromLocationID) as FromLocation, 
		dbo.GetLookupDataDes(InventoryTransfers.ToLocationID) as ToLocation, PackID,Quantity,
		dbo.GetLookUpDataDes(PackID) as Pack, PackSize, UnitCost,(Quantity*PackSize) as TotalUnits,
	(Quantity*PackSize*UnitCost) as TotalCost,  BatchNo, 
		dbo.FormatDate(ExpiryDate) as ExpiryDate, 
		dbo.GetLookupDataDes(StockStatusID) as StockStatus,
		dbo.FormatDate(InventoryTransferDetails.RecordDateTime) as RecordDate, 
		dbo.GetTime(InventoryTransferDetails.RecordDateTime) as RecordTime
	from InventoryTransferDetails
	inner join InventoryTransfers on InventoryTransferDetails.TransferNo = InventoryTransfers.TransferNo
	inner join InventoryOrders on InventoryOrders.OrderNo = InventoryTransfers.OrderNo and OrderTypeID=@OrderTypeID 
	where  StockStatusID = @IssuedID and TransferDate between @StartDate and @EndDate
	order by TransferDate, InventoryTransferDetails.RecordDateTime
end

else
begin
	select InventoryTransferDetails.TransferNo, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
		ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, 
		dbo.FormatDate(TransferDate) as TransferDate, 
		dbo.GetLookupDataDes(InventoryTransfers.FromLocationID) as FromLocation, 
		dbo.GetLookupDataDes(InventoryTransfers.ToLocationID) as ToLocation, PackID,Quantity,
		dbo.GetLookUpDataDes(PackID) as Pack, PackSize, UnitCost,(Quantity*PackSize) as TotalUnits,
	(Quantity*PackSize*UnitCost) as TotalCost,  BatchNo, 
		dbo.FormatDate(ExpiryDate) as ExpiryDate, 
		dbo.GetLookupDataDes(StockStatusID) as StockStatus,
		dbo.FormatDate(InventoryTransferDetails.RecordDateTime) as RecordDate, 
		dbo.GetTime(InventoryTransferDetails.RecordDateTime) as RecordTime
	from InventoryTransferDetails
	inner join InventoryTransfers on InventoryTransferDetails.TransferNo = InventoryTransfers.TransferNo
	inner join InventoryOrders on InventoryOrders.OrderNo = InventoryTransfers.OrderNo and OrderTypeID=@OrderTypeID
	where InventoryTransfers.ToLocationID = @ToLocationID and StockStatusID = @IssuedID and TransferDate between @StartDate and @EndDate
	order by TransferDate, InventoryTransferDetails.RecordDateTime
end		
	
return 0
go

-- select * from InventoryTransferDetails
-- exec uspGetIssuedInventoryTransferDetails null,null, '28 Aug 2014', '29 Aug 2017'
-- exec uspGetIssuedInventoryTransferDetails null,'11701', '28 Aug 2014', '29 Aug 2017'

---------------------------------------------------------------------------------------------------------
-------------- InventoryAcknowledges --------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------

-------------- Insert InventoryAcknowledges -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertInventoryAcknowledges') 
	drop proc uspInsertInventoryAcknowledges
go

create proc uspInsertInventoryAcknowledges(
@TransferNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@ReceivedDate smalldatetime,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ReceivedID varchar(10)
declare @OrderNo varchar(20)
declare @OfferedItemStatusID varchar(10)

----------------------------------------------------------------------------------------------------
set @ReceivedID = dbo.GetLookupDataID('StockType', 'R')
set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')
set @OrderNo = (select OrderNo from InventoryTransfers where TransferNo = @TransferNo)
set @OrderNo = isnull(@OrderNo, '') 
----------------------------------------------------------------------------------------------------

if not exists(select TransferNo from InventoryTransferDetails where TransferNo  = @TransferNo
			and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Transfer No', @TransferNo, 'Item Category ID', @ItemCategoryID, 'Item Code', @ItemCode, 'Inventory Transfer Details')
		return 1
	end

if exists(select TransferNo from InventoryAcknowledges where TransferNo = @TransferNo 
			and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Transfer No', @TransferNo, 'Item Category ID', @ItemCategoryID, 'Item Code', @ItemCode)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin tran
----------------------------------------------------------------------------------------------------------
insert into InventoryAcknowledges 
(TransferNo, ItemCategoryID, ItemCode, ReceivedDate, LoginID, ClientMachine) 
values 
(@TransferNo, @ItemCategoryID, @ItemCode, @ReceivedDate, @LoginID, @ClientMachine)
----------------------------------------------------------------------------------------------------------
update InventoryTransferDetails set StockStatusID = @ReceivedID 
where TransferNo = @TransferNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
----------------------------------------------------------------------------------------------------------
update InventoryOrderDetails set ItemStatusID = @OfferedItemStatusID
where OrderNo = @OrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
----------------------------------------------------------------------------------------------------------

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran

return 0

go

/******************************************************************************************************
exec uspInsertInventoryAcknowledges '0002', '27 Jul 2014', 'Admin', 'SYNCSOFT'

******************************************************************************************************/
-- select * from InventoryAcknowledges
-- delete from InventoryAcknowledges

-------------- Get InventoryAcknowledges -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInventoryAcknowledges')
	drop proc uspGetInventoryAcknowledges
go

create proc uspGetInventoryAcknowledges(
@TransferNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TransferNo from InventoryAcknowledges where TransferNo = @TransferNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Transfer No', @TransferNo, 'Inventory Acknowledges')
		return 1
	end
else
begin
	select InventoryAcknowledges.TransferNo, InventoryAcknowledges.ItemCode, 
	dbo.GetItemName(InventoryAcknowledges.ItemCategoryID, InventoryAcknowledges.ItemCode) as ItemName, 
	dbo.GetLookupDataDes(InventoryAcknowledges.ItemCategoryID ) as ItemCategory, dbo.FormatDate(ReceivedDate) as ReceivedDate, 
	dbo.GetInventoryBalance(FromLocationID, InventoryAcknowledges.ItemCategoryID, InventoryAcknowledges.ItemCode) as FromLocationBalance, 
	dbo.GetInventoryBalance(ToLocationID, InventoryAcknowledges.ItemCategoryID, InventoryAcknowledges.ItemCode) as ToLocationBalance, 
	Quantity, PackID,Quantity,dbo.GetLookUpDataDes(PackID) as Pack, PackSize, UnitCost,(Quantity*PackSize) as TotalUnits,
	(Quantity*PackSize*UnitCost) as TotalCost,BatchNo, ExpiryDate, StockStatusID, dbo.GetLookupDataDes(StockStatusID) as StockStatus
	from InventoryAcknowledges
	inner join InventoryTransferDetails on InventoryTransferDetails.TransferNo = InventoryAcknowledges.TransferNo
	and InventoryTransferDetails.ItemCategoryID = InventoryAcknowledges.ItemCategoryID 
	and InventoryTransferDetails.ItemCode = InventoryAcknowledges.ItemCode 
	inner join InventoryTransfers on InventoryTransferDetails.TransferNo = InventoryTransfers.TransferNo
	where InventoryAcknowledges.TransferNo = @TransferNo
return 0
end
go

/******************************************************************************************************
exec uspGetInventoryAcknowledges '0001'
exec uspGetInventoryAcknowledges '0022'
******************************************************************************************************/
-- select * from InventoryAcknowledges
-- delete from InventoryAcknowledges

--------GetPeriodicInventoryAcknowledges----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicInventoryAcknowledges')
	drop proc uspGetPeriodicInventoryAcknowledges
go

create proc uspGetPeriodicInventoryAcknowledges(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

begin
	select TransferNo, dbo.FormatDate(ReceivedDate) as ReceivedDate, 
	dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName,
	dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
	dbo.FormatDate(InventoryAcknowledges.RecordDateTime) as RecordDate,
	dbo.GetTime(InventoryAcknowledges.RecordDateTime) as RecordTime
	from InventoryAcknowledges
	where ReceivedDate between @StartDate and @EndDate
	order by ReceivedDate desc, TransferNo desc	
return 0
end
go


-- select * from InventoryAcknowledges
-- exec uspGetPeriodicInventoryAcknowledges 'Jan 12, 2015', 'May 20, 2015'


/******************************************************************************************************
exec uspGetInventoryTransfers
******************************************************************************************************/
-- select * from InventoryTransfers
-- delete from InventoryTransfers



--------GetNotAcknowledgedInventoryOrders-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNotAcknowledgedInventoryOrders')
	drop proc uspGetNotAcknowledgedInventoryOrders
	
go

create proc uspGetNotAcknowledgedInventoryOrders(
@FromLocationID varchar(20) = null,
@InventoryAlertDays integer
)with encryption as 

declare @StartDate datetime
declare @EndDate datetime
declare @ItemStatusOffered varchar(10)

set @ItemStatusOffered = dbo.GetLookupDataID('ItemStatus', 'P')
set @StartDate = GETDATE()- @InventoryAlertDays
set @EndDate = GETDATE()

begin
select 
	   orderID, InventoryOrders.OrderNo, dbo.FormatDate(OrderDate) as OrderDate, 
	   dbo.GetLookupDataDes(FromLocationID) as FromLocation,
	   dbo.GetLookupDataDes(ToLocationID) as ToLocation, 
	   dbo.FormatDate(InventoryOrders.RecordDateTime) as RecordDate,
	   dbo.GetTime(InventoryOrders.RecordDateTime) as RecordTime
from InventoryOrders
INNER JOIN  InventoryOrderDetails on InventoryOrders.OrderNo = InventoryOrderDetails.OrderNo
where FromLocationID = @FromLocationID and 
dbo.IsInventoryOrderAcknowledged(InventoryOrders.OrderNo) = 3 and
OrderDate between @StartDate and @EndDate 
and InventoryOrderDetails.ItemStatusID = @ItemStatusOffered
order by OrderDate desc,InventoryOrders.OrderNo desc

end


return 0
go

 --exec uspGetNotAcknowledgedInventoryOrders '117POPD'117DENT
 --exec uspGetNotAcknowledgedInventoryOrders '117DENT'
-- exec uspGetNotAcknowledgedInventoryOrders '117EYE PHA'
-- exec uspGetNotAcknowledgedInventoryOrders '11701'


--------GetNotProcessedInventoryAcknowledgement-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNotProcessedInventoryAcknowledgement')
	drop proc uspGetNotProcessedInventoryAcknowledgement
	
go

create proc uspGetNotProcessedInventoryAcknowledgement(
@InventoryAlertDays integer
)with encryption as 

declare @StartDate datetime
declare @EndDate datetime

set @StartDate = GETDATE()- @InventoryAlertDays
set @EndDate = GETDATE()

begin
select 
	   orderID, InventoryOrders.OrderNo, dbo.FormatDate(OrderDate) as OrderDate, 
	   dbo.GetLookupDataDes(FromLocationID) as FromLocation,
	   dbo.GetLookupDataDes(ToLocationID) as ToLocation, 
	   dbo.FormatDate(InventoryOrders.RecordDateTime) as RecordDate,
	   dbo.GetTime(InventoryOrders.RecordDateTime) as RecordTime
from InventoryOrders
where dbo.IsInventoryOrderAcknowledged(InventoryOrders.OrderNo) = 1 and
OrderDate between @StartDate and @EndDate 
order by OrderDate desc,OrderNo desc

end
return 0
go

-- exec uspGetNotProcessedInventoryAcknowledgement '117POPD'117DENT
-- exec uspGetNotProcessedInventoryAcknowledgement '117DENT'
-- exec uspGetNotProcessedInventoryAcknowledgement '117EYE PHA'
-- exec uspGetNotProcessedInventoryAcknowledgement '11701'



--------GetNextTransferID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextTransferID')
	drop proc uspGetNextTransferID
go

create proc uspGetNextTransferID(
@TransferID int = null output
)with encryption as

declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @TransferID = (select max(TransferID) from InventoryTransfers where left(TransferNo, 2) = @CurrentYear)
set @TransferID = dbo.GetNextAutoNumber('InventoryTransfers', 'TransferNo', @TransferID)

return 0

go

-- exec uspGetNextTransferID
-- select * from InventoryTransfers

--------GetPeriodicInventoryTransfers----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicInventoryTransfers')
	drop proc uspGetPeriodicInventoryTransfers
go

create proc uspGetPeriodicInventoryTransfers(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

begin
	select TransferNo, OrderNo, dbo.FormatDate(TransferDate) as TransferDate, 
	dbo.GetLookupDataDes(FromLocationID) as FromLocation,
	dbo.GetLookupDataDes(ToLocationID) as ToLocation, 
	dbo.FormatDate(InventoryTransfers.RecordDateTime) as RecordDate,
	dbo.GetTime(InventoryTransfers.RecordDateTime) as RecordTime
	from InventoryTransfers
	where TransferDate between @StartDate and @EndDate
	order by TransferDate desc, TransferNo desc	
return 0
end
go


------------------------------------------------------------------------------------------------------
-------------- DeliveryNoteDetails --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert DeliveryNoteDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertDeliveryNoteDetails')
	drop proc uspInsertDeliveryNoteDetails
go

create proc uspInsertDeliveryNoteDetails(
@TransferNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@DeliveryDate smalldatetime,
@PackID varchar(10),
@PackSize int,
@Quantity int,
@LoginID varchar(20),
@RecordDateTime smalldatetime,
@ClientMachine varchar(40),
@UnitCost money
)with encryption as

declare @ErrorMSG varchar(200)
declare @ReceivedID varchar(10)
declare @OrderNo varchar(20)
declare @OfferedItemStatusID varchar(10)

----------------------------------------------------------------------------------------------------
set @ReceivedID = dbo.GetLookupDataID('StockType', 'R')
set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')
set @OrderNo = (select OrderNo from InventoryTransfers where TransferNo = @TransferNo)
set @OrderNo = isnull(@OrderNo, '') 
if not exists(select TransferNo from InventoryTransferDetails where TransferNo  = @TransferNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Transfer No', @TransferNo, 'InventoryTransferDetails')
		return 1
	end

if not exists(select ItemCategoryID from InventoryTransferDetails where ItemCategoryID  = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'InventoryTransferDetails')
		return 1
	end

if not exists(select ItemCode from InventoryTransferDetails where ItemCode  = @ItemCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'InventoryTransferDetails')
		return 1
	end

if exists(select TransferNo from DeliveryNoteDetails where TransferNo = @TransferNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Transfer No', @TransferNo, 'Item Category', @ItemCategoryID, 'Item Code', @ItemCode)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PackID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pack ID', @PackID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
if exists(select TransferNo from DeliveryNoteDetails where TransferNo = @TransferNo 
			and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Transfer No', @TransferNo, 'Item Category ID', @ItemCategoryID, 'Item Code', @ItemCode)
		return 1
	end

begin tran
insert into DeliveryNoteDetails
(TransferNo, ItemCategoryID, ItemCode, DeliveryDate, PackID, PackSize, Quantity, LoginID, RecordDateTime, ClientMachine, UnitCost)
values
(@TransferNo, @ItemCategoryID, @ItemCode,@DeliveryDate, @PackID, @PackSize, @Quantity, @LoginID, @RecordDateTime, @ClientMachine, @UnitCost)
----------------------------------------------------------------------------------------------------------
update InventoryTransferDetails set StockStatusID = @ReceivedID 
where TransferNo = @TransferNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
----------------------------------------------------------------------------------------------------------
update InventoryOrderDetails set ItemStatusID = @OfferedItemStatusID
where OrderNo = @OrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
----------------------------------------------------------------------------------------------------------
if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran

return 0

go

/******************************************************************************************************
exec uspInsertDeliveryNoteDetails
******************************************************************************************************/
-- select * from DeliveryNoteDetails
-- delete from DeliveryNoteDetails


-------------- Update DeliveryNoteDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateDeliveryNoteDetails')
	drop proc uspUpdateDeliveryNoteDetails
go

create proc uspUpdateDeliveryNoteDetails(
@TransferNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@DeliveryDate smalldatetime,
@PackID varchar(10),
@PackSize int,
@Quantity int,
@LoginID varchar(20),
@RecordDateTime smalldatetime,
@ClientMachine varchar(40),
@UnitCost money
)with encryption as

declare @ErrorMSG varchar(200)
declare @ReceivedID varchar(10)
declare @OrderNo varchar(20)
declare @OfferedItemStatusID varchar(10)

----------------------------------------------------------------------------------------------------
set @ReceivedID = dbo.GetLookupDataID('StockType', 'R')
set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')
set @OrderNo = (select OrderNo from InventoryTransfers where TransferNo = @TransferNo)
set @OrderNo = isnull(@OrderNo, '') 
if not exists(select TransferNo from DeliveryNoteDetails where TransferNo = @TransferNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Transfer No', @TransferNo, 'Item Category', @ItemCategoryID, 'Item Code', @ItemCode, 'DeliveryNoteDetails')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PackID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pack ID', @PackID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

if exists(select TransferNo from DeliveryNoteDetails where TransferNo = @TransferNo 
			and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Transfer No', @TransferNo, 'Item Category ID', @ItemCategoryID, 'Item Code', @ItemCode)
		return 1
	end

begin tran
update DeliveryNoteDetails set
DeliveryDate=@DeliveryDate,PackID = @PackID, PackSize = @PackSize, Quantity = @Quantity, LoginID = @LoginID, RecordDateTime = @RecordDateTime, ClientMachine = @ClientMachine, UnitCost = @UnitCost
where TransferNo = @TransferNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode

----------------------------------------------------------------------------------------------------------
update InventoryTransferDetails set StockStatusID = @ReceivedID 
where TransferNo = @TransferNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
----------------------------------------------------------------------------------------------------------
update InventoryOrderDetails set ItemStatusID = @OfferedItemStatusID
where OrderNo = @OrderNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
----------------------------------------------------------------------------------------------------------
if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran

return 0

go

/******************************************************************************************************
exec uspUpdateDeliveryNoteDetails
******************************************************************************************************/
-- select * from DeliveryNoteDetails
-- delete from DeliveryNoteDetails


-------------- Get DeliveryNoteDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDeliveryNoteDetails')
	drop proc uspGetDeliveryNoteDetails
go

create proc uspGetDeliveryNoteDetails(
@TransferNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TransferNo from DeliveryNoteDetails where TransferNo = @TransferNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Transfer No', @TransferNo, 'Item Category', @ItemCategoryID, 'Item Code', @ItemCode, 'DeliveryNoteDetails')
		return 1
	end
else
begin
	select TransferNo, ItemCategoryID, ItemCode,DeliveryDate, PackID, dbo.GetLookupDataDes(PackID) as [Pack ID], PackSize, Quantity, DeliveryNoteDetails.LoginID, RecordDateTime, ClientMachine, UnitCost
	from DeliveryNoteDetails
	inner join Logins on DeliveryNoteDetails.LoginID = Logins.LoginID	

	where TransferNo = @TransferNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
return 0
end
go

/******************************************************************************************************
exec uspGetDeliveryNoteDetails
******************************************************************************************************/
-- select * from DeliveryNoteDetails
-- delete from DeliveryNoteDetails

------------------------------------------------------------------------------------------------------
------------- DrugCombinations -----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Drug Combinations---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertDrugCombinations')
	drop proc uspInsertDrugCombinations
go

create proc uspInsertDrugCombinations(
@Combination varchar(30),
@CombinationDes varchar(100)
)with encryption as 

declare @ErrorMSG varchar(200)

if exists(select Combination from DrugCombinations where Combination = @Combination)
	begin
		set @ErrorMSG = 'The Combination: ' + @Combination + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
begin
insert into DrugCombinations
(Combination, CombinationDes) 
values
(@Combination, @CombinationDes )
return 0
end
go


/*******************************************************************************
--1-----------------------------------------------------------------------------
exec uspInsertDrugCombinations 'D4T+3TC+NVP', 'Stavudine, Lamivudine, Nevirapine (Viramune)'

*********************************************************************************/

-- select * from DrugCombinations
-- delete from DrugCombinations

---------Update Drug Combinations-------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateDrugCombinations')
	drop proc uspUpdateDrugCombinations
go

create proc uspUpdateDrugCombinations(
@Combination varchar(30),
@CombinationDes varchar(100)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select Combination from DrugCombinations where Combination = @Combination)
	begin
		set @ErrorMSG = 'The Combination: ' + @Combination + ', you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Drug Combinations')	
		return 1
	end

else
begin
	update DrugCombinations set 
	CombinationDes = @CombinationDes
	where Combination = @Combination
	return 0
end
go

/***********************************************************************************************************************
--1---------------------------------------------------------------------------------------------------------------------
exec uspUpdateDrugCombinations 'D4T+3TC+NVP', 'Stavudine, Lamivudine, Nevirapine (Viramune)'

************************************************************************************************************************/

-- select * from DrugCombinations
-- delete from DrugCombinations

--------Get Drug Combinations -------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDrugCombinations')
	drop proc uspGetDrugCombinations
go

create proc uspGetDrugCombinations(
@Combination varchar(30) = null output
)with encryption as

declare @ErrorMSG varchar(200)

if not (@Combination is null)
begin
	if not exists(select Combination from DrugCombinations where Combination = @Combination)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Combination', @Combination, 'Drug Combinations')	
		return 1
	end
	begin
		select Combination, CombinationDes, dbo.GetMergedNameCode(CombinationDes,Combination) as CombinationFullName  from DrugCombinations 
		where Combination = @Combination
	end
end
else
if  (@Combination is null)

begin
	select Combination, CombinationDes, dbo.GetMergedNameCode(CombinationDes,Combination) as CombinationFullName  from DrugCombinations 
end

----------------------------------------------------------------------------------------------------------------

return 0

go

-- select * from DrugCombinations
-- exec uspGetDrugCombinations 'AZT+DDI+EFV'
-- exec uspGetDrugCombinations null

-----------------------------------------------------------------------------------------------------------
------------- DrugCombinationDetails ----------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------

---------Edit DrugCombinationDetails-----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditDrugCombinationDetails')
	drop proc uspEditDrugCombinationDetails
go

create proc uspEditDrugCombinationDetails(
@Combination varchar(30),
@DrugNo varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select Combination from DrugCombinations where Combination = @Combination)
	begin
		set @ErrorMSG = 'The Combination: ' + @Combination + ', you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1,'Drug Combinations')	
		return 1
	end

if not exists(select DrugNo  from Drugs where DrugNo  = @DrugNo )
	begin
		set @ErrorMSG = 'The Drug No: ' + @DrugNo + ', you are trying to enter does not exist in the registered Drugs'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if exists(select Combination from DrugCombinationDetails where Combination = @Combination and DrugNo = @DrugNo)
	begin
		-- set @ErrorMSG = 'The record with Combination: %s and Drug No: %s, you are trying to enter already exists'
		-- raiserror(@ErrorMSG,16,1, @Combination, @DrugNo)	
		-- return 1
		return 0
	end
else
begin
insert into DrugCombinationDetails
(Combination, DrugNo) 
values
(@Combination, @DrugNo)
return 0
end
go


/*************************************************************************************************************
--1-----------------------------------------------------------------------------------------------------------
exec uspEditDrugCombinationDetails 'D4T+DDI+EFV', 'M 0001'
exec uspEditDrugCombinationDetails 'D4T+DDI+EFV', 'M 0002'
exec uspEditDrugCombinationDetails 'LPV/r+CBV', 'M 0002'

**************************************************************************************************************/

-- select * from DrugCombinations
-- select * from DrugCombinationDetails
-- delete from DrugCombinationDetails

--------Get DrugCombinationDetails-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDrugCombinationDetails')
	drop proc uspGetDrugCombinationDetails
go

create proc uspGetDrugCombinationDetails(
@Combination varchar(30)
)with encryption as

if not exists(select Combination from DrugCombinationDetails where Combination = @Combination)
	begin
			--set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
			--raiserror(@ErrorMSG,16,1, 'Combination', @Combination, 'DrugCombinationDetails')	
			return 0
	end
	begin
		select Combination, DrugCombinationDetails.DrugNo, 
		dbo.GetMergedNameCode(DrugName, DrugCombinationDetails.DrugNo) as DrugFullName
		from DrugCombinationDetails
		inner join Drugs on DrugCombinationDetails.DrugNo = Drugs.DrugNo

		where Combination = @Combination 
	end

return 0

go

-- select * from DrugCombinationDetails
-- exec uspGetDrugCombinationDetails 'D4T+DDI+EFV'
-- exec uspGetDrugCombinationDetails 'LPV/r+CBV'


------------------------------------------------------------------------------------------------------
------------- ARTRegimen -----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert ART Regimen---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertARTRegimen')
	drop proc uspInsertARTRegimen
go

create proc uspInsertARTRegimen(
@VisitNo varchar(20),
@Combination varchar(30),
@StartDate smalldatetime,
@WHOStageID varchar(10),
@DrugLinesID varchar(10),
@StaffNo varchar(10),
@ARTCategoryID varchar(10),
@WhyEligible varchar(200),
@ARTSwitchReasons varchar(200), 
@Notes varchar(200),
@ARTStatusID varchar(10),
@RefillDuration smallint,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

declare @PatientNo varchar(20)

declare @StartingARTCategoryID varchar(10)
declare @SwitchingARTCategoryID varchar(10)
declare @ResumingARTCategoryID varchar(10)
declare @ReferredARTCategoryID varchar(10)

declare @OnARTStatusID varchar(10)
declare @StoppedARTStatusID varchar(10)

set @PatientNo = (select PatientNo from Visits where VisitNo = @VisitNo)

set @StartingARTCategoryID = dbo.GetLookupDataID('ARTCategory', 'STA')
set @SwitchingARTCategoryID = dbo.GetLookupDataID('ARTCategory', 'SWI')
set @ResumingARTCategoryID = dbo.GetLookupDataID('ARTCategory', 'RES')
set @ReferredARTCategoryID = dbo.GetLookupDataID('ARTCategory', 'REF')

set @OnARTStatusID = dbo.GetLookupDataID('ARTStatus', 'O')
set @StoppedARTStatusID = dbo.GetLookupDataID('ARTStatus', 'S')

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered Visits'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if exists(select VisitNo from ARTRegimen where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

---------------------------------------------------------------------------------------------------------------------
if (exists(select Patients.PatientNo from ARTRegimen
			inner join Visits on ARTRegimen.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			where Patients.PatientNo = @PatientNo) and (@ARTCategoryID = @StartingARTCategoryID))
	begin
		set @ErrorMSG = '%s: %s, is known to have been on ART before. You can''t select Starting'
		raiserror(@ErrorMSG,16,1, 'The Patient No', @PatientNo)
		return 1
	end

if (not exists(select Patients.PatientNo from ARTRegimen
			inner join Visits on ARTRegimen.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			where Patients.PatientNo = @PatientNo)) and ((@ARTCategoryID = @SwitchingARTCategoryID) 
			or (@ARTCategoryID = @ResumingARTCategoryID))
	begin
		set @ErrorMSG = '%s: %s, is not known to have been on ART before. You can''t select Resuming or Switching'
		raiserror(@ErrorMSG,16,1, 'The Patient No', @PatientNo)	
		return 1
	end

if (exists(select Patients.PatientNo from ARTRegimen
			inner join Visits on ARTRegimen.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			where Patients.PatientNo = @PatientNo) and (@ARTCategoryID = @ReferredARTCategoryID))
	begin
		set @ErrorMSG = '%s: %s, is known to have been on ART before. You can''t select Reffered'
		raiserror(@ErrorMSG,16,1, 'The Patient No', @PatientNo)	
		return 1
	end

if exists(select Patients.PatientNo from ARTRegimen
			inner join Visits on ARTRegimen.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			where Patients.PatientNo = @PatientNo and ARTStatusID = @OnARTStatusID)
	begin
		set @ErrorMSG = '%s: %s, is currently known to be on ART. Stop ART currently on first'
		raiserror(@ErrorMSG,16,1, 'The Patient No', @PatientNo)	
		return 1
	end

if (not exists(select Patients.PatientNo from ARTRegimen
			inner join Visits on ARTRegimen.VisitNo = Visits.VisitNo
			inner join Patients on Visits.PatientNo = Patients.PatientNo
			where Patients.PatientNo = @PatientNo and Combination = @Combination and 
			ARTStatusID = @StoppedARTStatusID) and (@ARTCategoryID = @ResumingARTCategoryID))
	begin
		set @ErrorMSG = '%s: %s, is not known to have stopped %s. You can''t select Resuming'
		raiserror(@ErrorMSG,16,1, 'The Patient No', @PatientNo, @Combination)	
		return 1
	end

---------------------------------------------------------------------------------------------------------------------

if not exists(select Combination from DrugCombinations where Combination = @Combination)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Combination', @Combination, 'Drug Combinations')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @WHOStageID)
	begin
		set @ErrorMSG = 'The Item WHO Stage ID: ' + @WHOStageID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DrugLinesID)
	begin
		set @ErrorMSG = 'The Item Drug Lines ID: ' + @DrugLinesID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Staff No', @StaffNo, 'Staff')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ARTCategoryID)
	begin
		set @ErrorMSG = 'The Item ART Category ID: ' + @ARTCategoryID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ARTStatusID)
	begin
		set @ErrorMSG = 'The Item ART Status ID: ' + @ARTStatusID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
begin
insert into ARTRegimen
(VisitNo, Combination, StartDate, WHOStageID, DrugLinesID, StaffNo, ARTCategoryID, WhyEligible, ARTSwitchReasons, Notes, ARTStatusID, RefillDuration, LoginID) 
values
(@VisitNo, @Combination, @StartDate, @WHOStageID, @DrugLinesID, @StaffNo, @ARTCategoryID, @WhyEligible, @ARTSwitchReasons, @Notes, @ARTStatusID, @RefillDuration, @LoginID)

--------------------------------------------
exec uspUpdatePatientCombinationOn @VisitNo
--------------------------------------------

return 0
end
go

/********************************************************************************************************************
--1------------------------------------------------------------------------------------------------------------------
exec uspInsertARTRegimen '100273001', 'D4T+3TC+NVP', '04 Oct 2006', '234', '221ST', '100', '25STA',  '', '', 'Notes', '24O', 30, 'Admin'

*********************************************************************************************************************/

-- select * from ARTRegimen
-- delete from ARTRegimen

---------Update ART Regimen-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateARTRegimen')
	drop proc uspUpdateARTRegimen
go

create proc uspUpdateARTRegimen(
@VisitNo varchar(20),
@Combination varchar(30),
@StartDate smalldatetime,
@WHOStageID varchar(10),
@DrugLinesID varchar(10),
@StaffNo varchar(10),
@ARTCategoryID varchar(10),
@WhyEligible varchar(200),
@ARTSwitchReasons varchar(200), 
@Notes varchar(200),
@ARTStatusID varchar(10),
@RefillDuration smallint,
@LoginID varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered Visits'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select VisitNo from ARTRegimen where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1,'ART Regimen')	
		return 1
	end

if not exists(select Combination from DrugCombinations where Combination = @Combination)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Combination', @Combination, 'Drug Combinations')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @WHOStageID)
	begin
		set @ErrorMSG = 'The Item WHO Stage ID: ' + @WHOStageID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DrugLinesID)
	begin
		set @ErrorMSG = 'The Item Drug Lines ID: ' + @DrugLinesID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Staff No', @StaffNo, 'Staff')	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ARTCategoryID)
	begin
		set @ErrorMSG = 'The Item ART Category ID: ' + @ARTCategoryID + ', you are trying to enter does not exist in the registered Lookup Data'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
begin
	update ARTRegimen set
	Combination = @Combination, StartDate = @StartDate, WHOStageID = @WHOStageID, DrugLinesID = @DrugLinesID, 
	StaffNo = @StaffNo, ARTCategoryID = @ARTCategoryID, WhyEligible = @WhyEligible, ARTSwitchReasons = @ARTSwitchReasons, 
	Notes = @Notes, RefillDuration = @RefillDuration, LoginID = @LoginID
	where VisitNo = @VisitNo

------------------------------------------------
	exec uspUpdatePatientCombinationOn @VisitNo
------------------------------------------------

	return 0
end
go

/********************************************************************************************************************
--1------------------------------------------------------------------------------------------------------------------
exec uspUpdateARTRegimen '07000001004', 'D4T+3TC+NVP', '04 Oct 2006', '231', '221ST', 'D01', '25REF',  '', '', 'Notes', '24O', 60, 'Kutegz'

*********************************************************************************************************************/

-- select * from ARTRegimen
-- delete from ARTRegimen

------------Delete ARTRegimen--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspDeleteARTRegimen')
	drop proc uspDeleteARTRegimen
go

create proc uspDeleteARTRegimen(
@VisitNo varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from ARTRegimen where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16, 1, 'Visit No', @VisitNo, 'ART Regimen')	
		return 1
	end

else
begin tran

delete ARTRegimen where VisitNo = @VisitNo
exec uspUpdatePatientCombinationOn @VisitNo

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
return 0
go

-- exec uspDeleteARTRegimen '08022077009'
-- select * from ARTRegimen

--------Get ART Regimen -------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetARTRegimen')
	drop proc uspGetARTRegimen
go

create proc uspGetARTRegimen(
@VisitNo as varchar(20) = null 
)with encryption as

declare @ErrorMSG varchar(200)

if not (@VisitNo is null)
begin
	if not exists(select VisitNo from ARTRegimen where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo, 'ART Regimen')	
		return 1
	end
	begin
		select VisitNo, Combination, StartDate, WHOStageID, WHOStage.DataDes as WHOStage,DrugLinesID, 
		DrugLines.DataDes as DrugLines, ARTCategoryID, ARTCategory.DataDes as ARTCategory, RefillDuration,
		dbo.GetMergedNameCode(dbo.GetFullName(LastName, null, FirstName), ARTRegimen.StaffNo) as StaffFullName, 
		dbo.GetLookupDataName(WhyEligible) as [WhyEligible], dbo.GetLookupDataName(ARTSwitchReasons) as [ARTSwitchReasons],Notes
		from ARTRegimen
		inner join LookupData WHOStage on ARTRegimen.WHOStageID = WHOStage.DataID
		inner join LookupData DrugLines on ARTRegimen.DrugLinesID = DrugLines.DataID
		inner join LookupData ARTCategory on ARTRegimen.ARTCategoryID = ARTCategory.DataID
		inner join Staff on ARTRegimen.StaffNo = Staff.StaffNo 		
		where VisitNo = @VisitNo	
	end
end
else
if (@VisitNo is null)
	begin
		select VisitNo, Combination, StartDate, WHOStageID, WHOStage.DataDes as WHOStage,DrugLinesID, 
		DrugLines.DataDes as DrugLines, ARTCategoryID, ARTCategory.DataDes as ARTCategory, RefillDuration,
		dbo.GetMergedNameCode(dbo.GetFullName(LastName, null, FirstName), ARTRegimen.StaffNo) as StaffFullName, 
		dbo.GetLookupDataName(WhyEligible) as [WhyEligible], dbo.GetLookupDataName(ARTSwitchReasons) as [ARTSwitchReasons], Notes
		from ARTRegimen
		inner join LookupData WHOStage on ARTRegimen.WHOStageID = WHOStage.DataID
		inner join LookupData DrugLines on ARTRegimen.DrugLinesID = DrugLines.DataID
		inner join LookupData ARTCategory on ARTRegimen.ARTCategoryID = ARTCategory.DataID
		inner join Staff on ARTRegimen.StaffNo = Staff.StaffNo 	
	end

return 0

go

-- select * from ARTRegimen
-- exec uspGetARTRegimen '07022064001'
-- exec uspGetARTRegimen null

-- dbo.GetMergedNameCode(WHOStage.DataDes, WHOStageID) as WHOStage,
-- dbo.GetMergedNameCode(DrugLines.DataDes, DrugLinesID) as DrugLines

--------GetVisitNoCurrentlyOnART----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetVisitNoCurrentlyOnART')
	drop proc uspGetVisitNoCurrentlyOnART
go

create proc uspGetVisitNoCurrentlyOnART(
@PatientNo varchar(20),
@VisitDate smalldatetime = null output,
@VisitNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @OnARTStatusID varchar(10)

set @OnARTStatusID = dbo.GetLookupDataID('ARTStatus', 'O')

if (@VisitDate is null)
begin
	if not exists(select Patients.PatientNo from ARTRegimen
					inner join Visits on ARTRegimen.VisitNo = Visits.VisitNo
					inner join Patients on Visits.PatientNo = Patients.PatientNo 
					where ARTStatusID = @OnARTStatusID and Patients.PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Patient No', @PatientNo, 'ART Regimen or Stopped ART')	
		return 1
	end
	else
	begin
		set @VisitNo = (select top 1 ARTRegimen.VisitNo from ARTRegimen
						inner join Visits on ARTRegimen.VisitNo = Visits.VisitNo
						inner join Patients on Visits.PatientNo = Patients.PatientNo
						where ARTStatusID = @OnARTStatusID and Patients.PatientNo = @PatientNo)
	end
end
else
if not (@VisitDate is null)
begin

if not exists(select PatientNo from Visits where PatientNo = @PatientNo and VisitDate = @VisitDate)
	begin
		set @ErrorMSG = '%s: %s and %s: ' + dbo.FormatDate(@VisitDate) + ', you are trying to enter does not exist %s'
		raiserror(@ErrorMSG,16,1, 'The record with Patient No', @PatientNo, 'Visit Date', 'in the registered Visits')	
		return 1		
	end
	else
	begin
		set @VisitNo = (select top 1 VisitNo from Visits where PatientNo = @PatientNo
						and VisitDate = @VisitDate order by VisitID desc)
	end
end

return 0

go

-- select * from ARTRegimen
-- exec  uspGetVisitNoCurrentlyOnART '063/05'
-- exec uspGetVisitNoCurrentlyOnART '063/05', '22 Apr 2005'

------------------------------------------------------------------------------------------------------
------------- ARTRegimenDetails ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Edit ART Regimen Details-------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditARTRegimenDetails')
	drop proc uspEditARTRegimenDetails
go

create proc uspEditARTRegimenDetails(
@VisitNo varchar(20),
@DrugNo varchar(20),
@Dosage varchar(100),
@Duration int,
@Quantity int,
@Formula varchar(40)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @PatientNo varchar(20)

if not exists(select VisitNo from ARTRegimen where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered ART Regimen'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DrugNo  from Drugs where DrugNo  = @DrugNo )
	begin
		set @ErrorMSG = 'The Drug No: ' + @DrugNo + ', you are trying to enter does not exist in the registered Drugs'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if (exists(select PatientNo from PatientAllergies
	inner join AllergyDrugs on PatientAllergies.AllergyNo = AllergyDrugs.AllergyNo 
	where PatientNo = (select PatientNo from Visits where VisitNo = @VisitNo) and DrugNo = @DrugNo))
	begin
		set @PatientNo = (select top 1 PatientNo from PatientAllergies
		inner join AllergyDrugs on PatientAllergies.AllergyNo = AllergyDrugs.AllergyNo 
		where PatientNo = (select PatientNo from Visits where VisitNo = @VisitNo) and DrugNo = @DrugNo)
		set @ErrorMSG = 'Patient No: %s, is allergic to Drug No: %s, you can’t prescribe this drug'
		raiserror(@ErrorMSG,16,1, @PatientNo, @DrugNo)	
		return 1
	end

if exists(select VisitNo from ARTRegimenDetails where VisitNo = @VisitNo and DrugNo = @DrugNo)
	begin
		-- set @ErrorMSG = 'The record with Visit No: %s and Drug No: %s, you are trying to enter already exists'
		-- raiserror(@ErrorMSG,16,1, @VisitNo, @DrugNo)	
		-- return 1

		update ARTRegimenDetails set
		Dosage = @Dosage, Duration = @Duration, Quantity = @Quantity, Formula =  @Formula
		where VisitNo = @VisitNo and DrugNo = @DrugNo
		return 0
	end
else
begin
insert into ARTRegimenDetails
(VisitNo, DrugNo, Dosage, Duration, Quantity, Formula) 
values
(@VisitNo, @DrugNo, @Dosage, @Duration, @Quantity, @Formula)
return 0
end
go


/*************************************************************************************************************
--1-----------------------------------------------------------------------------------------------------------
exec uspEditARTRegimenDetails '100273001', 'D001', '2*2', 2, 12, '2*3'

**************************************************************************************************************/

-- select * from ARTRegimenDetails
-- delete from ARTRegimenDetails

--------Get ART Regimen Details-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetARTRegimenDetails')
	drop proc uspGetARTRegimenDetails
go

create proc uspGetARTRegimenDetails(
@VisitNo as varchar(20) = null,
@DrugNo varchar(20) = null
)with encryption as

if (not @VisitNo is null ) and (not @DrugNo is null)
	begin
		select VisitNo, dbo.GetMergedNameCode(DrugName, ARTRegimenDetails.DrugNo) as DrugFullName, 
		Dosage, Duration, Quantity, Formula from ARTRegimenDetails
		inner join Drugs on ARTRegimenDetails.DrugNo = Drugs.DrugNo 
		where VisitNo = @VisitNo and ARTRegimenDetails.DrugNo = @DrugNo
	end

if (not @VisitNo is null ) and (@DrugNo is null)
	begin
		select VisitNo, dbo.GetMergedNameCode(DrugName, ARTRegimenDetails.DrugNo) as DrugFullName, 
		Dosage, Duration, Quantity, Formula from ARTRegimenDetails
		inner join Drugs on ARTRegimenDetails.DrugNo = Drugs.DrugNo 
		where VisitNo = @VisitNo 
	end

return 0

go

-- select * from ARTRegimenDetails
-- exec uspGetARTRegimenDetails '06000001001', 'M 0005'
-- exec uspGetARTRegimenDetails '06000001001', null
-- exec uspGetARTRegimenDetails '06000002001', null

--------Get ART Currently On-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetARTCurrentlyOn')
	drop proc uspGetARTCurrentlyOn
go

create proc uspGetARTCurrentlyOn(
@PatientNo varchar(20),
@ARTStatusID varchar(10)
)with encryption as

begin
	select StaffNo, RefillDuration, ARTRegimenDetails.VisitNo, ARTRegimenDetails.DrugNo, 
	Dosage, Duration, Quantity, Formula, UnitPrice
	from ARTRegimenDetails
	inner join ARTRegimen on ARTRegimenDetails.VisitNo = ARTRegimen.VisitNo
	inner join Drugs on ARTRegimenDetails.DrugNo = Drugs.DrugNo
	where ARTRegimenDetails.VisitNo = (select top 1 ARTRegimen.VisitNo from ARTRegimen
	inner join Visits on ARTRegimen.VisitNo = Visits.VisitNo
	where StartDate in (select Max(StartDate) from ARTRegimen
	inner join Visits on ARTRegimen.VisitNo = Visits.VisitNo
	where PatientNO = @PatientNo) and PatientNO = @PatientNo and ARTStatusID = @ARTStatusID
	order by VisitID desc)
end

return 0

go

-- select * from ARTRegimenDetails
-- exec uspGetARTCurrentlyOn '07000001', '24O'
-- exec uspGetARTCurrentlyOn '0045075TJ', '24O'
-- exec uspGetARTCurrentlyOn '010609NA', '24O'

------------------------------------------------------------------------------------------------------
------------- ARTStopped -----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert ART Stopped----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertARTStopped')
	drop proc uspInsertARTStopped
go

create proc uspInsertARTStopped(
@VisitNo varchar(20),
@StopDate smalldatetime,
@ARTStopReasons varchar(200),
@StaffNo varchar(10),
@LoginID varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from ARTRegimen where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered ART Regimen'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if exists(select VisitNo from ARTStopped where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Staff No', @StaffNo, 'Staff')	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
begin
insert into ARTStopped
(VisitNo, StopDate, ARTStopReasons, StaffNo, LoginID) 
values
(@VisitNo, @StopDate, @ARTStopReasons, @StaffNo, @LoginID)

-- Update ART Regimen table

	begin
		declare @ARTStatusID varchar(10)		
		set @ARTStatusID = dbo.GetLookupDataID('ARTStatus', 'S')
	
		update ARTRegimen set 
		ARTStatusID = @ARTStatusID 
		where VisitNo = @VisitNo

----------------------------------------------------
		exec uspUpdatePatientCombinationOn @VisitNo
----------------------------------------------------

	end

return 0
end
go

/********************************************************************************************************************
exec uspInsertARTStopped '07000001001', '04 Oct 2006', '293', '100', 'Kutegz'

*********************************************************************************************************************/

-- select * from ARTStopped
-- delete from ARTStopped

---------Update ART Stopped------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateARTStopped')
	drop proc uspUpdateARTStopped
go

create proc uspUpdateARTStopped(
@VisitNo varchar(20),
@StopDate smalldatetime,
@ARTStopReasons varchar(200),
@StaffNo varchar(10),
@LoginID varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from ARTRegimen where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: ' + @VisitNo + ', you are trying to enter does not exist in the registered ART Regimen'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select VisitNo from ARTStopped where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The Visit No: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, @VisitNo, 'ART Stopped')	
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Staff No', @StaffNo, 'Staff')	
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
begin
	update ARTStopped set
	StopDate = @StopDate, ARTStopReasons = @ARTStopReasons, StaffNo = @StaffNo, LoginID = @LoginID
	where VisitNo = @VisitNo

-----------------------------------------------
	exec uspUpdatePatientCombinationOn @VisitNo
-----------------------------------------------
	return 0
end
go


/********************************************************************************************************************
--1------------------------------------------------------------------------------------------------------------------
exec uspUpdateARTStopped '07000001001', '04 Oct 2006', '291,293', '100', 'Kutegz'

********************************************************************************************************************/

-- select * from ARTStopped
-- delete from ARTStopped

------------Delete ARTStopped--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspDeleteARTStopped')
	drop proc uspDeleteARTStopped
go

create proc uspDeleteARTStopped(
@VisitNo varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from ARTStopped where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16, 1, 'Visit No', @VisitNo, 'ART Stopped')	
		return 1
	end

else
begin tran

delete ARTStopped where VisitNo = @VisitNo
exec uspUpdatePatientCombinationOn @VisitNo

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
return 0
go

-- exec uspDeleteARTStopped '003/05023'
-- select * from ARTStopped

--------Get ARTStopped -------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetARTStopped')
	drop proc uspGetARTStopped
go

create proc uspGetARTStopped(
@VisitNo as varchar(20) = null 
)with encryption as

declare @ErrorMSG varchar(200)

if not (@VisitNo is null)
begin
	if not exists(select VisitNo from ARTStopped where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Visit No', @VisitNo, 'ART Stopped')	
		return 1
	end
	begin
		select VisitNo, StopDate, dbo.GetLookupDataName(ARTStopReasons) as [ARTStopReasons], 
		dbo.GetMergedNameCode(dbo.GetFullName(LastName, null, FirstName), ARTStopped.StaffNo) as StaffFullName
		from ARTStopped
		inner join Staff on ARTStopped.StaffNo = Staff.StaffNo 		
		where VisitNo = @VisitNo	
	end
end
else
if (@VisitNo is null)
	begin
		select VisitNo, StopDate, dbo.GetLookupDataName(ARTStopReasons) as [ARTStopReasons], 
		dbo.GetMergedNameCode(dbo.GetFullName(LastName, null, FirstName), ARTStopped.StaffNo) as StaffFullName
		from ARTStopped
		inner join Staff on ARTStopped.StaffNo = Staff.StaffNo 	
	end


return 0

go

-- select * from ARTStopped
-- exec uspGetARTStopped '06000001001'
-- exec uspGetARTStopped null

------------------------------------------------------------------------------------------------------
------------- Expenditure ----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
------------- Expenditure ----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Expenditure --------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertExpenditure')
	drop proc uspInsertExpenditure
go

create proc uspInsertExpenditure(
@ExpenditureNo varchar(20),
@SpentDate smalldatetime,
@ExpenditureCategoryID varchar(10),
@ExpenditureSourceTypeID varchar(10),
@AccountNo varchar(20),
@ExchangeRate money,
@GivenTo varchar(40),
@Amount money,
@DocumentNo varchar(20),
@Details varchar(100),
@BranchID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @ExpenditureID int

if exists(select ExpenditureNo from Expenditure where ExpenditureNo = @ExpenditureNo)
	begin
		set @ErrorMSG = 'The Expenditure No: ' + @ExpenditureNo + ', you are trying to enter already exists'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ExpenditureCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Expenditure Category ID', @ExpenditureCategoryID, 'Lookup Data')
		return 1
	end

	if not exists(select DataID from LookupData where DataID = @BranchID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Branch ID', @BranchID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The Login ID: ' + @LoginID + ', you are trying to enter does not exist in the registered Logins'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

else
begin

set @ExpenditureID = (select  max(ExpenditureID) from Expenditure)
set @ExpenditureID = dbo.GetNextAutoNumber('Expenditure', 'ExpenditureNo', @ExpenditureID)

insert into Expenditure
(ExpenditureID, ExpenditureNo, SpentDate ,ExpenditureCategoryID, ExpenditureSourceTypeID, AccountNo, ExchangeRate, GivenTo,Amount, DocumentNo, Details,BranchID, LoginID, ClientMachine)
values
(@ExpenditureID, @ExpenditureNo, @SpentDate ,@ExpenditureCategoryID ,@ExpenditureSourceTypeID, @AccountNo,@ExchangeRate,@GivenTo ,@Amount ,@DocumentNo, @Details,@BranchID,@LoginID, @ClientMachine)
return 0
end
go

/*********************************************************************
--1-------------------------------------------------------------------
exec uspInsertExpenditure '00001', '1 may 2005', 'S001', 'Moses Byaruhanga', 10000,
			'Transport to Town', 'Admin'

*********************************************************************/

-- select *  from Expenditure
-- delete from Expenditure

--------GetExpenditure----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExpenditure')
	drop proc uspGetExpenditure
go

create proc uspGetExpenditure(
@ExpenditureNo varchar(20) = null,
@StartDateTime smalldatetime = null,
@EndDateTime smalldatetime = null,
@LoginID varchar(20) = null,
@BranchID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@ExpenditureNo is null) and (@StartDateTime is null) and (@EndDateTime is null) and (@LoginID is null) and (@BranchID is null)
	begin
		if not exists(select ExpenditureNo from Expenditure where ExpenditureNo = @ExpenditureNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Expenditure No', @ExpenditureNo, 'Expenditure')
				return 1
			end
		else
			begin
				select dbo.FormatText(ExpenditureNo, 'Expenditure', 'ExpenditureNo') as ExpenditureNo, 
				dbo.FormatDate(SpentDate) as SpentDate, GivenTo,
				dbo.GetLookupDataDes(ExpenditureCategoryID) as ExpenditureCategory, ExpenditureSourceTypeID,
				 dbo.GetLookupDataDes(ExpenditureSourceTypeID) as ExpenditureSourceType, BankNameID, dbo.GetLookupDataDes(BankNameID) as BankName, Expenditure.AccountNo, AccountName, ExchangeRate,
				dbo.GetLookupDataDes(BranchID) as BranchName,
				dbo.FormatMoney(Amount) as Amount, DocumentNo, Details, Expenditure.LoginID,
				dbo.FormatDate(Expenditure.RecordDateTime) as RecordDate, dbo.GetTime(Expenditure.RecordDateTime) as RecordTime
				from Expenditure left outer join BankAccounts on Expenditure.AccountNo= BankAccounts.AccountNo
				where ExpenditureNo = @ExpenditureNo
			end
	end	
else if (@ExpenditureNo is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and (@LoginID is null) and (@BranchID is null)
	begin
		select dbo.FormatText(ExpenditureNo, 'Expenditure', 'ExpenditureNo') as ExpenditureNo, 
				dbo.FormatDate(SpentDate) as SpentDate, GivenTo,
				dbo.GetLookupDataDes(ExpenditureCategoryID) as ExpenditureCategory, ExpenditureSourceTypeID,
				 dbo.GetLookupDataDes(ExpenditureSourceTypeID) as ExpenditureSourceType, BankNameID, dbo.GetLookupDataDes(BankNameID) as BankName, Expenditure.AccountNo, AccountName, ExchangeRate,
				dbo.GetLookupDataDes(BranchID) as BranchName,
				dbo.FormatMoney(Amount) as Amount, DocumentNo, Details, Expenditure.LoginID,
				dbo.FormatDate(Expenditure.RecordDateTime) as RecordDate, dbo.GetTime(Expenditure.RecordDateTime) as RecordTime
				from Expenditure left outer join BankAccounts on Expenditure.AccountNo= BankAccounts.AccountNo
		where Expenditure.RecordDateTime between @StartDateTime and @EndDateTime
		order by SpentDate, Expenditure.RecordDateTime
	end
else if (@ExpenditureNo is null) and (@BranchID is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null)
	begin
		select dbo.FormatText(ExpenditureNo, 'Expenditure', 'ExpenditureNo') as ExpenditureNo, 
				dbo.FormatDate(SpentDate) as SpentDate, GivenTo,
				dbo.GetLookupDataDes(ExpenditureCategoryID) as ExpenditureCategory, ExpenditureSourceTypeID,
				 dbo.GetLookupDataDes(ExpenditureSourceTypeID) as ExpenditureSourceType, BankNameID, dbo.GetLookupDataDes(BankNameID) as BankName, Expenditure.AccountNo, AccountName, ExchangeRate,
				dbo.GetLookupDataDes(BranchID) as BranchName,
				dbo.FormatMoney(Amount) as Amount, DocumentNo, Details, Expenditure.LoginID,
				dbo.FormatDate(Expenditure.RecordDateTime) as RecordDate, dbo.GetTime(Expenditure.RecordDateTime) as RecordTime
				from Expenditure left outer join BankAccounts on Expenditure.AccountNo= BankAccounts.AccountNo
		where Expenditure.RecordDateTime between @StartDateTime and @EndDateTime and Expenditure.LoginID = @LoginID
		order by SpentDate, Expenditure.RecordDateTime
	end

	else if (@ExpenditureNo is null) and not (@BranchID is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null)
	begin
		select dbo.FormatText(ExpenditureNo, 'Expenditure', 'ExpenditureNo') as ExpenditureNo, 
				dbo.FormatDate(SpentDate) as SpentDate, GivenTo,
				dbo.GetLookupDataDes(ExpenditureCategoryID) as ExpenditureCategory, ExpenditureSourceTypeID,
				 dbo.GetLookupDataDes(ExpenditureSourceTypeID) as ExpenditureSourceType, BankNameID, dbo.GetLookupDataDes(BankNameID) as BankName, Expenditure.AccountNo, AccountName, ExchangeRate,
				dbo.GetLookupDataDes(BranchID) as BranchName,
				dbo.FormatMoney(Amount) as Amount, DocumentNo, Details, Expenditure.LoginID,
				dbo.FormatDate(Expenditure.RecordDateTime) as RecordDate, dbo.GetTime(Expenditure.RecordDateTime) as RecordTime
				from Expenditure left outer join BankAccounts on Expenditure.AccountNo= BankAccounts.AccountNo
		where Expenditure.RecordDateTime between @StartDateTime and @EndDateTime and Expenditure.LoginID = @LoginID and BranchID =@BranchID
		order by SpentDate, Expenditure.RecordDateTime
	end
	else if (@ExpenditureNo is null) and not (@BranchID is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and (@LoginID is null)
	begin
		select dbo.FormatText(ExpenditureNo, 'Expenditure', 'ExpenditureNo') as ExpenditureNo, 
				dbo.FormatDate(SpentDate) as SpentDate, GivenTo,
				dbo.GetLookupDataDes(ExpenditureCategoryID) as ExpenditureCategory, ExpenditureSourceTypeID,
				 dbo.GetLookupDataDes(ExpenditureSourceTypeID) as ExpenditureSourceType, BankNameID, dbo.GetLookupDataDes(BankNameID) as BankName, Expenditure.AccountNo, AccountName, ExchangeRate,
				dbo.GetLookupDataDes(BranchID) as BranchName,
				dbo.FormatMoney(Amount) as Amount, DocumentNo, Details, Expenditure.LoginID,
				dbo.FormatDate(Expenditure.RecordDateTime) as RecordDate, dbo.GetTime(Expenditure.RecordDateTime) as RecordTime
				from Expenditure left outer join BankAccounts on Expenditure.AccountNo= BankAccounts.AccountNo
		where Expenditure.RecordDateTime between @StartDateTime and @EndDateTime and BranchID =@BranchID
		order by SpentDate, Expenditure.RecordDateTime
	end
else 
	begin
		select dbo.FormatText(ExpenditureNo, 'Expenditure', 'ExpenditureNo') as ExpenditureNo, 
				dbo.FormatDate(SpentDate) as SpentDate, GivenTo,
				dbo.GetLookupDataDes(ExpenditureCategoryID) as ExpenditureCategory, ExpenditureSourceTypeID,
				 dbo.GetLookupDataDes(ExpenditureSourceTypeID) as ExpenditureSourceType, BankNameID, dbo.GetLookupDataDes(BankNameID) as BankName, Expenditure.AccountNo, AccountName, ExchangeRate,
				dbo.GetLookupDataDes(BranchID) as BranchName,
				dbo.FormatMoney(Amount) as Amount, DocumentNo, Details, Expenditure.LoginID,
				dbo.FormatDate(Expenditure.RecordDateTime) as RecordDate, dbo.GetTime(Expenditure.RecordDateTime) as RecordTime
				from Expenditure left outer join BankAccounts on Expenditure.AccountNo= BankAccounts.AccountNo
	end	
return 0
go

/******************************************************************************************************
exec uspGetExpenditure '00002'
exec uspGetExpenditure null, '1 Mar 2013', '3 Mar 2013'
exec uspGetExpenditure null, '1 Mar 2013', '3 Mar 2013', 'Admin'
exec uspGetExpenditure 

******************************************************************************************************/
-- select * from Expenditure

--------GetSummarizedPeriodicExpenditure----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetSummarizedPeriodicExpenditure')
	drop proc uspGetSummarizedPeriodicExpenditure
go

create proc uspGetSummarizedPeriodicExpenditure(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime,
@LoginID varchar(20) = null,
@BranchID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

------------------------------------LoginID and BranchID null-------------------------------------------------
 if (@LoginID is null) and (@BranchID is null)
	begin
		select  distinct ExpenditureCategoryID, dbo.GetLookupDataDes(ExpenditureCategoryID) as ExpenditureCategory, 
		dbo.FormatMoney(dbo.GetExpenditureCategoryTotal(ExpenditureCategoryID,@StartDateTime,@EndDateTime)) as ExpenditureCategoryTotal  
		from Expenditure
		where RecordDateTime between @StartDateTime and @EndDateTime
		order by ExpenditureCategoryID asc
	end

	--------------only BranchID null-----------------------------------------------------------------------------------------
else if (@BranchID is null)  and not(@LoginID is null)
	begin
		select  distinct ExpenditureCategoryID, dbo.GetLookupDataDes(ExpenditureCategoryID) as ExpenditureCategory, 
		dbo.FormatMoney(dbo.GetExpenditureCategoryTotal(ExpenditureCategoryID,@StartDateTime,@EndDateTime)) as ExpenditureCategoryTotal 
		from Expenditure
		where RecordDateTime between @StartDateTime and @EndDateTime and LoginID = @LoginID
		order by ExpenditureCategoryID asc
	end

	--------------------------------only LoginID null
	else if  not (@BranchID is null)  and (@LoginID is null)
	begin
		select  distinct ExpenditureCategoryID, dbo.GetLookupDataDes(ExpenditureCategoryID) as ExpenditureCategory, 
		dbo.FormatMoney(dbo.GetExpenditureCategoryTotal(ExpenditureCategoryID,@StartDateTime,@EndDateTime)) as ExpenditureCategoryTotal from Expenditure
		where RecordDateTime between @StartDateTime and @EndDateTime and BranchID =@BranchID
		order by ExpenditureCategoryID asc
	end

	--------------------------both not null------------------------------------------------------------------------
	else if  not (@BranchID is null)  and not(@LoginID is null)
	begin
		select  distinct ExpenditureCategoryID, dbo.GetLookupDataDes(ExpenditureCategoryID) as ExpenditureCategory, 
		dbo.FormatMoney(dbo.GetExpenditureCategoryTotal(ExpenditureCategoryID,@StartDateTime,@EndDateTime)) as ExpenditureCategoryTotal from Expenditure
		where RecordDateTime between @StartDateTime and @EndDateTime and LoginID = @LoginID and BranchID =@BranchID
		order by ExpenditureCategoryID asc
	end
	

return 0
go

/******************************************************************************************************
exec uspGetSummarizedPeriodicExpenditure '1 Mar 2013', '3 Mar 2017',null, null
exec uspGetSummarizedPeriodicExpenditure '1 Mar 2013', '3 Mar 2013', 'Admin', null
exec uspGetSummarizedPeriodicExpenditure  '1 Mar 2013', '3 Mar 2013', 'Admin',''
******************************************************************************************************/

--------Get Next Expenditure ID-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextExpenditureID')
	drop proc uspGetNextExpenditureID
go

create proc uspGetNextExpenditureID(
@ExpenditureID int = null output
)with encryption as

set @ExpenditureID = (select  max(ExpenditureID) from Expenditure)
set @ExpenditureID = dbo.GetNextAutoNumber('Expenditure', 'ExpenditureNo', @ExpenditureID)

return 0

go

-- exec uspGetNextExpenditureID
-- select * from Expenditure

------------------------------------------------------------------------------------------------------
------------- OtherIncome ----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

---------Insert Other Income -------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertOtherIncome')
	drop proc uspInsertOtherIncome
go

create proc uspInsertOtherIncome(
@IncomeNo varchar(20),
@IncomeDate smalldatetime,
@IncomeSourcesID varchar(10),
@PayModesID varchar(10),
@Amount money,
@CurrenciesID varchar(10),
@AmountTendered money,
@ExchangeRate money,
@Change money,
@DocumentNo varchar(20),
@Notes varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @IncomeID int
declare @BranchID varchar(10)

if exists(select IncomeNo from OtherIncome where IncomeNo = @IncomeNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Income No', @IncomeNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @IncomeSourcesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Income Sources ID', @IncomeSourcesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayModesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pay Modes ID', @PayModesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CurrenciesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrenciesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

else
begin
set @BranchID = dbo.GetMyCurrentBranch(@LoginID)
set @IncomeID = (select  max(IncomeID) from OtherIncome)
set @IncomeID = dbo.GetNextAutoNumber('OtherIncome', 'IncomeNo', @IncomeID)

insert into OtherIncome
(IncomeID, IncomeNo, IncomeDate, IncomeSourcesID, PayModesID, Amount, CurrenciesID, 
AmountTendered, ExchangeRate, Change, DocumentNo, Notes, LoginID,BranchID, ClientMachine)
values
(@IncomeID, @IncomeNo, @IncomeDate, @IncomeSourcesID, @PayModesID, @Amount, @CurrenciesID, 
@AmountTendered, @ExchangeRate, @Change, @DocumentNo, @Notes, @LoginID,@BranchID, @ClientMachine)
return 0
end
go

/************************************************************************************
exec uspInsertOtherIncome '00005', '1 may 2012', '48CAF', 10000, 'Donation', 'Admin'

************************************************************************************/

-- select *  from OtherIncome
-- delete from OtherIncome

--------GetOtherIncome----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetOtherIncome')
	drop proc uspGetOtherIncome
go

create proc uspGetOtherIncome(
@IncomeNo varchar(20) = null,
@StartDateTime smalldatetime = null,
@EndDateTime smalldatetime = null,
@LoginID varchar(20) = null,
@BranchID varchar(10) =null
)with encryption as

declare @ErrorMSG varchar(200)

if not (@IncomeNo is null) and (@StartDateTime is null) and (@EndDateTime is null) and (@LoginID is null) and (@BranchID is null)
	begin
		if not exists(select IncomeNo from OtherIncome where IncomeNo = @IncomeNo)
			begin
				set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Income No', @IncomeNo, 'Other Income')
				return 1
			end
		else
			begin
				select dbo.FormatText(IncomeNo, 'OtherIncome', 'IncomeNo') as IncomeNo, 
				dbo.FormatDate(IncomeDate) as IncomeDate, 
				dbo.GetLookupDataDes(IncomeSourcesID) as IncomeSource,
				dbo.GetLookupDataDes(PayModesID) as PayModes, 
				dbo.FormatMoney(Amount) as Amount, dbo.GetLookupDataDes(CurrenciesID) as Currency,
				dbo.GetLookupDataDes(BranchID) as BranchName, 
				AmountTendered, ExchangeRate, Change, DocumentNo, Notes, LoginID,
				dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
				from OtherIncome
				where IncomeNo = @IncomeNo
			end
	end	
else if (@IncomeNo is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and (@LoginID is null) and (@BranchID is null)
	begin
		select dbo.FormatText(IncomeNo, 'OtherIncome', 'IncomeNo') as IncomeNo, 
		dbo.FormatDate(IncomeDate) as IncomeDate, 
		dbo.GetLookupDataDes(IncomeSourcesID) as IncomeSource,
		dbo.GetLookupDataDes(PayModesID) as PayModes,
		dbo.GetLookupDataDes(BranchID) as BranchName, 
		dbo.FormatMoney(Amount) as Amount, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, Change, DocumentNo, Notes, LoginID,
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
		from OtherIncome
		where RecordDateTime between @StartDateTime and @EndDateTime
		order by IncomeDate, RecordDateTime
	end
else if (@IncomeNo is null) and (@BranchID is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null) 
	begin
		select dbo.FormatText(IncomeNo, 'OtherIncome', 'IncomeNo') as IncomeNo, 
		dbo.FormatDate(IncomeDate) as IncomeDate, 
		dbo.GetLookupDataDes(IncomeSourcesID) as IncomeSource,
		dbo.GetLookupDataDes(PayModesID) as PayModes,dbo.GetLookupDataDes(BranchID) as BranchName,
		dbo.FormatMoney(Amount) as Amount, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, Change, DocumentNo, Notes, LoginID,
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
		from OtherIncome
		where RecordDateTime between @StartDateTime and @EndDateTime and LoginID = @LoginID
		order by IncomeDate, RecordDateTime
	end

		else if (@IncomeNo is null) and (@LoginID is null)and not(@StartDateTime is null) and not(@EndDateTime is null) and not (@BranchID is null)
	begin
		select dbo.FormatText(IncomeNo, 'OtherIncome', 'IncomeNo') as IncomeNo, 
		dbo.FormatDate(IncomeDate) as IncomeDate, 
		dbo.GetLookupDataDes(IncomeSourcesID) as IncomeSource,
		dbo.GetLookupDataDes(PayModesID) as PayModes,dbo.GetLookupDataDes(BranchID) as BranchName,
		dbo.FormatMoney(Amount) as Amount, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, Change, DocumentNo, Notes, LoginID,
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
		from OtherIncome
		where RecordDateTime between @StartDateTime and @EndDateTime and BranchID = @BranchID
		order by IncomeDate, RecordDateTime
	end

else if (@IncomeNo is null) and not(@StartDateTime is null) and not(@EndDateTime is null) and not(@LoginID is null) and not (@BranchID is null)
	begin
		select dbo.FormatText(IncomeNo, 'OtherIncome', 'IncomeNo') as IncomeNo, 
		dbo.FormatDate(IncomeDate) as IncomeDate, 
		dbo.GetLookupDataDes(IncomeSourcesID) as IncomeSource,
		dbo.GetLookupDataDes(PayModesID) as PayModes,dbo.GetLookupDataDes(BranchID) as BranchName,
		dbo.FormatMoney(Amount) as Amount, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, Change, DocumentNo, Notes, LoginID,
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
		from OtherIncome
		where RecordDateTime between @StartDateTime and @EndDateTime and LoginID = @LoginID and BranchID = @BranchID
		order by IncomeDate, RecordDateTime
	end



else 
	begin
		select dbo.FormatText(IncomeNo, 'OtherIncome', 'IncomeNo') as IncomeNo, 
		dbo.FormatDate(IncomeDate) as IncomeDate, 
		dbo.GetLookupDataDes(IncomeSourcesID) as IncomeSource,
		dbo.GetLookupDataDes(PayModesID) as PayModes,dbo.GetLookupDataDes(BranchID) as BranchName,
		dbo.FormatMoney(Amount) as Amount, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
		AmountTendered, ExchangeRate, Change, DocumentNo, Notes, LoginID,
		dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
		from OtherIncome
	end	
return 0
go

/******************************************************************************************************
exec uspGetOtherIncome '00020'
exec uspGetOtherIncome null, '21 Jun 2012', '24 Jun 2012'
exec uspGetOtherIncome null, '27 May 2012', '24 Jun 2012', 'Joe'
exec uspGetOtherIncome 

******************************************************************************************************/
-- select * from OtherIncome

--------GetNextIncomeID-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextIncomeID')
	drop proc uspGetNextIncomeID
go

create proc uspGetNextIncomeID(
@IncomeID int = null output
)with encryption as

set @IncomeID = (select  max(IncomeID) from OtherIncome)
set @IncomeID = dbo.GetNextAutoNumber('OtherIncome', 'IncomeNo', @IncomeID)

return 0

go

-- exec uspGetNextIncomeID
-- select * from OtherIncome

------------------------------------------------------------------------------------------------------
-------------- Templates -----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Templates ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertTemplates')
	drop proc uspInsertTemplates
go

create proc uspInsertTemplates(
@TemplateName varchar(40),
@TemplateTypeID varchar(10),
@Notes varchar(2000)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select TemplateName from Templates where TemplateName = @TemplateName)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Template Name', @TemplateName)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TemplateTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Template Type', @TemplateTypeID, 'Lookup Data')
		return 1
	end

begin
insert into Templates
(TemplateName, TemplateTypeID, Notes)
values
(@TemplateName, @TemplateTypeID, @Notes)
return 0
end
go

/******************************************************************************************************
exec uspInsertTemplates 'HIV1/2SerologyScreeningNEG', '4101', 
						'A REPEAT AFTER 3 MONTHS IS ADVISED TO RULE OUT THE WINDOW PERIOD'

exec uspInsertTemplates 'HIV1/2SerologyScreeningPOS', '4101', 
						'YOU ARE REQUIRED TO DO A CONFIRMATORY TEST'

exec uspInsertTemplates 'ExamBoneReport', '4102', 
						'Bone mineralization is normal. The alignment is preserved.  
						 The vertebral bodies and posterior elements appear normal. 
						 The disc spaces appear normal. There is no paravertebral soft tissues shadow'

******************************************************************************************************/
-- select * from Templates
-- delete from Templates

-------------- Update Templates -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateTemplates')
	drop proc uspUpdateTemplates
go

create proc uspUpdateTemplates(
@TemplateName varchar(40),
@TemplateTypeID varchar(10),
@Notes varchar(2000)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TemplateName from Templates where TemplateName = @TemplateName)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Template Name', @TemplateName, 'Templates')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TemplateTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Template Type', @TemplateTypeID, 'Lookup Data')
		return 1
	end

begin
update Templates set
TemplateTypeID = @TemplateTypeID, Notes = @Notes
where TemplateName = @TemplateName
return 0
end
go

/******************************************************************************************************
exec uspUpdateTemplates 'HIV1/2SerologyScreeningNEG', '4101', 
						'A REPEAT AFTER 3 MONTHS IS ADVISED TO RULE OUT THE WINDOW PERIOD'
******************************************************************************************************/
-- select * from Templates
-- delete from Templates

-------------- Get Templates -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTemplates')
	drop proc uspGetTemplates
go

create proc uspGetTemplates(
@TemplateName varchar(40) = null,
@TemplateTypeID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@TemplateName is null) and (@TemplateTypeID is null))
begin
	if not exists(select TemplateName from Templates where TemplateName = @TemplateName)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Template Name', @TemplateName, 'Templates')
			return 1
		end
	else
	begin
		select TemplateName, TemplateTypeID, dbo.GetLookupDataDes(TemplateTypeID) as TemplateType, Notes
		from Templates
		where TemplateName = @TemplateName
	end
end

else
if ((@TemplateName is null) and not (@TemplateTypeID is null))
begin
	select TemplateName, TemplateTypeID, dbo.GetLookupDataDes(TemplateTypeID) as TemplateType, Notes
	from Templates
	where TemplateTypeID = @TemplateTypeID
end

else
if ((@TemplateName is null) and (@TemplateTypeID is null))
begin
	select TemplateName, TemplateTypeID, dbo.GetLookupDataDes(TemplateTypeID) as TemplateType, Notes
	from Templates
end
return 0
go

/******************************************************************************************************
exec uspGetTemplates 
exec uspGetTemplates 'HIV1/2SerologyScreeningNEG'
exec uspGetTemplates null, '4102'

******************************************************************************************************/
-- select * from Templates
-- delete from Templates

------------------------------------------------------------------------------------------------------
-------------- ImportDataInfo ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ImportDataInfo -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertImportDataInfo')
	drop proc uspInsertImportDataInfo
go

create proc uspInsertImportDataInfo(
@ItemCode varchar(20),
@SourceName varchar(60),
@SourceCaption varchar(100),
@DatabaseTypeID varchar(10),
@ConnectionModeID varchar(10),
@ImportServer varchar(100),
@ImportLogin varchar(100),
@ImportPassword nvarchar(100),
@SP_Name varchar(100)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TestCode from LabTests where TestCode  = @ItemCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Test Code', @ItemCode, 'Lab Tests')
		return 1
	end

if exists(select ItemCode from ImportDataInfo where ItemCode = @ItemCode and SourceName = @SourceName and SourceCaption = @SourceCaption)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Source Name', @SourceName, 'Source Caption', @SourceCaption)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DatabaseTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Database Type ID', @DatabaseTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ConnectionModeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Connection Mode ID', @ConnectionModeID, 'Lookup Data')
		return 1
	end
	
begin
insert into ImportDataInfo
(ItemCode, SourceName, SourceCaption, DatabaseTypeID, ConnectionModeID, ImportServer, ImportLogin, ImportPassword, SP_Name)
values
(@ItemCode, @SourceName, @SourceCaption, @DatabaseTypeID, @ConnectionModeID, @ImportServer, @ImportLogin, @ImportPassword, @SP_Name)
return 0
end
go

/******************************************************************************************************
exec uspInsertImportDataInfo
******************************************************************************************************/
-- select * from ImportDataInfo
-- delete from ImportDataInfo

-------------- Update ImportDataInfo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateImportDataInfo')
	drop proc uspUpdateImportDataInfo
go

create proc uspUpdateImportDataInfo(
@ItemCode varchar(20),
@SourceName varchar(60),
@SourceCaption varchar(100),
@DatabaseTypeID varchar(10),
@ConnectionModeID varchar(10),
@ImportServer varchar(100),
@ImportLogin varchar(100),
@ImportPassword nvarchar(100),
@SP_Name varchar(100)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TestCode from LabTests where TestCode  = @ItemCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Test Code', @ItemCode, 'Lab Tests')
		return 1
	end

if not exists(select ItemCode from ImportDataInfo where ItemCode = @ItemCode and SourceName = @SourceName and SourceCaption = @SourceCaption)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Source Name', @SourceName, 'Source Caption', @SourceCaption, 'Import Data Info')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DatabaseTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Database Type ID', @DatabaseTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ConnectionModeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Connection Mode ID', @ConnectionModeID, 'Lookup Data')
		return 1
	end

begin
update ImportDataInfo set
DatabaseTypeID = @DatabaseTypeID, ConnectionModeID = @ConnectionModeID, ImportServer = @ImportServer, 
ImportLogin = @ImportLogin, ImportPassword = @ImportPassword, SP_Name = @SP_Name
where ItemCode = @ItemCode and SourceName = @SourceName and SourceCaption = @SourceCaption
return 0
end
go

/******************************************************************************************************
exec uspUpdateImportDataInfo
******************************************************************************************************/
-- select * from ImportDataInfo
-- delete from ImportDataInfo

-------------- Get ImportDataInfo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetImportDataInfo')
	drop proc uspGetImportDataInfo
go

create proc uspGetImportDataInfo(
@ItemCode varchar(20),
@SourceName varchar(60),
@SourceCaption varchar(100)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ItemCode from ImportDataInfo where ItemCode = @ItemCode and SourceName = @SourceName and SourceCaption = @SourceCaption)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Source Name', @SourceName, 'Source Caption', @SourceCaption, 'Import Data Info')
		return 1
	end
else
begin
	select ImportDataInfo.ItemCode, SourceName, SourceCaption, 
	DatabaseTypeID, dbo.GetLookupDataDes(DatabaseTypeID) as DatabaseType, 
	ConnectionModeID, dbo.GetLookupDataDes(ConnectionModeID) as ConnectionMode, 
	ImportServer, ImportLogin, ImportPassword, SP_Name
	from ImportDataInfo
	where ItemCode = @ItemCode and SourceName = @SourceName and SourceCaption = @SourceCaption
return 0
end
go

/******************************************************************************************************
exec uspGetImportDataInfo
******************************************************************************************************/
-- select * from ImportDataInfo
-- delete from ImportDataInfo

-------------- Get ImportDataSources -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetImportDataSources')
	drop proc uspGetImportDataSources
go

create proc uspGetImportDataSources(
@ItemCode varchar(20)
)with encryption as

begin
	select SourceName, SourceCaption from ImportDataInfo where ItemCode = @ItemCode
return 0
end
go

/******************************************************************************************************
exec uspGetImportDataSources 'T138'
exec uspGetImportDataSources 'T192'

******************************************************************************************************/
-- select * from ImportDataInfo
-- delete from ImportDataInfo

------------------------------------------------------------------------------------------------------
-------------- OutwardFiles --------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert OutwardFiles -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertOutwardFiles')
	drop proc uspInsertOutwardFiles
go

create proc uspInsertOutwardFiles(
@OutwardNo varchar(20),
@FileNo varchar(20),
@TakenDateTime smalldatetime,
@TakenBy varchar(100),
@BillAccountName varchar(100),
@VisitNo varchar(20) = null,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

declare @OutwardID int

declare @PaddingLEN tinyint

declare @PassedOutwardID int
declare @PassedOutwardNo varchar(20)
declare @PassedFileNo varchar(20)

if not exists(select PatientNo from Patients where PatientNo  = @FileNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'File No', @FileNo, 'Patients')
		return 1
	end

if exists(select OutwardNo from OutwardFiles where OutwardNo = @OutwardNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Outward No', @OutwardNo)
		return 1
	end
	
if not (@VisitNo is null or @VisitNo = '') 
	begin
		if not exists(select VisitNo from Visits where VisitNo = @VisitNo and PatientNo = @FileNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s, or is not for %s: %s'
				raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits', 'File No', @FileNo)
				return 1
			end
	end
else if (@VisitNo is null or @VisitNo = '')
begin set @VisitNo = null end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select OutwardNo from OutwardFiles where FileNo = @FileNo and dbo.GetFileReturned(OutwardNo) = 0)
	begin
		set @ErrorMSG = 'The file with %s: %s, has not been returned. You can''t give out file not returned.'
		raiserror(@ErrorMSG, 16, 1, 'File No', @FileNo)
		return 1
	end

begin

----------------------------------------------------------------------------------------------------------
select @PaddingLEN = PaddingLEN from AutoNumbers where ObjectName = 'OutwardFiles' and AutoColumnName = 'OutwardNo'

set @PassedFileNo = ltrim(rtrim(substring(@OutwardNo, 1, len(@OutwardNo) - @PaddingLEN)))

if (@PassedFileNo = @FileNo)

begin

	set @PassedOutwardID = 1
	set @PassedOutwardNo = @OutwardNo

	set @PassedOutwardNo = ltrim(rtrim(substring(@PassedOutwardNo, len(@PassedFileNo) + 1, @PaddingLEN)))

	if isnumeric(@PassedOutwardNo) = 1 set @PassedOutwardID = @PassedOutwardNo
	else set @PassedOutwardID = 1

	set @OutwardID = (select max(OutwardID) from OutwardFiles where FileNo = @FileNo)
	set @OutwardID = dbo.GetNextAutoNumber('OutwardFiles', 'OutwardNo', @OutwardID)

	if @PassedOutwardID < @OutwardID set @OutwardID = @PassedOutwardID
	if @PassedOutwardID > @OutwardID set @OutwardID = @PassedOutwardID

end else set @OutwardID = 1

------------------------------------------------------------------------------------------------------------------------------------

insert into OutwardFiles
(OutwardID, OutwardNo, FileNo, TakenDateTime, TakenBy, BillAccountName, VisitNo, LoginID, ClientMachine)
values
(@OutwardID, @OutwardNo, @FileNo, @TakenDateTime, @TakenBy, @BillAccountName, @VisitNo, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertOutwardFiles '1402063001', '1402063', '15 Feb 2014 16:28', 'Reception', 'Cash Customer', 'Admin', 'SYNCSOFT'
exec uspInsertOutwardFiles '1402063002', '1402063', '15 Feb 2014 16:28', 'Reception', 'Cash Customer', 'Admin', 'SYNCSOFT'
exec uspInsertOutwardFiles '1402063005', '1402063', '15 Feb 2014 16:28', 'Reception', 'Cash Customer', 'Admin', 'SYNCSOFT'
exec uspInsertOutwardFiles '1401560001', '1401560', '15 Feb 2014 16:08', 'Dental', 'IDI', 'Admin', 'SYNCSOFT'

******************************************************************************************************/
-- select * from OutwardFiles
-- delete from OutwardFiles

-------------- Update OutwardFiles -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateOutwardFiles')
	drop proc uspUpdateOutwardFiles
go

create proc uspUpdateOutwardFiles(
@OutwardNo varchar(20),
--@FileNo varchar(20),
@TakenDateTime smalldatetime,
@TakenBy varchar(100),
@BillAccountName varchar(100),
@VisitNo varchar(20) = null,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @FileNo varchar(20)

-------------------------------------------------------------------------------------
set @FileNo = (select FileNo from OutwardFiles where OutwardNo = @OutwardNo)
-------------------------------------------------------------------------------------

if not exists(select OutwardNo from OutwardFiles where OutwardNo = @OutwardNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Outward No', @OutwardNo, 'Outward Files')
		return 1
	end
	
if not (@VisitNo is null or @VisitNo = '') 
	begin
		if not exists(select VisitNo from Visits where VisitNo  = @VisitNo and PatientNo  = @FileNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s, or is not for %s: %s'
				raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits', 'File No', @FileNo)
				return 1
			end
	end
else if (@VisitNo is null or @VisitNo = '')
begin set @VisitNo = null end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update OutwardFiles set --FileNo = @FileNo,
TakenDateTime = @TakenDateTime, TakenBy = @TakenBy, BillAccountName = @BillAccountName, 
VisitNo = @VisitNo, LoginID = @LoginID, ClientMachine = @ClientMachine
where OutwardNo = @OutwardNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateOutwardFiles '1401560001', '15 Feb 2014 12:08', 'Dental2', 'IDI2', 'Admin', 'SYNCSOFT'
exec uspUpdateOutwardFiles '1402063002', '15 Feb 2014 16:28', 'Reception', 'Cash Customer', 'Admin', 'SYNCSOFT'

******************************************************************************************************/
-- select * from OutwardFiles
-- delete from OutwardFiles

-------------- Get OutwardFiles -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetOutwardFiles')
	drop proc uspGetOutwardFiles
go

create proc uspGetOutwardFiles(
@OutwardNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select OutwardNo from OutwardFiles where OutwardNo = @OutwardNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Outward No', @OutwardNo, 'Outward Files')
		return 1
	end
else
begin
	select OutwardNo, FileNo, FirstName, LastName, MiddleName, Photo,	
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	BirthDate, JoinDate, ReferenceNo, Patients.Phone as [Phone], 
	dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.GetAgeInMonths(BirthDate, getdate()) as AgeInMonths, 
	dbo.GetAgeInDays(BirthDate, getdate()) as AgeInDays, VisitNo, 
	isnull(dbo.GetLastVisitDate(Patients.PatientNo),JoinDate) as LastVisitDate,
	dbo.GetLookupDataDes(GenderID) as Gender, TakenDateTime, TakenBy, BillAccountName
	from OutwardFiles
	inner join Patients on OutwardFiles.FileNo = Patients.PatientNo
	where OutwardNo = @OutwardNo
return 0
end
go

/******************************************************************************************************
exec uspGetOutwardFiles '1401560001'

******************************************************************************************************/
-- select * from OutwardFiles
-- delete from OutwardFiles

--------GetOutwardNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetOutwardNo')
	drop proc uspGetOutwardNo
go

create proc uspGetOutwardNo(
@FileNo varchar(20),
@TakenDateTime smalldatetime = null output,
@OutwardNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)

if (@TakenDateTime is null)
begin
	if not exists(select FileNo from OutwardFiles where FileNo = @FileNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'File No', @FileNo, 'Outward Files')	
		return 1
	end
	else
	begin
		set @OutwardNo = (select top 1 OutwardNo from OutwardFiles where FileNo = @FileNo
						and TakenDateTime = (select max(TakenDateTime) from OutwardFiles where FileNo = @FileNo)
						order by OutwardID desc)
	end
end
else
if not (@TakenDateTime is null)
begin

if not exists(select FileNo from OutwardFiles where FileNo = @FileNo and TakenDateTime = @TakenDateTime)
	begin
		set @ErrorMSG = '%s: %s and %s: ' + dbo.FormatDateTime(@TakenDateTime) + ', you are trying to enter does not exist %s'
		raiserror(@ErrorMSG,16,1, 'The record with File No', @FileNo, 'Taken Date Time', 'in the registered Outward Files')	
		return 1		
	end
	else
	begin
		set @OutwardNo = (select top 1 OutwardNo from OutwardFiles where FileNo = @FileNo
						and TakenDateTime = @TakenDateTime order by OutwardID desc)
	end
end

return 0

go

-- select * from patients
-- exec  uspGetOutwardNo '07022061'
-- exec uspGetOutwardNo '07022061', '23 Jan 2007'

--------Get NextOutwardID -----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextOutwardID')
	drop proc uspGetNextOutwardID
go

create proc uspGetNextOutwardID(
@FileNo varchar(20) ,
@OutwardID int = null output
)with encryption as

set @OutwardID = (select max(OutwardID) from OutwardFiles where FileNo = @FileNo)
set @OutwardID = dbo.GetNextAutoNumber('OutwardFiles', 'OutwardNo', @OutwardID)

return 0

go

-- exec uspGetNextOutwardID '08022077'
-- select * from OutwardFiles where FileNo = '08022077'

-----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetOutWardFilesSummary')
	drop proc uspGetOutWardFilesSummary
go

create proc uspGetOutWardFilesSummary(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

begin

select count(FileNo) as FilesOut,(select count (dbo.GetFileSeenDoctor(OutwardFiles.VisitNo,@StartDate , @EndDate)) as SeenDoctor 
from OutwardFiles where len(dbo.GetFileSeenDoctor(OutwardFiles.VisitNo,@StartDate , @EndDate)) >0) as SeenDoctor,
(select count (dbo.GetFileSeenDoctor(OutwardFiles.VisitNo,@StartDate , @EndDate))
from OutwardFiles 
where len(dbo.GetFileSeenDoctor(OutwardFiles.VisitNo,@StartDate , @EndDate)) < 1
and OutwardFiles.RecordDateTime between @StartDate and @EndDate) as NotSeenDoctor
from OutwardFiles
left outer join DoctorVisits on DoctorVisits.VisitNo =OutwardFiles.VisitNo
where OutwardFiles.RecordDateTime between @StartDate and @EndDate 
return 0
end
go

-----------------------------------------------------------------------------------------------------------------
-- exec uspGetOutWardFilesSummary 'Jan 12, 2017', 'May 20, 2018'
-----------------------------------------------------------------------------------------------------------------


-----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNotSeenOutWardFiles')
	drop proc uspGetNotSeenOutWardFiles
go

create proc uspGetNotSeenOutWardFiles(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

begin

select dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
 dbo.FormatDate(JoinDate) as JoinDate, Patients.Phone as [Phone], 
dbo.GetAge(BirthDate, getdate()) as Age, VisitNo, 
dbo.FormatDate(isnull(dbo.GetLastVisitDate(Patients.PatientNo),JoinDate)) as LastVisitDate,
dbo.GetLookupDataDes(GenderID) as Gender, TakenDateTime, TakenBy, BillAccountName from OutwardFiles
inner join Patients on Patients.PatientNo = OutwardFiles.FileNo
where len(dbo.GetFileSeenDoctor(OutwardFiles.VisitNo,@StartDate , @EndDate)) < 1
and OutwardFiles.RecordDateTime between @StartDate and @EndDate

return 0
end
go

-----------------------------------------------------------------------------------------------------------------
-- exec uspGetNotSeenOutWardFiles 'Jan 12, 2017', 'May 20, 2019'
-----------------------------------------------------------------------------------------------------------------

-----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDoctorSeenOutWardFiles')
	drop proc uspGetDoctorSeenOutWardFiles
go

create proc uspGetDoctorSeenOutWardFiles(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

begin

select dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
 dbo.FormatDate(JoinDate) as JoinDate, Patients.Phone as [Phone], 
dbo.GetAge(BirthDate, getdate()) as Age, OutwardFiles.VisitNo,
dbo.GetLookupDataDes(BillModesID) as BillMode,
isnull(dbo.FormatMoney(dbo.GetTotalBill(Visits.VisitNo, null)),0) as TotalBill,
isnull(dbo.FormatMoney(dbo.GetTotalBill(Visits.VisitNo, 'PF')),0) as TotalPaid,
isnull(dbo.FormatMoney(dbo.GetTotalBill(Visits.VisitNo, 'NP')),0) as BillBalance, 
dbo.FormatDate(isnull(dbo.GetLastVisitDate(Patients.PatientNo),JoinDate)) as LastVisitDate,
dbo.GetLookupDataDes(GenderID) as Gender, TakenDateTime, TakenBy, BillAccountName from OutwardFiles
inner join Patients on Patients.PatientNo = OutwardFiles.FileNo
inner join Visits on Visits.VisitNo =OutwardFiles.VisitNo

where len(dbo.GetFileSeenDoctor(OutwardFiles.VisitNo,@StartDate , @EndDate)) > 0
and OutwardFiles.RecordDateTime between @StartDate and @EndDate

return 0
end
go

-----------------------------------------------------------------------------------------------------------------
-- exec uspGetDoctorSeenOutWardFiles 'Jan 12, 2017', 'May 20, 2019'
-----------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
-------------- InwardFiles ---------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert InwardFiles --------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertInwardFiles')
	drop proc uspInsertInwardFiles
go

create proc uspInsertInwardFiles(
@OutwardNo varchar(20),
@ReturnDateTime smalldatetime,
@ReturnedBy varchar(100),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select OutwardNo from OutwardFiles where OutwardNo  = @OutwardNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Outward No', @OutwardNo, 'Outward Files')
		return 1
	end

if exists(select OutwardNo from InwardFiles where OutwardNo = @OutwardNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Outward No', @OutwardNo)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into InwardFiles
(OutwardNo, ReturnDateTime, ReturnedBy, LoginID, ClientMachine)
values
(@OutwardNo, @ReturnDateTime, @ReturnedBy, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertInwardFiles '1402063001', '15 Feb 2014 12:08', 'Dental2', 'Admin', 'SYNCSOFT'

******************************************************************************************************/
-- select * from InwardFiles
-- delete from InwardFiles

-------------- Update InwardFiles -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateInwardFiles')
	drop proc uspUpdateInwardFiles
go

create proc uspUpdateInwardFiles(
@OutwardNo varchar(20),
@ReturnDateTime smalldatetime,
@ReturnedBy varchar(100),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select OutwardNo from InwardFiles where OutwardNo = @OutwardNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Outward No', @OutwardNo, 'Inward Files')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update InwardFiles set
ReturnDateTime = @ReturnDateTime, ReturnedBy = @ReturnedBy, 
LoginID = @LoginID, ClientMachine = @ClientMachine
where OutwardNo = @OutwardNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateInwardFiles '1401560001', '15 Feb 2014 15:08', 'Dental', 'Admin', 'SYNCSOFT'

******************************************************************************************************/
-- select * from InwardFiles
-- delete from InwardFiles

-------------- Get InwardFiles -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInwardFiles')
	drop proc uspGetInwardFiles
go

create proc uspGetInwardFiles(
@OutwardNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select OutwardNo from InwardFiles where OutwardNo = @OutwardNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Outward No', @OutwardNo, 'Inward Files')
		return 1
	end
else
begin
	select InwardFiles.OutwardNo, FileNo, FirstName, LastName, MiddleName, Photo,	
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	BirthDate, JoinDate, ReferenceNo, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.GetAgeInMonths(BirthDate, getdate()) as AgeInMonths, 
	dbo.GetAgeInDays(BirthDate, getdate()) as AgeInDays, TakenDateTime,
	isnull(dbo.GetLastVisitDate(Patients.PatientNo),JoinDate) as LastVisitDate,
	dbo.GetLookupDataDes(GenderID) as Gender, ReturnDateTime, ReturnedBy
	from InwardFiles
	inner join OutwardFiles on InwardFiles.OutwardNo = OutwardFiles.OutwardNo
	inner join Patients on OutwardFiles.FileNo = Patients.PatientNo
	where InwardFiles.OutwardNo = @OutwardNo
return 0
end
go

/******************************************************************************************************
exec uspGetInwardFiles '1401560001'

******************************************************************************************************/
-- select * from InwardFiles
-- delete from InwardFiles

------------------------------------------------------------------------------------------------------
-------------- Alerts --------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Alerts -------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAlerts')
	drop proc uspInsertAlerts
go

create proc uspInsertAlerts(
@AlertTypeID varchar(10),
@VisitNo varchar(20),
@StaffNo varchar(10) = null,
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

declare @SentDate smalldatetime
declare @SentTime varchar(8)

set @SentDate = dbo.GetShortDate(getdate())
set @SentTime = dbo.GetTime(getdate())

if not exists(select DataID from LookupData where DataID = @AlertTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Alert Type ID', @AlertTypeID, 'Lookup Data')
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if not (@StaffNo is null or @StaffNo = '') 
	begin
		if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
				return 1
			end
	end
else if (@StaffNo is null or @StaffNo = '')
begin set @StaffNo = null end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select AlertID from Alerts where AlertTypeID = @AlertTypeID and VisitNo = @VisitNo and SentDate = @SentDate)
	begin 
		update Alerts set
		Notes = @Notes, SentTime = @SentTime
		where AlertTypeID = @AlertTypeID and VisitNo = @VisitNo and SentDate = @SentDate
		return 0 
	end
else
begin
insert into Alerts
(AlertTypeID, VisitNo, StaffNo, Notes, LoginID, SentDate, SentTime)
values
(@AlertTypeID, @VisitNo, @StaffNo, @Notes, @LoginID, @SentDate, @SentTime)

----------------------------------------------------------------------------------------------------------
declare @PastSentDate smalldatetime
set @PastSentDate = dbo.GetShortDate(dateadd(day, -2, getdate()))

delete from Alerts where SentDate <= @PastSentDate
----------------------------------------------------------------------------------------------------------

return 0
end
go

/******************************************************************************************************
exec uspInsertAlerts '3801', '100001001', '100', '', 'Admin'
exec uspInsertAlerts '3801', '100006001', '100', 'Hey U', 'Admin'
exec uspInsertAlerts '3801', '100061002', '100', '', 'Admin'
exec uspInsertAlerts '3801', '100091001', '100', '', 'Admin'
exec uspInsertAlerts '3801', '100019001', '101', '', 'Admin'

exec uspInsertAlerts '3802', '100091001', '100', '', 'Admin'
exec uspInsertAlerts '3802', '100019001', '101', '', 'Admin'

******************************************************************************************************/
-- select * from Alerts
-- delete from Alerts

-------------- GetAlerts -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAlerts')
	drop proc uspGetAlerts
go

create proc uspGetAlerts(
@AlertTypeID varchar(10),
@StaffLoginID varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not(@StaffLoginID is null)
begin
	select AlertID, AlertTypeID, dbo.GetLookupDataDes(AlertTypeID) as AlertType, 
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
	Alerts.VisitNo, dbo.FormatText(Alerts.VisitNo, 'Visits', 'VisitNo') as VisitNoText, FirstName,
	VisitDate, dbo.FormatDate(VisitDate) as VisitDateText, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
	dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact,
	SentDate, dbo.FormatDate(SentDate) as SentDateText, SentTime, Alerts.StaffNo, 
	dbo.GetStaffName(Alerts.StaffNo) as StaffName, Notes,
	dbo.GetStaffLoginID(Alerts.StaffNo) as StaffLoginID
	from Alerts
	inner join Visits on Alerts.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where AlertTypeID = @AlertTypeID and dbo.GetStaffLoginID(Alerts.StaffNo) = @StaffLoginID 
	order by SentDate, SentTime
end
else 
if @StaffLoginID is null
begin
	select AlertID, AlertTypeID, dbo.GetLookupDataDes(AlertTypeID) as AlertType, 
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
	Alerts.VisitNo, dbo.FormatText(Alerts.VisitNo, 'Visits', 'VisitNo') as VisitNoText, FirstName,
	VisitDate, dbo.FormatDate(VisitDate) as VisitDateText, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age,
	dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
	dbo.GetDoctorContactNo(Visits.VisitNo) as DoctorContact,
	SentDate, dbo.FormatDate(SentDate) as SentDateText, SentTime, Alerts.StaffNo, 
	dbo.GetStaffName(Alerts.StaffNo) as StaffName, Notes,
	dbo.GetStaffLoginID(Alerts.StaffNo) as StaffLoginID
	from Alerts
	inner join Visits on Alerts.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where AlertTypeID = @AlertTypeID
	order by SentDate, SentTime
end
return 0
go

/******************************************************************************************************
exec uspGetAlerts '3801', 'Admin'
exec uspGetAlerts '3802'

******************************************************************************************************/
-- select * from Alerts
-- delete from Alerts

------------------------------------------------------------------------------------------------------
-------------- IPDAlerts -----------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert IPDAlerts ----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertIPDAlerts')
	drop proc uspInsertIPDAlerts
go

create proc uspInsertIPDAlerts(
@AlertTypeID varchar(10),
@RoundNo varchar(20),
@StaffNo varchar(10),
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

declare @SentDate smalldatetime
declare @SentTime varchar(8)

set @SentDate = dbo.GetShortDate(getdate())
set @SentTime = dbo.GetTime(getdate())

if not exists(select DataID from LookupData where DataID = @AlertTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Alert Type ID', @AlertTypeID, 'Lookup Data')
		return 1
	end

if not exists(select RoundNo from IPDDoctor where RoundNo  = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPD Doctor')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select AlertID from IPDAlerts where AlertTypeID = @AlertTypeID and RoundNo = @RoundNo and SentDate = @SentDate)
	begin 
		update IPDAlerts set
		Notes = @Notes, SentTime = @SentTime
		where AlertTypeID = @AlertTypeID and RoundNo = @RoundNo and SentDate = @SentDate
		return 0 
	end
else
begin
insert into IPDAlerts
(AlertTypeID, RoundNo, StaffNo, Notes, LoginID, SentDate, SentTime)
values
(@AlertTypeID, @RoundNo, @StaffNo, @Notes, @LoginID, @SentDate, @SentTime)

----------------------------------------------------------------------------------------------------------
declare @PastSentDate smalldatetime
set @PastSentDate = dbo.GetShortDate(dateadd(day, -2, getdate()))

delete from IPDAlerts where SentDate <= @PastSentDate
----------------------------------------------------------------------------------------------------------

return 0
end
go

/******************************************************************************************************
exec uspInsertIPDAlerts '3801', '100001001', '100', '', 'Admin'
exec uspInsertIPDAlerts '3801', '100006001', '100', 'Hey U', 'Admin'
exec uspInsertIPDAlerts '3801', '100061002', '100', '', 'Admin'
exec uspInsertIPDAlerts '3801', '100091001', '100', '', 'Admin'
exec uspInsertIPDAlerts '3801', '100019001', '101', '', 'Admin'

exec uspInsertIPDAlerts '3802', '100091001', '100', '', 'Admin'
exec uspInsertIPDAlerts '3802', '100019001', '101', '', 'Admin'

******************************************************************************************************/
-- select * from IPDAlerts
-- delete from IPDAlerts

-------------- GetIPDAlerts -------------------------------------------------------------


if exists (select * from sysobjects where name = 'uspGetIPDAlerts')
	drop proc uspGetIPDAlerts
go

create proc uspGetIPDAlerts(
@AlertTypeID varchar(10),
@StaffLoginID varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if not(@StaffLoginID is null)
begin
	select AlertID, AlertTypeID, dbo.GetLookupDataDes(AlertTypeID) as AlertType, 
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
	IPDAlerts.RoundNo, dbo.FormatText(IPDAlerts.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNoText,
	RoundDateTime, dbo.FormatDateTime(RoundDateTime) as RoundDateTimeText, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
	dbo.GetAttendingDoctor(IPDAlerts.RoundNo) as AttendingDoctor,
	dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact,
	SentDate, dbo.FormatDate(SentDate) as SentDateText, SentTime, IPDAlerts.StaffNo, 
	dbo.GetStaffName(IPDAlerts.StaffNo) as StaffName, Notes,
	dbo.GetStaffLoginID(IPDAlerts.StaffNo) as StaffLoginID
	from IPDAlerts
	inner join IPDDoctor on IPDAlerts.RoundNo = IPDDoctor.RoundNo
	inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo	
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where AlertTypeID = @AlertTypeID and dbo.GetStaffLoginID(IPDAlerts.StaffNo) = @StaffLoginID 
	order by SentDate, SentTime asc
end
else 
if @StaffLoginID is null
begin
	select AlertID, AlertTypeID, dbo.GetLookupDataDes(AlertTypeID) as AlertType, 
	dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
	IPDAlerts.RoundNo, dbo.FormatText(IPDAlerts.RoundNo, 'IPDDoctor', 'RoundNo') as RoundNoText,
	RoundDateTime, dbo.FormatDateTime(RoundDateTime) as RoundDateTimeText, 
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
	dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
	dbo.GetAttendingDoctor(IPDAlerts.RoundNo) as AttendingDoctor,
	dbo.GetStaffPhoneNo(IPDDoctor.StaffNo) as DoctorContact,
	SentDate, dbo.FormatDate(SentDate) as SentDateText, SentTime, IPDAlerts.StaffNo, 
	dbo.GetStaffName(IPDAlerts.StaffNo) as StaffName, Notes,
	dbo.GetStaffLoginID(IPDAlerts.StaffNo) as StaffLoginID
	from IPDAlerts
	inner join IPDDoctor on IPDAlerts.RoundNo = IPDDoctor.RoundNo
	inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo	
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where AlertTypeID = @AlertTypeID
	order by SentDate, SentTime asc
end
return 0
go

/******************************************************************************************************
exec uspGetIPDAlerts '3801', 'Admin'
exec uspGetIPDAlerts '3802'

******************************************************************************************************/
-- select * from IPDAlerts
-- delete from IPDAlerts

------------------------------------------------------------------------------------------------------
-------------- PossibleAttachedItems --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
-------------- Edit PossibleAttachedItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditPossibleAttachedItems')
	drop proc uspEditPossibleAttachedItems
go

create proc uspEditPossibleAttachedItems(
@AttachedItemCode varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Quantity int,
@UnitCost money,
@UnitPrice money,
@Dosage varchar(40) = null,
@Duration int = null,
@Notes varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCategoryID', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
if exists(select AttachedItemCode from PossibleAttachedItems where AttachedItemCode = @AttachedItemCode 
				and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin 
	update PossibleAttachedItems set Quantity=@Quantity, Notes =@Notes,UnitCost=@UnitCost,
	UnitPrice=@UnitPrice,Dosage=@Dosage,Duration=@Duration
     where AttachedItemCode = @AttachedItemCode 
	and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	
	return 0 end
else
begin
insert into PossibleAttachedItems
(AttachedItemCode, ItemCode, ItemCategoryID, Quantity,UnitCost,UnitPrice,Dosage,Duration,Notes,LoginID,ClientMachine)
values
(@AttachedItemCode, @ItemCode, @ItemCategoryID, @Quantity,@UnitCost,@UnitPrice,@Dosage,@Duration, @Notes, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspEditPossibleAttachedItems
******************************************************************************************************/
-- select * from PossibleAttachedItems
-- delete from PossibleAttachedItems


-------------- Get PossibleAttachedItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPossibleAttachedItems')
	drop proc uspGetPossibleAttachedItems
go

create proc uspGetPossibleAttachedItems(
@AttachedItemCode varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AttachedItemCode from PossibleAttachedItems where AttachedItemCode = @AttachedItemCode and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'AttachedItemCode', @AttachedItemCode, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'PossibleAttachedItems')
		return 1
	end
else
begin
	select AttachedItemCode, ItemCode, ItemCategoryID,dbo.GetItemName(ItemCategoryID,ItemCode) as ItemName, Quantity,Dosage,Duration, Notes, PossibleAttachedItems.LoginID, ClientMachine, RecordDateTime
	from PossibleAttachedItems
	where AttachedItemCode = @AttachedItemCode and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetPossibleAttachedItems
******************************************************************************************************/
-- select * from PossibleAttachedItems
-- delete from PossibleAttachedItems

-------------- Get AttachedPossibleConsumables -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAttachedPossibleConsumables')
	drop proc uspGetAttachedPossibleConsumables
go

create proc uspGetAttachedPossibleConsumables(
@attachedItemCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
	begin
	select AttachedItemCode, PossibleAttachedItems.ItemCode, PossibleAttachedItems.Quantity, PossibleAttachedItems.Notes, 
	PossibleAttachedItems.ItemCategoryID, dbo.GetLookupDataDes(PossibleAttachedItems.ItemCategoryID) as ItemCategory,
	ConsumableItems.UnitPrice,Notes,
	dbo.GetMergedNameCode(ConsumableName, PossibleAttachedItems.ItemCode) as ConsumableFullName 
	,PossibleAttachedItems.LoginID, PossibleAttachedItems.ClientMachine, PossibleAttachedItems.RecordDateTime
	from PossibleAttachedItems
     inner join ConsumableItems on PossibleAttachedItems.ItemCode =ConsumableItems.ConsumableNo
	 where AttachedItemCode =@attachedItemCode 
end
return 0
go

-----------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetAttachedPossibleConsumablesExt')
	drop proc uspGetAttachedPossibleConsumablesExt
go

create proc uspGetAttachedPossibleConsumablesExt(
@attachedItemCode varchar(400)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
	begin
	select testName , AttachedItemCode, PossibleAttachedItems.ItemCode, PossibleAttachedItems.Quantity, PossibleAttachedItems.Notes, 
	PossibleAttachedItems.ItemCategoryID, dbo.GetLookupDataDes(PossibleAttachedItems.ItemCategoryID) as ItemCategory,
	ConsumableItems.UnitPrice,Notes, ConsumableName,
	dbo.GetMergedNameCode(ConsumableName, PossibleAttachedItems.ItemCode) as ConsumableFullName 
	,PossibleAttachedItems.LoginID, PossibleAttachedItems.ClientMachine, PossibleAttachedItems.RecordDateTime
	from PossibleAttachedItems
     inner join ConsumableItems on PossibleAttachedItems.ItemCode =ConsumableItems.ConsumableNo
     inner join LabTests on LabTests.TestCode = PossibleAttachedItems.AttachedItemCode
	 where AttachedItemCode in (SELECT Value FROM dbo.fn_Split(@attachedItemCode, ','))
end
return 0
go


-------------- Get Attached Possible Cosumables On Load -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAttachedPossibleCosumablesOnLoad')
	drop proc uspGetAttachedPossibleCosumablesOnLoad
go

create proc uspGetAttachedPossibleCosumablesOnLoad(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
if  not exists(select visitNo from Items where VisitNo = @VisitNo and ItemCategoryID = dbo.GetLookupDataID('ItemCategory','C'))
	begin
select VisitNo,AttachedItemCode, PossibleAttachedItems.ItemCode, PossibleAttachedItems.Quantity, PossibleAttachedItems.Notes, 
	PossibleAttachedItems.ItemCategoryID, dbo.GetLookupDataDes(PossibleAttachedItems.ItemCategoryID) as ItemCategory,
	ConsumableItems.UnitPrice,Notes,dbo.GetMergedNameCode(ConsumableName, PossibleAttachedItems.ItemCode) as ConsumableFullName 
	,PossibleAttachedItems.LoginID, PossibleAttachedItems.ClientMachine, PossibleAttachedItems.RecordDateTime
	from PossibleAttachedItems
     inner join ConsumableItems on PossibleAttachedItems.ItemCode =ConsumableItems.ConsumableNo
	 inner join Items on PossibleAttachedItems.AttachedItemCode =Items.ItemCode
 where  VisitNo = @VisitNo
end
return 0
go


-------------- Get IPD Attached Possible Cosumables On Load -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDAttachedPossibleCosumablesOnLoad')
	drop proc uspGetIPDAttachedPossibleCosumablesOnLoad
go
create proc uspGetIPDAttachedPossibleCosumablesOnLoad(
@RoundNo varchar(20)
)with encryption as
declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
if  not exists(select RoundNo from IPDItems where RoundNo = @RoundNo and ItemCategoryID = dbo.GetLookupDataID('ItemCategory','C'))
	begin
select RoundNo,AttachedItemCode, PossibleAttachedItems.ItemCode, PossibleAttachedItems.Quantity, PossibleAttachedItems.Notes, 
	PossibleAttachedItems.ItemCategoryID, dbo.GetLookupDataDes(PossibleAttachedItems.ItemCategoryID) as ItemCategory,
	ConsumableItems.UnitPrice,Notes,dbo.GetMergedNameCode(ConsumableName, PossibleAttachedItems.ItemCode) as ConsumableFullName 
	,PossibleAttachedItems.LoginID, PossibleAttachedItems.ClientMachine, PossibleAttachedItems.RecordDateTime
	from PossibleAttachedItems
     inner join ConsumableItems on PossibleAttachedItems.ItemCode =ConsumableItems.ConsumableNo
	 inner join IPDItems on PossibleAttachedItems.AttachedItemCode =IPDItems.ItemCode
 where  RoundNo = @RoundNo
end
return 0
go

-------------- Get AttachedPossibleTheatreServices -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAttachedPossibleTheatreServices')
	drop proc uspGetAttachedPossibleTheatreServices
go

create proc uspGetAttachedPossibleTheatreServices(
@attachedItemCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
	begin
	select AttachedItemCode, PossibleAttachedItems.ItemCode, PossibleAttachedItems.Quantity, PossibleAttachedItems.Notes, 
	PossibleAttachedItems.ItemCategoryID, dbo.GetLookupDataDes(PossibleAttachedItems.ItemCategoryID) as ItemCategory,
	PossibleAttachedItems.UnitPrice,Notes,TheatreName,
	dbo.GetMergedNameCode(TheatreName, PossibleAttachedItems.ItemCode) as FullTheatreServiceName,
	PossibleAttachedItems.LoginID, PossibleAttachedItems.ClientMachine, PossibleAttachedItems.RecordDateTime
	from PossibleAttachedItems
    inner join TheatreServices on PossibleAttachedItems.ItemCode =TheatreServices.TheatreCode
	where AttachedItemCode =@attachedItemCode 
	and ItemCategoryID = dbo.GetLookupDataID('ItemCategory','H')
	
end
return 0
go

-------------- Get Attached Possible Theatre Services On Load -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAttachedPossibleTheatreServicesOnLoad')
	drop proc uspGetAttachedPossibleTheatreServicesOnLoad
go

create proc uspGetAttachedPossibleTheatreServicesOnLoad(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
if  not exists(select visitNo from Items where VisitNo = @VisitNo and ItemCategoryID = dbo.GetLookupDataID('ItemCategory','H'))
	begin
select VisitNo,AttachedItemCode, Items.ItemCode, Items.Quantity,PossibleAttachedItems.ItemCode as TheatreCode, PossibleAttachedItems.Notes, 
	Items.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory,
	Items.UnitPrice,Notes,dbo.GetMergedNameCode(TheatreName, Items.ItemCode) as TheatreServicesFullName,
	TheatreName
	,PossibleAttachedItems.LoginID, PossibleAttachedItems.ClientMachine, PossibleAttachedItems.RecordDateTime
	from PossibleAttachedItems
     inner join TheatreServices on PossibleAttachedItems.ItemCode =TheatreServices.TheatreCode
	 inner join Items on PossibleAttachedItems.AttachedItemCode =Items.ItemCode
 where  VisitNo = @VisitNo 
 --and Items.ItemCategoryID = dbo.GetLookupDataID('ItemCategory','H')
end
return 0
go

-------------- Get Attached IPD Possible Theatre Services On Load -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAttachedIPDPossibleTheatreServicesOnLoad')
	drop proc uspGetAttachedIPDPossibleTheatreServicesOnLoad
go
create proc uspGetAttachedIPDPossibleTheatreServicesOnLoad(
@RoundNo varchar(20)
)with encryption as
declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
if  not exists(select RoundNo from IPDItems where RoundNo = @RoundNo and ItemCategoryID = dbo.GetLookupDataID('ItemCategory','H'))
	begin
select RoundNo,AttachedItemCode, PossibleAttachedItems.ItemCode, IPDItems.Quantity, PossibleAttachedItems.Notes, 
	IPDItems.ItemCategoryID, dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory,
	IPDItems.UnitPrice,Notes,dbo.GetMergedNameCode(TheatreName, IPDItems.ItemCode) as TheatreServicesFullName 
	,IPDItems.LoginID, IPDItems.ClientMachine, IPDItems.RecordDateTime
	from PossibleAttachedItems
     inner join TheatreServices on PossibleAttachedItems.ItemCode =TheatreServices.TheatreCode
	 inner join IPDItems on PossibleAttachedItems.AttachedItemCode =IPDItems.ItemCode
 where  RoundNo = @RoundNo and PossibleAttachedItems.ItemCategoryID = dbo.GetLookupDataID('ItemCategory','H')
end
return 0
go


-------------- Get Attached Possible Prescritions -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAttachedPossiblePrescritions')
	drop proc uspGetAttachedPossiblePrescritions
go

create proc uspGetAttachedPossiblePrescritions(
@attachedItemCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
	begin
	select AttachedItemCode, PossibleAttachedItems.ItemCode, DrugName,PossibleAttachedItems.Quantity, PossibleAttachedItems.Notes, 
	PossibleAttachedItems.ItemCategoryID, dbo.GetLookupDataDes(PossibleAttachedItems.ItemCategoryID) as ItemCategory,
	PossibleAttachedItems.UnitPrice,Dosage,Duration,Notes,UnitMeasureID, dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure,
	dbo.GetMergedNameCode(DrugName, PossibleAttachedItems.ItemCode) as DrugFullName
	,PossibleAttachedItems.LoginID, PossibleAttachedItems.ClientMachine, PossibleAttachedItems.RecordDateTime
	from PossibleAttachedItems
     inner join Drugs on PossibleAttachedItems.ItemCode =Drugs.DrugNo
	 where AttachedItemCode =@attachedItemCode and ItemCategoryID = dbo.GetLookupDataID('ItemCategory','D')
	
end
return 0
go


-------------- Get Attached Possible Prescritions On Load -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAttachedPossiblePrescritionsOnLoad')
	drop proc uspGetAttachedPossiblePrescritionsOnLoad
go

create proc uspGetAttachedPossiblePrescritionsOnLoad(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
if  not exists(select visitNo from Items where VisitNo = @VisitNo and ItemCategoryID = dbo.GetLookupDataID('ItemCategory','D'))
	begin
select VisitNo,AttachedItemCode, PossibleAttachedItems.ItemCode,DrugName, PossibleAttachedItems.Quantity, PossibleAttachedItems.Notes, 
	PossibleAttachedItems.ItemCategoryID, dbo.GetLookupDataDes(PossibleAttachedItems.ItemCategoryID) as ItemCategory,
	Items.UnitPrice,Dosage,Duration,Notes,dbo.GetMergedNameCode(DrugName, PossibleAttachedItems.ItemCode) as DrugFullName 
	,PossibleAttachedItems.LoginID, PossibleAttachedItems.ClientMachine, PossibleAttachedItems.RecordDateTime
	from PossibleAttachedItems
     inner join Drugs on PossibleAttachedItems.ItemCode =drugs.DrugNo
	 inner join Items on PossibleAttachedItems.AttachedItemCode =Items.ItemCode
 where  VisitNo = @VisitNo
end
return 0
go

-------------- Get Attached IPD Possible Prescritions On Load -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDAttachedPossiblePrescritionsOnLoad')
	drop proc uspGetIPDAttachedPossiblePrescritionsOnLoad
go

create proc uspGetIPDAttachedPossiblePrescritionsOnLoad(
@RoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
if  not exists(select RoundNo from IPDItems where RoundNo = @RoundNo and ItemCategoryID = dbo.GetLookupDataID('ItemCategory','D'))
	begin
select RoundNo,AttachedItemCode, PossibleAttachedItems.ItemCode,DrugName, PossibleAttachedItems.Quantity, PossibleAttachedItems.Notes, 
	PossibleAttachedItems.ItemCategoryID, dbo.GetLookupDataDes(PossibleAttachedItems.ItemCategoryID) as ItemCategory,
	IPDItems.UnitPrice,Dosage,Duration,Notes,dbo.GetMergedNameCode(DrugName, PossibleAttachedItems.ItemCode) as DrugFullName 
	,PossibleAttachedItems.LoginID, PossibleAttachedItems.ClientMachine, PossibleAttachedItems.RecordDateTime
	from PossibleAttachedItems
     inner join Drugs on PossibleAttachedItems.ItemCode =drugs.DrugNo
	 inner join IPDItems on PossibleAttachedItems.AttachedItemCode =IPDItems.ItemCode
 where  RoundNo = @RoundNo
end
return 0
go


-------------- Get Attached Possible Prescritions -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAttachedDrugs')
	drop proc uspGetAttachedDrugs
go

create proc uspGetAttachedDrugs(
@attachedItemCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @DrugCode varchar(10)
set @DrugCode = dbo.GetLookupDataID('ItemCategory', 'D')
-----------------------------------------------------------------------------------------------
begin
select AttachedItemCode,DrugName,dbo.GetMergedNameCode(DrugName, PossibleAttachedItems.ItemCode) as DrugFullName, 
PossibleAttachedItems.ItemCode,Dosage,Duration, PossibleAttachedItems.Quantity, PossibleAttachedItems.Notes,PossibleAttachedItems.UnitCost,
PossibleAttachedItems.UnitPrice
from PossibleAttachedItems
inner join Drugs on PossibleAttachedItems.ItemCode =Drugs.DrugNo
where AttachedItemCode =@attachedItemCode and ItemCategoryID =@DrugCode
end
return 0
go

-------------- Get Attached Consumables -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAttachedConsumables')
	drop proc uspGetAttachedConsumables
go

create proc uspGetAttachedConsumables(
@attachedItemCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
begin
select AttachedItemCode,dbo.GetMergedNameCode(ConsumableName, PossibleAttachedItems.ItemCode) as ConsumableFullName, 
PossibleAttachedItems.ItemCode, PossibleAttachedItems.Quantity, PossibleAttachedItems.Notes,PossibleAttachedItems.UnitCost,
PossibleAttachedItems.UnitPrice
from PossibleAttachedItems
inner join ConsumableItems on PossibleAttachedItems.ItemCode =ConsumableItems.ConsumableNo
where AttachedItemCode =@attachedItemCode
end
return 0
go

-------------- Get Attached Lab Tests -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAttachedLabTests')
	drop proc uspGetAttachedLabTests
go

create proc uspGetAttachedLabTests(
@attachedItemCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @TestID varchar(10)
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
-----------------------------------------------------------------------------------------------
begin
select AttachedItemCode,TestName,dbo.GetMergedNameCode(TestName, PossibleAttachedItems.ItemCode) as TestFullName, 
PossibleAttachedItems.ItemCode, PossibleAttachedItems.Quantity, PossibleAttachedItems.Notes,UnitMeasureID,
dbo.GetLookupDataDes(UnitMeasureID) as UnitMeasure,PossibleAttachedItems.UnitCost,PossibleAttachedItems.UnitPrice
from PossibleAttachedItems
inner join LabTests on PossibleAttachedItems.ItemCode =LabTests.TestCode
where AttachedItemCode =@attachedItemCode and ItemCategoryID = @TestID
end
return 0
go

-----------------------------------------------------------------------------------------------
-------------- Get Attached Theatre Services -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAttachedTheatreServices')
	drop proc uspGetAttachedTheatreServices
go

create proc uspGetAttachedTheatreServices(
@attachedItemCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
begin
select AttachedItemCode,dbo.GetMergedNameCode(TheatreName, PossibleAttachedItems.ItemCode) as TheatreFullName, 
PossibleAttachedItems.ItemCode, PossibleAttachedItems.Quantity, PossibleAttachedItems.Notes,PossibleAttachedItems.UnitCost,
PossibleAttachedItems.UnitPrice
from PossibleAttachedItems
inner join TheatreServices on PossibleAttachedItems.ItemCode =TheatreServices.TheatreCode
where AttachedItemCode =@attachedItemCode
end
return 0
go

-------------- Get Attached IPD Possible Cosumables On Load -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAttachedIPDPossibleCosumablesOnLoad')
	drop proc uspGetAttachedIPDPossibleCosumablesOnLoad
go

create proc uspGetAttachedIPDPossibleCosumablesOnLoad(
@RoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
if  not exists(select RoundNo from IPDItems where RoundNo = @RoundNo and ItemCategoryID = dbo.GetLookupDataID('ItemCategory','C'))
	begin
select RoundNo,AttachedItemCode, PossibleAttachedItems.ItemCode, PossibleAttachedItems.Quantity, PossibleAttachedItems.Notes, 
	PossibleAttachedItems.ItemCategoryID, dbo.GetLookupDataDes(PossibleAttachedItems.ItemCategoryID) as ItemCategory,
	PossibleAttachedItems.UnitPrice,Notes,dbo.GetMergedNameCode(ConsumableName, PossibleAttachedItems.ItemCode) as ConsumableFullName 
	,PossibleAttachedItems.LoginID, PossibleAttachedItems.ClientMachine, PossibleAttachedItems.RecordDateTime
	from PossibleAttachedItems
     inner join ConsumableItems on PossibleAttachedItems.ItemCode =ConsumableItems.ConsumableNo
	 inner join IPDItems on PossibleAttachedItems.AttachedItemCode =IPDItems.ItemCode
 where  RoundNo = @RoundNo
end
return 0
go

------------------------------------------------------------------------------------------------------
-------------- AccessedCashServices --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert AccessedCashServices -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAccessedCashServices')
	drop proc uspInsertAccessedCashServices
go

create proc uspInsertAccessedCashServices(
@VisitNo varchar(20),
@ToVisitDate Smalldatetime,
@AuthorisedBy varchar(41),
@AuthorisationReason varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @VisitNo, 'Patients')
		return 1
	end

if exists(select VisitNo from AccessedCashServices where VisitNo = @VisitNo and ToVisitDate = @ToVisitDate)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: '+ dbo.FormatDate(@ToVisitDate) +', you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Vist No', @VisitNo, 'Authorisation Date')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AuthorisationReason)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Authorisation Reason', @AuthorisationReason, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end


---------------------------------------------------------------------------------------------------------------------------------
begin tran

begin
if not (@VisitNo is null or @VisitNo = '') 
begin update Visits set AccessCashServices = 1 where VisitNo = @VisitNo end
end
---------------------------------------------------------------------------------------------------------------------------------
begin
insert into AccessedCashServices
(VisitNo, ToVisitDate, AuthorisedBy, AuthorisationReason, LoginID, ClientMachine)
values
(@VisitNo, @ToVisitDate, @AuthorisedBy, @AuthorisationReason, @LoginID, @ClientMachine)
---------------------------------------------------------------------------------------------------------------------------------

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran

end
return 0

go

/******************************************************************************************************
exec uspInsertAccessedCashServices
******************************************************************************************************/
-- select * from AccessedCashServices
-- delete from AccessedCashServices


-------------- Update AccessedCashServices -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateAccessedCashServices')
	drop proc uspUpdateAccessedCashServices
go

create proc uspUpdateAccessedCashServices(
@VisitNo varchar(20),
@ToVisitDate Smalldatetime,
@AuthorisedBy varchar(41),
@AuthorisationReason varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from AccessedCashServices where VisitNo = @VisitNo and ToVisitDate = @ToVisitDate)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: '+ dbo.FormatDate(@ToVisitDate) +', you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @VisitNo, 'Authorisation Date', 'To-Visit Date', 'AccessedCashServices')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AuthorisationReason)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Authorisation Reason', @AuthorisationReason, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update AccessedCashServices set
AuthorisedBy = @AuthorisedBy, AuthorisationReason = @AuthorisationReason, LoginID = @LoginID, ClientMachine = @ClientMachine
where VisitNo = @VisitNo and ToVisitDate = @ToVisitDate
return 0
end
go

/******************************************************************************************************
exec uspUpdateAccessedCashServices
******************************************************************************************************/
-- select * from AccessedCashServices
-- delete from AccessedCashServices


-------------- Get AccessedCashServices -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAccessedCashServices')
	drop proc uspGetAccessedCashServices
go

create proc uspGetAccessedCashServices(
@VisitNo varchar(20),
@ToVisitDate Smalldatetime = null
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select VisitNo, ToVisitDate, AuthorisedBy, AuthorisationReason, dbo.GetLookupDataDes(AuthorisationReason) as [Authorisation Reason], AccessedCashServices.LoginID, ClientMachine, RecordDateTime
	from AccessedCashServices
where VisitNo = @VisitNo and ToVisitDate = @ToVisitDate
return 0
end
go

/******************************************************************************************************
exec uspGetAccessedCashServices
******************************************************************************************************/
-- select * from AccessedCashServices
-- delete from AccessedCashServices
--------GetAccessedCashServicesAuthorized-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAccessedCashServicesAuthorized')
	drop proc uspGetAccessedCashServicesAuthorized
go

create proc uspGetAccessedCashServicesAuthorized(
@VisitNo varchar(20),
@IsAccessedCashServicesAuthorized bit = null output
)with encryption as

begin 
	set @IsAccessedCashServicesAuthorized = dbo.GetAccessedCashServicesAuthorized(@VisitNo)	
	set @IsAccessedCashServicesAuthorized = isnull(@IsAccessedCashServicesAuthorized, 0)
end
return 0
go

-------------- Edit ItemLocationOrderLevels -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditItemLocationOrderLevels')
	drop proc uspEditItemLocationOrderLevels
go

create proc uspEditItemLocationOrderLevels(
@LocationID varchar(10),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@LocationOrderLevel int,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

if exists(select LocationID from ItemLocationOrderLevels where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		update ItemLocationOrderLevels set
		LocationOrderLevel = @LocationOrderLevel, LoginID = @LoginID, ClientMachine = @ClientMachine
		where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
		return 0
	end
else
begin
insert into ItemLocationOrderLevels
(LocationID, ItemCategoryID, ItemCode, LocationOrderLevel, LoginID, ClientMachine)
values
(@LocationID, @ItemCategoryID, @ItemCode, @LocationOrderLevel, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspEditItemLocationOrderLevels
******************************************************************************************************/
-- select * from ItemLocationOrderLevels
-- delete from ItemLocationOrderLevels


-------------- Get ItemLocationOrderLevels -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetItemLocationOrderLevels')
	drop proc uspGetItemLocationOrderLevels
go

create proc uspGetItemLocationOrderLevels(
@ItemCategoryID varchar(10),
@ItemCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select LocationID, ItemCategoryID, ItemCode, LocationOrderLevel, ItemLocationOrderLevels.LoginID, ClientMachine, RecordDateTime
	from ItemLocationOrderLevels
	where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
return 0
end
go

/******************************************************************************************************
exec uspGetItemLocationOrderLevels
******************************************************************************************************/
-- select * from ItemLocationOrderLevels
-- delete from ItemLocationOrderLevels


------------------------------------------------------------------------------------------------------
-------------- SymptomsHistory --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert SymptomsHistory -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertSymptomsHistory')
	drop proc uspInsertSymptomsHistory
go

create proc uspInsertSymptomsHistory(
@VisitNo varchar(20),
@Fever varchar(10),
@Cough varchar(10),
@CoughMoreThanTwoWeeks varchar(10),
@DifficultyInBreathing varchar(10),
@ImmunizationDetails varchar(10),
@OtherHistory varchar(2000),
@Convulsions varchar(10),
@AlteredConsciousness varchar(10),
@Vomiting varchar(10),
@UnableToDrinkBreastfeed varchar(10),
@PastMedicalHistory varchar(2000),
@Diarrhoea varchar(10),
@DiarrhoeaLongerThanTwoWeeks varchar(10),
@BloodDiarrhoea varchar(10),
@PassingTeaColouredUrine varchar(10),
@FeedingHistory varchar(2000),
@Pallor varchar(10),
@SkinPinchReturn varchar(10),
@SevereWasting varchar(10),
@Edema varchar(10),
@SunkenEyes varchar(10),
@Jaundice varchar(10),
@MUAC int ,
@Height int,
@DeepBreathing varchar(10),
@FlaringOfNostrils varchar(10),
@IntercostalRecession  varchar(10),
@subCostalRecession  varchar(10),
@Pulse varchar(10),
@CapRefill varchar(10),
@Airway varchar(10),
@Wheezing varchar(10),
@PleuralRub varchar(10),
@Crackles varchar(10),
@Unconscious varchar(10),
@Lethargic varchar(10),
@UnableToSitStand varchar(10),
@BulgingFontanelle varchar(10),
@StiffNeck varchar(10),
@KerningsSign varchar(10),
@IsBloodTransfusionDesired varchar(10),
@BloodTransfusionStateReasons varchar(200),
@IfDesiredWasBloodGiven varchar(10),
@IfYesVolume int,
@TransfusionDate smallDateTime,
@BloodUnits int,
@BloodTransfusionNotGivenStateReasons varchar(200),
@OtherFormsOfSupportiveCare varchar(200),
@ReasonsForDiagnosisOfSevereComplicatedMalaria varchar(200),
@ReasonsForAdmissionWithPositiveMalariaTest varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if exists(select VisitNo from SymptomsHistory where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo)
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Fever)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Fever', @Fever, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Cough)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cough', @Cough, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @CoughMoreThanTwoWeeks)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cough More Than Two Weeks', @CoughMoreThanTwoWeeks, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @DifficultyInBreathing)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Difficulty In Breathing', @DifficultyInBreathing, 'Lookup Data')
		return 1
	end
	
	if not exists(select DataID from LookUpData where DataID = @ImmunizationDetails)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Immunization Details', @ImmunizationDetails, 'Lookup Data')
		return 1
	end

--if not exists(select DataID from LookUpData where DataID = @OtherHistory)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Other History', @OtherHistory, 'Lookup Data')
--		return 1
--	end

if not exists(select DataID from LookUpData where DataID = @Convulsions)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Convulsions', @Convulsions, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @AlteredConsciousness)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Altered Consciousness', @AlteredConsciousness, 'Lookup Data')
		return 1 
	end

if not exists(select DataID from LookUpData where DataID = @Vomiting)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Vomiting', @Vomiting, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @UnableToDrinkBreastfeed)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Unable To Drink  Breastfeed', @UnableToDrinkBreastfeed, 'Lookup Data')
		return 1
	end


if not exists(select DataID from LookUpData where DataID = @Diarrhoea)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Diarrhoea', @Diarrhoea, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @DiarrhoeaLongerThanTwoWeeks)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Diarrhoea Longer Than Weeks', @DiarrhoeaLongerThanTwoWeeks, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @BloodDiarrhoea)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Blood Diarrhoea', @BloodDiarrhoea, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @PassingTeaColouredUrine)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Passing Tea Coloured Urine', @PassingTeaColouredUrine, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Pallor)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pallor', @Pallor, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @SkinPinchReturn)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Skin Pinch Return', @SkinPinchReturn, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @SevereWasting)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Severe Wasting', @SevereWasting, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Edema)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Edema', @Edema, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @SunkenEyes)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sunken Eyes', @SunkenEyes, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Jaundice)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Jaundice', @Jaundice, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @DeepBreathing)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Deep Breathing', @DeepBreathing, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @FlaringOfNostrils)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Flaring Of Nostrils', @FlaringOfNostrils, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @IntercostalRecession )
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Intercostal Recession ', @IntercostalRecession , 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @subCostalRecession )
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'subCostal Recession ', @subCostalRecession , 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Pulse)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pulse', @Pulse, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @CapRefill)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cap Refill', @CapRefill, 'Lookup Data')
		return 1
	end
	
if not exists(select DataID from LookUpData where DataID = @Airway)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Airway', @Airway, 'Lookup Data')
		return 1
	end
	
	if not exists(select DataID from LookUpData where DataID = @Wheezing)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Wheezing', @Wheezing, 'Lookup Data')
		return 1
	end
	
	if not exists(select DataID from LookUpData where DataID = @PleuralRub)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pleural Rub', @PleuralRub, 'Lookup Data')
		return 1
	end
	
	if not exists(select DataID from LookUpData where DataID = @Crackles)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Crackles', @Crackles, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Unconscious)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Unconscious', @Unconscious, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Lethargic)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lethargic', @Lethargic, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @UnableToSitStand)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Unable To Sit  Stand', @UnableToSitStand, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @BulgingFontanelle)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bulging Fontanelle', @BulgingFontanelle, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @StiffNeck)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Stiff Neck', @StiffNeck, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @KerningsSign)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Kernings Sign', @KerningsSign, 'Lookup Data')
		return 1
	end
	
	if not exists(select DataID from LookUpData where DataID = @IsBloodTransfusionDesired)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Is Blood Transfusion Desired', @IsBloodTransfusionDesired, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @IfDesiredWasBloodGiven)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'If Desired Was Blood Given', @IfDesiredWasBloodGiven, 'Lookup Data')
		return 1
	end

begin
insert into SymptomsHistory
(VisitNo, Fever, Cough, CoughMoreThanTwoWeeks, DifficultyInBreathing, ImmunizationDetails, OtherHistory, 
Convulsions, AlteredConsciousness, Vomiting, UnableToDrinkBreastfeed, PastMedicalHistory, Diarrhoea, 
DiarrhoeaLongerThanTwoWeeks, BloodDiarrhoea, PassingTeaColouredUrine, FeedingHistory,
Pallor, SkinPinchReturn, SevereWasting, Edema, SunkenEyes, Jaundice, MUAC, Height, DeepBreathing,
FlaringOfNostrils, IntercostalRecession , subCostalRecession , Pulse, Airway, Wheezing, PleuralRub, 
Crackles, CapRefill, Unconscious, Lethargic, UnableToSitStand, BulgingFontanelle, StiffNeck, KerningsSign,
IsBloodTransfusionDesired, BloodTransfusionStateReasons, IfDesiredWasBloodGiven, IfYesVolume, TransfusionDate,
BloodUnits, BloodTransfusionNotGivenStateReasons, OtherFormsOfSupportiveCare, ReasonsForDiagnosisOfSevereComplicatedMalaria,
ReasonsForAdmissionWithPositiveMalariaTest, LoginID, ClientMachine)
values
(@VisitNo, @Fever, @Cough, @CoughMoreThanTwoWeeks, @DifficultyInBreathing,
 @ImmunizationDetails,@OtherHistory ,@Convulsions, @AlteredConsciousness, @Vomiting, @UnableToDrinkBreastfeed,
  @PastMedicalHistory, @Diarrhoea, @DiarrhoeaLongerThanTwoWeeks, @BloodDiarrhoea, @PassingTeaColouredUrine, @FeedingHistory,
 @Pallor, @SkinPinchReturn, @SevereWasting, @Edema, @SunkenEyes, @Jaundice, @MUAC, @Height, @DeepBreathing, @FlaringOfNostrils, 
 @IntercostalRecession , @subCostalRecession , @Pulse, @Airway, @Wheezing, @PleuralRub, @Crackles, @CapRefill, @Unconscious, @Lethargic, 
 @UnableToSitStand, @BulgingFontanelle, @StiffNeck, @KerningsSign, @IsBloodTransfusionDesired, @BloodTransfusionStateReasons, 
 @IfDesiredWasBloodGiven, @IfYesVolume, @TransfusionDate, @BloodUnits, @BloodTransfusionNotGivenStateReasons, @OtherFormsOfSupportiveCare, 
 @ReasonsForDiagnosisOfSevereComplicatedMalaria, @ReasonsForAdmissionWithPositiveMalariaTest, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertSymptomsHistory '1306750002'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
******************************************************************************************************/
-- select * from SymptomsHistory
-- delete from SymptomsHistory


-------------- Update SymptomsHistory -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateSymptomsHistory')
	drop proc uspUpdateSymptomsHistory
go

create proc uspUpdateSymptomsHistory(
@VisitNo varchar(20),
@Fever varchar(10),
@Cough varchar(10),
@CoughMoreThanTwoWeeks varchar(10),
@DifficultyInBreathing varchar(10),
@ImmunizationDetails varchar(10),
@OtherHistory varchar(2000),
@Convulsions varchar(10),
@AlteredConsciousness varchar(10),
@Vomiting varchar(10),
@UnableToDrinkBreastfeed varchar(10),
@PastMedicalHistory varchar(2000),
@Diarrhoea varchar(10),
@DiarrhoeaLongerThanTwoWeeks varchar(10),
@BloodDiarrhoea varchar(10),
@PassingTeaColouredUrine varchar(10),
@FeedingHistory varchar(2000),
@Pallor varchar(10),
@SkinPinchReturn varchar(10),
@SevereWasting varchar(10),
@Edema varchar(10),
@SunkenEyes varchar(10),
@Jaundice varchar(10),
@MUAC int ,
@Height int,
@DeepBreathing varchar(10),
@FlaringOfNostrils varchar(10),
@IntercostalRecession  varchar(10),
@subCostalRecession  varchar(10),
@Pulse varchar(10),
@CapRefill varchar(10),
@Airway varchar(10),
@Wheezing varchar(10),
@PleuralRub varchar(10),
@Crackles varchar(10),
@Unconscious varchar(10),
@Lethargic varchar(10),
@UnableToSitStand varchar(10),
@BulgingFontanelle varchar(10),
@StiffNeck varchar(10),
@KerningsSign varchar(10),

@IsBloodTransfusionDesired varchar(10),
@BloodTransfusionStateReasons varchar(200),
@IfDesiredWasBloodGiven varchar(10),
@IfYesVolume int,
@TransfusionDate smallDateTime,
@BloodUnits int,
@BloodTransfusionNotGivenStateReasons varchar(200),
@OtherFormsOfSupportiveCare varchar(200),
@ReasonsForDiagnosisOfSevereComplicatedMalaria varchar(200),
@ReasonsForAdmissionWithPositiveMalariaTest varchar(200),

@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)



	
if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

--if exists(select VisitNo from SymptomsHistory where VisitNo = @VisitNo)
--	begin
--		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
--		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo)
--		return 1
--	end

if not exists(select DataID from LookUpData where DataID = @Fever)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Fever', @Fever, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Cough)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cough', @Cough, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @CoughMoreThanTwoWeeks)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cough More Than Two Weeks', @CoughMoreThanTwoWeeks, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @DifficultyInBreathing)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Difficulty In Breathing', @DifficultyInBreathing, 'Lookup Data')
		return 1
	end
	
	if not exists(select DataID from LookUpData where DataID = @ImmunizationDetails)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Immunization Details', @ImmunizationDetails, 'Lookup Data')
		return 1
	end

--if not exists(select DataID from LookUpData where DataID = @OtherHistory)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Other History', @OtherHistory, 'Lookup Data')
--		return 1
--	end

if not exists(select DataID from LookUpData where DataID = @Convulsions)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Convulsions', @Convulsions, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @AlteredConsciousness)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Altered Consciousness', @AlteredConsciousness, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Vomiting)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Vomiting', @Vomiting, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @UnableToDrinkBreastfeed)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Unable To Drink  Breastfeed', @UnableToDrinkBreastfeed, 'Lookup Data')
		return 1
	end

--if not exists(select DataID from LookUpData where DataID = @PastMedicalHistory)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Past Medical History', @PastMedicalHistory, 'Lookup Data')
--		return 1
--	end

if not exists(select DataID from LookUpData where DataID = @Diarrhoea)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Diarrhoea', @Diarrhoea, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @DiarrhoeaLongerThanTwoWeeks)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Diarrhoea Longer Than Weeks', @DiarrhoeaLongerThanTwoWeeks, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @BloodDiarrhoea)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Blood Diarrhoea', @BloodDiarrhoea, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @PassingTeaColouredUrine)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Passing Tea Coloured Urine', @PassingTeaColouredUrine, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Pallor)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pallor', @Pallor, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @SkinPinchReturn)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Skin Pinch Return', @SkinPinchReturn, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @SevereWasting)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Severe Wasting', @SevereWasting, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Edema)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Edema', @Edema, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @SunkenEyes)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sunken Eyes', @SunkenEyes, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Jaundice)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Jaundice', @Jaundice, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @DeepBreathing)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Deep Breathing', @DeepBreathing, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @FlaringOfNostrils)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Flaring Of Nostrils', @FlaringOfNostrils, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @IntercostalRecession )
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Intercostal Recession ', @IntercostalRecession , 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @subCostalRecession )
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'subCostal Recession ', @subCostalRecession , 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Pulse)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pulse', @Pulse, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @CapRefill)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cap Refill', @CapRefill, 'Lookup Data')
		return 1
	end
	
if not exists(select DataID from LookUpData where DataID = @Airway)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Airway', @Airway, 'Lookup Data')
		return 1
	end
	
	if not exists(select DataID from LookUpData where DataID = @Wheezing)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Wheezing', @Wheezing, 'Lookup Data')
		return 1
	end
	
	if not exists(select DataID from LookUpData where DataID = @PleuralRub)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pleural Rub', @PleuralRub, 'Lookup Data')
		return 1
	end
	
	if not exists(select DataID from LookUpData where DataID = @Crackles)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Crackles', @Crackles, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Unconscious)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Unconscious', @Unconscious, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @Lethargic)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lethargic', @Lethargic, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @UnableToSitStand)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Unable To Sit  Stand', @UnableToSitStand, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @BulgingFontanelle)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bulging Fontanelle', @BulgingFontanelle, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @StiffNeck)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Stiff Neck', @StiffNeck, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @KerningsSign)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Kernings Sign', @KerningsSign, 'Lookup Data')
		return 1
	end
	
	if not exists(select DataID from LookUpData where DataID = @IsBloodTransfusionDesired)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Is Blood Transfusion Desired', @IsBloodTransfusionDesired, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @IfDesiredWasBloodGiven)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'If Desired Was Blood Given', @IfDesiredWasBloodGiven, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update SymptomsHistory set
Fever = @Fever, Cough = @Cough, CoughMoreThanTwoWeeks = @CoughMoreThanTwoWeeks, DifficultyInBreathing = @DifficultyInBreathing, 
ImmunizationDetails = @ImmunizationDetails, OtherHistory = @OtherHistory, Convulsions = @Convulsions, AlteredConsciousness = @AlteredConsciousness, 
Vomiting = @Vomiting, UnableToDrinkBreastfeed = @UnableToDrinkBreastfeed, PastMedicalHistory = @PastMedicalHistory, Diarrhoea = @Diarrhoea,
DiarrhoeaLongerThanTwoWeeks = @DiarrhoeaLongerThanTwoWeeks,BloodDiarrhoea = @BloodDiarrhoea, PassingTeaColouredUrine = @PassingTeaColouredUrine, 
FeedingHistory = @FeedingHistory, Pallor = @Pallor, SkinPinchReturn = @SkinPinchReturn, SevereWasting = @SevereWasting, Edema = @Edema, SunkenEyes = @SunkenEyes,
Jaundice = @Jaundice, MUAC = @MUAC, Height = @Height, DeepBreathing = @DeepBreathing, FlaringOfNostrils = @FlaringOfNostrils, 
IntercostalRecession  = @IntercostalRecession ,subCostalRecession  = @subCostalRecession , Pulse = @Pulse, CapRefill = @CapRefill, Airway = @Airway, 
Wheezing = @Wheezing, PleuralRub = PleuralRub, Crackles = @Crackles, Unconscious = @Unconscious, Lethargic = @Lethargic, UnableToSitStand = @UnableToSitStand, 
BulgingFontanelle = @BulgingFontanelle, StiffNeck = @StiffNeck, KerningsSign = @KerningsSign,

IsBloodTransfusionDesired = @IsBloodTransfusionDesired, BloodTransfusionStateReasons = @BloodTransfusionStateReasons, 
IfDesiredWasBloodGiven = @IfDesiredWasBloodGiven, IfYesVolume = @IfYesVolume, TransfusionDate = @TransfusionDate, BloodUnits = @BloodUnits, 
BloodTransfusionNotGivenStateReasons = @BloodTransfusionNotGivenStateReasons, OtherFormsOfSupportiveCare = @OtherFormsOfSupportiveCare, 
ReasonsForDiagnosisOfSevereComplicatedMalaria = @ReasonsForDiagnosisOfSevereComplicatedMalaria, 
ReasonsForAdmissionWithPositiveMalariaTest = @ReasonsForAdmissionWithPositiveMalariaTest, LoginID = @LoginID, ClientMachine = @ClientMachine
where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateSymptomsHistory
******************************************************************************************************/
-- select * from SymptomsHistory
-- delete from SymptomsHistory


-------------- Get SymptomsHistory -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetSymptomsHistory')
	drop proc uspGetSymptomsHistory
go

create proc uspGetSymptomsHistory(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from SymptomsHistory where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'SymptomsHistory')
		return 1
	end
else
begin
	select VisitNo, dbo.GetLookupDataDes(Fever) as [Fever], dbo.GetLookupDataDes(Cough) as [Cough], dbo.GetLookupDataDes(CoughMoreThanTwoWeeks) as [CoughMoreThanTwoWeeks], 
	dbo.GetLookupDataDes(DifficultyInBreathing) as [DifficultyInBreathing],dbo.GetLookupDataDes(ImmunizationDetails) as [ImmunizationDetails],
	OtherHistory, dbo.GetLookupDataDes(Convulsions) as [Convulsions], dbo.GetLookupDataDes(AlteredConsciousness) as [AlteredConsciousness], 
	dbo.GetLookupDataDes(Vomiting) as [Vomiting], dbo.GetLookupDataDes(UnableToDrinkBreastfeed) as [UnableToDrinkBreastfeed],
	PastMedicalHistory, dbo.GetLookupDataDes(Diarrhoea) as [Diarrhoea], dbo.GetLookupDataDes(DiarrhoeaLongerThanTwoWeeks) as [DiarrhoeaLongerThanTwoWeeks], 
	dbo.GetLookupDataDes(BloodDiarrhoea) as [BloodDiarrhoea], dbo.GetLookupDataDes(PassingTeaColouredUrine) as [PassingTeaColouredUrine],
	FeedingHistory, dbo.GetLookupDataDes(Pallor) as [Pallor], dbo.GetLookupDataDes(SkinPinchReturn) as [SkinPinchReturn], 
	dbo.GetLookupDataDes(SevereWasting) as [SevereWasting], dbo.GetLookupDataDes(Edema) as [Edema], dbo.GetLookupDataDes(SunkenEyes) as [SunkenEyes], 
	dbo.GetLookupDataDes(Jaundice) as [Jaundice], MUAC, Height, dbo.GetLookupDataDes(DeepBreathing) as [DeepBreathing], dbo.GetLookupDataDes(FlaringOfNostrils) as [FlaringOfNostrils], 
	dbo.GetLookupDataDes(IntercostalRecession ) as [IntercostalRecession], dbo.GetLookupDataDes(subCostalRecession ) as [subCostalRecession], dbo.GetLookupDataDes(Pulse) as [Pulse],
	dbo.GetLookupDataDes(CapRefill) as [CapRefill], dbo.GetLookupDataDes(Airway) as [Airway], dbo.GetLookupDataDes(Wheezing) as [Wheezing], dbo.GetLookupDataDes(PleuralRub) as [PleuralRub], 
	dbo.GetLookupDataDes(Crackles) as [Crackles], dbo.GetLookupDataDes(Unconscious) as [Unconscious], dbo.GetLookupDataDes(Lethargic) as [Lethargic],
	dbo.GetLookupDataDes(UnableToSitStand) as [UnableToSitStand], dbo.GetLookupDataDes(BulgingFontanelle) as [BulgingFontanelle], 
	dbo.GetLookupDataDes(StiffNeck) as [StiffNeck], dbo.GetLookupDataDes(KerningsSign) as [KerningsSign],	
	dbo.GetLookupDataName(IsBloodTransfusionDesired) as [IsBloodTransfusionDesired],
    dbo.GetLookupDataName(BloodTransfusionStateReasons) as [BloodTransfusionStateReasons],
    dbo.GetLookupDataDes(IfDesiredWasBloodGiven) as [IfDesiredWasBloodGiven],
    IfYesVolume, TransfusionDate, BloodUnits, 
    dbo.GetLookupDataName(BloodTransfusionNotGivenStateReasons) as [BloodTransfusionNotGivenStateReasons],
    dbo.GetLookupDataName(OtherFormsOfSupportiveCare) as [OtherFormsOfSupportiveCare], 
    dbo.GetLookupDataName(ReasonsForDiagnosisOfSevereComplicatedMalaria) as [ReasonsForDiagnosisOfSevereComplicatedMalaria],
    dbo.GetLookupDataName(ReasonsForAdmissionWithPositiveMalariaTest) as [ReasonsForAdmissionWithPositiveMalariaTest]	
	from SymptomsHistory

	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetSymptomsHistory
******************************************************************************************************/
-- select * from SymptomsHistory
-- delete from SymptomsHistor

------------------------------------------------------------------------------------------------------
-------------- Examinations --------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Examinations -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertExaminations')
	drop proc uspInsertExaminations
go

create proc uspInsertExaminations(
@VisitNo varchar(20),
@ExamVisitTypeID varchar(10),
@FollowupDate smalldatetime,
@DurationStartART int,
@DurationCurrentART int,
@OedemaID varchar(10),
@PregnancyStatusID varchar(10),
@ExpectedDeliveryDate smalldatetime,
@PMTCT bit,
@GestationalAge smallint,
@MUACStatusID varchar(10),
@FPMethods varchar(200),
@TBStatusID varchar(10),
@TBRxStartDate smalldatetime,
@TBRxStopDate smalldatetime,
@TBRegNo varchar(20),
@SideEffects varchar(200),
@NewOI varchar(200),
@FunctionalStatusID varchar(10),
@WHOStageID varchar(10),
@CPTAdhereID varchar(10),
@CPTDosage smallint,
@CPTDuration smallint,
@OtherMeds varchar(200),
@NutritionalSupID varchar(10),
@ARVAdhereID varchar(10),
@ARVAdhereWhy varchar(200),
@Combination varchar(30),
@ARVDosage smallint,
@ARVDuration smallint,
@CD4ABS decimal(10,2),
@CD4PCT decimal(10,2),
@Investigations varchar(200),
@Refer varchar(40),
@DaysHOSP smallint,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if exists(select VisitNo from Examinations where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ExamVisitTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Exam Visit Type ID', @ExamVisitTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OedemaID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Oedema ID', @OedemaID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PregnancyStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pregnancy Status ID', @PregnancyStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @MUACStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'MUAC Status ID', @MUACStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TBStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TB Status ID', @TBStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @FunctionalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Functional Status ID', @FunctionalStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @WHOStageID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'WHO Stage ID', @WHOStageID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CPTAdhereID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CPT Adhere ID', @CPTAdhereID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ARVAdhereID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ARV Adhere ID', @ARVAdhereID, 'Lookup Data')
		return 1
	end

if not (@Combination is null or @Combination = '')
	begin
		if not exists(select Combination from DrugCombinations where Combination  = @Combination)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Combination', @Combination, 'Drug Combinations')
				return 1
			end
	end
else if (@Combination is null or @Combination = '') begin set @Combination = null end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

----------------------------------------------------------------------------------------------------------
if @DurationStartART < 0 set @DurationStartART = null
if @DurationCurrentART < 0 set @DurationCurrentART = null
if @GestationalAge < 0 set @GestationalAge = null
if @CPTDosage < 0 set @CPTDosage = null
if @CPTDuration < 0 set @CPTDuration = null
if @ARVDosage < 0 set @ARVDosage = null
if @ARVDuration < 0 set @ARVDuration = null
if @CD4ABS < 0 set @CD4ABS = null
if @CD4PCT < 0 set @CD4PCT = null
if @DaysHOSP < 0 set @DaysHOSP = null
----------------------------------------------------------------------------------------------------------

insert into Examinations
(VisitNo, ExamVisitTypeID, FollowupDate, DurationStartART, DurationCurrentART, OedemaID, PregnancyStatusID, 
ExpectedDeliveryDate, PMTCT, GestationalAge, MUACStatusID, FPMethods, TBStatusID, TBRxStartDate, TBRxStopDate, TBRegNo, 
SideEffects, NewOI, FunctionalStatusID, WHOStageID, CPTAdhereID, CPTDosage, CPTDuration, OtherMeds, NutritionalSupID, 
ARVAdhereID, ARVAdhereWhy, Combination, ARVDosage, ARVDuration, CD4ABS, CD4PCT, Investigations, Refer, DaysHOSP, LoginID)
values
(@VisitNo, @ExamVisitTypeID, @FollowupDate, @DurationStartART, @DurationCurrentART, @OedemaID, @PregnancyStatusID, 
@ExpectedDeliveryDate, @PMTCT, @GestationalAge, @MUACStatusID, @FPMethods, @TBStatusID, @TBRxStartDate, @TBRxStopDate, @TBRegNo, 
@SideEffects, @NewOI, @FunctionalStatusID, @WHOStageID, @CPTAdhereID, @CPTDosage, @CPTDuration, @OtherMeds, @NutritionalSupID, 
@ARVAdhereID, @ARVAdhereWhy, @Combination, @ARVDosage, @ARVDuration, @CD4ABS, @CD4PCT, @Investigations, @Refer, @DaysHOSP, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertExaminations '0800001001', '0800001', '6001', '17 Aug 2010', '17 Oct 2010', 5, 12, 75, 6, 
							2, '6201', '17 Aug 2010', 1, 6, 12, '6301,6302', '6101', '12 Jan 2010', '15 Feb 2010',
							'TB006', '64NAU, 64DIA', '6501,6502', 'Nutritional Problems', 'Functional WAB', 
							'232', 45.36, 5, 8, 'Other Meds', 59.36, '6601,6602', 'ABC+DDI+KLT', 12, 4, 98.25, 53.2,
							'6701,6702', 'Refer', 8, 'S001', 'Admin'

exec uspInsertExaminations '0800001002', '0800001', '6001', '17 Aug 2010', '17 Oct 2010', 5, 12, 75, 6, 
							2, '6201', '17 Aug 2010', 1, 6, 12, '6301,6302', '6101', '12 Jan 2010', '15 Feb 2010',
							'TB006', '64NAU, 64DIA', '6501,6502', 'Nutritional Problems', 'Functional WAB', 
							'232', 45.36, 5, 8, 'Other Meds', 59.36, '6601,6602', 'ABC+DDI+KLT', 12, 4, 98.25, 53.2,
							'6701,6702', 'Refer', 8, 'S001', 'Admin'


******************************************************************************************************/
-- select * from Examinations
-- delete from Examinations

-------------- Update Examinations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateExaminations')
	drop proc uspUpdateExaminations
go

create proc uspUpdateExaminations(
@VisitNo varchar(20),
@ExamVisitTypeID varchar(10),
@FollowupDate smalldatetime,
@DurationStartART int,
@DurationCurrentART int,
@OedemaID varchar(10),
@PregnancyStatusID varchar(10),
@ExpectedDeliveryDate smalldatetime,
@PMTCT bit,
@GestationalAge smallint,
@MUACStatusID varchar(10),
@FPMethods varchar(200),
@TBStatusID varchar(10),
@TBRxStartDate smalldatetime,
@TBRxStopDate smalldatetime,
@TBRegNo varchar(20),
@SideEffects varchar(200),
@NewOI varchar(200),
@FunctionalStatusID varchar(10),
@WHOStageID varchar(10),
@CPTAdhereID varchar(10),
@CPTDosage smallint,
@CPTDuration smallint,
@OtherMeds varchar(200),
@NutritionalSupID varchar(10),
@ARVAdhereID varchar(10),
@ARVAdhereWhy varchar(200),
@Combination varchar(30),
@ARVDosage smallint,
@ARVDuration smallint,
@CD4ABS decimal(10,2),
@CD4PCT decimal(10,2),
@Investigations varchar(200),
@Refer varchar(40),
@DaysHOSP smallint,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Examinations where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Examinations')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ExamVisitTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Exam Visit Type ID', @ExamVisitTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OedemaID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Oedema ID', @OedemaID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PregnancyStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pregnancy Status ID', @PregnancyStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @MUACStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'MUAC Status ID', @MUACStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TBStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TB Status ID', @TBStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @FunctionalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Functional Status ID', @FunctionalStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @WHOStageID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'WHO Stage ID', @WHOStageID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CPTAdhereID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CPT Adhere ID', @CPTAdhereID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ARVAdhereID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ARV Adhere ID', @ARVAdhereID, 'Lookup Data')
		return 1
	end

if not (@Combination is null or @Combination = '')
	begin
		if not exists(select Combination from DrugCombinations where Combination  = @Combination)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Combination', @Combination, 'Drug Combinations')
				return 1
			end
	end
else if (@Combination is null or @Combination = '') begin set @Combination = null end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

----------------------------------------------------------------------------------------------------------
if @DurationStartART < 0 set @DurationStartART = null
if @DurationCurrentART < 0 set @DurationCurrentART = null
if @GestationalAge < 0 set @GestationalAge = null
if @CPTDosage < 0 set @CPTDosage = null
if @CPTDuration < 0 set @CPTDuration = null
if @ARVDosage < 0 set @ARVDosage = null
if @ARVDuration < 0 set @ARVDuration = null
if @CD4ABS < 0 set @CD4ABS = null
if @CD4PCT < 0 set @CD4PCT = null
if @DaysHOSP < 0 set @DaysHOSP = null
----------------------------------------------------------------------------------------------------------

update Examinations set ExamVisitTypeID = @ExamVisitTypeID, FollowupDate = @FollowupDate, DurationStartART = @DurationStartART, 
	DurationCurrentART = @DurationCurrentART, OedemaID = @OedemaID, PregnancyStatusID = @PregnancyStatusID, 
	ExpectedDeliveryDate = @ExpectedDeliveryDate, PMTCT = @PMTCT, GestationalAge = @GestationalAge, MUACStatusID = @MUACStatusID, 
	FPMethods = @FPMethods, TBStatusID = @TBStatusID, TBRxStartDate = @TBRxStartDate, TBRxStopDate = @TBRxStopDate, 
	TBRegNo = @TBRegNo, SideEffects = @SideEffects, NewOI = @NewOI, FunctionalStatusID = @FunctionalStatusID, 
	WHOStageID = @WHOStageID, CPTAdhereID = @CPTAdhereID, CPTDosage = @CPTDosage, CPTDuration = @CPTDuration, 
	OtherMeds = @OtherMeds, NutritionalSupID = @NutritionalSupID, ARVAdhereID = @ARVAdhereID, ARVAdhereWhy = @ARVAdhereWhy, 
	Combination = @Combination, ARVDosage = @ARVDosage, ARVDuration = @ARVDuration, CD4ABS = @CD4ABS, CD4PCT = @CD4PCT, 
	Investigations = @Investigations, Refer = @Refer, DaysHOSP = @DaysHOSP, LoginID = @LoginID
where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateExaminations '0800001002', '0800001', '6002', '12 Aug 2010', '12 Oct 2010', 2, 22, 25, 2, 
							3, '6202', '12 Aug 2010', 2, 2, 22, '6303,6302', '6101', '12 Jan 2010', '15 Feb 2010',
							'TB006', '64NAU, 64DIA', '6501,6502', 'Nutritional Problems2', 'Functional WAB2', 
							'233', 42.36, 2, 28, 'Other Meds2', 52.36, '6601,6603', 'ABC+DDI+KLT', 22, 2, 92.25, 52.2,
							'6701,6703', 'Refer2', 2, 'S001', 'Admin'

******************************************************************************************************/
-- select * from Examinations
-- delete from Examinations

-------------- Get Examinations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExaminations')
	drop proc uspGetExaminations
go

create proc uspGetExaminations(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Examinations where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Examinations')
		return 1
	end
else
begin
	select Examinations.VisitNo, Visits.PatientNo, FirstName, LastName, Photo,	
	dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, BirthDate, JoinDate, 
	dbo.GetAge(BirthDate, getdate()) as Age, GenderID, dbo.GetLookupDataDes(GenderID) as Gender,
	ExamVisitTypeID, dbo.GetLookupDataDes(ExamVisitTypeID) as ExamVisitType, VisitDate,
	dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,	
	dbo.GetNullDateValue(FollowupDate) as FollowupDate, DurationStartART, 
	DurationCurrentART, OedemaID, dbo.GetLookupDataDes(OedemaID) as Oedema, 
	Examinations.PregnancyStatusID, dbo.GetLookupDataDes(Examinations.PregnancyStatusID) as PregnancyStatus, 
	dbo.GetNullDateValue(ExpectedDeliveryDate) as ExpectedDeliveryDate, PMTCT, GestationalAge, 
	Examinations.MUACStatusID, dbo.GetLookupDataName(FPMethods) as FPMethods, TBStatusID, dbo.GetLookupDataDes(TBStatusID) as TBStatus, 
	dbo.GetNullDateValue(TBRxStartDate) as TBRxStartDate, dbo.GetNullDateValue(TBRxStopDate) as TBRxStopDate, 
	TBRegNo, dbo.GetLookupDataName(SideEffects) as SideEffects, dbo.GetLookupDataName(NewOI) as NewOI, 
	FunctionalStatusID, dbo.GetLookupDataDes(FunctionalStatusID) as FunctionalStatus,
	Examinations.WHOStageID, dbo.GetLookupDataDes(Examinations.WHOStageID) as WHOStage, 
	CPTAdhereID, CPTDosage, CPTDuration, OtherMeds, NutritionalSupID, 
	dbo.GetLookupDataDes(NutritionalSupID) as NutritionalSup,ARVAdhereID, 
	dbo.GetLookupDataName(ARVAdhereWhy) as ARVAdhereWhy, Examinations.Combination, ARVDosage, 
	ARVDuration, CD4ABS, CD4PCT, dbo.GetLookupDataName(Investigations) as Investigations, Refer, DaysHOSP,
	Weight, Temperature, Height, Pulse, BloodPressure, HeadCircum, BodySurfaceArea,	RespirationRate,
	dbo.CalculateBMI(Weight, Height/100) as BMI
	from Examinations
	inner join Visits on Examinations.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Triage on Triage.VisitNo = Visits.VisitNo
	where Examinations.VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetExaminations '007/05003'

******************************************************************************************************/
-- select * from Examinations
-- delete from Examinations
------------------------------------------------------------------------------------------------------
-------------- HIVCARE --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert HIVCARE -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertHIVCARE')
	drop proc uspInsertHIVCARE
go

create proc uspInsertHIVCARE(
@PatientNo Varchar(20),
@HealthUnitCode varchar(10),
@TeamLeader varchar(10),
@PtClinic varchar(20),
@LC1 Varchar(200),
@ConfirmedTestDate smalldatetime,
@HIVEnrolledDate smalldatetime,
@EligibleARTDate smalldatetime,
@EligibleReadyDate smalldatetime,
@Ab bit,
@PCR bit,
@HIVCareWhere varchar(41),
@HIVCareTransferIn bit,
@TransferInFrom varchar(41),
@WHOStageID varchar(10),
@CD4 decimal(10,2),
@PresumptiveHIV bit,
@PCRInfant bit,
@MedicalConditions varchar(2000),
@COHORTMonth tinyint,
@COHORTYear smallint,
@ARTTransferInDate smalldatetime,
@ARTTransferInFrom varchar(40),
@TransferInRegimen varchar(30),
@StartARTDate smalldatetime,
@StartARTRegimen varchar(30),
@StartARTWeight decimal(10,2),
@StartARTWHOStageID varchar(10),
@StartARTCD4 decimal(10,2),
@PregnancyStatusID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select PatientNo from HIVCARE where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo)
		return 1
	end


if not exists(select DataID from LookupData where DataID = @WHOStageID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'WHO Stage ID', @WHOStageID, 'Lookup Data')
		return 1
	end

if not (@TransferInRegimen is null or @TransferInRegimen = '')
	begin
		if not exists(select Combination from DrugCombinations where Combination  = @TransferInRegimen)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Transfer In Regimen', @TransferInRegimen, 'Drug Combinations')
				return 1
			end
		end
else if (@TransferInRegimen is null or @TransferInRegimen = '') begin set @TransferInRegimen = null end

if not (@StartARTRegimen is null or @StartARTRegimen = '')
	begin
		if not exists(select Combination from DrugCombinations where Combination  = @StartARTRegimen)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Start ART Regimen', @StartARTRegimen, 'Drug Combinations')
				return 1
			end
	end
else if (@StartARTRegimen is null or @StartARTRegimen = '') begin set @StartARTRegimen = null end

if not exists(select DataID from LookupData where DataID = @StartARTWHOStageID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Start ART WHO Stage ID', @StartARTWHOStageID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PregnancyStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pregnancy Status ID', @PregnancyStatusID, 'Lookup Data')
		return 1
	end


if not exists(select StaffNo from Staff where StaffNo  = @TeamLeader)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Team Leader', @TeamLeader, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into HIVCARE
(PatientNo, HealthUnitCode, TeamLeader, PtClinic, LC1,
 ConfirmedTestDate, HIVEnrolledDate, EligibleARTDate, EligibleReadyDate, Ab, PCR, HIVCareWhere, HIVCareTransferIn, TransferInFrom, 
WHOStageID, CD4, PresumptiveHIV, PCRInfant, MedicalConditions, COHORTMonth, COHORTYear, ARTTransferInDate, 
ARTTransferInFrom, TransferInRegimen, StartARTDate, StartARTRegimen, StartARTWeight, StartARTWHOStageID, 
StartARTCD4, PregnancyStatusID,
 LoginID)
values
(@PatientNo, @HealthUnitCode, @TeamLeader, @PtClinic, @LC1, @ConfirmedTestDate, 
@HIVEnrolledDate, @EligibleARTDate, @EligibleReadyDate, @Ab, @PCR, @HIVCareWhere, @HIVCareTransferIn, @TransferInFrom, 
@WHOStageID, @CD4, @PresumptiveHIV, @PCRInfant, @MedicalConditions, @COHORTMonth, @COHORTYear, @ARTTransferInDate, 
@ARTTransferInFrom, @TransferInRegimen, @StartARTDate, @StartARTRegimen, @StartARTWeight, @StartARTWHOStageID, 
@StartARTCD4, @PregnancyStatusID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertHIVCARE
******************************************************************************************************/
-- select * from HIVCARE
-- delete from HIVCARE


-------------- Update HIVCARE -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateHIVCARE')
	drop proc uspUpdateHIVCARE
go

create proc uspUpdateHIVCARE(
@PatientNo Varchar(20),
@HealthUnitCode varchar(10),
@TeamLeader varchar(10),
@PtClinic varchar(20),
@LC1 Varchar(200),
@ConfirmedTestDate smalldatetime,
@HIVEnrolledDate smalldatetime,
@EligibleARTDate smalldatetime,
@EligibleReadyDate smalldatetime,
@Ab bit,
@PCR bit,
@HIVCareWhere varchar(41),
@HIVCareTransferIn bit,
@TransferInFrom varchar(41),
@WHOStageID varchar(10),
@CD4 decimal(10,2),
@PresumptiveHIV bit,
@PCRInfant bit,
@MedicalConditions varchar(2000),
@COHORTMonth tinyint,
@COHORTYear smallint,
@ARTTransferInDate smalldatetime,
@ARTTransferInFrom varchar(40),
@TransferInRegimen varchar(30),
@StartARTDate smalldatetime,
@StartARTRegimen varchar(30),
@StartARTWeight decimal(10,2),
@StartARTWHOStageID varchar(10),
@StartARTCD4 decimal(10,2),
@PregnancyStatusID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
------------------------------------------------------------------------------------
if @CD4 < 0 set @CD4 = null
if @StartARTWeight < 0 set @StartARTWeight = null
if @StartARTCD4 < 0 set @StartARTCD4 = null
if @COHORTMonth <= 0 set @COHORTMonth = null
if @COHORTYear <= 0 set @COHORTYear = null
------------------------------------------------------------------------------------

if not exists(select PatientNo from HIVCARE where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'HIVCARE')
		return 1
	end

if not exists(select HealthUnitcode from HealthUnits where HealthUnitcode  = @HealthUnitCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'HealthUnit', @HealthUnitCode, 'HeathUnits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @WHOStageID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'WHO Stage ID', @WHOStageID, 'Lookup Data')
		return 1
	end

if not (@TransferInRegimen is null or @TransferInRegimen = '')
	begin
		if not exists(select Combination from DrugCombinations where Combination  = @TransferInRegimen)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Transfer In Regimen', @TransferInRegimen, 'Drug Combinations')
				return 1
			end
		end
else if (@TransferInRegimen is null or @TransferInRegimen = '') begin set @TransferInRegimen = null end

if not (@StartARTRegimen is null or @StartARTRegimen = '')
	begin
		if not exists(select Combination from DrugCombinations where Combination  = @StartARTRegimen)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Start ART Regimen', @StartARTRegimen, 'Drug Combinations')
				return 1
			end
	end
else if (@StartARTRegimen is null or @StartARTRegimen = '') begin set @StartARTRegimen = null end

if not exists(select DataID from LookupData where DataID = @StartARTWHOStageID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Start ART WHO Stage ID', @StartARTWHOStageID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PregnancyStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pregnancy Status ID', @PregnancyStatusID, 'Lookup Data')
		return 1
	end


if not exists(select StaffNo from Staff where StaffNo  = @TeamLeader)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Team Leader', @TeamLeader, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update HIVCARE set
HealthUnitCode = @HealthUnitCode, TeamLeader = @TeamLeader, PtClinic = @PtClinic, LC1 = @LC1,
ConfirmedTestDate = @ConfirmedTestDate, HIVEnrolledDate = @HIVEnrolledDate, EligibleARTDate = @EligibleARTDate, 
	EligibleReadyDate = @EligibleReadyDate, Ab = @Ab, PCR = @PCR, HIVCareWhere = @HIVCareWhere, 
	HIVCareTransferIn = @HIVCareTransferIn, TransferInFrom = @TransferInFrom, WHOStageID = @WHOStageID, CD4 = @CD4, 
	PresumptiveHIV = @PresumptiveHIV, PCRInfant = @PCRInfant, MedicalConditions = @MedicalConditions, 
	COHORTMonth = @COHORTMonth, COHORTYear = @COHORTYear, ARTTransferInDate = @ARTTransferInDate, 
	ARTTransferInFrom = @ARTTransferInFrom, TransferInRegimen = @TransferInRegimen, StartARTDate = @StartARTDate, 
	StartARTRegimen = @StartARTRegimen, StartARTWeight = @StartARTWeight, StartARTWHOStageID = @StartARTWHOStageID, 
	StartARTCD4 = @StartARTCD4, PregnancyStatusID = @PregnancyStatusID, 
 LoginID = @LoginID
where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateHIVCARE
******************************************************************************************************/
-- select * from HIVCARE
-- delete from HIVCARE


-------------- Get HIVCARE -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetHIVCARE')
	drop proc uspGetHIVCARE
go

create proc uspGetHIVCARE(
@PatientNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from HIVCARE where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'HIVCARE')
		return 1
	end
else
begin
	select PatientNo, HIVCARE.HealthUnitCode, HealthUnits.DistrictsID, 
	dbo.GetLookupDataDes(HealthUnits.DistrictsID) as District, HIVCARE.TeamLeader,  dbo.GetStaffFullName(HIVCARE.TeamLeader) as StaffFullName,PtClinic, LC1, RecordDateTime, ComputerName, HIVCARE.LoginID,
	dbo.GetNullDateValue(ConfirmedTestDate) as ConfirmedTestDate, dbo.GetNullDateValue(HIVEnrolledDate) as HIVEnrolledDate,
	dbo.GetNullDateValue(EligibleARTDate) as EligibleARTDate, dbo.GetNullDateValue(EligibleReadyDate) as EligibleReadyDate,
	Ab, PCR, HIVCareWhere, HIVCareTransferIn, TransferInFrom, WHOStageID, dbo.GetLookupDataDes(WHOStageID) as WHOStage, CD4, 
	PresumptiveHIV, PCRInfant, MedicalConditions, dbo.GetMonthName(COHORTMonth, 1) as COHORTMonth, COHORTYear, 
	dbo.GetNullDateValue(ARTTransferInDate) as ARTTransferInDate, ARTTransferInFrom, TransferInRegimen, 
	dbo.GetNullDateValue(StartARTDate) as StartARTDate, StartARTRegimen, StartARTWeight, 
	StartARTWHOStageID, dbo.GetLookupDataDes(StartARTWHOStageID) as StartARTWHOStage, StartARTCD4, 
	PregnancyStatusID, dbo.GetLookupDataDes(PregnancyStatusID) as PregnancyStatus
	from HIVCARE
		inner join HealthUnits on HIVCARE.HealthUnitCode = HealthUnits.HealthUnitCode
	where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspGetHIVCARE
******************************************************************************************************/
-- select * from HIVCARE
-- delete from HIVCARE
------------------------------------------------------------------------------------------------------
-------------- DrugAdministration --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert DrugAdministration -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertDrugAdministration')
	drop proc uspInsertDrugAdministration
go

create proc uspInsertDrugAdministration(
@VisitNo varchar(20),
@TakenDateTime smalldatetime,
@ItemCode varchar(20),
@ItemCategory varchar(10),
@ItemName varchar(800),
@QuantityTaken int,
@NurseNotes varchar(200),
@StaffNo varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if exists(select VisitNo from DrugAdministration where VisitNo = @VisitNo and TakenDateTime = @TakenDateTime and ItemCode=@ItemCode )
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: '+ dbo.FormatDate(@TakenDateTime) +', you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Taken Date &Time')
		return 1
	end
if not exists(select DataID from LookupData where DataID = @ItemCategory)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategory, 'Lookup Data')
		return 1
	end

	if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Drug Administrator', @StaffNo, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into DrugAdministration
(VisitNo, TakenDateTime, ItemCode, ItemCategory, ItemName, QuantityTaken,NurseNotes,StaffNo, LoginID)
values
(@VisitNo, @TakenDateTime, @ItemCode, @ItemCategory, @ItemName, @QuantityTaken,@NurseNotes,@StaffNo, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertDrugAdministration
******************************************************************************************************/
-- select * from DrugAdministration
-- delete from DrugAdministration


-------------- Update DrugAdministration -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateDrugAdministration')
	drop proc uspUpdateDrugAdministration
go

create proc uspUpdateDrugAdministration(
@VisitNo varchar(20),
@TakenDateTime smalldatetime,
@ItemCode varchar(20),
@ItemCategory varchar(10),
@ItemName varchar(800),
@QuantityTaken int,
@NurseNotes varchar(200),
@StaffNo varchar(20),
@LoginID varchar(20),
@ClientMachine varchar(40),
@RecordDateTime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from DrugAdministration where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'DrugAdministration')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemCategory)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategory, 'Lookup Data')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Drug Administrator', @StaffNo, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update DrugAdministration set
TakenDateTime = @TakenDateTime, ItemCode = @ItemCode, ItemCategory = @ItemCategory, ItemName = @ItemName,
 QuantityTaken = @QuantityTaken,StaffNo = @StaffNo,NurseNotes=@NurseNotes,
  LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateDrugAdministration
******************************************************************************************************/
-- select * from DrugAdministration
-- delete from DrugAdministration


-------------- Get DrugAdministration -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDrugAdministration')
	drop proc uspGetDrugAdministration
go

create proc uspGetDrugAdministration(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select VisitNo, TakenDateTime, ItemCode, ItemCategory, dbo.GetLookupDataDes(ItemCategory) as [Item Category], ItemName,
	 QuantityTaken,NurseNotes,dbo.GetStaffName(StaffNo) as StaffName,DrugAdministration.LoginID, ClientMachine, RecordDateTime
	from DrugAdministration
	where VisitNo = @VisitNo order by RecordDateTime desc
return 0
end
go

if exists (select * from sysobjects where name = 'uspGetSumDrugAdministered')
	drop proc uspGetSumDrugAdministered
go

create proc uspGetSumDrugAdministered(
@VisitNo varchar(20) = null,
@ItemCode varchar(20)=null,
@ItemCategory varchar(10)=null
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select sum(QuantityTaken) as TotalGivenAmount from DrugAdministration
	where VisitNo = @VisitNo and ItemCode =@ItemCode and ItemCategory=@ItemCategory
return 0
end
go

if exists (select * from sysobjects where name = 'uspGetDrugAdministrationPerVisit')
	drop proc uspGetDrugAdministrationPerVisit
go

create proc uspGetDrugAdministrationPerVisit(
@VisitNo varchar(20) = null,
@ItemCategoryID varchar(10) = null,
@ItemCode varchar(20) = null
)with encryption as
declare @ErrorMSG varchar(200)

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')

if not (@VisitNo is null)
begin
	if not exists(select VisitNo from Items where VisitNo = @VisitNo)
		begin
			return 1
		end
end
 
if not (@VisitNo is null) and not (@ItemCategoryID is null) and not (@ItemCode is null)
	begin
 select dbo.GetItemName(ItemsEXT.ItemCategoryID, ItemsEXT.ItemCode) as ItemName,Dosage,Duration,DrQuantity,Quantity,ItemDetails,
 dbo.GetLookupDataDes(PayStatusID) as PayStatus,UnitCost,UnitPrice,dbo.GetUnitMeasure(Items.ItemCategoryID, Items.ItemCode) as UnitMeasure,
 dbo.GetLookupDataDes(ItemStatusID) as ItemStatus from ItemsEXT
 left outer join Items on ItemsEXT. VisitNo =Items.VisitNo and  ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
 where ItemsEXT.VisitNo =@VisitNo and Items.ItemCategoryID =@ItemCategoryID and Items.ItemCode= @ItemCode	
return 0
end
go

/******************************************************************************************************
exec uspGetDrugAdministration
******************************************************************************************************/
-- select * from DrugAdministration
-- delete from DrugAdministration

-------------- Get Drugs To Prescribe by Category-------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDrugsToPrescribebyCategory')
	drop proc uspGetDrugsToPrescribebyCategory
go

create proc uspGetDrugsToPrescribebyCategory(
@GroupsID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)
begin
	select DrugNo as ItemCode, DrugName as ItemName,UnitsInStock,Hidden
	from Drugs
   where GroupsID = @GroupsID 
return 0
end
go


--------------Dr frequently prescribed drugs-------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDrfrequentlyprescribeddrugs')
	drop proc uspGetDrfrequentlyprescribeddrugs
go

create proc uspGetDrfrequentlyprescribeddrugs(
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @DrugCategoryID varchar(10)
begin
set @DrugCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
	select distinct TOP 10 ItemCode, ItemName,Hidden
	from Items 
	inner join Drugs on Drugs.DrugNo =Items.ItemCode
   where Items.CreatorLoginID = @LoginID  and ItemCategoryID =@DrugCategoryID
  
   
return 0
end
go


--------------Patient Account Statement-------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatientsAccountStatement')
	drop proc uspGetPatientsAccountStatement
go

create proc uspGetPatientsAccountStatement(
@AccountBillNo varchar(20),
@AccountBillModesID varchar(10),
@StartDateTime smalldatetime,
@EndDateTime smalldatetime
)with encryption as
declare @ErrorMSG varchar(200)
declare @CRAccountActionID varchar(10)
declare @DRAccountActionID varchar(10)
declare @ManualEntryModeID varchar(10)
declare @SystemEntryModeID varchar(10)
set @CRAccountActionID = dbo.GetLookupDataID('AccountAction', 'CR')
set @DRAccountActionID = dbo.GetLookupDataID('AccountAction', 'DR')

set @SystemEntryModeID =dbo.GetLookupDataID('EntryMode', 'SYS')
set @ManualEntryModeID = dbo.GetLookupDataID('EntryMode', 'MAN')
begin
select '' As VisitNo,TranNo,ReferenceNo,
dbo.GetAccountName(AccountBillModesID, AccountBillNo) as AccountDescription,'0.00' as Bill,
dbo.FormatMoney(Amount)as Deposit,
LoginID,dbo.FormatDate(dbo.GetAccountsRecordDateTime(Accounts.TranNo)) as RecordDate,Balance, 
dbo.GetTime(dbo.GetAccountsRecordDateTime(Accounts.TranNo)) as RecordTime FROM Accounts
where AccountActionID = @CRAccountActionID and AccountBillNo = @AccountBillNo 
and AccountBillModesID = @AccountBillModesID and dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime

union
select '' As VisitNo,TranNo,ReferenceNo,
dbo.GetAccountName(AccountBillModesID, AccountBillNo) as AccountDescription, dbo.FormatMoney(Amount)as Bill,'0.00' as Deposit,
LoginID,dbo.FormatDate(dbo.GetAccountsRecordDateTime(Accounts.TranNo)) as RecordDate,Balance, 
dbo.GetTime(dbo.GetAccountsRecordDateTime(Accounts.TranNo)) as RecordTime FROM Accounts
where AccountActionID = @DRAccountActionID and AccountBillNo = @AccountBillNo and EntryModeID = @ManualEntryModeID
and AccountBillModesID = @AccountBillModesID and dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime
union
select distinct(PaymentDetails.VisitNo) ,TranNo, Accounts.ReferenceNo,
dbo.GetFullName(LastName,MiddleName,FirstName) as AccountDescription, 
dbo.GetTotalBillPaidOnAccount(PaymentDetails.VisitNo) as Bill,'0.00' as Deposit,
Accounts.LoginID,dbo.FormatDate(dbo.GetAccountsRecordDateTime(Accounts.TranNo)) as RecordDate,Balance, 
dbo.GetTime(dbo.GetAccountsRecordDateTime(Accounts.TranNo)) as RecordTime from PaymentDetails 
inner join Accounts on Accounts.ReferenceNo = PaymentDetails.ReceiptNo
inner join Payments On Payments.ReceiptNo =PaymentDetails.ReceiptNo
inner join Visits on Visits.VisitNo =PaymentDetails.VisitNo
inner join Patients on Patients.PatientNo =Visits.PatientNo
where AccountActionID =@DRAccountActionID and AccountBillNo = @AccountBillNo and UseAccountBalance ='1' And EntryModeID =@SystemEntryModeID
and AccountBillModesID = @AccountBillModesID and dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime
return 0
end
go


if exists (select * from sysobjects where name = 'uspGetOPDDispensedDrugs')
	drop proc uspGetOPDDispensedDrugs
go

create proc uspGetOPDDispensedDrugs(
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @DrugItemCategoryID varchar(10)
declare @OfferedItemStatusID varchar(10)

set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory','D')
set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus','O')

if @StartDate is null and @EndDate is null
begin
	select Items.VisitNo, dbo.FormatDate(VisitDate) as VisitDate, Visits.PatientNo,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender, ItemCode, ItemName, Quantity, PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
	dbo.GetAge(BirthDate, getdate()) as Age, dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime 

from Items 
inner join Visits on Visits.VisitNo = Items.VisitNo
inner join Patients on Patients.PatientNo = Visits.PatientNo
where ItemCategoryID = @DrugItemCategoryID and ItemStatusID = @OfferedItemStatusID
end
else
begin
	select Items.VisitNo, dbo.FormatDate(VisitDate) as VisitDate, Visits.PatientNo,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
	GenderID, dbo.GetLookupDataDes(GenderID) as Gender, ItemCode, ItemName, Quantity, PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
	dbo.GetAge(BirthDate, getdate()) as Age, dbo.FormatDate(Items.RecordDateTime) as RecordDate, dbo.GetTime(Items.RecordDateTime) as RecordTime 
from Items 
inner join Visits on Visits.VisitNo = Items.VisitNo
inner join Patients on Patients.PatientNo = Visits.PatientNo
where ItemCategoryID = @DrugItemCategoryID and ItemStatusID = @OfferedItemStatusID
and VisitDate between @StartDate and @EndDate
end
return 0

go
/**********************************************************************************
exec uspGetOPDDispensedDrugs
exec uspGetOPDDispensedDrugs '1 Mar 2018', '1 Jul 2018'
*********************************************************************************/

------------------------------------------------------------------------------------------------------
-------------- GoodsReturnedNote --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert GoodsReturnedNote -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertGoodsReturnedNote')
	drop proc uspInsertGoodsReturnedNote
go

create proc uspInsertGoodsReturnedNote(
@ReturnNo varchar(20),
@GRNNo varchar(20),
@ReturnDate smalldatetime,
@AmountWords varchar(200),
@Notes varchar(100),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as
declare @ErrorMSG varchar(200)
declare @ReturnID int

if exists(select ReturnNo from GoodsReturnedNote where ReturnNo = @ReturnNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Return No', @ReturnNo)
		return 1
	end

if not exists(select GRNNo from GoodsReceivedNote where GRNNo  = @GRNNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'GRN No', @GRNNo, 'GoodsReceivedNote')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
/****************************************************************************************************/
set @ReturnID = (select max(ReturnID) from GoodsReturnedNote)
set @ReturnID = dbo.GetNextAutoNumber('GoodsReturnedNote', 'ReturnNo', @ReturnID)

/****************************************************************************************************/

insert into GoodsReturnedNote
(ReturnID, ReturnNo, GRNNo, ReturnDate, AmountWords, Notes, LoginID, ClientMachine)
values
(@ReturnID, @ReturnNo, @GRNNo, @ReturnDate, @AmountWords, @Notes, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertGoodsReturnedNote 
******************************************************************************************************/
-- select * from GoodsReturnedNote
-- delete from GoodsReturnedNote


-------------- Update GoodsReturnedNote -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateGoodsReturnedNote')
	drop proc uspUpdateGoodsReturnedNote
go

create proc uspUpdateGoodsReturnedNote(
@ReturnID int,
@ReturnNo varchar(20),
@GRNNo varchar(20),
@ReturnDate smalldatetime,
@AmountWords varchar(200),
@Notes varchar(100),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ReturnNo from GoodsReturnedNote where ReturnNo = @ReturnNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Return No', @ReturnNo, 'GoodsReturnedNote')
		return 1
	end

if not exists(select GRNNo from GoodsReceivedNote where GRNNo  = @GRNNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'GRN No', @GRNNo, 'GoodsReceivedNote')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update GoodsReturnedNote set
ReturnID = @ReturnID, GRNNo = @GRNNo, ReturnDate = @ReturnDate, AmountWords = @AmountWords, Notes = @Notes, LoginID = @LoginID, ClientMachine = @ClientMachine
where ReturnNo = @ReturnNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateGoodsReturnedNote
******************************************************************************************************/
-- select * from GoodsReturnedNote
-- delete from GoodsReturnedNote


-------------- Get GoodsReturnedNote -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetGoodsReturnedNote')
	drop proc uspGetGoodsReturnedNote
go

create proc uspGetGoodsReturnedNote(
@ReturnNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ReturnNo from GoodsReturnedNote where ReturnNo = @ReturnNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Return No', @ReturnNo, 'GoodsReturnedNote')
		return 1
	end
else
begin
	select ReturnID, ReturnNo, GoodsReturnedNote.GRNNo, GoodsReturnedNote.ReturnDate, GoodsReturnedNote.AmountWords, GoodsReturnedNote.Notes, GoodsReturnedNote.LoginID, GoodsReturnedNote.ClientMachine
	from GoodsReturnedNote
	inner join GoodsReceivedNote on GoodsReturnedNote.GRNNo = GoodsReceivedNote.GRNNo	
	where ReturnNo = @ReturnNo
return 0
end
go

/******************************************************************************************************
exec uspGetGoodsReturnedNote
******************************************************************************************************/
-- select * from GoodsReturnedNote
-- delete from GoodsReturnedNote

--------GetNextReturnID-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextReturnID')
	drop proc uspGetNextReturnID
go

create proc uspGetNextReturnID(
@GRNNo varchar(20),
@ReturnID int = null output
)with encryption as

set @ReturnID = (select count(ReturnNo) from GoodsReturnedNote
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo = GoodsReturnedNote.GRNNo
where GoodsReceivedNote.GRNNo =@GRNNo)

set @ReturnID = dbo.GetNextAutoNumber('GoodsReturnedNote', 'ReturnNo', @ReturnID)

return 0
go

/******************************************************************************************************
exec uspGetNextReturnID '0032'
******************************************************************************************************/
-- select * from GoodsReturnedNote
-- select * from GoodsReceivedNote
-- delete from GoodsReturnedNote


------------------------------------------------------------------------------------------------------
-------------- GoodsReturnedNoteDetails --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert GoodsReturnedNoteDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertGoodsReturnedNoteDetails')
	drop proc uspInsertGoodsReturnedNoteDetails
go

create proc uspInsertGoodsReturnedNoteDetails(
@ReturnNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@ItemName varchar(800),
@ReturnQuantity Int,
@GoodsReturnReasonID varchar(10),
@LoginID varchar(20)
--@ClientMachine varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @GRNNo varchar(20)
declare @InventoryLocationID varchar(20)
declare @UnitsAtHand int
declare @PreviousReturnedQuantity int
declare @ReceivedQuantity int
declare @CummulativeReturned int

if not exists(select ReturnNo from GoodsReturnedNote where ReturnNo  = @ReturnNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Return No', @ReturnNo, 'GoodsReturnedNote')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if exists(select ReturnNo from GoodsReturnedNoteDetails where ReturnNo = @ReturnNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Return No', @ReturnNo, 'Item Category', @ItemCategoryID, 'Item Code', @ItemCode)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GoodsReturnReasonID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Goods Return Reason', @GoodsReturnReasonID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end



set @GRNNo = (select GRNNo from GoodsReturnedNote where ReturnNo=@ReturnNo group by GRNNo)
set @InventoryLocationID = (select DeliveryLocationID from GoodsReceivedNote where GRNNo=@GRNNo)
set @UnitsAtHand = (select UnitsAtHand from InventoryLocation where LocationID=@InventoryLocationID and ItemCode=@ItemCode)
set @ReceivedQuantity =  dbo.GetTotalReceived(@GRNNo,@ItemCategoryID,@ItemCode)
set @PreviousReturnedQuantity=dbo.GetTotalReturnedItemQuantity(@GRNNo,@ItemCode)
set @CummulativeReturned=@PreviousReturnedQuantity+@ReturnQuantity

if (@CummulativeReturned)>@UnitsAtHand
	begin
		set @ErrorMSG = 'The  %s: %d, you are trying to enter cannot greater than the Units at hand %d'
		raiserror(@ErrorMSG, 16, 1, 'accumulative returned', @CummulativeReturned, @UnitsAtHand)
		
		return 1
	end

	if (@CummulativeReturned)>@ReceivedQuantity
	begin
		set @ErrorMSG = 'The  %s: %d, you are trying to enter cannot greater than the received Quantity %d'
		raiserror(@ErrorMSG, 16, 1, 'accumulative returned', @CummulativeReturned,@ReceivedQuantity)
		
		return 1
	end

begin
insert into GoodsReturnedNoteDetails
(ReturnNo, ItemCategoryID, ItemCode, ItemName, ReturnQuantity, GoodsReturnReasonID, LoginID)
values
(@ReturnNo, @ItemCategoryID, @ItemCode, @ItemName, @ReturnQuantity, @GoodsReturnReasonID, @LoginID)
return 0
end
go

--select * from InventoryLocation
--select ReceivedQuantity from GoodsReceivedNoteDetails where GRNNo='1600100001' and ItemCode='M005'
/******************************************************************************************************
exec uspInsertGoodsReturnedNoteDetails
******************************************************************************************************/
-- select * from GoodsReturnedNoteDetails
-- delete from GoodsReturnedNoteDetails


-------------- Update GoodsReturnedNoteDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateGoodsReturnedNoteDetails')
	drop proc uspUpdateGoodsReturnedNoteDetails
go

create proc uspUpdateGoodsReturnedNoteDetails(
@ReturnNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@ItemName varchar(800),
@ReturnQuantity Int,
@GoodsReturnReasonID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ReturnNo from GoodsReturnedNoteDetails where ReturnNo = @ReturnNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Return No', @ReturnNo, 'Item Category', @ItemCategoryID, 'Item Code', @ItemCode, 'GoodsReturnedNoteDetails')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GoodsReturnReasonID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Goods Return Reason', @GoodsReturnReasonID, 'Lookup Data')
		return 1
	end


if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update GoodsReturnedNoteDetails set
ItemName = @ItemName, ReturnQuantity = @ReturnQuantity, GoodsReturnReasonID = @GoodsReturnReasonID, LoginID = @LoginID, ClientMachine = @ClientMachine
where ReturnNo = @ReturnNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateGoodsReturnedNoteDetails
******************************************************************************************************/
-- select * from GoodsReturnedNoteDetails
-- delete from GoodsReturnedNoteDetails


-------------- Get GoodsReturnedNoteDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetGoodsReturnedNoteDetails')
	drop proc uspGetGoodsReturnedNoteDetails
go

create proc uspGetGoodsReturnedNoteDetails(
@ReturnNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ReturnNo from GoodsReturnedNoteDetails where ReturnNo = @ReturnNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Return No', @ReturnNo, 'Item Category', @ItemCategoryID, 'Item Code', @ItemCode, 'GoodsReturnedNoteDetails')
		return 1
	end
else
begin
	select ReturnNo, ItemCategoryID, ItemCode, ItemName, ReturnQuantity, GoodsReturnReasonID, dbo.GetLookupDataDes(GoodsReturnReasonID) as [Goods Return Reason], GoodsReturnedNoteDetails.LoginID, ClientMachine, RecordDateTime
	from GoodsReturnedNoteDetails
	inner join Logins on GoodsReturnedNoteDetails.LoginID = Logins.LoginID	

	where ReturnNo = @ReturnNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
return 0
end
go

/******************************************************************************************************
exec uspGetGoodsReturnedNoteDetails
******************************************************************************************************/
-- select * from GoodsReturnedNoteDetails
-- delete from GoodsReturnedNoteDetails


-------- uspCountGoodsReceivedProcessed -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCountGoodsReceivedProcessed')
	drop proc uspCountGoodsReceivedProcessed
go

create proc uspCountGoodsReceivedProcessed(
@GRNNo varchar(20),
@NoNotesProcessed tinyint = null output
)with encryption as

	set @NoNotesProcessed = (select count(GRNNo) from GoodsReturnedNote where GRNNo = @GRNNo)
	set @NoNotesProcessed = isnull(@NoNotesProcessed, 0)
	
return 0
go

-- exec uspCountGoodsReceivedProcessed '0001'

-------------- Get GoodsReceivedNoteDetailsToReturn -------------------------------------------------------------
-------------- Get GoodsReceivedNoteDetailsToReturn -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetGoodsReceivedNoteDetailsToReturn')
	drop proc uspGetGoodsReceivedNoteDetailsToReturn
go

create proc uspGetGoodsReceivedNoteDetailsToReturn(
@GRNNo varchar(20),
@LocationID varchar(10), 
@ItemCategoryID varchar(10) = null,
@ItemCode varchar(20) = null  ----added 19/08/2016
)with encryption as

declare @ErrorMSG varchar(200)

if ((@ItemCategoryID is null or @ItemCategoryID = '') and (@ItemCode is null or @ItemCode=''))
begin
	select GoodsReceivedNoteDetails.GRNNo, GoodsReceivedNoteDetails.ItemCategoryID as ItemCategoryID, 
	dbo.GetLookupDataDes(GoodsReceivedNoteDetails.ItemCategoryID) as ItemCategory, 
	GoodsReceivedNoteDetails.ItemCode, ItemName, dbo.GetMergedNameCode(ItemName,
	 GoodsReceivedNoteDetails.ItemCode) as ItemFullName, UnitMeasure, OrderedQuantity, 
	ReceivedQuantity, dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	 dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,GoodsReceivedNoteDetails.ItemCode) as PreviousReturned, 
	BonusQuantity, Rate, Discount, Amount, GoodsReceivedNoteDetails.BatchNo as BatchNo, 
	dbo.FormatDate(GoodsReceivedNoteDetails.ExpiryDate) as ExpiryDate, Notes, UnitsAtHand,GoodsReceivedNoteDetails.BatchNo
	from InventoryLocation
		inner join GoodsReceivedNoteDetails on InventoryLocation.ItemCode = GoodsReceivedNoteDetails.ItemCode
		and GoodsReceivedNoteDetails.ItemCategoryID = InventoryLocation.ItemCategoryID
		and GoodsReceivedNoteDetails.GRNNo = @GRNNo
		and InventoryLocation.LocationID = @LocationID
		inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo = GoodsReceivedNote.GRNNo
	where GoodsReceivedNoteDetails.GRNNo = @GRNNo
	and dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,GoodsReceivedNoteDetails.ItemCode)< dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode)
	and dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,GoodsReceivedNoteDetails.ItemCode)< UnitsAtHand
end

-------19/08/16
else
  if ((@ItemCategoryID is null or @ItemCategoryID = '') and (not @ItemCode is null or not @ItemCode = ''))

begin
	select GoodsReceivedNoteDetails.GRNNo, GoodsReceivedNoteDetails.ItemCategoryID as ItemCategoryID, 
	dbo.GetLookupDataDes(GoodsReceivedNoteDetails.ItemCategoryID) as ItemCategory, 
	GoodsReceivedNoteDetails.ItemCode, ItemName, dbo.GetMergedNameCode(ItemName,
	 GoodsReceivedNoteDetails.ItemCode) as ItemFullName, UnitMeasure, OrderedQuantity, 
	ReceivedQuantity,dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,GoodsReceivedNoteDetails.ItemCode) as PreviousReturned,
	 BonusQuantity, Rate, Discount, Amount, GoodsReceivedNoteDetails.BatchNo as BatchNo, 
	dbo.FormatDate(GoodsReceivedNoteDetails.ExpiryDate) as ExpiryDate, Notes, UnitsAtHand,GoodsReceivedNoteDetails.BatchNo
	from InventoryLocation
		inner join GoodsReceivedNoteDetails on InventoryLocation.ItemCode = GoodsReceivedNoteDetails.ItemCode
		and GoodsReceivedNoteDetails.ItemCategoryID = InventoryLocation.ItemCategoryID
		and GoodsReceivedNoteDetails.GRNNo = @GRNNo
		and InventoryLocation.LocationID = @LocationID
		inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo = GoodsReceivedNote.GRNNo
	where GoodsReceivedNoteDetails.GRNNo = @GRNNo and GoodsReceivedNoteDetails.ItemCode=@ItemCode
	and dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,GoodsReceivedNoteDetails.ItemCode)< dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode)
	and dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,GoodsReceivedNoteDetails.ItemCode)< UnitsAtHand
end	---------19/08/16

else
begin
	select GoodsReceivedNoteDetails.GRNNo, GoodsReceivedNoteDetails.ItemCategoryID as ItemCategoryID, 
	dbo.GetLookupDataDes(GoodsReceivedNoteDetails.ItemCategoryID) as ItemCategory, 
	GoodsReceivedNoteDetails.ItemCode, ItemName, dbo.GetMergedNameCode(ItemName,
	 GoodsReceivedNoteDetails.ItemCode) as ItemFullName, UnitMeasure, OrderedQuantity, 
	ReceivedQuantity,dbo.GetTotalReceived(GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode) as TotalReceived,
	dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,GoodsReceivedNoteDetails.ItemCode) as PreviousReturned,
	 BonusQuantity, Rate, Discount, Amount, GoodsReceivedNoteDetails.BatchNo as BatchNo, 
	dbo.FormatDate(GoodsReceivedNoteDetails.ExpiryDate) as ExpiryDate, Notes, UnitsAtHand
	from InventoryLocation
		inner join GoodsReceivedNoteDetails on InventoryLocation.ItemCode = GoodsReceivedNoteDetails.ItemCode
		and GoodsReceivedNoteDetails.ItemCategoryID = InventoryLocation.ItemCategoryID
		and GoodsReceivedNoteDetails.GRNNo = @GRNNo
		and InventoryLocation.LocationID = @LocationID
		and GoodsReceivedNoteDetails.ItemCode=@ItemCode
		inner join GoodsReceivedNote on GoodsReceivedNoteDetails.GRNNo = GoodsReceivedNote.GRNNo
	where GoodsReceivedNoteDetails.GRNNo = @GRNNo and GoodsReceivedNoteDetails.ItemCategoryID = @ItemCategoryID 
	and dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,GoodsReceivedNoteDetails.ItemCode)< dbo.GetTotalReceived (GoodsReceivedNoteDetails.GRNNo,GoodsReceivedNoteDetails.ItemCategoryID,GoodsReceivedNoteDetails.ItemCode)
	and dbo.GetTotalReturnedItemQuantity(GoodsReceivedNote.GRNNo,GoodsReceivedNoteDetails.ItemCode)< UnitsAtHand
end	
return 0
go


/******************************************************************************************************
exec uspGetGoodsReceivedNoteDetailsToReturn '0028', '11702'
exec uspGetGoodsReceivedNoteDetailsToReturn '0031', '11702', '7D'
******************************************************************************************************/
-- select * from GoodsReceivedNoteDetails
-- delete from GoodsReceivedNoteDetails
----------------------------------------------------------------------------------
--------GetTotalReturnedQuantity ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalReturnedQuantity')
	drop function GetTotalReturnedQuantity
go

create function GetTotalReturnedQuantity(@GRNO varchar(20)) returns int
with encryption as

begin

declare @returnedQuantity int

--------------------------------------------------------------------------------------------

set @returnedQuantity = (select sum(ReturnQuantity) 
from GoodsReturnedNoteDetails 
inner join GoodsReturnedNote on GoodsReturnedNote.ReturnNo=GoodsReturnedNoteDetails.ReturnNo
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo=GoodsReturnedNote.GRNNo
where GoodsReturnedNote.GRNNo = @GRNO) 
--------------------------------------------------------------------------------------------

set @returnedQuantity = isnull(@returnedQuantity, 0)

return @returnedQuantity

end
go
------------print dbo.GetTotalReturnedQuantity('1600030001')

--------GetTotalReturnedItemQuantity ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalReturnedItemQuantity')
	drop function GetTotalReturnedItemQuantity
go

create function GetTotalReturnedItemQuantity(@GRNO varchar(20),@ItemCode varchar(20)) returns int
with encryption as

begin

declare @returnedItemQuantity int
declare @returnNo varchar(20)

--------------------------------------------------------------------------------------------
set @returnedItemQuantity = (select sum(ReturnQuantity) 
from GoodsReturnedNoteDetails 
inner join GoodsReturnedNote on GoodsReturnedNote.ReturnNo=GoodsReturnedNoteDetails.ReturnNo
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo=GoodsReturnedNote.GRNNo
where GoodsReturnedNote.GRNNo = @GRNO and ItemCode=@ItemCode) 
--------------------------------------------------------------------------------------------

set @returnedItemQuantity = isnull(@returnedItemQuantity, 0)

return @returnedItemQuantity

end
go
------------print dbo.GetTotalReturnedItemQuantity('1600030001','M007')


--------GetTotalReceivedQuantity ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalReceivedQuantity')
	drop function GetTotalReceivedQuantity
go

create function GetTotalReceivedQuantity(@GRNNo varchar(20)) returns int
with encryption as

begin

declare @receivedQuantity int

--------------------------------------------------------------------------------------------
set @receivedQuantity = (select sum(ReceivedQuantity) from GoodsReceivedNoteDetails where GRNNo = @GRNNo) 
--------------------------------------------------------------------------------------------

set @receivedQuantity = isnull(@receivedQuantity, 0)

return @receivedQuantity

end
go
-------------print dbo.GetTotalReceivedQuantity('1600020001')

--------GetUnreturnedGoodsReceivedNote----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetUnReturnedGoodsReceivedNote')
	drop proc uspGetUnReturnedGoodsReceivedNote
go

create proc uspGetUnReturnedGoodsReceivedNote(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

begin

	select GRNNo, GoodsReceivedNote.PurchaseOrderNo, dbo.FormatDate(ReceivedDate) as ReceivedDate, 
	AdviceNoteNo, dbo.GetLookupDataDes(DeliveryLocationID) as DeliveryLocation,SupplierName, 	
	dbo.FormatMoney(dbo.GetGoodsReceivedNoteTotalAmount(GoodsReceivedNote.GRNNo)) as GRNAmount,
	dbo.FormatDate(GoodsReceivedNote.RecordDateTime) as RecordDate, 
	dbo.GetTime(GoodsReceivedNote.RecordDateTime) as RecordTime
	from GoodsReceivedNote
	inner join PurchaseOrders on GoodsReceivedNote.PurchaseOrderNo = PurchaseOrders.PurchaseOrderNo
	inner join Suppliers on Suppliers.SupplierNo = PurchaseOrders.SupplierNo
	where ReceivedDate between @StartDate and @EndDate
	and (GRNNo not in (select GRNNo from GoodsReturnedNote) or dbo.GetTotalReceivedQuantity(GRNNo)>dbo.GetTotalReturnedQuantity(GRNNo))
	order by ReceivedDate desc, GRNNo desc
return 0
end
go

-- select * from GoodsReceivedNote
-- exec uspGetUnReturnedGoodsReceivedNote 'May 12, 2015', 'Dec 13, 2015'

-------------- uspGetReturnedGoods -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetReturnedGoods')
	drop proc uspGetReturnedGoods
go

create proc uspGetReturnedGoods(
@GRNNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select dbo.FormatDate(ReturnDate) as ReturnDate,GoodsReturnedNoteDetails.ItemName As ItemName, 
	dbo.GetLookupDataDes(GoodsReturnedNoteDetails.ItemCategoryID) as ItemCategory,
	ReturnQuantity,rate, (rate*ReturnQuantity) as amount
	from GoodsReturnedNoteDetails
	    inner join GoodsReturnedNote on GoodsReturnedNote.ReturnNo=GoodsReturnedNoteDetails.ReturnNo
		inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo=GoodsReturnedNote.GRNNo
		inner join GoodsReceivedNoteDetails on GoodsReceivedNote.GRNNo=GoodsReceivedNoteDetails.GRNNo 
		and GoodsReceivedNoteDetails.ItemCategoryID=GoodsReturnedNoteDetails.ItemCategoryID and GoodsReceivedNoteDetails.ItemCode=GoodsReturnedNoteDetails.ItemCode
	   where GoodsReceivedNote.GRNNo = @GRNNo
	  
		
end
go

---select * from GoodsReturnedNote where GRNNo='1600080001'
/******************************************************************************************************/
---exec uspGetReturnedGoods '16003501'
---exec uspGetReturnedGoods ''



------------------------------------------------------------------------------------------------------
-------------- BulkMessaging --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert BulkMessaging -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertBulkMessaging')
	drop proc uspInsertBulkMessaging
go

create proc uspInsertBulkMessaging(
@MessageNo Varchar(20),
@Phone varchar(7500),
@Message Varchar(600),
@SentID varchar(10),
@flagID varchar(10),
@LoginID Varchar(20),
@SendDateTime SmallDateTime,
@TextLifeSpan int
)with encryption as

declare @ErrorMSG varchar(200)
declare @PassedMessageID int
declare @CurrentYear as char(2)
declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint
declare @MessageID int
declare @PassedMessageNo varchar(20)

---------------------------------------------------------------------------------------------------------------------
select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'BulkMessaging' and AutoColumnName = 'MessageNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'BulkMessaging' and AutoColumnName = 'MessageNo'

set @CurrentYear = right(year(getdate()),2)

if (@AutoColumnLEN = len(@MessageNo)) and (left(@MessageNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedMessageID = 1
	set @PassedMessageNo = @MessageNo
	set @PassedMessageNo = ltrim(rtrim(substring(@PassedMessageNo, len(@CurrentYear) + 1, @PaddingLEN)))

	if isnumeric(@PassedMessageNo) = 1 set @PassedMessageID = @PassedMessageNo
	else set @PassedMessageID = 1

	set @MessageID = (select max(MessageID) from BulkMessaging where left(MessageNo, len(@CurrentYear)) = @CurrentYear)
	set @MessageID = dbo.GetNextAutoNumber('BulkMessaging', 'MessageNo', @MessageID)

	if @PassedMessageID < @MessageID set @MessageID = @PassedMessageID
	if @PassedMessageID > @MessageID set @MessageID = @PassedMessageID

end else set @MessageID = 1

---------------------------------------------------------------------------------------------------------------------------
if exists(select Message from BulkMessaging where MessageNo = @MessageNo and Phone=@Phone and Message=@Message  )
begin
update BulkMessaging set 		
MessageID = @MessageID, Phone = @Phone, Message = @Message,SentID=@SentID,flagID=@flagID,LoginID = @LoginID, 
@SendDateTime = SendDateTime where MessageNo = @MessageNo and Message =@Message and Phone =@Phone
return 0
end
else
begin
insert into BulkMessaging (MessageID,MessageNo, Phone, Message,SentID,flagID,LoginID,SendDateTime,TextLifeSpan) values
(@MessageID,@MessageNo, @Phone, @Message,@SentID,@flagID, @LoginID,@SendDateTime,@TextLifeSpan)
return 0
end
go

/******************************************************************************************************
exec uspInsertBulkMessaging
******************************************************************************************************/
-- select * from BulkMessaging
-- delete from BulkMessaging

--------GetNextMessageID---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextMessageID')
	drop proc uspGetNextMessageID
go

create proc uspGetNextMessageID(
@MessageID int = null output
)with encryption as

declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @MessageID = (select max(MessageID) from BulkMessaging where left(MessageNo, 2) = @CurrentYear)
set @MessageID = dbo.GetNextAutoNumber('BulkMessaging', 'MessageNo', @MessageID)

return 0

go

-- exec uspGetNextMessageID
-- select * from BulkMessaging


/******************************************************************************************************/
-- exec uspGetUnsentTextMessages
/******************************************************************************************************/

if exists (select * from sysobjects where name = 'uspGetUnsentTextMessages')
	drop proc uspGetUnsentTextMessages
go

create proc uspGetUnsentTextMessages(
@sentID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select Phone,Message,TextLifeSpan
	from BulkMessaging
	where SentID = @sentID and len(Phone) >= 10 and CAST(RecordDateTime AS DATE) = CAST(GETDATE() AS DATE) AND
	 RecordDateTime > DateADD(MINUTE,-(2), Current_TimeStamp)
	 group by Phone,Message,TextLifeSpan

end

return 0

go

------------------------------------------------------------------------------------------------------
-------------- Messenger --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Messenger -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertMessenger')
	drop proc uspInsertMessenger
go

create proc uspInsertMessenger(
@ReceiverStaffNo varchar(20),
@MessageInfo varchar(2000),
@LoginID varchar(20),
@Status bit
)with encryption as

declare @ErrorMSG varchar(200)



if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into Messenger
(ReceiverStaffNo, MessageInfo, LoginID, Status)
values
(@ReceiverStaffNo, @MessageInfo, @LoginID, @Status)
return 0
end
go

/******************************************************************************************************
exec uspInsertMessenger
******************************************************************************************************/
-- select * from Messenger
-- delete from Messenger


-------------- Update Messenger -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateMessenger')
	drop proc uspUpdateMessenger
go

create proc uspUpdateMessenger(
@ReceiverStaffNo varchar(20),
@MessageInfo varchar(2000),
@LoginID varchar(20),
@Status bit
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update Messenger set
ReceiverStaffNo = @ReceiverStaffNo, MessageInfo = @MessageInfo, LoginID = @LoginID,
Status = @Status

return 0
end
go

/******************************************************************************************************
exec uspUpdateMessenger
******************************************************************************************************/
-- select * from Messenger
-- delete from Messenger


-------------- Get Messenger -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetMessenger')
	drop proc uspGetMessenger
go

create proc uspGetMessenger(
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select  ReceiverStaffNo,dbo.GetLoginsFullName(ReceiverStaffNo) as ReceiverFullName, MessageInfo, Messenger.LoginID,
		dbo.FormatDate(RecordDateTime) as RecordDate,
	 ClientMachine, RecordDateTime, Status
	from Messenger where Messenger.LoginID =@LoginID
	order by RecordDateTime desc
return 0
end
go

/******************************************************************************************************
exec uspGetMessenger
******************************************************************************************************/
-- select * from Messenger where ReceiverStaffNo ='100'
-- delete from Messenger


-------------- Get Inbox Messages-------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInboxMessages')
	drop proc uspGetInboxMessages
go

create proc uspGetInboxMessages(
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select  ReceiverStaffNo,dbo.GetLoginsFullName(LoginID) as FromFullName, MessageInfo, Messenger.LoginID,
		dbo.FormatDate(RecordDateTime) as RecordDate,
	 ClientMachine, RecordDateTime, Status
	from Messenger where ReceiverStaffNo =@LoginID
	order by RecordDateTime desc

return 0
end
go

-------------- Get UnRead Messages -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetUnReadMessages')
	drop proc uspGetUnReadMessages
go

create proc uspGetUnReadMessages(
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not(@LoginID is null)
begin
select MessageInfo from Messenger
where Status = 0 and ReceiverStaffNo =@LoginID
end

return 0
go


-------------- Get Clear Read Messages -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetClearReadMessages')
	drop proc uspGetClearReadMessages
go

create proc uspGetClearReadMessages(
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not(@LoginID is null)
begin
UPDATE Messenger SET Status = 1
where ReceiverStaffNo =@LoginID
end

return 0
go



------------------------------------------------------------------------------------------------------
-------------- BarCodeDetails --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert BarCodeDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertBarCodeDetails')
	drop proc uspInsertBarCodeDetails
go

create proc uspInsertBarCodeDetails(
@ItemCode Varchar(20),
@ItemCategoryID varchar(10),
@BarCode Varchar(2000),
@LoginID varchar(20),
@ClientMachine Varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

begin
insert into BarCodeDetails
(ItemCode, ItemCategoryID, BarCode, LoginID, ClientMachine)
values
(@ItemCode, @ItemCategoryID, @BarCode, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertBarCodeDetails
******************************************************************************************************/
-- select * from BarCodeDetails
-- delete from BarCodeDetails



-------------- Get BarCodeDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBarCodeDetails')
	drop proc uspGetBarCodeDetails
go

create proc uspGetBarCodeDetails(
@BarCode Varchar(2000)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select BarCode from BarCodeDetails where BarCode  = @BarCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'BarCode', @BarCode, 'BarCodeDetails')
		return 1
	end

begin
	select	TOP 1 ItemCode from BarCodeDetails
   where BarCode = @BarCode Order by RecordDateTime Desc
return 0
end
go

/******************************************************************************************************
exec uspGetBarCodeDetails
******************************************************************************************************/
-- select * from BarCodeDetails
-- delete from BarCodeDetails

if exists (select * from sysobjects where name = 'uspGetItemStatusSummaries')
	drop proc uspGetItemStatusSummaries
go

create proc uspGetItemStatusSummaries(
@ItemCategoryID varchar(10),
@StartDateTime smalldatetime,
@EndDateTime smalldatetime
)with encryption as 

declare @ErrorMSG varchar(200)
declare @ItemOfferedID varchar(10)
declare @ItemDoneID varchar(10)
declare @PendingItemStatusID varchar(10)
declare @ProcessingItemStatusID varchar(10)

set @ItemOfferedID = dbo.GetLookupDataID('ItemStatus', 'O')
set @ItemDoneID = dbo.GetLookupDataID('ItemStatus', 'D')
set @PendingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @ProcessingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'R')

begin
select ItemName,Count(VisitNo) as NoOfPatients ,Count(case when (ItemStatusID =@ItemDoneID or ItemStatusID =@ItemOfferedID ) then (ItemStatusID) else Null end) as Offered
,Count(case when (ItemStatusID =@PendingItemStatusID) then (ItemStatusID) else Null end) as Pending
,Count(case when (ItemStatusID =@ProcessingItemStatusID) then (ItemStatusID) else Null end) as Processing
 from Items Where ItemCategoryID =@ItemCategoryID and RecordDateTime between @StartDateTime and @EndDateTime Group by ItemName

 end
 return 0
 go
 ----------------------------------------------------------------------------------------------------------------------
 ------------------------------ Get Patient Birthdays -----------------------------------------------------------------
 ----------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatientBirthdays')
	drop proc uspGetPatientBirthdays
go

create proc uspGetPatientBirthdays(
@PatientNo varchar(20)= null
)with encryption as
declare @ErrorMSG varchar(200)

if ((@PatientNo is null or @PatientNo = ''))

begin 

select FirstName,PatientNo,dbo.FormatDate(Patients.BirthDate) as dob,Phone,dbo.GetMonthName(datepart(month, BirthDate), 0) as BirthMonth,datepart(day, BirthDate) as BirthDate  from Patients
where dbo.GetMonthName(datepart(month, BirthDate), 0)= dbo.GetMonthName(datepart(month, getdate()), 0) and datepart(day, BirthDate) = datepart(day, getdate())
end
else
begin
select FirstName,PatientNo,dbo.FormatDate(Patients.BirthDate) as dob,Phone,dbo.GetMonthName(datepart(month, BirthDate), 0) as BirthMonth,datepart(day, BirthDate) as BirthDate  from Patients
where dbo.GetMonthName(datepart(month, BirthDate), 0)= dbo.GetMonthName(datepart(month, getdate()), 0) and datepart(day, BirthDate) = datepart(day, getdate()) and PatientNo=@PatientNo

end
return 0

go

----------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTimelySMSIncomeSummaries')
	drop proc uspGetTimelySMSIncomeSummaries
go

create proc uspGetTimelySMSIncomeSummaries(
@startdatetime smalldatetime,
@enddatetime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)
---------------------------------------------------------------------------------------------
begin


select TOP 1 dbo.GetTimelySMSIncomeSummaries(@startdatetime, @enddatetime) as finalMoney from Payments
end
return 0

go

-------------------------------------------------Timely Other Income SMS---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTimelyOtherIncomeSMS')
	drop proc uspGetTimelyOtherIncomeSMS
go

create proc uspGetTimelyOtherIncomeSMS(
@startdatetime smalldatetime,
@enddatetime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)
---------------------------------------------------------------------------------------------
begin


select TOP 1 dbo.GetTimelyOtherIncomes(@startdatetime, @enddatetime) as depositsfinalMoney from OtherIncome
end
return 0

go

----------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTimelyAccountsSMS')
	drop proc uspGetTimelyAccountsSMS
go

create proc uspGetTimelyAccountsSMS(
@startdatetime smalldatetime,
@enddatetime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)
---------------------------------------------------------------------------------------------
begin


select TOP 1 dbo.GetTimelySMSDeposits(@startdatetime, @enddatetime) as AccountsfinalMoney from Accounts
end
return 0

go


-------------------------------------------------Timely Expenditure SMS---------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTimelyExpenditure')
	drop proc uspGetTimelyExpenditure
go

create proc uspGetTimelyExpenditure(
@startdatetime smalldatetime,
@enddatetime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)
---------------------------------------------------------------------------------------------
begin


select TOP 1 dbo.GetTimelyExpenditures(@startdatetime, @enddatetime) as expenditurefinalMoney from Expenditure
end
return 0

go

----------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
-------------- PhysicalStockCount --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PhysicalStockCount -------------------------------------------------------------


if exists (select * from sysobjects where name = 'uspInsertPhysicalStockCount')
	drop proc uspInsertPhysicalStockCount
go

create proc uspInsertPhysicalStockCount(
@PSCNo varchar(20),
@GeneralNotes Varchar(200),
@StartDate smalldatetime,
@EndDate smalldatetime,
@Closed bit,
@LoginID varchar(20),
@ClientMachine Varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @PSCID int
declare @CurrentYear int

if exists(select PSCNo from PhysicalStockCount where PSCNo = @PSCNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'PSC No', @PSCNo)
		return 1
	end

 if (@EndDate < @StartDate)
	begin
		set @ErrorMSG = 'End Date can''t be before Start Date!'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

	if (dbo.GetOptionValue('EnableMultiplePhysicalStockCountNumbers') = 0)
	  begin 
	 if exists(select top 1 PSCNo from PhysicalStockCount where Closed = 0)
		begin
			set @ErrorMSG = 'There is already an Open Physical Count No. The System is not set allow multiple Physical Stock Count'
			raiserror(@ErrorMSG, 16, 1)
			return 1
		end
	  end


if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

	

begin

set @CurrentYear = right(year(getdate()),2)
set @PSCID = (select max(PSCID) from PhysicalStockCount where left(PSCNo, 2) = @CurrentYear)
set @PSCID = dbo.GetNextAutoNumber('PhysicalStockCount', 'PSCNo', @PSCID)
insert into PhysicalStockCount
(PSCID, PSCNo, GeneralNotes,StartDate, EndDate, Closed, LoginID, ClientMachine)
values
(@PSCID, @PSCNo, @GeneralNotes,@StartDate, @EndDate, @Closed, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertPhysicalStockCount
******************************************************************************************************/
-- select * from PhysicalStockCount
-- delete from PhysicalStockCount


-------------- Update PhysicalStockCount -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePhysicalStockCount')
	drop proc uspUpdatePhysicalStockCount
go

create proc uspUpdatePhysicalStockCount(
@PSCNo varchar(20),
@GeneralNotes Varchar(200),
@StartDate smalldatetime,
@EndDate smalldatetime,
@Closed bit,
@LoginID varchar(20),
@ClientMachine Varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PSCNo from PhysicalStockCount where PSCNo = @PSCNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PSC No', @PSCNo, 'PhysicalStockCount')
		return 1
	end

	if (@EndDate < @StartDate)
	begin
		set @ErrorMSG = 'End Date can''t be before Start Date!'
		raiserror(@ErrorMSG,16,1)	
		return 1
	end

	if (dbo.GetOptionValue('EnableMultiplePhysicalStockCountNumbers') = 0 and @Closed = 0)
	  begin 
	 if exists(select top 1 PSCNo from PhysicalStockCount where Closed = 0)
		begin
			set @ErrorMSG = 'There is already an Open Physical Count No. The System is not set allow multiple Physical Stock Count'
			raiserror(@ErrorMSG, 16, 1)
			return 1
		end
	  end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update PhysicalStockCount set
 GeneralNotes = @GeneralNotes, StartDate = @StartDate, EndDate = @EndDate, Closed = @Closed, LoginID = @LoginID, ClientMachine = @ClientMachine
where PSCNo = @PSCNo
return 0
end
go

/******************************************************************************************************
exec uspUpdatePhysicalStockCount
******************************************************************************************************/
-- select * from PhysicalStockCount
-- delete from PhysicalStockCount


-------------- Get PhysicalStockCount -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPhysicalStockCount')
	drop proc uspGetPhysicalStockCount
go

create proc uspGetPhysicalStockCount(
@PSCNo varchar(20)= null,
@StartDate smalldatetime=null,
@EndDate smalldatetime=null
)with encryption as

declare @ErrorMSG varchar(200)

if not @PSCNo=null or not @PSCNo=''
	begin
	if not exists(select PSCNo from PhysicalStockCount where PSCNo = @PSCNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'PSC No', @PSCNo, 'PhysicalStockCount')
			return 1
		end
	else

	begin
	select PSCNo, GeneralNotes, dbo.FormatDate(StartDate) as StartDate, dbo.FormatDate(EndDate) as EndDate, Closed, 
	PhysicalStockCount.LoginID as LoginID, ClientMachine, 
	dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
		from PhysicalStockCount
		where PSCNo = @PSCNo

	end
end 
else

	begin
	select PSCNo, GeneralNotes, dbo.FormatDate(StartDate) as StartDate, dbo.FormatDate(EndDate) as EndDate, Closed, 
	PhysicalStockCount.LoginID as LoginID, ClientMachine, 
	dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
		from PhysicalStockCount
		inner join Logins on PhysicalStockCount.LoginID = Logins.LoginID
		where dbo.FormatDate(RecordDateTime) between @StartDate and @EndDate
	end
return 0
go

/******************************************************************************************************
exec uspGetPhysicalStockCount'1601',null,null
******************************************************************************************************/
-- select * from PhysicalStockCount
-- delete from PhysicalStockCount


---------------------------uspGetNextPSCID--------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetNextPSCID')
	drop proc uspGetNextPSCID
go

create proc uspGetNextPSCID(
@PSCID int = null output
)with encryption as
declare @CurrentYear int
set @CurrentYear = right(year(getdate()),2)
set @PSCID = (select max(PSCID) from PhysicalStockCount where left(PSCNo, 2) = @CurrentYear)
set @PSCID = dbo.GetNextAutoNumber('PhysicalStockCount', 'PSCNo', @PSCID)

return 0

go


-------------------------------uspCloseExpiredPhysicalStockCount------------------------------------------------------
if exists (select * from sysobjects where name = 'uspCloseExpiredPhysicalStockCount')
	drop proc uspCloseExpiredPhysicalStockCount
go

create proc uspCloseExpiredPhysicalStockCount(
@EndDate smalldatetime
)
with encryption as

begin
	update PhysicalStockCount set Closed= 1 where  Closed = 0 and EndDate < @EndDate

return 0
end
go

--- exec uspCloseExpiredPhysicalStockCount 'Jun 20 2018'


-------------- Get OpenPhysicalStockCount -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetOpenPhysicalStockCount')
	drop proc uspGetOpenPhysicalStockCount
go

create proc uspGetOpenPhysicalStockCount(
@EndDate smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)



	begin
	select PSCNo, GeneralNotes, dbo.FormatDate(StartDate) as StartDate, dbo.FormatDate(EndDate) as EndDate, Closed, 
	PhysicalStockCount.LoginID as LoginID, ClientMachine, 
	dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
		from PhysicalStockCount
		inner join Logins on PhysicalStockCount.LoginID = Logins.LoginID
		where Closed  = 0 and EndDate >= @EndDate
		order by RecordDateTime desc
	end
return 0
go

/******************************************************************************************************
exec uspGetOpenPhysicalStockCount 'Jun 21 2018 10:23:48 AM'
******************************************************************************************************/
-- select * from PhysicalStockCount order by RecordDateTime desc
-- delete from PhysicalStockCount

--------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
-------------- PhysicalStockCountDetails --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PhysicalStockCountDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPhysicalStockCountDetails')
	drop proc uspInsertPhysicalStockCountDetails
go

create proc uspInsertPhysicalStockCountDetails(
@PSCNo varchar(20),
@LocationID  varchar(10),
@ItemCategoryID  varchar(10),
@ItemCode Varchar(20),
@SystemQuantity int,
@PhysicalCountQuantity int,
@Notes Varchar(200),
@LoginID Varchar(20),
@ClientMachine Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PSCNo from PhysicalStockCount where PSCNo  = @PSCNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PSC No', @PSCNo, 'PhysicalStockCount')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @LocationID )
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Location ID ', @LocationID , 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @ItemCategoryID )
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item CategoryI D ', @ItemCategoryID , 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
else
begin
	if exists(select PSCNo from PhysicalStockCountDetails where PSCNo = @PSCNo and LocationID  = @LocationID  and ItemCategoryID  = @ItemCategoryID  and ItemCode = @ItemCode)
		begin
			update PhysicalStockCountDetails set
			SystemQuantity = @SystemQuantity, PhysicalCountQuantity = @PhysicalCountQuantity,Notes=@Notes, LoginID = @LoginID, ClientMachine = @ClientMachine
			where PSCNo = @PSCNo and LocationID  = @LocationID  and ItemCategoryID  = @ItemCategoryID  and ItemCode = @ItemCode
		end

	 else
		begin
		insert into PhysicalStockCountDetails
		(PSCNo, LocationID , ItemCategoryID , ItemCode, SystemQuantity, PhysicalCountQuantity,Notes, LoginID, ClientMachine)
		values
		(@PSCNo, @LocationID , @ItemCategoryID , @ItemCode, @SystemQuantity, @PhysicalCountQuantity,@Notes, @LoginID, @ClientMachine)
	 end


return 0
end
go

/******************************************************************************************************
exec uspInsertPhysicalStockCountDetails
******************************************************************************************************/
-- select * from PhysicalStockCountDetails
-- delete from PhysicalStockCountDetails


-------------- Update PhysicalStockCountDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePhysicalStockCountDetails')
	drop proc uspUpdatePhysicalStockCountDetails
go

create proc uspUpdatePhysicalStockCountDetails(
@PSCNo varchar(20),
@LocationID  varchar(10),
@ItemCategoryID  varchar(10),
@ItemCode Varchar(20),
@SystemQuantity int,
@PhysicalCountQuantity int,
@Notes varchar(200),
@LoginID Varchar(20),
@ClientMachine Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PSCNo from PhysicalStockCount where PSCNo  = @PSCNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PSC No', @PSCNo, 'PhysicalStockCount')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @LocationID )
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Location ID ', @LocationID , 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @ItemCategoryID )
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item CategoryI D ', @ItemCategoryID , 'Lookup Data')
		return 1
	end

	if  exists(select PSCNo from PhysicalStockCount where PSCNo  = @PSCNo and Closed = 1)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter is closed and cannot be used'
		raiserror(@ErrorMSG, 16, 1, 'PSCNo', @PSCNo)
		return 1
	end


if not exists(select PSCNo from PhysicalStockCountDetails where PSCNo = @PSCNo and LocationID  = @LocationID  and ItemCategoryID  = @ItemCategoryID  and ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PSC No', @PSCNo, 'Location ID ', @LocationID , 'Item CategoryI D ', @ItemCategoryID , 'Item Code', @ItemCode, 'PhysicalStockCountDetails')
		return 1
	end



begin
update PhysicalStockCountDetails set
SystemQuantity = @SystemQuantity, PhysicalCountQuantity = @PhysicalCountQuantity,Notes=@Notes, LoginID = @LoginID, ClientMachine = @ClientMachine
where PSCNo = @PSCNo and LocationID  = @LocationID  and ItemCategoryID  = @ItemCategoryID  and ItemCode = @ItemCode
return 0
end
go

/******************************************************************************************************
exec uspUpdatePhysicalStockCountDetails
******************************************************************************************************/
-- select * from PhysicalStockCountDetails
-- delete from PhysicalStockCountDetails


-------------- Get PhysicalStockCountDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPhysicalStockCountDetails')
	drop proc uspGetPhysicalStockCountDetails
go

create proc uspGetPhysicalStockCountDetails(
@PSCNo varchar(20),
@LocationID  varchar(10)=null,
@ItemCategoryID  varchar(10)=null,
@ItemCode Varchar(20)=null
)with encryption as

declare @ErrorMSG varchar(200)

if (not @LocationID=null or not @LocationID='') and (not @ItemCategoryID= null or not @ItemCategoryID='') and (not @ItemCode=null or not @ItemCode='')
begin
if not exists(select PSCNo from PhysicalStockCountDetails where PSCNo = @PSCNo and LocationID  = @LocationID  and ItemCategoryID  = @ItemCategoryID  and ItemCode = @ItemCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PSC No', @PSCNo, 'Location ID ', @LocationID , 'Item CategoryI D ', @ItemCategoryID , 'General Notes', @ItemCode, 'PhysicalStockCountDetails')
		return 1
	end
else
begin
	select PSCNo, LocationID, dbo.GetLookupDataDes(LocationID) as Location, ItemCategoryID ,dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
	 ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName, SystemQuantity, PhysicalCountQuantity,Notes
	  LoginID, ClientMachine,RecordDateTime, 
	 dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
	from PhysicalStockCountDetails

	where PSCNo = @PSCNo and LocationID  = @LocationID  and ItemCategoryID  = @ItemCategoryID  and ItemCode = @ItemCode

end
end
else 
begin
	select PSCNo, LocationID, dbo.GetLookupDataDes(LocationID) as Location, ItemCategoryID ,dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,
	 ItemCode, dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName,SystemQuantity, PhysicalCountQuantity,Notes, (PhysicalCountQuantity-SystemQuantity) as Variance, LoginID, ClientMachine, RecordDateTime,
	 dbo.FormatDate(RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
	from PhysicalStockCountDetails

	where PSCNo = @PSCNo

end
return 0
go



/******************************************************************************************************
exec uspGetPhysicalStockCountDetails
******************************************************************************************************/
-- select * from PhysicalStockCountDetails
-- delete from PhysicalStockCountDetails

------------------------------------------------------------------------------------------------------
-------------- IPDNurse -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit IPDNurse --------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditIPDNurse')
	drop proc uspEditIPDNurse
go

create proc uspEditIPDNurse(
@RoundNo varchar(20),
@NurseRoundNo varchar(20),
@Weight decimal(5,2),
@Temperature decimal(5,2),
@Height decimal(5,2),
@Pulse tinyint,
@BloodPressure varchar(10),
@HeadCircum decimal(5,2),
@BodySurfaceArea decimal(10,2),
@RespirationRate tinyint,
@OxygenSaturation decimal(5,2),
@HeartRate tinyint,
@Notes varchar(4000),
@NurseRoundDateTime smalldatetime,
@StaffNo varchar(10),
@OtherAttendingNurse varchar(100),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

declare @IPDNurseRoundID int
declare @PaddingLEN tinyint
declare @PassedNurseRoundID int
declare @PassedNurseRoundNo varchar(20)
declare @PassedRoundNo varchar(20)

if not exists(select RoundNo from IPDDoctor where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPD Doctor')
		return 1
	end
if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

-----------------------------------------------------------------------------------
if @Weight < 0 set @Weight = null
if @Temperature < 0 set @Temperature = null
if @Height < 0 set @Height = null
if @Pulse <= 0 set @Pulse = null
if @HeadCircum < 0 set @HeadCircum = null
if @BodySurfaceArea < 0 set @BodySurfaceArea = null
if @RespirationRate <= 0 set @RespirationRate = null
if @OxygenSaturation <= 0 set @OxygenSaturation = null
if @HeartRate <= 0 set @HeartRate = null
-----------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------------

select @PaddingLEN = PaddingLEN from AutoNumbers where ObjectName = 'IPDNurse' and AutoColumnName = 'NurseRoundNo' 
		
set @PassedRoundNo = ltrim(rtrim(substring(@NurseRoundNo, 1, len(@NurseRoundNo) - @PaddingLEN)))
		
if (@PassedRoundNo = @RoundNo)

begin

	set @PassedNurseRoundID = 1
	set @PassedNurseRoundNo = @NurseRoundNo

	set @PassedNurseRoundNo = ltrim(rtrim(substring(@PassedNurseRoundNo, len(@PassedRoundNo) + 1, @PaddingLEN)))

	if isnumeric(@PassedNurseRoundNo) = 1 set @PassedNurseRoundID = @PassedNurseRoundNo
	else set @PassedNurseRoundID = 1

	set @IPDNurseRoundID = (select max(IPDNurseRoundID) from IPDNurse where RoundNo = @RoundNo)
	
	set @IPDNurseRoundID = dbo.GetNextAutoNumber('IPDNurse', 'NurseRoundNo', @IPDNurseRoundID)

	if @PassedNurseRoundID < @IPDNurseRoundID set @IPDNurseRoundID = @PassedNurseRoundID
	if @PassedNurseRoundID > @IPDNurseRoundID set @IPDNurseRoundID = @PassedNurseRoundID

end else set @IPDNurseRoundID = 1
/*-----------------------------------------------------------------------------------------------------------------------------------
print cast(dbo.GetNextAutoNumber('IPDNurse', 'IPDNurseRouundNo', '1') as varchar(20)) 
'1600006301020', '1600006301020001',
------------------------------------------------------------------------------------------------------------------------------------*/

if exists(select NurseRoundNo from IPDNurse where NurseRoundNo = @NurseRoundNo)
	begin
		update IPDNurse 
		set 
		IPDNurseRoundID = @IPDNurseRoundID, RoundNo = @RoundNo, Weight = @Weight, Temperature = @Temperature, Height = @Height, 
		Pulse = @Pulse, BloodPressure = @BloodPressure, HeadCircum = @HeadCircum, BodySurfaceArea = @BodySurfaceArea, 
		RespirationRate = @RespirationRate, OxygenSaturation = @OxygenSaturation, Notes = @Notes, HeartRate = @HeartRate,
		NurseRoundDateTime = @NurseRoundDateTime,	StaffNo = @StaffNo, OtherAttendingNurse = @OtherAttendingNurse, 
		LoginID = @LoginID, ClientMachine = @ClientMachine 
		where NurseRoundNo = @NurseRoundNo and RoundNo = @RoundNo
		return 0
	end
else
begin
insert into IPDNurse
(IPDNurseRoundID, RoundNo, NurseRoundNo, Weight, Temperature, Height, Pulse, BloodPressure, HeadCircum, BodySurfaceArea, 
RespirationRate, OxygenSaturation, HeartRate, Notes, NurseRoundDateTime, StaffNo, OtherAttendingNurse, LoginID, ClientMachine)
values
(@IPDNurseRoundID, @RoundNo, @NurseRoundNo, @Weight, @Temperature, @Height, @Pulse, @BloodPressure, @HeadCircum, @BodySurfaceArea, 
@RespirationRate, @OxygenSaturation, @HeartRate, @Notes, @NurseRoundDateTime, @StaffNo, @OtherAttendingNurse, @LoginID, @ClientMachine)
return 0
end
go


/******************************************************************************************************
select * from IPDClinicalFindings where RecordDateTime >'2016-09-01'

exec uspEditIPDNurse '1600006301020', '1600006301020003', 75, 39.02, 89.36, 75.56, '78/95', 80, null, 
								null, null, null, 'Na', '2016/09/20 16:00:01', 
								'MH/0085','na','Admin','BAURDPC'

exec uspEditIPDNurse '1600006301020', '1600006301020001', , , , , '', , , 
								'History1', 'Notes', 'Respiratory', 'General Appearance1', 'CVS1', 
								'Abdomen1','CNS1','Muscular Skeletal1', 'Psychological Status1',
								'Clinical Diagnosis1', null, '0032','Admin','BAURDPC'
select * from IPDNurse

******************************************************************************************************/
-- select * from IPDNurse
-- delete from IPDNurse

-------------- Get IPDNurse --------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDNurse')
	drop proc uspGetIPDNurse
go

create proc uspGetIPDNurse(
@NurseRoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select NurseRoundNo from IPDNurse where NurseRoundNo = @NurseRoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Nurse Round No', @NurseRoundNo, 'IPD Nurse')
		return 1
	end

begin
	select IPDNurseRoundID, NurseRoundNo, IPDNurse.RoundNo, Weight, Temperature, Height, Pulse, BloodPressure,
	HeadCircum, BodySurfaceArea, RespirationRate, OxygenSaturation, HeartRate, Notes, IPDNurse.NurseRoundDateTime,   
	dbo.GetStaffFullName(IPDNurse.StaffNo) as StaffNo, --dbo.GetStaffFullName(IPDDoctor.StaffNo) as AttendingDoctor,
	OtherAttendingNurse--, IPDDoctor.RoundDateTime as DoctorRoundDateTime
	from IPDNurse 
	--Right Outer join IPDDoctor on IPDNurse.RoundNo = IPDDoctor.RoundNo
	where NurseRoundNo = @NurseRoundNo
	
return 0
end
go

/******************************************************************************************************
exec uspGetIPDNurse '1600006301020001'

******************************************************************************************************/
-- select * from IPDNurse
-- delete from IPDNurse

--------GetNextIPDNurseRoundID -----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextIPDNurseRoundID')
	drop proc uspGetNextIPDNurseRoundID
go

create proc uspGetNextIPDNurseRoundID(
@RoundNo varchar(20),
@IPDNurseRoundID int = null output
)with encryption as

set @IPDNurseRoundID = (select max(IPDNurseRoundID) from IPDNurse where RoundNo = @RoundNo)
set @IPDNurseRoundID = dbo.GetNextAutoNumber('IPDNurse', 'NurseRoundNo', @IPDNurseRoundID)


return 0

go

-- exec uspGetNextFollowUpID '08022077'
-- select * from Visits where PatientNo = '08022077'

------------------------------------------------------------------------------------------------------


--------GetNurseRoundNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNurseRoundNo')
	drop proc uspGetNurseRoundNo
go

create proc uspGetNurseRoundNo(
@AdmissionNo varchar(20),
@RoundDateTime smalldatetime = null output,
@NurseRoundNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200) 

if (@RoundDateTime is null)
begin
	if not exists(select AdmissionNo from IPDDoctor where AdmissionNo = @AdmissionNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG,16,1, 'Admission No', @AdmissionNo, 'IPD Doctor')	
		return 1
	end
	else
	begin
		set @NurseRoundNo =(select Top 1 NurseRoundNo from IPDNurse where RoundNo = (select top 1 RoundNo from IPDDoctor 
						where AdmissionNo = @AdmissionNo and RoundDateTime = (select max(RoundDateTime) from IPDDoctor 
						where AdmissionNo = @AdmissionNo) order by RoundID asc)order by NurseRoundNo desc)
	end
end
else
if not (@RoundDateTime is null)
begin

if not exists(select AdmissionNo from IPDDoctor where AdmissionNo = @AdmissionNo and RoundDateTime = @RoundDateTime)
	begin
		set @ErrorMSG = '%s: %s and %s: ' + dbo.FormatDateTime(@RoundDateTime) + ', you are trying to enter does not exist %s'
		raiserror(@ErrorMSG,16,1, 'The record with Admission No', @AdmissionNo, 'Round Date Time', 'in the registered IPDDoctor')	
		return 1		
	end
	else
	begin
		set @NurseRoundNo =(select Top 1 NurseRoundNo from IPDNurse where RoundNo = (select top 1 RoundNo from IPDDoctor where
							AdmissionNo = @AdmissionNo	and RoundDateTime = @RoundDateTime order by RoundID asc)order by NurseRoundNo desc)
		
	end
end

return 0

go

-- select * from Admissions
-- select * from IPDDoctor
-- select * from IPDNurse 1600006301019
-- exec  uspGetNurseRoundNo '1600006301' 
-- exec uspGetNurseRoundNo '110226501', '22 Feb 2011 09:53:00'
-- print cast(exec clinicMaster.dbo.uspGetNurseRoundNo '1600006301' as varchar(20)) 


--------GetIPDNurseByRoundNo------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDNurseByRoundNo')
	drop proc uspGetIPDNurseByRoundNo
go

create proc uspGetIPDNurseByRoundNo(
@RoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDNurse where RoundNo = @RoundNo)
begin
	set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
	raiserror(@ErrorMSG,16,1, 'Round No', @RoundNo, 'IPD Nurse')	
	return 1
end
else
begin
	select RecordDateTime, NurseRoundNo, RoundNo from IPDNurse
	where RoundNo = @RoundNo order by RecordDateTime, IPDNurseRoundID, NurseRoundNo
end
return 0
go

-- select * from IPDNurse
-- exec uspGetIPDNurseByRoundNo '1600006301020'


--------GetIPDItemsByRoundNo----------------------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetIPDItemsByRoundNo')
	drop proc uspGetIPDItemsByRoundNo
go

create proc uspGetIPDItemsByRoundNo(
@RoundNo varchar(20),
@ItemCategoryID varchar(10)
)with encryption as
declare @ErrorMSG varchar(200)
declare @OfferedItemStatusID varchar(10)

--------------------------------------------------------------------------------------------------
 set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')
--------------------------------------------------------------------------------------------------


if not exists(select RoundNo from IPDDoctor where RoundNo  = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'RoundNo', @RoundNo, 'IPDDoctor Rounds')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'Lookup Data')
		return 1
	end

begin

	select  IPDItems.RoundNo, IPDItems.ItemCode, Quantity, 
		UnitPrice, Quantity * UnitPrice as Amount, ItemDetails, 
		IPDItems.ItemCategoryID, dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, 
		ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
		PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
		LocationID, dbo.GetLookupDataDes(LocationID) as FromLocation, ItemName,
		dbo.GetUnitMeasure(IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitMeasure, Dosage, Duration,
		dbo.GetMergedNameCode(IPDItems.ItemName, IPDItems.ItemCode) as ItemFullName, 
		ItemDetails from IPDItems
		left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
		and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
		where IPDItems.RoundNo = @RoundNo and IPDItems.ItemCategoryID = @ItemCategoryID and ItemStatusID = @OfferedItemStatusID
	end
return 0
go

--select * from IPDItems where roundno = '1600006301020'
--select * from IPDItemsExt where roundno = '1600006301020'
-- select top 1000 * from Visits
-- exec uspGetIPDItemsByRoundNo '1600006301019'
-- exec uspGetIPDItemsByRoundNo '1600006301020','7c'
-- exec uspGetIPDItemsByRoundNo '130015001001', '7c'



------------------------------------------------------------------------------------------------------
---------------------------------- IPDDrugAdministration ---------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit IPDDrugAdministration -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditIPDDrugAdministration')
	drop proc uspEditIPDDrugAdministration
go

create proc uspEditIPDDrugAdministration(
@NurseRoundNo varchar(20),
--@DoctorRoundNo varchar(20),
@TakenDateTime smalldatetime,
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ItemName varchar(800),
@QuantityTaken int,
@StaffNo varchar(10),
@NurseNotes varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
--@RecordDateTime smalldatetime

)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select NurseRoundNo from IPDNurse where NurseRoundNo  = @NurseRoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'NurseRoundNo', @NurseRoundNo, 'IPDNurse')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'Lookup Data')
		return 1
	end


if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
	
if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Drug Administrator', @StaffNo, 'Staff')
		return 1
	end


begin
if exists(select NurseRoundNo from IPDDrugAdministration where NurseRoundNo = @NurseRoundNo and TakenDateTime = @TakenDateTime and ItemCode=@ItemCode )
	begin
		update IPDDrugAdministration set
		TakenDateTime = @TakenDateTime, ItemCode = @ItemCode, ItemCategoryID = @ItemCategoryID, ItemName = @ItemName,
		QuantityTaken = @QuantityTaken, StaffNo = @StaffNo, NurseNotes=@NurseNotes,	LoginID = @LoginID, ClientMachine = @ClientMachine
		where NurseRoundNo = @NurseRoundNo
		return 0
	end
else
	Begin
		insert into IPDDrugAdministration
		(NurseRoundNo, TakenDateTime, ItemCode, ItemCategoryID, ItemName, QuantityTaken, StaffNo, NurseNotes, LoginID, ClientMachine)
		values
		(@NurseRoundNo, @TakenDateTime, @ItemCode, @ItemCategoryID, @ItemName, @QuantityTaken, @StaffNo,@NurseNotes, @LoginID, @ClientMachine)
		return 0
	End
end
go

/******************************************************************************************************
exec uspEditIPDDrugAdministration '1600006301020003','2016/09/20 16:00:01','M0017','7D','M0017->M0017','8','MH/0085','Na','Admin','Baurd-Pc'
******************************************************************************************************/
-- select * from IPDDrugAdministration
-- delete from IPDDrugAdministration





-------------- Get IPDDrugAdministration -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDDrugAdministration')
	drop proc uspGetIPDDrugAdministration
go

create proc uspGetIPDDrugAdministration(
@NurseRoundNo varchar(20),
@ItemCategoryID varchar(10)=null
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select NurseRoundNo, TakenDateTime, ItemCode, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as [Item Category], ItemName,
	QuantityTaken,NurseNotes,dbo.GetStaffName(StaffNo) as StaffName,IPDDrugAdministration.LoginID, ClientMachine, RecordDateTime
	from IPDDrugAdministration
	where NurseRoundNo = @NurseRoundNo and ItemCategoryID = @ItemCategoryID  order by RecordDateTime desc
return 0
end
go

--------------------------------------GetSumIPDDrugsAdministered-----------------------------------
if exists (select * from sysobjects where name = 'uspGetSumIPDDrugsAdministered')
	drop proc uspGetSumIPDDrugsAdministered
go

create proc uspGetSumIPDDrugsAdministered(
@RoundNo varchar(20) = null,
@ItemCode varchar(20)=null,
@ItemCategoryID varchar(10)=null
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select sum(QuantityTaken) as TotalGivenAmount from IPDNurse
	right outer join IPDDrugAdministration on IPDNurse.NurseRoundNo = IPDDrugAdministration.NurseRoundNo
	where RoundNo = @RoundNo and ItemCode =@ItemCode and ItemCategoryID=@ItemCategoryID
return 0
end
go

-- uspGetSumIPDDrugsAdministered '1600006301020','M0017', '7D'

----------------------GetIPDDrugAdministrationPerRound--------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDDrugAdministrationPerRound')
	drop proc uspGetIPDDrugAdministrationPerRound
go

create proc uspGetIPDDrugAdministrationPerRound(
@RoundNo varchar(20) = null,
@ItemCategoryID varchar(10) = null,
@ItemCode varchar(20) = null
)with encryption as
declare @ErrorMSG varchar(200)
declare @DrugItemCategoryID varchar(20)
declare @ConsumableItemCategoryID varchar(20)

set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')

if not (@RoundNo is null) 
begin
	if not exists(select RoundNo from IPDDoctor where RoundNo = @RoundNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPDDoctor Rounds')
			return 1
		end
end
 
if not (@RoundNo is null) and not (@ItemCategoryID is null) and not (@ItemCode is null)
	begin
	if @ItemCategoryID = @DrugItemCategoryID
		begin
		 select dbo.GetItemName(IPDItemsEXT.ItemCategoryID, IPDItemsEXT.ItemCode) as ItemName,Dosage,Duration,DrQuantity,Quantity,ItemDetails,
		 dbo.GetLookupDataDes(PayStatusID) as PayStatus,UnitCost,UnitPrice,dbo.GetUnitMeasure(IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitMeasure,
		 LocationID, dbo.GetLookupDataDes(LocationID) as FromLocation, 
		 dbo.GetLookupDataDes(ItemStatusID) as ItemStatus
		  from IPDItemsEXT
		 left outer join IPDItems on IPDItemsEXT. RoundNo =IPDItems.RoundNo and  IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
		 where IPDItemsEXT.RoundNo =@RoundNo and IPDItems.ItemCategoryID =@ItemCategoryID and IPDItems.ItemCode= @ItemCode	
		End
	if @ItemCategoryID = @ConsumableItemCategoryID
		begin
		 select dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode) as ItemName,Quantity,ItemDetails,
		 dbo.GetLookupDataDes(PayStatusID) as PayStatus,UnitCost,UnitPrice,dbo.GetUnitMeasure(IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitMeasure,
		 dbo.GetLookupDataDes(ItemStatusID) as ItemStatus from IPDItems
		 where IPDItems.RoundNo =@RoundNo and IPDItems.ItemCategoryID =@ConsumableItemCategoryID and IPDItems.ItemCode= @ItemCode
		end
return 0
end
go

/******************************************************************************************************
exec uspGetIPDDrugAdministration

uspGetIPDDrugAdministrationPerRound '1600006301020','7D','M0017'
uspGetIPDDrugAdministrationPerRound '1600006301020','7C','C057'

******************************************************************************************************/
-- select * from IPDDrugAdministration
-- delete from IPDDrugAdministration


if exists (select * from sysobjects where name = 'uspGetDrugsAdministedPerAdmission')
	drop proc uspGetDrugsAdministedPerAdmission
go

create proc uspGetDrugsAdministedPerAdmission(
@AdmissionNo varchar(20) = null,
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @DrugItemCategoryID varchar(20)
declare @ConsumableItemCategoryID varchar(20)
declare @InWardAdmissionStatusID varchar(10)
declare @OfferedItemStatusID varchar(10)


set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')
set @InWardAdmissionStatusID = dbo.GetLookupDataID('AdmissionStatus', 'I')
set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')


if not (@AdmissionNo is null)
begin
	if not exists(select * from Admissions where AdmissionNo = @AdmissionNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Admission No', @AdmissionNo, 'Admissions')
			return 1
		end
end
 
if not (@AdmissionNo is null) and not (@ItemCategoryID is null)
begin
	if (@ItemCategoryID = @DrugItemCategoryID)
	begin
			select  IPDItems.RoundNo, IPDItems.ItemCode, IPDItems.ItemCategoryID as ItemCategoryID, 
			dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, 
			dbo.GetMergedNameCode(dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode), IPDItems.ItemCode) as ItemFullName ,
			IPDItems.ItemDetails as Notes, Quantity, dbo.GetAdministeredIPDDrugs(IPDItems.RoundNo, IPDItems.ItemCategoryID, IPDItems.ItemCode) as QuantityTaken, 
			(Quantity - dbo.GetAdministeredIPDDrugs(IPDItems.RoundNo, IPDItems.ItemCategoryID, IPDItems.ItemCode)) as Balance,
			Dosage, Duration, dbo.GetUnitMeasure(IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitMeasure,
			dbo.GetLookupDataDes(IPDItemsExt.LocationID) as Location
			from IPDDoctor
			inner join IPDItems on IPDItems.RoundNo = IPDDoctor.RoundNo 
			inner join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
			left outer join Admissions on IPDdoctor.AdmissionNo = Admissions.AdmissionNo
			where IPDdoctor.AdmissionNo = @AdmissionNo and IPDItems.ItemCategoryID = @DrugItemCategoryID
			and Admissions.AdmissionStatusID = @InWardAdmissionStatusID
			and IPDItems.ItemStatusID = @OfferedItemStatusID
			order by IPDItems.RoundNo asc	
	end
		else if(@ItemCategoryID = @ConsumableItemCategoryID)
		begin 
			select  IPDItems.RoundNo, IPDItems.ItemCode, IPDItems.ItemCategoryID as ItemCategoryID, 
			dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, 
			dbo.GetMergedNameCode(dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode), IPDItems.ItemCode) as ItemFullName ,
			IPDItems.ItemDetails, Quantity, dbo.GetAdministeredIPDDrugs(IPDItems.RoundNo, IPDItems.ItemCategoryID, IPDItems.ItemCode) as QuantityTaken, 
			(Quantity - dbo.GetAdministeredIPDDrugs(IPDItems.RoundNo, IPDItems.ItemCategoryID, IPDItems.ItemCode)) as Balance,
			dbo.GetUnitMeasure(IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitMeasure
			from IPDDoctor
			inner join IPDItems on IPDItems.RoundNo = IPDDoctor.RoundNo 
			left outer join Admissions on IPDdoctor.AdmissionNo = Admissions.AdmissionNo
			where IPDdoctor.AdmissionNo = @AdmissionNo and IPDItems.ItemCategoryID = @ConsumableItemCategoryID
			and Admissions.AdmissionStatusID = @InWardAdmissionStatusID
			and IPDItems.ItemStatusID = @OfferedItemStatusID
			order by IPDItems.RoundNo asc
		end
 return 0
end
go

/******************************************************************************************************
exec uspGetDrugsAdministedPerAdmission '1600006301','7D'
exec uspGetDrugsAdministedPerAdmission '130015001','7c'
exec uspGetDrugsAdministedPerAdmission '1600006301','7c'
******************************************************************************************************/
-- select * from IPDDrugAdministration
-- delete from IPDDrugAdministration


-------------- Edit IPDNurseFluids -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditIPDNurseFluids')
	drop proc uspEditIPDNurseFluids
go

create proc uspEditIPDNurseFluids(
@NurseRoundNo varchar(20),
@TakenDateTime smalldatetime,
@FluidTypeID varchar(10),
@FluidCategoryID varchar(10),
@RouteID varchar(10),
@Quantity int,
@NurseNotes varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select NurseRoundNo from IPDNurse where NurseRoundNo  = @NurseRoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'NurseRoundNo', @NurseRoundNo, 'IPDNurse')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @FluidTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Fluid Type ID', @FluidTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @FluidCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Fluid Category ID', @FluidCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @RouteID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Route', @RouteID, 'Lookup Data')
		return 1
	end
	
if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
	

begin
if exists(select NurseRoundNo from IPDNurseFluids where NurseRoundNo = @NurseRoundNo  and FluidTypeID = @FluidTypeID
and FluidCategoryID = @FluidCategoryID )
	begin
		update IPDNurseFluids set
		TakenDateTime = @TakenDateTime, FluidTypeID = @FluidTypeID, FluidCategoryID = @FluidCategoryID, 
		RouteID = @RouteID,	Quantity = @Quantity, NurseNotes=@NurseNotes,	
		LoginID = @LoginID, ClientMachine = @ClientMachine
		where NurseRoundNo = @NurseRoundNo and FluidTypeID = @FluidTypeID and FluidCategoryID = @FluidCategoryID --and TakenDateTime = @TakenDateTime
		return 0
	end
else
	Begin
		insert into IPDNurseFluids
		(NurseRoundNo, TakenDateTime, FluidTypeID, FluidCategoryID, RouteID, Quantity, NurseNotes, LoginID, ClientMachine)
		values
		(@NurseRoundNo, @TakenDateTime, @FluidTypeID, @FluidCategoryID, @RouteID, @Quantity, @NurseNotes, @LoginID, @ClientMachine)
		return 0
	End
end
go

/******************************************************************************************************
exec uspEditIPDNurseFluids '1600006301020003','2016/09/20 16:00:01','M0017','7D','M0017->M0017','8','MH/0085','Na','Admin','Baurd-Pc'
******************************************************************************************************/
-- select * from IPDNurseFluids
-- delete from IPDNurseFluids


-------------- Get IPDNurseFluids -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDNurseFluids')
	drop proc uspGetIPDNurseFluids
go

create proc uspGetIPDNurseFluids(
@NurseRoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select NurseRoundNo, TakenDateTime, FluidTypeID, dbo.GetLookupDataDes(FluidTypeID) as FluidType, FluidCategoryID, dbo.GetLookupDataDes(FluidCategoryID) as FluidCategory, RouteID,
	dbo.GetLookupDataDes(RouteID) as Route, RouteID as FluidRouteID, Quantity, NurseNotes, LoginID, ClientMachine, RecordDateTime
	from IPDNurseFluids
	where NurseRoundNo = @NurseRoundNo  order by RecordDateTime desc
return 0
end
go
/*****************************************************************************************
select * from IPDNurseFluids dbo.GetLookupDataDes(FluidType)
exec uspGetIPDNurseFluids '1600006301020008'
******************************************************************************************/



-------------- Get Categorized IPDNurseFluids -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCategorizedIPDNurseFluids')
	drop proc uspGetCategorizedIPDNurseFluids
go

create proc uspGetCategorizedIPDNurseFluids(
@RoundNo varchar(20),
@FluidCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select IPDNurseFluids.NurseRoundNo, TakenDateTime, FluidTypeID, dbo.GetLookupDataDes(FluidTypeID) as FluidType, FluidCategoryID, dbo.GetLookupDataDes(FluidCategoryID) as FluidCategory, RouteID,
	dbo.GetLookupDataDes(RouteID) as Route,	Quantity, NurseNotes, IPDNurseFluids.LoginID, IPDNurseFluids.ClientMachine, IPDNurseFluids.RecordDateTime
	from IPDNurseFluids
	inner join IPDNurse on IPDNurse.nurseRoundNo = IPDNurseFluids.NurseRoundNo
	where IPDNurse.RoundNo = @RoundNo and FluidCategoryID = @FluidCategoryID order by IPDNurseFluids.RecordDateTime desc
return 0
end
go
/*****************************************************************************************
select * from IPDNurseFluids
select * from IPDNurse
******************************************************************************************/


-------------- Get  IPDNurseFluidsBalances -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDNurseFluidsBalances')
	drop proc uspGetIPDNurseFluidsBalances
go

create proc uspGetIPDNurseFluidsBalances(
@RoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select  FluidTypeID, dbo.GetLookupDataDes(FluidTypeID) as FluidType, FluidCategoryID, dbo.GetLookupDataDes(FluidCategoryID) as FluidCategory, 
	Quantity
	from IPDNurseFluids
	inner join IPDNurse on IPDNurse.nurseRoundNo = IPDNurseFluids.NurseRoundNo
	where IPDNurse.RoundNo = @RoundNo  order by IPDNurseFluids.RecordDateTime desc
return 0
end
go
/*****************************************************************************************
select * from IPDNurseFluids
select * from IPDNurse
exec uspGetIPDNurseFluidsBalances '1600006301020'
******************************************************************************************/


	
-------------- Get  IPDNurseFluidsBalanceInputOutputTotals -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDNurseFluidsBalanceInputOutputTotals')
	drop proc uspGetIPDNurseFluidsBalanceInputOutputTotals
go

create proc uspGetIPDNurseFluidsBalanceInputOutputTotals(
@RoundNo varchar(20)
)with encryption as

	declare @InputFluidCategoryID varchar(10)
	declare @OutputFluidCategoryID varchar(10)
	declare @ErrorMSG varchar(200)

	set @InputFluidCategoryID = dbo.GetLookupDataID('FluidCategoryID', 'IN')
	set @OutputFluidCategoryID = dbo.GetLookupDataID('FluidCategoryID', 'OUT')

begin
	select  IPDNurse.RoundNo,FluidTypeID, dbo.GetLookupDataDes(FluidTypeID) as FluidType, 
	dbo.GetIPDNurseFluidsINputTotal(IPDNurse.RoundNo, FluidTypeID, @InputFluidCategoryID) as 'QuantityIN',
	dbo.GetIPDNurseFluidsINputTotal(IPDNurse.RoundNo, FluidTypeID, @OutputFluidCategoryID) as 'QuantityOUT',
	(dbo.GetIPDNurseFluidsINputTotal(IPDNurse.RoundNo, FluidTypeID, @InputFluidCategoryID)  -
	dbo.GetIPDNurseFluidsINputTotal(IPDNurse.RoundNo, FluidTypeID, @OutputFluidCategoryID))as Bal
	from IPDNurseFluids
	inner join IPDNurse on IPDNurse.nurseRoundNo = IPDNurseFluids.NurseRoundNo
	where IPDNurse.RoundNo = @RoundNo
	group by IPDNurseFluids.FluidTypeID,  IPDNurse.RoundNo

return 0
end
go
/*****************************************************************************************
select * from IPDNurseFluids
select * from IPDNurse
exec uspGetIPDNurseFluidsBalanceInputOutputTotals '1600006301020'
******************************************************************************************/


-------------- Get  FluidInTakeRouteItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetFluidInTakeRouteItems')
	drop proc uspGetFluidInTakeRouteItems
go

create proc uspGetFluidInTakeRouteItems
with encryption as
declare @ErrorMSG varchar(200)

begin
select dbo.GetMergedNameCode(DataDes, DataID) as ItemFullName,* from LookupData 
left outer join LookupObjects on LookupObjects.ObjectID = LookupData.ObjectID
where LookupData.ObjectID='182'
return 0
end
go
/*****************************************************************************************
exec uspGetFluidInTakeRouteItems 
******************************************************************************************/

-------------- Get  FluidOutPutRouteItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetFluidOutPutRouteItems')
	drop proc uspGetFluidOutPutRouteItems
go

create proc uspGetFluidOutPutRouteItems
with encryption as
declare @ErrorMSG varchar(200)

begin
select dbo.GetMergedNameCode(DataDes, DataID) as ItemFullName, 
* from LookupData
left outer join LookupObjects on LookupObjects.ObjectID = LookupData.ObjectID
 where LookupData.ObjectID='183'

return 0
end
go
/*****************************************************************************************
exec uspGetFluidOutPutRouteItems 
******************************************************************************************/


-------------- GetToCountFluidInBalances -------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetToCountFluidInBalances')
	drop proc uspGetToCountFluidInBalances
go

create proc uspGetToCountFluidInBalances
with encryption as
	declare @InputFluidCategoryID varchar(10)
	declare @OutputFluidCategoryID varchar(10)
	declare @InWardAdmissionStatusID varchar(10)
	declare @ErrorMSG varchar(200)

	
	set @InWardAdmissionStatusID = dbo.GetLookupDataID('AdmissionStatus', 'I')
	set @InputFluidCategoryID = dbo.GetLookupDataID('FluidCategoryID', 'IN')
	set @OutputFluidCategoryID = dbo.GetLookupDataID('FluidCategoryID', 'OUT')
	
begin
			select  dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
					dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
					dbo.FormatText(Admissions.AdmissionNo, 'Admissions', 'AdmissionNo') as AdmissionNo, 
					dbo.FormatText(IPDDoctor.RoundNo, 'Rounds', 'RoundNo') as RoundNo,
					dbo.GetLookupDataDes(WardsID) as Ward, Admissions.BedNo, BedName, 
					Beds.RoomNo, RoomName, dbo.FormatDateTime(AdmissionDateTime) as AdmissionDateTime,
					dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
 					dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age,
					dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
					dbo.FormatDate(VisitDate) as VisitDate,
					dbo.GetIPDNurseFluidsINputTotal(IPDNurse.RoundNo, FluidTypeID, @InputFluidCategoryID) as 'QuantityIN',
					dbo.GetIPDNurseFluidsINputTotal(IPDNurse.RoundNo, FluidTypeID, @OutputFluidCategoryID) as 'QuantityOUT'
				
				from Admissions
				inner join Beds on Admissions.BedNo = Beds.BedNo
				inner join Rooms on Beds.RoomNo = Rooms.RoomNo
				inner join Visits on Admissions.VisitNo = Visits.VisitNo	
				inner join Patients on Visits.PatientNo = Patients.PatientNo
				inner join IPDDoctor on Admissions.AdmissionNo = IPDDoctor.AdmissionNo
				inner join IPDNurse on IPDDoctor.RoundNo = IPDNurse.RoundNo
				inner join IPDNurseFluids on IPDNurse.NurseRoundNo = IPDNurseFluids.NurseRoundNo
				where AdmissionStatusID = @InWardAdmissionStatusID 
				and ((dbo.GetIPDNurseFluidsINputTotal(IPDNurse.RoundNo, FluidTypeID, @OutputFluidCategoryID)  = dbo.GetIPDNurseFluidsINputTotal(IPDNurse.RoundNo, FluidTypeID, @InputFluidCategoryID)) or 
				(dbo.GetIPDNurseFluidsINputTotal(IPDNurse.RoundNo, FluidTypeID, @OutputFluidCategoryID)  > dbo.GetIPDNurseFluidsINputTotal(IPDNurse.RoundNo, FluidTypeID, @InputFluidCategoryID)))
				order by VisitDate, AdmissionDateTime
	return 0
end
go
/*****************************************************************************************
exec uspGetToCountFluidInBalances 
******************************************************************************************/

-------------- Get UnAttendedInWardAdmissions -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetUnAttendedInWardAdmissions')
	drop proc uspGetUnAttendedInWardAdmissions
go

create proc uspGetUnAttendedInWardAdmissions(
@IpdNurseAlertDays integer
)with encryption as

declare @StartDate datetime
declare @EndDate datetime
declare @InWardAdmissionStatusID varchar(10)
declare @OfferedItemStatusID varchar(10)

--------------------------------------------------------------------------------------------------
set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')
set @InWardAdmissionStatusID = dbo.GetLookupDataID('AdmissionStatus', 'I')
set @StartDate = GETDATE()- @IpdNurseAlertDays
set @EndDate = GETDATE()
--------------------------------------------------------------------------------------------------


begin
	select 	distinct dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
			dbo.FormatText(Admissions.AdmissionNo, 'Admissions', 'AdmissionNo') as AdmissionNo, 
			dbo.GetLookupDataDes(WardsID) as Ward, Admissions.BedNo, BedName, 
			Beds.RoomNo, RoomName, dbo.FormatDateTime(AdmissionDateTime) as AdmissionDateTime,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.FormatDate(VisitDate) as VisitDate			
	from Admissions
	inner join Beds on Admissions.BedNo = Beds.BedNo
	inner join Rooms on Beds.RoomNo = Rooms.RoomNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo	
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	inner join IPDDoctor on Admissions.AdmissionNo =IPDDoctor.AdmissionNo
	inner join IPDItems on IPDItems.RoundNo = IPDDoctor.RoundNo 
	inner join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
	left  join IPDNurse on IPDDoctor.RoundNo = IPDNurse.RoundNo
	where AdmissionStatusID = @InWardAdmissionStatusID 
	and AdmissionDateTime between @StartDate and @EndDate
	and (Quantity - dbo.GetAdministeredIPDDrugs(IPDItems.RoundNo, IPDItems.ItemCategoryID, IPDItems.ItemCode)) > 0
	and ipdItems.ItemStatusID = @OfferedItemStatusID
	order by PatientNo, VisitDate, AdmissionDateTime
	end
		
return 0
go

/******************************************************************************************************
exec uspGetUnAttendedInWardAdmissions '360'
exec uspGetUnAttendedInWardAdmissions '290'
******************************************************************************************************/

------------------------------------------------------------------------------------------------------
-------------- BankAccounts --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------


-------------- Insert BankAccounts -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertBankAccounts')
	drop proc uspInsertBankAccounts
go

create proc uspInsertBankAccounts(
@AccountNo Varchar(20),
@AccountName Varchar(40),
@BankNameID Varchar(10),
@CurrencyID Varchar(10),
@LoginID Varchar(20),
@ClientMachine Varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @BankName varchar(200)
set @BankName=dbo.GetLookUpDataDes(@BankNameID)
if exists(select AccountNo from BankAccounts where AccountNo = @AccountNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Account No', @AccountNo)
		return 1
	end
if exists(select AccountName from BankAccounts where BankNameID  = @BankNameID and AccountName=@AccountName)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter already exists in the %s bank'
		raiserror(@ErrorMSG, 16, 1, 'Account Name', @AccountName, @BankName)
		return 1
	end


if not exists(select DataID from LookUpData where DataID = @BankNameID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bank Name', @BankNameID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @CurrencyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrencyID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end


begin
insert into BankAccounts
(AccountNo, AccountName, BankNameID, CurrencyID, LoginID, ClientMachine)
values
(@AccountNo, @AccountName, @BankNameID, @CurrencyID, @LoginID, @ClientMachine)


return 0
end
go

/******************************************************************************************************
exec uspInsertBankAccounts
******************************************************************************************************/
-- select * from BankAccounts
-- delete from BankAccounts


-------------- Update BankAccounts -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateBankAccounts')
	drop proc uspUpdateBankAccounts
go

create proc uspUpdateBankAccounts(
@AccountNo Varchar(20),
@AccountName Varchar(40),
@BankNameID Varchar(10),
@CurrencyID Varchar(10),
@LoginID Varchar(20),
@ClientMachine Varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @BankName varchar(20)

set @BankName= dbo.GetLookupDataDes(@BankNameID)
if not exists(select AccountNo from BankAccounts where AccountNo = @AccountNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account No', @AccountNo, 'BankAccounts')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @BankNameID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bank Name', @BankNameID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @CurrencyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrencyID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update BankAccounts set
AccountName = @AccountName, BankNameID = @BankNameID, CurrencyID = @CurrencyID, LoginID = @LoginID, 
ClientMachine = @ClientMachine
where AccountNo = @AccountNo

return 0
end
go

/******************************************************************************************************
exec uspUpdateBankAccounts
******************************************************************************************************/
-- select * from BankAccounts
-- delete from BankAccounts



-------------- Get BankAccounts -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBankAccounts')
	drop proc uspGetBankAccounts
go

create proc uspGetBankAccounts(
@AccountNo Varchar(20)=null,
@BankNameID Varchar(20)=null,
@AccountName Varchar(40)=null
)with encryption as

declare @ErrorMSG varchar(200)


if not @AccountNo is null
begin
	if not exists(select AccountNo from BankAccounts where AccountNo = @AccountNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Account No', @AccountNo, 'BankAccounts')
			return 1
		end
	else 
	   begin
		select AccountNo, AccountName, BankNameID, dbo.GetLookupDataDes(BankNameID) as BankName,
		dbo.GetCurrentBankBalance(AccountNo) as Balance,dbo.GetCurrentBankBalance (AccountNo) as Balance, CurrencyID, 
			dbo.GetLookupDataDes(CurrencyID) as Currency, BankAccounts.LoginID, BankAccounts.ClientMachine, BankAccounts.RecordDateTime
			from BankAccounts
			where AccountNo = @AccountNo

	
		end

end

else
begin
  if not @BankNameID is null and not @AccountName is null
	 begin
		select AccountNo, AccountName, BankNameID, dbo.GetLookupDataDes(BankNameID) as BankName,
        dbo.GetCurrentBankBalance (AccountNo) as Balance,dbo.GetCurrentBankBalance (AccountNo) as Balance,
		 CurrencyID, dbo.GetLookupDataDes(CurrencyID) as Currency, 
		BankAccounts.LoginID, BankAccounts.ClientMachine, BankAccounts.RecordDateTime
		from BankAccounts
		where BankNameID = @BankNameID and AccountName=@AccountName

	end

	else if  (@AccountName is null ) and not (@BankNameID is null)
	 begin
		select AccountNo, AccountName, BankNameID, dbo.GetLookupDataDes(BankNameID) as BankName,
		dbo.GetCurrentBankBalance (AccountNo) as Balance, dbo.GetCurrentBankBalance (AccountNo) as Balance,
		CurrencyID, dbo.GetLookupDataDes(CurrencyID) as Currency, BankAccounts.LoginID, BankAccounts.ClientMachine, BankAccounts.RecordDateTime
		from BankAccounts
		where BankNameID = @BankNameID

	end
	
 else
	 begin
	   select AccountNo, AccountName, BankNameID, dbo.GetLookupDataDes(BankNameID) as BankName,
	   dbo.GetCurrentBankBalance (AccountNo) as Balance,
	   dbo.GetCurrentBankBalance (AccountNo) as Balance, CurrencyID, 
	   dbo.GetLookupDataDes(CurrencyID) as Currency, BankAccounts.LoginID, BankAccounts.ClientMachine, BankAccounts.RecordDateTime
	   from BankAccounts
	end
end

return 0
go

/******************************************************************************************************
exec uspGetBankAccounts '4667896556'
exec uspGetBankAccounts null, '178001'
exec uspGetBankAccounts null,'178001','ClinicMaster Shillings'

******************************************************************************************************/

/******************************************************************************************************
exec uspGetBankAccounts '4667896556'
exec uspGetBankAccounts null, '178001'
exec uspGetBankAccounts null,'178001','ClinicMaster Shillings'

******************************************************************************************************/
------------------------------------------------------------------------------------------------------
-------------- BankingRegister --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------


-------------- Insert BankingRegister -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertBankingRegister')
	drop proc uspInsertBankingRegister
go

create proc uspInsertBankingRegister(
@RegisterNo Varchar(20),
@CollectionStartDate smalldatetime,
@CollectionEndDate smalldatetime,
@BankingDate smalldatetime,
@CollectionSourceTypeID Varchar(10),
@BankNameID Varchar(10),
@AccountName Varchar(20),
@AccountNo Varchar(20),
@AmountCollected money,
@AmountBanked money,
@AmountInWords Varchar(800),
@CurrencyID Varchar(10),
@ExchangeRate money,
@BankedBy Varchar(40),
@LoginID Varchar(20),
@ClientMachine Varchar(40),
@RecordDateTime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)
declare @RegisterID int
if exists(select RegisterNo from BankingRegister where RegisterNo = @RegisterNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Register No', @RegisterNo)
		return 1
	end

	--if exists(select RegisterNo from BankingRegister where CollectionSourceTypeID=@CollectionSourceTypeID and  @CollectionStartDate  between  CollectionStartDate and CollectionEndDate 
	--or CollectionStartDate=@CollectionStartDate or CollectionEndDate=@CollectionStartDate) 
	--begin
	--	set @ErrorMSG = 'Entered Collections for the Start Date is already registered !'
	--	raiserror(@ErrorMSG,16,1)	
	--	return 1
	--end

	--if exists(select RegisterNo from BankingRegister where CollectionSourceTypeID=@CollectionSourceTypeID and   @CollectionEndDate  between CollectionStartDate and CollectionEndDate
	--or CollectionStartDate=@CollectionEndDate or CollectionEndDate=@CollectionEndDate) 
	--begin
	--	set @ErrorMSG = 'Entered Collections for the End Date is already registered !'
	--	raiserror(@ErrorMSG,16,1)	
	--	return 1
	--end

	
if not exists(select DataID from LookupData where DataID = @BankNameID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bank Name', @BankNameID, 'Lookup Data')
		return 1
	end

if not exists(select AccountNo from BankAccounts where AccountNo  = @AccountNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account No', @AccountNo, 'BankAccounts')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CurrencyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrencyID, 'Lookup Data')
		return 1
	end

	--if not exists(select DataID from LookupData where DataID = @CollectionSourceTypeID)
	--begin
	--	set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
	--	raiserror(@ErrorMSG, 16, 1, 'Collection Source Type', @CollectionSourceTypeID, 'Lookup Data')
	--	return 1
	--end



if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
set @RegisterID= (select max(RegisterID) from BankingRegister)
set @RegisterID = dbo.GetNextAutoNumber('BankingRegister', 'RegisterNo', @RegisterID)
insert into BankingRegister
(RegisterID, RegisterNo, CollectionStartDate, CollectionEndDate, BankingDate,CollectionSourceTypeID, BankNameID, AccountName, AccountNo, AmountCollected, AmountBanked, 
AmountInWords,  CurrencyID,ExchangeRate, BankedBy, LoginID, ClientMachine, RecordDateTime)
values
(@RegisterID, @RegisterNo, @CollectionStartDate, @CollectionEndDate, @BankingDate,@CollectionSourceTypeID, @BankNameID, @AccountName, @AccountNo, 
@AmountCollected, @AmountBanked, @AmountInWords,  @CurrencyID,@ExchangeRate, @BankedBy, @LoginID, @ClientMachine, @RecordDateTime)
return 0
end
go

/******************************************************************************************************
exec uspInsertBankingRegister
******************************************************************************************************/
-- select * from BankingRegister
-- delete from BankingRegister


-------------- Update BankingRegister -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateBankingRegister')
	drop proc uspUpdateBankingRegister
go

create proc uspUpdateBankingRegister(
@RegisterNo Varchar(20),
@CollectionStartDate smalldatetime,
@CollectionEndDate smalldatetime,
@BankingDate smalldatetime,
@CollectionSourceTypeID Varchar(10),
@BankNameID Varchar(10),
@AccountName Varchar(20),
@AccountNo Varchar(20),
@AmountCollected money,
@AmountBanked money,
@AmountInWords Varchar(800),
@CurrencyID Varchar(10),
@ExchangeRate money,
@BankedBy Varchar(40),
@LoginID Varchar(20),
@ClientMachine Varchar(40),
@RecordDateTime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RegisterNo from BankingRegister where RegisterNo = @RegisterNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Register No', @RegisterNo, 'BankingRegister')
		return 1
	end

	if not exists(select DataID from LookupData where DataID = @CollectionSourceTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Collection Source Type', @CollectionSourceTypeID, 'Lookup Data')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @BankNameID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bank Name', @BankNameID, 'Lookup Data')
		return 1
	end

if not exists(select AccountNo from BankAccounts where AccountNo  = @AccountNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account No', @AccountNo, 'BankAccounts')
		return 1
	end

	if not exists(select DataID from LookupData where DataID = @CurrencyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Currency', @CurrencyID, 'Lookup Data')
		return 1
	end


if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update BankingRegister set
CollectionStartDate = @CollectionStartDate, CollectionEndDate = @CollectionEndDate, 
BankingDate = @BankingDate, CollectionSourceTypeID=@CollectionSourceTypeID,
 BankNameID = @BankNameID, 
AccountName = @AccountName, AccountNo = @AccountNo, AmountCollected = @AmountCollected, AmountBanked = @AmountBanked, 
AmountInWords = @AmountInWords, CurrencyID = @CurrencyID, ExchangeRate=@ExchangeRate, 
BankedBy = @BankedBy, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
where RegisterNo = @RegisterNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateBankingRegister
******************************************************************************************************/
-- select * from BankingRegister
-- delete from BankingRegister


-------------- Get BankingRegister -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBankingRegister')
	drop proc uspGetBankingRegister
go

create proc uspGetBankingRegister(
@RegisterNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RegisterNo from BankingRegister where RegisterNo = @RegisterNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Register No', @RegisterNo, 'BankingRegister')
		return 1
	end
else
begin
	select  RegisterNo, CollectionStartDate, CollectionEndDate, BankingDate,CollectionSourceTypeID, dbo.GetLookupDataDes(CollectionSourceTypeID) as CollectionSourceType, BankingRegister.BankNameID as BankNamesID, 
	dbo.GetLookupDataDes(BankingRegister.BankNameID) as BankName, BankingRegister.AccountName as AccountName, 
	BankingRegister.AccountNo as AccountNo,AmountCollected, AmountBanked,dbo.GetLookupDataDes(BankAccounts.CurrencyID) as AccountCurrency,
	(AmountBanked*ExchangeRate) as BankedInShillings,
	AmountInWords,BankingRegister.CurrencyID as CurrencyID,
	dbo.GetLookupDataDes(BankingRegister.CurrencyID) as Currency, ExchangeRate, BankedBy, 
	BankingRegister.LoginID as LoginID, BankingRegister.ClientMachine as ClientMachine,
	 BankingRegister.RecordDateTime as RecordDateTime
	from BankingRegister
	inner join BankAccounts on BankingRegister.AccountNo = BankAccounts.AccountNo	
	inner join Logins on BankingRegister.LoginID = Logins.LoginID	

	where RegisterNo = @RegisterNo
return 0
end
go


/******************************************************************************************************
exec uspGetBankingRegister
******************************************************************************************************/
-- select * from BankingRegister
-- delete from BankingRegister


------------- Get PeriodicBankingRegister -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicBankingRegister')
	drop proc uspGetPeriodicBankingRegister
go

create proc uspGetPeriodicBankingRegister( 
@StartDate smalldatetime,
@EndDate smalldatetime,
@BankNamesID Varchar(10)=null,
@AccountNo varchar(20)=null,
@LoginID varchar(20)=null
)with encryption as

declare @ErrorMSG varchar(200)

if (@BankNamesID='' or @BankNamesID is null) and (@AccountNo='' or @AccountNo is null) and (@LoginID='' or @LoginID is null)
begin
	select  RegisterNo, dbo.FormatDate(CollectionStartDate) as CollectionStartDate, dbo.FormatDate(CollectionEndDate) as CollectionEndDate,
	 dbo.FormatDate(BankingDate) as BankingDate,CollectionSourceTypeID, dbo.GetLookupDataDes(CollectionSourceTypeID) as CollectionSourceType, BankingRegister.BankNameID as BankNamesID, 
	dbo.GetLookupDataDes(BankingRegister.BankNameID) as BankName, BankingRegister.AccountName as AccountName, 
	BankingRegister.AccountNo as AccountNo,AmountCollected, AmountBanked, dbo.GetLookupDataDes(BankAccounts.CurrencyID) as AccountCurrency,
	(AmountBanked*ExchangeRate) as BankedInShillings,AmountInWords,BankingRegister.CurrencyID as CurrencyID,
	dbo.GetLookupDataDes(BankingRegister.CurrencyID) as Currency,ExchangeRate, BankedBy, 
	BankingRegister.LoginID as LoginID, BankingRegister.ClientMachine as ClientMachine, BankingRegister.RecordDateTime as RecordDateTime 
	from BankingRegister
	inner join BankAccounts on BankingRegister.AccountNo = BankAccounts.AccountNo	
	inner join Logins on BankingRegister.LoginID = Logins.LoginID
	where BankingRegister.RecordDateTime between @StartDate and @EndDate
end

---------------only @BankNameID not null
else if not (@BankNamesID='' or @BankNamesID is null)  and(@AccountNo='' or @AccountNo is null) and @LoginID='' or @LoginID is null

begin
	select  RegisterNo, dbo.FormatDate(CollectionStartDate) as CollectionStartDate, dbo.FormatDate(CollectionEndDate) as CollectionEndDate,
	 dbo.FormatDate(BankingDate) as BankingDate,CollectionSourceTypeID, dbo.GetLookupDataDes(CollectionSourceTypeID) as CollectionSourceType, BankingRegister.BankNameID as BankNamesID, 
	dbo.GetLookupDataDes(BankingRegister.BankNameID) as BankName, BankingRegister.AccountName as AccountName, 
	BankingRegister.AccountNo as AccountNo,AmountCollected, AmountBanked,dbo.GetLookupDataDes(BankAccounts.CurrencyID) as AccountCurrency,
	(AmountBanked*ExchangeRate) as BankedInShillings,
	 AmountInWords, BankingRegister.CurrencyID as CurrencyID,
	dbo.GetLookupDataDes(BankingRegister.CurrencyID) as Currency, ExchangeRate,BankedBy, 
	BankingRegister.LoginID as LoginID, BankingRegister.ClientMachine as ClientMachine, BankingRegister.RecordDateTime as RecordDateTime
	from BankingRegister
	inner join BankAccounts on BankingRegister.AccountNo = BankAccounts.AccountNo	
	inner join Logins on BankingRegister.LoginID = Logins.LoginID	
   where BankingRegister.BankNameID = @BankNamesID and BankingRegister.RecordDateTime between @StartDate and @EndDate
end


---------------only @AccountNo not null
else if  (@BankNamesID='' or @BankNamesID is null)  and not (@AccountNo='' or @AccountNo is null) and @LoginID='' or @LoginID is null

begin
	select  RegisterNo, dbo.FormatDate(CollectionStartDate) as CollectionStartDate, dbo.FormatDate(CollectionEndDate) as CollectionEndDate,
	 dbo.FormatDate(BankingDate) as BankingDate,CollectionSourceTypeID, dbo.GetLookupDataDes(CollectionSourceTypeID) as CollectionSourceType, BankingRegister.BankNameID as BankNamesID, 
	dbo.GetLookupDataDes(BankingRegister.BankNameID) as BankName, BankingRegister.AccountName as AccountName, 
	BankingRegister.AccountNo as AccountNo,AmountCollected, AmountBanked,dbo.GetLookupDataDes(BankAccounts.CurrencyID) as AccountCurrency,
	(AmountBanked*ExchangeRate) as BankedInShillings,
	 AmountInWords, BankingRegister.CurrencyID as CurrencyID,
	dbo.GetLookupDataDes(BankingRegister.CurrencyID) as Currency, ExchangeRate,BankedBy, 
	BankingRegister.LoginID as LoginID, BankingRegister.ClientMachine as ClientMachine, BankingRegister.RecordDateTime as RecordDateTime
	from BankingRegister
	inner join BankAccounts on BankingRegister.AccountNo = BankAccounts.AccountNo	
	inner join Logins on BankingRegister.LoginID = Logins.LoginID	
   where BankingRegister.AccountNo = @AccountNo and BankingRegister.RecordDateTime between @StartDate and @EndDate
end

----------------------------------------Only LoginID not null
else if  (@BankNamesID='' or @BankNamesID is null) and(@AccountNo='' or @AccountNo is null) and not (@LoginID='' or @LoginID is null)
begin
	select  RegisterNo, dbo.FormatDate(CollectionStartDate) as CollectionStartDate, dbo.FormatDate(CollectionEndDate) as CollectionEndDate,
	 dbo.FormatDate(BankingDate) as BankingDate,CollectionSourceTypeID, dbo.GetLookupDataDes(CollectionSourceTypeID) as CollectionSourceType, BankingRegister.BankNameID as BankNamesID, 
	dbo.GetLookupDataDes(BankingRegister.BankNameID) as BankName, BankingRegister.AccountName as AccountName, 
	BankingRegister.AccountNo as AccountNo,AmountCollected, AmountBanked,dbo.GetLookupDataDes(BankAccounts.CurrencyID) as AccountCurrency,
	(AmountBanked*ExchangeRate) as BankedInShillings,
	 AmountInWords, BankingRegister.CurrencyID as CurrencyID,
	dbo.GetLookupDataDes(BankingRegister.CurrencyID) as Currency,ExchangeRate, BankedBy, 
	BankingRegister.LoginID as LoginID, BankingRegister.ClientMachine as ClientMachine, BankingRegister.RecordDateTime as RecordDateTime
	from BankingRegister
	inner join BankAccounts on BankingRegister.AccountNo = BankAccounts.AccountNo	
	inner join Logins on BankingRegister.LoginID = Logins.LoginID	

	where BankingRegister.LoginID = @LoginID and BankingRegister.RecordDateTime between @StartDate and @EndDate
 end
 

 -------------------------BankNamesID and AccountNo not null--------------------------------------------
else if  not (@BankNamesID='' or @BankNamesID is null) and not (@AccountNo='' or @AccountNo is null) and  (@LoginID='' or @LoginID is null)

begin

select  RegisterNo, dbo.FormatDate(CollectionStartDate) as CollectionStartDate, dbo.FormatDate(CollectionEndDate) as CollectionEndDate,
	 dbo.FormatDate(BankingDate) as BankingDate,CollectionSourceTypeID, dbo.GetLookupDataDes(CollectionSourceTypeID) as CollectionSourceType, BankingRegister.BankNameID as BankNamesID, 
	dbo.GetLookupDataDes(BankingRegister.BankNameID) as BankName, BankingRegister.AccountName as AccountName, 
	BankingRegister.AccountNo as AccountNo,AmountCollected, AmountBanked, dbo.GetLookupDataDes(BankAccounts.CurrencyID) as AccountCurrency,
	(AmountBanked*ExchangeRate) as BankedInShillings,
	AmountInWords, BankingRegister.CurrencyID as CurrencyID,
	dbo.GetLookupDataDes(BankingRegister.CurrencyID) as Currency,ExchangeRate, BankedBy, 
	BankingRegister.LoginID as LoginID, BankingRegister.ClientMachine as ClientMachine, BankingRegister.RecordDateTime as RecordDateTime
	from BankingRegister
	inner join BankAccounts on BankingRegister.AccountNo = BankAccounts.AccountNo	
	inner join Logins on BankingRegister.LoginID = Logins.LoginID	

	where BankingRegister.BankNameID = @BankNamesID and BankingRegister.AccountNo = @AccountNo  and BankingRegister.RecordDateTime between @StartDate and @EndDate
 end 

 -------------------------BankNamesID and Login not null--------------------------------------------
else if  not (@BankNamesID='' or @BankNamesID is null) and  (@AccountNo='' or @AccountNo is null) and  not (@LoginID='' or @LoginID is null)

begin

select  RegisterNo, dbo.FormatDate(CollectionStartDate) as CollectionStartDate, dbo.FormatDate(CollectionEndDate) as CollectionEndDate,
	 dbo.FormatDate(BankingDate) as BankingDate,CollectionSourceTypeID, dbo.GetLookupDataDes(CollectionSourceTypeID) as CollectionSourceType, BankingRegister.BankNameID as BankNamesID, 
	dbo.GetLookupDataDes(BankingRegister.BankNameID) as BankName, BankingRegister.AccountName as AccountName, 
	BankingRegister.AccountNo as AccountNo,AmountCollected, AmountBanked, dbo.GetLookupDataDes(BankAccounts.CurrencyID) as AccountCurrency,
	(AmountBanked*ExchangeRate) as BankedInShillings,
	AmountInWords,BankingRegister.CurrencyID as CurrencyID,
	dbo.GetLookupDataDes(BankingRegister.CurrencyID) as Currency,ExchangeRate, BankedBy, 
	BankingRegister.LoginID as LoginID, BankingRegister.ClientMachine as ClientMachine, BankingRegister.RecordDateTime as RecordDateTime
	from BankingRegister
	inner join BankAccounts on BankingRegister.AccountNo = BankAccounts.AccountNo	
	inner join Logins on BankingRegister.LoginID = Logins.LoginID	

	where BankingRegister.BankNameID = @BankNamesID and BankingRegister.LoginID = @LoginID  and BankingRegister.RecordDateTime between @StartDate and @EndDate
 end 

 -------------------------AccountNo and LoginID not null not null--------------------------------------------
else if   (@BankNamesID='' or @BankNamesID is null) and not (@AccountNo='' or @AccountNo is null) and  not(@LoginID='' or @LoginID is null)

begin

select  RegisterNo, dbo.FormatDate(CollectionStartDate) as CollectionStartDate, dbo.FormatDate(CollectionEndDate) as CollectionEndDate,
	 dbo.FormatDate(BankingDate) as BankingDate,CollectionSourceTypeID, dbo.GetLookupDataDes(CollectionSourceTypeID) as CollectionSourceType, BankingRegister.BankNameID as BankNamesID, 
	dbo.GetLookupDataDes(BankingRegister.BankNameID) as BankName, BankingRegister.AccountName as AccountName, 
	BankingRegister.AccountNo as AccountNo,AmountCollected, AmountBanked, dbo.GetLookupDataDes(BankAccounts.CurrencyID) as AccountCurrency,
	(AmountBanked*ExchangeRate) as BankedInShillings,
	AmountInWords,BankingRegister.CurrencyID as CurrencyID,
	dbo.GetLookupDataDes(BankingRegister.CurrencyID) as Currency,ExchangeRate, BankedBy, 
	BankingRegister.LoginID as LoginID, BankingRegister.ClientMachine as ClientMachine, BankingRegister.RecordDateTime as RecordDateTime
	from BankingRegister
	inner join BankAccounts on BankingRegister.AccountNo = BankAccounts.AccountNo	
	inner join Logins on BankingRegister.LoginID = Logins.LoginID	

	where BankingRegister.AccountNo = @AccountNo  and BankingRegister.LoginID = @LoginID and BankingRegister.RecordDateTime between @StartDate and @EndDate
 end 
--------------------------nothing is null--------------------------------------------
else

begin

select  RegisterNo, dbo.FormatDate(CollectionStartDate) as CollectionStartDate, dbo.FormatDate(CollectionEndDate) as CollectionEndDate,
	 dbo.FormatDate(BankingDate) as BankingDate,CollectionSourceTypeID, dbo.GetLookupDataDes(CollectionSourceTypeID) as CollectionSourceType, BankingRegister.BankNameID as BankNamesID, 
	dbo.GetLookupDataDes(BankingRegister.BankNameID) as BankName, BankingRegister.AccountName as AccountName, 
	BankingRegister.AccountNo as AccountNo,AmountCollected, AmountBanked, dbo.GetLookupDataDes(BankAccounts.CurrencyID) as AccountCurrency,
	(AmountBanked*ExchangeRate) as BankedInShillings,
	AmountInWords,BankingRegister.CurrencyID as CurrencyID,
	dbo.GetLookupDataDes(BankingRegister.CurrencyID) as Currency,ExchangeRate, BankedBy, 
	BankingRegister.LoginID as LoginID, BankingRegister.ClientMachine as ClientMachine, BankingRegister.RecordDateTime as RecordDateTime
	from BankingRegister
	inner join BankAccounts on BankingRegister.AccountNo = BankAccounts.AccountNo	
	inner join Logins on BankingRegister.LoginID = Logins.LoginID	

	where BankingRegister.BankNameID = @BankNamesID and BankingRegister.AccountNo = @AccountNo and BankingRegister.LoginID = @LoginID and BankingRegister.RecordDateTime between @StartDate and @EndDate
 end 
return 0
go

---------------------------uspGetNextRegisterID--------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetNextRegisterID')
	drop proc uspGetNextRegisterID
go

create proc uspGetNextRegisterID(
@RegisterID int = null output
)with encryption as
declare @CurrentYear int
set @CurrentYear = right(year(getdate()),2)
set @RegisterID = (select max(RegisterID) from BankingRegister where left(RegisterNo, 2) = @CurrentYear)
set @RegisterID = dbo.GetNextAutoNumber('BankingRegister', 'RegisterNo', @RegisterID)

return 0

go

------------------------------------------------------------------------------------------------------------------------------------------------------------

--------uspGetPeriodicPayModePaymentSummaries----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicPayModePaymentSummaries')
	drop proc uspGetPeriodicPayModePaymentSummaries
go

create proc uspGetPeriodicPayModePaymentSummaries(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime,
@PayModesID varchar(20) = null,
@LoginID varchar(20) = null,
@VisitsBranch varchar(10) =null
)with encryption as

declare @ErrorMSG varchar(200)

------------------------All null---------------------------------------
if  (@PayModesID is null) and  (@LoginID is null) and (@VisitsBranch is null)
	begin
		
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)) as AmountCollected, 
	sum(dbo.GetAmountRefunded(ReceiptNo)) as TotalAmountRefunded,
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)-dbo.GetAmountRefunded(ReceiptNo)) as NetAmountCollected
	from Payments where RecordDateTime between @StartDateTime and @EndDateTime group by PayModesID
			
	end	

------------------------only PayModeID not null---------------------------------------
if not (@PayModesID is null) and  (@LoginID is null) and (@VisitsBranch is null)
	begin
		
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)) as AmountCollected, 
	sum(dbo.GetAmountRefunded(ReceiptNo)) as TotalAmountRefunded,
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)-dbo.GetAmountRefunded(ReceiptNo)) as NetAmountCollected
	from Payments where RecordDateTime between @StartDateTime and @EndDateTime and PayModesID=@PayModesID  group by PayModesID
			
	end	

	------------------------only LoginID not null---------------------------------------
else if (@PayModesID is null) and not (@LoginID is null) and (@VisitsBranch is null)
	begin
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)) as AmountCollected, 
	sum(dbo.GetAmountRefunded(ReceiptNo)) as TotalAmountRefunded,
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)-dbo.GetAmountRefunded(ReceiptNo)) as NetAmountCollected
	from Payments 
		where LoginID=@LoginID and RecordDateTime between @StartDateTime and @EndDateTime group by PayModesID
		   
	end

	
	------------------------only VisitsBranch not null---------------------------------------
else if (@PayModesID is null) and (@LoginID is null) and not(@VisitsBranch is null)
	begin
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)) as AmountCollected, 
	sum(dbo.GetAmountRefunded(ReceiptNo)) as TotalAmountRefunded,
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)-dbo.GetAmountRefunded(ReceiptNo)) as NetAmountCollected
	from Payments 
		where RecordDateTime between @StartDateTime and @EndDateTime
		and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch 
		group by PayModesID
		   
	end


----------------------------- not PayModesID and LoginID----------------------------------------

else if not (@PayModesID is null) and not (@LoginID is null)  and (@VisitsBranch is null)
	begin
			select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)) as AmountCollected, 
	sum(dbo.GetAmountRefunded(ReceiptNo)) as TotalAmountRefunded,
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)-dbo.GetAmountRefunded(ReceiptNo)) as NetAmountCollected
	from Payments
		where RecordDateTime between @StartDateTime and @EndDateTime and PayModesID=@PayModesID and LoginID=@LoginID 
		group by PayModesID
		  
	end

------------------------only PayModesID and BranchID not null---------------------------------------	
else if not (@PayModesID is null) and not (@VisitsBranch is null) and (@LoginID is null)  
	begin
			select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)) as AmountCollected, 
	sum(dbo.GetAmountRefunded(ReceiptNo)) as TotalAmountRefunded,
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)-dbo.GetAmountRefunded(ReceiptNo)) as NetAmountCollected
	from Payments
	where RecordDateTime between @StartDateTime and @EndDateTime and PayModesID=@PayModesID 
	and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch 
	group by PayModesID
		  
	end

------------------------only Login ID and Branch ID not null---------------------------------------	
else if not (@PayModesID is null) and not (@VisitsBranch is null) and (@LoginID is null)  
	begin
			select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)) as AmountCollected, 
	sum(dbo.GetAmountRefunded(ReceiptNo)) as TotalAmountRefunded,
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)-dbo.GetAmountRefunded(ReceiptNo)) as NetAmountCollected
	from Payments
	where RecordDateTime between @StartDateTime and @EndDateTime  and LoginID = @LoginID and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch
	group by PayModesID
		  
	end


else 
	begin
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)) as AmountCollected, 
	sum(dbo.GetAmountRefunded(ReceiptNo)) as TotalAmountRefunded,
	sum(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)-dbo.GetAmountRefunded(ReceiptNo)) as NetAmountCollected
	from Payments 
	where RecordDateTime between @StartDateTime and @EndDateTime and PayModesID=@PayModesID and LoginID=@LoginID and dbo.GetMyCurrentBranch(LoginID)=@VisitsBranch  
	group by PayModesID
	end	
return 0
go


---exec uspGetPeriodicPayModePaymentSummaries 'Dec 15, 2016','Mar 15, 2017','6CA', 'Administrator','177NA'
--------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------



--------uspGetPeriodicPayModePayments----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicPayModePayments')
	drop proc uspGetPeriodicPayModePayments
go

create proc uspGetPeriodicPayModePayments(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime,
@PayModesID varchar(20) = null,
@LoginID varchar(20) = null,
@VisitsBranch varchar(10) =null
)with encryption as

declare @ErrorMSG varchar(200)

------------------------All null---------------------------------------
if  (@PayModesID is null) and  (@LoginID is null) and (@VisitsBranch is null)
	begin
		
				select ReceiptNo, PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,	
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, PayDate, 
	dbo.FormatMoney(dbo.GetOutstandingBalance(dbo.GetPayeeNo(PayTypeID, PayNo))) as OutstandingBalance,
	PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo) as AmountPaid, AmountWords, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved,
	AmountTendered, ExchangeRate, Change, UseAccountBalance,
	dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded,
	VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as VisitType
	from Payments where RecordDateTime between @StartDateTime and @EndDateTime order by PayModesID
			
	end	

------------------------only PayModeID not null---------------------------------------
if not (@PayModesID is null) and  (@LoginID is null) and (@VisitsBranch is null)
	begin
				select ReceiptNo, PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,	
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, PayDate, 
	dbo.FormatMoney(dbo.GetOutstandingBalance(dbo.GetPayeeNo(PayTypeID, PayNo))) as OutstandingBalance,
	PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo) as AmountPaid, AmountWords, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved, 
	AmountTendered, ExchangeRate, Change, UseAccountBalance,
	dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded,
	VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as VisitType
	from Payments where RecordDateTime between @StartDateTime and @EndDateTime and PayModesID=@PayModesID  order by PayModesID
			
	end	

	------------------------only LoginID not null---------------------------------------
else if (@PayModesID is null) and not (@LoginID is null) and (@VisitsBranch is null)
	begin
				select ReceiptNo, PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,	
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, PayDate, 
	dbo.FormatMoney(dbo.GetOutstandingBalance(dbo.GetPayeeNo(PayTypeID, PayNo))) as OutstandingBalance,
	PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo) as AmountPaid, AmountWords, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved, 
	AmountTendered, ExchangeRate, Change, UseAccountBalance,
	dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded,
	VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as VisitType
	from Payments 
		where LoginID=@LoginID and RecordDateTime between @StartDateTime and @EndDateTime order by PayModesID
		   
	end

	
	------------------------only VisitsBranch not null---------------------------------------
else if (@PayModesID is null) and (@LoginID is null) and not(@VisitsBranch is null)
	begin
				select ReceiptNo, PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,	
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, PayDate, 
	dbo.FormatMoney(dbo.GetOutstandingBalance(dbo.GetPayeeNo(PayTypeID, PayNo))) as OutstandingBalance,
	PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo) as AmountPaid, AmountWords, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved,
	AmountTendered, ExchangeRate, Change, UseAccountBalance,
	dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded,
	VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as VisitType
	from Payments 
		where RecordDateTime between @StartDateTime and @EndDateTime
		and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch 
		order by PayModesID
		   
	end


----------------------------- not PayModesID and LoginID----------------------------------------

else if not (@PayModesID is null) and not (@LoginID is null)  and (@VisitsBranch is null)
	begin
			select ReceiptNo, PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,	
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, PayDate, 
	dbo.FormatMoney(dbo.GetOutstandingBalance(dbo.GetPayeeNo(PayTypeID, PayNo))) as OutstandingBalance,
	PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo) as AmountPaid, AmountWords, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved,
	AmountTendered, ExchangeRate, Change, UseAccountBalance,
	dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded,
	VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as VisitType
	from Payments
		where RecordDateTime between @StartDateTime and @EndDateTime and PayModesID=@PayModesID and LoginID=@LoginID 
		order by PayModesID
		  
	end

------------------------only PayModesID and BranchID not null---------------------------------------	
else if not (@PayModesID is null) and not (@VisitsBranch is null) and (@LoginID is null)  
	begin
					select ReceiptNo, PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,	
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, PayDate, 
	dbo.FormatMoney(dbo.GetOutstandingBalance(dbo.GetPayeeNo(PayTypeID, PayNo))) as OutstandingBalance,
	PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo) as AmountPaid, AmountWords, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved, 
	AmountTendered, ExchangeRate, Change, UseAccountBalance,
	dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded,
	VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as VisitType
	from Payments
	where RecordDateTime between @StartDateTime and @EndDateTime and PayModesID=@PayModesID 
	and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch 
	order by PayModesID
		  
	end

------------------------only Login ID and Branch ID not null---------------------------------------	
else if not (@PayModesID is null) and not (@VisitsBranch is null) and (@LoginID is null)  
	begin
					select ReceiptNo, PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,	
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, PayDate, 
	dbo.FormatMoney(dbo.GetOutstandingBalance(dbo.GetPayeeNo(PayTypeID, PayNo))) as OutstandingBalance,
	PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo) as AmountPaid, AmountWords, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved,
	AmountTendered, ExchangeRate, Change, UseAccountBalance,
	dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded,
	VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as VisitType
	from Payments
	where RecordDateTime between @StartDateTime and @EndDateTime  and LoginID = @LoginID and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch
	order by PayModesID
		  
	end


else 
	begin
				select ReceiptNo, PayTypeID, dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,	
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, PayDate, 
	dbo.FormatMoney(dbo.GetOutstandingBalance(dbo.GetPayeeNo(PayTypeID, PayNo))) as OutstandingBalance,
	PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo) as AmountPaid, AmountWords, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved, 
	AmountTendered, ExchangeRate, Change, UseAccountBalance,
	dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded,
	VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as VisitType
	from Payments 
	where RecordDateTime between @StartDateTime and @EndDateTime and PayModesID=@PayModesID and LoginID=@LoginID and dbo.GetMyCurrentBranch(LoginID)=@VisitsBranch  
	order by PayModesID
	end	
return 0
go

--exec uspGetPeriodicPayModePayments 'Dec 15, 2016','Jan 15, 2017','6CA', 'daphine.birungi','177NA'

-------------------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------------------

----------------------------------- Other Income Register --------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------
--------uspGetPeriodicOtherIncomeSummaries----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicOtherIncomeSummaries')
	drop proc uspGetPeriodicOtherIncomeSummaries
go

create proc uspGetPeriodicOtherIncomeSummaries(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime,
@PayModesID varchar(20) = null,
@LoginID varchar(20) = null,
@VisitsBranch varchar(10) =null
)with encryption as

declare @ErrorMSG varchar(200)

------------------------All null---------------------------------------
if  (@PayModesID is null) and  (@LoginID is null) and (@VisitsBranch is null)
	begin
		
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(Amount) as Amount
	from OtherIncome where RecordDateTime between @StartDateTime and @EndDateTime group by PayModesID
			
	end	

------------------------only PayModeID not null---------------------------------------
if not (@PayModesID is null) and  (@LoginID is null) and (@VisitsBranch is null)
	begin
		
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(Amount) as Amount
	from OtherIncome where RecordDateTime between @StartDateTime and @EndDateTime and PayModesID=@PayModesID  group by PayModesID
			
	end	

	------------------------only LoginID not null---------------------------------------
else if (@PayModesID is null) and not (@LoginID is null) and (@VisitsBranch is null)
	begin
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(Amount) as Amount
	from OtherIncome 
		where LoginID=@LoginID and RecordDateTime between @StartDateTime and @EndDateTime group by PayModesID
		   
	end

	
	------------------------only VisitsBranch not null---------------------------------------
else if (@PayModesID is null) and (@LoginID is null) and not(@VisitsBranch is null)
	begin
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(Amount) as Amount
	from OtherIncome 
		where RecordDateTime between @StartDateTime and @EndDateTime
		and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch 
		group by PayModesID
		   
	end


----------------------------- not PayModesID and LoginID----------------------------------------

else if not (@PayModesID is null) and not (@LoginID is null)  and (@VisitsBranch is null)
	begin
			select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(Amount) as Amount
	from OtherIncome
		where RecordDateTime between @StartDateTime and @EndDateTime and PayModesID=@PayModesID and LoginID=@LoginID 
		group by PayModesID
		  
	end

------------------------only PayModesID and BranchID not null---------------------------------------	
else if not (@PayModesID is null) and not (@VisitsBranch is null) and (@LoginID is null)  
	begin
			select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(Amount) as Amount
	from OtherIncome
	where RecordDateTime between @StartDateTime and @EndDateTime and PayModesID=@PayModesID 
	and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch 
	group by PayModesID
		  
	end

------------------------only Login ID and Branch ID not null---------------------------------------	
else if not (@PayModesID is null) and not (@VisitsBranch is null) and (@LoginID is null)  
	begin
			select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(Amount) as Amount
	from OtherIncome
	where RecordDateTime between @StartDateTime and @EndDateTime  and LoginID = @LoginID and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch
	group by PayModesID
		  
	end


else 
	begin
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	sum(Amount) as Amount
	from OtherIncome 
	where RecordDateTime between @StartDateTime and @EndDateTime and PayModesID=@PayModesID and LoginID=@LoginID and dbo.GetMyCurrentBranch(LoginID)=@VisitsBranch  
	group by PayModesID
	end	
return 0
go


--exec uspGetPeriodicOtherIncomeSummaries 'Dec 15, 2016','Mar 15, 2017','6CH', 'Administrator','177NA'
--------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------

--------uspGetPeriodicAccountSummaries----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicAccountSummaries')
	drop proc uspGetPeriodicAccountSummaries
go

create proc uspGetPeriodicAccountSummaries(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime,
@PayModesID varchar(20) = null,
@LoginID varchar(20) = null,
@VisitsBranch varchar(10) =null
)with encryption as

declare @ErrorMSG varchar(200)
declare @DebitAccountActionID varchar(10)
declare @CreditAccountActionID varchar(10)
----------------------------------------------------------------------
set  @DebitAccountActionID= dbo.GetLookupDataID('AccountAction', 'DR')
set  @CreditAccountActionID= dbo.GetLookupDataID('AccountAction', 'CR')

------------------------All null---------------------------------------
if  (@PayModesID is null) and  (@LoginID is null) and (@VisitsBranch is null)
	begin
		
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	dbo.FormatMoney(dbo.GetPeriodicAccountActionAmount(@StartDateTime,@EndDateTime,@CreditAccountActionID, PayModesID)-dbo.GetPeriodicAccountActionAmount(@StartDateTime,@EndDateTime,@DebitAccountActionID, PayModesID)) as Amount
	from Accounts where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime group by PayModesID
			
	end	

------------------------only PayModeID not null---------------------------------------
if not (@PayModesID is null) and  (@LoginID is null) and (@VisitsBranch is null)
	begin
		
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
dbo.FormatMoney(dbo.GetPeriodicAccountActionAmount(@StartDateTime,@EndDateTime,@CreditAccountActionID, PayModesID)-dbo.GetPeriodicAccountActionAmount(@StartDateTime,@EndDateTime,@DebitAccountActionID, PayModesID)) as Amount
	from Accounts where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime and PayModesID=@PayModesID  group by PayModesID
			
	end	

	------------------------only LoginID not null---------------------------------------
else if (@PayModesID is null) and not (@LoginID is null) and (@VisitsBranch is null)
	begin
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
dbo.FormatMoney(dbo.GetPeriodicAccountActionAmount(@StartDateTime,@EndDateTime,@CreditAccountActionID, PayModesID)-dbo.GetPeriodicAccountActionAmount( @StartDateTime,@EndDateTime,@DebitAccountActionID, PayModesID)) as Amount
	from Accounts 
		where LoginID=@LoginID and dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime group by PayModesID
		   
	end

	
	------------------------only VisitsBranch not null---------------------------------------
else if (@PayModesID is null) and (@LoginID is null) and not(@VisitsBranch is null)
	begin
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
dbo.FormatMoney(dbo.GetPeriodicAccountActionAmount(@StartDateTime,@EndDateTime,@CreditAccountActionID, PayModesID)-dbo.GetPeriodicAccountActionAmount( @StartDateTime,@EndDateTime,@DebitAccountActionID, PayModesID)) as Amount
	from Accounts 
		where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime
		and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch 
		group by PayModesID
		   
	end


----------------------------- not PayModesID and LoginID----------------------------------------

else if not (@PayModesID is null) and not (@LoginID is null)  and (@VisitsBranch is null)
	begin
			select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
dbo.FormatMoney(dbo.GetPeriodicAccountActionAmount(@StartDateTime,@EndDateTime,@CreditAccountActionID, PayModesID)-dbo.GetPeriodicAccountActionAmount( @StartDateTime,@EndDateTime,@DebitAccountActionID, PayModesID)) as Amount
		from Accounts
		where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime and PayModesID=@PayModesID and LoginID=@LoginID 
		group by PayModesID
		  
	end

------------------------only PayModesID and BranchID not null---------------------------------------	
else if not (@PayModesID is null) and not (@VisitsBranch is null) and (@LoginID is null)  
	begin
			select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
dbo.FormatMoney(dbo.GetPeriodicAccountActionAmount(@StartDateTime,@EndDateTime,@CreditAccountActionID, PayModesID)-dbo.GetPeriodicAccountActionAmount( @StartDateTime,@EndDateTime,@DebitAccountActionID, PayModesID)) as Amount
	from Accounts
	where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime and PayModesID=@PayModesID 
	and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch 
	group by PayModesID
		  
	end

------------------------only Login ID and Branch ID not null---------------------------------------	
else if (@PayModesID is null) and not (@VisitsBranch is null) and not (@LoginID is null)  
	begin
			select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
	dbo.FormatMoney(dbo.GetPeriodicAccountActionAmount(@StartDateTime,@EndDateTime,@CreditAccountActionID, PayModesID)-dbo.GetPeriodicAccountActionAmount( @StartDateTime,@EndDateTime,@DebitAccountActionID, PayModesID)) as Amount
	from Accounts
	where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime  and LoginID = @LoginID and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch
	group by PayModesID
		  
	end


else 
	begin
		select PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, 
dbo.FormatMoney(dbo.GetPeriodicAccountActionAmount(@StartDateTime,@EndDateTime,@CreditAccountActionID, PayModesID)-dbo.GetPeriodicAccountActionAmount( @StartDateTime,@EndDateTime,@DebitAccountActionID, PayModesID)) as Amount
		from Accounts 
	where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime and PayModesID=@PayModesID and LoginID=@LoginID and dbo.GetMyCurrentBranch(LoginID)=@VisitsBranch  
	group by PayModesID
	end	
return 0
go


--------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------
--------GetPeriodicAccountActionAmount ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPeriodicAccountActionAmount')
	drop function GetPeriodicAccountActionAmount
go

create function GetPeriodicAccountActionAmount(@StartDate smalldatetime, @EndDate smalldatetime,@AccountActionID varchar(10), @PayModesID as Varchar(10)) returns int
with encryption as

begin

declare @Amount int

--------------------------------------------------------------------------------------------
set @Amount = (select sum(Amount) from Accounts where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDate and @EndDate and AccountActionID=@AccountActionID and PayModesID=@PayModesID) 
--------------------------------------------------------------------------------------------

set @Amount = isnull(@Amount, 0)

return @Amount

end
go

/*---
print dbo.GetPeriodicAccountActionAmount( 'Jun 15, 2016','Mar 15, 2017','19CR', '6CA')
exec uspGetPeriodicAccountSummaries 'Feb 15 2016','Mar 15 2017','6CA', null,'177NA'
exec uspGetPeriodicAccountSummaries 'Feb 15 2016','Mar 15 2017',null, 'Administrator','177NA'
exec uspGetPeriodicAccountSummaries 'Feb 15 2016','Mar 15 2017','6CH',null,'177NA'

*/
----------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------



--------uspGetPeriodicPayModeAccounts----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicPayModeAccount')
	drop proc uspGetPeriodicPayModeAccount
go

create proc uspGetPeriodicPayModeAccount(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime,
@PayModesID varchar(20) = null,
@LoginID varchar(20) = null,
@VisitsBranch varchar(10) =null
)with encryption as

declare @ErrorMSG varchar(200)
declare @CreditAccountActionID varchar(10)

----------------------------------------------------------------------
set  @CreditAccountActionID= dbo.GetLookupDataID('AccountAction', 'CR')

------------------------All null---------------------------------------
if  (@PayModesID is null) and  (@LoginID is null) and (@VisitsBranch is null)
	begin
		select TranNo, PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency,
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved,  
	Amount, ExchangeRate, Change 
	from Accounts where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime and AccountActionID=@CreditAccountActionID and AccountActionID=@CreditAccountActionID order by PayModesID
			
	end	

------------------------only PayModeID not null---------------------------------------
if not (@PayModesID is null) and  (@LoginID is null) and (@VisitsBranch is null)
	begin
		select TranNo, PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved, 
	Amount, ExchangeRate, Change
	from Accounts where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime and AccountActionID=@CreditAccountActionID and AccountActionID=@CreditAccountActionID and PayModesID=@PayModesID  order by PayModesID
			
	end	

	------------------------only LoginID not null---------------------------------------
else if (@PayModesID is null) and not (@LoginID is null) and (@VisitsBranch is null)
	begin
				select TranNo, PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved, 
	Amount, ExchangeRate, Change
	from Accounts 
		where LoginID=@LoginID and dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime order by PayModesID
		   
	end

	
	------------------------only VisitsBranch not null---------------------------------------
else if (@PayModesID is null) and (@LoginID is null) and not(@VisitsBranch is null)
	begin
				select TranNo, PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved, 
	Amount, ExchangeRate, Change
	from Accounts 
		where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime
		and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch 
		order by PayModesID
	
	end


----------------------------- not PayModesID and LoginID----------------------------------------

else if not (@PayModesID is null) and not (@LoginID is null)  and (@VisitsBranch is null)
	begin
			select TranNo, PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved, 
	Amount, ExchangeRate, Change
	from Accounts
		where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime and PayModesID=@PayModesID and LoginID=@LoginID 
		order by PayModesID
		  
	end

------------------------only PayModesID and BranchID not null---------------------------------------	
else if not (@PayModesID is null) and not (@VisitsBranch is null) and (@LoginID is null)  
	begin
					select TranNo, PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved, 
	Amount, ExchangeRate, Change
	from Accounts
	where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime and PayModesID=@PayModesID 
	and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch 
	order by PayModesID
		  
	end

------------------------only Login ID and Branch ID not null---------------------------------------	
else if not (@PayModesID is null) and not (@VisitsBranch is null) and (@LoginID is null)  
	begin
		select TranNo, PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved, 
	Amount, ExchangeRate, Change
	from Accounts
	where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime  and LoginID = @LoginID and dbo.GetMyCurrentBranch(LoginID) =@VisitsBranch
	order by PayModesID
		  
	end
	

else 
	begin
			select TranNo,PayModesID, dbo.GetLookupDataDes(PayModesID) as PayModes, DocumentNo, 
	Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
	dbo.IsCollectionSaved(PayModesID,DocumentNo) as isSaved, 
	Amount, ExchangeRate, Change
	from Accounts 
	where dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime and PayModesID=@PayModesID and LoginID=@LoginID and dbo.GetMyCurrentBranch(LoginID)=@VisitsBranch  
	order by PayModesID
	end	
return 0
go

--exec uspGetPeriodicPayModeAccount 'Dec 15, 2016','Mar 15, 2017','6CA', 'Administrator','177NA'
----------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------
-------------- BankingRegisterDetails --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert BankingRegisterDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertBankingRegisterDetails')
	drop proc uspInsertBankingRegisterDetails
go

create proc uspInsertBankingRegisterDetails(
@RegisterNo Varchar(20),
@CollectionModesID Varchar(10),
@BankModesID varchar(10),
@Amount money,
@DocumentNo varchar(20),
@LoginID Varchar(20),
@ClientMachine Varchar(40),
@RecordDateTime SmallDateTime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RegisterNo from BankingRegister where RegisterNo  = @RegisterNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'RegisterNo', @RegisterNo, 'BankingRegister')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CollectionModesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Collection Mode', @CollectionModesID, 'Lookup Data')
		return 1
	end

if exists(select RegisterNo from BankingRegisterDetails where RegisterNo = @RegisterNo and CollectionModesID = @CollectionModesID and DocumentNo = @DocumentNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'RegisterNo', @RegisterNo, 'Collection Mode', @CollectionModesID, 'Document No', @DocumentNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BankModesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bank Modes', @BankModesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into BankingRegisterDetails
(RegisterNo, CollectionModesID, BankModesID, Amount, DocumentNo, LoginID, ClientMachine, RecordDateTime)
values
(@RegisterNo, @CollectionModesID, @BankModesID, @Amount, @DocumentNo, @LoginID, @ClientMachine, @RecordDateTime)
return 0
end
go

/******************************************************************************************************
exec uspInsertBankingRegisterDetails
******************************************************************************************************/
-- select * from BankingRegisterDetails
-- delete from BankingRegisterDetails


-------------- Update BankingRegisterDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateBankingRegisterDetails')
	drop proc uspUpdateBankingRegisterDetails
go

create proc uspUpdateBankingRegisterDetails(
@RegisterNo Varchar(20),
@CollectionModesID Varchar(10),
@BankModesID varchar(10),
@Amount money,
@DocumentNo varchar(20),
@LoginID Varchar(20),
@ClientMachine Varchar(40),
@RecordDateTime SmallDateTime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RegisterNo from BankingRegisterDetails where RegisterNo = @RegisterNo and CollectionModesID = @CollectionModesID and DocumentNo = @DocumentNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'RegisterNo', @RegisterNo, 'Collection Mode', @CollectionModesID, 'Document No', @DocumentNo, 'BankingRegisterDetails')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BankModesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bank Modes', @BankModesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update BankingRegisterDetails set
BankModesID = @BankModesID, Amount = @Amount, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
where RegisterNo = @RegisterNo and CollectionModesID = @CollectionModesID and DocumentNo = @DocumentNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateBankingRegisterDetails
******************************************************************************************************/
-- select * from BankingRegisterDetails
-- delete from BankingRegisterDetails


-------------- Get BankingRegisterDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBankingRegisterDetails')
	drop proc uspGetBankingRegisterDetails
go

create proc uspGetBankingRegisterDetails(
@RegisterNo Varchar(20),
@CollectionModesID Varchar(10),
@DocumentNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RegisterNo from BankingRegisterDetails where RegisterNo = @RegisterNo and CollectionModesID = @CollectionModesID and DocumentNo = @DocumentNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'RegisterNo', @RegisterNo, 'Collection Mode', @CollectionModesID, 'Document No', @DocumentNo, 'BankingRegisterDetails')
		return 1
	end
else
begin
	select RegisterNo, CollectionModesID, BankModesID, dbo.GetLookupDataDes(BankModesID) as [Bank Modes], Amount, DocumentNo, BankingRegisterDetails.LoginID, ClientMachine, RecordDateTime
	from BankingRegisterDetails
	inner join Logins on BankingRegisterDetails.LoginID = Logins.LoginID	

	where RegisterNo = @RegisterNo and CollectionModesID = @CollectionModesID and DocumentNo = @DocumentNo
return 0
end
go

/******************************************************************************************************
exec uspGetBankingRegisterDetails
******************************************************************************************************/
-- select * from BankingRegisterDetails
-- delete from BankingRegisterDetails


------------------------------------------------------------------------------------------------------
-------------- BankPaymentDetails --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert BankPaymentDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertBankPaymentDetails')
	drop proc uspInsertBankPaymentDetails
go

create proc uspInsertBankPaymentDetails(
@ReceiptNo varchar(10),
@BankNamesID varchar(10),
@AccountNo varchar(20),
@DocumentNo varchar(20),
@PayModesID varchar(10),
@ClientMachine varchar(40),
@RecordDateTime smalldatetime,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select ReceiptNo from BankPaymentDetails where ReceiptNo = @ReceiptNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BankNamesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bank Name', @BankNamesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into BankPaymentDetails
(ReceiptNo, BankNamesID, AccountNo, DocumentNo, PayModesID, ClientMachine, RecordDateTime, LoginID)
values
(@ReceiptNo, @BankNamesID, @AccountNo, @DocumentNo, @PayModesID, @ClientMachine, @RecordDateTime, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertBankPaymentDetails
******************************************************************************************************/
-- select * from BankPaymentDetails
-- delete from BankPaymentDetails


-------------- Update BankPaymentDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateBankPaymentDetails')
	drop proc uspUpdateBankPaymentDetails
go

create proc uspUpdateBankPaymentDetails(
@ReceiptNo varchar(10),
@BankNamesID varchar(10),
@AccountNo varchar(20),
@DocumentNo varchar(20),
@PayModesID varchar(10),
@ClientMachine varchar(40),
@RecordDateTime smalldatetime,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ReceiptNo from BankPaymentDetails where ReceiptNo = @ReceiptNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'BankPaymentDetails')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BankNamesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bank Name', @BankNamesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update BankPaymentDetails set
BankNamesID = @BankNamesID, AccountNo = @AccountNo, DocumentNo = @DocumentNo, PayModesID = @PayModesID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime, LoginID = @LoginID
where ReceiptNo = @ReceiptNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateBankPaymentDetails
******************************************************************************************************/
-- select * from BankPaymentDetails
-- delete from BankPaymentDetails


-------------- Get BankPaymentDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBankPaymentDetails')
	drop proc uspGetBankPaymentDetails
go

create proc uspGetBankPaymentDetails(
@ReceiptNo varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ReceiptNo from BankPaymentDetails where ReceiptNo = @ReceiptNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'BankPaymentDetails')
		return 1
	end
else
begin
	select ReceiptNo, BankNamesID, dbo.GetLookupDataDes(BankNamesID) as [Bank Name], AccountNo, DocumentNo, PayModesID, ClientMachine, RecordDateTime, BankPaymentDetails.LoginID
	from BankPaymentDetails
	inner join Logins on BankPaymentDetails.LoginID = Logins.LoginID	

	where ReceiptNo = @ReceiptNo
return 0
end
go

/******************************************************************************************************
exec uspGetBankPaymentDetails
******************************************************************************************************/
-- select * from BankPaymentDetails
-- delete from BankPaymentDetails


--------uspGetDailyNetCashCollections----------------------------------------------------------------------------------------------------------------

if exists(select * from sysobjects where name='uspGetDailyNetCashCollections')
drop proc uspGetDailyNetCashCollections
go
create proc uspGetDailyNetCashCollections(
@CollectionStartDate smalldatetime,
@CollectionEndDate smalldatetime) with encryption as

begin
select (sum (AmountPaid)-sum(AmountRefunded)) as NetCashCollected from CashPayments where RecordDateTime between @CollectionStartDate and @CollectionEndDate
end

go


--------exec uspGetDailyNetCashCollections '2015-05-11 00:00:00','2015-08-25 00:00:00'--------------------------------------------------------------------------------------------------------------



------------- Get GetStaffLoginDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetStaffLoginDetails')
	drop proc uspGetStaffLoginDetails
go

create proc uspGetStaffLoginDetails(
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select LoginID,LoginLevel, FirstName, LastName ,dbo.GetFullName(LastName, '', FirstName) as FullName,
	dbo.GetAssignedLoginRole(LoginID) as LoginRole
	from Logins
	where LoginID = @LoginID
end

return 0

go

-----------------------------  Get Banking Register Logins-------------------------------------------

------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBankingRegisterLogins')
	drop proc uspGetBankingRegisterLogins
go

create proc uspGetBankingRegisterLogins(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime
)with encryption as

begin
	select  distinct LoginID
	from BankingRegister where RecordDateTime between @StartDateTime and @EndDateTime
return 0
end
go

------------------------------------------------------------------------------------------------------
-------------- StaffLocations --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert StaffLocations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertStaffLocations')
	drop proc uspInsertStaffLocations
go

create proc uspInsertStaffLocations(
@StaffLoginID Varchar(20),
@LocationID varchar(10),
@StartDate smallDateTime,
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select LoginID from Logins where LoginID  = @StaffLoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'StaffLoginID', @StaffLoginID, 'Logins')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LocationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LocationID', @LocationID, 'Lookup Data')
		return 1
	end

if exists(select StaffLoginID from StaffLocations where StaffLoginID = @StaffLoginID and LocationID = @LocationID and StartDate = @StartDate)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s:  '+dbo.FormatDate(@StartDate) +', you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'StaffLoginID', @StaffLoginID, 'Branch', @LocationID, 'Start Date')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into StaffLocations
(StaffLoginID, LocationID, StartDate, Notes, LoginID)
values
(@StaffLoginID, @LocationID, @StartDate, @Notes, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertStaffLocations
******************************************************************************************************/
-- select * from StaffLocations
-- delete from StaffLocations


-------------- Update StaffLocations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateStaffLocations')
	drop proc uspUpdateStaffLocations
go

create proc uspUpdateStaffLocations(
@StaffLoginID Varchar(20),
@LocationID varchar(10),
@StartDate smallDateTime,
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select StaffLoginID from StaffLocations where StaffLoginID = @StaffLoginID and LocationID = @LocationID and StartDate = @StartDate)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s:  '+dbo.FormatDate(@StartDate) +', you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'StaffLoginID', @StaffLoginID, 'LocationID', @LocationID, 'StartDate', 'Staff Locations')
		return 1
	end



if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update StaffLocations set
Notes = @Notes, LoginID = @LoginID
where StaffLoginID = @StaffLoginID and LocationID = @LocationID and StartDate = @StartDate
return 0
end
go

/******************************************************************************************************
exec uspUpdateStaffLocations
******************************************************************************************************/
-- select * from StaffLocations
-- delete from StaffLocations


-------------- Get StaffLocations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetStaffLocations')
	drop proc uspGetStaffLocations
go

create proc uspGetStaffLocations(
@StaffLoginID Varchar(20),
@LocationID varchar(10) = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @BranchID varchar(10)

begin
set @BranchID = dbo.GetLookupDataID('BranchName', 'NA')
set @LocationID = isnull((select top 1 LocationID from StaffLocations where StaffLoginID = @StaffLoginID Order by RecordDateTime Desc),@BranchID)

return 0
end
go

/******************************************************************************************************
exec uspGetStaffLocations ('Admin')
******************************************************************************************************/
-- select * from StaffLocations
-- delete from StaffLocations
--------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
-------------- DoctorVisits --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
-------------- Queues --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit Queues -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditQueues')
	drop proc uspEditQueues
go

create proc uspEditQueues(
@VisitNo Varchar(20),
@ServicePointID varchar(10),
@PriorityID Varchar(10),
@QueueStatus bit,
@LoginID Varchar(20),
@ClientMachine Varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @TokenID int
declare @TokenNo Varchar(20)
declare @VisitPriorityID Varchar(10)
declare @BranchID varchar(10)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ServicePointID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Service Point No', @ServicePointID, 'Lookup Data')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @PriorityID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Priority ID', @PriorityID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

	
begin
	set @TokenID= (select max(TokenID) from Queues)
	set @TokenID = isnull(@TokenID,0)
	set @TokenID= @TokenID+1
	set @BranchID = dbo.GetMyCurrentBranch(@LoginID)
	
	

 if exists(select VisitNo from Queues where VisitNo = @VisitNo and BranchID = @BranchID and ServicePointID = @ServicePointID)
   begin
	 
	 set @VisitPriorityID=(select PriorityID from Queues where VisitNo = @VisitNo and BranchID = @BranchID and ServicePointID = @ServicePointID)

	 if @PriorityID=@VisitPriorityID
	   begin
	   
	   set @TokenNo=(select TokenNo from Queues where VisitNo = @VisitNo and BranchID = @BranchID and ServicePointID = @ServicePointID)
		
		update Queues set
		TokenNo = @TokenNo, PriorityID = @PriorityID,QueueStatus=@QueueStatus, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime=getdate()
		 where VisitNo = @VisitNo and BranchID = @BranchID and ServicePointID = @ServicePointID
	   end

     else
	  begin
	    set @TokenNo=dbo.GetNextTokenNo(@VisitNo, @ServicePointID,@BranchID , @PriorityID)
		update Queues set
		TokenNo = @TokenNo, PriorityID = @PriorityID,QueueStatus=@QueueStatus, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime=getdate()
		 where VisitNo = @VisitNo and BranchID = @BranchID and ServicePointID = @ServicePointID
	   end
	end
		
	else
	 begin
	  
	  set @TokenNo=dbo.GetNextTokenNo(@VisitNo, @ServicePointID,@BranchID , @PriorityID)
		
		insert into Queues
		(TokenID, VisitNo, BranchID, ServicePointID, TokenNo, PriorityID, QueueStatus,LoginID, ClientMachine)
		values
		(@TokenID, @VisitNo, @BranchID, @ServicePointID, @TokenNo, @PriorityID, @QueueStatus,@LoginID, @ClientMachine)
	  end
  end
return 0

go

/******************************************************************************************************
exec uspEditQueues
******************************************************************************************************/
-- select * from Queues 
-- delete from Queues


-------------- Get Queues -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetQueues')
	drop proc uspGetQueues
go

create proc uspGetQueues(
@VisitNo Varchar(20)=null,
@ServicePointID varchar(10)=null,
@BranchID Varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)
declare @RecordDate smalldatetime

set @RecordDate = dateadd(hour, -12, getdate())

if  (not @VisitNo is null or not  @VisitNo='') and  (not @BranchID=null or not @BranchID='') 
and (not @ServicePointID is null or not @ServicePointID='')
begin

	if not exists(select VisitNo from Queues where VisitNo = @VisitNo and BranchID = @BranchID and ServicePointID = @ServicePointID)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Branch ID', @BranchID, 'Service Point No', @ServicePointID, 'Queues')
			return 1
		end
	else
	 
	 begin
		select TOP 20 TokenID,Visits.PatientNo as PatientNo,Patients.FirstName as FirstName, Queues.VisitNo as VisitNo, 
		Queues.BranchID as BranchID, ServicePointID, dbo.GetLookupDataDes(ServicePointID) as ServicePoint, 
		TokenNo, Queues.PriorityID as PriorityID, dbo.GetLookupDataDes(Queues.PriorityID) as 
		VisitPriority,QueueStatus, Queues.LoginID, Queues.ClientMachine, Queues.RecordDateTime
		from Queues
		inner join Logins on Queues.LoginID = Logins.LoginID
		inner join Visits on Queues.VisitNo = Visits.VisitNo
	    inner join Patients on visits.PatientNo = Patients.PatientNo	
        where Queues.VisitNo = @VisitNo and Queues.BranchID = @BranchID and ServicePointID = @ServicePointID and QueueStatus=1 
		and Queues.RecordDateTime>=@RecordDate

		  
	end

 end

else if  (@VisitNo is null or @VisitNo='') and (not @BranchID is null or not @BranchID='') 
  and (not @ServicePointID is null or not @ServicePointID='')

begin
   select TOP 20 TokenID,Visits.PatientNo as PatientNo,Patients.FirstName as FirstName, Queues.VisitNo as VisitNo, 
   Queues.BranchID as BranchID,ServicePointID,dbo.GetLookupDataDes(ServicePointID) as ServicePoint, 
   TokenNo, Queues.PriorityID as PriorityID , dbo.GetLookupDataDes(Queues.PriorityID) as VisitPriority,QueueStatus,
    Queues.LoginID, Queues.ClientMachine, Queues.RecordDateTime
	from Queues
	inner join Logins on Queues.LoginID = Logins.LoginID
	inner join Visits on Queues.VisitNo = Visits.VisitNo
	inner join Patients on visits.PatientNo = Patients.PatientNo	

	where Queues.BranchID = @BranchID and Queues.ServicePointID = @ServicePointID and QueueStatus=1 
	and Queues.RecordDateTime>=@RecordDate
end

else
  begin
    select TOP 20 TokenID,Visits.PatientNo as PatientNo,Patients.FirstName as FirstName, Queues.VisitNo as VisitNo, 
	Queues.BranchID as BranchID, ServicePointID,dbo.GetLookupDataDes(ServicePointID) as ServicePoint, 
	TokenNo, Queues.PriorityID as PriorityID, dbo.GetLookupDataDes(Queues.PriorityID) as VisitPriority,QueueStatus,
    Queues.LoginID, Queues.ClientMachine, Queues.RecordDateTime
	from Queues
	inner join Logins on Queues.LoginID = Logins.LoginID
	inner join Visits on Queues.VisitNo = Visits.VisitNo
	inner join Patients on visits.PatientNo = Patients.PatientNo			

	where Queues.BranchID = @BranchID and QueueStatus=1 and Queues.RecordDateTime>=@RecordDate
return 0
end
go

/******************************************************************************************************
exec uspGetQueues null,'16CAS','177NA'
******************************************************************************************************/
-- select * from Queues
-- delete from Queues
---------------------------------------uspDeleteWaitingPatient----------------------------------------
 if exists (select * from sysobjects where name = 'uspDeleteQueues')
	drop proc uspDeleteQueues
go

create proc uspDeleteQueues(
@VisitNo Varchar(20),
@BranchID Varchar(10),
@ServicePointID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if  exists(select VisitNo from Queues where VisitNo = @VisitNo and BranchID = @BranchID and ServicePointID = @ServicePointID)
	begin
		 delete from Queues  where VisitNo = @VisitNo and BranchID = @BranchID and ServicePointID = @ServicePointID
	end
 return 0
  go
---------------------------------------uspDeleteQueues-------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
-------------- QueuedMessages --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit QueuedMessages -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditQueuedMessages')
	drop proc uspEditQueuedMessages
go

create proc uspEditQueuedMessages(
@VisitNo Varchar(20),
@ServicePointID varchar(10),
@RoomNameID varchar(40),
@TokenNo Varchar(20),
@ReadCount int,
@LoginID Varchar(20),
@ClientMachine Varchar(40),
@RecordDateTime SmallDateTime
)with encryption as

declare @ErrorMSG varchar(200)
declare @BranchID varchar(10)
set @BranchID = dbo.GetMyCurrentBranch(@LoginID)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ServicePointID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Service Point No', @ServicePointID, 'Lookup Data')
		return 1
	end

if exists(select VisitNo from QueuedMessages where VisitNo = @VisitNo and BranchID = @BranchID and ServicePointID = @ServicePointID)
	begin
	if @ReadCount>0
	 begin
		update QueuedMessages set
		ReadCount=@ReadCount, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
		where VisitNo = @VisitNo and BranchID = @BranchID and ServicePointID = @ServicePointID

	  end 
	  else
	  begin
		update QueuedMessages set RoomNameID=@RoomNameID,
		ReadCount=@ReadCount, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
		where VisitNo = @VisitNo and BranchID = @BranchID and ServicePointID = @ServicePointID

	  end 

	end

else 
begin
insert into QueuedMessages
(VisitNo, BranchID, RoomNameID,ServicePointID, TokenNo,ReadCount, LoginID, ClientMachine, RecordDateTime)
values
(@VisitNo, @BranchID, @RoomNameID, @ServicePointID, @TokenNo, @ReadCount, @LoginID, @ClientMachine, @RecordDateTime)

end
return 0
go

/******************************************************************************************************
exec uspInsertQueuedMessages
******************************************************************************************************/
-- select * from QueuedMessages
-- delete from QueuedMessages


-------------- Get QueuedMessages -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetQueuedMessages')
	drop proc uspGetQueuedMessages
go

create proc uspGetQueuedMessages(
@VisitNo Varchar(20),
@BranchID Varchar(10),
@ServicePointID varchar(10),
@TokenNo Varchar(20)=null
)with encryption as

declare @ErrorMSG varchar(200)
declare @RecordDate smalldatetime
set @RecordDate = dateadd(minute, -12, getdate())
if not exists(select VisitNo from QueuedMessages where VisitNo = @VisitNo and BranchID = @BranchID and ServicePointID = @ServicePointID and TokenNo = @TokenNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Branch ID', @BranchID, 'Service Point No', @ServicePointID, 'Token No', @TokenNo, 'QueuedMessages')
		return 1
	end
else
begin


	select VisitNo, BranchID, RoomNameID,dbo.GetLookupDataDes(RoomNameID) as RoomName,ServicePointID, TokenNo,  ReadCount LoginID, ClientMachine, RecordDateTime
	from QueuedMessages

	where VisitNo = @VisitNo and BranchID = @BranchID and ServicePointID = @ServicePointID and TokenNo = @TokenNo  and RecordDateTime>=@RecordDate
return 0
end
go

/******************************************************************************************************
exec uspGetQueuedMessages
******************************************************************************************************/
-- select * from QueuedMessages
-- delete from QueuedMessages

-------------- uspGetUnReadQueuedMessages -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetUnReadQueuedMessages')
	drop proc uspGetUnReadQueuedMessages
go

create proc uspGetUnReadQueuedMessages(
@ServicePointID varchar(10)=null,
@BranchID varchar(10),
@MaxReadCount int
)with encryption as
 
 declare @RecordDate smalldatetime
set @RecordDate = dateadd(minute, -12, getdate())

if not @ServicePointID is null or not @ServicePointID=''
begin
	select VisitNo, BranchID, RoomNameID, dbo.GetLookupDataDes(RoomNameID) as RoomName, ServicePointID, dbo.GetLookupDataDes(ServicePointID) as ServicePoint, TokenNo,  ReadCount, LoginID, ClientMachine, RecordDateTime
	from QueuedMessages

	where BranchID=@BranchID and ServicePointID=@ServicePointID and ReadCount<@MaxReadCount and RecordDateTime>=@RecordDate
end
else
begin
  select VisitNo, BranchID,RoomNameID,dbo.GetLookupDataDes(RoomNameID) as RoomName, ServicePointID,dbo.GetLookupDataDes(ServicePointID) as ServicePoint, TokenNo, ReadCount, LoginID, ClientMachine, RecordDateTime
	from QueuedMessages

	where BranchID=@BranchID and ReadCount<@MaxReadCount and RecordDateTime>=@RecordDate
	end
return 0
go
/******************************************************************************************************
exec uspGetUnReadQueuedMessages '16DOC','177NA',7
******************************************************************************************************/
-- select * from QueuedMessages
-- delete from QueuedMessages
---------------------To Get Voucher Payment Details -----------------------------------------------------

if exists (select * from sysobjects where name = 'uspToGetVoucherPaymentDetails')
	drop proc uspToGetVoucherPaymentDetails
go

create proc uspToGetVoucherPaymentDetails(
@StaffNo varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null,
@ItemCategoryID varchar(400),
@BillModesID varchar(10),
@VisitTypeID varchar(10),
@ItemStatusID varchar(10),
@AccountNo varchar(20),
@CompanyNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ApprovedID as varchar(10)
declare @OfferedItemStatus as varchar(10)
declare @DoneItemStatus as varchar(10)
declare @ProcessingItemStatus as varchar(10)
declare @IPDVisitTypeID as varchar(10)
declare @OPDVisitTypeID as varchar(10)
declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

-------------------------------------------------------------------------------------

set @ApprovedID =  dbo.GetLookupDataID('ClaimStatus', 'AP')
set @OfferedItemStatus = dbo.GetLookupDataID('ItemStatus', 'O')
set @DoneItemStatus = dbo.GetLookupDataID('ItemStatus', 'D')
set @ProcessingItemStatus = dbo.GetLookupDataID('ItemStatus', 'D')
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')
set @OPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')

-------------------------------------------------------------------------------------

-------------------------------------------------------------------------------------


if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to update does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')	
		return 1
	end
else

begin
	if((@BillModesID is null or @BillModesID = ''))
		Begin
			if(@ItemStatusID is null or @ItemStatusID = '')
								begin
									if(@VisitTypeID = @OPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
													  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
													  ,Items.ItemCode
													  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
													  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
													  ,Items.ItemDetails
													  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
													  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
													  ,Items.Quantity
													  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
													  ,items.LoginID
													  ,items.RecordDateTime
													  ,items.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from items 
												  inner join Visits on Items.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												  where 
												  --items.ItemStatusID = @ItemStatusID
												  DoctorVisits.StaffNo = @StaffNo
												  --and Visits.BillModesID = @BillModesID
												  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
												  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
												  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
												  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  
												return 0
												end
									if(@VisitTypeID = @IPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo, IPDDoctor.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,ExtraBills.StaffNo ,dbo.GetStaffName(ExtraBills.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
													  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
													  ,ExtraBillItems.ItemCode
													  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
													  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
													 -- ,ExtraBillItems.ItemDetails
													  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
													  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
													  ,ExtraBillItems.Quantity
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
													  ,ExtraBillItems.LoginID
													  ,ExtraBillItems.RecordDateTime
													  ,ExtraBillItems.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from ExtraBillItems
												  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  left join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBillItems.ExtraBillNo
												  left join IPDDoctor on extrabillsExt.RoundNo = IPDDoctor.RoundNo
												  where 
												  ExtraBills.StaffNo = @StaffNo	
												  --and Visits.BillModesID = @BillModesID
												  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
												  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
												  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
												  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
												  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  
												  union
												  
												  select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo,	ipditems.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
													  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
													  ,ExtraBillItems.ItemCode
													  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
													  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
													 -- ,ExtraBillItems.ItemDetails
													  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
													  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
													  ,ExtraBillItems.Quantity
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
													  ,ExtraBillItems.LoginID
													  ,ExtraBillItems.RecordDateTime
													  ,ExtraBillItems.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from ExtraBillItems
												  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
												  inner join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join IPDItems on IPDItems.RoundNo = extrabillsExt.RoundNo
												  inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
												  left join patients on visits.PatientNo = patients.patientNo
												  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												  where 
												  IPDDoctor.StaffNo = @StaffNo	
												  --and Visits.BillModesID = @BillModesID
												  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
												  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
												  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
												  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
												  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  
										return 0
										end
								end
					else if not(@ItemStatusID is null or @ItemStatusID = '')
								begin
						    		if(@VisitTypeID = @OPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
													  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
													  ,Items.ItemCode
													  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
													  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
													  ,Items.ItemDetails
													  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
													  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
													  ,Items.Quantity
													  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
													  ,items.LoginID
													  ,items.RecordDateTime
													  ,items.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName 
												  from items 
												  inner join Visits on Items.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												  where 
												  items.ItemStatusID = @ItemStatusID
												  and DoctorVisits.StaffNo = @StaffNo
												  --and Visits.BillModesID = @BillModesID
												  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
												  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
												  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
												  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  
												return 0
										end
									if(@VisitTypeID = @IPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, IPDitems.RoundNo, ExtraBills.ExtraBillNo,	dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
													  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
													  ,IPDItems.ItemCode
													  ,dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, IPDItems.ItemCategoryID
													  ,dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode) as ItemName
													  ,IPDItems.ItemDetails
													  ,dbo.GetLookupDataDes(IPDItems.ItemStatusID) as ItemStatus, IPDItems.ItemStatusID
													  ,dbo.GetLookupDataDes(IPDItems.PayStatusID) as PayStatus, IPDItems.PayStatusID
													  ,IPDItems.Quantity
													  ,dbo.FormatMoney(IPDItems.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(IPDItems.UnitPrice * IPDItems.Quantity) as TotalFee
													  ,IPDItems.LoginID
													  ,IPDItems.RecordDateTime
													  ,IPDItems.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from IPDItems
												  inner join extrabillsExt on extrabillsExt.RoundNo = IPDItems.RoundNo
												  inner join ExtraBills on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												   left  join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
												  where 
												  IPDitems.ItemStatusID not in (@DoneItemStatus, @OfferedItemStatus)
												  and IPDDoctor.StaffNo = @StaffNo		  
												  --and Visits.BillModesID = @BillModesID
												  and IPDItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, RoundNo, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
												  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
												  and IPDStaffPaymentDetails.ItemCategoryID = IPDitems.ItemCategoryID 
												  and IPDStaffPaymentDetails.itemCode = IPDitems.ItemCode  and ApprovalStatusID = @ApprovedID))
												  and IPDItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												 return 0
										end
								end	
		end
		
	else if((@BillModesID = @CashBillModesID))
		Begin
			if(@ItemStatusID is null or @ItemStatusID = '')
								begin
										if(@VisitTypeID = @OPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
													  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
													  ,Items.ItemCode
													  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
													  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
													  ,Items.ItemDetails
													  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
													  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
													  ,Items.Quantity
													  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
													  ,items.LoginID
													  ,items.RecordDateTime
													  ,items.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from items 
												  inner join Visits on Items.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												  where 
												  --items.ItemStatusID = @ItemStatusID
												  DoctorVisits.StaffNo = @StaffNo
												  and Visits.BillModesID = @BillModesID
												  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
												  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
												  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
												  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  
												return 0
												end
										
									    if(@VisitTypeID = @IPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo, IPDDoctor.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,ExtraBills.StaffNo ,dbo.GetStaffName(ExtraBills.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
													  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
													  ,ExtraBillItems.ItemCode
													  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
													  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
													 -- ,ExtraBillItems.ItemDetails
													  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
													  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
													  ,ExtraBillItems.Quantity
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
													  ,ExtraBillItems.LoginID
													  ,ExtraBillItems.RecordDateTime
													  ,ExtraBillItems.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from ExtraBillItems
												  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  left join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBillItems.ExtraBillNo
												  left join IPDDoctor on extrabillsExt.RoundNo = IPDDoctor.RoundNo
												  where 
												  ExtraBills.StaffNo = @StaffNo	
												  and Visits.BillModesID = @BillModesID
												  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
												  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
												  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
												  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
												  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  
												  union
												  
												  select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo,	ipditems.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
													  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
													  ,ExtraBillItems.ItemCode
													  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
													  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
													 -- ,ExtraBillItems.ItemDetails
													  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
													  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
													  ,ExtraBillItems.Quantity
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
													  ,ExtraBillItems.LoginID
													  ,ExtraBillItems.RecordDateTime
													  ,ExtraBillItems.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from ExtraBillItems
												  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
												  inner join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join IPDItems on IPDItems.RoundNo = extrabillsExt.RoundNo
												  inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
												  left join patients on visits.PatientNo = patients.patientNo
												  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												  where 
												  IPDDoctor.StaffNo = @StaffNo	
												  and Visits.BillModesID = @BillModesID
												  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
												  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
												  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
												  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
												  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  
										return 0
										end
								end
					else if not(@ItemStatusID is null or @ItemStatusID = '')
								begin
										if(@VisitTypeID = @OPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
													  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
													  ,Items.ItemCode
													  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
													  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
													  ,Items.ItemDetails
													  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
													  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
													  ,Items.Quantity
													  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
													  ,items.LoginID
													  ,items.RecordDateTime
													  ,items.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName 
												  from items 
												  inner join Visits on Items.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												  where 
												  items.ItemStatusID = @ItemStatusID
												  and DoctorVisits.StaffNo = @StaffNo
												  and Visits.BillModesID = @BillModesID
												  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
												  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
												  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
												  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  
												return 0
										end
								if(@VisitTypeID = @IPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, IPDitems.RoundNo, ExtraBills.ExtraBillNo,	dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
													  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
													  ,IPDItems.ItemCode
													  ,dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, IPDItems.ItemCategoryID
													  ,dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode) as ItemName
													  ,IPDItems.ItemDetails
													  ,dbo.GetLookupDataDes(IPDItems.ItemStatusID) as ItemStatus, IPDItems.ItemStatusID
													  ,dbo.GetLookupDataDes(IPDItems.PayStatusID) as PayStatus, IPDItems.PayStatusID
													  ,IPDItems.Quantity
													  ,dbo.FormatMoney(IPDItems.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(IPDItems.UnitPrice * IPDItems.Quantity) as TotalFee
													  ,IPDItems.LoginID
													  ,IPDItems.RecordDateTime
													  ,IPDItems.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from IPDItems
												  inner join extrabillsExt on extrabillsExt.RoundNo = IPDItems.RoundNo
												  inner join ExtraBills on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												   left  join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
												  where 
												  IPDitems.ItemStatusID not in (@DoneItemStatus, @OfferedItemStatus)
												  and IPDDoctor.StaffNo = @StaffNo		  
												  and Visits.BillModesID = @BillModesID
												  and IPDItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, RoundNo, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
												  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
												  and IPDStaffPaymentDetails.ItemCategoryID = IPDitems.ItemCategoryID 
												  and IPDStaffPaymentDetails.itemCode = IPDitems.ItemCode  and ApprovalStatusID = @ApprovedID))
												  and IPDItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												 return 0
										end
								end	
		end
		
	else if((@BillModesID = @AccountBillModesID))
		begin
			if not(@AccountNo is null or @AccountNo = '')
			begin
				if(@ItemStatusID is null or @ItemStatusID = '')
							begin
									if(@VisitTypeID = @OPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
												  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
												  ,Items.ItemCode
												  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
												  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
												  ,Items.ItemDetails
												  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
												  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
												  ,Items.Quantity
												  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
												  ,items.LoginID
												  ,items.RecordDateTime
												  ,items.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from items 
											  inner join Visits on Items.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											  where 
											  --items.ItemStatusID = @ItemStatusID
											  DoctorVisits.StaffNo = @StaffNo
											  and Visits.BillModesID = @BillModesID
											  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
											  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
											  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
											  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
											return 0
									end
											
									if(@VisitTypeID = @IPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo, IPDDoctor.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,ExtraBills.StaffNo ,dbo.GetStaffName(ExtraBills.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
												  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
												  ,ExtraBillItems.ItemCode
												  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
												  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
												 -- ,ExtraBillItems.ItemDetails
												  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
												  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
												  ,ExtraBillItems.Quantity
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
												  ,ExtraBillItems.LoginID
												  ,ExtraBillItems.RecordDateTime
												  ,ExtraBillItems.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from ExtraBillItems
											  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  left join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBillItems.ExtraBillNo
											  left join IPDDoctor on extrabillsExt.RoundNo = IPDDoctor.RoundNo
											  where 
											  ExtraBills.StaffNo = @StaffNo	
											  and Visits.BillModesID = @BillModesID
											  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
											  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
											  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
											  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
											  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID  
											  union
											  
											  select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo,	ipditems.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
												  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
												  ,ExtraBillItems.ItemCode
												  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
												  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
												 -- ,ExtraBillItems.ItemDetails
												  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
												  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
												  ,ExtraBillItems.Quantity
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
												  ,ExtraBillItems.LoginID
												  ,ExtraBillItems.RecordDateTime
												  ,ExtraBillItems.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from ExtraBillItems
											  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
											  inner join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join IPDItems on IPDItems.RoundNo = extrabillsExt.RoundNo
											  inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
											  left join patients on visits.PatientNo = patients.patientNo
											  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											  where 
											  IPDDoctor.StaffNo = @StaffNo	
											  and Visits.BillModesID = @BillModesID
											  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
											  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
											  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
											  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
											  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
									return 0
									end
							end
				else if not(@ItemStatusID is null or @ItemStatusID = '')
							begin
									if(@VisitTypeID = @OPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
												  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
												  ,Items.ItemCode
												  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
												  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
												  ,Items.ItemDetails
												  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
												  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
												  ,Items.Quantity
												  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
												  ,items.LoginID
												  ,items.RecordDateTime
												  ,items.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from items 
											  inner join Visits on Items.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											  where 
											  items.ItemStatusID = @ItemStatusID
											  and DoctorVisits.StaffNo = @StaffNo
											  and Visits.BillModesID = @BillModesID
											  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
											  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
											  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
											  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
											  return 0
									end
									if(@VisitTypeID = @IPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, IPDitems.RoundNo, ExtraBills.ExtraBillNo,	dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
												  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
												  ,IPDItems.ItemCode
												  ,dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, IPDItems.ItemCategoryID
												  ,dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode) as ItemName
												  ,IPDItems.ItemDetails
												  ,dbo.GetLookupDataDes(IPDItems.ItemStatusID) as ItemStatus, IPDItems.ItemStatusID
												  ,dbo.GetLookupDataDes(IPDItems.PayStatusID) as PayStatus, IPDItems.PayStatusID
												  ,IPDItems.Quantity
												  ,dbo.FormatMoney(IPDItems.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(IPDItems.UnitPrice * IPDItems.Quantity) as TotalFee
												  ,IPDItems.LoginID
												  ,IPDItems.RecordDateTime
												  ,IPDItems.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from IPDItems
											  inner join extrabillsExt on extrabillsExt.RoundNo = IPDItems.RoundNo
											  inner join ExtraBills on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											   left  join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
											  where 
											  IPDitems.ItemStatusID not in (@DoneItemStatus, @OfferedItemStatus)
											  and IPDDoctor.StaffNo = @StaffNo		  
											  and Visits.BillModesID = @BillModesID
											  and IPDItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, RoundNo, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
											  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
											  and IPDStaffPaymentDetails.ItemCategoryID = IPDitems.ItemCategoryID 
											  and IPDStaffPaymentDetails.itemCode = IPDitems.ItemCode  and ApprovalStatusID = @ApprovedID))
											  and IPDItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
									return 0
									end
							end	
			end				
			else if	(@AccountNo is null or @AccountNo = '')	
			begin
				if(@ItemStatusID is null or @ItemStatusID = '')
							begin
									if(@VisitTypeID = @OPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
												  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
												  ,Items.ItemCode
												  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
												  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
												  ,Items.ItemDetails
												  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
												  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
												  ,Items.Quantity
												  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
												  ,items.LoginID
												  ,items.RecordDateTime
												  ,items.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from items 
											  inner join Visits on Items.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											  where 
											  --items.ItemStatusID = @ItemStatusID
											  DoctorVisits.StaffNo = @StaffNo
											  and Visits.BillModesID = @BillModesID
											  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
											  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
											  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
											  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  --and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
											return 0
									end
											
									if(@VisitTypeID = @IPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo, IPDDoctor.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,ExtraBills.StaffNo ,dbo.GetStaffName(ExtraBills.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
												  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
												  ,ExtraBillItems.ItemCode
												  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
												  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
												 -- ,ExtraBillItems.ItemDetails
												  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
												  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
												  ,ExtraBillItems.Quantity
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
												  ,ExtraBillItems.LoginID
												  ,ExtraBillItems.RecordDateTime
												  ,ExtraBillItems.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from ExtraBillItems
											  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  left join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBillItems.ExtraBillNo
											  left join IPDDoctor on extrabillsExt.RoundNo = IPDDoctor.RoundNo
											  where 
											  ExtraBills.StaffNo = @StaffNo	
											  and Visits.BillModesID = @BillModesID
											  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
											  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
											  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
											  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
											  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  --and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID  
											  union
											  
											  select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo,	ipditems.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
												  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
												  ,ExtraBillItems.ItemCode
												  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
												  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
												 -- ,ExtraBillItems.ItemDetails
												  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
												  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
												  ,ExtraBillItems.Quantity
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
												  ,ExtraBillItems.LoginID
												  ,ExtraBillItems.RecordDateTime
												  ,ExtraBillItems.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from ExtraBillItems
											  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
											  inner join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join IPDItems on IPDItems.RoundNo = extrabillsExt.RoundNo
											  inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
											  left join patients on visits.PatientNo = patients.patientNo
											  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											  where 
											  IPDDoctor.StaffNo = @StaffNo	
											  and Visits.BillModesID = @BillModesID
											  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
											  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
											  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
											  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
											  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  --and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
									return 0
									end
							end
				else if not(@ItemStatusID is null or @ItemStatusID = '')
							begin
									if(@VisitTypeID = @OPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
												  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
												  ,Items.ItemCode
												  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
												  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
												  ,Items.ItemDetails
												  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
												  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
												  ,Items.Quantity
												  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
												  ,items.LoginID
												  ,items.RecordDateTime
												  ,items.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from items 
											  inner join Visits on Items.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											  where 
											  items.ItemStatusID = @ItemStatusID
											  and DoctorVisits.StaffNo = @StaffNo
											  and Visits.BillModesID = @BillModesID
											  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
											  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
											  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
											  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  --and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
											  return 0
									end
									if(@VisitTypeID = @IPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, IPDitems.RoundNo, ExtraBills.ExtraBillNo,	dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
												  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
												  ,IPDItems.ItemCode
												  ,dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, IPDItems.ItemCategoryID
												  ,dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode) as ItemName
												  ,IPDItems.ItemDetails
												  ,dbo.GetLookupDataDes(IPDItems.ItemStatusID) as ItemStatus, IPDItems.ItemStatusID
												  ,dbo.GetLookupDataDes(IPDItems.PayStatusID) as PayStatus, IPDItems.PayStatusID
												  ,IPDItems.Quantity
												  ,dbo.FormatMoney(IPDItems.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(IPDItems.UnitPrice * IPDItems.Quantity) as TotalFee
												  ,IPDItems.LoginID
												  ,IPDItems.RecordDateTime
												  ,IPDItems.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from IPDItems
											  inner join extrabillsExt on extrabillsExt.RoundNo = IPDItems.RoundNo
											  inner join ExtraBills on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											   left  join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
											  where 
											  IPDitems.ItemStatusID not in (@DoneItemStatus, @OfferedItemStatus)
											  and IPDDoctor.StaffNo = @StaffNo		  
											  and Visits.BillModesID = @BillModesID
											  and IPDItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, RoundNo, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
											  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
											  and IPDStaffPaymentDetails.ItemCategoryID = IPDitems.ItemCategoryID 
											  and IPDStaffPaymentDetails.itemCode = IPDitems.ItemCode  and ApprovalStatusID = @ApprovedID))
											  and IPDItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  --and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
									return 0
									end
							end	
			end		
		end
		
	else if((@BillModesID = @InsuranceBillModesID))
		Begin
			if not(@CompanyNo is null or @CompanyNo ='')
				begin
					if(@ItemStatusID is null or @ItemStatusID = '')
									begin
											if(@VisitTypeID = @OPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName
														  ,patients.GenderID, dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
														  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
														  ,Items.ItemCode
														  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
														  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
														  ,Items.ItemDetails
														  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
														  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
														  ,Items.Quantity
														  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
														  ,items.LoginID
														  ,items.RecordDateTime
														  ,items.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
										    			  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from items 
													  inner join Visits on Items.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													  --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  --items.ItemStatusID = @ItemStatusID
													  DoctorVisits.StaffNo = @StaffNo
													  and Visits.BillModesID = @BillModesID
													  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
													  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
													  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
													  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													return 0
											end
													
											else if(@VisitTypeID = @IPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo, IPDDoctor.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID
														  ,dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,ExtraBills.StaffNo ,dbo.GetStaffName(ExtraBills.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
														  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
														  ,ExtraBillItems.ItemCode
														  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
														  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
														 -- ,ExtraBillItems.ItemDetails
														  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
														  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
														  ,ExtraBillItems.Quantity
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
														  ,ExtraBillItems.LoginID
														  ,ExtraBillItems.RecordDateTime
														  ,ExtraBillItems.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from ExtraBillItems
													  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  left join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBillItems.ExtraBillNo
													  left join IPDDoctor on extrabillsExt.RoundNo = IPDDoctor.RoundNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													  --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  ExtraBills.StaffNo = @StaffNo	
													  and Visits.BillModesID = @BillModesID
													  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
													  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
													  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
													  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
													  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
											  			  --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													  union
													  
													  select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo,	ipditems.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID
														  ,dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
														  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
														  ,ExtraBillItems.ItemCode
														  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
														  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
														 -- ,ExtraBillItems.ItemDetails
														  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
														  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
														  ,ExtraBillItems.Quantity
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
														  ,ExtraBillItems.LoginID
														  ,ExtraBillItems.RecordDateTime
														  ,ExtraBillItems.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from ExtraBillItems
													  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
													  inner join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join IPDItems on IPDItems.RoundNo = extrabillsExt.RoundNo
													  inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
													  left join patients on visits.PatientNo = patients.patientNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													  --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  IPDDoctor.StaffNo = @StaffNo	
													  and Visits.BillModesID = @BillModesID
													  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
													  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
													  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
													  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
													  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.BillModesID = @CashBillModesID
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
											  			  --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													 return 0
											end
									end
					else if not(@ItemStatusID is null or @ItemStatusID = '')
									begin
											if(@VisitTypeID = @OPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID
														  ,dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
														  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
														  ,Items.ItemCode
														  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
														  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
														  ,Items.ItemDetails
														  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
														  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
														  ,Items.Quantity
														  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
														  ,items.LoginID
														  ,items.RecordDateTime
														  ,items.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from items 
													  inner join Visits on Items.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													  --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  items.ItemStatusID = @ItemStatusID
													  and DoctorVisits.StaffNo = @StaffNo
													  and Visits.BillModesID = @BillModesID
													  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
													  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
													  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
													  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
														--new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													return 0
											end
											if(@VisitTypeID = @IPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, IPDitems.RoundNo, ExtraBills.ExtraBillNo,	dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID, dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
														  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
														  ,IPDItems.ItemCode
														  ,dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, IPDItems.ItemCategoryID
														  ,dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode) as ItemName
														  ,IPDItems.ItemDetails
														  ,dbo.GetLookupDataDes(IPDItems.ItemStatusID) as ItemStatus, IPDItems.ItemStatusID
														  ,dbo.GetLookupDataDes(IPDItems.PayStatusID) as PayStatus, IPDItems.PayStatusID
														  ,IPDItems.Quantity
														  ,dbo.FormatMoney(IPDItems.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(IPDItems.UnitPrice * IPDItems.Quantity) as TotalFee
														  ,IPDItems.LoginID
														  ,IPDItems.RecordDateTime
														  ,IPDItems.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from IPDItems
													  inner join extrabillsExt on extrabillsExt.RoundNo = IPDItems.RoundNo
													  inner join ExtraBills on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
													   left  join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
													   --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													  --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  IPDitems.ItemStatusID not in (@DoneItemStatus, @OfferedItemStatus)
													  and IPDDoctor.StaffNo = @StaffNo		  
													  and Visits.BillModesID = @BillModesID
													  and IPDItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, RoundNo, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
													  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
													  and IPDStaffPaymentDetails.ItemCategoryID = IPDitems.ItemCategoryID 
													  and IPDStaffPaymentDetails.itemCode = IPDitems.ItemCode  and ApprovalStatusID = @ApprovedID))
													  and IPDItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
														--new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													 return 0
											end
									end	
				end	
			else if (@CompanyNo is null or @CompanyNo ='')
				begin
					if(@ItemStatusID is null or @ItemStatusID = '')
									begin
											if(@VisitTypeID = @OPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName
														  ,patients.GenderID, dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
														  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
														  ,Items.ItemCode
														  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
														  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
														  ,Items.ItemDetails
														  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
														  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
														  ,Items.Quantity
														  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
														  ,items.LoginID
														  ,items.RecordDateTime
														  ,items.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
										    			  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from items 
													  inner join Visits on Items.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
														--new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  --items.ItemStatusID = @ItemStatusID
													  DoctorVisits.StaffNo = @StaffNo
													  and Visits.BillModesID = @BillModesID
													  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
													  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
													  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
													  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
														 --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  --and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													return 0
											end
													
											if(@VisitTypeID = @IPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo, IPDDoctor.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID
														  ,dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,ExtraBills.StaffNo ,dbo.GetStaffName(ExtraBills.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
														  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
														  ,ExtraBillItems.ItemCode
														  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
														  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
														 -- ,ExtraBillItems.ItemDetails
														  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
														  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
														  ,ExtraBillItems.Quantity
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
														  ,ExtraBillItems.LoginID
														  ,ExtraBillItems.RecordDateTime
														  ,ExtraBillItems.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from ExtraBillItems
													  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  left join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBillItems.ExtraBillNo
													  left join IPDDoctor on extrabillsExt.RoundNo = IPDDoctor.RoundNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
														 --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  ExtraBills.StaffNo = @StaffNo	
													  and Visits.BillModesID = @BillModesID
													  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
													  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
													  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
													  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
													  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
														 --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  --and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													  union
													  
													  select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo,	ipditems.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID
														  ,dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
														  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
														  ,ExtraBillItems.ItemCode
														  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
														  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
														 -- ,ExtraBillItems.ItemDetails
														  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
														  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
														  ,ExtraBillItems.Quantity
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
														  ,ExtraBillItems.LoginID
														  ,ExtraBillItems.RecordDateTime
														  ,ExtraBillItems.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from ExtraBillItems
													  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
													  inner join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join IPDItems on IPDItems.RoundNo = extrabillsExt.RoundNo
													  inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
													  left join patients on visits.PatientNo = patients.patientNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													   --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  IPDDoctor.StaffNo = @StaffNo	
													  and Visits.BillModesID = @BillModesID
													  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
													  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
													  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
													  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
													  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.BillModesID = @CashBillModesID
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
													  --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  --and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													 return 0
											end
									end
					else if not(@ItemStatusID is null or @ItemStatusID = '')
									begin
											if(@VisitTypeID = @OPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID
														  ,dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
														  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
														  ,Items.ItemCode
														  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
														  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
														  ,Items.ItemDetails
														  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
														  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
														  ,Items.Quantity
														  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
														  ,items.LoginID
														  ,items.RecordDateTime
														  ,items.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from items 
													  inner join Visits on Items.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													   --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  items.ItemStatusID = @ItemStatusID
													  and DoctorVisits.StaffNo = @StaffNo
													  and Visits.BillModesID = @BillModesID
													  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
													  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
													  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
													  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
													   --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  --and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													return 0
											end
											if(@VisitTypeID = @IPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, IPDitems.RoundNo, ExtraBills.ExtraBillNo,	dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID, dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
														  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
														  ,IPDItems.ItemCode
														  ,dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, IPDItems.ItemCategoryID
														  ,dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode) as ItemName
														  ,IPDItems.ItemDetails
														  ,dbo.GetLookupDataDes(IPDItems.ItemStatusID) as ItemStatus, IPDItems.ItemStatusID
														  ,dbo.GetLookupDataDes(IPDItems.PayStatusID) as PayStatus, IPDItems.PayStatusID
														  ,IPDItems.Quantity
														  ,dbo.FormatMoney(IPDItems.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(IPDItems.UnitPrice * IPDItems.Quantity) as TotalFee
														  ,IPDItems.LoginID
														  ,IPDItems.RecordDateTime
														  ,IPDItems.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from IPDItems
													  inner join extrabillsExt on extrabillsExt.RoundNo = IPDItems.RoundNo
													  inner join ExtraBills on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
													   left  join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
													   --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
														--new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  IPDitems.ItemStatusID not in (@DoneItemStatus, @OfferedItemStatus)
													  and IPDDoctor.StaffNo = @StaffNo		  
													  and Visits.BillModesID = @BillModesID
													  and IPDItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, RoundNo, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
													  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
													  and IPDStaffPaymentDetails.ItemCategoryID = IPDitems.ItemCategoryID 
													  and IPDStaffPaymentDetails.itemCode = IPDitems.ItemCode  and ApprovalStatusID = @ApprovedID))
													  and IPDItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
													   --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  --and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													 return 0
											end
									end	
				end
		end	  
end	

go

/*
select * from staffPayments
exec uspToGetVoucherPaymentDetails 'SUR0016', '2016-06-01', '2016-12-30'
exec uspToGetVoucherPaymentDetails 'MHIN/63', '2016-03-10 07:30:00', '2016-03-10 22:29:00'
exec uspToGetVoucherPaymentDetails 'MHIN/63', '2016-01-01 07:30:00', '2016-12-31 22:29:00', '7s', '17c', '110IPD' 
exec uspToGetVoucherPaymentDetails 'MHIN/63', '2016-01-01 07:30:00', '2016-12-10 22:29:00', '7s', '17c', '110OPD' 
exec uspToGetVoucherPaymentDetails 'MHIN/63', '2015-01-01 07:30:00', '2016-12-10 22:29:00', '7s,7d,7c', '17c', '110OPD' 
exec uspToGetVoucherPaymentDetails 'MHIN/63', '2016-01-01 07:30:00', '2016-12-10 22:29:00', '7s', '17c', '110OPD' 
exec uspToGetVoucherPaymentDetails 'MHIN/63', '2016-01-01 07:30:00', '2016-12-10 22:29:00', '$(7s','7d)', '17c', '110OPD' 
exec uspToGetVoucherPaymentDetails 'MHIN/63', '2013-01-01 07:30:00', '2016-12-10 22:29:00', '7d', '17c', '110OPD', '11o','A13253',''
exec uspToGetVoucherPaymentDetails 'MHIN/63', '2013-01-01 07:30:00', '2016-12-10 22:29:00', '7d,7s,7c', '17A', '110IPD', '11o','UAP',''
exec uspToGetVoucherPaymentDetails 'MHIN/63', '2013-01-01 07:30:00', '2016-12-10 22:29:00', '7d,7s,7c', '17C', '110IPD', '11o','',''
exec uspToGetVoucherPaymentDetails 'MHIN/005','2013-01-01 07:30:00', '2017-12-10 22:29:00', '7d,7s,7c', '17A', '110IPD', '','I14001',''
exec uspToGetVoucherPaymentDetails 'MH/334', '2015-01-01 07:30:00', '2017-12-10 22:29:00', '7d,7s,7c', '17A', '110OPD', '11P','','A130200'

exec uspToGetVoucherPaymentDetails 'MHIN/63', '2015-01-01 07:30:00', '2017-12-10 22:29:00', '7d,7s,7c', '17i', '110IPD', '11O','I14001',''
exec uspToGetVoucherPaymentDetails 'MHIN/63', '2013-01-01 07:30:00', '2017-12-10 22:29:00', '7d,7s,7c', '17A', '110OPD', '','','A130200'
*/


---------------------To Get Voucher Payment Details extra-----------------------------------------------------

if exists (select * from sysobjects where name = 'uspToGetVoucherPaymentDetailsExt')
	drop proc uspToGetVoucherPaymentDetailsExt
go

create proc uspToGetVoucherPaymentDetailsExt(
@StaffNo varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null,
@ItemCategoryID varchar(400),
@BillModesID varchar(10),
@VisitTypeID varchar(10),
@ItemStatusID varchar(10),
@AccountNo varchar(20),
@CompanyNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ApprovedID as varchar(10)
declare @OfferedItemStatus as varchar(10)
declare @DoneItemStatus as varchar(10)
declare @ProcessingItemStatus as varchar(10)
declare @IPDVisitTypeID as varchar(10)
declare @OPDVisitTypeID as varchar(10)
declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

-------------------------------------------------------------------------------------

set @ApprovedID =  dbo.GetLookupDataID('ClaimStatus', 'AP')
set @OfferedItemStatus = dbo.GetLookupDataID('ItemStatus', 'O')
set @DoneItemStatus = dbo.GetLookupDataID('ItemStatus', 'D')
set @ProcessingItemStatus = dbo.GetLookupDataID('ItemStatus', 'D')
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')
set @OPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')

-------------------------------------------------------------------------------------

-------------------------------------------------------------------------------------


if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to looking for does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')	
		return 1
	end
else

begin
	if((@BillModesID is null or @BillModesID = ''))
		Begin
			if(@ItemStatusID is null or @ItemStatusID = '')
								begin
									if(@VisitTypeID = @OPDVisitTypeID)
										begin
												select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
													  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
													  ,Items.ItemCode
													  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
													  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
													  ,Items.ItemDetails
													  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
													  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
													  ,Items.Quantity
													  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
													  ,items.LoginID
													  ,items.RecordDateTime
													  ,items.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from items 
												  inner join Visits on Items.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												  where 
												  items.LoginID = dbo.GetStaffLoginID(@StaffNo)
												  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
												  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
												  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
												  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												 					  
												return 0
										end
									if(@VisitTypeID = @IPDVisitTypeID)
										begin
												select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo, IPDDoctor.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,ExtraBills.StaffNo ,dbo.GetStaffName(ExtraBills.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
													  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
													  ,ExtraBillItems.ItemCode
													  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
													  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
													 -- ,ExtraBillItems.ItemDetails
													  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
													  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
													  ,ExtraBillItems.Quantity
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
													  ,ExtraBillItems.LoginID
													  ,ExtraBillItems.RecordDateTime
													  ,ExtraBillItems.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from ExtraBillItems
												  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  left join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBillItems.ExtraBillNo
												  left join IPDDoctor on extrabillsExt.RoundNo = IPDDoctor.RoundNo
												  where 
												  --ExtraBills.StaffNo = @StaffNo	
												  ExtraBills.LoginID = dbo.GetStaffLoginID(@StaffNo)
												  --and Visits.BillModesID = @BillModesID
												  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
												  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
												  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
												  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
												  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  
												  union
												  
												  select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo,	ipditems.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
													  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
													  ,ExtraBillItems.ItemCode
													  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
													  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
													 -- ,ExtraBillItems.ItemDetails
													  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
													  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
													  ,ExtraBillItems.Quantity
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
													  ,ExtraBillItems.LoginID
													  ,ExtraBillItems.RecordDateTime
													  ,ExtraBillItems.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from ExtraBillItems
												  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
												  inner join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join IPDItems on IPDItems.RoundNo = extrabillsExt.RoundNo
												  inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
												  left join patients on visits.PatientNo = patients.patientNo
												  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												  where 
												  IPDItems.LoginID = dbo.GetStaffLoginID(@StaffNo)	
												  --and Visits.BillModesID = @BillModesID
												  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
												  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
												  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
												  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
												  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												return 0
										end
								end
			else if not(@ItemStatusID is null or @ItemStatusID = '')
								begin
						    		if(@VisitTypeID = @OPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
													  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
													  ,Items.ItemCode
													  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
													  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
													  ,Items.ItemDetails
													  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
													  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
													  ,Items.Quantity
													  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
													  ,items.LoginID
													  ,items.RecordDateTime
													  ,items.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName 
												  from items 
												  inner join Visits on Items.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												  where 
												  items.ItemStatusID = @ItemStatusID
												  --and DoctorVisits.StaffNo = @StaffNo
												  and items.loginid = dbo.GetStaffLoginID(@StaffNo)
												  --and Visits.BillModesID = @BillModesID
												  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
												  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
												  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
												  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  return 0
										end
									if(@VisitTypeID = @IPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, IPDitems.RoundNo, ExtraBills.ExtraBillNo,	dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
													  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
													  ,IPDItems.ItemCode
													  ,dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, IPDItems.ItemCategoryID
													  ,dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode) as ItemName
													  ,IPDItems.ItemDetails
													  ,dbo.GetLookupDataDes(IPDItems.ItemStatusID) as ItemStatus, IPDItems.ItemStatusID
													  ,dbo.GetLookupDataDes(IPDItems.PayStatusID) as PayStatus, IPDItems.PayStatusID
													  ,IPDItems.Quantity
													  ,dbo.FormatMoney(IPDItems.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(IPDItems.UnitPrice * IPDItems.Quantity) as TotalFee
													  ,IPDItems.LoginID
													  ,IPDItems.RecordDateTime
													  ,IPDItems.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from IPDItems
												  inner join extrabillsExt on extrabillsExt.RoundNo = IPDItems.RoundNo
												  inner join ExtraBills on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												   left  join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
												  where 
												  IPDitems.ItemStatusID not in (@DoneItemStatus, @OfferedItemStatus)
												  and IPDItems.LoginID = dbo.GetStaffLoginID(@StaffNo)												  	  
												  --and Visits.BillModesID = @BillModesID
												  and IPDItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, RoundNo, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
												  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
												  and IPDStaffPaymentDetails.ItemCategoryID = IPDitems.ItemCategoryID 
												  and IPDStaffPaymentDetails.itemCode = IPDitems.ItemCode  and ApprovalStatusID = @ApprovedID))
												  and IPDItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												 return 0
										end
								end	
		end
		
	else if((@BillModesID = @CashBillModesID))
		Begin
			if(@ItemStatusID is null or @ItemStatusID = '')
								begin
										if(@VisitTypeID = @OPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
													  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
													  ,Items.ItemCode
													  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
													  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
													  ,Items.ItemDetails
													  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
													  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
													  ,Items.Quantity
													  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
													  ,items.LoginID
													  ,items.RecordDateTime
													  ,items.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from items 
												  inner join Visits on Items.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												  where 
												  --items.ItemStatusID = @ItemStatusID
												  items.LoginID = dbo.GetStaffLoginID(@StaffNo)
												  and Visits.BillModesID = @BillModesID
												  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
												  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
												  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
												  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  
												return 0
												end
										
									    if(@VisitTypeID = @IPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo, IPDDoctor.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,ExtraBills.StaffNo ,dbo.GetStaffName(ExtraBills.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
													  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
													  ,ExtraBillItems.ItemCode
													  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
													  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
													 -- ,ExtraBillItems.ItemDetails
													  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
													  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
													  ,ExtraBillItems.Quantity
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
													  ,ExtraBillItems.LoginID
													  ,ExtraBillItems.RecordDateTime
													  ,ExtraBillItems.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from ExtraBillItems
												  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  left join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBillItems.ExtraBillNo
												  left join IPDDoctor on extrabillsExt.RoundNo = IPDDoctor.RoundNo
												  where 
												  ExtraBills.LoginID = dbo.GetStaffLoginID(@StaffNo)
												  and Visits.BillModesID = @BillModesID
												  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
												  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
												  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
												  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
												  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  
												  union
												  
												  select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo,	ipditems.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
													  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
													  ,ExtraBillItems.ItemCode
													  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
													  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
													 -- ,ExtraBillItems.ItemDetails
													  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
													  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
													  ,ExtraBillItems.Quantity
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
													  ,ExtraBillItems.LoginID
													  ,ExtraBillItems.RecordDateTime
													  ,ExtraBillItems.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from ExtraBillItems
												  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
												  inner join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join IPDItems on IPDItems.RoundNo = extrabillsExt.RoundNo
												  inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
												  left join patients on visits.PatientNo = patients.patientNo
												  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												  where 
												  IPDItems.LoginID = dbo.GetStaffLoginID(@StaffNo)
												  and Visits.BillModesID = @BillModesID
												  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
												  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
												  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
												  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
												  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  
										return 0
										end
								end
					else if not(@ItemStatusID is null or @ItemStatusID = '')
								begin
										if(@VisitTypeID = @OPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
													  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
													  ,Items.ItemCode
													  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
													  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
													  ,Items.ItemDetails
													  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
													  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
													  ,Items.Quantity
													  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
													  ,items.LoginID
													  ,items.RecordDateTime
													  ,items.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName 
												  from items 
												  inner join Visits on Items.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												  where 
												  items.ItemStatusID = @ItemStatusID
												  and items.LoginID = dbo.GetStaffLoginID(@StaffNo)
												  and Visits.BillModesID = @BillModesID
												  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
												  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
												  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
												  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												  
												return 0
										end
								if(@VisitTypeID = @IPDVisitTypeID)
										begin
												 select Visits.PatientNo, Visits.VisitNo, IPDitems.RoundNo, ExtraBills.ExtraBillNo,	dbo.FormatDate(visits.VisitDate) as VisitDate
													  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
													  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
													  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
													  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
													  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
													  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
													  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
													  ,IPDItems.ItemCode
													  ,dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, IPDItems.ItemCategoryID
													  ,dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode) as ItemName
													  ,IPDItems.ItemDetails
													  ,dbo.GetLookupDataDes(IPDItems.ItemStatusID) as ItemStatus, IPDItems.ItemStatusID
													  ,dbo.GetLookupDataDes(IPDItems.PayStatusID) as PayStatus, IPDItems.PayStatusID
													  ,IPDItems.Quantity
													  ,dbo.FormatMoney(IPDItems.UnitPrice) as UnitPrice
													  ,dbo.FormatMoney(IPDItems.UnitPrice * IPDItems.Quantity) as TotalFee
													  ,IPDItems.LoginID
													  ,IPDItems.RecordDateTime
													  ,IPDItems.ClientMachine
													  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
													  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
													  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
												  from IPDItems
												  inner join extrabillsExt on extrabillsExt.RoundNo = IPDItems.RoundNo
												  inner join ExtraBills on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
												  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
												  left join patients on visits.PatientNo = patients.patientNo
												  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
												   left  join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
												  where 
												  IPDitems.ItemStatusID not in (@DoneItemStatus, @OfferedItemStatus)
												  and IPDItems.LoginID = dbo.GetStaffLoginID(@StaffNo)		  
												  and Visits.BillModesID = @BillModesID
												  and IPDItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
												  and (not exists(select visitno, RoundNo, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
												  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
												  and IPDStaffPaymentDetails.ItemCategoryID = IPDitems.ItemCategoryID 
												  and IPDStaffPaymentDetails.itemCode = IPDitems.ItemCode  and ApprovalStatusID = @ApprovedID))
												  and IPDItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
												  --and Visits.InsuranceNo = @CompanyNo
												  --and Visits.BillModesID = @InsuranceBillModesID
												 return 0
										end
								end	
		end
		
	else if((@BillModesID = @AccountBillModesID))
		begin
			if not(@AccountNo is null or @AccountNo = '')
			begin
				if(@ItemStatusID is null or @ItemStatusID = '')
							begin
									if(@VisitTypeID = @OPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
												  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
												  ,Items.ItemCode
												  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
												  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
												  ,Items.ItemDetails
												  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
												  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
												  ,Items.Quantity
												  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
												  ,items.LoginID
												  ,items.RecordDateTime
												  ,items.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from items 
											  inner join Visits on Items.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											  where 
											  --items.ItemStatusID = @ItemStatusID
											  items.LoginID = dbo.GetStaffLoginID(@StaffNo)
											  and Visits.BillModesID = @BillModesID
											  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
											  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
											  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
											  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
											return 0
									end
											
									if(@VisitTypeID = @IPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo, IPDDoctor.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,ExtraBills.StaffNo ,dbo.GetStaffName(ExtraBills.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
												  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
												  ,ExtraBillItems.ItemCode
												  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
												  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
												 -- ,ExtraBillItems.ItemDetails
												  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
												  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
												  ,ExtraBillItems.Quantity
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
												  ,ExtraBillItems.LoginID
												  ,ExtraBillItems.RecordDateTime
												  ,ExtraBillItems.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from ExtraBillItems
											  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  left join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBillItems.ExtraBillNo
											  left join IPDDoctor on extrabillsExt.RoundNo = IPDDoctor.RoundNo
											  where 
											  ExtraBillItems.LoginID = dbo.GetStaffLoginID(@StaffNo)
											  and Visits.BillModesID = @BillModesID
											  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
											  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
											  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
											  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
											  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID  
											  union
											  
											  select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo,	ipditems.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
												  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
												  ,ExtraBillItems.ItemCode
												  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
												  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
												 -- ,ExtraBillItems.ItemDetails
												  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
												  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
												  ,ExtraBillItems.Quantity
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
												  ,ExtraBillItems.LoginID
												  ,ExtraBillItems.RecordDateTime
												  ,ExtraBillItems.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from ExtraBillItems
											  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
											  inner join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join IPDItems on IPDItems.RoundNo = extrabillsExt.RoundNo
											  inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
											  left join patients on visits.PatientNo = patients.patientNo
											  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											  where 
											  ipditems.LoginID = dbo.GetStaffLoginID(@StaffNo)
											  and Visits.BillModesID = @BillModesID
											  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
											  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
											  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
											  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
											  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
									return 0
									end
							end
				else if not(@ItemStatusID is null or @ItemStatusID = '')
							begin
									if(@VisitTypeID = @OPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
												  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
												  ,Items.ItemCode
												  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
												  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
												  ,Items.ItemDetails
												  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
												  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
												  ,Items.Quantity
												  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
												  ,items.LoginID
												  ,items.RecordDateTime
												  ,items.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from items 
											  inner join Visits on Items.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											  where 
											  items.ItemStatusID = @ItemStatusID
											  and items.LoginID = dbo.GetStaffLoginID(@StaffNo)
											  and Visits.BillModesID = @BillModesID
											  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
											  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
											  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
											  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
											  return 0
									end
									if(@VisitTypeID = @IPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, IPDitems.RoundNo, ExtraBills.ExtraBillNo,	dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
												  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
												  ,IPDItems.ItemCode
												  ,dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, IPDItems.ItemCategoryID
												  ,dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode) as ItemName
												  ,IPDItems.ItemDetails
												  ,dbo.GetLookupDataDes(IPDItems.ItemStatusID) as ItemStatus, IPDItems.ItemStatusID
												  ,dbo.GetLookupDataDes(IPDItems.PayStatusID) as PayStatus, IPDItems.PayStatusID
												  ,IPDItems.Quantity
												  ,dbo.FormatMoney(IPDItems.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(IPDItems.UnitPrice * IPDItems.Quantity) as TotalFee
												  ,IPDItems.LoginID
												  ,IPDItems.RecordDateTime
												  ,IPDItems.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from IPDItems
											  inner join extrabillsExt on extrabillsExt.RoundNo = IPDItems.RoundNo
											  inner join ExtraBills on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											   left  join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
											  where 
											  IPDitems.ItemStatusID not in (@DoneItemStatus, @OfferedItemStatus)
											  and ipditems.LoginID = dbo.GetStaffLoginID(@StaffNo)
											  and Visits.BillModesID = @BillModesID
											  and IPDItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, RoundNo, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
											  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
											  and IPDStaffPaymentDetails.ItemCategoryID = IPDitems.ItemCategoryID 
											  and IPDStaffPaymentDetails.itemCode = IPDitems.ItemCode  and ApprovalStatusID = @ApprovedID))
											  and IPDItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
									return 0
									end
							end	
			end				
			else if	(@AccountNo is null or @AccountNo = '')	
			begin
				if(@ItemStatusID is null or @ItemStatusID = '')
							begin
									if(@VisitTypeID = @OPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
												  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
												  ,Items.ItemCode
												  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
												  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
												  ,Items.ItemDetails
												  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
												  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
												  ,Items.Quantity
												  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
												  ,items.LoginID
												  ,items.RecordDateTime
												  ,items.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from items 
											  inner join Visits on Items.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											  where 
											  --items.ItemStatusID = @ItemStatusID
											  items.LoginID = dbo.GetStaffLoginID(@StaffNo)
											  and Visits.BillModesID = @BillModesID
											  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
											  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
											  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
											  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  --and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
											 return 0
									end
											
									if(@VisitTypeID = @IPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo, IPDDoctor.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,ExtraBills.StaffNo ,dbo.GetStaffName(ExtraBills.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
												  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
												  ,ExtraBillItems.ItemCode
												  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
												  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
												 -- ,ExtraBillItems.ItemDetails
												  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
												  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
												  ,ExtraBillItems.Quantity
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
												  ,ExtraBillItems.LoginID
												  ,ExtraBillItems.RecordDateTime
												  ,ExtraBillItems.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from ExtraBillItems
											  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  left join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBillItems.ExtraBillNo
											  left join IPDDoctor on extrabillsExt.RoundNo = IPDDoctor.RoundNo
											  where 
											  ExtraBillItems.LoginID = dbo.GetStaffLoginID(@StaffNo)
											  and Visits.BillModesID = @BillModesID
											  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
											  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
											  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
											  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
											  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  --and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID  
											  union
											  
											  select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo,	ipditems.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
												  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
												  ,ExtraBillItems.ItemCode
												  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
												  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
												 -- ,ExtraBillItems.ItemDetails
												  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
												  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
												  ,ExtraBillItems.Quantity
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
												  ,ExtraBillItems.LoginID
												  ,ExtraBillItems.RecordDateTime
												  ,ExtraBillItems.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from ExtraBillItems
											  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
											  inner join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join IPDItems on IPDItems.RoundNo = extrabillsExt.RoundNo
											  inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
											  left join patients on visits.PatientNo = patients.patientNo
											  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											  where 
											  IPDItems.LoginID = dbo.GetStaffLoginID(@StaffNo)
											  and Visits.BillModesID = @BillModesID
											  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
											  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
											  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
											  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
											  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  --and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
									return 0
									end
							end
				else if not(@ItemStatusID is null or @ItemStatusID = '')
							begin
									if(@VisitTypeID = @OPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
												  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
												  ,Items.ItemCode
												  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
												  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
												  ,Items.ItemDetails
												  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
												  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
												  ,Items.Quantity
												  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
												  ,items.LoginID
												  ,items.RecordDateTime
												  ,items.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from items 
											  inner join Visits on Items.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											  where 
											  items.ItemStatusID = @ItemStatusID
											  and items.LoginID = dbo.GetStaffLoginID(@StaffNo)
											  and Visits.BillModesID = @BillModesID
											  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
											  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
											  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
											  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  --and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
											  return 0
									end
									if(@VisitTypeID = @IPDVisitTypeID)
									begin
											 select Visits.PatientNo, Visits.VisitNo, IPDitems.RoundNo, ExtraBills.ExtraBillNo,	dbo.FormatDate(visits.VisitDate) as VisitDate
												  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
												  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
												  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
												  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
												  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
												  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
												  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
												  ,IPDItems.ItemCode
												  ,dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, IPDItems.ItemCategoryID
												  ,dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode) as ItemName
												  ,IPDItems.ItemDetails
												  ,dbo.GetLookupDataDes(IPDItems.ItemStatusID) as ItemStatus, IPDItems.ItemStatusID
												  ,dbo.GetLookupDataDes(IPDItems.PayStatusID) as PayStatus, IPDItems.PayStatusID
												  ,IPDItems.Quantity
												  ,dbo.FormatMoney(IPDItems.UnitPrice) as UnitPrice
												  ,dbo.FormatMoney(IPDItems.UnitPrice * IPDItems.Quantity) as TotalFee
												  ,IPDItems.LoginID
												  ,IPDItems.RecordDateTime
												  ,IPDItems.ClientMachine
												  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
												  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
												  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
											  from IPDItems
											  inner join extrabillsExt on extrabillsExt.RoundNo = IPDItems.RoundNo
											  inner join ExtraBills on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
											  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
											  left join patients on visits.PatientNo = patients.patientNo
											  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
											   left  join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
											  where 
											  IPDitems.ItemStatusID not in (@DoneItemStatus, @OfferedItemStatus)
											  and IPDItems.LoginID = dbo.GetStaffLoginID(@StaffNo)	  
											  and Visits.BillModesID = @BillModesID
											  and IPDItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
											  and (not exists(select visitno, RoundNo, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
											  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
											  and IPDStaffPaymentDetails.ItemCategoryID = IPDitems.ItemCategoryID 
											  and IPDStaffPaymentDetails.itemCode = IPDitems.ItemCode  and ApprovalStatusID = @ApprovedID))
											  and IPDItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
											  --and Visits.BillNo = @AccountNo
											  --and Visits.BillModesID = @AccountBillModesID
									return 0
									end
							end	
			end		
		end
		
	else if((@BillModesID = @InsuranceBillModesID))
		Begin
			if not(@CompanyNo is null or @CompanyNo ='')
				begin
					if(@ItemStatusID is null or @ItemStatusID = '')
									begin
											if(@VisitTypeID = @OPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName
														  ,patients.GenderID, dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
														  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
														  ,Items.ItemCode
														  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
														  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
														  ,Items.ItemDetails
														  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
														  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
														  ,Items.Quantity
														  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
														  ,items.LoginID
														  ,items.RecordDateTime
														  ,items.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
										    			  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from items 
													  inner join Visits on Items.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													  --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  --items.ItemStatusID = @ItemStatusID
													  Items.LoginID = dbo.GetStaffLoginID(@StaffNo)
													  and Visits.BillModesID = @BillModesID
													  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
													  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
													  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
													  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													return 0
											end
													
											else if(@VisitTypeID = @IPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo, IPDDoctor.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID
														  ,dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,ExtraBills.StaffNo ,dbo.GetStaffName(ExtraBills.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
														  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
														  ,ExtraBillItems.ItemCode
														  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
														  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
														 -- ,ExtraBillItems.ItemDetails
														  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
														  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
														  ,ExtraBillItems.Quantity
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
														  ,ExtraBillItems.LoginID
														  ,ExtraBillItems.RecordDateTime
														  ,ExtraBillItems.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from ExtraBillItems
													  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  left join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBillItems.ExtraBillNo
													  left join IPDDoctor on extrabillsExt.RoundNo = IPDDoctor.RoundNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													  --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  ExtraBillItems.LoginID = dbo.GetStaffLoginID(@StaffNo)
													  and Visits.BillModesID = @BillModesID
													  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
													  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
													  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
													  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
													  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
											  			  --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													  union
													  
													  select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo,	ipditems.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID
														  ,dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
														  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
														  ,ExtraBillItems.ItemCode
														  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
														  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
														 -- ,ExtraBillItems.ItemDetails
														  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
														  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
														  ,ExtraBillItems.Quantity
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
														  ,ExtraBillItems.LoginID
														  ,ExtraBillItems.RecordDateTime
														  ,ExtraBillItems.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from ExtraBillItems
													  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
													  inner join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join IPDItems on IPDItems.RoundNo = extrabillsExt.RoundNo
													  inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
													  left join patients on visits.PatientNo = patients.patientNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													  --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  IPDItems.LoginID = dbo.GetStaffLoginID(@StaffNo)
													  and Visits.BillModesID = @BillModesID
													  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
													  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
													  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
													  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
													  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.BillModesID = @CashBillModesID
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
											  			  --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													 return 0
											end
									end
					else if not(@ItemStatusID is null or @ItemStatusID = '')
									begin
											if(@VisitTypeID = @OPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID
														  ,dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
														  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
														  ,Items.ItemCode
														  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
														  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
														  ,Items.ItemDetails
														  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
														  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
														  ,Items.Quantity
														  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
														  ,items.LoginID
														  ,items.RecordDateTime
														  ,items.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from items 
													  inner join Visits on Items.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													  --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  items.ItemStatusID = @ItemStatusID
													  and items.LoginID = dbo.GetStaffLoginID(@StaffNo)
													  and Visits.BillModesID = @BillModesID
													  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
													  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
													  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
													  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
														--new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													return 0
											end
											if(@VisitTypeID = @IPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, IPDitems.RoundNo, ExtraBills.ExtraBillNo,	dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID, dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
														  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
														  ,IPDItems.ItemCode
														  ,dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, IPDItems.ItemCategoryID
														  ,dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode) as ItemName
														  ,IPDItems.ItemDetails
														  ,dbo.GetLookupDataDes(IPDItems.ItemStatusID) as ItemStatus, IPDItems.ItemStatusID
														  ,dbo.GetLookupDataDes(IPDItems.PayStatusID) as PayStatus, IPDItems.PayStatusID
														  ,IPDItems.Quantity
														  ,dbo.FormatMoney(IPDItems.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(IPDItems.UnitPrice * IPDItems.Quantity) as TotalFee
														  ,IPDItems.LoginID
														  ,IPDItems.RecordDateTime
														  ,IPDItems.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from IPDItems
													  inner join extrabillsExt on extrabillsExt.RoundNo = IPDItems.RoundNo
													  inner join ExtraBills on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
													   left  join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
													   --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													  --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  IPDitems.ItemStatusID not in (@DoneItemStatus, @OfferedItemStatus)
													  and IPDItems.LoginID = dbo.GetStaffLoginID(@StaffNo)		  
													  and Visits.BillModesID = @BillModesID
													  and IPDItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, RoundNo, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
													  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
													  and IPDStaffPaymentDetails.ItemCategoryID = IPDitems.ItemCategoryID 
													  and IPDStaffPaymentDetails.itemCode = IPDitems.ItemCode  and ApprovalStatusID = @ApprovedID))
													  and IPDItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
														--new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													 return 0
											end
									end	
				end	
			else if (@CompanyNo is null or @CompanyNo ='')
				begin
					if(@ItemStatusID is null or @ItemStatusID = '')
									begin
											if(@VisitTypeID = @OPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName
														  ,patients.GenderID, dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
														  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
														  ,Items.ItemCode
														  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
														  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
														  ,Items.ItemDetails
														  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
														  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
														  ,Items.Quantity
														  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
														  ,items.LoginID
														  ,items.RecordDateTime
														  ,items.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
										    			  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from items 
													  inner join Visits on Items.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
														--new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  --items.ItemStatusID = @ItemStatusID
													  items.LoginID = dbo.GetStaffLoginID(@StaffNo)
													  and Visits.BillModesID = @BillModesID
													  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
													  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
													  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
													  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
														 --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  --and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													return 0
											end
													
											if(@VisitTypeID = @IPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo, IPDDoctor.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID
														  ,dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,ExtraBills.StaffNo ,dbo.GetStaffName(ExtraBills.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
														  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
														  ,ExtraBillItems.ItemCode
														  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
														  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
														 -- ,ExtraBillItems.ItemDetails
														  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
														  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
														  ,ExtraBillItems.Quantity
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
														  ,ExtraBillItems.LoginID
														  ,ExtraBillItems.RecordDateTime
														  ,ExtraBillItems.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from ExtraBillItems
													  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  left join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBillItems.ExtraBillNo
													  left join IPDDoctor on extrabillsExt.RoundNo = IPDDoctor.RoundNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
														 --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  ExtraBillItems.LoginID = dbo.GetStaffLoginID(@StaffNo)
													  and Visits.BillModesID = @BillModesID
													  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
													  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
													  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
													  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
													  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
														 --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  --and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													  union
													  
													  select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo,	ipditems.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID
														  ,dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
														  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
														  ,ExtraBillItems.ItemCode
														  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
														  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
														 -- ,ExtraBillItems.ItemDetails
														  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
														  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
														  ,ExtraBillItems.Quantity
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
														  ,ExtraBillItems.LoginID
														  ,ExtraBillItems.RecordDateTime
														  ,ExtraBillItems.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from ExtraBillItems
													  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
													  inner join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join IPDItems on IPDItems.RoundNo = extrabillsExt.RoundNo
													  inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
													  left join patients on visits.PatientNo = patients.patientNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													   --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  IPDItems.LoginID = dbo.GetStaffLoginID(@StaffNo)
													  and Visits.BillModesID = @BillModesID
													  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
													  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
													  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
													  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode  and ApprovalStatusID = @ApprovedID))
													  and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.BillModesID = @CashBillModesID
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
													  --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  --and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													 return 0
											end
									end
					else if not(@ItemStatusID is null or @ItemStatusID = '')
									begin
											if(@VisitTypeID = @OPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID
														  ,dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
														  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
														  ,Items.ItemCode
														  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
														  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
														  ,Items.ItemDetails
														  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
														  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
														  ,Items.Quantity
														  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
														  ,items.LoginID
														  ,items.RecordDateTime
														  ,items.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from items 
													  inner join Visits on Items.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
													  --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
													   --new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  items.ItemStatusID = @ItemStatusID
													  and Items.LoginID = dbo.GetStaffLoginID(@StaffNo)
													  and Visits.BillModesID = @BillModesID
													  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
													  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
													  and OPDStaffPaymentDetails.itemCode = Items.ItemCode and ApprovalStatusID = @ApprovedID))		  
													  and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
													   --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  --and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													return 0
											end
											if(@VisitTypeID = @IPDVisitTypeID)
											begin
													 select Visits.PatientNo, Visits.VisitNo, IPDitems.RoundNo, ExtraBills.ExtraBillNo,	dbo.FormatDate(visits.VisitDate) as VisitDate
														  ,dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, patients.GenderID, dbo.GetLookupDataDes(patients.GenderID) as Gender
														  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
														  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
														  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
														  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
														  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
														  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
														  ,IPDItems.ItemCode
														  ,dbo.GetLookupDataDes(IPDItems.ItemCategoryID) as ItemCategory, IPDItems.ItemCategoryID
														  ,dbo.GetItemName(IPDItems.ItemCategoryID, IPDItems.ItemCode) as ItemName
														  ,IPDItems.ItemDetails
														  ,dbo.GetLookupDataDes(IPDItems.ItemStatusID) as ItemStatus, IPDItems.ItemStatusID
														  ,dbo.GetLookupDataDes(IPDItems.PayStatusID) as PayStatus, IPDItems.PayStatusID
														  ,IPDItems.Quantity
														  ,dbo.FormatMoney(IPDItems.UnitPrice) as UnitPrice
														  ,dbo.FormatMoney(IPDItems.UnitPrice * IPDItems.Quantity) as TotalFee
														  ,IPDItems.LoginID
														  ,IPDItems.RecordDateTime
														  ,IPDItems.ClientMachine
														  ,visits.BillModesID, dbo.GetLookupDataDes(visits.BillModesID) as BillMode, visits.BillNo
														  ,visits.MemberCardNo, visits.MainMemberName, visits.ClaimReferenceNo
														  ,dbo.GetBillName(visits.BillModesID, visits.BillNo) as BillCustomerName
													  from IPDItems
													  inner join extrabillsExt on extrabillsExt.RoundNo = IPDItems.RoundNo
													  inner join ExtraBills on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
													  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
													  left join patients on visits.PatientNo = patients.patientNo
													  --left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
													   left  join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
													   --left join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
														--new code trial
													  left join InsurancePolicies on Visits.InsuranceNo = InsurancePolicies.InsuranceNo
													  left join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
													  left join Companies on InsuranceSchemes.CompanyNo = Companies.Companyno
													  -- ending new code trial
													  where 
													  IPDitems.ItemStatusID not in (@DoneItemStatus, @OfferedItemStatus)
													  and IPDItems.LoginID = dbo.GetStaffLoginID(@StaffNo)	  
													  and Visits.BillModesID = @BillModesID
													  and IPDItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
													  and (not exists(select visitno, RoundNo, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
													  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
													  and IPDStaffPaymentDetails.ItemCategoryID = IPDitems.ItemCategoryID 
													  and IPDStaffPaymentDetails.itemCode = IPDitems.ItemCode  and ApprovalStatusID = @ApprovedID))
													  and IPDItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
													  --and Visits.InsuranceNo = @AccountNo
													  --and SchemeMembers.CompanyNo = @CompanyNo
													   --new code trila
													  and InsurancePolicies.InsuranceNo = @AccountNo
													  --and Companies.CompanyNo = @CompanyNo
													  -- ending new code trial
													 return 0
											end
									end	
				end
		end	  
end	

go

/*

exec uspToGetVoucherPaymentDetails 'MHIN/63', '2015-01-01 07:30:00', '2017-12-10 22:29:00', '7d,7s,7c', '17i', '110IPD', '11O','I14001',''
exec uspToGetVoucherPaymentDetails 'MHIN/63', '2013-01-01 07:30:00', '2017-12-10 22:29:00', '7d,7s,7c', '17A', '110OPD', '','','A130200'
eft join InsuranceSchemes on InsurancePolicies.PolicyNo = InsuranceSchemes.PolicyNo
 MHIN/005  C14157  A130200
@StaffNo varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null,
@ItemCategoryID varchar(400),
@BillModesID varchar(10),
@VisitTypeID varchar(10),
@ItemStatusID varchar(10),
@AccountNo varchar(20),
@CompanyNo varchar(20)

*/

---------------------To Get Pending Voucher Payment Details -----------------------------------------------------

if exists (select * from sysobjects where name = 'uspToGetPendingVoucherPaymentDetails')
	drop proc uspToGetPendingVoucherPaymentDetails
go

create proc uspToGetPendingVoucherPaymentDetails(
@StaffNo varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null,
@PaymentVoucherNo varchar(20),
@BillModesID varchar(10),
@VisitTypeID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)
--declare @NotPaidID as varchar(10)
declare @ApprovedID as varchar(10)
declare @OfferedItemStatus as varchar(10)
declare @DoneItemStatus as varchar(10)
declare @ProcessingItemStatus as varchar(10)
declare @IPDVisitTypeID as varchar(10)
declare @OPDVisitTypeID as varchar(10)
-------------------------------------------------------------------------------------

--set @NotPaidID =  dbo.GetLookupDataID('PayStatus', 'NP')
set @ApprovedID =  dbo.GetLookupDataID('ClaimStatus', 'AP')

set @OfferedItemStatus = dbo.GetLookupDataID('ItemStatus', 'O')
set @DoneItemStatus = dbo.GetLookupDataID('ItemStatus', 'D')
set @ProcessingItemStatus = dbo.GetLookupDataID('ItemStatus', 'D')
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')
set @OPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------

-------------------------------------------------------------------------------------


if not exists(select StaffNo from Staff where StaffNo = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you''re trying to update does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')	
		return 1
	end

if(@VisitTypeID = @OPDVisitTypeID)
begin
		 select Visits.PatientNo, Visits.VisitNo, 	dbo.FormatDate(visits.VisitDate) as VisitDate
			  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
			  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
			  ,DoctorVisits.StaffNo ,dbo.GetStaffName(DoctorVisits.StaffNo)as staffName
			  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
			  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
			  ,dbo.FormatMoney((select sum(amount) from OPDStaffPaymentDetails where OPDStaffPaymentDetails.visitno = Visits.VisitNo 
			  and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID  and OPDStaffPaymentDetails.itemCode = Items.ItemCode )) as PaidAmount
			  ,Items.ItemCode
			  ,dbo.GetLookupDataDes(Items.ItemCategoryID) as ItemCategory, Items.ItemCategoryID
			  ,dbo.GetItemName(Items.ItemCategoryID, Items.ItemCode) as ItemName
			  ,Items.ItemDetails
			  ,dbo.GetLookupDataDes(Items.ItemStatusID) as ItemStatus, items.ItemStatusID
			  ,dbo.GetLookupDataDes(Items.PayStatusID) as PayStatus, Items.PayStatusID
			  ,Items.Quantity
			  ,dbo.FormatMoney(Items.UnitPrice) as UnitPrice
			  ,dbo.FormatMoney(Items.UnitPrice * Items.Quantity) as TotalFee
			  ,OPDStaffPaymentDetails.amount
			
		  from items 
		  inner join Visits on Items.VisitNo = Visits.VisitNo
		  left join patients on visits.PatientNo = patients.patientNo
		  left  join DoctorVisits on DoctorVisits.VisitNo = Visits.VisitNo
		  inner join OPDStaffPaymentDetails on OPDStaffPaymentDetails.visitNo = items.visitNo and OPDStaffPaymentDetails.itemCode = items.ItemCode
		  and OPDStaffPaymentDetails.ItemCategoryID = items.ItemCategoryID
		  where 
		  --visits.VisitStatusID = @CompletedVisitStatusID  and DoctorVisits.StaffNo = @StaffNo
		  DoctorVisits.StaffNo = @StaffNo
		  and Visits.BillModesID = @BillModesID
		  and items.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
		  and ( exists(select visitno, itemCode, ItemCategoryID from OPDStaffPaymentDetails where 
		  OPDStaffPaymentDetails.visitno = Visits.VisitNo and OPDStaffPaymentDetails.ItemCategoryID = Items.ItemCategoryID 
		  and OPDStaffPaymentDetails.itemCode = Items.ItemCode))
		  --and ApprovalStatusID = @ApprovedID))	
		  and OPDStaffPaymentDetails.PaymentVoucherNo = @PaymentVoucherNo	  
		  --and Items.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
		  
		  
		return 0
		end
if(@VisitTypeID = @IPDVisitTypeID)
begin
		 select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo, IPDDoctor.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
								  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
								  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
								  ,ExtraBills.StaffNo ,dbo.GetStaffName(ExtraBills.StaffNo)as staffName
								  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
								  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
								  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
								  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
								  ,ExtraBillItems.ItemCode
								  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
								  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
								 -- ,ExtraBillItems.ItemDetails
								  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
								  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
								  ,ExtraBillItems.Quantity
								  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
								  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
								  ,IPDStaffPaymentDetails.amount
								  ,ExtraBillItems.LoginID
								  ,ExtraBillItems.RecordDateTime
								   ,ExtraBillItems.ClientMachine
							  from ExtraBillItems
							  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
							  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
							  left join patients on visits.PatientNo = patients.patientNo
							  left join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBillItems.ExtraBillNo
							  left join IPDDoctor on extrabillsExt.RoundNo = IPDDoctor.RoundNo
							  inner join IPDStaffPaymentDetails on IPDStaffPaymentDetails.ExtraBillNo = ExtraBillItems.ExtraBillNo 
							  and IPDStaffPaymentDetails.ItemCode = ExtraBillItems.ItemCode
							  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID
							  where 
							  ExtraBills.StaffNo = @StaffNo	
							  and Visits.BillModesID = @BillModesID
							  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
							  and ( exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
							  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
							  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
							  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode)) -- and ApprovalStatusID = @ApprovedID))
							  --and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
							  and IPDStaffPaymentDetails.PaymentVoucherNo = @PaymentVoucherNo	  
							  union
							  
							  select Visits.PatientNo, Visits.VisitNo, ExtraBills.ExtraBillNo,	ipditems.RoundNo, dbo.FormatDate(visits.VisitDate) as VisitDate
								  ,dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, GenderID, dbo.GetLookupDataDes(GenderID) as Gender
								  ,dbo.GetLookupDataDes(Visits.DoctorSpecialtyID) as DoctorSpecialty 
								  ,IPDDoctor.StaffNo ,dbo.GetStaffName(IPDDoctor.StaffNo)as staffName
								  ,dbo.GetLookupDataDes(Visits.VisitStatusID) as VisitStatus
								  ,dbo.GetLookupDataDes(Visits.VisitCategoryID) as VisitCategory
								  --,dbo.FormatMoney((select sum(amount) from StaffPayments where StaffPayments.visitno = Visits.VisitNo and StaffPayments.ItemCategoryID = IPDItems.ItemCategoryID
								  --and StaffPayments.itemCode = IPDItems.ItemCode )) as PaidAmount
								  ,ExtraBillItems.ItemCode
								  ,dbo.GetLookupDataDes(ExtraBillItems.ItemCategoryID) as ItemCategory, ExtraBillItems.ItemCategoryID
								  ,dbo.GetItemName(ExtraBillItems.ItemCategoryID, ExtraBillItems.ItemCode) as ItemName
								 -- ,ExtraBillItems.ItemDetails
								  ,dbo.GetLookupDataDes(ExtraBillItems.EntryModeID) as EntryMode, ExtraBillItems.EntryModeID
								  ,dbo.GetLookupDataDes(ExtraBillItems.PayStatusID) as PayStatus, ExtraBillItems.PayStatusID
								  ,ExtraBillItems.Quantity
								  ,dbo.FormatMoney(ExtraBillItems.UnitPrice) as UnitPrice
								  ,dbo.FormatMoney(ExtraBillItems.UnitPrice * ExtraBillItems.Quantity) as TotalFee
								  ,IPDStaffPaymentDetails.amount
								  ,ExtraBillItems.LoginID
								  ,ExtraBillItems.RecordDateTime
							      ,ExtraBillItems.ClientMachine
							  from ExtraBillItems
							  
							  inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
							  inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
							  inner join extrabillsExt on extrabillsExt.ExtraBillNo = ExtraBills.ExtraBillNo
							  inner join IPDItems on IPDItems.RoundNo = extrabillsExt.RoundNo
							  inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
							  left join patients on visits.PatientNo = patients.patientNo
							  inner join IPDStaffPaymentDetails on IPDStaffPaymentDetails.ExtraBillNo = ExtraBillItems.ExtraBillNo 
							  and IPDStaffPaymentDetails.ItemCode = ExtraBillItems.ItemCode
							  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID
							  where 
							  IPDDoctor.StaffNo = @StaffNo	
							  and Visits.BillModesID = @BillModesID
							  and ExtraBillItems.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
							  and ( exists(select visitno, ExtraBillNo, itemCode, ItemCategoryID from IPDStaffPaymentDetails where 
							  IPDStaffPaymentDetails.visitno = Visits.VisitNo and IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo 
							  and IPDStaffPaymentDetails.ItemCategoryID = ExtraBillItems.ItemCategoryID 
							  and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode))--  and ApprovalStatusID = @ApprovedID))
							  --and ExtraBillItems.ItemCategoryID  in (SELECT Value FROM dbo.fn_Split(@ItemCategoryID, ','))
							  and IPDStaffPaymentDetails.PaymentVoucherNo = @PaymentVoucherNo	 
		  
		  
		
		
		  
return 0
end
  
go

/*
@StaffNo varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null,
@PaymentVoucherNo varchar(20),
@BillModesID varchar(10),
@VisitTypeID varchar(10)

select * from staffPayments
exec uspToGetPendingVoucherPaymentDetails 'SUR0016', '2016-06-01', '2016-12-30'
exec uspToGetPendingVoucherPaymentDetails 'MHIN/63', '2016-03-10 07:30:00', '2016-03-10 22:29:00'
exec uspToGetPendingVoucherPaymentDetails 'MHIN/63', '2016-01-01 07:30:00', '2016-12-31 22:29:00', '16000008', '17A', '110IPD' 
*/



--------GetNextPaymentVoucherID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextPaymentVoucherID')
	drop proc uspGetNextPaymentVoucherID
go

create proc uspGetNextPaymentVoucherID(
@PaymentVoucherID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @PaymentVoucherID = (select max(PaymentVoucherID) from StaffPayments where left(PaymentVoucherNo, 2) = @CurrentYear)
set @PaymentVoucherID = dbo.GetNextAutoNumber('StaffPayments', 'PaymentVoucherNo', @PaymentVoucherID)

return 0

go

-- exec uspGetNextPaymentVoucherID 
-- select * from StaffPayments


------------------------------------------------------------------------------------------------------
-------------- StaffPayments --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert StaffPayments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertStaffPayments')
	drop proc uspInsertStaffPayments
go

create proc uspInsertStaffPayments(
--@PaymentVoucherID int,
@PaymentVoucherNo varchar(20),
@VisitTypeID varchar(10),
@StartDateTime SmallDateTime,
@EndDateTime SmallDateTime,
@BillModesID varchar(10),
@StaffNo varchar(10),
@VoucherStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine Varchar(40)
--@RecordDateTime SmallDateTime
)with encryption as

----------------------------------------------
declare @ErrorMSG varchar(200)

declare @CurrentYear as char(2)
declare @AutoColumnLEN tinyint

declare @PaymentVoucherID int

declare @PaddingLEN tinyint
declare @PassedPaymentVoucherID int
declare @PassedPaymentVoucherNo varchar(20)
declare @PassedStaffNo varchar(20)
----------------------------------------------

if exists(select PaymentVoucherNo from StaffPayments where PaymentVoucherNo = @PaymentVoucherNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo)
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @VisitTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit TypeID', @VisitTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @BillModesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bill ModesID', @BillModesID, 'Lookup Data')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
		return 1
	end

--if not exists(select DataID from LookUpData where DataID = @VoucherStatusID)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Voucher StatusID', @VoucherStatusID, 'Lookup Data')
--		return 1
--	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end


---------------------------------------------------------------------------------------------------------------------

select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'StaffPayments' and AutoColumnName = 'PaymentVoucherNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'StaffPayments' and AutoColumnName = 'PaymentVoucherNo'

set @CurrentYear = right(year(getdate()),2)

if (@AutoColumnLEN = len(@PaymentVoucherNo)) and (left(@PaymentVoucherNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedPaymentVoucherID = 1
	set @PassedPaymentVoucherNo = @PaymentVoucherNo
	set @PassedPaymentVoucherNo = ltrim(rtrim(substring(@PassedPaymentVoucherNo, len(@CurrentYear) + 1, @PaddingLEN)))

	if isnumeric(@PassedPaymentVoucherNo) = 1 set @PassedPaymentVoucherID = @PassedPaymentVoucherNo
	else set @PassedPaymentVoucherID = 1

	set @PaymentVoucherID = (select max(ReceiptID) from Payments where left(ReceiptNo, len(@CurrentYear)) = @CurrentYear)
	set @PaymentVoucherID = dbo.GetNextAutoNumber('StaffPayments', 'PaymentVoucherNo', @PaymentVoucherID)

	if @PassedPaymentVoucherID < @PaymentVoucherID set @PaymentVoucherID = @PassedPaymentVoucherID
	if @PassedPaymentVoucherID > @PaymentVoucherID set @PaymentVoucherID = @PassedPaymentVoucherID

end else set @PaymentVoucherID = 1

---------------------------------------------------------------------------------------------------------------------------



begin
insert into StaffPayments
(PaymentVoucherID, PaymentVoucherNo, VisitTypeID, StartDateTime, EndDateTime, BillModesID, StaffNo, VoucherStatusID, LoginID, ClientMachine)--, RecordDateTime)
values
(@PaymentVoucherID, @PaymentVoucherNo, @VisitTypeID, @StartDateTime, @EndDateTime, @BillModesID, @StaffNo, @VoucherStatusID, @LoginID, @ClientMachine)--, @RecordDateTime)
return 0
end
go

/******************************************************************************************************
exec uspInsertStaffPayments
******************************************************************************************************/
-- select * from StaffPayments
-- delete from StaffPayments


-------------- Update StaffPayments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateStaffPayments')
	drop proc uspUpdateStaffPayments
go

create proc uspUpdateStaffPayments(
--@PaymentVoucherID int,
@PaymentVoucherNo varchar(20),
@VisitTypeID varchar(10),
@StartDateTime SmallDateTime,
@EndDateTime SmallDateTime,
@BillModesID varchar(10),
@StaffNo varchar(10),
@VoucherStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine Varchar(40)
--@RecordDateTime SmallDateTime
)with encryption as

----------------------------------------------
declare @ErrorMSG varchar(200)

declare @CurrentYear as char(2)
declare @AutoColumnLEN tinyint

declare @PaymentVoucherID int

declare @PaddingLEN tinyint
declare @PassedPaymentVoucherID int
declare @PassedPaymentVoucherNo varchar(20)
declare @PassedStaffNo varchar(20)
----------------------------------------------

if not exists(select PaymentVoucherNo from StaffPayments where PaymentVoucherNo = @PaymentVoucherNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo, 'StaffPayments')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @VisitTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit TypeID', @VisitTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @BillModesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bill ModesID', @BillModesID, 'Lookup Data')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
		return 1
	end

--if not exists(select DataID from LookUpData where DataID = @VoucherStatusID)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Voucher StatusID', @VoucherStatusID, 'Lookup Data')
--		return 1
--	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end



---------------------------------------------------------------------------------------------------------------------

select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'StaffPayments' and AutoColumnName = 'PaymentVoucherNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'StaffPayments' and AutoColumnName = 'PaymentVoucherNo'

set @CurrentYear = right(year(getdate()),2)

if (@AutoColumnLEN = len(@PaymentVoucherNo)) and (left(@PaymentVoucherNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedPaymentVoucherID = 1
	set @PassedPaymentVoucherNo = @PaymentVoucherNo
	set @PassedPaymentVoucherNo = ltrim(rtrim(substring(@PassedPaymentVoucherNo, len(@CurrentYear) + 1, @PaddingLEN)))

	if isnumeric(@PassedPaymentVoucherNo) = 1 set @PassedPaymentVoucherID = @PassedPaymentVoucherNo
	else set @PassedPaymentVoucherID = 1

	set @PaymentVoucherID = (select max(ReceiptID) from Payments where left(ReceiptNo, len(@CurrentYear)) = @CurrentYear)
	set @PaymentVoucherID = dbo.GetNextAutoNumber('StaffPayments', 'PaymentVoucherNo', @PaymentVoucherID)

	if @PassedPaymentVoucherID < @PaymentVoucherID set @PaymentVoucherID = @PassedPaymentVoucherID
	if @PassedPaymentVoucherID > @PaymentVoucherID set @PaymentVoucherID = @PassedPaymentVoucherID

end else set @PaymentVoucherID = 1

---------------------------------------------------------------------------------------------------------------------------


begin
update StaffPayments set
PaymentVoucherID = @PaymentVoucherID, VisitTypeID = @VisitTypeID, StartDateTime = @StartDateTime, EndDateTime = @EndDateTime, 
BillModesID = @BillModesID, StaffNo = @StaffNo, VoucherStatusID = @VoucherStatusID, LoginID = @LoginID,
ClientMachine = @ClientMachine --, RecordDateTime = @RecordDateTime
where PaymentVoucherNo = @PaymentVoucherNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateStaffPayments
******************************************************************************************************/
-- select * from StaffPayments
-- delete from StaffPayments


-------------- Get StaffPayments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetStaffPayments')
	drop proc uspGetStaffPayments
go

create proc uspGetStaffPayments(
@PaymentVoucherNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PaymentVoucherNo from StaffPayments where PaymentVoucherNo = @PaymentVoucherNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo, 'StaffPayments')
		return 1
	end
else
begin
	select PaymentVoucherID, PaymentVoucherNo, VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as [Visit Type], StartDateTime, 
	EndDateTime, BillModesID, dbo.GetLookupDataDes(BillModesID) as [BillModes], StaffPayments.StaffNo, dbo.GetStaffFullName(StaffPayments.StaffNo) as StaffFullName,
	VoucherStatusID, 	dbo.GetLookupDataDes(VoucherStatusID) as [Voucher Status], StaffPayments.LoginID, StaffPayments.ClientMachine, StaffPayments.RecordDateTime
	from StaffPayments
	inner join Staff on StaffPayments.StaffNo = Staff.StaffNo	
	inner join Logins on StaffPayments.LoginID = Logins.LoginID	

	where PaymentVoucherNo = @PaymentVoucherNo
return 0
end
go

/******************************************************************************************************
exec uspGetStaffPayments'16000002'
******************************************************************************************************/
-- select * from StaffPayments
-- delete from StaffPayments



-------------- Get Pending StaffPayments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPendingStaffPayments')
	drop proc uspGetPendingStaffPayments
go

create proc uspGetPendingStaffPayments
with encryption as

declare @ErrorMSG varchar(200)
declare @ApprovedID as varchar(10)
----------------------------------------------------------------------
set @ApprovedID =  dbo.GetLookupDataID('ClaimStatus', 'AP')
---------------------------------------------------------------------

begin
	select PaymentVoucherID, PaymentVoucherNo, VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as [VisitType], StartDateTime, 
	EndDateTime, BillModesID, dbo.GetLookupDataDes(BillModesID) as [BillModes], StaffPayments.StaffNo, 
	dbo.GetStaffFullName(StaffPayments.StaffNo) as StaffFullName, VoucherStatusID, 	
	dbo.GetLookupDataDes(VoucherStatusID) as [Voucher Status], StaffPayments.LoginID, StaffPayments.ClientMachine, StaffPayments.RecordDateTime
	from StaffPayments
	inner join Staff on StaffPayments.StaffNo = Staff.StaffNo	
	inner join Logins on StaffPayments.LoginID = Logins.LoginID	
	where not(VoucherStatusID = @ApprovedID)
	
return 0
end
go

/******************************************************************************************************
exec uspGetPendingStaffPayments
******************************************************************************************************/
-- select * from StaffPayments
-- delete from StaffPayments



-------------- Get Periodic Pending StaffPayments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicPendingStaffPayments')
	drop proc uspGetPeriodicPendingStaffPayments
go

create proc uspGetPeriodicPendingStaffPayments(
@StartDateTime smalldatetime = null,
@EndDateTime smalldatetime = null,
@VisitTypeID varchar(10)
)
with encryption as

declare @ErrorMSG varchar(200)
declare @ApprovedID as varchar(10)
----------------------------------------------------------------------
set @ApprovedID =  dbo.GetLookupDataID('ClaimStatus', 'AP')
---------------------------------------------------------------------

begin
	select PaymentVoucherID, PaymentVoucherNo, VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as [VisitType], StartDateTime, 
	EndDateTime, BillModesID, dbo.GetLookupDataDes(BillModesID) as [BillModes], StaffPayments.StaffNo, 
	dbo.GetStaffFullName(StaffPayments.StaffNo) as StaffFullName, VoucherStatusID, 	
	dbo.GetLookupDataDes(VoucherStatusID) as [Voucher Status], StaffPayments.LoginID, StaffPayments.ClientMachine, StaffPayments.RecordDateTime
	from StaffPayments
	inner join Staff on StaffPayments.StaffNo = Staff.StaffNo	
	inner join Logins on StaffPayments.LoginID = Logins.LoginID	
	where 
	StaffPayments.RecordDateTime between dbo.FormatDateTime(@StartDateTime) and dbo.FormatDateTime(@EndDateTime)
	and VisitTypeID = @VisitTypeID
	
return 0
end
go

/******************************************************************************************************
exec uspGetPeriodicPendingStaffPayments '2016-01-01', '2016-12-31'
******************************************************************************************************/
-- select * from StaffPayments
-- delete from StaffPayments



------------------------------------------------------------------------------------------------------
-------------- StaffPaymentExt --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
-------------- StaffPaymentsExt --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert StaffPaymentsExt -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertStaffPaymentsExt')
	drop proc uspInsertStaffPaymentsExt
go

create proc uspInsertStaffPaymentsExt(
@PaymentVoucherNo varchar(20),
@ApprovalDateTime SmallDateTime,
@PayModeID varchar(20),
@DocumentNo varchar(20),
@CurrenciesID varchar(10),
@ExchangeRate money,
@Amount money,
@AmountWords varchar(400),
@ApprovalStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine Varchar(40)
--@RecordDateTime SmallDateTime
)with encryption as

declare @ErrorMSG varchar(200)
declare @ApprovedStatusID varchar(10)

set @ApprovedStatusID = dbo.GetLookupDataID('ClaimStatus', 'AP')

if not exists(select PaymentVoucherNo from StaffPayments where PaymentVoucherNo  = @PaymentVoucherNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo, 'StaffPayments')
		return 1
	end

if exists(select PaymentVoucherNo from StaffPaymentsExt where PaymentVoucherNo = @PaymentVoucherNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayModeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pay ModeID', @PayModeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CurrenciesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CurrenciesID', @CurrenciesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ApprovalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Approval Status ID', @ApprovalStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
begin tran
insert into StaffPaymentsExt
(PaymentVoucherNo, ApprovalDateTime, PayModeID, DocumentNo, CurrenciesID, ExchangeRate, Amount, AmountWords, ApprovalStatusID, LoginID, ClientMachine) --, RecordDateTime)
values
(@PaymentVoucherNo, @ApprovalDateTime, @PayModeID, @DocumentNo, @CurrenciesID, @ExchangeRate, @Amount, @AmountWords, @ApprovalStatusID, @LoginID, @ClientMachine) --, @RecordDateTime)

update StaffPayments set VoucherStatusID = @ApprovedStatusID where PaymentVoucherNo = @PaymentVoucherNo

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
return 0
end
go

/******************************************************************************************************
exec uspInsertStaffPaymentsExt
******************************************************************************************************/
-- select * from StaffPaymentsExt
-- delete from StaffPaymentsExt


-------------- Update StaffPaymentsExt -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateStaffPaymentsExt')
	drop proc uspUpdateStaffPaymentsExt
go

create proc uspUpdateStaffPaymentsExt(
@PaymentVoucherNo varchar(20),
@ApprovalDateTime SmallDateTime,
@PayModeID varchar(20),
@DocumentNo varchar(20),
@CurrenciesID varchar(10),
@ExchangeRate money,
@Amount money,
@AmountWords varchar(400),
@ApprovalStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine Varchar(40)
--@RecordDateTime SmallDateTime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PaymentVoucherNo from StaffPaymentsExt where PaymentVoucherNo = @PaymentVoucherNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo, 'StaffPaymentExt')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayModeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pay ModeID', @PayModeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CurrenciesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CurrenciesID', @CurrenciesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ApprovalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Approval Status ID', @ApprovalStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update StaffPaymentsExt set
ApprovalDateTime = @ApprovalDateTime, PayModeID = @PayModeID, DocumentNo = @DocumentNo, CurrenciesID = @CurrenciesID, 
ExchangeRate = @ExchangeRate, Amount = @Amount, AmountWords = @AmountWords, ApprovalStatusID = @ApprovalStatusID, LoginID = @LoginID,
ClientMachine = @ClientMachine --, RecordDateTime = @RecordDateTime
where PaymentVoucherNo = @PaymentVoucherNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateStaffPaymentsExt
******************************************************************************************************/
-- select * from StaffPaymentsExt
-- delete from StaffPaymentsExt


-------------- Get StaffPaymentsExt -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetStaffPaymentsExt')
	drop proc uspGetStaffPaymentsExt
go

create proc uspGetStaffPaymentsExt(
@PaymentVoucherNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PaymentVoucherNo from StaffPaymentsExt where PaymentVoucherNo = @PaymentVoucherNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo, 'StaffPaymentsExt')
		return 1
	end
else
begin
	select PaymentVoucherNo, ApprovalDateTime, PayModeID, dbo.GetLookupDataDes(PayModeID) as [Pay ModeID], DocumentNo, 
	CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as [CurrenciesID], ExchangeRate, Amount, AmountWords, ApprovalStatusID, 
	dbo.GetLookupDataDes(ApprovalStatusID) as [Approval Status ID], StaffPaymentsExt.LoginID, ClientMachine, RecordDateTime
	from StaffPaymentsExt
	inner join Logins on StaffPaymentsExt.LoginID = Logins.LoginID	

	where PaymentVoucherNo = @PaymentVoucherNo
return 0
end
go

/******************************************************************************************************
exec uspGetStaffPaymentsExt
******************************************************************************************************/
-- select * from StaffPaymentsExt
-- delete from StaffPaymentsExt






------------------------------------------------------------------------------------------------------
-------------- IPDStaffPaymentDetails --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert IPDStaffPaymentDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertIPDStaffPaymentDetails')
	drop proc uspInsertIPDStaffPaymentDetails
go

create proc uspInsertIPDStaffPaymentDetails(
@PaymentVoucherNo varchar(20),
@VisitNo varchar(20),
@RoundNo varchar(20),
@ExtraBillNo varchar(20),
@ItemCode varchar(10),
@ItemCategoryID varchar(10),
@Amount money,
@ApprovalStatusID varchar(10),
@ApprovalNotes varchar(200),
@LoginID varchar(20),
@ClientMachine Varchar(40)
--@RecordDateTime SmallDateTime
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select * from IPDStaffPaymentDetails 
			where PaymentVoucherNo = @PaymentVoucherNo and VisitNo = @VisitNo and ExtraBillNo = @ExtraBillNo
			and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, %s: %s, %s: %s, %s: %s, %s: %s, you are trying to enter already exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo, 'VisitNo', @VisitNo, 'ExtraBillNo', @ExtraBillNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'StaffPayments')
		return 1
	end

if not exists(select PaymentVoucherNo from StaffPayments where PaymentVoucherNo  = @PaymentVoucherNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo, 'StaffPayments')
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

--if not exists(select RoundNo from IPDItems where RoundNo  = @RoundNo)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'RoundNo', @RoundNo, 'IPDItems')
--		return 1
--	end

if not exists(select ExtraBillNo from ExtraBills where ExtraBillNo  = @ExtraBillNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra BillNo', @ExtraBillNo, 'ExtraBills')
		return 1
	end

--if not exists(select DataID from LookUpData where DataID = @ItemCode)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Lookup Data')
--		return 1
--	end

if not exists(select DataID from LookUpData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @ApprovalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Approval StatusID', @ApprovalStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into IPDStaffPaymentDetails
(PaymentVoucherNo, VisitNo, RoundNo, ExtraBillNo, ItemCode, ItemCategoryID, Amount, ApprovalStatusID,
ApprovalNotes, LoginID, ClientMachine)--, RecordDateTime)
values
(@PaymentVoucherNo, @VisitNo, @RoundNo, @ExtraBillNo, @ItemCode, @ItemCategoryID, @Amount, @ApprovalStatusID, 
@ApprovalNotes, @LoginID, @ClientMachine)--, @RecordDateTime)
return 0
end
go

/******************************************************************************************************
exec uspInsertIPDStaffPaymentDetails
******************************************************************************************************/
-- select * from IPDStaffPaymentDetails
-- delete from IPDStaffPaymentDetails


-------------- Update IPDStaffPaymentDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDStaffPaymentDetails')
	drop proc uspUpdateIPDStaffPaymentDetails
go

create proc uspUpdateIPDStaffPaymentDetails(
@PaymentVoucherNo varchar(20),
@VisitNo varchar(20),
@RoundNo varchar(20),
@ExtraBillNo varchar(20),
@ItemCode varchar(10),
@ItemCategoryID varchar(10),
@Amount money,
@ApprovalStatusID varchar(10),
@ApprovalNotes varchar(200),
@LoginID varchar(20),
@ClientMachine Varchar(40)
--@RecordDateTime SmallDateTime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select * from IPDStaffPaymentDetails 
			where PaymentVoucherNo = @PaymentVoucherNo and VisitNo = @VisitNo and RoundNo = @RoundNo and ExtraBillNo = @ExtraBillNo
			and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, %s: %s, %s: %s, %s: %s, %s: %s, you are trying to Update does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo, 'VisitNo', @VisitNo, 'ExtraBillNo', @ExtraBillNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'StaffPayments')
		return 1
	end

if not exists(select PaymentVoucherNo from StaffPayments where PaymentVoucherNo  = @PaymentVoucherNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo, 'StaffPayments')
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

--if not exists(select RoundNo from IPDItems where RoundNo  = @RoundNo)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'RoundNo', @RoundNo, 'IPDItems')
--		return 1
--	end

if not exists(select ExtraBillNo from ExtraBills where ExtraBillNo  = @ExtraBillNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Extra BillNo', @ExtraBillNo, 'ExtraBills')
		return 1
	end

--if not exists(select DataID from LookUpData where DataID = @ItemCode)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Lookup Data')
--		return 1
--	end

if not exists(select DataID from LookUpData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @ApprovalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Approval StatusID', @ApprovalStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update IPDStaffPaymentDetails set
PaymentVoucherNo = @PaymentVoucherNo, VisitNo = @VisitNo, RoundNo = @RoundNo, ExtraBillNo = @ExtraBillNo, ItemCode = @ItemCode, 
ItemCategoryID = @ItemCategoryID, Amount = @Amount, ApprovalStatusID = @ApprovalStatusID,
ApprovalNotes = @ApprovalNotes, LoginID = @LoginID, ClientMachine = @ClientMachine 
where PaymentVoucherNo = @PaymentVoucherNo and VisitNo = @VisitNo and RoundNo = @RoundNo and ExtraBillNo = @ExtraBillNo
and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
--RecordDateTime = @RecordDateTime

return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDStaffPaymentDetails
******************************************************************************************************/
-- select * from IPDStaffPaymentDetails
-- delete from IPDStaffPaymentDetails


-------------- Get IPDStaffPaymentDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDStaffPaymentDetails')
	drop proc uspGetIPDStaffPaymentDetails
go

create proc uspGetIPDStaffPaymentDetails(
@PaymentVoucherNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select * from IPDStaffPaymentDetails where PaymentVoucherNo = @PaymentVoucherNo )
	begin
		set @ErrorMSG = 'The record(s) with %s: %s, you are searching for do not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PaymentVoucherNo', @PaymentVoucherNo, 'IPDStaffPaymentDetails')
		return 1
	end
else
begin
	select IPDStaffPaymentDetails.PaymentVoucherNo, IPDStaffPaymentDetails.VisitNo, IPDStaffPaymentDetails.RoundNo, Visits.PatientNo,
	dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName, IPDStaffPaymentDetails.ExtraBillNo, IPDStaffPaymentDetails.ItemCode, 
	dbo.GetLookupDataDes(IPDStaffPaymentDetails.ItemCode) as [Item Code], IPDStaffPaymentDetails.ItemCategoryID, 
	dbo.GetItemName(IPDStaffPaymentDetails.ItemCategoryID, IPDStaffPaymentDetails.ItemCode) as ItemName,
	dbo.GetLookupDataDes(IPDStaffPaymentDetails.ItemCategoryID) as [ItemCategory], IPDStaffPaymentDetails.Amount, ApprovalStatusID, ApprovalNotes, 
	dbo.GetLookupDataDes(ApprovalStatusID) as ApprovalStatus, IPDStaffPaymentDetails.LoginID, IPDStaffPaymentDetails.ClientMachine, 
	IPDStaffPaymentDetails.RecordDateTime
	from IPDStaffPaymentDetails
	inner join StaffPayments on IPDStaffPaymentDetails.PaymentVoucherNo = StaffPayments.PaymentVoucherNo	
	inner join Visits on IPDStaffPaymentDetails.VisitNo = Visits.VisitNo	
	left join patients on visits.PatientNo = patients.patientNo
	inner join ExtraBillItems on IPDStaffPaymentDetails.ExtraBillNo = ExtraBillItems.ExtraBillNo 
	and IPDStaffPaymentDetails.itemCategoryID = ExtraBillItems.itemCategoryID 
	and IPDStaffPaymentDetails.itemCode = ExtraBillItems.ItemCode
	
	inner join ExtraBills on IPDStaffPaymentDetails.ExtraBillNo = ExtraBills.ExtraBillNo	
	left join Logins on IPDStaffPaymentDetails.LoginID = Logins.LoginID	
	where IPDStaffPaymentDetails.PaymentVoucherNo = @PaymentVoucherNo
	
return 0
end
go

/******************************************************************************************************
exec uspGetIPDStaffPaymentDetails
exec uspGetIPDStaffPaymentDetails '16000002'
******************************************************************************************************/
-- select * from IPDStaffPaymentDetails
-- delete from IPDStaffPaymentDetails



------------------------------------------------------------------------------------------------------
-------------- OPDStaffPaymentDetails --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert OPDStaffPaymentDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertOPDStaffPaymentDetails')
	drop proc uspInsertOPDStaffPaymentDetails
go

create proc uspInsertOPDStaffPaymentDetails(
@PaymentVoucherNo varchar(20),
@VisitNo varchar(20),
@ItemCode varchar(10),
@ItemCategoryID varchar(10),
@Amount money,
@ApprovalStatusID varchar(10),
@ApprovalNotes varchar(200),
@LoginID varchar(20),
@ClientMachine Varchar(40)
--@RecordDateTime SmallDateTime
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select * from OPDStaffPaymentDetails 
			where PaymentVoucherNo = @PaymentVoucherNo and VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, %s: %s, %s: %s, %s: %s, you are trying to enter already exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo, 'VisitNo', @VisitNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'StaffPayments')
		return 1
	end

if not exists(select PaymentVoucherNo from StaffPayments where PaymentVoucherNo  = @PaymentVoucherNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo, 'StaffPayments')
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

--if not exists(select DataID from LookUpData where DataID = @ItemCode)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Lookup Data')
--		return 1
--	end

if not exists(select DataID from LookUpData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @ApprovalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Approval StatusID', @ApprovalStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into OPDStaffPaymentDetails
(PaymentVoucherNo, VisitNo, ItemCode, ItemCategoryID, Amount, ApprovalStatusID, ApprovalNotes, LoginID, ClientMachine)--, RecordDateTime)
values
(@PaymentVoucherNo, @VisitNo, @ItemCode, @ItemCategoryID, @Amount, @ApprovalStatusID, @ApprovalNotes, @LoginID, @ClientMachine)--, @RecordDateTime)
return 0
end
go

/******************************************************************************************************
exec uspInsertOPDStaffPaymentDetails
******************************************************************************************************/
-- select * from OPDStaffPaymentDetails
-- delete from OPDStaffPaymentDetails


-------------- Update OPDStaffPaymentDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateOPDStaffPaymentDetails')
	drop proc uspUpdateOPDStaffPaymentDetails
go

create proc uspUpdateOPDStaffPaymentDetails(
@PaymentVoucherNo varchar(20),
@VisitNo varchar(20),
@ItemCode varchar(10),
@ItemCategoryID varchar(10),
@Amount money,
@ApprovalStatusID varchar(10),
@ApprovalNotes varchar(200),
@LoginID varchar(20),
@ClientMachine Varchar(40)
--@RecordDateTime SmallDateTime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select * from OPDStaffPaymentDetails 
			where PaymentVoucherNo = @PaymentVoucherNo and VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, %s: %s, %s: %s, %s: %s, you are trying to update does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo, 'VisitNo', @VisitNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'StaffPayments')
		return 1
	end

if not exists(select PaymentVoucherNo from StaffPayments where PaymentVoucherNo  = @PaymentVoucherNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Payment VoucherNo', @PaymentVoucherNo, 'StaffPayments')
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

--if not exists(select DataID from LookUpData where DataID = @ItemCode)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Lookup Data')
--		return 1
--	end

if not exists(select DataID from LookUpData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookUpData where DataID = @ApprovalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Approval StatusID', @ApprovalStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update OPDStaffPaymentDetails set
PaymentVoucherNo = @PaymentVoucherNo, VisitNo = @VisitNo, ItemCode = @ItemCode, ItemCategoryID = @ItemCategoryID,
Amount = @Amount, ApprovalStatusID = @ApprovalStatusID, ApprovalNotes = @ApprovalNotes, LoginID = @LoginID, ClientMachine = @ClientMachine
where PaymentVoucherNo = @PaymentVoucherNo and VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID

 --, RecordDateTime = @RecordDateTime

return 0
end
go

/******************************************************************************************************
exec uspUpdateOPDStaffPaymentDetails '16000002'
exec uspUpdateIPDStaffPaymentDetails '16000002'
******************************************************************************************************/
-- select * from OPDStaffPaymentDetails
-- delete from OPDStaffPaymentDetails


-------------- Get OPDStaffPaymentDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetOPDStaffPaymentDetails')
	drop proc uspGetOPDStaffPaymentDetails
go

create proc uspGetOPDStaffPaymentDetails(
@PaymentVoucherNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select * from OPDStaffPaymentDetails where PaymentVoucherNo = @PaymentVoucherNo )
	begin
		set @ErrorMSG = 'The record(s) with %s: %s, you are searching for do not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PaymentVoucherNo', @PaymentVoucherNo, 'OPDStaffPaymentDetails')
		return 1
	end
else
begin
	select OPDStaffPaymentDetails.PaymentVoucherNo, OPDStaffPaymentDetails.VisitNo, OPDStaffPaymentDetails.ItemCode, Visits.PatientNo,
	dbo.GetFullName(patients.LastName, patients.MiddleName, patients.FirstName) as FullName,	
	dbo.GetLookupDataDes(OPDStaffPaymentDetails.ItemCode) as [Item Code], OPDStaffPaymentDetails.ItemCategoryID, dbo.GetLookupDataDes(Items.ItemCategoryID) as [ItemCategory], 
	dbo.GetItemName(OPDStaffPaymentDetails.ItemCategoryID, OPDStaffPaymentDetails.ItemCode) as ItemName,
	OPDStaffPaymentDetails.Amount, ApprovalStatusID, dbo.GetLookupDataDes(ApprovalStatusID) as [ApprovalStatus], ApprovalNotes,
	OPDStaffPaymentDetails.LoginID, OPDStaffPaymentDetails.ClientMachine, OPDStaffPaymentDetails.RecordDateTime
	from OPDStaffPaymentDetails
	inner join StaffPayments on OPDStaffPaymentDetails.PaymentVoucherNo = StaffPayments.PaymentVoucherNo	
	inner join Visits on OPDStaffPaymentDetails.VisitNo = Visits.VisitNo
	left join patients on visits.PatientNo = patients.patientNo	
	inner join Items on OPDStaffPaymentDetails.VisitNo = Items.VisitNo and OPDStaffPaymentDetails.itemCategoryID = Items.itemCategoryID and OPDStaffPaymentDetails.itemCode = Items.ItemCode
	inner join Logins on OPDStaffPaymentDetails.LoginID = Logins.LoginID	
	where OPDStaffPaymentDetails.PaymentVoucherNo = @PaymentVoucherNo
	
return 0
end
go

/******************************************************************************************************
exec uspGetOPDStaffPaymentDetails
exec uspGetIPDStaffPaymentDetails '16000002'
exec uspGetOPDStaffPaymentDetails '16000012'
select * from IPDStaffPaymentDetails
******************************************************************************************************/
-- select * from OPDStaffPaymentDetails
-- delete from OPDStaffPaymentDetails

-----------------uspUpdateItemsVATPercentage--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateItemsVATPercentage')
	drop proc uspUpdateItemsVATPercentage
go

create proc uspUpdateItemsVATPercentage(
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@VATPercentage decimal

)with encryption as 

declare @ErrorMSG varchar(200)
declare @NotPaidPayStatusID varchar(10)
declare @PercentCoPayTypeID varchar(10)

declare @CoPayTypeID varchar(10)
declare @CoPayPercent decimal(5,2)
declare @Quantity int
declare @CashAmount money

declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)
declare @PackageID varchar(10)
declare @OtherItemsID varchar(10)

begin

	set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
	set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
	set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
	set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
	set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
	set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')
	
	set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
	set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
	set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
	set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
	set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
	set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
	set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
	set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
	set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
	set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')
	set @PackageID = dbo.GetLookupDataID('ItemCategory', 'G')
	set @OtherItemsID = dbo.GetLookupDataID('ItemCategory', 'NM')

	if @ItemCategoryID = @DrugID -- Drugs
		begin 
			if not exists(select DrugNo from Drugs where DrugNo = @ItemCode)
				begin
					set @ErrorMSG = 'The Drug No: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Drugs')	
					return 1
				end
				
			else 
					begin update Drugs set VATPercentage = @VATPercentage where DrugNo = @ItemCode end
					
			end
	else
	if @ItemCategoryID = @ConsumableID -- ConsumableItems

		begin 
			if not exists(select ConsumableNo from ConsumableItems where ConsumableNo = @ItemCode)
				begin
					set @ErrorMSG = 'The Consumable No: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Consumable Items')	
					return 1
				end 
				
			else
					begin update ConsumableItems set VATPercentage = @VATPercentage where ConsumableNo = @ItemCode end
					
			
		end


	else
	if @ItemCategoryID = @OtherItemsID -- Other Items

		begin 
			if not exists(select ItemCode from OtherItems where ItemCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Item Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Item Code')	
					return 1
				end 
				
			else
					begin update OtherItems set VATPercentage = @VATPercentage where ItemCode = @ItemCode end
					
			
		end


	else
	if @ItemCategoryID = @ProcedureID -- Procedures

		begin 
			if not exists(select ProcedureCode from Procedures where ProcedureCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Procedure Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Procedures')	
					return 1
				end 
				
			else 
					begin update Procedures set  VATPercentage = @VATPercentage where ProcedureCode = @ItemCode end
					
			end		
				
	else
	if @ItemCategoryID = @TestID -- LabTests

		begin 
			if not exists(select TestCode from LabTests where TestCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Test Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Lab Tests')	
					return 1
				end 
				
			
								
				else begin update LabTests set VATPercentage = @VATPercentage where TestCode = @ItemCode end  
		end	
	else

	if @ItemCategoryID = @CardiologyID -- CardiologyExaminations

		begin 
			if not exists(select ExamCode from CardiologyExaminations where ExamCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Exam Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Cardiology Examinations')	
					return 1
				end 
				
				
				else begin update CardiologyExaminations set VATPercentage = @VATPercentage where ExamCode = @ItemCode end  
		end	
	else

	if @ItemCategoryID = @RadiologyID -- RadiologyExaminations

		begin 
			if not exists(select ExamCode from RadiologyExaminations where ExamCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Exam Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Radiology Examinations')	
					return 1
				end 
				
				
				else begin update RadiologyExaminations set VATPercentage = @VATPercentage where ExamCode = @ItemCode end  
		end	
	else
	if @ItemCategoryID = @PathologyID -- PathologyExaminations

		begin 
			if not exists(select ExamCode from PathologyExaminations where ExamCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Exam Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Pathology Examinations')	
					return 1
				end 
				
			
					
				else begin update PathologyExaminations set VATPercentage = @VATPercentage where ExamCode = @ItemCode end
		end	
	else
	if @ItemCategoryID = @DentalID -- DentalServices

		begin 
			if not exists(select DentalCode from DentalServices where DentalCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Dental Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Dental Services')	
					return 1
				end 
				
			
					
				else begin update DentalServices set VATPercentage = @VATPercentage where DentalCode = @ItemCode end -- UnitCost = @UnitCost, 
		end	
	else
	if @ItemCategoryID = @TheatreID -- TheatreServices

		begin 
			if not exists(select TheatreCode from TheatreServices where TheatreCode = @ItemCode)
				begin
					set @ErrorMSG = 'The Theatre Code: %s, you''re trying to update does not exist in the registered %s'
					raiserror(@ErrorMSG, 16, 1, @ItemCode, 'Theatre Services')	
					return 1
				end 
				
		
					
				else begin update TheatreServices set VATPercentage = @VATPercentage where TheatreCode = @ItemCode end -- UnitCost = @UnitCost, 
		end
	else
		begin	
			set @ErrorMSG = 'Item Category: %s, not supported!'
			raiserror(@ErrorMSG, 16, 1, @ItemCategoryID)	
			return 1
		end
end
return 0
go

/*--------------------------------------------------------------------------------------------------------
-- exec uspUpdateItemsVATPercentage '7D', 'M00001', 18
select * from Drugs where DrugNo= 'M00001'

---------------------------------------------------------------------------------------------------------*/

-------------- Insert ReceiptInvoiceDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertReceiptInvoiceDetails')
	drop proc uspInsertReceiptInvoiceDetails
go

create proc uspInsertReceiptInvoiceDetails(
@InvoiceNo varchar(20),
@ReceiptNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select InvoiceNo from ReceiptInvoiceDetails where InvoiceNo = @InvoiceNo and ReceiptNo = @ReceiptNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'InvoiceNo', @InvoiceNo, 'ReceiptNo', @ReceiptNo)
		return 1
	end



begin
insert into ReceiptInvoiceDetails
(InvoiceNo, ReceiptNo)
values
(@InvoiceNo, @ReceiptNo)
return 0
end
go

/******************************************************************************************************
exec uspInsertReceiptInvoiceDetails
******************************************************************************************************/
-- select * from ReceiptInvoiceDetails
-- delete from ReceiptInvoiceDetails


-------------- Update ReceiptInvoiceDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateReceiptInvoiceDetails')
	drop proc uspUpdateReceiptInvoiceDetails
go

create proc uspUpdateReceiptInvoiceDetails(
@InvoiceNo varchar(20),
@ReceiptNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select InvoiceNo from ReceiptInvoiceDetails where InvoiceNo = @InvoiceNo and ReceiptNo = @ReceiptNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'InvoiceNo', @InvoiceNo, 'ReceiptNo', @ReceiptNo, 'ReceiptInvoiceDetails')
		return 1
	end



begin
update ReceiptInvoiceDetails set InvoiceNo = @InvoiceNo, ReceiptNo = @ReceiptNo
where InvoiceNo = @InvoiceNo and ReceiptNo = @ReceiptNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateReceiptInvoiceDetails
******************************************************************************************************/
-- select * from ReceiptInvoiceDetails
-- delete from ReceiptInvoiceDetails


-------------- Get ReceiptInvoiceDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetReceiptInvoiceDetails')
	drop proc uspGetReceiptInvoiceDetails
go

create proc uspGetReceiptInvoiceDetails(
@InvoiceNo varchar(20),
@ReceiptNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select InvoiceNo from ReceiptInvoiceDetails where InvoiceNo = @InvoiceNo and ReceiptNo = @ReceiptNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'InvoiceNo', @InvoiceNo, 'ReceiptNo', @ReceiptNo, 'ReceiptInvoiceDetails')
		return 1
	end
else
begin
	select InvoiceNo, ReceiptNo
	from ReceiptInvoiceDetails

	where InvoiceNo = @InvoiceNo and ReceiptNo = @ReceiptNo
return 0
end
go

/******************************************************************************************************
exec uspGetReceiptInvoiceDetails
******************************************************************************************************/
-- select * from ReceiptInvoiceDetails
-- delete from ReceiptInvoiceDetails

------------------------------------------------------------------------------------------------------
-------------- TBIntensifiedCaseFinding --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert TBIntensifiedCaseFinding -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertTBIntensifiedCaseFinding')
	drop proc uspInsertTBIntensifiedCaseFinding
go

create proc uspInsertTBIntensifiedCaseFinding(
@VisitNo varchar(20),
@CoughingTwoWeeksMoreID varchar(10),
@PersistantFeversID varchar(10),
@NoticableWeightLossID varchar(10),
@ExcessiveNightSweatsID varchar(10),
@PoorWeightGainID varchar(10),
@PulmonaryTBChronicCoughContactID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @YesNo varchar(10)



if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if exists(select VisitNo from TBIntensifiedCaseFinding where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CoughingTwoWeeksMoreID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCategoryID', @CoughingTwoWeeksMoreID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PersistantFeversID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PersistantFeversID', @PersistantFeversID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @NoticableWeightLossID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'NoticableWeightLossID', @NoticableWeightLossID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ExcessiveNightSweatsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ExcessiveNightSweatsID', @ExcessiveNightSweatsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PoorWeightGainID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PoorWeightGainID', @PoorWeightGainID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PulmonaryTBChronicCoughContactID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PulmonaryTBChronicCoughContactID', @PulmonaryTBChronicCoughContactID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin tran

begin
if not (@VisitNo is null or @VisitNo = '' and @CoughingTwoWeeksMoreID ='54Y' and @PersistantFeversID ='54Y') 
begin update Visits set VisitsPriorityID = '155EM' where VisitNo = @VisitNo end
end
---------------------------------------------------------------------------------------------------------------------------------
begin
insert into TBIntensifiedCaseFinding
(VisitNo, CoughingTwoWeeksMoreID, PersistantFeversID, NoticableWeightLossID, ExcessiveNightSweatsID, PoorWeightGainID,
 PulmonaryTBChronicCoughContactID, LoginID)
values
(@VisitNo, @CoughingTwoWeeksMoreID, @PersistantFeversID, @NoticableWeightLossID, @ExcessiveNightSweatsID, @PoorWeightGainID,
 @PulmonaryTBChronicCoughContactID, @LoginID)
---------------------------------------------------------------------------------------------------------------------------------

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran

end
return 0

go

/******************************************************************************************************
exec uspInsertTBIntensifiedCaseFinding
******************************************************************************************************/
-- select * from TBIntensifiedCaseFinding
-- delete from TBIntensifiedCaseFinding


-------------- Update TBIntensifiedCaseFinding -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateTBIntensifiedCaseFinding')
	drop proc uspUpdateTBIntensifiedCaseFinding
go

create proc uspUpdateTBIntensifiedCaseFinding(
@VisitNo varchar(20),
@CoughingTwoWeeksMoreID varchar(10),
@PersistantFeversID varchar(10),
@NoticableWeightLossID varchar(10),
@ExcessiveNightSweatsID varchar(10),
@PoorWeightGainID varchar(10),
@PulmonaryTBChronicCoughContactID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from TBIntensifiedCaseFinding where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'TBIntensifiedCaseFinding')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CoughingTwoWeeksMoreID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCategoryID', @CoughingTwoWeeksMoreID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PersistantFeversID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PersistantFeversID', @PersistantFeversID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @NoticableWeightLossID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'NoticableWeightLossID', @NoticableWeightLossID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ExcessiveNightSweatsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ExcessiveNightSweatsID', @ExcessiveNightSweatsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PoorWeightGainID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PoorWeightGainID', @PoorWeightGainID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PulmonaryTBChronicCoughContactID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PulmonaryTBChronicCoughContactID', @PulmonaryTBChronicCoughContactID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update TBIntensifiedCaseFinding set
CoughingTwoWeeksMoreID = @CoughingTwoWeeksMoreID, PersistantFeversID = @PersistantFeversID, NoticableWeightLossID = @NoticableWeightLossID,
 ExcessiveNightSweatsID = @ExcessiveNightSweatsID, PoorWeightGainID = @PoorWeightGainID, PulmonaryTBChronicCoughContactID = @PulmonaryTBChronicCoughContactID,
  LoginID = @LoginID
where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateTBIntensifiedCaseFinding
******************************************************************************************************/
-- select * from TBIntensifiedCaseFinding
-- delete from TBIntensifiedCaseFinding


-------------- Get TBIntensifiedCaseFinding -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTBIntensifiedCaseFinding')
	drop proc uspGetTBIntensifiedCaseFinding
go

create proc uspGetTBIntensifiedCaseFinding(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from TBIntensifiedCaseFinding where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'TBIntensifiedCaseFinding')
		return 1
	end
else
begin
	select VisitNo, CoughingTwoWeeksMoreID, dbo.GetLookupDataDes(CoughingTwoWeeksMoreID) as [ItemCategoryID], 
	PersistantFeversID, dbo.GetLookupDataDes(PersistantFeversID) as [PersistantFeversID], NoticableWeightLossID,
	 dbo.GetLookupDataDes(NoticableWeightLossID) as [NoticableWeightLossID], ExcessiveNightSweatsID, 
	 dbo.GetLookupDataDes(ExcessiveNightSweatsID) as [ExcessiveNightSweatsID], PoorWeightGainID,
	  dbo.GetLookupDataDes(PoorWeightGainID) as [PoorWeightGainID], PulmonaryTBChronicCoughContactID, 
	  dbo.GetLookupDataDes(PulmonaryTBChronicCoughContactID) as [PulmonaryTBChronicCoughContactID], 
	  TBIntensifiedCaseFinding.LoginID, ClientMachine, RecordDateTime
	from TBIntensifiedCaseFinding
	
	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetTBIntensifiedCaseFinding
******************************************************************************************************/
-- select * from TBIntensifiedCaseFinding
-- delete from TBIntensifiedCaseFinding

------------------------------------------------------------------------------------------------------
-------------- RevenueStreams --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert RevenueStreams -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditRevenueStreams')
	drop proc uspEditRevenueStreams
go

create proc uspEditRevenueStreams(
@RevenueStreamCode varchar(20),
@Name varchar(40),
@Hidden bit
)with encryption as

declare @ErrorMSG varchar(200)
begin
if exists(select RevenueStreamCode from RevenueStreams where RevenueStreamCode = @RevenueStreamCode)
	begin
		update RevenueStreams set
Name = @Name, Hidden = @Hidden, RecordDateTime = getdate()
where RevenueStreamCode = @RevenueStreamCode
	end


else
begin
insert into RevenueStreams
(RevenueStreamCode, Name, Hidden)
values
(@RevenueStreamCode, @Name, @Hidden)
end
return 0
end
go

/******************************************************************************************************
exec uspInsertRevenueStreams
******************************************************************************************************/
-- select * from RevenueStreams
-- delete from RevenueStreams


-------------- Update RevenueStreams -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateRevenueStreams')
	drop proc uspUpdateRevenueStreams
go

create proc uspUpdateRevenueStreams(
@RevenueStreamCode varchar(20),
@Name varchar(40),
@Hidden bit,
@RecordDateTime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RevenueStreamCode from RevenueStreams where RevenueStreamCode = @RevenueStreamCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Resource Code', @RevenueStreamCode, 'RevenueStreams')
		return 1
	end



begin
update RevenueStreams set
Name = @Name, Hidden = @Hidden, RecordDateTime = @RecordDateTime
where RevenueStreamCode = @RevenueStreamCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateRevenueStreams
******************************************************************************************************/
-- select * from RevenueStreams
-- delete from RevenueStreams


-------------- Get RevenueStreams -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRevenueStreams')
	drop proc uspGetRevenueStreams
go

create proc uspGetRevenueStreams(
@RevenueStreamCode varchar(20)=null
)with encryption as

declare @ErrorMSG varchar(200)
if not (@RevenueStreamCode='' or @RevenueStreamCode is null)
begin
	if not exists(select RevenueStreamCode from RevenueStreams where RevenueStreamCode = @RevenueStreamCode)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Resource Code', @RevenueStreamCode, 'RevenueStreams')
			return 1
		end
	else
	  begin
		select RevenueStreamCode, Name, Hidden, RecordDateTime
		from RevenueStreams

		where RevenueStreamCode = @RevenueStreamCode
		end
 end
else
  begin
  select RevenueStreamCode, Name, Hidden, RecordDateTime
	from RevenueStreams
  end
return 0
go

/******************************************************************************************************
exec uspGetRevenueStreams
******************************************************************************************************/
-- select * from RevenueStreams
-- delete from RevenueStreams


------------------------------------------------------------------------------------------------------
-------------- RejectedSpecimens --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert RejectedSpecimens -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertRejectedSpecimens')
	drop proc uspInsertRejectedSpecimens
go

create proc uspInsertRejectedSpecimens(
@SpecimenNo varchar(20),
@VisitNo varchar(20),
@RejectectionReasonID varchar(10),
@RejectionDate smalldatetime,
@RejectedAt varchar(10),
@RejectedBy varchar(40),
@IsReAccepted bit,
@LoginID varchar(20),
@ClientMachine varchar(40),
@RecordDateTime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select SpecimenNo from RejectedSpecimens where SpecimenNo = @SpecimenNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Specimen No', @SpecimenNo)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into RejectedSpecimens
(SpecimenNo, VisitNo, RejectectionReasonID, RejectionDate, RejectedAt, RejectedBy, IsReAccepted, LoginID, ClientMachine, RecordDateTime)
values
(@SpecimenNo, @VisitNo, @RejectectionReasonID, @RejectionDate, @RejectedAt, @RejectedBy, @IsReAccepted, @LoginID, @ClientMachine, @RecordDateTime)
return 0
end
go

/******************************************************************************************************
exec uspInsertRejectedSpecimens
******************************************************************************************************/
-- select * from RejectedSpecimens
-- delete from RejectedSpecimens


-------------- Update RejectedSpecimens -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateRejectedSpecimens')
	drop proc uspUpdateRejectedSpecimens
go

create proc uspUpdateRejectedSpecimens(
@SpecimenNo varchar(20),
@VisitNo varchar(20),
@RejectectionReasonID varchar(10),
@RejectionDate smalldatetime,
@RejectedAt varchar(10),
@RejectedBy varchar(40),
@IsReAccepted bit,
@LoginID varchar(20),
@ClientMachine varchar(40),
@RecordDateTime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SpecimenNo from RejectedSpecimens where SpecimenNo = @SpecimenNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Specimen No', @SpecimenNo, 'RejectedSpecimens')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update RejectedSpecimens set
VisitNo = @VisitNo, RejectectionReasonID = @RejectectionReasonID, RejectionDate = @RejectionDate, RejectedAt = @RejectedAt, RejectedBy = @RejectedBy, IsReAccepted = @IsReAccepted, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
where SpecimenNo = @SpecimenNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateRejectedSpecimens
******************************************************************************************************/
-- select * from RejectedSpecimens
-- delete from RejectedSpecimens


-------------- Get RejectedSpecimens -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRejectedSpecimens')
	drop proc uspGetRejectedSpecimens
go

create proc uspGetRejectedSpecimens(
@SpecimenNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SpecimenNo from RejectedSpecimens where SpecimenNo = @SpecimenNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Specimen No', @SpecimenNo, 'RejectedSpecimens')
		return 1
	end
else
begin
	select SpecimenNo, VisitNo, RejectectionReasonID, RejectionDate, RejectedAt, RejectedBy, IsReAccepted, RejectedSpecimens.LoginID, ClientMachine, RecordDateTime
	from RejectedSpecimens
	inner join Logins on RejectedSpecimens.LoginID = Logins.LoginID
	where SpecimenNo = @SpecimenNo
return 0
end
go

/******************************************************************************************************
exec uspGetRejectedSpecimens
******************************************************************************************************/
-- select * from RejectedSpecimens
-- delete from RejectedSpecimens


------------------------------------------------------------------------------------------------------
-------------- Packages --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Packages -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPackages')
	drop proc uspInsertPackages
go

create proc uspInsertPackages(
@PackageNo varchar(20),
@PackageName varchar(200),
@UnitCost money,
@UnitPrice money,
@ExpiryDays int,
@RevenueStreamCode varchar(20),
@Hidden bit,
@MonitorQty bit,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @PackageID Int
declare @PackageNoPrefix varchar(1)

if exists(select PackageNo from Packages where PackageNo = @PackageNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'PackageNo', @PackageNo)
		return 1
	end

--if not exists(select RevenueStreamCode from RevenueStreams where RevenueStreamCode  = @RevenueStreamCode)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'RevenueStreamCode', @RevenueStreamCode, 'RevenueStreams')
--		return 1
--	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
	set @PackageNoPrefix = dbo.GetOptionValue('PackageNoPrefix')
	set @PackageID = (select max(PackageID) from Packages where left(PackageNo, len(@PackageNoPrefix)) = @PackageNoPrefix)
	set @PackageID = dbo.GetNextAutoNumber('Packages', 'PackageNo', @PackageID)	

insert into Packages
(PackageID, PackageNo, PackageName,UnitCost, UnitPrice,ExpiryDays, RevenueStreamCode, Hidden, LoginID)
values
(@PackageID, @PackageNo, @PackageName,@UnitCost, @UnitPrice,@ExpiryDays, @RevenueStreamCode, @Hidden, @LoginID)

return 0
end
go

/******************************************************************************************************
exec uspInsertPackages
******************************************************************************************************/
-- select * from Packages
-- delete from Packages


---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextPackageID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextPackageID')
	drop proc uspGetNextPackageID
go
create proc uspGetNextPackageID(
@PackageID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @PackageNoPrefix varchar(1)

set @PackageNoPrefix =dbo.GetOptionValue('PackageNoPrefix')

set @PackageID = (select max(PackageID) from Packages where left(PackageNo, len(@PackageNoPrefix)) = @PackageNoPrefix)
set @PackageID =  dbo.GetNextAutoNumber('Packages', 'PackageNo', @PackageID)

return 0
go



-------------- Update Packages -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePackages')
	drop proc uspUpdatePackages
go

create proc uspUpdatePackages(
@PackageNo varchar(20),
@PackageName varchar(200),
@UnitCost money,
@UnitPrice money,
@ExpiryDays int,
@RevenueStreamCode varchar(20),
@Hidden bit,
@MonitorQty bit,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PackageNo from Packages where PackageNo = @PackageNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PackageNo', @PackageNo, 'Packages')
		return 1
	end

--if not exists(select RevenueStreamCode from RevenueStreams where RevenueStreamCode  = @RevenueStreamCode)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'RevenueStreamCode', @RevenueStreamCode, 'RevenueStreams')
--		return 1
--	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update Packages set
PackageName = @PackageName,UnitCost=@UnitCost, UnitPrice = @UnitPrice, RevenueStreamCode = @RevenueStreamCode,ExpiryDays=@ExpiryDays,
Hidden = @Hidden,MonitorQty=@MonitorQty, LoginID = @LoginID
where PackageNo = @PackageNo
return 0
end
go

/******************************************************************************************************
exec uspUpdatePackages
******************************************************************************************************/
-- select * from Packages
-- delete from Packages


-------------- Get Packages -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPackages')
	drop proc uspGetPackages
go

create proc uspGetPackages(
@PackageNo varchar(20)=null
)with encryption as

declare @ErrorMSG varchar(200)
if @PackageNo is not null
begin
	select PackageNo, PackageName,UnitCost, UnitPrice, Packages.RevenueStreamCode,Name, 
	Packages.Hidden,MonitorQty, Packages.LoginID,ExpiryDays,ClientMachine, Packages.RecordDateTime
	from Packages
	inner join RevenueStreams on RevenueStreams.RevenueStreamCode=Packages.RevenueStreamCode
	where PackageNo = @PackageNo
end
else
begin
	select PackageNo, PackageName,UnitCost, UnitPrice, Packages.RevenueStreamCode,Name, 
	Packages.Hidden,MonitorQty, Packages.LoginID,ExpiryDays,ClientMachine, Packages.RecordDateTime
	from Packages
	inner join RevenueStreams on RevenueStreams.RevenueStreamCode=Packages.RevenueStreamCode
end
return 0

go
-------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatientActivePackage')
	drop proc uspGetPatientActivePackage
go

create proc uspGetPatientActivePackage(
@PackageNo varchar(20),
@PatientNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select Top 1 dbo.GetHasPackage(@PatientNo,@PackageNo) as PackageStatus from PackageDetails
	
return 0
end
go


/******************************************************************************************************
exec uspGetPatientActivePackage '100Q','SR170151'
******************************************************************************************************/
-- select * from Packages
-- delete from Packages


if exists (select * from sysobjects where name = 'uspGetPackageName')
	drop proc uspGetPackageName
go

create proc uspGetPackageName(
@PackageNo varchar(20) =null
)with encryption as

declare @ErrorMSG varchar(200)
declare @NotHidden as bit = 0

begin
	select PackageNo, PackageName,
	dbo.GetMergedNameCode(PackageName, PackageNo) as PackageFullName
	 from Packages where Hidden =@NotHidden

return 0
end
go


------------------------------------------------------------------------------------------------------
-------------- PackagesEXT --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- uspEditPackagesEXT -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditPackagesEXT')
	drop proc uspEditPackagesEXT
go

create proc uspEditPackagesEXT(
@PackageNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(20),
@Quantity int,
@UnitCost money,
@UnitPrice money,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DataID from LookupData where DataID  = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCategoryID', @ItemCategoryID, 'LookupData')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

if exists(select PackageNo from PackagesEXT where PackageNo = @PackageNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
update PackagesEXT set
Quantity = @Quantity,UnitCost = @UnitCost,UnitPrice = @UnitPrice, LoginID = @LoginID
where PackageNo = @PackageNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	end
else

begin
insert into PackagesEXT
(PackageNo, ItemCode, ItemCategoryID, Quantity,UnitCost,UnitPrice, LoginID)
values
(@PackageNo, @ItemCode, @ItemCategoryID, @Quantity,@UnitCost,@UnitPrice, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspEditPackagesEXT
******************************************************************************************************/
-- select * from PackagesEXT
-- delete from PackagesEXT


-------------- Get PackagesEXT -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPackagesEXT')
	drop proc uspGetPackagesEXT
go

create proc uspGetPackagesEXT(
@PackageNo varchar(20),
@ItemCategoryID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
begin

select PackageNo, ItemCode, ItemCategoryID,dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName,
	dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	Quantity,UnitCost,UnitPrice, PackagesEXT.LoginID, ClientMachine, RecordDateTime
	from PackagesEXT
where PackageNo = @PackageNo and ItemCategoryID = @ItemCategoryID

return 0
end
go

/******************************************************************************************************
exec uspGetPackagesEXT
******************************************************************************************************/
-- select * from PackagesEXT
-- delete from PackagesEXT


-------------- Get Attached Package Prescritions -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAllowedPackagePrescritions')
	drop proc uspGetAllowedPackagePrescritions
go

create proc uspGetAllowedPackagePrescritions(
@packageNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
	begin
	select PackageNo, PackagesEXT.ItemCode, DrugName,PackagesEXT.Quantity, 
	PackagesEXT.ItemCategoryID, dbo.GetLookupDataDes(PackagesEXT.ItemCategoryID) as ItemCategory,
	'' as Notes,PackagesEXT.UnitCost,PackagesEXT.UnitPrice,
	dbo.GetMergedNameCode(DrugName, PackagesEXT.ItemCode) as DrugFullName
	from PackagesEXT
     inner join Drugs on PackagesEXT.ItemCode =Drugs.DrugNo
	 where PackageNo =@packageNo
	 group by PackageNo,PackagesEXT.ItemCode,DrugName,Drugs.UnitPrice,PackagesEXT.ItemCategoryID, 
	 dbo.GetMergedNameCode(DrugName, PackagesEXT.ItemCode),PackagesEXT.Quantity, PackagesEXT.UnitCost, PackagesEXT.UnitPrice
end
return 0
go


-------------- Get Attached Package LabTests -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAllowedPackageLabTests')
	drop proc uspGetAllowedPackageLabTests
go

create proc uspGetAllowedPackageLabTests(
@packageNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
	begin
	select PackageNo, PackagesEXT.ItemCode, TestName,1 as Quantity, 
	PackagesEXT.ItemCategoryID, dbo.GetLookupDataDes(PackagesEXT.ItemCategoryID) as ItemCategory,
	PackagesEXT.UnitCost,PackagesEXT.UnitPrice,'' as Notes, dbo.GetUnitMeasure(PackagesEXT.ItemCategoryID,PackagesEXT.ItemCode) as UnitMeasure,
	dbo.GetMergedNameCode(TestName, PackagesEXT.ItemCode) as TestFullName
	from PackagesEXT
     inner join LabTests on PackagesEXT.ItemCode = LabTests.TestCode
	 where PackageNo = @packageNo
	 group by PackageNo,PackagesEXT.ItemCode,TestName,TestFee,PackagesEXT.ItemCategoryID, 
	 dbo.GetMergedNameCode(TestName, PackagesEXT.ItemCode),PackagesEXT.Quantity, PackagesEXT.UnitPrice, PackagesEXT.UnitCost
end
return 0
go


-------------- Get Attached Package ConsumableItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAllowedPackageConsumableItems')
	drop proc uspGetAllowedPackageConsumableItems
go

create proc uspGetAllowedPackageConsumableItems(
@packageNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
	begin
	select PackageNo, PackagesEXT.ItemCode,ConsumableName,PackagesEXT.Quantity, 
	PackagesEXT.ItemCategoryID, dbo.GetLookupDataDes(PackagesEXT.ItemCategoryID) as ItemCategory,
	PackagesEXT.UnitCost,PackagesEXT.UnitPrice,'' as Notes,dbo.GetUnitMeasure(PackagesEXT.ItemCategoryID,PackagesEXT.ItemCode) as UnitMeasure,
	dbo.GetMergedNameCode(ConsumableName, PackagesEXT.ItemCode) as TestFullName,UnitsInStock,isnull(dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)), '') as ExpiryDate,
	Halted,AlternateName,OrderLevel
	from PackagesEXT
     inner join ConsumableItems on PackagesEXT.ItemCode =ConsumableItems.ConsumableNo
	 where PackageNo =@packageNo
	 group by PackageNo,PackagesEXT.ItemCode,ConsumableName, PackagesEXT.UnitPrice,PackagesEXT.ItemCategoryID, dbo.GetMergedNameCode(ConsumableName, PackagesEXT.ItemCode),
	 PackagesEXT.Quantity,UnitsInStock,isnull(dbo.FormatDate(dbo.GetNullDateValue(ExpiryDate)),''),Halted,AlternateName,OrderLevel, PackagesEXT.UnitCost

end
return 0
go



-------------- Get Attached Package CardiologyExaminations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAllowedPackageCardiologyExaminations')
	drop proc uspGetAllowedPackageCardiologyExaminations
go

create proc uspGetAllowedPackageCardiologyExaminations(
@packageNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
	begin
	select PackageNo, PackagesEXT.ItemCode,ExamName,PackagesEXT.Quantity,
	PackagesEXT.UnitCost,PackagesEXT.UnitPrice, 
	PackagesEXT.ItemCategoryID, dbo.GetLookupDataDes(PackagesEXT.ItemCategoryID) as ItemCategory,
	dbo.GetMergedNameCode(ExamName, PackagesEXT.ItemCode) as ExamFullName
	from PackagesEXT
     inner join CardiologyExaminations on PackagesEXT.ItemCode =CardiologyExaminations.ExamCode
	 where PackageNo =@packageNo
	 group by PackageNo,PackagesEXT.ItemCode,ExamName, 	PackagesEXT.UnitCost,PackagesEXT.UnitPrice, PackagesEXT.ItemCategoryID, dbo.GetMergedNameCode(ExamName, PackagesEXT.ItemCode),
	 PackagesEXT.Quantity
end
return 0
go


-------------- Get Attached Package RadiologyExaminations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAllowedPackageRadiologyExaminations')
	drop proc uspGetAllowedPackageRadiologyExaminations
go

create proc uspGetAllowedPackageRadiologyExaminations(
@packageNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
	begin
	select PackageNo, PackagesEXT.ItemCode,ExamName,PackagesEXT.Quantity,
	PackagesEXT.UnitCost,PackagesEXT.UnitPrice, 
	PackagesEXT.ItemCategoryID, dbo.GetLookupDataDes(PackagesEXT.ItemCategoryID) as ItemCategory,
	dbo.GetMergedNameCode(ExamName, PackagesEXT.ItemCode) as ExamFullName
	from PackagesEXT
     inner join RadiologyExaminations on PackagesEXT.ItemCode =RadiologyExaminations.ExamCode
	 where PackageNo =@packageNo
	 group by PackageNo,PackagesEXT.ItemCode,ExamName, PackagesEXT.UnitCost, PackagesEXT.UnitPrice,PackagesEXT.ItemCategoryID, dbo.GetMergedNameCode(ExamName, PackagesEXT.ItemCode),
	 PackagesEXT.Quantity
end
return 0
go


-------------- Get Attached Package Procedures -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAllowedPackageProcedures')
	drop proc uspGetAllowedPackageProcedures
go

create proc uspGetAllowedPackageProcedures(
@packageNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
-----------------------------------------------------------------------------------------------
	begin
	select PackageNo, PackagesEXT.ItemCode, ProcedureName,1 as Quantity,ProcedureCode, 
	PackagesEXT.ItemCategoryID, dbo.GetLookupDataDes(PackagesEXT.ItemCategoryID) as ItemCategory,
	PackagesEXT.UnitCost,PackagesEXT.UnitPrice,'' as Notes, dbo.GetUnitMeasure(PackagesEXT.ItemCategoryID,PackagesEXT.ItemCode) as UnitMeasure,
	dbo.GetMergedNameCode(ProcedureName, PackagesEXT.ItemCode) as ProcedureFullName
	from PackagesEXT
     inner join Procedures on PackagesEXT.ItemCode =Procedures.ProcedureCode
	 where PackageNo = @packageNo
	 group by PackageNo,PackagesEXT.ItemCode,ProcedureCode,ProcedureName, PackagesEXT.UnitPrice, PackagesEXT.UnitCost,PackagesEXT.ItemCategoryID, dbo.GetMergedNameCode(ProcedureName, PackagesEXT.ItemCode),PackagesEXT.Quantity
end
return 0
go
-----------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
-------------- LabTestsEXTPossibleResults --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert LabTestsEXTPossibleResults -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertLabTestsEXTPossibleResults')
	drop proc uspInsertLabTestsEXTPossibleResults
go

create proc uspInsertLabTestsEXTPossibleResults(
@TestCode varchar(20),
@SubTestCode varchar(20),
@PossibleResults varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TestCode from LabTests where TestCode  = @TestCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TestCode', @TestCode, 'LabTests')
		return 1
	end

if not exists(select SubTestCode from LabTestsEXT where SubTestCode  = @SubTestCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TestCodeEXT', @SubTestCode, 'LabTestsEXT')
		return 1
	end

if exists(select TestCode from LabTestsEXTPossibleResults where TestCode = @TestCode and SubTestCode = @SubTestCode and PossibleResults = @PossibleResults)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'TestCode', @TestCode, 'TestCodeEXT', @SubTestCode, 'PossibleResults', @PossibleResults)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into LabTestsEXTPossibleResults
(TestCode, SubTestCode, PossibleResults, LoginID)
values
(@TestCode, @SubTestCode, @PossibleResults, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertLabTestsEXTPossibleResults
******************************************************************************************************/
-- select * from LabTestsEXTPossibleResults
-- delete from LabTestsEXTPossibleResults


-------------- Update LabTestsEXTPossibleResults -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateLabTestsEXTPossibleResults')
	drop proc uspUpdateLabTestsEXTPossibleResults
go

create proc uspUpdateLabTestsEXTPossibleResults(
@TestCode varchar(20),
@SubTestCode varchar(20),
@PossibleResults varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TestCode from LabTestsEXTPossibleResults where TestCode = @TestCode and SubTestCode = @SubTestCode and PossibleResults = @PossibleResults)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TestCode', @TestCode, 'TestCodeEXT', @SubTestCode, 'PossibleResults', @PossibleResults, 'LabTestsEXTPossibleResults')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update LabTestsEXTPossibleResults set
LoginID = @LoginID
where TestCode = @TestCode and SubTestCode = @SubTestCode and PossibleResults = @PossibleResults
return 0
end
go

/******************************************************************************************************
exec uspUpdateLabTestsEXTPossibleResults
******************************************************************************************************/
-- select * from LabTestsEXTPossibleResults
-- delete from LabTestsEXTPossibleResults


-------------- Get LabTestsEXTPossibleResults -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabTestsEXTPossibleResults')
	drop proc uspGetLabTestsEXTPossibleResults
go

create proc uspGetLabTestsEXTPossibleResults(
@TestCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select LabTestsEXTPossibleResults.TestCode, LabTestsEXTPossibleResults.SubTestCode,
	dbo.GetMergedNameCode(SubTestName, LabTestsEXTPossibleResults.SubTestCode) as TestFullName, PossibleResults, 
	LabTestsEXTPossibleResults.LoginID, ClientMachine, RecordDateTime
	from LabTestsEXTPossibleResults
	inner join LabTestsEXT on LabTestsEXTPossibleResults.TestCode = LabTestsEXTPossibleResults.TestCode and LabTestsEXT.SubTestCode = LabTestsEXTPossibleResults.SubTestCode
	where LabTestsEXTPossibleResults.TestCode = @TestCode
return 0
end
go

/******************************************************************************************************
exec uspGetLabTestsEXTPossibleResults
******************************************************************************************************/
-- select * from LabTestsEXTPossibleResults
-- delete from LabTestsEXTPossibleResults

--------GetLabTestsWithSubTests------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabTestsWithSubTests')
	drop proc uspGetLabTestsWithSubTests
go

create proc uspGetLabTestsWithSubTests(
@TestCode varchar(20) =null)
with encryption as

declare @ErrorMSG varchar(200)
declare @Hidden bit = 0

begin
select TestCode,TestName,dbo.GetMergedNameCode(TestName, TestCode) as TestFullName from LabTests
where dbo.GetHasSubTests(TestCode) =1 and (Hidden = @Hidden)
end

--------------------------------------------------------------------------------------------------------------------------------

return 0

go

--------GetLabTestsSubTests------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabTestsSubTests')
	drop proc uspGetLabTestsSubTests
go

create proc uspGetLabTestsSubTests(
@TestCode varchar(20))
with encryption as

declare @ErrorMSG varchar(200)
declare @Hidden bit = 0

begin
select SubTestCode,SubTestName,dbo.GetMergedNameCode(SubTestName, SubTestCode) as TestFullName from LabTestsEXT
Where TestCode =@TestCode and (Hidden = @Hidden)
end

--------------------------------------------------------------------------------------------------------------------------------

return 0

go


--------GetLabSubTestsPerTest------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabSubTestsPerTest')
	drop proc uspGetLabSubTestsPerTest
go

create proc uspGetLabSubTestsPerTest(
@SubTestCode varchar(20))
with encryption as

declare @ErrorMSG varchar(200)


begin
select SubTestName, LabTestsEXTPossibleResults.SubTestCode,PossibleResults  from LabTestsEXTPossibleResults
inner join LabTestsEXT on LabTestsEXTPossibleResults.SubTestCode =LabTestsEXT.SubTestCode
WHERE LabTestsEXTPossibleResults.SubTestCode =@SubTestCode
end

--------------------------------------------------------------------------------------------------------------------------------

return 0

go



--------uspGetHasPossibleSubTestsResults-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetHasPossibleSubTestsResults')
	drop proc uspGetHasPossibleSubTestsResults
go

create proc uspGetHasPossibleSubTestsResults(
@SubTestCode varchar(20),
@Records tinyint = null output
)with encryption as

set @Records = (select count(SubTestCode) from LabTestsEXTPossibleResults 
				where SubTestCode = @SubTestCode)
set @Records = isnull(@Records, 0)

return 0

go

--------------Dr frequently Requested Test-------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDrfrequentlyRequestedTest')
	drop proc uspGetDrfrequentlyRequestedTest
go

create proc uspGetDrfrequentlyRequestedTest(
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @LabCategoryID varchar(10)
begin
set @LabCategoryID = dbo.GetLookupDataID('ItemCategory', 'T')
	select distinct TOP 15 ItemCode, dbo.GetMergedNameCode(TestName, TestCode) as ItemName,Hidden
	from Items 
	inner join labTests on labTests.testcode =Items.ItemCode
   where Items.CreatorLoginID = @LoginID  and ItemCategoryID = @LabCategoryID
  
   
return 0
end
go



-------------- Get Lab Test By Lab Type-------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLabTestByLabType')
	drop proc uspGetLabTestByLabType
go

create proc uspGetLabTestByLabType(
@LabsID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)
begin
	select TestCode as ItemCode, dbo.GetMergedNameCode(TestName, TestCode) as ItemName,Hidden
	from Labtests
   where labsid= @LabsID 
return 0
end
go
------------------------------------------------------------------------------------------------------
-------------- AttachPackage --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert AttachPackage -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAttachPackage')
	drop proc uspInsertAttachPackage
go

create proc uspInsertAttachPackage(
@VisitNo varchar(20),
@PatientNo varchar(20),
@PackageNo varchar(20),
@PackageVisitNo varchar(20),
@Details varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @PackageExpiryDays int
declare @PackageEndDate smallDateTime
------------------------------------------------------------------------------------------------------
Set @PackageExpiryDays =isnull ((select ExpiryDays from Packages where PackageNo =@PackageNo),0)
Set @PackageEndDate =(GETDATE() + @PackageExpiryDays)
------------------------------------------------------------------------------------------------------

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if not exists(select PackageNo from Packages where PackageNo  = @PackageNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PackageNo', @PackageNo, 'Packages')
		return 1
	end

if exists(select VisitNo from AttachPackage where VisitNo = @VisitNo and PackageNo = @PackageNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'PackageNo', @PackageNo)
		return 1
	end

if not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PatientNo', @PatientNo, 'Patients')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into AttachPackage
(VisitNo, PatientNo, PackageNo,PackageVisitNo, Details, PackageEndDate, LoginID)
values
(@VisitNo, @PatientNo, @PackageNo,@PackageVisitNo, @Details, @PackageEndDate, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertAttachPackage
******************************************************************************************************/
-- select * from AttachPackage
-- delete from AttachPackage


-------------- Update AttachPackage -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateAttachPackage')
	drop proc uspUpdateAttachPackage
go

create proc uspUpdateAttachPackage(
@VisitNo varchar(20),
@PatientNo varchar(20),
@PackageNo varchar(20),
@Details varchar(200),
@PackageStartDate smallDateTime,
@PackageEndDate smallDateTime,
@LoginID varchar(20),
@ClientMachine varchar(41),
@RecordDateTime smallDateTime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from AttachPackage where VisitNo = @VisitNo and PackageNo = @PackageNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'PackageNo', @PackageNo, 'AttachPackage')
		return 1
	end

if not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PatientNo', @PatientNo, 'Patients')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update AttachPackage set
PatientNo = @PatientNo, Details = @Details, PackageStartDate = @PackageStartDate, PackageEndDate = @PackageEndDate, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
where VisitNo = @VisitNo and PackageNo = @PackageNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateAttachPackage
******************************************************************************************************/
-- select * from AttachPackage
-- delete from AttachPackage


-------------- Get AttachPackage -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAttachPackage')
	drop proc uspGetAttachPackage
go

create proc uspGetAttachPackage(
@VisitNo varchar(20),
@PackageNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from AttachPackage where VisitNo = @VisitNo and PackageNo = @PackageNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'PackageNo', @PackageNo, 'AttachPackage')
		return 1
	end
else
begin
	select VisitNo, AttachPackage.PatientNo, PackageNo, Details, PackageStartDate, PackageEndDate, AttachPackage.LoginID, 
	AttachPackage.ClientMachine, AttachPackage.RecordDateTime
	from AttachPackage
	inner join Patients on AttachPackage.PatientNo = Patients.PatientNo	
	inner join Logins on AttachPackage.LoginID = Logins.LoginID
	where VisitNo = @VisitNo and PackageNo = @PackageNo
return 0
end
go

/******************************************************************************************************
exec uspGetAttachPackage
******************************************************************************************************/
-- select * from AttachPackage
-- delete from AttachPackage

--------GetNextPackageVisitID---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextPackageVisitID')
	drop proc uspGetNextPackageVisitID
go

create proc uspGetNextPackageVisitID(
@AttachPackageID int = null output
)with encryption as

declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @AttachPackageID = (select max(AttachPackageID) from AttachPackage where left(PackageVisitNo, 2) = @CurrentYear)
set @AttachPackageID = dbo.GetNextAutoNumber('AttachPackage', 'PackageVisitNo', @AttachPackageID)

return 0

go

-- exec uspGetNextPackageVisitID
-- select * from AttachPackage


-------------------------uspIsPackageStillOn-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspIsPackageStillOn')
	drop proc  uspIsPackageStillOn
go

create proc  uspIsPackageStillOn(
@PatientNo varchar(20), 
@PackageNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@IsPackageOn bit = null output) with encryption as

begin

declare @ConsumedQtys int
declare @PackageQuantity int
declare @remainingbal int
declare @stillactive bit
declare @finalQuantities int
declare @ItemstatusID varchar(10)
declare @IspatientOnPackage int
set @ItemstatusID = dbo.GetLookupDataID('ItemStatus', 'O')

set @ConsumedQtys =isnull ((select sum(quantity)  from PackageConsumption
inner join PackageCheck on PackageConsumption.PackageVisitNo=PackageCheck.PackageVisitNo
where PatientNo =@PatientNo and ItemCode =@ItemCode and ItemCategoryID = @ItemCategoryID and PackageConsumption.PackageNo =@PackageNo and ItemStatusID=@ItemstatusID
and RemainingDays > 0  and PackageConsumption.PackageVisitNo =(select Top 1 PackageConsumption.PackageVisitNo from PackageConsumption
inner join PackageVisits on PackageConsumption.PackageVisitNo = PackageVisits.PackageVisitNo  
where PatientNo =@PatientNo
order by RecordDateTime desc)),0)


set @IspatientOnPackage =isnull ((select count(PatientNo)  from PackageCheck 
where PatientNo =@PatientNo and PackageNo =@PackageNo
and RemainingDays > 0),0)

set @PackageQuantity = isnull((select Quantity from PackagesEXT where PackageNo =@PackageNo and ItemCode=@ItemCode and ItemCategoryID =@ItemCategoryID),0)

set @finalQuantities= (@PackageQuantity - @ConsumedQtys)

if @finalQuantities > 0 and @IspatientOnPackage >0 begin  set @IsPackageOn =1 end
else begin set @IsPackageOn =0 end

set @finalQuantities = isnull(@IsPackageOn, 0)

RETURN  @finalQuantities
end
go

--- exec uspIsPackageStillOn '1407185','PAC004','7s','OPD001'

--- exec uspIsPackageStillOn '1407185','001','7s','10D'

------------------------------------------------------------------------------------------------------
-------------- IPDCancerDiagnosis --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert IPDCancerDiagnosis -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertIPDCancerDiagnosis')
	drop proc uspInsertIPDCancerDiagnosis
go

create proc uspInsertIPDCancerDiagnosis(
@RoundNo varchar(20),
@DiseaseNo varchar(20),
@TopographicalNo varchar(20),
@BasisOfDiagnosisID varchar(10),
@CancerStageID varchar(10),
@Notes varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(41),
@RecordDateTime smallDateTime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDDoctor where RoundNo  = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPDDoctor')
		return 1
	end

if not exists(select DiseaseNo from CancerDiseases where DiseaseNo  = @DiseaseNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Disease No', @DiseaseNo, 'CancerDiseases')
		return 1
	end



if not exists(select TopographicalNo from TopologySites where TopographicalNo  = @TopographicalNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Topographical No', @TopographicalNo, 'TopologySites')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BasisOfDiagnosisID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Basis Of Diagnosis', @BasisOfDiagnosisID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CancerStageID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cancer Stage', @CancerStageID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
if exists(select RoundNo from IPDCancerDiagnosis where RoundNo = @RoundNo and DiseaseNo = @DiseaseNo)
	begin
		update IPDCancerDiagnosis set
TopographicalNo = @TopographicalNo, BasisOfDiagnosisID = @BasisOfDiagnosisID, CancerStageID = @CancerStageID, Notes = @Notes, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
where RoundNo = @RoundNo and DiseaseNo = @DiseaseNo
		return 0
	end

begin
insert into IPDCancerDiagnosis
(RoundNo, DiseaseNo, TopographicalNo, BasisOfDiagnosisID, CancerStageID, Notes, LoginID, ClientMachine, RecordDateTime)
values
(@RoundNo, @DiseaseNo, @TopographicalNo, @BasisOfDiagnosisID, @CancerStageID, @Notes, @LoginID, @ClientMachine, @RecordDateTime)
return 0
end
go

/******************************************************************************************************
exec uspInsertIPDCancerDiagnosis
******************************************************************************************************/
-- select * from IPDCancerDiagnosis
-- delete from IPDCancerDiagnosis


-------------- Update IPDCancerDiagnosis -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDCancerDiagnosis')
	drop proc uspUpdateIPDCancerDiagnosis
go

create proc uspUpdateIPDCancerDiagnosis(
@RoundNo varchar(20),
@DiseaseNo varchar(20),
@TopographicalNo varchar(20),
@BasisOfDiagnosisID varchar(10),
@CancerStageID varchar(10),
@Notes varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(41),
@RecordDateTime smallDateTime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDCancerDiagnosis where RoundNo = @RoundNo and DiseaseNo = @DiseaseNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Disease No', @DiseaseNo, 'IPDCancerDiagnosis')
		return 1
	end

if not exists(select TopographicalNo from TopologySites where TopographicalNo  = @TopographicalNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Topographical No', @TopographicalNo, 'TopologySites')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BasisOfDiagnosisID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Basis Of Diagnosis', @BasisOfDiagnosisID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CancerStageID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cancer Stage', @CancerStageID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update IPDCancerDiagnosis set
TopographicalNo = @TopographicalNo, BasisOfDiagnosisID = @BasisOfDiagnosisID, CancerStageID = @CancerStageID, Notes = @Notes, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
where RoundNo = @RoundNo and DiseaseNo = @DiseaseNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDCancerDiagnosis
******************************************************************************************************/
-- select * from IPDCancerDiagnosis
-- delete from IPDCancerDiagnosis


-------------- Get IPDCancerDiagnosis -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDCancerDiagnosis')
	drop proc uspGetIPDCancerDiagnosis
go

create proc uspGetIPDCancerDiagnosis(
@RoundNo varchar(20),
@DiseaseNo varchar(20)=null
)with encryption as

declare @ErrorMSG varchar(200)

if not @DiseaseNo is null
begin
if not exists(select RoundNo from IPDCancerDiagnosis where RoundNo = @RoundNo and DiseaseNo = @DiseaseNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Disease No', @DiseaseNo, 'IPDCancerDiagnosis')
		return 1
	end
else
begin
	select RoundNo, IPDCancerDiagnosis.DiseaseNo, IPDCancerDiagnosis.TopographicalNo, 
	BasisOfDiagnosisID, dbo.GetLookupDataDes(BasisOfDiagnosisID) as
	 BasisOfDiagnosis, CancerStageID,CancerDiseaseCategoriesID, dbo.GetLookupDataDes(CancerDiseaseCategoriesID) as CancerDiseaseCategory,
	 dbo.GetLookupDataDes(CancerStageID) as CancerStage,
	 Notes, IPDCancerDiagnosis.LoginID, 
	 IPDCancerDiagnosis.ClientMachine, IPDCancerDiagnosis.RecordDateTime
	from IPDCancerDiagnosis
	inner join TopologySites on IPDCancerDiagnosis.TopographicalNo = TopologySites.TopographicalNo	
	inner join Logins on IPDCancerDiagnosis.LoginID = Logins.LoginID	
	inner join CancerDiseases on CancerDiseases.DiseaseNo = IPDCancerDiagnosis.DiseaseNo
	where RoundNo = @RoundNo and IPDCancerDiagnosis.DiseaseNo = @DiseaseNo
return 0
end
end
else
begin
	select RoundNo, IPDCancerDiagnosis.DiseaseNo, IPDCancerDiagnosis.TopographicalNo, 
	BasisOfDiagnosisID, dbo.GetLookupDataDes(BasisOfDiagnosisID) as
	 BasisOfDiagnosis, CancerStageID, 
	 dbo.GetLookupDataDes(CancerStageID) as CancerStage,
	 Notes, IPDCancerDiagnosis.LoginID,CancerDiseaseCategoriesID, dbo.GetLookupDataDes(CancerDiseaseCategoriesID) as CancerDiseaseCategory, 
	 IPDCancerDiagnosis.ClientMachine, IPDCancerDiagnosis.RecordDateTime
	from IPDCancerDiagnosis
	inner join TopologySites on IPDCancerDiagnosis.TopographicalNo = TopologySites.TopographicalNo	
	inner join Logins on IPDCancerDiagnosis.LoginID = Logins.LoginID	
		inner join CancerDiseases on CancerDiseases.DiseaseNo = IPDCancerDiagnosis.DiseaseNo

	where RoundNo = @RoundNo
return 0
end
go

/******************************************************************************************************
exec uspGetIPDCancerDiagnosis '17000201001'
******************************************************************************************************/
-- select * from IPDCancerDiagnosis 
-- delete from IPDCancerDiagnosis

------------------------------------------------------------------------------------------------------
-------------- AccountTransferDetails --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert AccountTransferDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAccountTransferDetails')
	drop proc uspInsertAccountTransferDetails
go

create proc uspInsertAccountTransferDetails(
@TranNo varchar(20),
@FromAccount varchar(20),
@ToAccount varchar(20),
@Amount money,
@AmountInWords varchar(500),
@Reason varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TranNo from Accounts where TranNo  = @TranNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TranNo', @TranNo, 'Accounts')
		return 1
	end

if exists(select TranNo from AccountTransferDetails where TranNo = @TranNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'TranNo', @TranNo)
		return 1
	end

if not exists(select AccountNo from BillCustomers where AccountNo  = @ToAccount)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ToAccount', @ToAccount, 'BillCustomers')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Reason)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Reason', @Reason, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into AccountTransferDetails
(TranNo, FromAccount, ToAccount, Amount, AmountInWords, Reason, LoginID)
values
(@TranNo, @FromAccount, @ToAccount, @Amount, @AmountInWords, @Reason, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertAccountTransferDetails
******************************************************************************************************/
-- select * from AccountTransferDetails
-- delete from AccountTransferDetails


-------------- Update AccountTransferDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateAccountTransferDetails')
	drop proc uspUpdateAccountTransferDetails
go

create proc uspUpdateAccountTransferDetails(
@TranNo varchar(20),
@FromAccount varchar(20),
@ToAccount varchar(20),
@Amount money,
@AmountInWords varchar(500),
@Reason varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TranNo from AccountTransferDetails where TranNo = @TranNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TranNo', @TranNo, 'AccountTransferDetails')
		return 1
	end

if not exists(select AccountNo from BillCustomers where AccountNo  = @ToAccount)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ToAccount', @ToAccount, 'BillCustomers')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Reason)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Reason', @Reason, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update AccountTransferDetails set
FromAccount = @FromAccount, ToAccount = @ToAccount, Amount = @Amount, AmountInWords = @AmountInWords, 
Reason = @Reason, LoginID = @LoginID
where TranNo = @TranNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateAccountTransferDetails
******************************************************************************************************/
-- select * from AccountTransferDetails
-- delete from AccountTransferDetails


-------------- Get AccountTransferDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAccountTransferDetails')
	drop proc uspGetAccountTransferDetails
go

create proc uspGetAccountTransferDetails(
@TranNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TranNo from AccountTransferDetails where TranNo = @TranNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TranNo', @TranNo, 'AccountTransferDetails')
		return 1
	end
else
begin
	select TranNo, FromAccount, AccountTransferDetails.ToAccount, Amount, AmountInWords, Reason, dbo.GetLookupDataDes(Reason) as [Reason], AccountTransferDetails.LoginID, ClientMachine, RecordDateTime
	from AccountTransferDetails
    where TranNo = @TranNo
return 0
end
go

/******************************************************************************************************
exec uspGetAccountTransferDetails
******************************************************************************************************/
-- select * from AccountTransferDetails
-- delete from AccountTransferDetails

------------------------------------------------------------------------------------------------------
-------------- PrintDetails --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PrintDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPrintDetails')
	drop proc uspInsertPrintDetails
go

create proc uspInsertPrintDetails(
@PatientNo varchar(20),
@DocumentNo varchar(20),
@PrintDesc varchar(200),
@PrintCategoryID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select DataID from LookupData where DataID = @PrintCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PrintCategory', @PrintCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into PrintDetails
(PatientNo, DocumentNo, PrintDesc, PrintCategoryID, LoginID)
values
(@PatientNo, @DocumentNo, @PrintDesc, @PrintCategoryID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertPrintDetails
******************************************************************************************************/
-- select * from PrintDetails
-- delete from PrintDetails




/******************************************************************************************************
exec uspUpdatePrintDetails
******************************************************************************************************/
-- select * from PrintDetails
-- delete from PrintDetails


-------------- Get PrintDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPrintDetails')
	drop proc uspGetPrintDetails
go

create proc uspGetPrintDetails(
@PatientNo varchar(20),
@PrintDesc varchar(200),
@RecordDateTime SmallDateTime
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select PatientNo, DocumentNo, PrintDesc, PrintCategoryID, dbo.GetLookupDataDes(PrintCategoryID) as [PrintCategory], PrintDetails.LoginID, ClientMachine, RecordDateTime
	from PrintDetails
	inner join Logins on PrintDetails.LoginID = Logins.LoginID	

	where PatientNo = @PatientNo and PrintDesc = @PrintDesc and RecordDateTime = @RecordDateTime
return 0
end
go

/******************************************************************************************************
exec uspGetPrintDetails
******************************************************************************************************/
-- select * from PrintDetails
-- delete from PrintDetails


--------GetTodaysVisits-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTodaysVisits')
	drop proc uspGetTodaysVisits
go

create proc uspGetTodaysVisits
with encryption as

begin

declare @todaysDate smalldatetime


set @todaysDate = dbo.GetShortDate(getdate())

select VisitNo, Visits.PatientNo, dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,Phone,
dbo.GetLookupDataDes(BillModesID) as BillMode,dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor,
dbo.GetWaitingTime(Visits.RecordDateTime, dbo.GetDoctorRecordDateTime(Visits.VisitNo)) as WaitingTime,
dbo.GetTime(Visits.RecordDateTime) as RecordTime,dbo.GetTime(dbo.GetDoctorRecordDateTime(Visits.VisitNo)) as DoctorTime from Visits
inner join Patients on Visits.PatientNo = Patients.PatientNo
where (VisitDate = @todaysDate)
order by VisitDate desc 

end

return 0
go

-- select * from Visits
-- exec uspGetTodaysVisits

--------GetcountTodaysVisits-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetcountTodaysVisits')
	drop proc uspGetcountTodaysVisits
go

create proc uspGetcountTodaysVisits
with encryption as
begin

declare @todaysDate smalldatetime
set @todaysDate = dbo.GetShortDate(getdate())
select VisitNo from Visits where VisitDate = @todaysDate
end
return 0
go

-- select * from Visits
-- exec uspGetcountTodaysVisits


--------GetTodaysAdmissions----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTodaysAdmissions')
	drop proc uspGetTodaysAdmissions
go

create proc uspGetTodaysAdmissions
with encryption as
declare @todaysDate smalldatetime
declare @InWardAdmissionStatusID varchar(10)
set @InWardAdmissionStatusID = dbo.GetLookupDataID('AdmissionStatus', 'I')
set @todaysDate = dbo.GetShortDate(getdate())
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Admissions.VisitNo, 'Visits', 'VisitNo') as VisitNo, 
			dbo.FormatText(Admissions.AdmissionNo, 'Admissions', 'AdmissionNo') as AdmissionNo, 
			dbo.GetLookupDataDes(WardsID) as Ward, Admissions.BedNo, BedName, 
			Beds.RoomNo, RoomName, dbo.FormatDateTime(AdmissionDateTime) as AdmissionDateTime,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(Admissions.BillModesID, Admissions.BillNo) as BillCustomerName, 
			dbo.FormatDate(VisitDate) as VisitDate
	from Admissions
	inner join Beds on Admissions.BedNo = Beds.BedNo
	inner join Rooms on Beds.RoomNo = Rooms.RoomNo
	inner join Visits on Admissions.VisitNo = Visits.VisitNo	
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where AdmissionStatusID = @InWardAdmissionStatusID 
	and VisitDate =@todaysDate
	order by VisitDate, AdmissionDateTime
end	
return 0
go

-- exec uspGetTodaysAdmissions



------------------------------------------------------------------------------------------------------
-------------- RefundRequests --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert RefundRequests -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertRefundRequests')
	drop proc uspInsertRefundRequests
go

create proc uspInsertRefundRequests(
@RefundRequestNo varchar(20),
@ReceiptNo varchar(20),
@Amount money,
@RequestStatusID varchar(10),
@ApprovalStatusID varchar(10),
@VisitTypeID varchar(10),
@RequestedBy varchar(41),
@LoginID varchar(20),
@ClientMachine varchar(41)
)with encryption as

declare @ErrorMSG varchar(200)
declare @RefundRequestID int
declare @CashVisitPayTypeID varchar(10)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)
declare @IPDRoundPayTypeID varchar(10)
declare @ExtraBillPayTypeID varchar(10)
declare @PayTypeID varchar(10)
declare @AmountPaid money
declare @AmountRefunded money

declare @CurrentYear as char(2)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedRefundRequestID int
declare @PassedRefundRequestNo varchar(20)

set @CashVisitPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')
set @IPDRoundPayTypeID = dbo.GetLookupDataID('PayType', 'IPR')
set @ExtraBillPayTypeID = dbo.GetLookupDataID('PayType', 'EXT')
---------------------------------------------------------------------------------------------
set @PayTypeID = (select PayTypeID from Payments where ReceiptNo = @ReceiptNo)
set @AmountPaid =  dbo.GetAmountPaid(@PayTypeID, @VisitTypeID, @ReceiptNo)
set @AmountRefunded = dbo.GetAmountRefunded(@ReceiptNo) 

if (@Amount <= 0)
	begin
		set @ErrorMSG = 'Zero or less amount not allowed for refund!'
		raiserror(@ErrorMSG, 16, 1)
		return 1
	end

if (@AmountPaid < (@Amount + @AmountRefunded))
	begin
		set @ErrorMSG = 'Total refunded amount can''t be more than receipt amount!'
		raiserror(@ErrorMSG, 16, 1)
		return 1
	end

----------------------------------------------------------------------------------------------------------


if exists(select RefundRequestNo from RefundRequests where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo)
		return 1
	end

if not exists(select ReceiptNo from Payments where ReceiptNo  = @ReceiptNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payments')
		return 1
	end

if (dbo.GetOptionValue('AllowAccountReceiptsRefunds') =0)
begin
 
	if not exists(select ReceiptNo from Payments where ReceiptNo  = @ReceiptNo and 
			PayTypeID in (@CashVisitPayTypeID, @IPDRoundPayTypeID, @ExtraBillPayTypeID))
	begin
		set @ErrorMSG = 'You can only refund cash or bill form payment!'
		raiserror(@ErrorMSG, 16, 1)
		return 1
	end
end
if not exists(select DataID from LookupData where DataID = @RequestStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Request Status', @RequestStatusID, 'Lookup Data')
		return 1
	end

	if not exists(select DataID from LookupData where DataID = @ApprovalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Approval Status', @ApprovalStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

---------------------------------------------------------------------------------------------------------------------

select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'RefundRequests' and AutoColumnName = 'RefundRequestNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'RefundRequests' and AutoColumnName = 'RefundRequestNo'

set @CurrentYear = right(year(getdate()),2)

if (@AutoColumnLEN = len(@RefundRequestNo)) and (left(@RefundRequestNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedRefundRequestID = 1
	set @PassedRefundRequestNo = @RefundRequestNo
	set @PassedRefundRequestNo = ltrim(rtrim(substring(@PassedRefundRequestNo, len(@CurrentYear) + 1, @PaddingLEN)))

	if isnumeric(@PassedRefundRequestNo) = 1 set @PassedRefundRequestID = @PassedRefundRequestNo
	else set @PassedRefundRequestID = 1

	set @RefundRequestID = (select max(RefundRequestID) from RefundRequests where left(RefundRequestNo, len(@CurrentYear)) = @CurrentYear)
	set @RefundRequestID = dbo.GetNextAutoNumber('RefundRequests', 'RefundRequestNo', @RefundRequestID)

	if @PassedRefundRequestID < @RefundRequestID set @RefundRequestID = @PassedRefundRequestID
	if @PassedRefundRequestID > @RefundRequestID set @RefundRequestID = @PassedRefundRequestID

end else set @RefundRequestID = 1
insert into RefundRequests
(RefundRequestID, RefundRequestNo, ReceiptNo, RequestStatusID,ApprovalStatusID, RequestedBy, VisitTypeID, LoginID, ClientMachine)
values
(@RefundRequestID, @RefundRequestNo, @ReceiptNo, @RequestStatusID,@ApprovalStatusID, @RequestedBy, @VisitTypeID, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertRefundRequests
******************************************************************************************************/
-- select * from RefundRequests
-- delete from RefundRequests


-------------- Update RefundRequests -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateRefundRequests')
	drop proc uspUpdateRefundRequests
go

create proc uspUpdateRefundRequests(
@RefundRequestNo varchar(20),
@ReceiptNo varchar(20),
@RequestStatusID varchar(10),
@ApprovalStatusID varchar(10),
@RequestedBy varchar(41),
@VisitTypeID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(41)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundRequests')
		return 1
	end

if not exists(select ReceiptNo from Payments where ReceiptNo  = @ReceiptNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payments')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @RequestStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Request Status', @RequestStatusID, 'Lookup Data')
		return 1
	end

	if not exists(select DataID from LookupData where DataID = @ApprovalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Approval Status', @ApprovalStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update RefundRequests set
 ApprovalStatusID=@ApprovalStatusID, ReceiptNo = @ReceiptNo, RequestStatusID = @RequestStatusID, RequestedBy = @RequestedBy, VisitTypeID = @VisitTypeID, LoginID = @LoginID, ClientMachine = @ClientMachine
where RefundRequestNo = @RefundRequestNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateRefundRequests
******************************************************************************************************/
-- select * from RefundRequests
-- delete from RefundRequests


-------------- Get RefundRequests -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRefundRequests')
	drop proc uspGetRefundRequests
go

create proc uspGetRefundRequests(
@RefundRequestNo varchar(20)=null,
@RequestStatusID varchar(10)=null,
@ApprovalStatusID varchar(20)=null
)with encryption as

declare @ErrorMSG varchar(200)

if not @RefundRequestNo is null
begin
if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundRequests')
		return 1
	end
else
begin
	select  RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID
	where RefundRequestNo = @RefundRequestNo
end
end
else if not @RequestStatusID is null and @ApprovalStatusID is null
begin
	select  RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, -- dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID

	where RefundRequests.RequestStatusID = @RequestStatusID
end

else if not @RequestStatusID is null and not @ApprovalStatusID is null
begin
	select  RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo,-- dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID	

	where RefundRequests.RequestStatusID = @RequestStatusID and ApprovalStatusID=@ApprovalStatusID
end
return 0
go

/******************************************************************************************************
exec uspGetRefundRequests '17000001'

exec uspGetRefundRequests null,'11p'
******************************************************************************************************/
-- select * from RefundRequests
-- delete from RefundRequests


-------------- Get Get To Approve Refund Requests -------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetToApproveRefundRequests')
	drop proc uspGetToApproveRefundRequests
go

create proc uspGetToApproveRefundRequests(
@RefundRequestNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @PendingApprovalStatusID varchar(10)
declare @DoneRequestStatusID varchar(10)

set @DoneRequestStatusID = dbo.GetLookupDataID('ItemStatus', 'D')
set @PendingApprovalStatusID = dbo.GetLookupDataID('ItemStatus', 'P')

if not @RefundRequestNo is null and not (dbo.GetOptionValue('ForceRefundsApproval') > 0)
begin

if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the done %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'Refunds')
		return 1
	end

else
begin
	select RefundRequestID, RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --- dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID
	where RefundRequestNo = @RefundRequestNo
end
end

else if  @RefundRequestNo is null and not (dbo.GetOptionValue('ForceRefundsApproval') > 0)
begin
	select RefundRequestID, RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName, 
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID	

	where RefundRequests.RequestStatusID = @DoneRequestStatusID and ApprovalStatusID=@PendingApprovalStatusID

end




if (dbo.GetOptionValue('ForceRefundsApproval') > 0) and not @RefundRequestNo is null
begin

if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the done %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'Refunds')
		return 1
	end

else
begin
	select RefundRequestID, RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --- dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID
	where RefundRequestNo = @RefundRequestNo
end
end

else
begin
	select RefundRequestID, RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName, 
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID	

	where RefundRequests.RequestStatusID = @PendingApprovalStatusID and ApprovalStatusID=@PendingApprovalStatusID
end



return 0
go


/******************************************************************************************************
exec uspGetToApproveRefundRequests '19000002'
exec uspGetToApproveRefundRequests
******************************************************************************************************/
-- select * from RefundRequests
-- delete from RefundRequests


-------------- Get  Refund Requests -------------------------------------------------------------


if exists (select * from sysobjects where name = 'uspGetToRefundRequests')
	drop proc uspGetToRefundRequests
go

create proc uspGetToRefundRequests(
@RefundRequestNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @PendingRequestStatusID varchar(10)
declare @PendingApprovalStatusID  varchar(10)
declare @ApprovedStatusID  varchar(10)

set @PendingRequestStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @PendingApprovalStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @ApprovedStatusID= dbo.GetLookupDataID('ItemStatus', 'A')

if not @RefundRequestNo is null and not (dbo.GetOptionValue('ForceRefundsApproval') > 0)
begin

if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in pending %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundRequests')
		return 1
	end

else
begin
	select RefundRequestID, RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID
	where RefundRequestNo = @RefundRequestNo
end
end
else if  @RefundRequestNo is null and not (dbo.GetOptionValue('ForceRefundsApproval') > 0)
begin
	select RefundRequestID, RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID	

	where RefundRequests.RequestStatusID = @PendingRequestStatusID and ApprovalStatusID=@PendingApprovalStatusID
end


if (dbo.GetOptionValue('ForceRefundsApproval') > 0) and not @RefundRequestNo is null
begin

if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo = @RefundRequestNo And ApprovalStatusID = @ApprovedStatusID And RequestStatusID =@PendingApprovalStatusID)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter has not been Approved,Please Contact your Administrator to continue %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'The Refunding Process')
		return 1
	end
	
else
begin

	select RefundRequestID, RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID
	where RefundRequestNo = @RefundRequestNo
end
end

else if (dbo.GetOptionValue('ForceRefundsApproval') > 0) and @RefundRequestNo is null
begin
	select RefundRequestID, RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID	

	where RefundRequests.RequestStatusID = @PendingRequestStatusID and ApprovalStatusID=@ApprovedStatusID
end
return 0
go
--------GetNextRefundRequestID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextRefundRequestID')
	drop proc uspGetNextRefundRequestID
go

create proc uspGetNextRefundRequestID(
@RefundRequestID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @RefundRequestID = (select max(RefundRequestID) from RefundRequests where left(RefundRequestNo, 2) = @CurrentYear)
set @RefundRequestID = dbo.GetNextAutoNumber('RefundRequests', 'RefundRequestNo', @RefundRequestID)

return 0

go



------------------------------------------------------------------------------------------------------
-------------- RefundApprovals --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert RefundApprovals -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertRefundApprovals')
	drop proc uspInsertRefundApprovals
go

create proc uspInsertRefundApprovals(
@RefundRequestNo varchar(20),
@Notes varchar(800),
@AttendingPersonel varchar(41),
@ApprovalStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40),
@RecordDateTime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo  = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundRequests')
		return 1
	end

if exists(select RefundRequestNo from RefundApprovals where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo)
		return 1
	end

	if not exists(select DataID from LookupData where DataID  = @ApprovalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ApprovalStatusID', @ApprovalStatusID, 'LookupData')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
begin tran
insert into RefundApprovals
(RefundRequestNo, Notes, AttendingPersonel, ApprovalStatusID, LoginID, ClientMachine, RecordDateTime)
values
(@RefundRequestNo, @Notes, @AttendingPersonel, @ApprovalStatusID, @LoginID, @ClientMachine, @RecordDateTime)

update RefundRequests set ApprovalStatusID=@ApprovalStatusID where RefundRequestNo=@RefundRequestNo

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
end

return 0
go


/******************************************************************************************************
exec uspInsertRefundApprovals ''
******************************************************************************************************/
-- select * from RefundApprovals
-- delete from RefundApprovals


-------------- Update RefundApprovals -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateRefundApprovals')
	drop proc uspUpdateRefundApprovals
go

create proc uspUpdateRefundApprovals(
@RefundRequestNo varchar(20),
@Notes varchar(800),
@AttendingPersonel varchar(41),
@ApprovalStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40),
@RecordDateTime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundRequestNo from RefundApprovals where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundApprovals')
		return 1
	end


if not exists(select DataID from LookupData where DataID  = @ApprovalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ApprovalStatusID', @ApprovalStatusID, 'LookupData')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update RefundApprovals set
Notes = @Notes, AttendingPersonel = @AttendingPersonel, ApprovalStatusID = @ApprovalStatusID, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
where RefundRequestNo = @RefundRequestNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateRefundApprovals
******************************************************************************************************/
-- select * from RefundApprovals
-- delete from RefundApprovals


-------------- Get RefundApprovals -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRefundApprovals')
	drop proc uspGetRefundApprovals
go

create proc uspGetRefundApprovals(
@RefundRequestNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundRequestNo from RefundApprovals where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundApprovals')
		return 1
	end
else
begin
	select RefundRequestNo, Notes, AttendingPersonel, ApprovalStatusID, dbo.GetLookupDataDes(ApprovalStatusID) as ApprovalStatus,
	 RefundApprovals.LoginID, ClientMachine, RecordDateTime
	from RefundApprovals
	inner join Logins on RefundApprovals.LoginID = Logins.LoginID
	where RefundRequestNo = @RefundRequestNo
return 0
end
go


------------------------------------------------------------------------------------------------------
-------------- RefundRequests --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
-------------- RefundRequests --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert RefundRequests -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertRefundRequests')
	drop proc uspInsertRefundRequests
go

create proc uspInsertRefundRequests(
@RefundRequestNo varchar(20),
@ReceiptNo varchar(20),
@Amount money,
@RequestStatusID varchar(10),
@ApprovalStatusID varchar(10),
@VisitTypeID varchar(10),
@RequestedBy varchar(41),
@LoginID varchar(20),
@ClientMachine varchar(41)
)with encryption as

declare @ErrorMSG varchar(200)
declare @RefundRequestID int
declare @CashVisitPayTypeID varchar(10)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)
declare @IPDRoundPayTypeID varchar(10)
declare @ExtraBillPayTypeID varchar(10)
declare @PayTypeID varchar(10)
declare @AmountPaid money
declare @AmountRefunded money

declare @CurrentYear as char(2)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedRefundRequestID int
declare @PassedRefundRequestNo varchar(20)

set @CashVisitPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')
set @IPDRoundPayTypeID = dbo.GetLookupDataID('PayType', 'IPR')
set @ExtraBillPayTypeID = dbo.GetLookupDataID('PayType', 'EXT')
---------------------------------------------------------------------------------------------
set @PayTypeID = (select PayTypeID from Payments where ReceiptNo = @ReceiptNo)
set @AmountPaid =  dbo.GetAmountPaid(@PayTypeID, @VisitTypeID, @ReceiptNo)
set @AmountRefunded = dbo.GetAmountRefunded(@ReceiptNo) 

if (@Amount <= 0)
	begin
		set @ErrorMSG = 'Zero or less amount not allowed for refund!'
		raiserror(@ErrorMSG, 16, 1)
		return 1
	end

if (@AmountPaid < (@Amount + @AmountRefunded))
	begin
		set @ErrorMSG = 'Total refunded amount can''t be more than receipt amount!'
		raiserror(@ErrorMSG, 16, 1)
		return 1
	end

----------------------------------------------------------------------------------------------------------


if exists(select RefundRequestNo from RefundRequests where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo)
		return 1
	end

if not exists(select ReceiptNo from Payments where ReceiptNo  = @ReceiptNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payments')
		return 1
	end

if (dbo.GetOptionValue('AllowAccountReceiptsRefunds') =0)
begin
 
	if not exists(select ReceiptNo from Payments where ReceiptNo  = @ReceiptNo and 
			PayTypeID in (@CashVisitPayTypeID, @IPDRoundPayTypeID, @ExtraBillPayTypeID))
	begin
		set @ErrorMSG = 'You can only refund cash or bill form payment!'
		raiserror(@ErrorMSG, 16, 1)
		return 1
	end
end
if not exists(select DataID from LookupData where DataID = @RequestStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Request Status', @RequestStatusID, 'Lookup Data')
		return 1
	end

	if not exists(select DataID from LookupData where DataID = @ApprovalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Approval Status', @ApprovalStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

---------------------------------------------------------------------------------------------------------------------

select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'RefundRequests' and AutoColumnName = 'RefundRequestNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'RefundRequests' and AutoColumnName = 'RefundRequestNo'

set @CurrentYear = right(year(getdate()),2)

if (@AutoColumnLEN = len(@RefundRequestNo)) and (left(@RefundRequestNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedRefundRequestID = 1
	set @PassedRefundRequestNo = @RefundRequestNo
	set @PassedRefundRequestNo = ltrim(rtrim(substring(@PassedRefundRequestNo, len(@CurrentYear) + 1, @PaddingLEN)))

	if isnumeric(@PassedRefundRequestNo) = 1 set @PassedRefundRequestID = @PassedRefundRequestNo
	else set @PassedRefundRequestID = 1

	set @RefundRequestID = (select max(RefundRequestID) from RefundRequests where left(RefundRequestNo, len(@CurrentYear)) = @CurrentYear)
	set @RefundRequestID = dbo.GetNextAutoNumber('RefundRequests', 'RefundRequestNo', @RefundRequestID)

	if @PassedRefundRequestID < @RefundRequestID set @RefundRequestID = @PassedRefundRequestID
	if @PassedRefundRequestID > @RefundRequestID set @RefundRequestID = @PassedRefundRequestID

end else set @RefundRequestID = 1
insert into RefundRequests
(RefundRequestID, RefundRequestNo, ReceiptNo, RequestStatusID,ApprovalStatusID, RequestedBy, VisitTypeID, LoginID, ClientMachine)
values
(@RefundRequestID, @RefundRequestNo, @ReceiptNo, @RequestStatusID,@ApprovalStatusID, @RequestedBy, @VisitTypeID, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertRefundRequests
******************************************************************************************************/
-- select * from RefundRequests
-- delete from RefundRequests


-------------- Update RefundRequests -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateRefundRequests')
	drop proc uspUpdateRefundRequests
go

create proc uspUpdateRefundRequests(
@RefundRequestNo varchar(20),
@ReceiptNo varchar(20),
@RequestStatusID varchar(10),
@ApprovalStatusID varchar(10),
@RequestedBy varchar(41),
@VisitTypeID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(41)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundRequests')
		return 1
	end

if not exists(select ReceiptNo from Payments where ReceiptNo  = @ReceiptNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payments')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @RequestStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Request Status', @RequestStatusID, 'Lookup Data')
		return 1
	end

	if not exists(select DataID from LookupData where DataID = @ApprovalStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Approval Status', @ApprovalStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update RefundRequests set
 ApprovalStatusID=@ApprovalStatusID, ReceiptNo = @ReceiptNo, RequestStatusID = @RequestStatusID, RequestedBy = @RequestedBy, VisitTypeID = @VisitTypeID, LoginID = @LoginID, ClientMachine = @ClientMachine
where RefundRequestNo = @RefundRequestNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateRefundRequests
******************************************************************************************************/
-- select * from RefundRequests
-- delete from RefundRequests


-------------- Get RefundRequests -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRefundRequests')
	drop proc uspGetRefundRequests
go

create proc uspGetRefundRequests(
@RefundRequestNo varchar(20)=null,
@RequestStatusID varchar(10)=null,
@ApprovalStatusID varchar(20)=null
)with encryption as

declare @ErrorMSG varchar(200)

if not @RefundRequestNo is null
begin
if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundRequests')
		return 1
	end
else
begin
	select  RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID
	where RefundRequestNo = @RefundRequestNo
end
end
else if not @RequestStatusID is null and @ApprovalStatusID is null
begin
	select  RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, -- dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID

	where RefundRequests.RequestStatusID = @RequestStatusID
end

else if not @RequestStatusID is null and not @ApprovalStatusID is null
begin
	select  RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo,-- dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID	

	where RefundRequests.RequestStatusID = @RequestStatusID and ApprovalStatusID=@ApprovalStatusID
end
return 0
go

/******************************************************************************************************
exec uspGetRefundRequests '17000001'

exec uspGetRefundRequests null,'11p'
******************************************************************************************************/
-- select * from RefundRequests
-- delete from RefundRequests


-------------- Get  Refund Requests -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetToRefundRequests')
	drop proc uspGetToRefundRequests
go

create proc uspGetToRefundRequests(
@RefundRequestNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)
declare @PendingRequestStatusID varchar(10)
declare @PendingApprovalStatusID  varchar(10)
declare @ApprovedStatusID  varchar(10)

set @PendingRequestStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @PendingApprovalStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @ApprovedStatusID= dbo.GetLookupDataID('ItemStatus', 'A')

if not @RefundRequestNo is null and not (dbo.GetOptionValue('ForceRefundsApproval') > 0)
begin

if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in pending %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundRequests')
		return 1
	end

else
begin
	select RefundRequestID, RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID
	where RefundRequestNo = @RefundRequestNo
end
end
else if  @RefundRequestNo is null and not (dbo.GetOptionValue('ForceRefundsApproval') > 0)
begin
	select RefundRequestID, RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID	

	where RefundRequests.RequestStatusID = @PendingRequestStatusID and ApprovalStatusID=@PendingApprovalStatusID
end


if (dbo.GetOptionValue('ForceRefundsApproval') > 0) and not @RefundRequestNo is null
begin

if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo = @RefundRequestNo And ApprovalStatusID = @ApprovedStatusID And RequestStatusID =@PendingApprovalStatusID)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter has not been Approved,Please Contact your Administrator to continue %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'The Refunding Process')
		return 1
	end
	
else
begin

	select RefundRequestID, RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID
	where RefundRequestNo = @RefundRequestNo
end
end

else if (dbo.GetOptionValue('ForceRefundsApproval') > 0) and @RefundRequestNo is null
begin
	select RefundRequestID, RefundRequestNo, RefundRequests.ReceiptNo as ReceiptNo, RefundRequests.RequestStatusID as RequestStatusID, 
	dbo.GetLookupDataDes(RefundRequests.RequestStatusID) as RequestStatus,ApprovalStatusID,
	dbo.GetLookupDataDes(RefundRequests.ApprovalStatusID) as ApprovalStatus,  RequestedBy,dbo.GetLookupDataDes(PayTypeID) as PayType, 
	PayNo, dbo.GetPayeeName(PayTypeID, PayNo) as PayeeName,
	dbo.GetPayeeNo(PayTypeID, PayNo) as PayeeNo, --dbo.GetVisitBillModesID(VisitNo) as BillModesID,
	RefundRequests.VisitTypeID, dbo.GetLookupDataDes(RefundRequests.VisitTypeID) as VisitType,
	 RefundRequests.LoginID,RefundRequests.ClientMachine, RefundRequests.RecordDateTime
	from RefundRequests
	inner join Payments on RefundRequests.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRequests.LoginID = Logins.LoginID	

	where RefundRequests.RequestStatusID = @PendingRequestStatusID and ApprovalStatusID=@ApprovedStatusID
end
return 0
go

/******************************************************************************************************
exec uspGetToRefundRequests '17000001'
exec uspGetToRefundRequests
******************************************************************************************************/
-- select * from RefundRequests
-- delete from RefundRequests




--------GetNextRefundRequestID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextRefundRequestID')
	drop proc uspGetNextRefundRequestID
go

create proc uspGetNextRefundRequestID(
@RefundRequestID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @RefundRequestID = (select max(RefundRequestID) from RefundRequests where left(RefundRequestNo, 2) = @CurrentYear)
set @RefundRequestID = dbo.GetNextAutoNumber('RefundRequests', 'RefundRequestNo', @RefundRequestID)

return 0

go




/******************************************************************************************************
exec uspGetNextRefundRequestID
******************************************************************************************************/


------------------------------------------------------------------------------------------------------
-------------- RefundRequestDetails --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert RefundRequestDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertRefundRequestDetails')
	drop proc uspInsertRefundRequestDetails
go

create proc uspInsertRefundRequestDetails(
@RefundRequestNo varchar(20),
@VisitNo varchar(20),
@ReceiptNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReturnReasonID varchar(10),
@Quantity int,
@Amount money,
@NewPrice money,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo  = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundRequests')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if exists(select RefundRequestNo from RefundRequestDetails where RefundRequestNo = @RefundRequestNo and VisitNo = @VisitNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'Visit No', @VisitNo, 'Receipt No', @ReceiptNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into RefundRequestDetails
(RefundRequestNo, VisitNo, ReceiptNo, ItemCode, ItemCategoryID, ReturnReasonID, Quantity, Amount, NewPrice, LoginID, ClientMachine)
values
(@RefundRequestNo, @VisitNo, @ReceiptNo, @ItemCode, @ItemCategoryID, @ReturnReasonID, @Quantity, @Amount, @NewPrice, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertRefundRequestDetails
******************************************************************************************************/
-- select * from RefundRequestDetails
-- delete from RefundRequestDetails


-------------- Update RefundRequestDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateRefundRequestDetails')
	drop proc uspUpdateRefundRequestDetails
go

create proc uspUpdateRefundRequestDetails(
@RefundRequestNo varchar(20),
@VisitNo varchar(20),
@ReceiptNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReturnReasonID varchar(10),
@Quantity int,
@Amount money,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundRequestNo from RefundRequestDetails where RefundRequestNo = @RefundRequestNo and VisitNo = @VisitNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'Visit No', @VisitNo, 'Receipt No', @ReceiptNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'RefundRequestDetails')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update RefundRequestDetails set
ReturnReasonID = @ReturnReasonID, Quantity = @Quantity, Amount = @Amount, LoginID = @LoginID, ClientMachine = @ClientMachine
where RefundRequestNo = @RefundRequestNo and VisitNo = @VisitNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspUpdateRefundRequestDetails
******************************************************************************************************/
-- select * from RefundRequestDetails
-- delete from RefundRequestDetails


-------------- Get RefundRequestDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRefundRequestDetails')
	drop proc uspGetRefundRequestDetails
go

create proc uspGetRefundRequestDetails(
@RefundRequestNo varchar(20),
@VisitNo varchar(20),
@ReceiptNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundRequestNo from RefundRequestDetails where RefundRequestNo = @RefundRequestNo and VisitNo = @VisitNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'Visit No', @VisitNo, 'Receipt No', @ReceiptNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'RefundRequestDetails')
		return 1
	end
else
begin
	select RefundRequestNo, VisitNo, ReceiptNo, ItemCode, ItemCategoryID,
	dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ReturnReasonID, 
	dbo.GetLookupDataDes(ReturnReasonID) as ReturnReason, Quantity, Amount, RefundRequestDetails.LoginID, ClientMachine, RecordDateTime
	from RefundRequestDetails
	where RefundRequestNo = @RefundRequestNo and VisitNo = @VisitNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetRefundRequestDetails
******************************************************************************************************/
-- select * from RefundRequestDetails
-- delete from RefundRequestDetails


-------------- Get RefundRequestDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRefundRequestDetailsByRequestNo')
	drop proc uspGetRefundRequestDetailsByRequestNo
go

create proc uspGetRefundRequestDetailsByRequestNo(
@RefundRequestNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select RefundRequestNo, RefundRequestDetails.VisitNo, RefundRequestDetails.ReceiptNo, 
	RefundRequestDetails.ItemCode,RefundRequestDetails.ItemCategoryID, 
	dbo.GetLookupDataDes(RefundRequestDetails.ItemCategoryID) as ItemCategory, ReturnReasonID, 
	dbo.GetLookupDataDes(ReturnReasonID) as ReturnReason,
	RefundRequestDetails.Quantity, RefundRequestDetails.Amount, 
	Items.ItemName, Items.InvoiceNo, ItemStatusID, dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,
	
	dbo.FormatMoney(dbo.GetRefundItemAmount(RefundRequestDetails.ReceiptNo, RefundRequestDetails.VisitNo,
	RefundRequestDetails.ItemCode, RefundRequestDetails.ItemCategoryID)) as RefundedAmount,
	dbo.GetRefundItemQuantity(RefundRequestDetails.ReceiptNo, RefundRequestDetails.VisitNo, 
	RefundRequestDetails.ItemCode, RefundRequestDetails.ItemCategoryID) as RefundedQuantity,
	PaymentDetails.Quantity as SoldQuantity, PaymentDetails.UnitPrice, dbo.FormatMoney(NewPrice) as NewPrice, Discount, 
	PaymentDetails.Amount as AmountPaid, RefundRequestDetails.LoginID, 
	RefundRequestDetails.ClientMachine, RefundRequestDetails.RecordDateTime
	
	from RefundRequestDetails
	inner join PaymentDetails on PaymentDetails.ReceiptNo = RefundRequestDetails.ReceiptNo
	and  PaymentDetails.VisitNo = RefundRequestDetails.VisitNo
	and PaymentDetails.ItemCode = RefundRequestDetails.ItemCode
	and PaymentDetails.ItemCategoryID = RefundRequestDetails.ItemCategoryID
	inner join Items on Items.VisitNo = RefundRequestDetails.VisitNo
	and Items.ItemCode = RefundRequestDetails.ItemCode
	and Items.ItemCategoryID = RefundRequestDetails.ItemCategoryID
	where RefundRequestNo = @RefundRequestNo
return 0
end
go

/******************************************************************************************************
exec uspGetRefundRequestDetailsByRequestNo '18000076'
select * from Payments where ReceiptNo = '170058151'
select * from PaymentDetails where ReceiptNo = '170058151'
select * from Items where VisitNo = 'SR1709724001'

******************************************************************************************************/
-- select * from RefundRequestDetails
-- delete from RefundRequestDetails



------------------------------------------------------------------------------------------------------
-------------- RefundRequestExtraBillItems --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert RefundRequestExtraBillItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertRefundRequestExtraBillItems')
	drop proc uspInsertRefundRequestExtraBillItems
go

create proc uspInsertRefundRequestExtraBillItems(
@RefundRequestNo varchar(20),
@ExtraBillNo varchar(20),
@ReceiptNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReturnReasonID varchar(10),
@Quantity int,
@Amount money,
@NewPrice money,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo  = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundRequests')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if exists(select RefundRequestNo from RefundRequestExtraBillItems where RefundRequestNo = @RefundRequestNo and ExtraBillNo = @ExtraBillNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'Extra Bill No', @ExtraBillNo, 'Receipt No', @ReceiptNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into RefundRequestExtraBillItems
(RefundRequestNo, ExtraBillNo, ReceiptNo, ItemCode, ItemCategoryID, ReturnReasonID, Quantity, Amount, NewPrice, LoginID, ClientMachine)
values
(@RefundRequestNo, @ExtraBillNo, @ReceiptNo, @ItemCode, @ItemCategoryID, @ReturnReasonID, @Quantity, @Amount, @NewPrice, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertRefundRequestExtraBillItems
******************************************************************************************************/
-- select * from RefundRequestExtraBillItems
-- delete from RefundRequestExtraBillItems


-------------- Update RefundRequestExtraBillItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateRefundRequestExtraBillItems')
	drop proc uspUpdateRefundRequestExtraBillItems
go

create proc uspUpdateRefundRequestExtraBillItems(
@RefundRequestNo varchar(20),
@ExtraBillNo varchar(20),
@ReceiptNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReturnReasonID varchar(10),
@Quantity int,
@Amount money,
@NewPrice money,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundRequestNo from RefundRequestExtraBillItems where RefundRequestNo = @RefundRequestNo and ExtraBillNo = @ExtraBillNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'Extra Bill No', @ExtraBillNo, 'Receipt No', @ReceiptNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'RefundRequestExtraBillItems')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update RefundRequestExtraBillItems set
ReturnReasonID = @ReturnReasonID, Quantity = @Quantity, Amount = @Amount, NewPrice = @NewPrice, LoginID = @LoginID, ClientMachine = @ClientMachine
where RefundRequestNo = @RefundRequestNo and ExtraBillNo = @ExtraBillNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspUpdateRefundRequestExtraBillItems
******************************************************************************************************/
-- select * from RefundRequestExtraBillItems
-- delete from RefundRequestExtraBillItems


-------------- Get RefundRequestExtraBillItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRefundRequestExtraBillItems')
	drop proc uspGetRefundRequestExtraBillItems
go

create proc uspGetRefundRequestExtraBillItems(
@RefundRequestNo varchar(20),
@ExtraBillNo varchar(20),
@ReceiptNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundRequestNo from RefundRequestExtraBillItems where RefundRequestNo = @RefundRequestNo and ExtraBillNo = @ExtraBillNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'Extra Bill No', @ExtraBillNo, 'Receipt No', @ReceiptNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'RefundRequestExtraBillItems')
		return 1
	end
else
begin
	select RefundRequestNo, ExtraBillNo, ReceiptNo, ItemCode, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	ReturnReasonID, dbo.GetLookupDataDes(ReturnReasonID) as ReturnReason, Quantity, dbo.FormatMoney(Amount), dbo.FormatMoney(NewPrice) as NewPrice, RefundRequestExtraBillItems.LoginID,
	 ClientMachine, RecordDateTime
	from RefundRequestExtraBillItems
	inner join Logins on RefundRequestExtraBillItems.LoginID = Logins.LoginID
	where RefundRequestNo = @RefundRequestNo and ExtraBillNo = @ExtraBillNo and ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetRefundRequestExtraBillItems
******************************************************************************************************/
-- select * from RefundRequestExtraBillItems
-- delete from RefundRequestExtraBillItems



if exists (select * from sysobjects where name = 'uspGetRefundRequestExtraBillItemsByRequestNo')
	drop proc uspGetRefundRequestExtraBillItemsByRequestNo
go

create proc uspGetRefundRequestExtraBillItemsByRequestNo(
@RefundRequestNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select RefundRequestNo, RefundRequestExtraBillItems.ExtraBillNo, RefundRequestExtraBillItems.ReceiptNo, RefundRequestExtraBillItems.ItemCode, 
	RefundRequestExtraBillItems.ItemCategoryID, EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,
	isnull(ExtraBillItems.InvoiceNo, '') as InvoiceNo,	ExtraBillItems.ItemName,
	dbo.GetLookupDataDes(RefundRequestExtraBillItems.ItemCategoryID) as ItemCategory, ReturnReasonID, 
	dbo.GetLookupDataDes(ReturnReasonID) as ReturnReason, RefundRequestExtraBillItems.Quantity, RefundRequestExtraBillItems.Amount, 
	PaymentExtraBillItems.Quantity as SoldQuantity, PaymentExtraBillItems.UnitPrice, dbo.FormatMoney(NewPrice) as NewPrice, Discount, 
	PaymentExtraBillItems.Amount AmountPaid,
	dbo.FormatMoney(dbo.GetIPDRefundItemAmount(RefundRequestExtraBillItems.ReceiptNo,RefundRequestExtraBillItems.ExtraBillNo,RefundRequestExtraBillItems.ItemCode,RefundRequestExtraBillItems.ItemCategoryID)) as RefundedAmount,
	dbo.GetIPDRefundItemQuantity(PaymentExtraBillItems.ReceiptNo,RefundRequestExtraBillItems.ExtraBillNo,RefundRequestExtraBillItems.ItemCode,RefundRequestExtraBillItems.ItemCategoryID) as RefundedQuantity,
	RefundRequestExtraBillItems.LoginID, RefundRequestExtraBillItems.ClientMachine, RefundRequestExtraBillItems.RecordDateTime
	
	from RefundRequestExtraBillItems
	inner join PaymentExtraBillItems on 
	 PaymentExtraBillItems.ReceiptNo = RefundRequestExtraBillItems.ReceiptNo
	and PaymentExtraBillItems.ExtraBillNo = RefundRequestExtraBillItems.ExtraBillNo
	and PaymentExtraBillItems.ItemCode = RefundRequestExtraBillItems.ItemCode
	and PaymentExtraBillItems.ItemCategoryID = RefundRequestExtraBillItems.ItemCategoryID
	inner join ExtraBillItems on  ExtraBillItems.ExtraBillNo = RefundRequestExtraBillItems.ExtraBillNo
	and ExtraBillItems.ItemCode = RefundRequestExtraBillItems.ItemCode
	and ExtraBillItems.ItemCategoryID = RefundRequestExtraBillItems.ItemCategoryID
	where RefundRequestNo = @RefundRequestNo 
return 0
end
go

/******************************************************************************************************
exec uspGetRefundRequestExtraBillItemsByRequestNo '18000070'
******************************************************************************************************/
-- select * from RefundRequestExtraBillItems
-- delete from RefundRequestExtraBillItems


------------------------------------------------------------------------------------------------------
-------------- RefundRejects --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert RefundRejects -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertRefundRejects')
	drop proc uspInsertRefundRejects
go

create proc uspInsertRefundRejects(
@RefundRequestNo varchar(20),
@ReceiptNo varchar(20),
@RejectedAt varchar(10),
@RejectionDate smallDateTime,
@Notes varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(41),
@RecordDateTime smallDateTime
)with encryption as

declare @ErrorMSG varchar(200)
declare @RequestStatusID varchar(10)
declare @ApprovalStatusID varchar(10)

set @RequestStatusID= dbo.GetLookupDataID('ItemStatus', 'C')
set @ApprovalStatusID= dbo.GetLookupDataID('ItemStatus', 'D')

if not exists(select RefundRequestNo from RefundRequests where RefundRequestNo  = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundRequests')
		return 1
	end

if exists(select RefundRequestNo from RefundRejects where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo)
		return 1
	end

if not exists(select ReceiptNo from Payments where ReceiptNo  = @ReceiptNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payments')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @RejectedAt)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Rejected At', @RejectedAt, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
begin tran
insert into RefundRejects
(RefundRequestNo, ReceiptNo, RejectedAt, RejectionDate, Notes, LoginID, ClientMachine, RecordDateTime)
values
(@RefundRequestNo, @ReceiptNo, @RejectedAt, @RejectionDate, @Notes, @LoginID, @ClientMachine, @RecordDateTime)

update RefundRequests set RequestStatusID=@RequestStatusID, ApprovalStatusID=@ApprovalStatusID where RefundRequestNo=@RefundRequestNo

if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran
end

return 0
go

/******************************************************************************************************
exec uspInsertRefundRejects
******************************************************************************************************/
-- select * from RefundRejects
-- delete from RefundRejects


-------------- Update RefundRejects -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateRefundRejects')
	drop proc uspUpdateRefundRejects
go

create proc uspUpdateRefundRejects(
@RefundRequestNo varchar(20),
@ReceiptNo varchar(20),
@RejectedAt varchar(10),
@RejectionDate smallDateTime,
@Notes varchar(200),
@LoginID varchar(20),
@ClientMachine varchar(41),
@RecordDateTime smallDateTime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundRequestNo from RefundRejects where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundRejects')
		return 1
	end

if not exists(select ReceiptNo from Payments where ReceiptNo  = @ReceiptNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Receipt No', @ReceiptNo, 'Payments')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @RejectedAt)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Rejected At', @RejectedAt, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update RefundRejects set
ReceiptNo = @ReceiptNo, RejectedAt = @RejectedAt, RejectionDate = @RejectionDate, Notes = @Notes, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
where RefundRequestNo = @RefundRequestNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateRefundRejects
******************************************************************************************************/
-- select * from RefundRejects

-- delete from RefundRejects


-------------- Get RefundRejects -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRefundRejects')
	drop proc uspGetRefundRejects
go

create proc uspGetRefundRejects(
@RefundRequestNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundRequestNo from RefundRejects where RefundRequestNo = @RefundRequestNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Refund Request No', @RefundRequestNo, 'RefundRejects')
		return 1
	end
else
begin
	select RefundRequestNo, RefundRejects.ReceiptNo, RejectedAt, dbo.GetLookupDataDes(RejectedAt) as RejectedAt, 
	RejectionDate, RefundRejects.Notes as Notes, RefundRejects.LoginID, RefundRejects.ClientMachine, RefundRejects.RecordDateTime
	from RefundRejects
	inner join Payments on RefundRejects.ReceiptNo = Payments.ReceiptNo	
	inner join Logins on RefundRejects.LoginID = Logins.LoginID	

	where RefundRequestNo = @RefundRequestNo
return 0
end
go


------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
-------------- InvoiceAdjustments --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert InvoiceAdjustments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertInvoiceAdjustments')
	drop proc uspInsertInvoiceAdjustments
go

create proc uspInsertInvoiceAdjustments(
@AdjustmentNo varchar(20),
@InvoiceNo varchar(20),
@VisitTypeID varchar(10),
@AdjustmentTypeID varchar(10),
@ReversalActionID varchar(10),
@EntryLevelID varchar(10),
@Amount money,
@AdjustmentDate smalldatetime,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @AdjustmentID int
declare @CancelledReversalActionID varchar(10)
declare @OPDVisitTypeID varchar(10)
declare @IPDVisitTypeID varchar(10)

set @OPDVisitTypeID =  dbo.GetLookupDataID('VisitType', 'OPD')
set @IPDVisitTypeID =  dbo.GetLookupDataID('VisitType', 'IPD')

set @CancelledReversalActionID = dbo.GetLookupDataID('ReversalAction', 'C')

if exists(select AdjustmentNo from InvoiceAdjustments where AdjustmentNo = @AdjustmentNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Adjustment No', @AdjustmentNo)
		return 1
	end

if not exists(select InvoiceNo from Invoices where InvoiceNo  = @InvoiceNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo, 'Invoices')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisitTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit Type ID', @VisitTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EntryLevelID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Entry Level ID', @EntryLevelID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AdjustmentTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Adjustment Type ID', @AdjustmentTypeID, 'Lookup Data')
		return 1
	end

	if not exists(select DataID from LookupData where DataID = @ReversalActionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Reversal Action ID', @ReversalActionID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

	if  exists(select InvoiceNo from Invoices where InvoiceNo  = @InvoiceNo and Cancelled = 1)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does is cancelled and cannot be adjusted'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo, 'Invoices')
		return 1
	end

begin
 begin tran
set @AdjustmentID = (select max(AdjustmentID) from InvoiceAdjustments where InvoiceNo = @InvoiceNo)
set @AdjustmentID = dbo.GetNextAutoNumber('InvoiceAdjustments', 'AdjustmentNo', @AdjustmentID)

insert into InvoiceAdjustments
(AdjustmentID, AdjustmentNo, InvoiceNo, VisitTypeID, AdjustmentTypeID, ReversalActionID, EntryLevelID, Amount, AdjustmentDate, LoginID, ClientMachine)
values
(@AdjustmentID, @AdjustmentNo, @InvoiceNo, @VisitTypeID, @AdjustmentTypeID, @ReversalActionID, @EntryLevelID, @Amount, @AdjustmentDate, @LoginID, @ClientMachine)

if @ReversalActionID = @CancelledReversalActionID
 begin
  update Invoices set Cancelled = 1 where InvoiceNo = @InvoiceNo
  if @VisitTypeID = @OPDVisitTypeID begin update Items set InvoiceNo = '' where InvoiceNo = @InvoiceNo end
  else if @VisitTypeID = @IPDVisitTypeID begin update ExtraBillItems set InvoiceNo = '' where InvoiceNo = @InvoiceNo end
 end


if @@error > 0
	begin
		rollback tran
		return 1		
	end
commit tran

return 0
end
go

/******************************************************************************************************
exec uspInsertInvoiceAdjustments '1200000101', '12000001', '110OPD', '264D','266A', '201CRDNT', 35000, 'Jul 19 2018', 'jamescil', 'CLINICMASTER13'
******************************************************************************************************/
-- select * from InvoiceAdjustments
-- delete from InvoiceAdjustments


-------------- Get InvoiceAdjustments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInvoiceAdjustments')
	drop proc uspGetInvoiceAdjustments
go

create proc uspGetInvoiceAdjustments(
@AdjustmentNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AdjustmentNo from InvoiceAdjustments where AdjustmentNo = @AdjustmentNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Adjustment No', @AdjustmentNo, 'InvoiceAdjustments')
		return 1
	end
else
begin
	select AdjustmentNo, InvoiceAdjustments.InvoiceNo, InvoiceAdjustments.VisitTypeID, dbo.GetLookupDataDes(InvoiceAdjustments.VisitTypeID) as VisitType, 
	EntryLevelID,  dbo.GetLookupDataDes(EntryLevelID) as EntryLevel, Amount, AdjustmentDate, InvoiceAdjustments.LoginID, 
	ClientMachine, InvoiceAdjustments.RecordDateTime
	from InvoiceAdjustments
	inner join Invoices on InvoiceAdjustments.InvoiceNo = Invoices.InvoiceNo	
	where AdjustmentNo = @AdjustmentNo
return 0
end
go

/******************************************************************************************************
exec uspGetInvoiceAdjustments '1200000101'
******************************************************************************************************/
-- select * from InvoiceAdjustments
-- delete from InvoiceAdjustments




--------GetNextAdjustmentID --------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextAdjustmentID')
	drop proc uspGetNextAdjustmentID
go

create proc uspGetNextAdjustmentID(
@InvoiceNo varchar(20),
@AdjustmentID int = null output
)with encryption as

set @AdjustmentID = (select max(AdjustmentID) from InvoiceAdjustments where InvoiceNo = @InvoiceNo)
set @AdjustmentID = dbo.GetNextAutoNumber('InvoiceAdjustments', 'AdjustmentNo', @AdjustmentID)

return 0

go


------------------------------------------------------------------------------------------------------
-------------- InvoiceDetailAdjustments --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert InvoiceDetailAdjustments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertInvoiceDetailAdjustments')
	drop proc uspInsertInvoiceDetailAdjustments
go

create proc uspInsertInvoiceDetailAdjustments(
@AdjustmentNo varchar(20),
@VisitNo varchar(20),
@InvoiceNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReturnReasonID varchar(10),
@Quantity int,
@Amount money,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @EntryLevelID varchar(10)
declare @InvoiceAdjustmentsEntryLevelID varchar(10)

declare @DownAdjustmentTypeID varchar(10)
declare @UPAdjustmentTypeID varchar(10)
declare @AdjustmentTypeID varchar(10)
declare @ItemCategory varchar(100)
declare @ReversalActionID varchar(10)
declare @CancelledReversalActionID varchar(10)

declare @BillQuantity int
declare @BillPrice money
declare @BillAmount money

declare @VisitBillID varchar(10)
declare @PayTpeID varchar(10)

set @VisitBillID = dbo.GetLookupDataID('PayType', 'CAS')
set @PayTpeID = (select PayTypeID from Invoices where InvoiceNo = @InvoiceNo)

set @EntryLevelID = (select EntryLevelID from InvoiceAdjustments where AdjustmentNo = @AdjustmentNo)
set @InvoiceAdjustmentsEntryLevelID = dbo.GetLookupDataID('DocumentType', 'CRDNT')
set @CancelledReversalActionID = dbo.GetLookupDataID('ReversalAction', 'C')

set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'D')
set @UPAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'U')
set @ItemCategory = dbo.GetLookupDataDes(@ItemCategoryID)

set @AdjustmentTypeID = (select AdjustmentTypeID from InvoiceAdjustments where AdjustmentNo = @AdjustmentNo)
set @ReversalActionID = (select ReversalActionID from InvoiceAdjustments where AdjustmentNo = @AdjustmentNo)


set @BillQuantity = (select Quantity from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID) 
set @BillPrice = (select UnitPrice from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID) 

if not exists(select AdjustmentNo from InvoiceAdjustments where AdjustmentNo  = @AdjustmentNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Adjustment No', @AdjustmentNo, 'InvoiceAdjustments')
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select InvoiceNo from InvoiceDetails where InvoiceNo  = @InvoiceNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Invoice No', @InvoiceNo, 'InvoiceDetails')
		return 1
	end

if not exists(select ItemCode from InvoiceDetails where ItemCode  = @ItemCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'InvoiceDetails')
		return 1
	end

if not exists(select ItemCategoryID from InvoiceDetails where ItemCategoryID  = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'InvoiceDetails')
		return 1
	end

if exists(select AdjustmentNo from InvoiceDetailAdjustments where AdjustmentNo = @AdjustmentNo and VisitNo = @VisitNo and InvoiceNo = @InvoiceNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Adjustment No', @AdjustmentNo, 'Visit No', @VisitNo, 'Invoice No', @InvoiceNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID)
		return 1
	end

if not exists(select InvoiceNo from InvoiceDetails where VisitNo = @VisitNo and InvoiceNo = @InvoiceNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exists %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Invoice No', @InvoiceNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Invoice Details')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ReturnReasonID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Return Reason ID', @ReturnReasonID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

if exists(select top 1 ReceiptNo from PaymentDetails where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID) and @EntryLevelID = @InvoiceAdjustmentsEntryLevelID
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter is already paid and can''t be saved. An Invoice Adjustment will be made when a refund is made'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID)
		return 1
	end

	if @Quantity > @BillQuantity
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', has more returned items than consumed item.'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Item Code', @ItemCode, 'Item Category')
		return 1
	end	

	if (@Amount > @BillAmount) and (@AdjustmentTypeID = @DownAdjustmentTypeID)
	begin
		set @ErrorMSG = 'The adjusted amount cannot be greater than the bill amount for %s: %s and %s: %s and %s :%s for '+dbo.GetLookupDataDes(@DownAdjustmentTypeID)+' Adjustment'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategory)
		return 1
	end	
	
	if (@Quantity > 0) and (@AdjustmentTypeID = @UpAdjustmentTypeID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s cannot be adjusted upwards'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Item Code', @ItemCode, 'Item Category')
		return 1
	end		


begin
	insert into InvoiceDetailAdjustments
	(AdjustmentNo, VisitNo, InvoiceNo, ItemCode, ItemCategoryID, ReturnReasonID, Quantity, Amount, LoginID, ClientMachine)
	values
	(@AdjustmentNo, @VisitNo, @InvoiceNo, @ItemCode, @ItemCategoryID, @ReturnReasonID, @Quantity, @Amount, @LoginID, @ClientMachine)

return 0
end
go

/******************************************************************************************************
exec uspInsertInvoiceDetailAdjustments '1817236002', 'P160001810002', '18172360', 'M488','7D', '19601', 1, 2000, 'jamescil', 'CLINICMASTER13'

******************************************************************************************************/
-- select * from InvoiceDetailAdjustments
-- delete from InvoiceDetailAdjustments


-------------- Get InvoiceDetailAdjustments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInvoiceDetailAdjustments')
	drop proc uspGetInvoiceDetailAdjustments
go

create proc uspGetInvoiceDetailAdjustments(
@AdjustmentNo varchar(20),
@VisitNo varchar(20),
@InvoiceNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AdjustmentNo from InvoiceDetailAdjustments where AdjustmentNo = @AdjustmentNo and VisitNo = @VisitNo and InvoiceNo = @InvoiceNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Adjustment No', @AdjustmentNo, 'Visit No', @VisitNo, 'Invoice No', @InvoiceNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'InvoiceDetailAdjustments')
		return 1
	end
else
begin
	select AdjustmentNo, VisitNo, InvoiceNo, ItemCode, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, ReturnReasonID, dbo.GetLookupDataDes(ReturnReasonID) as ReturnReason, Quantity, Amount, InvoiceDetailAdjustments.LoginID, ClientMachine, RecordDateTime
	from InvoiceDetailAdjustments
	where AdjustmentNo = @AdjustmentNo and VisitNo = @VisitNo and InvoiceNo = @InvoiceNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetInvoiceDetailAdjustments
******************************************************************************************************/
-- select * from InvoiceDetailAdjustments
-- delete from InvoiceDetailAdjustments


-------------- Get InvoiceDetailAdjustmentsByInvoiceNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInvoiceDetailAdjustmentsByInvoiceNo')
	drop proc uspGetInvoiceDetailAdjustmentsByInvoiceNo
go

create proc uspGetInvoiceDetailAdjustmentsByInvoiceNo(
@InvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select InvoiceDetailAdjustments.VisitNo, InvoiceDetailAdjustments.InvoiceNo, ItemCode, 
	ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, sum(Quantity) as TotalQuantity, 
	dbo.GetMappedCustomCodeByVisitNo(VisitNo,InvoiceDetailAdjustments.ItemCode,InvoiceDetailAdjustments.ItemCategoryID) as MappedCustomCode,
    dbo.GetItemName(InvoiceDetailAdjustments.ItemCategoryID, InvoiceDetailAdjustments.ItemCode) as ItemName, 
    AdjustmentTypeID, dbo.GetLookupDataDes(AdjustmentTypeID) as AdjustmentType, sum(InvoiceDetailAdjustments.Amount) as TotalAmount
	from InvoiceDetailAdjustments
	inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceDetailAdjustments.AdjustmentNo
	where InvoiceDetailAdjustments.InvoiceNo = @InvoiceNo
	group by InvoiceDetailAdjustments.VisitNo, InvoiceDetailAdjustments.InvoiceNo, ItemCode, ItemCategoryID, AdjustmentTypeID
return 0
end
go

/******************************************************************************************************
exec uspGetInvoiceDetailAdjustmentsByInvoiceNo '17000388'
******************************************************************************************************/
-- select * from InvoiceDetailAdjustments
-- delete from InvoiceDetailAdjustments



------------------------------------------------------------------------------------------------------
-------------- InvoiceExtraBillItemAdjustments --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
-------------- Insert  -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertInvoiceExtraBillItemAdjustments')
	drop proc uspInsertInvoiceExtraBillItemAdjustments
go

create proc uspInsertInvoiceExtraBillItemAdjustments(
@AdjustmentNo varchar(20),
@ExtraBillNo varchar(20),
@InvoiceNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ReturnReasonID varchar(10),
@Quantity int,
@Amount money,
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @InvoiceAdjustmentsEntryLevelID varchar(10)
declare @EntryLevelID varchar(10)
declare @ItemCategory varchar(100)

declare @DownAdjustmentTypeID varchar(10)
declare @UPAdjustmentTypeID varchar(10)
declare @AdjustmentTypeID varchar(10)
declare @BillQuantity int
declare @BillPrice money
declare @BillAmount money
declare @VisitBillID varchar(10)
declare @PayTpeID varchar(10)

set @EntryLevelID = (select EntryLevelID from InvoiceAdjustments where AdjustmentNo = @AdjustmentNo)
set @InvoiceAdjustmentsEntryLevelID = dbo.GetLookupDataID('DocumentType', 'CRDNT')
set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'D')
set @UPAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'U')
set @ItemCategory = dbo.GetLookupDataDes(@ItemCategoryID)

set @AdjustmentTypeID = (select AdjustmentTypeID from InvoiceAdjustments where AdjustmentNo = @AdjustmentNo)

set @BillQuantity = (select Quantity from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID) 
set @BillPrice = (select UnitPrice from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID) 
set @BillAmount = (@BillQuantity * @BillPrice)
if not exists(select AdjustmentNo from InvoiceAdjustments where AdjustmentNo  = @AdjustmentNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Adjustment No', @AdjustmentNo, 'InvoiceAdjustments')
		return 1
	end

if exists(select AdjustmentNo from InvoiceExtraBillItemAdjustments where AdjustmentNo = @AdjustmentNo and ExtraBillNo = @ExtraBillNo and InvoiceNo = @InvoiceNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Adjustment No', @AdjustmentNo, 'Extra Bill No', @ExtraBillNo, 'Invoice No', @InvoiceNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID)
		return 1
	end

if not exists(select InvoiceNo from InvoiceExtraBillItems where  ExtraBillNo = @ExtraBillNo and InvoiceNo = @InvoiceNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exists in registered %s'
		raiserror(@ErrorMSG, 16, 1,  'Extra Bill No', @ExtraBillNo, 'Invoice No', @InvoiceNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Invoice Bill Form')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @ReturnReasonID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Return Reason ID', @ReturnReasonID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

	if exists(select top 1 ReceiptNo from PaymentExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID) and @EntryLevelID = @InvoiceAdjustmentsEntryLevelID
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter is already paid and can''t be saved. An Invoice Adjustment will be made when a refund is made'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID)
		return 1
	end

	
if @Quantity > @BillQuantity
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: ' + dbo.GetLookupDataDes(@ItemCategoryID) + ', has more returned items than consumed item.'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category')
		return 1
	end	

	if (@Amount > @BillAmount) and (@AdjustmentTypeID = @DownAdjustmentTypeID)
	begin
		set @ErrorMSG = 'The adjusted amount cannot be greater than the bill amount for %s: %s and %s: %s and %s :%s for '+dbo.GetLookupDataDes(@DownAdjustmentTypeID)+' Adjustment'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategory)
		return 1
	end	
	
	if (@Quantity > 0) and (@AdjustmentTypeID = @UpAdjustmentTypeID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s cannot be adjusted upwards'
		raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category')
		return 1
	end		

	--if (@NewPrice < @BillPrice) and (@AdjustmentTypeID = @UpAdjustmentTypeID)
	--begin
	--	set @ErrorMSG = 'The adjusted price cannot be less than the unit price for %s: %s and %s: %s and %s :%s for '+dbo.GetLookupDataDes(@UpAdjustmentTypeID) +' Adjustment'
	--	raiserror(@ErrorMSG, 16, 1, 'Extra Bill No', @ExtraBillNo, 'Item Code', @ItemCode, 'Item Category', @ItemCategory)
	--	return 1
	--end		


begin
	insert into InvoiceExtraBillItemAdjustments
	(AdjustmentNo, ExtraBillNo, InvoiceNo, ItemCode, ItemCategoryID, ReturnReasonID, Quantity, Amount, LoginID, ClientMachine)
	values
	(@AdjustmentNo, @ExtraBillNo, @InvoiceNo, @ItemCode, @ItemCategoryID, @ReturnReasonID, @Quantity, @Amount, @LoginID, @ClientMachine)
	
	
return 0
end
go

/******************************************************************************************************
exec uspInsertInvoiceExtraBillItemAdjustments '1503976301', '1206726003', '15039763', 'M488','7D', '19601', 1, 2000, 'jamescil', 'CLINICMASTER13'
******************************************************************************************************/
-- select * from InvoiceExtraBillItemAdjustments
-- delete from InvoiceExtraBillItemAdjustments



-------------- Get InvoiceExtraBillItemAdjustments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInvoiceExtraBillItemAdjustments')
	drop proc uspGetInvoiceExtraBillItemAdjustments
go

create proc uspGetInvoiceExtraBillItemAdjustments(
@AdjustmentNo varchar(20),
@ExtraBillNo varchar(20),
@InvoiceNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AdjustmentNo from InvoiceExtraBillItemAdjustments where AdjustmentNo = @AdjustmentNo and ExtraBillNo = @ExtraBillNo and InvoiceNo = @InvoiceNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Adjustment No', @AdjustmentNo, 'Extra Bill No', @ExtraBillNo, 'Invoice No', @InvoiceNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'InvoiceExtraBillItemAdjustments')
		return 1
	end
else
begin
	select AdjustmentNo, ExtraBillNo, InvoiceNo, ItemCode, ItemCategoryID, ReturnReasonID, dbo.GetLookupDataDes(ReturnReasonID) as [Return Reason ID], Quantity, Amount, InvoiceExtraBillItemAdjustments.LoginID, ClientMachine, RecordDateTime
	from InvoiceExtraBillItemAdjustments
	inner join Logins on InvoiceExtraBillItemAdjustments.LoginID = Logins.LoginID	

	where AdjustmentNo = @AdjustmentNo and ExtraBillNo = @ExtraBillNo and InvoiceNo = @InvoiceNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetInvoiceExtraBillItemAdjustments '1503976301', '1206726003', '15039763', 'M488', '7D'
******************************************************************************************************/
-- select * from InvoiceExtraBillItemAdjustments
-- delete from InvoiceExtraBillItemAdjustments


-------------- Get InvoiceExtraBillItemAdjustmentsByInvoiceNo -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInvoiceExtraBillItemAdjustmentsByInvoiceNo')
	drop proc uspGetInvoiceExtraBillItemAdjustmentsByInvoiceNo
go

create proc uspGetInvoiceExtraBillItemAdjustmentsByInvoiceNo(
@InvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select  InvoiceExtraBillItemAdjustments.ExtraBillNo, InvoiceExtraBillItemAdjustments.InvoiceNo, ItemCode, 
	ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	sum(Quantity) as TotalQuantity, dbo.GetMappedCustomCode(BillNo,InvoiceExtraBillItemAdjustments.ItemCode,InvoiceExtraBillItemAdjustments.ItemCategoryID) as MappedCustomCode,
    dbo.GetItemName(InvoiceExtraBillItemAdjustments.ItemCategoryID, InvoiceExtraBillItemAdjustments.ItemCode) as ItemName,  

	AdjustmentTypeID, dbo.GetLookupDataDes(AdjustmentTypeID) as AdjustmentType, sum(InvoiceExtraBillItemAdjustments.Amount) as TotalAmount
	from InvoiceExtraBillItemAdjustments
	inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo
	inner join ExtraBills on InvoiceExtraBillItemAdjustments.ExtraBillNo = ExtraBills.ExtraBillNo
	inner join Admissions on Admissions.VisitNo = ExtraBills.VisitNo
	where InvoiceExtraBillItemAdjustments.InvoiceNo = @InvoiceNo
	group by  BillNo, InvoiceExtraBillItemAdjustments.ExtraBillNo, InvoiceExtraBillItemAdjustments.InvoiceNo, ItemCode, ItemCategoryID, AdjustmentTypeID
return 0
end
go

/******************************************************************************************************
exec uspGetInvoiceExtraBillItemAdjustmentsByInvoiceNo '18172334'
******************************************************************************************************/
-- select * from InvoiceExtraBillItemAdjustments
-- delete from InvoiceExtraBillItemAdjustments





------------------------------------------------------------------------------------------------------
-------------- BillAdjustments --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert BillAdjustments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertBillAdjustments')
	drop proc uspInsertBillAdjustments
go

create proc uspInsertBillAdjustments(
@AdjustmentNo varchar(20),
@BillNo varchar(20),
@AdjustmentDate smalldatetime,
@VisitTypeID varchar(10),
@AdjustmentTypeID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @AdjustmentID int

if exists(select AdjustmentNo from BillAdjustments where AdjustmentNo = @AdjustmentNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Adjustment No', @AdjustmentNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VisitTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit Type ID', @VisitTypeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
set @AdjustmentID = (select max(AdjustmentID) from BillAdjustments where BillNo = @BillNo)
	set @AdjustmentID = dbo.GetNextAutoNumber('BillAdjustments', 'AdjustmentNo', @AdjustmentID)
insert into BillAdjustments
(AdjustmentID, AdjustmentNo, BillNo, AdjustmentDate, VisitTypeID, AdjustmentTypeID, LoginID, ClientMachine)
values
(@AdjustmentID, @AdjustmentNo, @BillNo, @AdjustmentDate, @VisitTypeID, @AdjustmentTypeID, @LoginID, @ClientMachine)
return 0
end
go

/****************************************************************************************************************************************
 exec uspInsertBillAdjustments 'P16000092000001', 'P16000092000001', 'Nov 3 2018', '110OPD', '264D', 'ClinicMaster.Sam', 'ClinicMaster13'
 ***************************************************************************************************************************************/

-------------- Get BillAdjustments -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBillAdjustments')
	drop proc uspGetBillAdjustments
go

create proc uspGetBillAdjustments(
@AdjustmentNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AdjustmentNo from BillAdjustments where AdjustmentNo = @AdjustmentNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Adjustment No', @AdjustmentNo, 'BillAdjustments')
		return 1
	end
else
begin
	select AdjustmentNo, BillNo, AdjustmentDate, VisitTypeID, dbo.GetLookupDataDes(VisitTypeID) as VisitType, AdjustmentTypeID, dbo.GetLookupDataDes(AdjustmentTypeID) as AdjustmentType, BillAdjustments.LoginID, ClientMachine, RecordDateTime
	from BillAdjustments

	where AdjustmentNo = @AdjustmentNo
return 0
end
go

/******************************************************************************************************
exec uspGetBillAdjustments
******************************************************************************************************/
-- select * from BillAdjustments
-- delete from BillAdjustments


-------uspGetNextBillAdjustmentID --------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextBillAdjustmentID')
    drop proc uspGetNextBillAdjustmentID
go

create proc uspGetNextBillAdjustmentID(
@BillNo varchar(20),
@AdjustmentID int = null output
)with encryption as

set @AdjustmentID = (select max(AdjustmentID) from BillAdjustments where BillNo = @BillNo)
set @AdjustmentID = dbo.GetNextAutoNumber('BillAdjustments', 'AdjustmentNo', @AdjustmentID)

return 0

go



--------------------------------------------------------------------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetPatientsRecordOPD')
	drop proc uspGetPatientsRecordOPD
go

create proc uspGetPatientsRecordOPD(
@PatientNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

declare @Offered varchar(10)
declare @done varchar(10)
set @Offered = dbo.GetLookupDataID('ItemStatus', 'O')
set @done = dbo.GetLookupDataID('ItemStatus', 'D')
---------------------------------------------------------------------------------------------------------------------------------------------------------------
begin

select dbo.FormatDate(Items.RecordDateTime) as DateAndTime,
dbo.GetLookupDataDes(ItemCategoryID) as Category,
dbo.FormatMoney(UnitPrice * Quantity) as Amount,
ItemName as Details,dbo.GetLookupDataDes(PaystatusID) as PayStatus,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus,dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
Quantity from Items inner join 
Visits on Items.VisitNo = visits.VisitNo
where visits.PatientNo=@PatientNo
order by Items.RecordDateTime desc
end
go

------ exec uspGetPatientsRecordOPD '1710474'

--------------------------------------------------------------------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetPatientsRecordIPD')
	drop proc uspGetPatientsRecordIPD
go

create proc uspGetPatientsRecordIPD(
@PatientNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

---------------------------------------------------------------------------------------------------------------------------------------------------------------
begin

select dbo.FormatDate(ExtraBillItems.RecordDateTime) as DateAndTime,dbo.GetLookupDataDes(ItemCategoryID) as Category,
ItemName as Details,Quantity,
dbo.FormatMoney(UnitPrice * Quantity) as Amount,dbo.GetLookupDataDes(PaystatusID) as PayStatus,
'Done' as ItemStatus,dbo.GetBillName(BillModesID, BillNo) as BillCustomerName from ExtraBills
inner join ExtraBillItems on ExtraBills.ExtraBillNo =ExtraBillItems.ExtraBillNo
inner join Visits on Visits.VisitNo =ExtraBills.VisitNo
where visits.PatientNo=@PatientNo
order by ExtraBillItems.RecordDateTime desc
end
go

--------- exec uspGetPatientsRecordIPD '1711403'


---------------------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetStaffFullNameUsingLoginID')
	drop proc uspGetStaffFullNameUsingLoginID
go

create proc uspGetStaffFullNameUsingLoginID(
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
select dbo.GetFullName(LastName,'',FirstName) as FullName from Logins WHERE LoginID = @LoginID
end
go

--------- exec uspGetStaffFullNameUsingLoginID '1453873'-------------------------------------------------------

------------------------------------------------------------------------------------------------------
-------------- MappedCodes --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert MappedCodes -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertMappedCodes')
	drop proc uspInsertMappedCodes
go

create proc uspInsertMappedCodes(
@AccountNo varchar(20),
@ItemCode varchar(200),
@ItemCategoryID varchar(10),
@CustomCode varchar(20),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AccountNo from BillCustomers where AccountNo  = @AccountNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'AccountNo', @AccountNo, 'BillCustomers')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCategoryID', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if exists(select AccountNo from MappedCodes where AccountNo = @AccountNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'AccountNo', @AccountNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'LoginID', @LoginID)
		return 1
	end



begin
insert into MappedCodes
(AccountNo, ItemCode, ItemCategoryID, CustomCode, LoginID)
values
(@AccountNo, @ItemCode, @ItemCategoryID, @CustomCode, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertMappedCodes
******************************************************************************************************/
-- select * from MappedCodes
-- delete from MappedCodes


-------------- Update MappedCodes -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateMappedCodes')
	drop proc uspUpdateMappedCodes
go

create proc uspUpdateMappedCodes(
@AccountNo varchar(20),
@ItemCode varchar(200),
@ItemCategoryID varchar(10),
@CustomCode varchar(20),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AccountNo from MappedCodes where AccountNo = @AccountNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and LoginID = @LoginID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'AccountNo', @AccountNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'LoginID', @LoginID, 'MappedCodes')
		return 1
	end



begin
update MappedCodes set
CustomCode = @CustomCode
where AccountNo = @AccountNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and LoginID = @LoginID
return 0
end
go

/******************************************************************************************************
exec uspUpdateMappedCodes
******************************************************************************************************/
-- select * from MappedCodes
-- delete from MappedCodes


-------------- Get MappedCodes -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetMappedCodes')
	drop proc uspGetMappedCodes
go

create proc uspGetMappedCodes(
@AccountNo varchar(20),
@ItemCode varchar(200),
@ItemCategoryID varchar(10),
@CustomCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AccountNo from MappedCodes where AccountNo = @AccountNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and CustomCode = @CustomCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'AccountNo', @AccountNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'CustomCode', @CustomCode, 'MappedCodes')
		return 1
	end
else
begin
	select AccountNo, ItemCode, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory ,CustomCode, LoginID, ClientMachine, RecordDateTime
	from MappedCodes

	where AccountNo = @AccountNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and CustomCode = @CustomCode
return 0
end
go

/******************************************************************************************************
exec uspGetMappedCodes
******************************************************************************************************/
-- select * from MappedCodes
-- delete from MappedCodes


/*==================================================01-12-2017================================================================================== */
/*==================================================01-12-2017================================================================================== */




------------------------------------------------------------------------------------------------------
-------------- CardiologyExaminations -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert CardiologyExaminations ----------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertCardiologyExaminations')
	drop proc uspInsertCardiologyExaminations
go

create proc uspInsertCardiologyExaminations(
@ExamCode varchar(20),
@ExamName varchar(200),
@CardiologyCategoriesID varchar(10),
@CardiologySiteID varchar(10),
@UnitPrice money,
@VATPercentage decimal,
@Hidden bit = null,
@LoginID Varchar(20),
@ClientMachine Varchar(40),
@RecordDateTime Smalldatetime

)with encryption as

declare @ErrorMSG varchar(200)
declare @ExamID Int
declare @CardiologyExamCodePrefix varchar(1)

if exists(select ExamCode from CardiologyExaminations where ExamCode = @ExamCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ExamCode)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CardiologyCategoriesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cardiology Categories ID', @CardiologyCategoriesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CardiologySiteID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cardiology Site', @CardiologySiteID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end


begin

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------
	set @CardiologyExamCodePrefix = dbo.GetOptionValue('CardiologyExamCodePrefix')
	set @ExamID = (select max(ExamID) from CardiologyExaminations where left(ExamCode, len(@CardiologyExamCodePrefix)) = @CardiologyExamCodePrefix)
	set @ExamID = dbo.GetNextAutoNumber('CardiologyExaminations', 'ExamCode', @ExamID)


insert into CardiologyExaminations
(ExamID, ExamCode, ExamName, CardiologyCategoriesID,CardiologySiteID,VATPercentage, UnitPrice, Hidden, LoginID, ClientMachine, RecordDateTime)
values
(@ExamID, @ExamCode, @ExamName, @CardiologyCategoriesID,@CardiologySiteID,@VATPercentage, @UnitPrice, @Hidden, @LoginID, @ClientMachine, @RecordDateTime)

return 0
end
go

/******************************************************************************************************
exec uspInsertCardiologyExaminations 'E001', 'Obs Scan', '37S', 6000, 1
exec uspInsertCardiologyExaminations 'E002', 'Abd Scan', '37S', 32000
exec uspInsertCardiologyExaminations 'E003', 'Pelvic Scan', '37US', 15000
exec uspInsertCardiologyExaminations 'E004', 'Superficial Scan', '37OT', 8750
exec uspInsertCardiologyExaminations 'E005', 'Chest XRay', '37XR', 120000

******************************************************************************************************/
-- select * from CardiologyExaminations
-- delete from CardiologyExaminations

---------------------------------------------------------------------------------------------------------------------------------------------------
--------GetNextCardiologyExamID--------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextCardiologyExamID')
	drop proc uspGetNextCardiologyExamID
go
create proc uspGetNextCardiologyExamID(
@ExamID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CardiologyExamCodePrefix varchar(1)

set @CardiologyExamCodePrefix =dbo.GetOptionValue('CardiologyExamCodePrefix')

set @ExamID = (select max(ExamID) from CardiologyExaminations where left(ExamCode, len(@CardiologyExamCodePrefix)) = @CardiologyExamCodePrefix)
set @ExamID =  dbo.GetNextAutoNumber('CardiologyExaminations', 'ExamCode', @ExamID)

return 0
go




-------------- Update CardiologyExaminations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateCardiologyExaminations')
	drop proc uspUpdateCardiologyExaminations
go

create proc uspUpdateCardiologyExaminations(
@ExamCode varchar(20),
@ExamName varchar(40),
@CardiologyCategoriesID varchar(10),
@CardiologySiteID varchar(10),
@VATPercentage decimal,
@UnitPrice money,
@Hidden bit = null,
@LoginID Varchar(20),
@ClientMachine Varchar(40),
@RecordDateTime Smalldatetime

)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ExamCode from CardiologyExaminations where ExamCode = @ExamCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ExamCode, 'Cardiology Examinations')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CardiologyCategoriesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cardiology Categories ID', @CardiologyCategoriesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CardiologySiteID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cardiology Site', @CardiologySiteID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

update CardiologyExaminations set
ExamName = @ExamName, CardiologyCategoriesID = @CardiologyCategoriesID,CardiologySiteID=@CardiologySiteID,VATPercentage=@VATPercentage, 
UnitPrice = @UnitPrice, Hidden = @Hidden, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
where ExamCode = @ExamCode

return 0
end
go

/******************************************************************************************************
exec uspUpdateCardiologyExaminations 'E001', 'Superficial', '37S', 8700, 0

******************************************************************************************************/
-- select * from CardiologyExaminations
-- delete from CardiologyExaminations

-------------- Get CardiologyExaminations -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCardiologyExaminations')
	drop proc uspGetCardiologyExaminations
go

create proc uspGetCardiologyExaminations(
@ExamCode varchar(20) = null,
@Hidden bit = null
)with encryption as

declare @ErrorMSG varchar(200)

-------------------------------------------------------------------------------------
set @Hidden = isnull(@Hidden, 0)
-------------------------------------------------------------------------------------

if not (@ExamCode is null)
begin
	if not exists(select ExamCode from CardiologyExaminations where ExamCode = @ExamCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Exam Code', @ExamCode, 'Cardiology Examinations')
		return 1
	end
	begin
		select ExamCode, ExamName, dbo.GetMergedNameCode(ExamName, ExamCode) as ExamFullName,
		CardiologyCategoriesID, dbo.GetLookupDataDes(CardiologyCategoriesID) as CardiologyCategories,
		CardiologySiteID,dbo.GetLookupDataDes(CardiologySiteID) as CardiologySites,
		VATPercentage, UnitPrice, Hidden
		,CardiologyExaminations.LoginID, ClientMachine, RecordDateTime
		from CardiologyExaminations
		inner join Logins on CardiologyExaminations.LoginID = Logins.LoginID	
		where ExamCode = @ExamCode
	end
end
else
if  (@ExamCode is null)

begin
	select ExamCode, ExamName, dbo.GetMergedNameCode(ExamName, ExamCode) as ExamFullName,
	CardiologyCategoriesID, dbo.GetLookupDataDes(CardiologyCategoriesID) as CardiologyCategories,
	CardiologySiteID,dbo.GetLookupDataDes(CardiologySiteID) as CardiologySites,
	VATPercentage, UnitPrice, Hidden
	,CardiologyExaminations.LoginID, ClientMachine, RecordDateTime
	from CardiologyExaminations
	inner join Logins on CardiologyExaminations.LoginID = Logins.LoginID	
	where Hidden = @Hidden
	order by ExamName
end
return 0
go


/******************************************************************************************************
exec uspGetCardiologyExaminations 'E001'
exec uspGetCardiologyExaminations

******************************************************************************************************/
-- select * from CardiologyExaminations
-- delete from CardiologyExaminations

------------------------------------------------------------------------------------------------------
-------------- CardiologyReports ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert CardiologyReports ---------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertCardiologyReports')
	drop proc uspInsertCardiologyReports
go

create proc uspInsertCardiologyReports(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ExamDateTime smalldatetime,
@Indication varchar(4000),
@Report varchar(4000),
@Conclusion varchar(4000),
@Cardiologist varchar(10),
@CardiologyTitleID varchar(10),
@LoginID Varchar(20),
@ClientMachine Varchar(40),
@RecordDateTime Smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Items')
		return 1
	end

if exists(select VisitNo from CardiologyReports where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID)
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Cardiologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cardiologist', @Cardiologist, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CardiologyTitleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cardiology Title ID', @CardiologyTitleID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into CardiologyReports
(VisitNo, ItemCode, ItemCategoryID, ExamDateTime, Indication, Report, Conclusion, Cardiologist, CardiologyTitleID
, LoginID, ClientMachine, RecordDateTime)
values
(@VisitNo, @ItemCode, @ItemCategoryID, @ExamDateTime, @Indication, @Report, @Conclusion, @Cardiologist, @CardiologyTitleID
, @LoginID, @ClientMachine, @RecordDateTime)
return 0
end
go

/******************************************************************************************************
exec uspInsertCardiologyReports 'MED02001', 'E001', '7R', '22 Sep 2010 14:45', 'Report', 'Conclusion',
							   '100', 'Admin'

exec uspInsertCardiologyReports 'MED02001', 'E002', '7R', '22 Sep 2010 14:45', 'Report', 'Conclusion',
							   '100', 'Admin'

exec uspInsertCardiologyReports '100054001', 'E001', '7R', '22 Sep 2010 14:45', 'Report', 'Conclusion',
							   '100', 'Admin'

******************************************************************************************************/
-- select * from CardiologyReports
-- delete from CardiologyReports

-------------- Update CardiologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateCardiologyReports')
	drop proc uspUpdateCardiologyReports
go

create proc uspUpdateCardiologyReports(
@VisitNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ExamDateTime smalldatetime,
@Indication varchar(4000),
@Report varchar(4000),
@Conclusion varchar(4000),
@Cardiologist varchar(10),
@CardiologyTitleID varchar(10),
@LoginID Varchar(20),
@ClientMachine Varchar(40),
@RecordDateTime Smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from CardiologyReports where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Cardiology Reports')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Cardiologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cardiologist', @Cardiologist, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CardiologyTitleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cardiology Title ID', @CardiologyTitleID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
	update CardiologyReports set
	ExamDateTime = @ExamDateTime, Indication = @Indication, Report = @Report, Conclusion = @Conclusion, 
	Cardiologist = @Cardiologist, CardiologyTitleID = @CardiologyTitleID
	, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
	where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	return 0
end
go

/******************************************************************************************************
exec uspUpdateCardiologyReports '100054001', 'E001', '7R', '20 Sep 2010 11:45', 'Report2', 'Conclusion2',
							   '101', 'Admin'

******************************************************************************************************/
-- select * from CardiologyReports
-- delete from CardiologyReports

-------------- Get CardiologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCardiologyReports')
	drop proc uspGetCardiologyReports
go

create proc uspGetCardiologyReports(
@VisitNo varchar(20),
@ItemCode varchar(20) = null,
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not @VisitNo is null and @ItemCode is null and @ItemCategoryID is null)
	begin
		select VisitNo, ItemCode, ItemCategoryID, ExamDateTime, Indication, Report, Conclusion, Cardiologist, 
		dbo.GetItemName(ItemCategoryID, ItemCode) as ExamName, dbo.GetStaffName(Cardiologist)as CardiologistName,
		dbo.GetStaffFullName(Cardiologist)as CardiologistFullName,
		CardiologyTitleID, dbo.GetLookupDataDes(CardiologyTitleID) as CardiologyTitle
		, CardiologyReports.LoginID, ClientMachine, RecordDateTime
		from CardiologyReports
		inner join Logins on CardiologyReports.LoginID = Logins.LoginID
		where VisitNo = @VisitNo
	end
else
if (not @VisitNo is null and not @ItemCode is null and not @ItemCategoryID is null)
begin
	if not exists(select VisitNo from CardiologyReports where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Cardiology Reports')
			return 1
		end
	else
	begin
		select VisitNo, ItemCode, ItemCategoryID, ExamDateTime, Indication, Report, Conclusion, Cardiologist, 
		dbo.GetItemName(ItemCategoryID, ItemCode) as ExamName, dbo.GetStaffName(Cardiologist)as CardiologistName,
		dbo.GetStaffFullName(Cardiologist)as CardiologistFullName,
		CardiologyTitleID, dbo.GetLookupDataDes(CardiologyTitleID) as CardiologyTitle
		, CardiologyReports.LoginID, ClientMachine, RecordDateTime
		from CardiologyReports
		inner join Logins on CardiologyReports.LoginID = Logins.LoginID
		where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	end
end
return 0
go

/******************************************************************************************************
exec uspGetCardiologyReports '100970002', 'E001', '7R'
exec uspGetCardiologyReports '100970002'

******************************************************************************************************/
-- select * from CardiologyReports
-- delete from CardiologyReports

--------- GetSelfRequestCardiologyReports -------------------------------------------

if exists (select * from sysobjects where name = 'uspGetSelfRequestCardiologyReports')
	drop proc uspGetSelfRequestCardiologyReports
go

create proc uspGetSelfRequestCardiologyReports
(@VisitNo varchar(20) = null)
with encryption as

declare @ErrorMSG varchar(200)

declare @SelfRequestVisitCategoryID varchar(10)
declare @RecordDateTime smalldatetime

set @SelfRequestVisitCategoryID = dbo.GetLookupDataID('VisitCategory', 'S')
set @RecordDateTime = dateadd(hour, -12, getdate())

begin
if not (@VisitNo is null or @VisitNo = '')
	begin
		if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
			return 1
		end
		else
		begin
			select Patients.PatientNo,Visits.VisitNo,dbo.GetFullName(LastName,MiddleName,FirstName) as FullName,
			dbo.GetLookupDataDes(GenderID) as Gender,dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.FormatDate(VisitDate) as VisitDate,dbo.FormatDate(ExamDateTime) as ExamDate,
			dbo.GetTime(CardiologyReports.RecordDateTime) as SentTime, dbo.GetStaffName(Cardiologist) as Cardiologist 
			from Patients inner join visits on Patients.PatientNo = Visits.PatientNo
			inner join CardiologyReports on Visits.VisitNo = CardiologyReports.VisitNo
			where Visits.VisitCategoryID = @SelfRequestVisitCategoryID
			and Visits.VisitNo = @VisitNo and CardiologyReports.RecordDateTime >= @RecordDateTime
			order by  ExamDate desc, SentTime desc
		end
	end
else
	begin
		select Patients.PatientNo,Visits.VisitNo,dbo.GetFullName(LastName,MiddleName,FirstName) as FullName,
		dbo.GetLookupDataDes(GenderID) as Gender,dbo.GetAge(BirthDate, getdate()) as Age, 
		dbo.FormatDate(VisitDate) as VisitDate,dbo.FormatDate(ExamDateTime) as ExamDate,
		dbo.GetTime(CardiologyReports.RecordDateTime) as SentTime, dbo.GetStaffName(Cardiologist) as Cardiologist 
		from Patients inner join visits on Patients.PatientNo = Visits.PatientNo
		inner join CardiologyReports on Visits.VisitNo = CardiologyReports.VisitNo
		where Visits.VisitCategoryID = @SelfRequestVisitCategoryID and CardiologyReports.RecordDateTime >= @RecordDateTime
		order by  ExamDate desc, SentTime desc
	end
end
return 0
go

-----------------------------------------------------
--exec uspGetSelfRequestCardiologyReports '1112541002'
--exec uspGetSelfRequestCardiologyReports
-----------------------------------------------------



------------------------------------------------------------------------------------------------------
-------------- IPDCardiologyReports -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert IPDCardiologyReports ------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertIPDCardiologyReports')
	drop proc uspInsertIPDCardiologyReports
go

create proc uspInsertIPDCardiologyReports(
@RoundNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ExamDateTime smalldatetime,
@Indication varchar(4000),
@Report varchar(4000),
@Conclusion varchar(4000),
@Cardiologist varchar(10),
@CardiologyTitleID varchar(10),
@LoginID Varchar(20),
@ClientMachine Varchar(40),
@RecordDateTime Smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDItems where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'IPD Items')
		return 1
	end

if exists(select RoundNo from IPDCardiologyReports where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID)
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Cardiologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cardiologist', @Cardiologist, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CardiologyTitleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cardiology Title ID', @CardiologyTitleID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into IPDCardiologyReports
(RoundNo, ItemCode, ItemCategoryID, ExamDateTime, Indication, Report, Conclusion, Cardiologist, CardiologyTitleID
, LoginID, ClientMachine, RecordDateTime)
values
(@RoundNo, @ItemCode, @ItemCategoryID, @ExamDateTime, @Indication, @Report, @Conclusion, @Cardiologist, @CardiologyTitleID
, @LoginID, @ClientMachine, @RecordDateTime)
return 0
end
go

/******************************************************************************************************
exec uspInsertIPDCardiologyReports 'MED02001', 'E001', '7R', '22 Sep 2010 14:45', 'Report', 'Conclusion',
							   '100', 'Admin'

exec uspInsertIPDCardiologyReports 'MED02001', 'E002', '7R', '22 Sep 2010 14:45', 'Report', 'Conclusion',
							   '100', 'Admin'

exec uspInsertIPDCardiologyReports '100054001', 'E001', '7R', '22 Sep 2010 14:45', 'Report', 'Conclusion',
							   '100', 'Admin'

******************************************************************************************************/
-- select * from IPDCardiologyReports
-- delete from IPDCardiologyReports

-------------- Update IPDCardiologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDCardiologyReports')
	drop proc uspUpdateIPDCardiologyReports
go

create proc uspUpdateIPDCardiologyReports(
@RoundNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@ExamDateTime smalldatetime,
@Indication varchar(4000),
@Report varchar(4000),
@Conclusion varchar(4000),
@Cardiologist varchar(10),
@CardiologyTitleID varchar(10),
@LoginID Varchar(20),
@ClientMachine Varchar(40),
@RecordDateTime Smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDCardiologyReports where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Cardiology Reports')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @Cardiologist)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cardiologist', @Cardiologist, 'Staff')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CardiologyTitleID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cardiology Title ID', @CardiologyTitleID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
	update IPDCardiologyReports set
	ExamDateTime = @ExamDateTime, Indication = @Indication, Report = @Report, Conclusion = @Conclusion, 
	Cardiologist = @Cardiologist, CardiologyTitleID = @CardiologyTitleID
	, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
	where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDCardiologyReports '100054001', 'E001', '7R', '20 Sep 2010 11:45', 'Report2', 'Conclusion2',
							   '101', 'Admin'

******************************************************************************************************/
-- select * from IPDCardiologyReports
-- delete from IPDCardiologyReports

-------------- Get IPDCardiologyReports -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDCardiologyReports')
	drop proc uspGetIPDCardiologyReports
go

create proc uspGetIPDCardiologyReports(
@RoundNo varchar(20),
@ItemCode varchar(20) = null,
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not @RoundNo is null and @ItemCode is null and @ItemCategoryID is null)
	begin
		select RoundNo, ItemCode, ItemCategoryID, ExamDateTime, Indication, Report, Conclusion, Cardiologist, 
		dbo.GetItemName(ItemCategoryID, ItemCode) as ExamName, dbo.GetStaffName(Cardiologist)as CardiologistName,
		dbo.GetStaffFullName(Cardiologist)as CardiologistFullName,
		CardiologyTitleID, dbo.GetLookupDataDes(CardiologyTitleID) as CardiologyTitle
		, IPDCardiologyReports.LoginID, ClientMachine, RecordDateTime
		from IPDCardiologyReports
		inner join Logins on IPDCardiologyReports.LoginID = Logins.LoginID
		where RoundNo = @RoundNo
	end
else
if (not @RoundNo is null and not @ItemCode is null and not @ItemCategoryID is null)
begin
	if not exists(select RoundNo from IPDCardiologyReports where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
		begin
			set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'Item Code', @ItemCode, 'Item Category ID', @ItemCategoryID, 'Cardiology Reports')
			return 1
		end
	else
	begin
		select RoundNo, ItemCode, ItemCategoryID, ExamDateTime, Indication, Report, Conclusion, Cardiologist, 
		dbo.GetItemName(ItemCategoryID, ItemCode) as ExamName, dbo.GetStaffName(Cardiologist)as CardiologistName,
		dbo.GetStaffFullName(Cardiologist)as CardiologistFullName,
		CardiologyTitleID, dbo.GetLookupDataDes(CardiologyTitleID) as CardiologyTitle
		, IPDCardiologyReports.LoginID, ClientMachine, RecordDateTime
		from IPDCardiologyReports
		inner join Logins on IPDCardiologyReports.LoginID = Logins.LoginID
		where RoundNo = @RoundNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	end
end
return 0
go

/******************************************************************************************************
exec uspGetIPDCardiologyReports '100970002', 'E001', '7R'
exec uspGetIPDCardiologyReports '100970002'

******************************************************************************************************/
-- select * from IPDCardiologyReports
-- delete from IPDCardiologyReports

------------------------------------------------------------------------------------------------------
-------------- ChildNutrition --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ChildNutrition -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertChildNutrition')
	drop proc uspInsertChildNutrition
go

create proc uspInsertChildNutrition(
@VisitNo Varchar(20),
@BreastFeeding Varchar(10),
@IfNoDetails Varchar(100),
@ComplementaryFoods Varchar(10),
@ComplementaryFoodsDetails Varchar(100),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BreastFeeding)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Breast Feeding', @BreastFeeding, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ComplementaryFoods)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Complementary Foods', @ComplementaryFoods, 'Lookup Data')
		return 1
	end



if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into ChildNutrition
(VisitNo, BreastFeeding, IfNoDetails, ComplementaryFoods, ComplementaryFoodsDetails, LoginID)
values
(@VisitNo, @BreastFeeding, @IfNoDetails, @ComplementaryFoods, @ComplementaryFoodsDetails,@LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertChildNutrition
******************************************************************************************************/
-- select * from ChildNutrition
-- delete from ChildNutrition


-------------- Update ChildNutrition -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateChildNutrition')
	drop proc uspUpdateChildNutrition
go

create proc uspUpdateChildNutrition(
@VisitNo Varchar(20),
@BreastFeeding Varchar(10),
@IfNoDetails Varchar(100),
@ComplementaryFoods Varchar(10),
@ComplementaryFoodsDetails Varchar(100),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select VisitNo from ChildNutrition where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'ChildNutrition')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BreastFeeding)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Breast Feeding', @BreastFeeding, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ComplementaryFoods)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Complementary Foods', @ComplementaryFoods, 'Lookup Data')
		return 1
	end


if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end


if exists(select VisitNo from Nutrition where VisitNo = @VisitNo)
begin

	update ChildNutrition set
		BreastFeeding = @BreastFeeding, IfNoDetails = @IfNoDetails, ComplementaryFoods = @ComplementaryFoods, ComplementaryFoodsDetails = @ComplementaryFoodsDetails, LoginID = @LoginID
		where VisitNo = @VisitNo
	return 0

end
else
begin
insert into ChildNutrition
	(VisitNo, BreastFeeding, IfNoDetails, ComplementaryFoods, ComplementaryFoodsDetails, 
	 LoginID) 
	values
	(@VisitNo, @BreastFeeding, @IfNoDetails, @ComplementaryFoods, @ComplementaryFoodsDetails, 
	 @LoginID)
return 0
end
go



/******************************************************************************************************
exec uspUpdateChildNutrition
******************************************************************************************************/
-- select * from ChildNutrition
-- delete from ChildNutrition


-------------- Get ChildNutrition -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetChildNutrition')
	drop proc uspGetChildNutrition
go

create proc uspGetChildNutrition(
@VisitNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select VisitNo, BreastFeeding, dbo.GetLookupDataDes(BreastFeeding) as [Breast Feeding], IfNoDetails, ComplementaryFoods, dbo.GetLookupDataDes(ComplementaryFoods) as [Complementary Foods], ComplementaryFoodsDetails, LoginID
	from ChildNutrition
	where VisitNo = @VisitNo

	
return 0
end
go

------------------------------------------------------------------------------------------------------
-------------- Antenatal --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Antenatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAntenatal')
	drop proc uspInsertAntenatal
go

create proc uspInsertAntenatal(
@VisitNo Varchar(20),
@Infection Varchar(10),
@InfectionDetails Varchar(100),
@AccidentDuringPregnancy Varchar(10),
@DetailsOfAccident Varchar(100),
@UseOfDrugsOrPrescription Varchar(10),
@DrugDetails Varchar(100),
@Smoking Varchar(10),
@ChronicIllness varchar(10),
@DetailsOfIllness varchar(100),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Infection)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Infection', @Infection, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AccidentDuringPregnancy)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Accident During Pregnancy', @AccidentDuringPregnancy, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @UseOfDrugsOrPrescription)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Use Of Drugs Or Prescription', @UseOfDrugsOrPrescription, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Smoking)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Smoking', @Smoking, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ChronicIllness)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Chronic Illness', @ChronicIllness, 'LookupData')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into Antenatal
(VisitNo, Infection, InfectionDetails, AccidentDuringPregnancy, DetailsOfAccident, UseOfDrugsOrPrescription, DrugDetails, Smoking, ChronicIllness, DetailsOfIllness, LoginID)
values
(@VisitNo, @Infection, @InfectionDetails, @AccidentDuringPregnancy, @DetailsOfAccident, @UseOfDrugsOrPrescription, @DrugDetails, @Smoking, @ChronicIllness, @DetailsOfIllness, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertAntenatal
******************************************************************************************************/
-- select * from Antenatal
-- delete from Antenatal


-------------- Update Antenatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateAntenatal')
	drop proc uspUpdateAntenatal
go

create proc uspUpdateAntenatal(
@VisitNo Varchar(20),
@Infection Varchar(10),
@InfectionDetails Varchar(100),
@AccidentDuringPregnancy Varchar(10),
@DetailsOfAccident Varchar(100),
@UseOfDrugsOrPrescription Varchar(10),
@DrugDetails Varchar(100),
@Smoking Varchar(10),
@ChronicIllness varchar(10),
@DetailsOfIllness varchar(100),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select VisitNo from Antenatal where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @VisitNo, 'Antenatal')
		return 1
	end
	
if not exists(select DataID from LookupData where DataID = @Infection)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Infection', @Infection, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AccidentDuringPregnancy)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Accident During Pregnancy', @AccidentDuringPregnancy, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @UseOfDrugsOrPrescription)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Use Of Drugs Or Prescription', @UseOfDrugsOrPrescription, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Smoking)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Smoking', @Smoking, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ChronicIllness)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Chronic Illness', @ChronicIllness, 'LookupData')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update Antenatal set
VisitNo = @VisitNo, Infection = @Infection, InfectionDetails = @InfectionDetails, AccidentDuringPregnancy = @AccidentDuringPregnancy, DetailsOfAccident = @DetailsOfAccident, UseOfDrugsOrPrescription = @UseOfDrugsOrPrescription, DrugDetails = @DrugDetails, Smoking = @Smoking, ChronicIllness = @ChronicIllness, DetailsOfIllness = @DetailsOfIllness, LoginID = @LoginID

return 0
end
go

/******************************************************************************************************
exec uspUpdateAntenatal
******************************************************************************************************/
-- select * from Antenatal
-- delete from Antenatal


-------------- Get Antenatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAntenatal')
	drop proc uspGetAntenatal
go

create proc uspGetAntenatal(
@VisitNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select Antenatal.VisitNo, Infection, dbo.GetLookupDataDes(Infection) as [InfectionID], InfectionDetails, AccidentDuringPregnancy, dbo.GetLookupDataDes(AccidentDuringPregnancy) as [AccidentDuringPregnancyID], DetailsOfAccident, UseOfDrugsOrPrescription, dbo.GetLookupDataDes(UseOfDrugsOrPrescription) as [UseOfDrugsOrPrescriptionID], DrugDetails, Smoking, dbo.GetLookupDataDes(Smoking) as [SmokingID], ChronicIllness, dbo.GetLookupDataDes(ChronicIllness) as [ChronicIllnessID], DetailsOfIllness, Antenatal.LoginID
	from Antenatal
	where VisitNo = @VisitNo
	
	
return 0
end
go

/******************************************************************************************************
exec uspGetAntenatal '170003'
******************************************************************************************************/
-- select * from Antenatal
-- delete from Antenatal


------------------------------------------------------------------------------------------------------
-------------- ChildGrowth --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ChildGrowth -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertChildGrowth')
	drop proc uspInsertChildGrowth
go

create proc uspInsertChildGrowth(
@VisitNo Varchar(20),
@SocialSmile bit,
@HeadControl bit,
@ReactionToSound bit,
@GraspReflex bit,
@Sitting bit,
@Standing bit,
@WeightForAge Varchar(10),
@HeightForAge Varchar(10),
@WeightForHeight Varchar(10),
@BreastFeedingID varchar(10),
@Notes varchar(200),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @WeightForAge)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Weght For Age', @WeightForAge, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HeightForAge)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Height For Age', @HeightForAge, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @WeightForHeight)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Weight For Height', @WeightForHeight, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BreastFeedingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Breast Feeding', @BreastFeedingID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into ChildGrowth
(VisitNo, SocialSmile, HeadControl, ReactionToSound, GraspReflex, Sitting, Standing, WeightForAge, HeightForAge, WeightForHeight,BreastFeedingID, Notes, LoginID)
values
(@VisitNo, @SocialSmile, @HeadControl, @ReactionToSound, @GraspReflex, @Sitting, @Standing, @WeightForAge, @HeightForAge, @WeightForHeight, @BreastFeedingID, @Notes, @LoginID)
return 0
end
go


/******************************************************************************************************
exec uspInsertChildGrowth
******************************************************************************************************/
-- select * from ChildGrowth
-- delete from ChildGrowth


---------------- Update ChildGrowth -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateChildGrowth')
	drop proc uspUpdateChildGrowth
go

create proc uspUpdateChildGrowth(
@VisitNo Varchar(20),
@SocialSmile bit,
@HeadControl bit,
@ReactionToSound bit,
@GraspReflex bit,
@Sitting bit,
@Standing bit,
@WeightForAge Varchar(10),
@HeightForAge Varchar(10),
@WeightForHeight Varchar(10),
@BreastFeedingID varchar(10),
@Notes varchar(200),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from ChildGrowth where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'ChildGrowth')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @WeightForAge)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Weght For Age', @WeightForAge, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HeightForAge)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Height For Age', @HeightForAge, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @WeightForHeight)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Weight For Height', @WeightForHeight, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BreastFeedingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Breast Feeding', @BreastFeedingID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update ChildGrowth set
SocialSmile = @SocialSmile, HeadControl = @HeadControl, ReactionToSound = @ReactionToSound, GraspReflex = @GraspReflex, Sitting = @Sitting, Standing = @Standing, WeightForAge = @WeightForAge, HeightForAge = @HeightForAge, WeightForHeight = @WeightForHeight,BreastFeedingID = @BreastFeedingID, Notes = @Notes, LoginID = @LoginID
where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateChildGrowth
******************************************************************************************************/
-- select * from ChildGrowth
-- delete from ChildGrowth


-------------- Get ChildGrowth -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetChildGrowth')
	drop proc uspGetChildGrowth
go

create proc uspGetChildGrowth(
@VisitNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select ChildGrowth.VisitNo, SocialSmile, HeadControl, ReactionToSound, GraspReflex, Sitting, Standing, WeightForAge, dbo.GetLookupDataDes(WeightForAge) as [WeightForAgeID], HeightForAge, dbo.GetLookupDataDes(HeightForAge) as [HeightForAgeID], WeightForHeight, dbo.GetLookupDataDes(WeightForHeight) as [WeightForHeightID],BreastFeedingID, dbo.GetLookupDataDes(BreastFeedingID) as [BreastFeeding], Notes, ChildGrowth.LoginID
	from ChildGrowth
	inner join Logins on ChildGrowth.LoginID = Logins.LoginID	

	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetChildGrowth
******************************************************************************************************/
-- select * from ChildGrowth
-- delete from ChildGrowth



------------------------------------------------------------------------------------------------------
-------------- Perinatal --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Perinatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPerinatal')
	drop proc uspInsertPerinatal
go

create proc uspInsertPerinatal(
@VisitNo Varchar(20),
@ModeOfDelivery Varchar(10),
@DurationOfLabour Decimal,
@DeliveryComplications Varchar(10),
@AmountOfBloodLoss Decimal,
@MothersCondition Varchar(10),
@DetailsOfCondition Varchar(100),
@BabyAlive Varchar(10),
@CauseOfDeath Varchar(10),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ModeOfDelivery)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Mode Of Delivery', @ModeOfDelivery, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DeliveryComplications)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Delivery Complications', @DeliveryComplications, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @MothersCondition)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Mothers Condition', @MothersCondition, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BabyAlive)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Baby Alive', @BabyAlive, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CauseOfDeath)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CauseOfDeath', @CauseOfDeath, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into Perinatal
(VisitNo, ModeOfDelivery, DurationOfLabour, DeliveryComplications, AmountOfBloodLoss, MothersCondition, DetailsOfCondition, BabyAlive, CauseOfDeath, LoginID)
values
(@VisitNo, @ModeOfDelivery, @DurationOfLabour, @DeliveryComplications, @AmountOfBloodLoss, @MothersCondition, @DetailsOfCondition, @BabyAlive, @CauseOfDeath, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertPerinatal
******************************************************************************************************/
-- select * from Perinatal
-- delete from Perinatal


-------------- Update Perinatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePerinatal')
	drop proc uspUpdatePerinatal
go

create proc uspUpdatePerinatal(
@VisitNo Varchar(20),
@ModeOfDelivery Varchar(10),
@DurationOfLabour Decimal,
@DeliveryComplications Varchar(10),
@AmountOfBloodLoss Decimal,
@MothersCondition Varchar(10),
@DetailsOfCondition Varchar(100),
@BabyAlive Varchar(10),
@CauseOfDeath Varchar(10),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select VisitNo from Perinatal where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ModeOfDelivery)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Mode Of Delivery', @ModeOfDelivery, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DeliveryComplications)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Delivery Complications', @DeliveryComplications, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @MothersCondition)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Mothers Condition', @MothersCondition, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BabyAlive)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Baby Alive', @BabyAlive, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CauseOfDeath)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CauseOfDeath', @CauseOfDeath, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update Perinatal set
VisitNo = @VisitNo, ModeOfDelivery = @ModeOfDelivery, DurationOfLabour = @DurationOfLabour, DeliveryComplications = @DeliveryComplications, AmountOfBloodLoss = @AmountOfBloodLoss, MothersCondition = @MothersCondition, DetailsOfCondition = @DetailsOfCondition, BabyAlive = @BabyAlive, CauseOfDeath = @CauseOfDeath, LoginID = @LoginID

return 0
end
go


/******************************************************************************************************
exec uspUpdatePerinatal
******************************************************************************************************/
-- select * from Perinatal
-- delete from Perinatal


-------------- Get Perinatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPerinatal')
	drop proc uspGetPerinatal
go

create proc uspGetPerinatal(
@VisitNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select Perinatal.VisitNo, ModeOfDelivery, dbo.GetLookupDataDes(ModeOfDelivery) as [ModeOfDeliveryID],
	 DurationOfLabour, DeliveryComplications, dbo.GetLookupDataDes(DeliveryComplications) as [DeliveryComplicationsID],
	  AmountOfBloodLoss, MothersCondition, dbo.GetLookupDataDes(MothersCondition) as [MothersConditionID], DetailsOfCondition,
	  BabyAlive, dbo.GetLookupDataDes(BabyAlive) as [BabyAliveID], CauseOfDeath, dbo.GetLookupDataDes(CauseOfDeath) as [CauseOfDeathID],
	  Perinatal.LoginID
	from Perinatal
	where VisitNo= @VisitNo

	
return 0
end
go

/******************************************************************************************************
exec uspGetPerinatal '170005'
******************************************************************************************************/
-- select * from Perinatal
-- delete from Perinatal

------------------------------------------------------------------------------------------------------
-------------- Neonatal --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Neonatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertNeonatal')
	drop proc uspInsertNeonatal
go

create proc uspInsertNeonatal(
@PatientNo Varchar(20),
@GestationalStage Varchar(10),
@Sex Varchar(10),
@BirthWeight Decimal,
@WeighedWithin72hrs varchar(10),
@ConditionOnBirth Varchar(10),
@ConditionDetails Varchar(10),
@PhysicalAbnormalityDetails Varchar(100),
@UmblicalCordDetails Varchar(10),
@Jaundice Varchar(10),
@Bleeding Varchar(10),
@EarlyInfection Varchar(10),
@InfectionDetails Varchar(100),
@Convulsions Varchar(10),
@ConvulsionsDetails Varchar(100),
@EIDResults Varchar(10),
@ApgarScore Int,
@SleepingHabits Varchar(100),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Patients')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GestationalStage)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Gestational Stage', @GestationalStage, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Sex)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sex', @Sex, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @WeighedWithin72hrs)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Weighed Within 72hrs', @WeighedWithin72hrs, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ConditionOnBirth)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Condition On Birth', @ConditionOnBirth, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ConditionDetails)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Condition Details', @ConditionDetails, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @UmblicalCordDetails)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'UmblicalCordDetails', @UmblicalCordDetails, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Jaundice)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Jaundice', @Jaundice, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Bleeding)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bleeding', @Bleeding, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EarlyInfection)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Early Infection', @EarlyInfection, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Convulsions)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Convulsions', @Convulsions, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EIDResults)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'EIDResults', @EIDResults, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into Neonatal
(PatientNo, GestationalStage, Sex, BirthWeight, WeighedWithin72hrs, ConditionOnBirth, ConditionDetails, PhysicalAbnormalityDetails, UmblicalCordDetails, Jaundice, Bleeding, EarlyInfection, InfectionDetails, Convulsions, ConvulsionsDetails, EIDResults, ApgarScore, SleepingHabits, LoginID)
values
(@PatientNo, @GestationalStage, @Sex, @BirthWeight, @WeighedWithin72hrs, @ConditionOnBirth, @ConditionDetails, @PhysicalAbnormalityDetails, @UmblicalCordDetails, @Jaundice, @Bleeding, @EarlyInfection, @InfectionDetails, @Convulsions, @ConvulsionsDetails, @EIDResults, @ApgarScore, @SleepingHabits, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertNeonatal
******************************************************************************************************/
-- select * from Neonatal
-- delete from Neonatal


-------------- Update Neonatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateNeonatal')
	drop proc uspUpdateNeonatal
go

create proc uspUpdateNeonatal(
@PatientNo Varchar(20),
@GestationalStage Varchar(10),
@Sex Varchar(10),
@BirthWeight Decimal,
@WeighedWithin72hrs varchar(10),
@ConditionOnBirth Varchar(10),
@ConditionDetails Varchar(10),
@PhysicalAbnormalityDetails Varchar(100),
@UmblicalCordDetails Varchar(10),
@Jaundice Varchar(10),
@Bleeding Varchar(10),
@EarlyInfection Varchar(10),
@InfectionDetails Varchar(100),
@Convulsions Varchar(10),
@ConvulsionsDetails Varchar(100),
@EIDResults Varchar(10),
@ApgarScore Int,
@SleepingHabits Varchar(100),
@LoginID Varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Patients')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GestationalStage)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Gestational Stage', @GestationalStage, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Sex)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sex', @Sex, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @WeighedWithin72hrs)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Weighed Within 72hrs', @WeighedWithin72hrs, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ConditionOnBirth)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Condition On Birth', @ConditionOnBirth, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ConditionDetails)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Condition Details', @ConditionDetails, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @UmblicalCordDetails)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'UmblicalCordDetails', @UmblicalCordDetails, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Jaundice)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Jaundice', @Jaundice, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Bleeding)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bleeding', @Bleeding, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EarlyInfection)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Early Infection', @EarlyInfection, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Convulsions)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Convulsions', @Convulsions, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EIDResults)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'EIDResults', @EIDResults, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update Neonatal set
PatientNo = @PatientNo, GestationalStage = @GestationalStage, Sex = @Sex, BirthWeight = @BirthWeight, WeighedWithin72hrs = @WeighedWithin72hrs, ConditionOnBirth = @ConditionOnBirth, ConditionDetails = @ConditionDetails, PhysicalAbnormalityDetails = @PhysicalAbnormalityDetails, UmblicalCordDetails = @UmblicalCordDetails, Jaundice = @Jaundice, Bleeding = @Bleeding, EarlyInfection = @EarlyInfection, InfectionDetails = @InfectionDetails, Convulsions = @Convulsions, ConvulsionsDetails = @ConvulsionsDetails, EIDResults = @EIDResults, ApgarScore = @ApgarScore, SleepingHabits = @SleepingHabits, LoginID = @LoginID

return 0
end
go

/******************************************************************************************************
exec uspUpdateNeonatal
******************************************************************************************************/
-- select * from Neonatal
-- delete from Neonatal


-------------- Get Neonatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNeonatal')
	drop proc uspGetNeonatal
go


create proc uspGetNeonatal(
@PatientNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select Neonatal.PatientNo, GestationalStage, dbo.GetLookupDataDes(GestationalStage) as [GestationalStageID], Sex, dbo.GetLookupDataDes(Sex) as [SexID], BirthWeight, WeighedWithin72hrs, dbo.GetLookupDataDes(WeighedWithin72hrs) as [WeighedWithin72hrsID], ConditionOnBirth, dbo.GetLookupDataDes(ConditionOnBirth) as [ConditionOnBirthID], ConditionDetails, dbo.GetLookupDataDes(ConditionDetails) as [ConditionDetailsID], PhysicalAbnormalityDetails, UmblicalCordDetails, dbo.GetLookupDataDes(UmblicalCordDetails) as [UmblicalCordDetailsID], Jaundice, dbo.GetLookupDataDes(Jaundice) as [JaundiceID], Bleeding, dbo.GetLookupDataDes(Bleeding) as [BleedingID], EarlyInfection, dbo.GetLookupDataDes(EarlyInfection) as [EarlyInfectionID], InfectionDetails, Convulsions, dbo.GetLookupDataDes(Convulsions) as [ConvulsionsID], ConvulsionsDetails, EIDResults, dbo.GetLookupDataDes(EIDResults) as [EIDResultsID], ApgarScore, SleepingHabits, Neonatal.LoginID
	from Neonatal
	where PatientNo =@PatientNo

	
return 0
end
go

------------------------------------------------------------------------------------------------------
-------------- ObstetricHistory --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ObstetricHistory -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertObstetricHistory')
	drop proc uspInsertObstetricHistory
go

create proc uspInsertObstetricHistory(
@PatientNo Varchar(20),
@Gravidity int,
@Parity int,
@NoOfSurvivingChildren int,
@LMP SmallDateTime,
@EDD SmallDateTime,
@GestationalAgeInWks int,
@StillBirth Varchar(10),
@NoOfStillBirths int,
@Abortions Varchar(10),
@NoOfAbortions int,
@Caesarian Varchar(10),
@NoOfCaesarians int,
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)



if not exists(select DataID from LookupData where DataID = @StillBirth)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Still Birth', @StillBirth, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Abortions)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Abortions', @Abortions, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Caesarian)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Caesarian', @Caesarian, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into ObstetricHistory
(PatientNo, Gravidity, Parity, NoOfSurvivingChildren, LMP, EDD, GestationalAgeInWks, StillBirth, NoOfStillBirths, Abortions, NoOfAbortions, Caesarian, NoOfCaesarians, LoginID)
values
(@PatientNo, @Gravidity, @Parity, @NoOfSurvivingChildren, @LMP, @EDD, @GestationalAgeInWks, @StillBirth, @NoOfStillBirths, @Abortions, @NoOfAbortions, @Caesarian, @NoOfCaesarians, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertObstetricHistory
******************************************************************************************************/
-- select * from ObstetricHistory
-- delete from ObstetricHistory


-------------- Update ObstetricHistory -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateObstetricHistory')
	drop proc uspUpdateObstetricHistory
go

create proc uspUpdateObstetricHistory(
@PatientNo Varchar(20),
@Gravidity int,
@Parity int,
@NoOfSurvivingChildren int,
@LMP SmallDateTime,
@EDD SmallDateTime,
@GestationalAgeInWks int,
@StillBirth Varchar(10),
@NoOfStillBirths int,
@Abortions Varchar(10),
@NoOfAbortions int,
@Caesarian Varchar(10),
@NoOfCaesarians int,
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select DataID from LookupData where DataID = @StillBirth)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Still Birth', @StillBirth, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Abortions)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Abortions', @Abortions, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Caesarian)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Caesarian', @Caesarian, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end
if exists(select PatientNo from ObstetricHistory where PatientNo = @PatientNo)
begin

update ObstetricHistory set
	Gravidity = @Gravidity, Parity = @Parity, NoOfSurvivingChildren = @NoOfSurvivingChildren, LMP = @LMP, EDD = @EDD, GestationalAgeInWks = @GestationalAgeInWks, StillBirth = @StillBirth, NoOfStillBirths = @NoOfStillBirths, Abortions = @Abortions, NoOfAbortions = @NoOfAbortions, Caesarian = @Caesarian, NoOfCaesarians = @NoOfCaesarians, LoginID = @LoginID
	where PatientNo = @PatientNo
return 0
end
else
begin
insert into ObstetricHistory
	(PatientNo, Gravidity, Parity , NoOfSurvivingChildren, LMP, EDD, GestationalAgeInWks, StillBirth, NoOfStillBirths, Abortions,NoOfAbortions,Caesarian,NoOfCaesarians, LoginID)
	 
	values
	(@PatientNo, @Gravidity, @Parity, @NoOfSurvivingChildren, @LMP, @EDD, @GestationalAgeInWks, @StillBirth, @NoOfStillBirths, @Abortions,@NoOfAbortions,@Caesarian,@NoOfCaesarians, @LoginID)
return 0
end
go
/******************************************************************************************************
exec uspUpdateObstetricHistory
******************************************************************************************************/
-- select * from ObstetricHistory
-- delete from ObstetricHistory


-------------- Get ObstetricHistory -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetObstetricHistory')
	drop proc uspGetObstetricHistory
go

create proc uspGetObstetricHistory(
	@PatientNo Varchar(20)
)with encryption as
	
declare @ErrorMSG varchar(200)

begin
	select ObstetricHistory.PatientNo, Gravidity, Parity, NoOfSurvivingChildren, LMP, EDD, GestationalAgeInWks, StillBirth, dbo.GetLookupDataDes(StillBirth) as [Still Birth], NoOfStillBirths, Abortions, dbo.GetLookupDataDes(Abortions) as [Abortions], NoOfAbortions, Caesarian, dbo.GetLookupDataDes(Caesarian) as [Caesarian], NoOfCaesarians, ObstetricHistory.LoginID
	from ObstetricHistory
	where PatientNo= @PatientNo

	
return 0
end
go
--------------------------------------------------------------------------------------------------
------------ IPDNurseAssessment --------------------------------------------------------------------
----------------------------------------------------------------------------------------------------

-------------- Edit IPDNurseAssessment -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditIPDNurseAssessment')
	drop proc uspEditIPDNurseAssessment
go

create proc uspEditIPDNurseAssessment(
@RoundNo Varchar(20),
@Complaint Varchar(1000),
@Etiology Varchar(1000),
@SignsAndSymptoms Varchar(1000),
@ProposedSolution Varchar(1000),
@LoginID Varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select NurseRoundNo from IPDNurse where NurseRoundNo  = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Nurse Round No', @RoundNo, 'IPDNurse')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select RoundNo from IPDNurseAssessment where RoundNo = @RoundNo )
	begin
		update IPDNurseAssessment set
		Complaint = @Complaint, Etiology = @Etiology, SignsAndSymptoms = @SignsAndSymptoms, ProposedSolution =@ProposedSolution,
		LoginID = @LoginID
		where RoundNo = @RoundNo
		return 0
	end
else

begin
insert into IPDNurseAssessment
(RoundNo, Complaint, Etiology, SignsAndSymptoms, ProposedSolution, LoginID)
values
(@RoundNo, @Complaint, @Etiology, @SignsAndSymptoms, @ProposedSolution, @LoginID)
return 0
end
go


/******************************************************************************************************
exec uspInsertIPDNurseAssessment
******************************************************************************************************/
-- select * from IPDNurseAssessment
-- delete from IPDNurseAssessment


-------------- Update IPDNurseAssessment -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDNurseAssessment')
	drop proc uspUpdateIPDNurseAssessment
go

create proc uspUpdateIPDNurseAssessment(
@RoundNo Varchar(20),
@Complaint Varchar(1000),
@Etiology Varchar(1000),
@SignsAndSymptoms Varchar(1000),
@ProposedSolution Varchar(1000),
@LoginID Varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDNurseAssessment where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPDNurseAssessment2')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update IPDNurseAssessment set
Complaint = @Complaint, Etiology = @Etiology, SignsAndSymptoms = @SignsAndSymptoms, ProposedSolution = @ProposedSolution, LoginID = @LoginID
where RoundNo = @RoundNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDNurseAssessment
******************************************************************************************************/
-- select * from IPDNurseAssessment
-- delete from IPDNurseAssessment


-------------- Get IPDNurseAssessment -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDNurseAssessment')
	drop proc uspGetIPDNurseAssessment
go

create proc uspGetIPDNurseAssessment(
@RoundNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDNurseAssessment where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPDNurseAssessment')
		return 1
	end
else
begin
	select IPDNurseAssessment.RoundNo, Complaint, Etiology, SignsAndSymptoms, ProposedSolution, IPDNurseAssessment.LoginID
	from IPDNurseAssessment
	inner join Logins on IPDNurseAssessment.LoginID = Logins.LoginID
	where RoundNo = @RoundNo
return 0
end
go

--------GetIPDNurseAssessmentByRoundNo------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDNurseAssessmentByRoundNo')
	drop proc uspGetIPDNurseAssessmentByRoundNo
go

create proc uspGetIPDNurseAssessmentByRoundNo(
@RoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDNurseAssessment where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPDNurseAssessment')
		return 1
	end
else
begin
	select RecordDateTime, NurseRoundNo, RoundNo from IPDNurse
	where RoundNo = @RoundNo order by RecordDateTime, IPDNurseRoundID, NurseRoundNo
end
return 0
go


/******************************************************************************************************
exec uspGetIPDNurseAssessment
******************************************************************************************************/
-- select * from IPDNurseAssessment
-- delete from IPDNurseAssessment



------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
-------------- IPDNursingPlan --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert IPDNursingPlan -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertIPDNursingPlan')
	drop proc uspInsertIPDNursingPlan
go

create proc uspInsertIPDNursingPlan(
@RoundNo Varchar(20),
@ExpectedOutcome Varchar(1000),
@NursingActions Varchar(1000),
@Implementation Varchar(1000),
@LoginID Varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select NurseRoundNo from IPDNurse where NurseRoundNo  = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPDNurse')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into IPDNursingPlan
(RoundNo, ExpectedOutcome, NursingActions, Implementation, LoginID)
values
(@RoundNo, @ExpectedOutcome, @NursingActions, @Implementation, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertIPDNursingPlan
******************************************************************************************************/
-- select * from IPDNursingPlan
-- delete from IPDNursingPlan


-------------- Update IPDNursingPlan -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDNursingPlan')
	drop proc uspUpdateIPDNursingPlan
go

create proc uspUpdateIPDNursingPlan(
@RoundNo Varchar(20),
@ExpectedOutcome Varchar(1000),
@NursingActions Varchar(1000),
@Implementation Varchar(1000),
@LoginID Varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDNursingPlan where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPDNursingPlan')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update IPDNursingPlan set
ExpectedOutcome = @ExpectedOutcome, NursingActions = @NursingActions, Implementation = @Implementation, LoginID = @LoginID
where RoundNo = @RoundNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDNursingPlan
******************************************************************************************************/
-- select * from IPDNursingPlan
-- delete from IPDNursingPlan


-------------- Get IPDNursingPlan -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDNursingPlan')
	drop proc uspGetIPDNursingPlan
go

create proc uspGetIPDNursingPlan(
@RoundNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDNursingPlan where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPDNursingPlan')
		return 1
	end
else
begin
	select IPDNursingPlan.RoundNo, ExpectedOutcome, NursingActions, Implementation, IPDNursingPlan.LoginID
	from IPDNursingPlan
	inner join Logins on IPDNursingPlan.LoginID = Logins.LoginID
	where RoundNo = @RoundNo
return 0
end
go

/******************************************************************************************************
exec uspGetIPDNursingPlan
******************************************************************************************************/
-- select * from IPDNursingPlan
-- delete from IPDNursingPlan


------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
-------------- IPDNurseEvaluation --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit IPDNurseEvaluation -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditIPDNurseEvaluation')
	drop proc uspEditIPDNurseEvaluation
go

create proc uspEditIPDNurseEvaluation(
@RoundNo Varchar(20),
@NursingCareEffective Varchar(10),
@ProposedModifications Varchar(1000),
@EvaluationNotes Varchar(1000),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select NurseRoundNo from IPDNurse where NurseRoundNo  = @RoundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPDNurse')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @NursingCareEffective)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Nursing Care Effective', @NursingCareEffective, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select RoundNo from IPDNurseEvaluation where RoundNo = @RoundNo )
	begin
		update IPDNurseEvaluation set
		NursingCareEffective = @NursingCareEffective, ProposedModifications = @ProposedModifications, EvaluationNotes = @EvaluationNotes,
		LoginID = @LoginID
		where RoundNo = @RoundNo
		return 0
	end

if not exists(select RoundNo from IPDNurseEvaluation where RoundNo = @RoundNo )
	begin
		update IPDNurseEvaluation set
		NursingCareEffective = @NursingCareEffective, ProposedModifications = @ProposedModifications, EvaluationNotes = @EvaluationNotes,
		LoginID = @LoginID
		where RoundNo = @RoundNo
		return 0
	end
else

begin
insert into IPDNurseEvaluation
(RoundNo, NursingCareEffective, ProposedModifications, EvaluationNotes, LoginID)
values
(@RoundNo, @NursingCareEffective, @ProposedModifications, @EvaluationNotes, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertIPDNurseEvaluation
******************************************************************************************************/
-- select * from IPDNurseEvaluation
-- delete from IPDNurseEvaluation


-------------- Update IPDNurseEvaluation -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateIPDNurseEvaluation')
	drop proc uspUpdateIPDNurseEvaluation
go

create proc uspUpdateIPDNurseEvaluation(
@RoundNo Varchar(20),
@NursingCareEffective Varchar(10),
@ProposedModifications Varchar(1000),
@EvaluationNotes Varchar(1000),
@LoginID Varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDNurseEvaluation where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPDNurseEvaluation')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @NursingCareEffective)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Nursing Care Effective', @NursingCareEffective, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update IPDNurseEvaluation set
NursingCareEffective = @NursingCareEffective, ProposedModifications = @ProposedModifications, EvaluationNotes = @EvaluationNotes, LoginID = @LoginID
where RoundNo = @RoundNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateIPDNurseEvaluation
******************************************************************************************************/
-- select * from IPDNurseEvaluation
-- delete from IPDNurseEvaluation


-------------- Get IPDNurseEvaluation -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDNurseEvaluation')
	drop proc uspGetIPDNurseEvaluation
go

create proc uspGetIPDNurseEvaluation(
@RoundNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDNurseEvaluation where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPDNurseEvaluation')
		return 1
	end
else
begin
	select IPDNurseEvaluation.RoundNo, NursingCareEffective, dbo.GetLookupDataDes(NursingCareEffective) as [NursingCareEffectiveID], ProposedModifications, EvaluationNotes, IPDNurseEvaluation.LoginID
	from IPDNurseEvaluation
	inner join Logins on IPDNurseEvaluation.LoginID = Logins.LoginID	

	where RoundNo = @RoundNo
return 0
end
go

/******************************************************************************************************
exec uspGetIPDNurseEvaluation
******************************************************************************************************/
-- select * from IPDNurseEvaluation
-- delete from IPDNurseEvaluation
--------GetIPDNurseEvaluationByRoundNo------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetIPDNurseEvaluationByRoundNo')
	drop proc uspGetIPDNurseEvaluationByRoundNo
go

create proc uspGetIPDNurseEvaluationByRoundNo(
@RoundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RoundNo from IPDNurseEvaluation where RoundNo = @RoundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Round No', @RoundNo, 'IPDNurseEvaluation')
		return 1
	end
else
begin
	select RecordDateTime, NurseRoundNo, RoundNo from IPDNurse
	where RoundNo = @RoundNo order by RecordDateTime, IPDNurseRoundID, NurseRoundNo
end
return 0
go


---------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspClosePendingItems')
	drop proc uspClosePendingItems
go

create proc uspClosePendingItems(
@Updated bit= null output
)
with encryption as

begin
	declare @VisitExpireDays int
	declare @PendingStatusID varchar(10)
	declare @ClosedItemStatusID varchar(10)

	if  dbo.GetOptionValue('ClosePendingItemsAfterVisitClosed')>0
	begin
    set @VisitExpireDays =dbo.GetOptionValue('DoctorVisitUpdateDays')
	set @ClosedItemStatusID=  dbo.GetLookupDataID('ItemStatus','L')
	set @PendingStatusID=  dbo.GetLookupDataID('ItemStatus','P')

	update Items set ItemStatusID=@ClosedItemStatusID where ItemStatusID=@PendingStatusID and dbo.GetAgeInDays(LastUpDate, getdate())>@VisitExpireDays

	end
return 0
end
go
---------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspClosePendingIPDItems')
	drop proc uspClosePendingIPDItems
go

create proc uspClosePendingIPDItems(
@Updated bit= null output
)with encryption as

begin
	declare @VisitExpireDays int
	declare @PendingStatusID varchar(10)
	declare @ClosedItemStatusID varchar(10)

	if  dbo.GetOptionValue('ClosePendingItemsAfterVisitClosed')>0
	begin
    set @VisitExpireDays = dbo.GetOptionValue('DoctorVisitUpdateDays')
	set @ClosedItemStatusID=  dbo.GetLookupDataID('ItemStatus','L')
	set @PendingStatusID=  dbo.GetLookupDataID('ItemStatus','P')
	update IPDItems set ItemStatusID=@ClosedItemStatusID where ItemStatusID=@PendingStatusID and dbo.GetAgeInDays(LastUpDate, getdate())>@VisitExpireDays

	end
return 0
end
go

------------------------------------------------------------------------------------------------------
-------------- PaymentVouchers --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PaymentVouchers -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPaymentVouchers')
	drop proc uspInsertPaymentVouchers
go

create proc uspInsertPaymentVouchers(
@VoucherNo varchar(20),
@PayTypeID varchar(10),
@BillNo varchar(20),
@PayDate smallDateTime,
@PayModesID varchar(10),
@DocumentNo varchar(20),
@AmountWords varchar(200),
@Notes varchar(200),
@CurrenciesID varchar(10),
@AmountTendered Money,
@ExchangeRate money,
@Change Money,
@SendBalanceToAccount bit,
@UseAccountBalance bit,
@VoucherTypeID varchar(10),
@FilterNo varchar(20),
@PayNo varchar(20),
@Payee varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @VoucherID int
declare @CurrentYear as char(2)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedVoucherID int
declare @PassedVoucherNo varchar(20)


if exists(select VoucherNo from PaymentVouchers where VoucherNo = @VoucherNo)
	begin
		set @ErrorMSG = 'The VoucherNo with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'VoucherNo', @VoucherNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PayTypeID', @PayTypeID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayModesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PayModesID', @PayModesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CurrenciesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CurrenciesID', @CurrenciesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VoucherTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VoucherTypeID', @VoucherTypeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

---------------------------------------------------------------------------------------------------------------------

select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'PaymentVouchers' and AutoColumnName = 'VoucherNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'PaymentVouchers' and AutoColumnName = 'VoucherNo'

set @CurrentYear = right(year(getdate()),2)

if (@AutoColumnLEN = len(@VoucherNo)) and (left(@VoucherNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedVoucherID = 1
	set @PassedVoucherNo = @VoucherNo
	set @PassedVoucherNo = ltrim(rtrim(substring(@PassedVoucherNo, len(@CurrentYear) + 1, @PaddingLEN)))

	if isnumeric(@PassedVoucherNo) = 1 set @PassedVoucherID = @PassedVoucherNo
	else set @PassedVoucherID = 1

	set @VoucherID = (select max(VoucherID) from PaymentVouchers where left(VoucherNo, len(@CurrentYear)) = @CurrentYear)
	set @VoucherID = dbo.GetNextAutoNumber('PaymentVouchers', 'VoucherNo', @VoucherID)

	if @PassedVoucherID < @VoucherID set @VoucherID = @PassedVoucherID
	if @PassedVoucherID > @VoucherID set @VoucherID = @PassedVoucherID

end else set @VoucherID = 1

---------------------------------------------------------------------------------------------------------------------------------


begin
insert into PaymentVouchers
(VoucherID,VoucherNo, PayTypeID, BillNo, PayDate, PayModesID, DocumentNo, AmountWords, Notes, CurrenciesID, AmountTendered, ExchangeRate, Change, 
SendBalanceToAccount, UseAccountBalance, VoucherTypeID, FilterNo,PayNo, Payee, LoginID )
values
(@VoucherID,@VoucherNo, @PayTypeID, @BillNo, @PayDate, @PayModesID, @DocumentNo, @AmountWords, @Notes, @CurrenciesID, @AmountTendered, @ExchangeRate, @Change, 
@SendBalanceToAccount, @UseAccountBalance, @VoucherTypeID, @FilterNo,@PayNo, @Payee, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertPaymentVouchers
******************************************************************************************************/
-- select * from PaymentVouchers
-- delete from PaymentVouchers


-------------- Update PaymentVouchers -------------------------------------------------------------

-------------- Get PaymentVouchers -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPaymentVouchers')
	drop proc uspGetPaymentVouchers
go

create proc uspGetPaymentVouchers(
@VoucherNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VoucherNo from PaymentVouchers where VoucherNo = @VoucherNo)
	begin
		set @ErrorMSG = 'The VoucherNo with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VoucherNo', @VoucherNo, 'PaymentVouchers')
		return 1
	end
else
begin
	select VoucherID, VoucherNo, PayTypeID, dbo.GetLookupDataDes(PayTypeID) as [PayTypeID], BillNo, PayDate, PayModesID, dbo.GetLookupDataDes(PayModesID) as [PayModesID], DocumentNo, AmountWords, Notes, CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as [CurrenciesID], AmountTendered, ExchangeRate, Change, SendBalanceToAccount, UseAccountBalance, VoucherTypeID, dbo.GetLookupDataDes(VoucherTypeID) as [VoucherTypeID], FilterNo, Payee, PaymentVouchers.LoginID, ClientMachine, RecordDateTime
	from PaymentVouchers
	inner join Logins on PaymentVouchers.LoginID = Logins.LoginID	

	where VoucherNo = @VoucherNo
return 0
end
go

/******************************************************************************************************
exec uspGetPaymentVouchers
******************************************************************************************************/
-- select * from PaymentVouchers
-- delete from PaymentVouchers

--------GetNextVoucherID---------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextVoucherID')
	drop proc uspGetNextVoucherID
go

create proc uspGetNextVoucherID(
@VoucherID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @OptionValue varchar(10)
declare @CurrentYear as char(2)
declare @ReceiptNoPrefix varchar(12)

set @CurrentYear = right(year(getdate()), 2)
set @ReceiptNoPrefix =  @CurrentYear

set @VoucherID = (select max(VoucherID) from PaymentVouchers where left(VoucherNo, len(@ReceiptNoPrefix)) = @ReceiptNoPrefix)
set @VoucherID = dbo.GetNextAutoNumber('PaymentVouchers', 'VoucherNo', @VoucherID)

return 0

go

-- exec uspGetNextVoucherID
-- select * from PaymentVouchers

------------------------------------------------------------------------------------------------------
-------------- PaymentVoucherDetails --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PaymentVoucherDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPaymentVoucherDetails')
	drop proc uspInsertPaymentVoucherDetails
go

create proc uspInsertPaymentVoucherDetails(
@VoucherNo varchar(20),
@BillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Quantity int,
@UnitPrice money,
@Discount money,
@Amount money,
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VoucherNo from PaymentVouchers where VoucherNo  = @VoucherNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VoucherNo', @VoucherNo, 'PaymentVouchers')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ItemCategoryID', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if exists(select VoucherNo from PaymentVoucherDetails where VoucherNo = @VoucherNo and BillNo = @BillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'VoucherNo', @VoucherNo, 'BillNo', @BillNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID)
		return 1
	end



begin
insert into PaymentVoucherDetails
(VoucherNo, BillNo, ItemCode, ItemCategoryID, Quantity, UnitPrice, Discount, Amount, LoginID )
values
(@VoucherNo, @BillNo, @ItemCode, @ItemCategoryID, @Quantity, @UnitPrice, @Discount, @Amount, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertPaymentVoucherDetails
******************************************************************************************************/
-- select * from PaymentVoucherDetails
-- delete from PaymentVoucherDetails


-------------- Update PaymentVoucherDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePaymentVoucherDetails')
	drop proc uspUpdatePaymentVoucherDetails
go

create proc uspUpdatePaymentVoucherDetails(
@VoucherNo varchar(20),
@BillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Quantity int,
@UnitPrice money,
@Discount money,
@Amount money,
@LoginID Varchar(20),
@ClientMachine Varchar(41),
@RecordDateTime smallDateTime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VoucherNo from PaymentVoucherDetails where VoucherNo = @VoucherNo and BillNo = @BillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VoucherNo', @VoucherNo, 'BillNo', @BillNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'PaymentVoucherDetails')
		return 1
	end



begin
update PaymentVoucherDetails set
Quantity = @Quantity, UnitPrice = @UnitPrice, Discount = @Discount, Amount = @Amount, LoginID = @LoginID, ClientMachine = @ClientMachine, RecordDateTime = @RecordDateTime
where VoucherNo = @VoucherNo and BillNo = @BillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspUpdatePaymentVoucherDetails
******************************************************************************************************/
-- select * from PaymentVoucherDetails
-- delete from PaymentVoucherDetails


-------------- Get PaymentVoucherDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPaymentVoucherDetails')
	drop proc uspGetPaymentVoucherDetails
go

create proc uspGetPaymentVoucherDetails(
@VoucherNo varchar(20),
@BillNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VoucherNo from PaymentVoucherDetails where VoucherNo = @VoucherNo and BillNo = @BillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VoucherNo', @VoucherNo, 'BillNo', @BillNo, 'ItemCode', @ItemCode, 'ItemCategoryID', @ItemCategoryID, 'PaymentVoucherDetails')
		return 1
	end
else
begin
	select VoucherNo, BillNo, ItemCode, ItemCategoryID, Quantity, UnitPrice, Discount, Amount, LoginID, ClientMachine, RecordDateTime
	from PaymentVoucherDetails

	where VoucherNo = @VoucherNo and BillNo = @BillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
return 0
end
go

/******************************************************************************************************
exec uspGetPaymentVoucherDetails
******************************************************************************************************/
-- select * from PaymentVoucherDetails
-- delete from PaymentVoucherDetails


------------------------------------------------------------------------------------------------------
-------------- ServiceInvoices ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ServiceInvoices -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertServiceInvoices')
	drop proc uspInsertServiceInvoices
go

create proc uspInsertServiceInvoices(
@ServiceInvoiceNo varchar(20),
@InvoiceDate smalldatetime,
@DocumentNo varchar(20),
@SupplierNo varchar(20),
@ShipAddress varchar(300),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ServiceInvoiceID int
declare @CurrentYear as char(2)

declare @AutoColumnLEN tinyint
declare @PaddingLEN tinyint

declare @PassedServiceInvoiceID int
declare @PassedServiceInvoiceNo varchar(20)

if exists(select ServiceInvoiceNo from ServiceInvoices where ServiceInvoiceNo = @ServiceInvoiceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Purchase Order No', @ServiceInvoiceNo)
		return 1
	end

if not exists(select SupplierNo from Suppliers where SupplierNo  = @SupplierNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Supplier No', @SupplierNo, 'Suppliers')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin

---------------------------------------------------------------------------------------------------------------------
select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'ServiceInvoices' and AutoColumnName = 'ServiceInvoiceNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'ServiceInvoices' and AutoColumnName = 'ServiceInvoiceNo'

set @CurrentYear = right(year(getdate()),2)

if (@AutoColumnLEN = len(@ServiceInvoiceNo)) and (left(@ServiceInvoiceNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedServiceInvoiceID = 1
	set @PassedServiceInvoiceNo = @ServiceInvoiceNo
	set @PassedServiceInvoiceNo = ltrim(rtrim(substring(@PassedServiceInvoiceNo, len(@CurrentYear) + 1, @PaddingLEN)))

	if isnumeric(@PassedServiceInvoiceNo) = 1 set @PassedServiceInvoiceID = @PassedServiceInvoiceNo
	else set @PassedServiceInvoiceID = 1

	set @ServiceInvoiceID = (select max(ServiceInvoiceID) from ServiceInvoices where left(ServiceInvoiceNo, len(@CurrentYear)) = @CurrentYear)
	set @ServiceInvoiceID = dbo.GetNextAutoNumber('ServiceInvoices', 'ServiceInvoiceNo', @ServiceInvoiceID)

	if @PassedServiceInvoiceID < @ServiceInvoiceID set @ServiceInvoiceID = @PassedServiceInvoiceID
	if @PassedServiceInvoiceID > @ServiceInvoiceID set @ServiceInvoiceID = @PassedServiceInvoiceID

end else set @ServiceInvoiceID = 1

---------------------------------------------------------------------------------------------------------------------------

insert into ServiceInvoices
(ServiceInvoiceID, ServiceInvoiceNo, InvoiceDate, DocumentNo, SupplierNo, ShipAddress, LoginID, ClientMachine)
values
(@ServiceInvoiceID, @ServiceInvoiceNo, @InvoiceDate, @DocumentNo, @SupplierNo, @ShipAddress, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertServiceInvoices

******************************************************************************************************/
-- select * from ServiceInvoices
-- delete from ServiceInvoices

-------------- Update ServiceInvoices -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateServiceInvoices')
	drop proc uspUpdateServiceInvoices
go

create proc uspUpdateServiceInvoices(
@ServiceInvoiceNo varchar(20),
@InvoiceDate smalldatetime,
@DocumentNo varchar(20),
@SupplierNo varchar(20),
@ShipAddress varchar(300),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ServiceInvoiceNo from ServiceInvoices where ServiceInvoiceNo = @ServiceInvoiceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Purchase Order No', @ServiceInvoiceNo, 'ServiceInvoices')
		return 1
	end

--if (dbo.GetIsPurchaseOrderReceived(@ServiceInvoiceNo) = 1) 
--	begin
--		set @ErrorMSG = '%s: %s, is already received. You can''t update such an order!'
--		raiserror(@ErrorMSG, 16, 1, 'Purchase Order No', @ServiceInvoiceNo)
--		return 1
--	end

if not exists(select SupplierNo from Suppliers where SupplierNo  = @SupplierNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Supplier No', @SupplierNo, 'Suppliers')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update ServiceInvoices set
InvoiceDate = @InvoiceDate, DocumentNo = @DocumentNo, SupplierNo = @SupplierNo, 
ShipAddress = @ShipAddress, LoginID = @LoginID, ClientMachine = @ClientMachine
where ServiceInvoiceNo = @ServiceInvoiceNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateServiceInvoices
******************************************************************************************************/
-- select * from ServiceInvoices
-- delete from ServiceInvoices

--------GetServiceInvoicesNotPaidFor----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetServiceInvoicesNotPaidFor')
	drop proc uspGetServiceInvoicesNotPaidFor
go

create proc uspGetServiceInvoicesNotPaidFor(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

declare @NotPaidID varchar(10)
declare @PaidID varchar(10)
declare @CashBillModesID varchar(10)

set @NotPaidID =  dbo.GetLookupDataID('PayStatus', 'NP')
set @PaidID =  dbo.GetLookupDataID('PayStatus', 'PF')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')

	begin
		select ServiceInvoiceNo, DocumentNo, dbo.FormatDate(RecordDateTime) as OrderDate, 
		 dbo.GetSupplierName(SupplierNo) as SupplierName, 
		dbo.FormatMoney(dbo.GetServiceInvoicesAmount(ServiceInvoiceNo)) as OrderAmount,
		dbo.FormatMoney(dbo.GetServiceInvoicePayAmount(ServiceInvoiceNo,@NotPaidID)) as NotPaidAmount,
		dbo.FormatMoney(dbo.GetServiceInvoicePayAmount(ServiceInvoiceNo,@PaidID)) as PaidAmount,	
		dbo.FormatDate(RecordDateTime) as RecordDate,
		dbo.GetTime(RecordDateTime) as RecordTime,
		dbo.FormatMoney(dbo.GetAccountBalance(@CashBillModesID, SupplierNo)) as AccountBalance
		from ServiceInvoices
          where InvoiceDate between @StartDate and @EndDate
		and dbo.GetServiceInvoicePayAmount(ServiceInvoiceNo,@NotPaidID) > 0
		order by RecordDateTime desc, ServiceInvoiceNo desc
	end
return 0
go

-- select * from ServiceInvoices
-- exec uspGetServiceInvoicesNotPaidFor 'May 12, 2015', 'May 13, 2019'



-------------- Get Not Paid ServiceInvoiceDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNotPaidServiceInvoiceDetails')
	drop proc uspGetNotPaidServiceInvoiceDetails
go

create proc uspGetNotPaidServiceInvoiceDetails(
@ServiceInvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @NotPaidPayStatus varchar(10)
set @NotPaidPayStatus = dbo.GetLookupDataID('PayStatus', 'NP')


begin
	select dbo.FormatDate(InvoiceDate) as ReceivedDate, ServiceInvoiceDetails.ServiceInvoiceNo, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	ItemCode, ItemName, dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName, UnitMeasure,Quantity,
	 Rate,PackID, dbo.GetLookupDataDes(PackID) as Pack, PackSize, VATValue,Amount,'0.00' as Discount,
	 Notes,
	dbo.GetTotalReturnedItemQuantity(ServiceInvoices.ServiceInvoiceNo,ItemCode) as ReturnQuantity	
	from ServiceInvoiceDetails
	inner join ServiceInvoices on ServiceInvoiceDetails.ServiceInvoiceNo = ServiceInvoices.ServiceInvoiceNo
	where ServiceInvoiceDetails.ServiceInvoiceNo = @ServiceInvoiceNo and PayStatusID =@NotPaidPayStatus
end

return 0
go

-- exec uspGetNotPaidServiceInvoiceDetails '170002'
--select * from ServiceInvoices
--select * from ServiceInvoiceDetails






-------------- Get ServiceInvoices -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetServiceInvoices')
	drop proc uspGetServiceInvoices
go

create proc uspGetServiceInvoices(
@ServiceInvoiceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @NotPaidID varchar(10)
declare @PaidID varchar(10)

set @NotPaidID =  dbo.GetLookupDataID('PayStatus', 'NP')
set @PaidID =  dbo.GetLookupDataID('PayStatus', 'PF')


if not exists(select ServiceInvoiceNo from ServiceInvoices where ServiceInvoiceNo = @ServiceInvoiceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Purchase Order No', @ServiceInvoiceNo, 'ServiceInvoices')
		return 1
	end
else
begin
	select ServiceInvoiceNo, InvoiceDate as ReceivedDate, DocumentNo, SupplierNo, dbo.GetSupplierName(SupplierNo) as SupplierName, 
	dbo.GetSupplierFullName(SupplierNo) as SupplierFullName, ShipAddress,
	dbo.FormatMoney(dbo.GetServiceInvoicesAmount(ServiceInvoiceNo)) as OrderAmount,
		dbo.FormatMoney(dbo.GetServiceInvoicePayAmount(ServiceInvoiceNo,@NotPaidID)) as NotPaidAmount,
		dbo.FormatMoney(dbo.GetServiceInvoicePayAmount(ServiceInvoiceNo,@PaidID)) as PaidAmount,
    dbo.FormatMoney(dbo.GetCashAccountBalance(supplierNo)) as CashAccountBalance,
	dbo.FormatMoney(dbo.GetOutstandingBalance(supplierNo)) as OutstandingBalance
	from ServiceInvoices
	where ServiceInvoiceNo = @ServiceInvoiceNo
return 0
end
go

/******************************************************************************************************
exec uspGetServiceInvoices
******************************************************************************************************/
-- select * from ServiceInvoices
-- delete from ServiceInvoices




--------GetNextServiceInvoiceID---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextServiceInvoiceID')
	drop proc uspGetNextServiceInvoiceID
go

create proc uspGetNextServiceInvoiceID(
@ServiceInvoiceID int = null output
)with encryption as

declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @ServiceInvoiceID = (select max(ServiceInvoiceID) from ServiceInvoices where left(ServiceInvoiceNo, 2) = @CurrentYear)
set @ServiceInvoiceID = dbo.GetNextAutoNumber('ServiceInvoices', 'ServiceInvoiceNo', @ServiceInvoiceID)

return 0

go

-- exec uspGetNextServiceInvoiceID
-- select * from ServiceInvoices


----------GetPeriodicServiceInvoices----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicServiceInvoices')
	drop proc uspGetPeriodicServiceInvoices
go

create proc uspGetPeriodicServiceInvoices(
@StartDate smalldatetime,
@EndDate smalldatetime,
@IncludeReceived bit = 1
)with encryption as

if (@IncludeReceived = 0)
	begin
		select ServiceInvoiceNo, dbo.FormatDate(InvoiceDate) as InvoiceDate,
		DocumentNo, dbo.GetSupplierName(SupplierNo) as SupplierName, 
		dbo.FormatMoney(dbo.GetServiceInvoiceAmount(ServiceInvoiceNo)) as OrderAmount,	
		--dbo.GetIsPurchaseOrderReceived(ServiceInvoiceNo) as IsPurchaseOrderReceived,	
		dbo.FormatDate(ServiceInvoices.RecordDateTime) as RecordDate,
		dbo.GetTime(ServiceInvoices.RecordDateTime) as RecordTime
		from ServiceInvoices
		where InvoiceDate between @StartDate and @EndDate 
		--and (dbo.GetIsPurchaseOrderReceived(ServiceInvoiceNo) = @IncludeReceived)
		order by InvoiceDate desc, ServiceInvoiceNo desc
	end
else
	begin
		select ServiceInvoiceNo, dbo.FormatDate(InvoiceDate) as InvoiceDate, 
		DocumentNo, dbo.GetSupplierName(SupplierNo) as SupplierName, 
		dbo.FormatMoney(dbo.GetServiceInvoiceAmount(ServiceInvoiceNo)) as OrderAmount,	
		--dbo.GetIsPurchaseOrderReceived(ServiceInvoiceNo) as IsPurchaseOrderReceived,		
		dbo.FormatDate(ServiceInvoices.RecordDateTime) as RecordDate,
		dbo.GetTime(ServiceInvoices.RecordDateTime) as RecordTime
		from ServiceInvoices
		where InvoiceDate between @StartDate and @EndDate
		order by InvoiceDate desc, ServiceInvoiceNo desc
	end
return 0
go

 --select * from ServiceInvoices
 --exec uspGetPeriodicServiceInvoices 'DEC 01, 2017', 'DEC 31, 2017'
 --exec uspGetPeriodicServiceInvoices 'May 12, 2015', 'May 13, 2015', 0







------------------------------------------------------------------------------------------------------
-------------- ServiceInvoiceDetails ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ServiceInvoiceDetails -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditServiceInvoiceDetails')
	drop proc uspEditServiceInvoiceDetails
go

create proc uspEditServiceInvoiceDetails(
@ServiceInvoiceNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@ItemName varchar(800),
@UnitMeasure varchar(100),
@ItemGroup varchar(100),
@Quantity int,
@Rate money,
@PackID varchar(10),
@PackSize int,
@VATValue money,
@Amount money,
@Notes varchar(200),
@PayStatusID varchar(10),
@LoginID varchar(20),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

declare @DrugID varchar(10)
declare @ConsumableID varchar(10)

set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')

----------------------------------------------------------------------------------------------------------------------

if (@ItemCategoryID = @DrugID) and 
	(not exists(select DrugNo from Drugs where DrugNo = @ItemCode)) -- Drugs
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Drug No', @ItemCode, 'Drugs')	
			return 1
		end
	
else if (@ItemCategoryID = @ConsumableID) and 
	(not exists(select ConsumableNo from ConsumableItems where ConsumableNo  = @ItemCode)) -- Consumable Items
		begin
			set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Consumable No', @ItemCode, 'Consumable Items')	
			return 1
		end
		
----------------------------------------------------------------------------------------------------------------------

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Stock Status ID', @PayStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PayStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Stock Status ID', @PayStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select ServiceInvoiceNo from ServiceInvoiceDetails 
		where ServiceInvoiceNo = @ServiceInvoiceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		---------------------------------------------------------------------------------------------------------
		update ServiceInvoiceDetails set ItemName = @ItemName, UnitMeasure = @UnitMeasure, 
		ItemGroup = @ItemGroup, Quantity = @Quantity, Rate = @Rate, PackID=@PackID, PackSize=@PackSize, Amount = @Amount,VATValue=@VATValue, Notes = @Notes, 
		PayStatusID = @PayStatusID, LoginID = @LoginID, ClientMachine = @ClientMachine
		where ServiceInvoiceNo = @ServiceInvoiceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
		return 0
		---------------------------------------------------------------------------------------------------------
	end
else
begin
insert into ServiceInvoiceDetails
(ServiceInvoiceNo, ItemCategoryID, ItemCode, ItemName, UnitMeasure, ItemGroup, 
Quantity, Rate,PackID, PackSize, Amount,VATValue,Notes, PayStatusID, LoginID, ClientMachine)
values
(@ServiceInvoiceNo, @ItemCategoryID, @ItemCode, @ItemName, @UnitMeasure, @ItemGroup, 
@Quantity, @Rate, @PackID, @PackSize,@Amount,@VATValue, @Notes, @PayStatusID, @LoginID, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspEditServiceInvoiceDetails
******************************************************************************************************/
-- select * from ServiceInvoiceDetails
-- delete from ServiceInvoiceDetails

-------------- Get ServiceInvoiceDetails -------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetServiceInvoiceDetails')
	drop proc uspGetServiceInvoiceDetails
go

create proc uspGetServiceInvoiceDetails(
@ServiceInvoiceNo varchar(20),
@ItemCategoryID varchar(10) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (@ItemCategoryID is null or @ItemCategoryID = '') 
begin
	select ServiceInvoiceDetails.ServiceInvoiceNo, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	ItemCode, ItemName, dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName, UnitMeasure, ItemGroup,Notes, 
	Quantity, Rate, PackID, dbo.GetLookUpDataDes(PackID) as Pack, PackSize, 
	dbo.GetTotalProvided(ServiceInvoiceDetails.ServiceInvoiceNo, ItemCategoryID,ItemCode) as TotalOrdered,
	dbo.GetVATPercentage(ItemCategoryID,ItemCode) as VATPercentage, 
	((Quantity*Rate*dbo.GetVATPercentage(ItemCategoryID,ItemCode))/100) as VATValue, Amount, Notes, 
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus 
	from ServiceInvoiceDetails
	inner join ServiceInvoices on ServiceInvoiceDetails.ServiceInvoiceNo = ServiceInvoices.ServiceInvoiceNo
	where ServiceInvoiceDetails.ServiceInvoiceNo = @ServiceInvoiceNo
end
else
begin
	select ServiceInvoiceDetails.ServiceInvoiceNo, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, 
	ItemCode, ItemName, dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName, UnitMeasure, ItemGroup,Notes, 
	Quantity, Rate, PackID,dbo.GetLookUpDataDes(PackID) as Pack, PackSize,
	dbo.GetTotalProvided(ServiceInvoiceDetails.ServiceInvoiceNo, ItemCategoryID,ItemCode) as TotalOrdered,
	dbo.GetVATPercentage(ItemCategoryID,ItemCode) as VATPercentage, 
	((Quantity*Rate*dbo.GetVATPercentage(ItemCategoryID,ItemCode))/100) as VATValue, Amount, Notes, 
	PayStatusID, dbo.GetLookupDataDes(PayStatusID) as PayStatus 
	from ServiceInvoiceDetails
	inner join ServiceInvoices on ServiceInvoiceDetails.ServiceInvoiceNo = ServiceInvoices.ServiceInvoiceNo
	where ServiceInvoiceDetails.ServiceInvoiceNo = @ServiceInvoiceNo and ItemCategoryID = @ItemCategoryID
end	
return 0
go

/******************************************************************************************************
exec uspGetServiceInvoiceDetails '170001'
exec uspGetServiceInvoiceDetails '170001', '7NM'
******************************************************************************************************/

-----------------Update Paid ServiceInvoice Details--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePaidServiceInvoiceDetails')
	drop proc uspUpdatePaidServiceInvoiceDetails
go

create proc uspUpdatePaidServiceInvoiceDetails(
@ServiceInvoiceNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@PaystatusID varchar(10)
)with encryption as 

declare @ErrorMSG varchar(200)

if exists(select ServiceInvoiceNo from ServiceInvoiceDetails 
		where ServiceInvoiceNo = @ServiceInvoiceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	begin
		---------------------------------------------------------------------------------------------------------
		update ServiceInvoiceDetails set PaystatusID= @PaystatusID
		where ServiceInvoiceNo = @ServiceInvoiceNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
		return 0
		---------------------------------------------------------------------------------------------------------
	end

return 0
go

----------------------------------------------------------------------------------------------------------
----------------------------01 FEB 2018-----------------------------------------------------------
------------------------------------------------------------------------------------------------------
-------------- PostNatal --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- insert PostNatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPostNatal')
	drop proc uspInsertPostNatal
go

create proc uspInsertPostNatal(
@PatientNo varchar(20),
@DeliveryComplications varchar(10),
@ConditionOnBirth varchar(10),
@ConditionDetails varchar(100),
@PhysicalAbnormalityDetails varchar(100),
@UmblicalCordDetails varchar(100),
@Jaundice varchar(10),
@EarlyInfection varchar(10),
@InfectionDetails varchar(100),
@Convulsions varchar(10),
@ConvulsionsDetails varchar(100),
@EIDResults varchar(10),
@ApgarScore int,
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Patients')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DeliveryComplications)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Delivery Complications', @DeliveryComplications, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ConditionOnBirth)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ConditionOnBirth', @ConditionOnBirth, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Jaundice)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Jaundice', @Jaundice, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EarlyInfection)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'EarlyInfection', @EarlyInfection, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Convulsions)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Convulsions', @Convulsions, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EIDResults)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'EIDResults', @EIDResults, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

--if exists(select PatientNo from PostNatal where PatientNo  = @PatientNo)
--begin
--	update PostNatal set 		
--	DeliveryComplications = @DeliveryComplications, ConditionOnBirth = @ConditionOnBirth, ConditionDetails = @ConditionDetails,PhysicalAbnormalityDetails=@PhysicalAbnormalityDetails, Jaundice=@Jaundice, EarlyInfection =@EarlyInfection, InfectionDetails=@InfectionDetails, Convulsions =@Convulsions, ConvulsionsDetails=@ConvulsionsDetails, EIDResults=@EIDResults, ApgarScore =@ApgarScore, Notes= @Notes,
--	LoginID = @LoginID
--	where PatientNo = @PatientNo
--	return 0
--end
--else
--if exists(select PatientNo from PostNatal where PatientNo  = @PatientNo)
begin
insert into PostNatal
(PatientNo, DeliveryComplications, ConditionOnBirth, ConditionDetails, PhysicalAbnormalityDetails, UmblicalCordDetails, Jaundice, EarlyInfection, InfectionDetails, Convulsions, ConvulsionsDetails, EIDResults, ApgarScore, Notes, LoginID)
values
(@PatientNo, @DeliveryComplications, @ConditionOnBirth, @ConditionDetails, @PhysicalAbnormalityDetails, @UmblicalCordDetails, @Jaundice, @EarlyInfection, @InfectionDetails, @Convulsions, @ConvulsionsDetails, @EIDResults, @ApgarScore, @Notes, @LoginID)
return 0
end
go


/******************************************************************************************************
exec uspInsertPostNatal
******************************************************************************************************/
-- select * from PostNatal
-- delete from PostNatal


------------ Update PostNatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePostNatal')
	drop proc uspUpdatePostNatal
go

create proc uspUpdatePostNatal(
@PatientNo varchar(20),
@DeliveryComplications varchar(10),
@ConditionOnBirth varchar(10),
@ConditionDetails varchar(100),
@PhysicalAbnormalityDetails varchar(100),
@UmblicalCordDetails varchar(100),
@Jaundice varchar(10),
@EarlyInfection varchar(10),
@InfectionDetails varchar(100),
@Convulsions varchar(10),
@ConvulsionsDetails varchar(100),
@EIDResults varchar(10),
@ApgarScore int,
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from PostNatal where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'PostNatal')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @DeliveryComplications)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Delivery Complications', @DeliveryComplications, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ConditionOnBirth)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ConditionOnBirth', @ConditionOnBirth, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Jaundice)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Jaundice', @Jaundice, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EarlyInfection)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'EarlyInfection', @EarlyInfection, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Convulsions)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Convulsions', @Convulsions, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @EIDResults)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'EIDResults', @EIDResults, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end
begin
update PostNatal set
DeliveryComplications = @DeliveryComplications, ConditionOnBirth = @ConditionOnBirth, ConditionDetails = @ConditionDetails, PhysicalAbnormalityDetails = @PhysicalAbnormalityDetails, UmblicalCordDetails = @UmblicalCordDetails, Jaundice = @Jaundice, EarlyInfection = @EarlyInfection, InfectionDetails = @InfectionDetails, Convulsions = @Convulsions, ConvulsionsDetails = @ConvulsionsDetails, EIDResults = @EIDResults, ApgarScore = @ApgarScore, Notes = @Notes, LoginID = @LoginID
where PatientNo = @PatientNo
return 0
end
go


/******************************************************************************************************
exec uspUpdatePostNatal
******************************************************************************************************/
-- select * from PostNatal
-- delete from PostNatal


-------------- Get PostNatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPostNatal')
	drop proc uspGetPostNatal
go

create proc uspGetPostNatal(
@PatientNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select PatientNo, DeliveryComplications, dbo.GetLookupDataDes(DeliveryComplications) as [DeliveryComplicationsID], ConditionOnBirth, dbo.GetLookupDataDes(ConditionOnBirth) as [ConditionOnBirthID], ConditionDetails, PhysicalAbnormalityDetails, UmblicalCordDetails, Jaundice, dbo.GetLookupDataDes(Jaundice) as [JaundiceID], EarlyInfection, dbo.GetLookupDataDes(EarlyInfection) as [EarlyInfectionID], InfectionDetails, Convulsions, dbo.GetLookupDataDes(Convulsions) as [ConvulsionsID], ConvulsionsDetails, EIDResults, dbo.GetLookupDataDes(EIDResults) as [EIDResultsID], ApgarScore, Notes, PostNatal.LoginID
	from PostNatal
	inner join Logins on PostNatal.LoginID = Logins.LoginID
	where PatientNo = @PatientNo

end
return 0
go

	
--return 0
--end
--go

/******************************************************************************************************
exec uspGetPostNatal
******************************************************************************************************/
-- select * from PostNatal
-- delete from PostNatal

-------------- Antenatal --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Antenatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAntenatal')
	drop proc uspInsertAntenatal
go

create proc uspInsertAntenatal(
@VisitNo Varchar(20),
@Infection Varchar(10),
@InfectionDetails Varchar(100),
@AccidentDuringPregnancy Varchar(10),
@DetailsOfAccident Varchar(100),
@UseOfDrugsOrPrescription Varchar(10),
@DrugDetails Varchar(100),
@Smoking Varchar(10),
@ChronicIllness varchar(10),
@DetailsOfIllness varchar(100),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Infection)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Infection', @Infection, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AccidentDuringPregnancy)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Accident During Pregnancy', @AccidentDuringPregnancy, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @UseOfDrugsOrPrescription)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Use Of Drugs Or Prescription', @UseOfDrugsOrPrescription, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Smoking)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Smoking', @Smoking, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ChronicIllness)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Chronic Illness', @ChronicIllness, 'LookupData')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into Antenatal
(VisitNo, Infection, InfectionDetails, AccidentDuringPregnancy, DetailsOfAccident, UseOfDrugsOrPrescription, DrugDetails, Smoking, ChronicIllness, DetailsOfIllness, LoginID)
values
(@VisitNo, @Infection, @InfectionDetails, @AccidentDuringPregnancy, @DetailsOfAccident, @UseOfDrugsOrPrescription, @DrugDetails, @Smoking, @ChronicIllness, @DetailsOfIllness, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertAntenatal
******************************************************************************************************/
-- select * from Antenatal
-- delete from Antenatal


-------------- Update Antenatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateAntenatal')
	drop proc uspUpdateAntenatal
go

create proc uspUpdateAntenatal(
@VisitNo Varchar(20),
@Infection Varchar(10),
@InfectionDetails Varchar(100),
@AccidentDuringPregnancy Varchar(10),
@DetailsOfAccident Varchar(100),
@UseOfDrugsOrPrescription Varchar(10),
@DrugDetails Varchar(100),
@Smoking Varchar(10),
@ChronicIllness varchar(10),
@DetailsOfIllness varchar(100),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select VisitNo from Antenatal where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @VisitNo, 'Antenatal')
		return 1
	end
	
if not exists(select DataID from LookupData where DataID = @Infection)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Infection', @Infection, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AccidentDuringPregnancy)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Accident During Pregnancy', @AccidentDuringPregnancy, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @UseOfDrugsOrPrescription)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Use Of Drugs Or Prescription', @UseOfDrugsOrPrescription, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Smoking)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Smoking', @Smoking, 'LookupData')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ChronicIllness)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Chronic Illness', @ChronicIllness, 'LookupData')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update Antenatal set
VisitNo = @VisitNo, Infection = @Infection, InfectionDetails = @InfectionDetails, AccidentDuringPregnancy = @AccidentDuringPregnancy, DetailsOfAccident = @DetailsOfAccident, UseOfDrugsOrPrescription = @UseOfDrugsOrPrescription, DrugDetails = @DrugDetails, Smoking = @Smoking, ChronicIllness = @ChronicIllness, DetailsOfIllness = @DetailsOfIllness, LoginID = @LoginID

return 0
end
go

/******************************************************************************************************
exec uspUpdateAntenatal
******************************************************************************************************/
-- select * from Antenatal
-- delete from Antenatal


-------------- Get Antenatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAntenatal')
	drop proc uspGetAntenatal
go

create proc uspGetAntenatal(
@VisitNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select Antenatal.VisitNo, Infection, dbo.GetLookupDataDes(Infection) as [InfectionID], InfectionDetails, AccidentDuringPregnancy, dbo.GetLookupDataDes(AccidentDuringPregnancy) as [AccidentDuringPregnancyID], DetailsOfAccident, UseOfDrugsOrPrescription, dbo.GetLookupDataDes(UseOfDrugsOrPrescription) as [UseOfDrugsOrPrescriptionID], DrugDetails, Smoking, dbo.GetLookupDataDes(Smoking) as [SmokingID], ChronicIllness, dbo.GetLookupDataDes(ChronicIllness) as [ChronicIllnessID], DetailsOfIllness, Antenatal.LoginID
	from Antenatal
	where VisitNo = @VisitNo
	
	
return 0
end
go

/******************************************************************************************************
exec uspGetAntenatal '170003'
******************************************************************************************************/
-- select * from Antenatal
-- delete from Antenatal

------------------------------------------------------------------------------------------------------
-------------- Perinatal --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Perinatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPerinatal')
	drop proc uspInsertPerinatal
go

create proc uspInsertPerinatal(
@VisitNo Varchar(20),
@ModeOfDelivery Varchar(10),
@DurationOfLabour Decimal,
@DeliveryComplications Varchar(10),
@AmountOfBloodLoss Decimal,
@MothersCondition Varchar(10),
@DetailsOfCondition Varchar(100),
@BabyAlive Varchar(10),
@CauseOfDeath Varchar(10),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ModeOfDelivery)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Mode Of Delivery', @ModeOfDelivery, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DeliveryComplications)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Delivery Complications', @DeliveryComplications, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @MothersCondition)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Mothers Condition', @MothersCondition, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BabyAlive)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Baby Alive', @BabyAlive, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CauseOfDeath)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CauseOfDeath', @CauseOfDeath, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into Perinatal
(VisitNo, ModeOfDelivery, DurationOfLabour, DeliveryComplications, AmountOfBloodLoss, MothersCondition, DetailsOfCondition, BabyAlive, CauseOfDeath, LoginID)
values
(@VisitNo, @ModeOfDelivery, @DurationOfLabour, @DeliveryComplications, @AmountOfBloodLoss, @MothersCondition, @DetailsOfCondition, @BabyAlive, @CauseOfDeath, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertPerinatal
******************************************************************************************************/
-- select * from Perinatal
-- delete from Perinatal


-------------- Update Perinatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePerinatal')
	drop proc uspUpdatePerinatal
go

create proc uspUpdatePerinatal(
@VisitNo Varchar(20),
@ModeOfDelivery Varchar(10),
@DurationOfLabour Decimal,
@DeliveryComplications Varchar(10),
@AmountOfBloodLoss Decimal,
@MothersCondition Varchar(10),
@DetailsOfCondition Varchar(100),
@BabyAlive Varchar(10),
@CauseOfDeath Varchar(10),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select VisitNo from Perinatal where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ModeOfDelivery)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Mode Of Delivery', @ModeOfDelivery, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DeliveryComplications)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Delivery Complications', @DeliveryComplications, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @MothersCondition)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Mothers Condition', @MothersCondition, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BabyAlive)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Baby Alive', @BabyAlive, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CauseOfDeath)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'CauseOfDeath', @CauseOfDeath, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update Perinatal set
VisitNo = @VisitNo, ModeOfDelivery = @ModeOfDelivery, DurationOfLabour = @DurationOfLabour, DeliveryComplications = @DeliveryComplications, AmountOfBloodLoss = @AmountOfBloodLoss, MothersCondition = @MothersCondition, DetailsOfCondition = @DetailsOfCondition, BabyAlive = @BabyAlive, CauseOfDeath = @CauseOfDeath, LoginID = @LoginID

return 0
end
go


/******************************************************************************************************
exec uspUpdatePerinatal
******************************************************************************************************/
-- select * from Perinatal
-- delete from Perinatal


-------------- Get Perinatal -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPerinatal')
	drop proc uspGetPerinatal
go

create proc uspGetPerinatal(
@VisitNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


begin
	select Perinatal.VisitNo, ModeOfDelivery, dbo.GetLookupDataDes(ModeOfDelivery) as [ModeOfDeliveryID],
	 DurationOfLabour, DeliveryComplications, dbo.GetLookupDataDes(DeliveryComplications) as [DeliveryComplicationsID],
	  AmountOfBloodLoss, MothersCondition, dbo.GetLookupDataDes(MothersCondition) as [MothersConditionID], DetailsOfCondition,
	  BabyAlive, dbo.GetLookupDataDes(BabyAlive) as [BabyAliveID], CauseOfDeath, dbo.GetLookupDataDes(CauseOfDeath) as [CauseOfDeathID],
	  Perinatal.LoginID
	from Perinatal
	where VisitNo= @VisitNo

	
return 0
end
go

------------------------------------------------------------------------------------------------------
-------------- ObstetricHistory --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ObstetricHistory -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertObstetricHistory')
	drop proc uspInsertObstetricHistory
go

create proc uspInsertObstetricHistory(
@PatientNo Varchar(20) ,
@Gravidity int,
@Parity int,
@NoOfSurvivingChildren int,
@LMP SmallDateTime,
@EDD SmallDateTime,
@GestationalAgeInWks int,
@StillBirth Varchar(10),
@NoOfStillBirths int,
@Abortions Varchar(10),
@NoOfAbortions int,
@Caesarian Varchar(10),
@NoOfCaesarians int,
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
if not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Patients')
		return 1
	end


if not exists(select DataID from LookupData where DataID = @StillBirth)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Still Birth', @StillBirth, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Abortions)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Abortions', @Abortions, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Caesarian)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Caesarian', @Caesarian, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into ObstetricHistory
(PatientNo, Gravidity, Parity, NoOfSurvivingChildren, LMP, EDD, GestationalAgeInWks, StillBirth, NoOfStillBirths, Abortions, NoOfAbortions, Caesarian, NoOfCaesarians, LoginID)
values
(@PatientNo, @Gravidity, @Parity, @NoOfSurvivingChildren, @LMP, @EDD, @GestationalAgeInWks, @StillBirth, @NoOfStillBirths, @Abortions, @NoOfAbortions, @Caesarian, @NoOfCaesarians, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertObstetricHistory
******************************************************************************************************/
-- select * from ObstetricHistory
-- delete from ObstetricHistory


-------------- Update ObstetricHistory -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateObstetricHistory')
	drop proc uspUpdateObstetricHistory
go

create proc uspUpdateObstetricHistory(
@PatientNo Varchar(20),
@Gravidity int,
@Parity int,
@NoOfSurvivingChildren int,
@LMP SmallDateTime,
@EDD SmallDateTime,
@GestationalAgeInWks int,
@StillBirth Varchar(10),
@NoOfStillBirths int,
@Abortions Varchar(10),
@NoOfAbortions int,
@Caesarian Varchar(10),
@NoOfCaesarians int,
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
if not exists(select PatientNo from ObstetricHistory where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'ObstetricHistory')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @StillBirth)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Still Birth', @StillBirth, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Abortions)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Abortions', @Abortions, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Caesarian)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Caesarian', @Caesarian, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update ObstetricHistory set
	Gravidity = @Gravidity, Parity = @Parity, NoOfSurvivingChildren = @NoOfSurvivingChildren, LMP = @LMP, EDD = @EDD, GestationalAgeInWks = @GestationalAgeInWks, StillBirth = @StillBirth, NoOfStillBirths = @NoOfStillBirths, Abortions = @Abortions, NoOfAbortions = @NoOfAbortions, Caesarian = @Caesarian, NoOfCaesarians = @NoOfCaesarians, LoginID = @LoginID
	where PatientNo = @PatientNo
		
return 0
end
go
/******************************************************************************************************
exec uspUpdateObstetricHistory
******************************************************************************************************/
-- select * from ObstetricHistory
-- delete from ObstetricHistory


-------------- Get ObstetricHistory -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetObstetricHistory')
	drop proc uspGetObstetricHistory
go

create proc uspGetObstetricHistory(
	@PatientNo Varchar(20)
)with encryption as
	
declare @ErrorMSG varchar(200)

begin
	select ObstetricHistory.PatientNo, Gravidity, Parity, NoOfSurvivingChildren, LMP, EDD, GestationalAgeInWks, StillBirth, dbo.GetLookupDataDes(StillBirth) as [StillBirthID], NoOfStillBirths, Abortions, dbo.GetLookupDataDes(Abortions) as [AbortionsID], NoOfAbortions, Caesarian, dbo.GetLookupDataDes(Caesarian) as [CaesarianID], NoOfCaesarians
	from ObstetricHistory
	inner join Logins on ObstetricHistory.LoginID = Logins.LoginID
	where PatientNo= @PatientNo

	
return 0
end
go

/******************************************************************************************************
exec uspGetObstetricHistory
******************************************************************************************************/
-- select * from ObstetricHistory
-- delete from ObstetricHistory

------------------------------------------------------------------------------------------------------
-------------- ImmunisationVaccines --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ImmunisationVaccines -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertImmunisationVaccines')
	drop proc uspInsertImmunisationVaccines
go

create proc uspInsertImmunisationVaccines(
@ImmunisationNo varchar(20),
@PatientNo Varchar(20),
@VaccineName Varchar(10),
@VaccineReceived varchar(10),
@DateGiven smalldatetime,
@PlaceReceived varchar(10),
@MothersName varchar(10),
@UpToDate bit,
@Notes varchar(100),
@LoginID Varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)
declare @ImmunisationID int
declare @PaddingLEN tinyint

declare @CurrentYear as char(2)
declare @AutoColumnLEN tinyint
declare @SelfRequest as char(4)

declare @ImmunisationNoPrefix varchar(1)
declare @PassedImmunisationID int
declare @PassedImmunisationNo varchar(20)



select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'ImmunisationVaccines' and AutoColumnName = 'ImmunisationNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'ImmunisationVaccines' and AutoColumnName = 'ImmunisationNo'

set @CurrentYear = right(year(getdate()),2)


if (@AutoColumnLEN = len(@ImmunisationNo)) and (left(@ImmunisationNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedImmunisationID = 1
	set @PassedImmunisationNo = @ImmunisationNo
	set @PassedImmunisationNo = ltrim(rtrim(substring(@PassedImmunisationNo, len(@CurrentYear) + 1, @PaddingLEN)))

if isnumeric(@PassedImmunisationNo) = 1 set @PassedImmunisationID = @PassedImmunisationNo
	else set @PassedImmunisationID = 1

	set @ImmunisationID = (select max(ImmunisationID) from ImmunisationVaccines where left(ImmunisationNo, len(@CurrentYear)) = @CurrentYear)
	set @ImmunisationID = dbo.GetNextAutoNumber('ImmunisationVaccines', 'ImmunisationNo', @ImmunisationID)

	if @PassedImmunisationID < @ImmunisationID set @ImmunisationID = @PassedImmunisationID
	if @PassedImmunisationID > @ImmunisationID set @ImmunisationID = @PassedImmunisationID

/*============================================================================================================================= */
--declare @ImmunisationID Int
--declare @ImmunisationNoPrefix varchar(1)
--declare @PaddingLEN tinyint

--*============================================================================================================================= */

if exists(select ImmunisationNo from ImmunisationVaccines where ImmunisationNo = @ImmunisationNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Immunisation No', @ImmunisationNo)
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VaccineName)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Vaccine Name', @VaccineName, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VaccineReceived)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Vaccine Received', @VaccineReceived, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PlaceReceived)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Place Received', @PlaceReceived, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end
end
begin
-------------------------------------------------------------------------------------------------------
set @ImmunisationNoPrefix = dbo.GetOptionValue('ImmunisationNoPrefix')
set @ImmunisationID = (select max(ImmunisationID) from ImmunisationVaccines where left(ImmunisationNo, len(@ImmunisationNoPrefix)) = @ImmunisationNoPrefix)
set @ImmunisationID = dbo.GetNextAutoNumber('ImmunisationVaccines', 'ImmunisationNo', @ImmunisationID)
--------------------------------------------------------------------------------------------------------------

-----------------------------------------------------------------------------------
		insert into ImmunisationVaccines
		(ImmunisationID, ImmunisationNo, PatientNo, VaccineName, VaccineReceived, DateGiven, PlaceReceived,MothersName,UpToDate, Notes, LoginID)
		values
		(@ImmunisationID, @ImmunisationNo, @PatientNo, @VaccineName, @VaccineReceived, @DateGiven, @PlaceReceived,@MothersName,@UpToDate, @Notes, @LoginID)
		return 0
return 0
end

go

/******************************************************************************************************
exec uspInsertImmunisationVaccines
******************************************************************************************************/
-- select * from ImmunisationVaccines
-- delete from ImmunisationVaccines


-------------- Update ImmunisationVaccines -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateImmunisationVaccines')
	drop proc uspUpdateImmunisationVaccines
go

create proc uspUpdateImmunisationVaccines(
@ImmunisationNo varchar(20),
@PatientNo Varchar(20),
@VaccineName Varchar(10),
@VaccineReceived varchar(10),
@DateGiven smalldatetime,
@PlaceReceived varchar(10),
@MothersName varchar(20),
@UpToDate bit,
@Notes varchar(100),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DataID from LookupData where DataID = @VaccineName)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Vaccine Name', @VaccineName, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VaccineReceived)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Vaccine Received', @VaccineReceived, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PlaceReceived)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Place Received', @PlaceReceived, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update ImmunisationVaccines set
	PatientNo = @PatientNo, VaccineName = @VaccineName, VaccineReceived = @VaccineReceived, DateGiven = @DateGiven, PlaceReceived = @PlaceReceived,MothersName = @MothersName,UpToDate = @UpToDate, Notes = @Notes, LoginID = @LoginID
	where ImmunisationNo= @ImmunisationNo
return 0
end
go

--------GetNextImmunisationID---------------------------------------------------------------------------------------------


if exists (select * from sysobjects where name = 'uspGetNextImmunisationID')
	drop proc uspGetNextImmunisationID
go
create proc uspGetNextImmunisationID(
@ImmunisationID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @ImmunisationNoPrefix varchar(1)

set @ImmunisationNoPrefix = dbo.GetOptionValue('ImmunisationNoPrefix')

set @ImmunisationID = (select max(ImmunisationID) from ImmunisationVaccines where left(ImmunisationNo, len(@ImmunisationNoPrefix)) = @ImmunisationNoPrefix)
set @ImmunisationID = dbo.GetNextAutoNumber('ImmunisationVaccines', 'ImmunisationNo', @ImmunisationID)

return 0
return 0
go

/******************************************************************************************************
exec uspUpdateImmunisationVaccines
******************************************************************************************************/
-- select * from ImmunisationVaccines
-- delete from ImmunisationVaccines


-------------- Get ImmunisationVaccines -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetImmunisationVaccines')
	drop proc uspGetImmunisationVaccines
go

create proc uspGetImmunisationVaccines(
@ImmunisationNo varchar(20) = null ,
@PatientNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not (@ImmunisationNo is null)
	begin
		select ImmunisationNo,ImmunisationVaccines.PatientNo, VaccineName, dbo.GetLookupDataDes(VaccineName) as [VaccineNameID], VaccineReceived, dbo.GetLookupDataDes(VaccineReceived) as [VaccineReceivedID], DateGiven, PlaceReceived, dbo.GetLookupDataDes(PlaceReceived) as [PlaceReceivedID],MothersName,UpToDate, Notes
	from ImmunisationVaccines
	inner join Patients on ImmunisationVaccines.PatientNo = Patients.PatientNo	
	inner join Logins on ImmunisationVaccines.LoginID = Logins.LoginID
	where ImmunisationVaccines.PatientNo= @PatientNo and ImmunisationNo =@ImmunisationNo
	end

else
	begin
		select ImmunisationNo,ImmunisationVaccines.PatientNo, VaccineName, dbo.GetLookupDataDes(VaccineName) as [VaccineNameID], VaccineReceived, dbo.GetLookupDataDes(VaccineReceived) as [VaccineReceivedID], DateGiven, PlaceReceived, dbo.GetLookupDataDes(PlaceReceived) as [PlaceReceivedID],MothersName, Notes
	from ImmunisationVaccines
	inner join Patients on ImmunisationVaccines.PatientNo = Patients.PatientNo	
	inner join Logins on ImmunisationVaccines.LoginID = Logins.LoginID
	where ImmunisationVaccines.PatientNo= @PatientNo
	end


return 0

go

go

/******************************************************************************************************
exec uspGetImmunisationVaccines
******************************************************************************************************/
-- select * from ImmunisationVaccines
-- delete from ImmunisationVaccines

-------------------------------------------PHYSIOTHERAPY---------------------------------------
------------------------------------------------------------------------------------------------------
-------------- PhysioDiagnosis --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit PhysioDiagnosis -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPhysioDiagnosis')
	drop proc uspInsertPhysioDiagnosis
go

create proc uspInsertPhysioDiagnosis(
@VisitNo Varchar(20),
@PhysioDiseaseNo varchar(20),
@Notes Varchar(200),
@LoginID varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select PhysioDiseaseNo from PhysioDiseases where PhysioDiseaseNo  = @PhysioDiseaseNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PhysioDiseaseNo', @PhysioDiseaseNo, 'PhysioDiseases')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

if exists(select VisitNo from PhysioDiagnosis where VisitNo = @VisitNo and PhysioDiseaseNo = @PhysioDiseaseNo)
	begin
		update PhysioDiagnosis set Notes = @Notes, LoginID = @LoginID
		where VisitNo = @VisitNo and PhysioDiseaseNo = @PhysioDiseaseNo
		return 0
	end
else

begin
insert into PhysioDiagnosis
(VisitNo, PhysioDiseaseNo, Notes, LoginID)
values
(@VisitNo, @PhysioDiseaseNo, @Notes, @LoginID)
return 0
end
go


/******************************************************************************************************
exec uspInsertPhysioDiagnosis
******************************************************************************************************/
 --select * from PhysioDiagnosis
-- delete from PhysioDiagnosis


-------------- Update PhysioDiagnosis -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePhysioDiagnosis')
	drop proc uspUpdatePhysioDiagnosis
go

create proc uspUpdatePhysioDiagnosis(
@VisitNo Varchar(20),
@PhysioDiseaseNo varchar(20),
@Notes Varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select PhysioDiseaseNo from PhysioDiseases where PhysioDiseaseNo  = @PhysioDiseaseNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PhysioDiseaseNo', @PhysioDiseaseNo, 'PhysioDiseases')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end


begin
update PhysioDiagnosis set
VisitNo = @VisitNo, PhysioDiseaseNo = @PhysioDiseaseNo, Notes = @Notes, LoginID = @LoginID

return 0
end
go

/******************************************************************************************************
exec uspUpdatePhysioDiagnosis
******************************************************************************************************/
-- select * from PhysioDiagnosis
-- delete from PhysioDiagnosis


-------------- Get PhysioDiagnosis -------------------------------------------------------------
if exists (select * from sysobjects where name = 'uspGetPhysioDiagnosis')
	drop proc uspGetPhysioDiagnosis
go

create proc uspGetPhysioDiagnosis(
@VisitNo as varchar(20) = null 
)with encryption as

if not (@VisitNo is null)
	begin
		select  VisitNo, PhysioDiagnosis.PhysioDiseaseNo, Notes 
		from PhysioDiagnosis
		inner join PhysioDiseases on PhysioDiagnosis.PhysioDiseaseNo = PhysioDiseases.PhysioDiseaseNo
		where VisitNo = @VisitNo	
	end

if (@VisitNo is null)
	begin
		select  VisitNo, PhysioDiagnosis.PhysioDiseaseNo, Notes 
		from PhysioDiagnosis
		inner join PhysioDiseases on PhysioDiagnosis.PhysioDiseaseNo = PhysioDiseases.PhysioDiseaseNo
	end
return 0

go

------------------------------------------------------------------------------------------------------
-------------- TreatmentPlan --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert TreatmentPlan -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertTreatmentPlan')
	drop proc uspInsertTreatmentPlan
go

create proc uspInsertTreatmentPlan(
@VisitNo Varchar(20),
@CategoryID Varchar(10),
@TherapyTechniqueID Varchar(10),
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select VisitNo from Physiotherapy where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @CategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Category', @CategoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TherapyTechniqueID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Therapy Technique', @TherapyTechniqueID, 'Lookup Data')
		return 1
	end


if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into TreatmentPlan
(VisitNo, CategoryID, TherapyTechniqueID,Notes, LoginID)
values
(@VisitNo, @CategoryID, @TherapyTechniqueID, @Notes, @LoginID)
return 0
end
go





/******************************************************************************************************
exec uspInsertTreatmentPlan
******************************************************************************************************/
-- select * from TreatmentPlan
-- delete from TreatmentPlan


-------------- Update TreatmentPlan -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateTreatmentPlan')
	drop proc uspUpdateTreatmentPlan
go

create proc uspUpdateTreatmentPlan(
@VisitNo Varchar(20),
@CategoryID Varchar(10),
@TherapyTechniqueID Varchar(10),
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select VisitNo from Physiotherapy where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

	if not exists(select DataID from LookupData where DataID = @CategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Category', @CategoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @TherapyTechniqueID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Therapy Technique', @TherapyTechniqueID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update TreatmentPlan set
VisitNo = @VisitNo,CategoryID = @CategoryID, TherapyTechniqueID = @TherapyTechniqueID, Notes = @Notes, LoginID = @LoginID

return 0
end
go

/******************************************************************************************************
exec uspUpdateTreatmentPlan
******************************************************************************************************/
-- select * from TreatmentPlan
-- delete from TreatmentPlan


-------------- Get TreatmentPlan -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetTreatmentPlan')
	drop proc uspGetTreatmentPlan
go

create proc uspGetTreatmentPlan(
	@VisitNo as varchar(20) = null 
)with encryption as

declare @ErrorMSG varchar(200)

if not (@VisitNo is null)
	begin
		select  VisitNo,TherapyTechniqueID, Notes 
		from TreatmentPlan
	
	end

if (@VisitNo is null)
	begin
		select  VisitNo, TherapyTechniqueID, Notes 
		from TreatmentPlan
	end

return 0

go

go

/******************************************************************************************************
exec uspGetTreatmentPlan
******************************************************************************************************/
-- select * from TreatmentPlan
-- delete from TreatmentPlan


-------------- Get  ManipulativeTechniqueItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetManipulativeTechniqueItems')
	drop proc uspGetManipulativeTechniqueItems
go

create proc uspGetManipulativeTechniqueItems
with encryption as
declare @ErrorMSG varchar(200)

begin
select dbo.GetMergedNameCode(DataDes, DataID) as ItemFullName,* from LookupData 
left outer join LookupObjects on LookupObjects.ObjectID = LookupData.ObjectID
where LookupData.ObjectID='223'
return 0
end
go
/*****************************************************************************************
exec uspGetManipulativeTechniqueItems 
******************************************************************************************/

-------------- Get  ElectrotherapyItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetElectrotherapyItems')
	drop proc uspGetElectrotherapyItems
go

create proc uspGetElectrotherapyItems
with encryption as
declare @ErrorMSG varchar(200)

begin
select dbo.GetMergedNameCode(DataDes, DataID) as ItemFullName, 
* from LookupData
left outer join LookupObjects on LookupObjects.ObjectID = LookupData.ObjectID
 where LookupData.ObjectID='225'

return 0
end
go
/*****************************************************************************************
exec uspGetElectrotherapyItems 
******************************************************************************************/

-------------- Get  ExercisotherapyItems -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetExercisotherapyItems')
	drop proc uspGetExercisotherapyItems
go

create proc uspGetExercisotherapyItems
with encryption as
declare @ErrorMSG varchar(200)

begin
select dbo.GetMergedNameCode(DataDes, DataID) as ItemFullName, 
* from LookupData
left outer join LookupObjects on LookupObjects.ObjectID = LookupData.ObjectID
 where LookupData.ObjectID='226'

return 0
end
go

------------------------------------------------------------------------------------------------------
-------------- PhysioDiseases --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PhysioDiseases -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPhysioDiseases')
	drop proc uspInsertPhysioDiseases
go

create proc uspInsertPhysioDiseases(
@PhysioDiseaseNo varchar(20),
@DiseaseCode varchar(10),
@DiseaseName varchar(200),
@PhysioDiseaseCategoriesID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @DiseaseID int

declare @PaddingLEN tinyint

declare @PassedDiseaseID int
declare @PassedDiseaseNo varchar(20)
declare @PassedDiseaseCode varchar(20)

if exists(select PhysioDiseaseNo from PhysioDiseases where PhysioDiseaseNo = @PhysioDiseaseNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Disease No', @PhysioDiseaseNo)
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @PhysioDiseaseCategoriesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Physio Disease Categories', @PhysioDiseaseCategoriesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
------------------------------------------------------------------------------------------------------------
select @PaddingLEN = PaddingLEN from AutoNumbers where ObjectName = 'PhysioDiseases' and AutoColumnName = 'PhysioDiseaseNo'
   set @PassedDiseaseNo = ltrim(rtrim(substring(@PhysioDiseaseNo, 1, len(@PhysioDiseaseNo) - @PaddingLEN)))

set @DiseaseID = CONVERT(int,ltrim(rtrim(right(@PhysioDiseaseNo,@PaddingLEN))))

-----------------------------------------------------------------------------------------------------------
insert into PhysioDiseases
(DiseaseID, PhysioDiseaseNo, DiseaseCode, DiseaseName, PhysioDiseaseCategoriesID, LoginID)
values
(@DiseaseID, @PhysioDiseaseNo, @DiseaseCode, @DiseaseName, @PhysioDiseaseCategoriesID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertPhysioDiseases
******************************************************************************************************/
-- select * from PhysioDiseases
-- delete from PhysioDiseases


-------------- Update PhysioDiseases -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePhysioDiseases')
	drop proc uspUpdatePhysioDiseases
go

create proc uspUpdatePhysioDiseases(

@PhysioDiseaseNo varchar(20),
@DiseaseCode varchar(10),
@DiseaseName varchar(200),
@PhysioDiseaseCategoriesID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PhysioDiseaseNo from PhysioDiseases where PhysioDiseaseNo = @PhysioDiseaseNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Disease No', @PhysioDiseaseNo, 'PhysioDiseases')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @PhysioDiseaseCategoriesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Physio Disease Categories', @PhysioDiseaseCategoriesID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update PhysioDiseases set
 DiseaseCode = @DiseaseCode, DiseaseName = @DiseaseName, PhysioDiseaseCategoriesID = @PhysioDiseaseCategoriesID, LoginID = @LoginID
where PhysioDiseaseNo = @PhysioDiseaseNo
return 0
end
go

/******************************************************************************************************
exec uspUpdatePhysioDiseases
******************************************************************************************************/
-- select * from PhysioDiseases
-- delete from PhysioDiseases


-------------- Get PhysioDiseases -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPhysioDiseases')
	drop proc uspGetPhysioDiseases
go

create proc uspGetPhysioDiseases(
@PhysioDiseaseNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (@PhysioDiseaseNo is null or @PhysioDiseaseNo= '')
begin
	select PhysioDiseaseNo, DiseaseCode, DiseaseName, PhysioDiseaseCategoriesID,
	 dbo.GetLookupDataDes(PhysioDiseaseCategoriesID) as PhysioDiseaseCategory, 
	 PhysioDiseases.LoginID, ClientMachine, RecordDateTime
	from PhysioDiseases
   	order by DiseaseName
end

else 
begin

if not exists(select PhysioDiseaseNo from PhysioDiseases where PhysioDiseaseNo = @PhysioDiseaseNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Disease No', @PhysioDiseaseNo, 'PhysioDiseases')
		return 1
	end
else
begin

	select PhysioDiseaseNo, DiseaseCode, DiseaseName, PhysioDiseaseCategoriesID, dbo.GetLookupDataDes(PhysioDiseaseCategoriesID) as [Physio Disease Categories], PhysioDiseases.LoginID, ClientMachine, RecordDateTime
	from PhysioDiseases
	inner join Logins on PhysioDiseases.LoginID = Logins.LoginID	

	where PhysioDiseaseNo = @PhysioDiseaseNo
	end 
end	
go

--------GetNextPhysioDiseaseID--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetNextPhysioDiseaseID')
	drop proc GetNextPhysioDiseaseID
go

create proc GetNextPhysioDiseaseID(
@DiseaseCode varchar(20),
@DiseaseID int = null output
)with encryption as

declare @Increment int

set @Increment= (select Increment from AutoNumbers where ObjectName = 'PhysioDiseases')
set @DiseaseID = (select max(DiseaseID)+ @Increment from PhysioDiseases where DiseaseCode = @DiseaseCode)


return 0

go

------------------------------------------------------------------------------------------------------
-------------- Physiotherapy --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Physiotherapy -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPhysiotherapy')
	drop proc uspInsertPhysiotherapy
go

create proc uspInsertPhysiotherapy(

@VisitNo Varchar(20),
@OnMedication Varchar(10),
@Medication Varchar(100),
@Pain24hoursOrVAS Varchar(10),
@LevelOfDependenceOrADLS Varchar(10),
@MuscleStatus varchar(100),
@StatusOfJoints Varchar(50),
@Sensitivity varchar(100),
@WalkingAnalysis varchar(100),
@ShortTermTreatmentTargets varchar(100),
@LongTermTreatmentTargets varchar(100),
@ProvisionalDiagnosis varchar(100),
@LoginID Varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select DataID from LookupData where DataID = @OnMedication)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'On Medication', @OnMedication, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Pain24hoursOrVAS)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pain 24 hours Or VAS', @Pain24hoursOrVAS, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LevelOfDependenceOrADLS)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Level Of Dependence Or ADLS', @LevelOfDependenceOrADLS, 'Lookup Data')
		return 1
	end


if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end


begin
if exists(select VisitNo from Physiotherapy where VisitNo = @VisitNo )

	begin
		update Physiotherapy set
		OnMedication = @OnMedication, Medication = @Medication, Pain24hoursOrVAS = @Pain24hoursOrVAS, 
		LevelOfDependenceOrADLS = @LevelOfDependenceOrADLS,	MuscleStatus = @MuscleStatus, StatusOfJoints=@StatusOfJoints,Sensitivity= @Sensitivity, WalkingAnalysis= @WalkingAnalysis, ShortTermTreatmentTargets= @ShortTermTreatmentTargets, LongTermTreatmentTargets= @LongTermTreatmentTargets,ProvisionalDiagnosis= @ProvisionalDiagnosis,
		LoginID = @LoginID
		where VisitNo = @VisitNo
		return 0
	end
else
	Begin
		insert into Physiotherapy
		(VisitNo, OnMedication, Medication, Pain24hoursOrVAS, LevelOfDependenceOrADLS, MuscleStatus, StatusOfJoints, Sensitivity, WalkingAnalysis, ShortTermTreatmentTargets, LongTermTreatmentTargets,ProvisionalDiagnosis, LoginID)
		values
		(@VisitNo, @OnMedication, @Medication, @Pain24hoursOrVAS, @LevelOfDependenceOrADLS, @MuscleStatus, @StatusOfJoints, @Sensitivity, @WalkingAnalysis, @ShortTermTreatmentTargets, @LongTermTreatmentTargets,@ProvisionalDiagnosis, @LoginID)
		return 0
	End
end
go

/******************************************************************************************************
exec uspInsertPhysiotherapy
******************************************************************************************************/
-- select * from Physiotherapy
-- delete from Physiotherapy


-------------- Update Physiotherapy -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePhysiotherapy')
	drop proc uspUpdatePhysiotherapy
go

create proc uspUpdatePhysiotherapy(
@VisitNo Varchar(20),
@OnMedication Varchar(10),
@Medication Varchar(100),
@Pain24hoursOrVAS Varchar(40),
@LevelOfDependenceOrADLS Varchar(10),
@MuscleStatus varchar(100),
@StatusOfJoints Varchar(50),
@Sensitivity varchar(100),
@WalkingAnalysis varchar(100),
@ShortTermTreatmentTargets varchar(100),
@LongTermTreatmentTargets varchar(100),
@ProvisionalDiagnosis varchar(100),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if not exists(select DataID from LookupData where DataID = @OnMedication)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'On Medication', @OnMedication, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @Pain24hoursOrVAS)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pain 24 hours Or VAS', @Pain24hoursOrVAS, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LevelOfDependenceOrADLS)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Level Of Dependence Or ADLS', @LevelOfDependenceOrADLS, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update Physiotherapy set
	VisitNo = @VisitNo, OnMedication = @OnMedication, Medication = @Medication, Pain24hoursOrVAS = @Pain24hoursOrVAS, LevelOfDependenceOrADLS = @LevelOfDependenceOrADLS, MuscleStatus = @MuscleStatus, StatusOfJoints = @StatusOfJoints, Sensitivity = @Sensitivity, WalkingAnalysis = @WalkingAnalysis, ShortTermTreatmentTargets = @ShortTermTreatmentTargets, LongTermTreatmentTargets = @LongTermTreatmentTargets,ProvisionalDiagnosis= @ProvisionalDiagnosis, LoginID = @LoginID

return 0
end
go

/******************************************************************************************************
exec uspUpdatePhysiotherapy
******************************************************************************************************/
-- select * from Physiotherapy
-- delete from Physiotherapy


-------------- Get Physiotherapy -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPhysiotherapy')
	drop proc uspGetPhysiotherapy
go

create proc uspGetPhysiotherapy(
	@VisitNo Varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)

	
begin
	select VisitNo, OnMedication,  dbo.GetLookupDataDes(OnMedication) as [OnMedicationID],Medication,  Pain24hoursOrVAS, LevelOfDependenceOrADLS,dbo.GetLookupDataDes(LevelOfDependenceOrADLS) as [LevelOfDependenceOrADLSID], MuscleStatus, StatusOfJoints, Sensitivity, WalkingAnalysis,ShortTermTreatmentTargets, LongTermTreatmentTargets,ProvisionalDiagnosis
	from Physiotherapy
	where VisitNo = @VisitNo
return 0
end
go

------------------------------------------------------------------------------------------------------
-------------- Clients --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert Clients -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertClients')
	drop proc uspInsertClients
go

create proc uspInsertClients(
@ReferenceNo varchar(20),
@FirstName varchar(20),
@LastName varchar(20),
@MiddleName varchar(20),
@GenderID varchar(10),
@PhoneNo varchar(30),
@DoctorSpecialtyID varchar(10),
@StaffNo varchar(10) =null,
@Description varchar(200),
@BirthDate SmallDateTime,
@AppointmentDate SmallDateTime,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

declare @ReferenceID int
declare @CurrentYear as char(2)

if exists(select ReferenceNo from Clients where ReferenceNo = @ReferenceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'ReferenceNo', @ReferenceNo)
		return 1
	end

if (@BirthDate > GetDate())
	begin		
		set @ErrorMSG = 'The %s: ' + ltrim(rtrim(dbo.FormatDate(@BirthDate))) + ', you are trying to enter can''t be ahead of today’s date as set by server administrator'
		raiserror(@ErrorMSG, 16, 1, 'Birth Date')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GenderID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'GenderID', @GenderID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DoctorSpecialtyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'DoctorSpecialtyID', @DoctorSpecialtyID, 'Lookup Data')
		return 1
	end

if not (@StaffNo is null or @StaffNo = '') 
	begin
		if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
				return 1
			end
	end
else if (@StaffNo is null or @StaffNo = '')
begin set @StaffNo = null end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin

	--------------------------------------------------------------------------------------------------------------
	set @CurrentYear = right(year(getdate()),2)
	set @ReferenceID = (select max(ReferenceID) from Clients where substring(ReferenceNo, 2, 2) = @CurrentYear)
	set @ReferenceID = dbo.GetNextAutoNumber('Clients', 'ReferenceNo', @ReferenceID)
	--------------------------------------------------------------------------------------------------------------


insert into Clients
(ReferenceID, ReferenceNo, FirstName, LastName, MiddleName, GenderID, PhoneNo,
 DoctorSpecialtyID, StaffNo, Description, LoginID,BirthDate, AppointmentDate)
values
(@ReferenceID, @ReferenceNo, @FirstName, @LastName, @MiddleName, @GenderID, @PhoneNo,
 @DoctorSpecialtyID, @StaffNo, @Description, @LoginID,@BirthDate, @AppointmentDate)
return 0
end
go

/******************************************************************************************************
exec uspInsertClients '100','Mukiibi','Ismail','','15M','','39GEN','','Call','Admin'
exec uspInsertClients '102','Mukiibi','Ismail','Musisi','15M','','39GEN','','Call','Admin'
******************************************************************************************************/
-- select * from Clients
-- delete from Clients


-------------- Update Clients -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateClients')
	drop proc uspUpdateClients
go

create proc uspUpdateClients(
@ReferenceNo varchar(20),
@FirstName varchar(20),
@LastName varchar(20),
@MiddleName varchar(20),
@GenderID varchar(10),
@PhoneNo varchar(30),
@DoctorSpecialtyID varchar(10),
@StaffNo varchar(10)=null,
@Description varchar(200),
@BirthDate SmallDateTime,
@AppointmentDate SmallDateTime,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ReferenceNo from Clients where ReferenceNo = @ReferenceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ReferenceNo', @ReferenceNo, 'Clients')
		return 1
	end

if (@BirthDate > GetDate())
	begin		
		set @ErrorMSG = 'The %s: ' + ltrim(rtrim(dbo.FormatDate(@BirthDate))) + ', you are trying to enter can''t be ahead of today’s date as set by server administrator'
		raiserror(@ErrorMSG, 16, 1, 'Birth Date')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @GenderID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'GenderID', @GenderID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DoctorSpecialtyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'DoctorSpecialtyID', @DoctorSpecialtyID, 'Lookup Data')
		return 1
	end

if not (@StaffNo is null or @StaffNo = '') 
	begin
		if not exists(select StaffNo from Staff where StaffNo  = @StaffNo)
			begin
				set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
				raiserror(@ErrorMSG, 16, 1, 'Staff No', @StaffNo, 'Staff')
				return 1
			end
	end
else if (@StaffNo is null or @StaffNo = '')
begin set @StaffNo = null end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update Clients set
FirstName = @FirstName, LastName = @LastName, MiddleName = @MiddleName, 
GenderID = @GenderID, PhoneNo = @PhoneNo, DoctorSpecialtyID = @DoctorSpecialtyID, StaffNo = @StaffNo, 
Description = @Description,BirthDate = @BirthDate, AppointmentDate = @AppointmentDate,
LoginID = @LoginID
where ReferenceNo = @ReferenceNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateClients
******************************************************************************************************/
-- select * from Clients
-- delete from Clients


-------------- Get Clients -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetClients')
	drop proc uspGetClients
go

create proc uspGetClients(
@ReferenceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ReferenceNo from Clients where ReferenceNo = @ReferenceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ReferenceNo', @ReferenceNo, 'Clients')
		return 1
	end
else
begin
	select ReferenceID, ReferenceNo, FirstName, LastName, MiddleName,
	 GenderID, dbo.GetLookupDataDes(GenderID) as [GenderID], PhoneNo, DoctorSpecialtyID, 
	 dbo.GetLookupDataDes(DoctorSpecialtyID) as [DoctorSpecialtyID], Clients.StaffNo, Description, 
     dbo.GetStaffFullName(Clients.StaffNo) as StaffFullName,BirthDate,dbo.GetAge(BirthDate, getdate()) as Age, AppointmentDate,
	 dbo.FormatDate(AppointmentDate) as AppointmentDateTime,
	 Clients.LoginID, ClientMachine, RecordDateTime
	from Clients

	where ReferenceNo = @ReferenceNo
return 0
end
go

/******************************************************************************************************
exec uspGetClients
******************************************************************************************************/
-- select * from Clients
-- delete from Clients


--------GetNextReferenceNo--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextClientsReferenceNo')
	drop proc uspGetNextClientsReferenceNo
go

create proc uspGetNextClientsReferenceNo(
@ReferenceID int = null output
)with encryption as

declare @ErrorMSG varchar(200)
declare @CurrentYear as char(2)

set @CurrentYear = right(year(getdate()),2)
set @ReferenceID = (select max(ReferenceID) from Clients where substring(ReferenceNo, 2, 2) = @CurrentYear)
set @ReferenceID = dbo.GetNextAutoNumber('Clients', 'ReferenceNo', @ReferenceID)

return 0

go

-- exec uspGetNextClientsReferenceNo
-- select * from Clients

-----------------------------------uspGetClientsByDate------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetClientsByDate')
	drop proc uspGetClientsByDate
go
create proc uspGetClientsByDate(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as

begin

select ReferenceNo, FirstName, LastName, MiddleName,
dbo.GetLookupDataDes(GenderID) as [Gender], PhoneNo, 
dbo.GetLookupDataDes(DoctorSpecialtyID) as [DoctorSpecialtyID], Description, 
dbo.GetStaffName(Clients.StaffNo) as StaffFullName,BirthDate,dbo.GetAge(BirthDate, getdate()) as Age,
AppointmentDate,dbo.FormatDate(AppointmentDate) as AppointmentDateTime
from Clients
where dbo.FormatDate(RecordDateTime) between @StartDate and @EndDate and dbo.GetClientPatients(ReferenceNo)= 0
end
return 0
go

-------------------------------------------------------------------------------------------------------
-- exec uspGetClientsByDate '1 mar 2018', '16 Mar 2018'
--------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
-------------- MappedCodesFinance --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert MappedCodesFinance -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertMappedCodesFinance')
	drop proc uspInsertMappedCodesFinance
go

create proc uspInsertMappedCodesFinance(
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@AccountTypeID Varchar(10),
@ItemName varchar(200),
@AccountNo varchar(20),
@LoginID varchar(20),
@Username varchar(41),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AccountTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Account Type', @AccountTypeID, 'Lookup Data')
		return 1
	end

if exists(select ItemCode from MappedCodesFinance where ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and AccountTypeID = @AccountTypeID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'Account Type', @AccountTypeID)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into MappedCodesFinance
(ItemCode, ItemCategoryID, AccountTypeID, ItemName, AccountNo, LoginID, Username, ClientMachine)
values
(@ItemCode, @ItemCategoryID, @AccountTypeID, @ItemName, @AccountNo, @LoginID, @Username, @ClientMachine)
return 0
end
go

/******************************************************************************************************
exec uspInsertMappedCodesFinance 
exec uspInsertMappedCodesFinance 

******************************************************************************************************/
-- select * from MappedCodesFinance
-- delete from MappedCodesFinance


-------------- Update MappedCodesFinance -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateMappedCodesFinance')
	drop proc uspUpdateMappedCodesFinance
go

create proc uspUpdateMappedCodesFinance(
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@AccountTypeID Varchar(10),
@ItemName varchar(200),
@AccountNo varchar(20),
@LoginID varchar(20),
@Username varchar(41),
@ClientMachine varchar(40)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ItemCode from MappedCodesFinance where ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and AccountTypeID = @AccountTypeID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'Account Type', @AccountTypeID, 'MappedCodesFinance')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update MappedCodesFinance set
ItemName = @ItemName, AccountNo = @AccountNo, LoginID = @LoginID, Username = @Username, ClientMachine = @ClientMachine
where ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and AccountTypeID = @AccountTypeID
return 0
end
go

/******************************************************************************************************
exec uspUpdateMappedCodesFinance
******************************************************************************************************/
-- select * from MappedCodesFinance
-- delete from MappedCodesFinance


-------------- Get MappedCodesFinance -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetMappedCodesFinance')
	drop proc uspGetMappedCodesFinance
go

create proc uspGetMappedCodesFinance(
@ItemCode varchar(20)=null,
@ItemCategoryID varchar(10),
@AccountTypeID Varchar(10)
)with encryption as

declare @ErrorMSG varchar(200)

if @ItemCode is not null

begin
if not exists(select ItemCode from MappedCodesFinance where ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and AccountTypeID = @AccountTypeID)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Code', @ItemCode, 'Item Category', @ItemCategoryID, 'Account Type', @AccountTypeID, 'MappedCodesFinance')
		return 1
	end
else
begin
	select ItemCode, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, AccountTypeID, 
	dbo.GetLookupDataDes(AccountTypeID) as AccountType, ItemName, MappedCodesFinance.AccountNo, 
	AccountName,dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName, MappedCodesFinance.LoginID, 
	MappedCodesFinance.Username, MappedCodesFinance.ClientMachine, MappedCodesFinance.RecordDateTime
	from MappedCodesFinance
	inner join Logins on MappedCodesFinance.LoginID = Logins.LoginID
	inner join ClinicMasterFinance.dbo.ChartAccounts on ChartAccounts.AccountNo= MappedCodesFinance.AccountNo
	where ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and AccountTypeID = @AccountTypeID
end
end

else
begin
	select ItemCode, ItemCategoryID, dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory, AccountTypeID, 
	dbo.GetLookupDataDes(AccountTypeID) as AccountType, ItemName, MappedCodesFinance.AccountNo, 
	AccountName,dbo.GetMergedNameCode(ItemName, ItemCode) as ItemFullName, MappedCodesFinance.LoginID, 
	MappedCodesFinance.Username, MappedCodesFinance.ClientMachine, MappedCodesFinance.RecordDateTime
	from MappedCodesFinance
	inner join Logins on MappedCodesFinance.LoginID = Logins.LoginID
	inner join ClinicMasterFinance.dbo.ChartAccounts on ChartAccounts.AccountNo= MappedCodesFinance.AccountNo
	where ItemCategoryID = @ItemCategoryID and AccountTypeID = @AccountTypeID
end
return 0
go

/******************************************************************************************************
exec uspGetMappedCodesFinance '10C', '245S', '10034'
exec uspGetMappedCodesFinance null , '245S', '10034'
******************************************************************************************************/
-- select * from MappedCodesFinance
-- delete from MappedCodesFinance


/******************************************************************************************************
exec uspGetMappedCodesFinance '085', '245D', '510001'
exec uspGetMappedCodesFinance null, '245S', '510001'

******************************************************************************************************/
-- select * from MappedCodesFinance
-- delete from MappedCodesFinance



if exists (select * from sysobjects where name = 'uspReverseReceiptsOPD')
	drop proc uspReverseReceiptsOPD
go

create proc uspReverseReceiptsOPD(
@VisitNo varchar(20),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@ReceiptNo varchar(20)
)with encryption as 

declare @ErrorMSG varchar(200)
declare @NotPaidPayStatusID varchar(10)
declare @PaidPayStatusID varchar(10)
declare @PercentCoPayTypeID varchar(10)
declare @CoPayTypeID varchar(10)
declare @CoPayPercent decimal(5,2)
declare @PayTypeID varchar(10)

-----------------------------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @PaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'PF')
set @PercentCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'PCT')
-----------------------------------------------------------------------------------------------
declare @CashVisitPayTypeID varchar(10)
declare @ExtraBillPayTypeID varchar(10)


------------------------------------------------------------------------------------------------------------------
set @CashVisitPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @ExtraBillPayTypeID = dbo.GetLookupDataID('PayType', 'EXT')
set @PayTypeID =(select Top 1 PayTypeID from Payments where ReceiptNo =@ReceiptNo)
------------------------------------------------------------------------------------------------------------------


if not (@VisitNo is null or @VisitNo = '')
begin

begin tran 						
												
set @CoPayTypeID = (select CoPayTypeID from Visits where VisitNo = @VisitNo)
								
---------------------------------------------------------------------------------------
if (@PayTypeID =@CashVisitPayTypeID)

begin
update Items set PayStatusID = @NotPaidPayStatusID
where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID	
---------------------------------------------------------------------------------------
if (@CoPayTypeID = @PercentCoPayTypeID)
begin
	
update ItemsCash set CashPayStatusID = @NotPaidPayStatusID
	where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
end
end
---------------------------------------------------------------------------------------

else if (@PayTypeID =@ExtraBillPayTypeID)

begin
update ExtraBillItems set PayStatusID = @NotPaidPayStatusID
where ExtraBillNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID

update IPDItems set PayStatusID = @NotPaidPayStatusID
where RoundNo =dbo.GetExtraBillRoundNo(@VisitNo) and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
	
---------------------------------------------------------------------------------------
if (@CoPayTypeID = @PercentCoPayTypeID)
begin
	
update ExtraBillItemsCASH set CashPayStatusID = @NotPaidPayStatusID
where ExtraBillNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
end
end
end
---------------------------------------------------------------------------------------
											
if @@error > 0
begin
	rollback tran
	return 1		
end
commit tran
return 0
go

/*--------------------------------------------------------------------------------------------------------
-- exec uspReverseReceiptsOPD '18000020001', '7R', 'R054','1800000105'
-- select Top 1 PayTypeID from Payments where ReceiptNo ='1800000105'
---------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------
-- exec uspReverseReceiptsOPD '15007328001', '7T', 'T006',''
---------------------------------------------------------------------------------------------------------*/

------------------------------------------------------------------------------------------------------
-------------- OccupationalTherapy --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert OccupationalTherapy -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertOccupationalTherapy')
	drop proc uspInsertOccupationalTherapy
go

create proc uspInsertOccupationalTherapy(
@VisitNo Varchar(20),
@WalkingID varchar(10),
@SitStandTransfersID varchar(10),
@BathingID varchar(10),
@ToiletingID varchar(10),
@DressingID varchar(10),
@HandFunctionID varchar(10),
@WashingID varchar(10),
@FeedingID varchar(10),
@GroomingID varchar(10),
@MealPreparationID varchar(10),
@WorkPlaySchoolID varchar(10),
@LeisureID varchar(10),
@CommunicationID varchar(10),
@CognitionID varchar(10),
@AttentionID varchar(10),
@ImpulseControlID varchar(10),
@SleepID varchar(10),
@MemoryID varchar(10),
@PerceptionID varchar(10),
@ThoughtID varchar(10),
@SightID varchar(10),
@TasteID varchar(10),
@HearingID varchar(10),
@TouchID varchar(10),
@SmellID varchar(10),
@PainID varchar(10),
@VestibularID varchar(10),
@TemperatureAndPressureID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------

--if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
--		return 1
--	end

if not exists(select DataID from Lookupdata where DataID = @WalkingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Walking', @WalkingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @SitStandTransfersID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sit Stand Transfers', @SitStandTransfersID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @BathingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bathing', @BathingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @ToiletingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Toileting', @ToiletingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @DressingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Dressing', @DressingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @HandFunctionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Hand Function', @HandFunctionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @WashingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Washing', @WashingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @FeedingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Feeding', @FeedingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @GroomingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Grooming', @GroomingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @MealPreparationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Meal Preparation', @MealPreparationID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @WorkPlaySchoolID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Work Play School', @WorkPlaySchoolID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @LeisureID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Leisure', @LeisureID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @CommunicationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Communication', @CommunicationID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @CognitionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cognition', @CognitionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @AttentionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Attention', @AttentionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @ImpulseControlID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Impulse Control', @ImpulseControlID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @SleepID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sleep', @SleepID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @MemoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Memory', @MemoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @PerceptionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Perception', @PerceptionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @ThoughtID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Thought', @ThoughtID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @SightID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sight', @SightID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @TasteID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Taste', @TasteID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @HearingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Hearing', @HearingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @TouchID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Touch', @TouchID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @SmellID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Smell', @SmellID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @PainID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pain', @PainID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @VestibularID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Vestibular', @VestibularID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @TemperatureAndPressureID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Temperature And Pressure', @TemperatureAndPressureID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end
begin

if exists(select VisitNo from OccupationalTherapy where VisitNo = @VisitNo  and WalkingID = @WalkingID and SitStandTransfersID =@SitStandTransfersID and BathingID =@BathingID and ToiletingID =ToiletingID and DressingID =@DressingID and HandFunctionID =@HandFunctionID and WashingID =@WashingID and FeedingID =@FeedingID and GroomingID =@GroomingID and MealPreparationID= @MealPreparationID and WorkPlaySchoolID =@WorkPlaySchoolID
	 and LeisureID =@LeisureID and CommunicationID =@CommunicationID and CognitionID =@CognitionID and AttentionID =@AttentionID and ImpulseControlID =@ImpulseControlID and SleepID =@SleepID and MemoryID =@MemoryID and PerceptionID =@PerceptionID and ThoughtID =@ThoughtID and SightID =@SightID and TasteID =@TasteID and HearingID =@HearingID and TouchID =@TouchID and SmellID =@SmellID and PainID= @PainID and VestibularID =@VestibularID and TemperatureAndPressureID =@TemperatureAndPressureID)
	begin
		update OccupationalTherapy set
		
		LoginID = @LoginID
		where VisitNo = @VisitNo and WalkingID = @WalkingID and SitStandTransfersID =@SitStandTransfersID and BathingID =@BathingID and ToiletingID =ToiletingID and DressingID =@DressingID and HandFunctionID =@HandFunctionID and WashingID =@WashingID and FeedingID =@FeedingID and GroomingID =@GroomingID and MealPreparationID= @MealPreparationID and WorkPlaySchoolID =@WorkPlaySchoolID
	 and LeisureID =@LeisureID and CommunicationID =@CommunicationID and CognitionID =@CognitionID and AttentionID =@AttentionID and ImpulseControlID =@ImpulseControlID and SleepID =@SleepID and MemoryID =@MemoryID and PerceptionID =@PerceptionID and ThoughtID =@ThoughtID and SightID =@SightID and TasteID =@TasteID and HearingID =@HearingID and TouchID =@TouchID and SmellID =@SmellID and PainID= @PainID and VestibularID =@VestibularID and TemperatureAndPressureID =@TemperatureAndPressureID
		return 0
	end
else
begin
-------------------------------------------------------------------------------------------------------

insert into OccupationalTherapy
(  VisitNo, WalkingID, SitStandTransfersID, BathingID, ToiletingID, DressingID, HandFunctionID, WashingID, FeedingID, GroomingID, MealPreparationID, WorkPlaySchoolID, LeisureID, CommunicationID, CognitionID, AttentionID, ImpulseControlID, SleepID, MemoryID, PerceptionID, ThoughtID, SightID, TasteID, HearingID, TouchID, SmellID, PainID, VestibularID, TemperatureAndPressureID)
values
( @VisitNo, @WalkingID, @SitStandTransfersID, @BathingID, @ToiletingID, @DressingID, @HandFunctionID, @WashingID, @FeedingID, @GroomingID, @MealPreparationID, @WorkPlaySchoolID, @LeisureID, @CommunicationID, @CognitionID, @AttentionID, @ImpulseControlID, @SleepID, @MemoryID, @PerceptionID, @ThoughtID, @SightID, @TasteID, @HearingID, @TouchID, @SmellID, @PainID, @VestibularID, @TemperatureAndPressureID)
return 0
end
end
go


/******************************************************************************************************
exec uspInsertOccupationalTherapy
******************************************************************************************************/
-- select * from OccupationalTherapy
-- delete from OccupationalTherapy


-------------- Update OccupationalTherapy -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateOccupationalTherapy')
	drop proc uspUpdateOccupationalTherapy
go

create proc uspUpdateOccupationalTherapy(

@VisitNo Varchar(20),
@WalkingID varchar(10),
@SitStandTransfersID varchar(10),
@BathingID varchar(10),
@ToiletingID varchar(10),
@DressingID varchar(10),
@HandFunctionID varchar(10),
@WashingID varchar(10),
@FeedingID varchar(10),
@GroomingID varchar(10),
@MealPreparationID varchar(10),
@WorkPlaySchoolID varchar(10),
@LeisureID varchar(10),
@CommunicationID varchar(10),
@CognitionID varchar(10),
@AttentionID varchar(10),
@ImpulseControlID varchar(10),
@SleepID varchar(10),
@MemoryID varchar(10),
@PerceptionID varchar(10),
@ThoughtID varchar(10),
@SightID varchar(10),
@TasteID varchar(10),
@HearingID varchar(10),
@TouchID varchar(10),
@SmellID varchar(10),
@PainID varchar(10),
@VestibularID varchar(10),
@TemperatureAndPressureID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

--if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
--		return 1
--	end

if not exists(select DataID from Lookupdata where DataID = @WalkingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Walking', @WalkingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @SitStandTransfersID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sit Stand Transfers', @SitStandTransfersID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @BathingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bathing', @BathingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @ToiletingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Toileting', @ToiletingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @DressingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Dressing', @DressingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @HandFunctionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Hand Function', @HandFunctionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @WashingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Washing', @WashingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @FeedingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Feeding', @FeedingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @GroomingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Grooming', @GroomingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @MealPreparationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Meal Preparation', @MealPreparationID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @WorkPlaySchoolID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Work Play School', @WorkPlaySchoolID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @LeisureID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Leisure', @LeisureID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @CommunicationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Communication', @CommunicationID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @CognitionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cognition', @CognitionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @AttentionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Attention', @AttentionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @ImpulseControlID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Impulse Control', @ImpulseControlID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @SleepID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sleep', @SleepID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @MemoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Memory', @MemoryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @PerceptionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Perception', @PerceptionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @ThoughtID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Thought', @ThoughtID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @SightID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Sight', @SightID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @TasteID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Taste', @TasteID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @HearingID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Hearing', @HearingID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @TouchID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Touch', @TouchID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @SmellID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Smell', @SmellID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @PainID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pain', @PainID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @VestibularID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Vestibular', @VestibularID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @TemperatureAndPressureID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Temperature And Pressure', @TemperatureAndPressureID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update OccupationalTherapy set
 WalkingID = @WalkingID, SitStandTransfersID = @SitStandTransfersID, BathingID = @BathingID, ToiletingID = @ToiletingID, DressingID = @DressingID, HandFunctionID = @HandFunctionID, WashingID = @WashingID, FeedingID = @FeedingID, GroomingID = @GroomingID, MealPreparationID = @MealPreparationID, WorkPlaySchoolID = @WorkPlaySchoolID, LeisureID = @LeisureID, CommunicationID = @CommunicationID, CognitionID = @CognitionID, AttentionID = @AttentionID, ImpulseControlID = @ImpulseControlID, SleepID = @SleepID, MemoryID = @MemoryID, PerceptionID = @PerceptionID, ThoughtID = @ThoughtID, SightID = @SightID, TasteID = @TasteID, HearingID = @HearingID, TouchID = @TouchID, SmellID = @SmellID, PainID = @PainID, VestibularID = @VestibularID, TemperatureAndPressureID = @TemperatureAndPressureID
where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateOccupationalTherapy
******************************************************************************************************/
-- select * from OccupationalTherapy
-- delete from OccupationalTherapy


-------------- Get OccupationalTherapy -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetOccupationalTherapy')
	drop proc uspGetOccupationalTherapy
go

create proc uspGetOccupationalTherapy(
	@VisitNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select VisitNo, WalkingID, dbo.GetLookupDataDes(WalkingID) as [Walking], SitStandTransfersID, dbo.GetLookupDataDes(SitStandTransfersID) as [Sit Stand Transfers], BathingID, dbo.GetLookupDataDes(BathingID) as [Bathing], ToiletingID, dbo.GetLookupDataDes(ToiletingID) as [Toileting], DressingID, dbo.GetLookupDataDes(DressingID) as [Dressing], HandFunctionID, dbo.GetLookupDataDes(HandFunctionID) as [HandFunction], WashingID, dbo.GetLookupDataDes(WashingID) as [Washing], FeedingID, dbo.GetLookupDataDes(FeedingID) as [Feeding], GroomingID, dbo.GetLookupDataDes(GroomingID) as [Grooming], MealPreparationID, dbo.GetLookupDataDes(MealPreparationID) as [MealPreparation], WorkPlaySchoolID, dbo.GetLookupDataDes(WorkPlaySchoolID) as [WorkPlaySchool], LeisureID, dbo.GetLookupDataDes(LeisureID) as [Leisure], CommunicationID, dbo.GetLookupDataDes(CommunicationID) as [Communication], CognitionID, dbo.GetLookupDataDes(CognitionID) as [Cognition], AttentionID, dbo.GetLookupDataDes(AttentionID) as [Attention], ImpulseControlID, dbo.GetLookupDataDes(ImpulseControlID) as [ImpulseControl], SleepID, dbo.GetLookupDataDes(SleepID) as [Sleep], MemoryID, dbo.GetLookupDataDes(MemoryID) as [Memory], PerceptionID, dbo.GetLookupDataDes(PerceptionID) as [Perception], ThoughtID, dbo.GetLookupDataDes(ThoughtID) as [Thought], SightID, dbo.GetLookupDataDes(SightID) as [Sight], TasteID, dbo.GetLookupDataDes(TasteID) as [Taste], HearingID, dbo.GetLookupDataDes(HearingID) as [Hearing], TouchID, dbo.GetLookupDataDes(TouchID) as [Touch], SmellID, dbo.GetLookupDataDes(SmellID) as [Smell], PainID, dbo.GetLookupDataDes(PainID) as [Pain], VestibularID, dbo.GetLookupDataDes(VestibularID) as [Vestibular], TemperatureAndPressureID, dbo.GetLookupDataDes(TemperatureAndPressureID) as [TemperatureAndPressure], OccupationalTherapy.LoginID, ClientMachine, RecordDateTime
	from OccupationalTherapy
	inner join Logins on OccupationalTherapy.LoginID = Logins.LoginID	

	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetOccupationalTherapy
******************************************************************************************************/
-- select * from OccupationalTherapy
-- delete from OccupationalTherapy



------------------------------------------------------------------------------------------------------
-------------- OTIntervention --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert OTIntervention -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertOTIntervention')
	drop proc uspInsertOTIntervention
go

create proc uspInsertOTIntervention(
@VisitNo Varchar(20),
@LeadTherapist Varchar(10),
@InterventionTypeID varchar(10),
@CognitiveAssessment bit,
@HandTherapy bit,
@HealthEducation bit,
@TherapeuticGroupActivities bit,
@HomebasedRehabilitation bit,
@AssistiveDevices bit,
@MobilitySkillsTraining bit,
@NeurocognitiveRehabilitation bit,
@OrientationTechniques bit,
@VocationalRehabilitation bit,
@SelfCareTraining bit,
@PlayTherapy bit,
@StressManagement bit,
@OtherAssessment varchar(100),
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

--if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
--		return 1
--	end

--if not exists(select DataID from Lookupdata where DataID = @LeadTherapist)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'LeadTherapist', @LeadTherapist, 'Lookup Data')
--		return 1
--	end

if not exists(select DataID from Lookupdata where DataID = @InterventionTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'InterventionTypeID', @InterventionTypeID, 'Lookup Data')
		return 1
	end


if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end


begin
insert into OTIntervention
(VisitNo, LeadTherapist, InterventionTypeID, CognitiveAssessment, HandTherapy, HealthEducation, TherapeuticGroupActivities, HomebasedRehabilitation, AssistiveDevices, MobilitySkillsTraining, NeurocognitiveRehabilitation, OrientationTechniques, VocationalRehabilitation, SelfCareTraining, PlayTherapy, StressManagement, OtherAssessment, Notes, LoginID)
values
(@VisitNo, @LeadTherapist, @InterventionTypeID, @CognitiveAssessment, @HandTherapy, @HealthEducation, @TherapeuticGroupActivities, @HomebasedRehabilitation, @AssistiveDevices, @MobilitySkillsTraining, @NeurocognitiveRehabilitation, @OrientationTechniques, @VocationalRehabilitation, @SelfCareTraining, @PlayTherapy, @StressManagement, @OtherAssessment, @Notes, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertOTIntervention
******************************************************************************************************/
-- select * from OTIntervention
-- delete from OTIntervention


-------------- Update OTIntervention -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateOTIntervention')
	drop proc uspUpdateOTIntervention
go

create proc uspUpdateOTIntervention(
@VisitNo Varchar(20),
@LeadTherapist Varchar(10),
@InterventionTypeID varchar(10),
@CognitiveAssessment bit,
@HandTherapy bit,
@HealthEducation bit,
@TherapeuticGroupActivities bit,
@HomebasedRehabilitation bit,
@AssistiveDevices bit,
@MobilitySkillsTraining bit,
@NeurocognitiveRehabilitation bit,
@OrientationTechniques bit,
@VocationalRehabilitation bit,
@SelfCareTraining bit,
@PlayTherapy bit,
@StressManagement bit,
@OtherAssessment varchar(100),
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

--if not exists(select DataID from Lookupdata where DataID = @LeadTherapist)
--	begin
--		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
--		raiserror(@ErrorMSG, 16, 1, 'LeadTherapist', @LeadTherapist, 'Lookup Data')
--		return 1
--	end

if not exists(select DataID from Lookupdata where DataID = @InterventionTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'InterventionTypeID', @InterventionTypeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update OTIntervention set
LeadTherapist = @LeadTherapist, InterventionTypeID = @InterventionTypeID, CognitiveAssessment = @CognitiveAssessment, HandTherapy = @HandTherapy, HealthEducation = @HealthEducation, TherapeuticGroupActivities = @TherapeuticGroupActivities, HomebasedRehabilitation = @HomebasedRehabilitation, AssistiveDevices = @AssistiveDevices, MobilitySkillsTraining = @MobilitySkillsTraining, NeurocognitiveRehabilitation = @NeurocognitiveRehabilitation, OrientationTechniques = @OrientationTechniques, VocationalRehabilitation = @VocationalRehabilitation, SelfCareTraining = @SelfCareTraining, PlayTherapy = @PlayTherapy, StressManagement = @StressManagement, OtherAssessment = @OtherAssessment, Notes = @Notes, LoginID = @LoginID
where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateOTIntervention
******************************************************************************************************/
-- select * from OTIntervention
-- delete from OTIntervention


-------------- Get OTIntervention -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetOTIntervention')
	drop proc uspGetOTIntervention
go

create proc uspGetOTIntervention(
@VisitNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end
else
begin
	select VisitNo, LeadTherapist, dbo.GetLookupDataDes(LeadTherapist) as [LeadTherapist], InterventionTypeID, dbo.GetLookupDataDes(InterventionTypeID) as [InterventionType] , CognitiveAssessment, HandTherapy, HealthEducation, TherapeuticGroupActivities, HomebasedRehabilitation, AssistiveDevices, MobilitySkillsTraining, NeurocognitiveRehabilitation, OrientationTechniques, VocationalRehabilitation, SelfCareTraining, PlayTherapy, StressManagement, OtherAssessment, Notes, OTIntervention.LoginID
	from OTIntervention
	inner join Logins on OTIntervention.LoginID = Logins.LoginID
	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetOTIntervention
******************************************************************************************************/
-- select * from OTIntervention
-- delete from OTIntervention

-------------- MaternalEnrollment --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert MaternalEnrollment -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertMaternalEnrollment')
	drop proc uspInsertMaternalEnrollment
go

create proc uspInsertMaternalEnrollment(
@ANCNo varchar(20),
@PatientNo varchar(20),
@HIVStatusID varchar(10),
@PartnersHIVStatusID varchar(10),
@Gravida int,
@Para int,
@LNMP smalldatetime,
@LNMPDateReliable bit,
@CycleRegularID varchar(10),
@EDD smalldatetime,
@ScanDate smalldatetime,
@MedicalHistory varchar(200),
@MedicalHistoryNotes varchar(200),
@BloodTransfusion varchar(10),
@BloodTransfusionDate smalldatetime,
@SurgicalHistory varchar(200),
@SurgicalHistoryNotes varchar(200),
@GynaecologicalHistory varchar(200),
@GynaecologicalHistoryNotes varchar(200),
@FamilyHistory varchar(200),
@FamilyHistoryNotes varchar(200),
@SocialHistory varchar(200),
@SocialHistoryNotes varchar(200),
@PatientStatusID varchar(10),
@LoginID varchar(20)
)with encryption as


declare @ErrorMSG varchar(200)
declare @ANCID int
declare @PaddingLEN tinyint

declare @CurrentYear as char(2)
declare @AutoColumnLEN tinyint
declare @SelfRequest as char(4)

declare @ANCNoPrefix varchar(1)
declare @PassedANCID int
declare @PassedANCNo varchar(20)

select @AutoColumnLEN = AutoColumnLEN from AutoNumbers 
		where ObjectName = 'MaternalEnrollment' and AutoColumnName = 'ANCNo'

select @PaddingLEN = PaddingLEN from AutoNumbers 
		where ObjectName = 'MaternalEnrollment' and AutoColumnName = 'ANCNo'

set @CurrentYear = right(year(getdate()),2)


if (@AutoColumnLEN = len(@ANCNo)) and (left(@ANCNo, len(@CurrentYear)) = @CurrentYear)

begin

	set @PassedANCID = 1
	set @PassedANCNo = @ANCNo
	set @PassedANCNo = ltrim(rtrim(substring(@PassedANCNo, len(@CurrentYear) + 1, @PaddingLEN)))

if isnumeric(@PassedANCNo) = 1 set @PassedANCID = @PassedANCNo
	else set @PassedANCID = 1

	set @ANCID = (select max(ANCID) from MaternalEnrollment where left(ANCNo, len(@CurrentYear)) = @CurrentYear)
	set @ANCID = dbo.GetNextAutoNumber('MaternalEnrollments', 'ANCNo', @ANCID)

	if @PassedANCID < @ANCID set @ANCID = @PassedANCID
	if @PassedANCID > @ANCID set @ANCID = @PassedANCID

/*============================================================================================================================= */
--declare @ANCID Int
--declare @ANCNoPrefix varchar(1)
--declare @PaddingLEN tinyint

--*============================================================================================================================= */

if not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Patients')
		return 1
	end

if exists(select PatientNo from MaternalEnrollment where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo)
		return 1
	end


if exists(select ANCNo from MaternalEnrollment where ANCNo = @ANCNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'ANC No', @ANCNo)
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @CycleRegularID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cycle Regular', @CycleRegularID, 'Lookup Data')
		return 1
	end


if not exists(select DataID from Lookupdata where DataID = @BloodTransfusion)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Blood Transfusion', @BloodTransfusion, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @PatientStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient Status', @PatientStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end
end
begin

/*============================================================================================================================= */
	set @ANCNoPrefix = dbo.GetOptionValue('ANCNoPrefix')
	set @ANCID = (select max(ANCID) from MaternalEnrollment where left(ANCNo, len(@ANCNoPrefix)) = @ANCNoPrefix)
	set @ANCID = dbo.GetNextAutoNumber('MaternalEnrollment', 'ANCNo', @ANCID)


insert into MaternalEnrollment
(ANCID, ANCNo, PatientNo,HIVStatusID, PartnersHIVStatusID, Gravida, Para, LNMP, LNMPDateReliable, CycleRegularID,EDD, ScanDate, MedicalHistory,MedicalHistoryNotes,
 BloodTransfusion, BloodTransfusionDate, SurgicalHistory,SurgicalHistoryNotes, GynaecologicalHistory,GynaecologicalHistoryNotes, FamilyHistory, FamilyHistoryNotes,
  SocialHistory,SocialHistoryNotes,PatientStatusID, LoginID)
values
(@ANCID, @ANCNo, @PatientNo,@HIVStatusID, @PartnersHIVStatusID,@Gravida, @Para, @LNMP, @LNMPDateReliable, @CycleRegularID, @EDD, @ScanDate, @MedicalHistory,
@MedicalHistoryNotes,@BloodTransfusion, @BloodTransfusionDate,@SurgicalHistory,@SurgicalHistoryNotes, @GynaecologicalHistory,
@GynaecologicalHistoryNotes, @FamilyHistory,@FamilyHistoryNotes,@SocialHistory,@SocialHistoryNotes, @PatientStatusID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertMaternalEnrollment where ANCNo= '01'
******************************************************************************************************/
-- select * from MaternalEnrollment
-- delete from MaternalEnrollment


-------------- Update MaternalEnrollment -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateMaternalEnrollment')
	drop proc uspUpdateMaternalEnrollment
go

create proc uspUpdateMaternalEnrollment(
@ANCNo varchar(20),
@PatientNo varchar(20),
@HIVStatusID varchar(10),
@PartnersHIVStatusID varchar(10),
@Gravida int,
@Para int,
@LNMP smalldatetime,
@LNMPDateReliable bit,
@CycleRegularID varchar(10),
@EDD smalldatetime,
@ScanDate smalldatetime,
@ContraceptivesComplications varchar(200),
@MedicalHistory varchar(200),
@MedicalHistoryNotes varchar(200),
@BloodTransfusion varchar(10),
@BloodTransfusionDate smalldatetime,
@SurgicalHistory varchar(200),
@SurgicalHistoryNotes varchar(200),
@GynaecologicalHistory varchar(200),
@GynaecologicalHistoryNotes varchar(200),
@FamilyHistory varchar(200),
@FamilyHistoryNotes varchar(200),
@SocialHistory varchar(200),
@SocialHistoryNotes varchar(200),
@PatientStatusID varchar(10),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from MaternalEnrollment where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'MaternalEnrollment')
		return 1
	end

if exists(select ANCNo from MaternalEnrollment where ANCNo = @ANCNo and PatientNo <> @PatientNo )
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'ANC No', @ANCNo)
		return 1
	end


if not exists(select ANCNo from MaternalEnrollment where @ANCNo = @ANCNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ANC No', @ANCNo, 'MaternalEnrollment')
		return 1
	end


if not exists(select DataID from Lookupdata where DataID = @HIVStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'HIV Status', @HIVStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @PartnersHIVStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Partners HIV Status', @PartnersHIVStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @BloodTransfusion)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Blood Transfusion', @BloodTransfusion, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @CycleRegularID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cycle Regular', @CycleRegularID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @PatientStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient Status', @PatientStatusID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update MaternalEnrollment set
 ANCNo = @ANCNo, HIVStatusID = @HIVStatusID, PartnersHIVStatusID = @PartnersHIVStatusID,Gravida = @Gravida, Para = @Para, LNMP = @LNMP, LNMPDateReliable = @LNMPDateReliable, CycleRegularID = @CycleRegularID, EDD= @EDD,
 ScanDate = @ScanDate, MedicalHistory = @MedicalHistory, 
 MedicalHistoryNotes = @MedicalHistoryNotes,BloodTransfusion= @BloodTransfusion, BloodTransfusionDate= @BloodTransfusionDate, SurgicalHistory = @SurgicalHistory, 
 SurgicalHistoryNotes= @SurgicalHistoryNotes, GynaecologicalHistory = @GynaecologicalHistory,
 GynaecologicalHistoryNotes= @GynaecologicalHistoryNotes, FamilyHistory = @FamilyHistory,FamilyHistoryNotes =@FamilyHistoryNotes,
  SocialHistory = @SocialHistory,SocialHistoryNotes = @SocialHistoryNotes, PatientStatusID = @PatientStatusID, LoginID = @LoginID
where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateMaternalEnrollment
******************************************************************************************************/
-- select * from MaternalEnrollment
-- delete from MaternalEnrollment

--------uspGetNextANCID -----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetNextANCID')
	drop proc uspGetNextANCID
go

create proc uspGetNextANCID(
@PatientNo varchar(20),
@ANCID int = null output
)with encryption as

set @ANCID = (select max(ANCID) from MaternalEnrollment where PatientNo = @PatientNo)
set @ANCID = dbo.GetNextAutoNumber('MaternalEnrollment', 'ANCNo', @ANCID)

return 0

go



-------------- Get MaternalEnrollment -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetMaternalEnrollment')
	drop proc uspGetMaternalEnrollment
go

create proc uspGetMaternalEnrollment(
@ANCNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from MaternalEnrollment where ANCNo = @ANCNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ANCNo No', @ANCNo, 'Maternal Enrollment')
		return 1
	end
else
begin
	select  ANCNo, MaternalEnrollment.PatientNo, HIVStatusID, dbo.GetLookupDataDes(HIVStatusID) as [HIVStatus], PartnersHIVStatusID, dbo.GetLookupDataDes(PartnersHIVStatusID) as [PartnersHIVStatus],
	Gravida, Para,LNMP, LNMPDateReliable, CycleRegularID,EDD, ScanDate,
	dbo.GetLookupDataDes(CycleRegularID) as [CycleRegular], dbo.GetLookupDataName(MedicalHistory) as MedicalHistory,
	MedicalHistoryNotes, dbo.GetLookupDataName(BloodTransfusion) as BloodTransfusion,BloodTransfusionDate,
	dbo.GetLookupDataName(SurgicalHistory) as SurgicalHistory,SurgicalHistoryNotes,
	dbo.GetLookupDataName(GynaecologicalHistory) as GynaecologicalHistory,GynaecologicalHistoryNotes,
	dbo.GetLookupDataName(FamilyHistory) as FamilyHistory , FamilyHistoryNotes,dbo.GetLookupDataName(SocialHistory) as SocialHistory ,
	SocialHistoryNotes, PatientStatusID, dbo.GetLookupDataDes(PatientStatusID) as [PatientStatus], BloodGroupID, dbo.GetLookupDataDes(BloodGroupID) as BloodGroup,
	Visits.VisitDate, Patients.PatientNo, dbo.GetHidePatientDetails(FirstName,HideDetails) as FirstName, dbo.GetHidePatientDetails(LastName,HideDetails) as LastName, 
	dbo.GetHidePatientDetails(MiddleName,HideDetails) as MiddleName, dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName, BirthDate, JoinDate, ReferenceNo,
	Photo, dbo.GetHidePatientDetails(Patients.Phone,HideDetails) as Phone, isnull(dbo.GetLastVisitDate(Patients.PatientNo),JoinDate) as LastVisitDate,
	dbo.GetTotalVisits(Patients.PatientNo) as TotalVisits, dbo.GetHasTriage(Visits.VisitNo) as HasTriage, Weight, Temperature, 
	Height, Pulse, BloodPressure, HeadCircum, BodySurfaceArea, RespirationRate,
	OxygenSaturation, HeartRate, dbo.CalculateBMI(Weight, Height/100) as BMI, Triage.Notes As Notes,
	MUAC, dbo.GetLookupDataDes(Triage.BMIStatusID)as BMIStatus
	from MaternalEnrollment
	inner join Patients on Patients.PatientNo  = MaternalEnrollment.PatientNo
	inner join Visits on Visits.PatientNo = Patients.PatientNo
	left outer join Triage on Triage.VisitNo = Visits.VisitNo
	where ANCNo = @ANCNo
return 0
end
go
go

-- exec uspGetMaternalEnrollment 'PLH395453001' ******************************************************************************************************/
-- select * from MaternalEnrollment
-- delete from MaternalEnrollment

--------GetPeriodicMaternalEnrollment----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPeriodicMaternalEnrollment')
	drop proc uspGetPeriodicMaternalEnrollment
go

create proc uspGetPeriodicMaternalEnrollment(
@StartDate smalldatetime,
@EndDate smalldatetime
)with encryption as
declare @ActiveStatusID varchar(10)
set @ActiveStatusID = dbo.GetLookupDataID('Status','A')
begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,
			dbo.FormatText(Visits.VisitNo, 'Visits', 'VisitNo') as VisitNo, ANCNo, FirstName,
			dbo.FormatDate(VisitDate) as VisitDate,
			dbo.GetHidePatientDetails(dbo.GetFullName(LastName, MiddleName, FirstName),HideDetails) as FullName,
			dbo.GetLookupDataDes(GenderID) as Gender, PatientStatusID,
			dbo.GetAge(BirthDate, getdate()) as Age,
			dbo.GetLookupDataDes(BillModesID) as BillMode,
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName,
			dbo.GetLookupDataDes(CoPayTypeID) as CoPayType, CoPayPercent, CoPayValue, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.FormatDate(Visits.RecordDateTime) as RecordDate,
			dbo.GetTime(Visits.RecordDateTime) as RecordTime
	from MaternalEnrollment
	inner join Patients on MaternalEnrollment.PatientNo = Patients.PatientNo
	inner join Visits on Visits.PatientNo = Patients.PatientNo
	where dbo.GetShortDate(MaternalEnrollment.RecordDateTime) between @StartDate and @EndDate and PatientStatusID = @ActiveStatusID
	order by ANCNo desc, VisitDate asc, VisitNo asc
end
return 0
go
-- select * from  MaternalEnrollment
-- exec uspGetPeriodicMaternalEnrollment 'Jan 1, 2018', 'Apr 30, 2019'


---------------------------------------------------------------------------------------------------------------------------------------------------
--------CheckMaternalEnrollmentAttendance--------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCheckMaternalEnrollmentAttendance')
	drop proc uspCheckMaternalEnrollmentAttendance
go

create proc uspCheckMaternalEnrollmentAttendance(
@PatientNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

   begin
		select top 1 Patients.PatientNo, MaternalEnrollment.PatientNo,
		JoinDate
		from MaternalEnrollment 
		inner join Patients on MaternalEnrollment.PatientNo = Patients.PatientNo
		where Patients.PatientNo = @PatientNo order by ANCID desc
	end

return 0
go

---------------------------------------------------------------------------------------------------------------------------------------------------
--------CheckMaternalEnrollmentStatus--------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspCheckMaternalEnrollmentStatus')
	drop proc uspCheckMaternalEnrollmentStatus
go

create proc uspCheckMaternalEnrollmentStatus(
@PatientNo varchar(20)
)with encryption as

begin 

select top 1  PatientStatusID from MaternalEnrollment 
inner join Patients on MaternalEnrollment.PatientNo = Patients.PatientNo
where Patients.PatientNo = @PatientNo

end
return 0
go

-- exec uspCheckMaternalEnrollmentStatus 'PLH395453'
------------------------------------------------------------------------------------------------------
-------------- SuspiciousLogins --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert SuspiciousLogins -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertSuspiciousLogins')
	drop proc uspInsertSuspiciousLogins
go

create proc uspInsertSuspiciousLogins(
@Username varchar(20),
@Details varchar(200)
)with encryption as

declare @ErrorMSG varchar(200)

begin
insert into SuspiciousLogins
(Username, Details)
values
(@Username, @Details)
return 0
end
go

/******************************************************************************************************
exec uspInsertSuspiciousLogins 'ADMIN','WRONG USERNAME'
******************************************************************************************************/
-- select * from SuspiciousLogins
-- delete from SuspiciousLogins


------------------------------------------------------------------------------------------------------
-------------- Obstetric --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit Obstetric -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditObstetric')
	drop proc uspEditObstetric
go

create proc uspEditObstetric(
@PatientNo Varchar(20),
@Pregnancy int,
@YearPregnant int,
@AbortionID varchar(10),
@AbortionPeriodID varchar(10) = null,
@TypeOfDeliveryID varchar(10) = null,
@ThirdStageID Varchar(10) = null,
@PuerPeriumID Varchar(10) = null,
@ChildStatusID varchar(10) = null,
@GenderID Varchar(10) = null,
@BirthWeight decimal,
@ChildImmunised bit,
@HealthCondition Varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)


if  not exists(select DataID from Lookupdata where DataID = @AbortionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Abortion', @AbortionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @AbortionPeriodID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Abortion Period', @AbortionPeriodID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @TypeOfDeliveryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Type Of Delivery', @TypeOfDeliveryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @ThirdStageID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Third Stage', @ThirdStageID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @PuerPeriumID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Puer Perium', @PuerPeriumID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @ChildStatusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Child Status', @ChildStatusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @GenderID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Gender', @GenderID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select PatientNo from Obstetric where PatientNo = @PatientNo and Pregnancy = @Pregnancy)
	begin
		update Obstetric set
		PatientNo = @PatientNo, Pregnancy = @Pregnancy, YearPregnant = @YearPregnant, AbortionID = @AbortionID, 
		AbortionPeriodID = @AbortionPeriodID, TypeOfDeliveryID = @TypeOfDeliveryID, ThirdStageID = @ThirdStageID,
		PuerPeriumID = @PuerPeriumID, ChildStatusID = @ChildStatusID, GenderID = @GenderID, BirthWeight = @BirthWeight,
		 ChildImmunised = @ChildImmunised, HealthCondition = @HealthCondition
		where PatientNo = @PatientNo and Pregnancy = @Pregnancy
		return 0
	end
else
begin
insert into Obstetric
(PatientNo, Pregnancy, YearPregnant, AbortionID, AbortionPeriodID, TypeOfDeliveryID, ThirdStageID, PuerPeriumID, ChildStatusID, GenderID, BirthWeight, ChildImmunised, HealthCondition, LoginID)
values
(@PatientNo, @Pregnancy, @YearPregnant, @AbortionID, @AbortionPeriodID, @TypeOfDeliveryID, @ThirdStageID, @PuerPeriumID, @ChildStatusID, @GenderID, @BirthWeight, @ChildImmunised, @HealthCondition, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspEditObstetric '160004', 4, 1998, '54Y', '253001', '20601', '21201', '21201', '20601','15F', '3', '0', 'bad', 'Admin'
******************************************************************************************************/
-- select * from Obstetric where datades LIKE 'yes'
-- delete from Obstetric
-- select * from logins


-------------- Get Obstetric -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetObstetric')
	drop proc uspGetObstetric
go

create proc uspGetObstetric(
@PatientNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Obstetric where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Obstetric')
		return 1
	end
else
begin
	select PatientNo, Pregnancy, YearPregnant, AbortionID, dbo.GetLookupDataDes(AbortionID) as [Abortion], AbortionPeriodID, dbo.GetLookupDataDes(AbortionPeriodID) as [AbortionPeriod], TypeOfDeliveryID, dbo.GetLookupDataDes(TypeOfDeliveryID) as [TypeOfDelivery], ThirdStageID, dbo.GetLookupDataDes(ThirdStageID) as [ThirdStage], PuerPeriumID, dbo.GetLookupDataDes(PuerPeriumID) as [PuerPerium], ChildStatusID, dbo.GetLookupDataDes(ChildStatusID) as [Child Status], GenderID, dbo.GetLookupDataDes(GenderID) as [Gender], BirthWeight, ChildImmunised, HealthCondition, Obstetric.LoginID
	from Obstetric
	inner join Logins on Obstetric.LoginID = Logins.LoginID	

	where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspGetObstetric
******************************************************************************************************/
-- select * from Obstetric
-- delete from Obstetric

------------------------------------------------------------------------------------------------------
-------------- ContraceptivesHistory --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit ContraceptivesHistory -----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditContraceptivesHistory')
	drop proc uspEditContraceptivesHistory
go

create proc uspEditContraceptivesHistory(
@PatientNo varchar(20),
@ComplicationsID varchar(10),
@ComplicationDetails varchar(200),
@ContraceptiveID varchar(10),
@DateStarted smalldatetime,
@DiscontinuedRemovedID varchar(10),
@RemovalReasonsID varchar(10),
@Notes varchar(200),
@LoginID varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'Patients')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @ComplicationsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Complications', @ComplicationsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @ContraceptiveID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Contraceptive ', @ContraceptiveID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @DiscontinuedRemovedID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Discontinued /Removed', @DiscontinuedRemovedID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @RemovalReasonsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Removal Reasons', @RemovalReasonsID, 'Lookup Data')
		return 1
	end

	if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select PatientNo from ContraceptivesHistory where PatientNo = @PatientNo and ContraceptiveID = @ContraceptiveID)
	begin
		update ContraceptivesHistory set
		PatientNo = @PatientNo, ComplicationsID = @ComplicationsID, ComplicationDetails = @ComplicationDetails,
		 ContraceptiveID = @ContraceptiveID, DateStarted = @DateStarted, DiscontinuedRemovedID = @DiscontinuedRemovedID,
		 RemovalReasonsID = @RemovalReasonsID, Notes = @Notes

		where PatientNo = @PatientNo and ContraceptiveID = @ContraceptiveID
		return 0
	end
else


begin
insert into ContraceptivesHistory
(PatientNo, ComplicationsID, ComplicationDetails, ContraceptiveID, DateStarted, DiscontinuedRemovedID, RemovalReasonsID, Notes, LoginID)
values
(@PatientNo, @ComplicationsID, @ComplicationDetails, @ContraceptiveID, @DateStarted, @DiscontinuedRemovedID, @RemovalReasonsID, @Notes, @LoginID)
return 0
end
go

-------------- Get ContraceptivesHistory -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetContraceptivesHistory')
	drop proc uspGetContraceptivesHistory
go

create proc uspGetContraceptivesHistory(
@PatientNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from ContraceptivesHistory where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Patient No', @PatientNo, 'ContraceptivesHistory')
		return 1
	end
else
begin
	select PatientNo, ComplicationsID, dbo.GetLookupDataDes(ComplicationsID) as [Complications],
	 dbo.GetLookupDataName(ComplicationDetails) as ComplicationDetails, ContraceptiveID,
	  dbo.GetLookupDataDes(ContraceptiveID) as [Contraceptive ], DateStarted, DiscontinuedRemovedID,
	   dbo.GetLookupDataDes(DiscontinuedRemovedID) as [Discontinued/Removed], RemovalReasonsID, 
	   dbo.GetLookupDataDes(RemovalReasonsID) as [RemovalReasons], Notes, ContraceptivesHistory.LoginID
	from ContraceptivesHistory
	inner join Logins on ContraceptivesHistory.LoginID = Logins.LoginID	

	where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspGetContraceptivesHistory
******************************************************************************************************/
-- select * from ContraceptivesHistory
-- delete from ContraceptivesHistory


------------------------------------------------------------------------------------------------------
-------------- AntenatalVisits --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert AntenatalVisits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAntenatalVisits')
	drop proc uspInsertAntenatalVisits
go

create proc uspInsertAntenatalVisits(
@VisitNo Varchar(20),
@ANCNo Varchar(20),
@PallorID varchar(10),
@JaundiceID varchar(10),
@LynphadenopathyID varchar(10),
@VaricoseID varchar(10),
@OedemaID Varchar(10),
@HeartSoundID Varchar(10),
@AirEntryID varchar(10),
@BreastID Varchar(10),
@LiverID Varchar(10),
@SpleenID Varchar(10),
@BowelSoundsID varchar(10),
@ScarID Varchar(10),
@PupilReactionID Varchar(10),
@ReflexesID Varchar(10),
@OtherSTIID varchar(10),
@STIDetails Varchar(200),
@SkeletalDeformityID Varchar(10),
@AnenorrheaWeeks int,
@FundalHeight varchar(10),
@PresentationID varchar(10),
@LieID varchar(10),
@PositionID varchar(10),
@RelationPPOrBrim varchar(10),
@FoetalHeart int,
@TTGiven bit,
@IPTID varchar(10),
@NetUseID varchar(10),
@Remarks varchar(200),
@ReturnDate smalldatetime,
@DoctorSpecialityID varchar(10),
@DoctorID varchar(10),
@NurseInChargeID varchar(10),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ANCVisitID int

declare @PaddingLEN tinyint

declare @PassedANCVisitID int
declare @PassedANCVisitNo varchar(20)
declare @PassedANCNo varchar(20)

if exists(select VisitNo from AntenatalVisits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, ' Visit No', @VisitNo)
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, ' Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select ANCNo from MaternalEnrollment where ANCNo  = @ANCNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ANC No', @ANCNo, 'MaternalEnrollment')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PallorID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pallor', @PallorID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @JaundiceID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Jaundice', @JaundiceID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LynphadenopathyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lynphadenopathy', @LynphadenopathyID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VaricoseID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Varicose', @VaricoseID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OedemaID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Oedema', @OedemaID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HeartSoundID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Heart Sound', @HeartSoundID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AirEntryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Air Entry', @AirEntryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BreastID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Breast', @BreastID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LiverID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Liver', @LiverID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @SpleenID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Spleen', @SpleenID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BowelSoundsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bowel Sounds', @BowelSoundsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ScarID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Scar', @ScarID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PupilReactionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pupil Reaction', @PupilReactionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ReflexesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Reflexes', @ReflexesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OtherSTIID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Other STIs', @OtherSTIID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @SkeletalDeformityID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Skeletal Deformity', @SkeletalDeformityID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PresentationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Presentation', @PresentationID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LieID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lie', @LieID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PositionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Position', @PositionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @IPTID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'IPT', @IPTID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @NetUseID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Net Use', @NetUseID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DoctorSpecialityID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Doctor Speciality', @DoctorSpecialityID, 'Lookup Data')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @DoctorID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Doctor', @DoctorID, 'Staff')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @NurseInChargeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Nurse In Charge', @NurseInChargeID, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin


----------------------------------------------------------------------------------------------------------

insert into AntenatalVisits
(VisitNo, ANCNo, PallorID, JaundiceID, LynphadenopathyID, VaricoseID, OedemaID, HeartSoundID, AirEntryID, BreastID,
 LiverID, SpleenID, BowelSoundsID, ScarID, PupilReactionID, ReflexesID, OtherSTIID, STIDetails, SkeletalDeformityID,
  AnenorrheaWeeks, FundalHeight, PresentationID, LieID, PositionID, RelationPPOrBrim, FoetalHeart, TTGiven, IPTID, NetUseID,
   Remarks, ReturnDate, DoctorSpecialityID, DoctorID, NurseInChargeID, LoginID)
values
(@VisitNo, @ANCNo, @PallorID, @JaundiceID, @LynphadenopathyID, @VaricoseID, @OedemaID, @HeartSoundID, @AirEntryID, @BreastID, 
@LiverID, @SpleenID, @BowelSoundsID, @ScarID, @PupilReactionID, @ReflexesID, @OtherSTIID, @STIDetails, @SkeletalDeformityID,
 @AnenorrheaWeeks, @FundalHeight, @PresentationID, @LieID, @PositionID,@RelationPPOrBrim, @FoetalHeart, @TTGiven, @IPTID, @NetUseID,
  @Remarks, @ReturnDate, @DoctorSpecialityID, @DoctorID, @NurseInChargeID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertAntenatalVisits
******************************************************************************************************/
-- select * from AntenatalVisits
-- delete from AntenatalVisits


-------------- Update AntenatalVisits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateAntenatalVisits')
	drop proc uspUpdateAntenatalVisits
go

create proc uspUpdateAntenatalVisits(
@VisitNo Varchar(20),
@ANCNo Varchar(20),
@PallorID varchar(10),
@JaundiceID varchar(10),
@LynphadenopathyID varchar(10),
@VaricoseID varchar(10),
@OedemaID Varchar(10),
@HeartSoundID Varchar(10),
@AirEntryID varchar(10),
@BreastID Varchar(10),
@LiverID Varchar(10),
@SpleenID Varchar(10),
@BowelSoundsID varchar(10),
@ScarID Varchar(10),
@PupilReactionID Varchar(10),
@ReflexesID Varchar(10),
@OtherSTIID varchar(10),
@STIDetails Varchar(200),
@SkeletalDeformityID Varchar(10),
@AnenorrheaWeeks int,
@FundalHeight varchar(10),
@PresentationID varchar(10),
@LieID varchar(10),
@PositionID varchar(10),
@RelationPPOrBrim varchar(10),
@FoetalHeart int,
@TTGiven bit,
@IPTID varchar(10),
@NetUseID varchar(10),
@Remarks varchar(200),
@ReturnDate smalldatetime,
@DoctorSpecialityID varchar(10),
@DoctorID varchar(10),
@NurseInChargeID varchar(10),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select VisitNo from AntenatalVisits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'ANC Visit No', @VisitNo)
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, ' Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select ANCNo from MaternalEnrollment where ANCNo  = @ANCNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ANC No', @ANCNo, 'MaternalEnrollment')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PallorID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pallor', @PallorID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @JaundiceID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Jaundice', @JaundiceID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LynphadenopathyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lynphadenopathy', @LynphadenopathyID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VaricoseID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Varicose', @VaricoseID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OedemaID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Oedema', @OedemaID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HeartSoundID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Heart Sound', @HeartSoundID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AirEntryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Air Entry', @AirEntryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BreastID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Breast', @BreastID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LiverID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Liver', @LiverID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @SpleenID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Spleen', @SpleenID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BowelSoundsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bowel Sounds', @BowelSoundsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ScarID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Scar', @ScarID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PupilReactionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pupil Reaction', @PupilReactionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ReflexesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Reflexes', @ReflexesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OtherSTIID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Other STIs', @OtherSTIID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @SkeletalDeformityID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Skeletal Deformity', @SkeletalDeformityID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PresentationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Presentation', @PresentationID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LieID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lie', @LieID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PositionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Position', @PositionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @IPTID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'IPT', @IPTID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @NetUseID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Net Use', @NetUseID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DoctorSpecialityID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Doctor Speciality', @DoctorSpecialityID, 'Lookup Data')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @DoctorID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Doctor', @DoctorID, 'Staff')
		return 1
	end


if not exists(select StaffNo from Staff where StaffNo  = @NurseInChargeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Nurse In Charge', @NurseInChargeID, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update AntenatalVisits set
ANCNo = @ANCNo, PallorID = @PallorID, JaundiceID = @JaundiceID, LynphadenopathyID = @LynphadenopathyID, VaricoseID = @VaricoseID,
 OedemaID = @OedemaID, HeartSoundID = @HeartSoundID, AirEntryID = @AirEntryID, BreastID = @BreastID, LiverID = @LiverID, 
 SpleenID = @SpleenID, BowelSoundsID = @BowelSoundsID, ScarID = @ScarID, PupilReactionID = @PupilReactionID, ReflexesID = @ReflexesID,
  OtherSTIID = @OtherSTIID, STIDetails = @STIDetails, SkeletalDeformityID = @SkeletalDeformityID, AnenorrheaWeeks = @AnenorrheaWeeks,
    FundalHeight = @FundalHeight, PresentationID = @PresentationID, LieID = @LieID, PositionID = @PositionID, RelationPPOrBrim = @RelationPPOrBrim,
	 FoetalHeart = @FoetalHeart, TTGiven = @TTGiven, IPTID = @IPTID, NetUseID = @NetUseID, Remarks = @Remarks, ReturnDate = @ReturnDate,
	  DoctorSpecialityID = @DoctorSpecialityID, DoctorID = @DoctorID, NurseInChargeID = @NurseInChargeID, LoginID = @LoginID

where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateAntenatalVisits
******************************************************************************************************/
-- select * from AntenatalVisits
-- delete from AntenatalVisits


-------------- Get AntenatalVisits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAntenatalVisits')
	drop proc uspGetAntenatalVisits
go

create proc uspGetAntenatalVisits(
@VisitNo Varchar(20) = null,
@ANCNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@VisitNo is null) and (@ANCNo is null))
begin
	if not exists(select VisitNo from AntenatalVisits where VisitNo = @VisitNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Antenatal Visits')
			return 1
		end
	else

begin
	select VisitNo, AntenatalVisits.ANCNo, PallorID, dbo.GetLookupDataDes(PallorID) as [Pallor], JaundiceID, dbo.GetLookupDataDes(JaundiceID) as [Jaundice], 
	LynphadenopathyID, dbo.GetLookupDataDes(LynphadenopathyID) as [Lynphadenopathy], VaricoseID,
	 dbo.GetLookupDataDes(VaricoseID) as [Varicose], OedemaID, dbo.GetLookupDataDes(OedemaID) as [Oedema], HeartSoundID, 
	 dbo.GetLookupDataDes(HeartSoundID) as [HeartSound], AirEntryID, dbo.GetLookupDataDes(AirEntryID) as [AirEntry], BreastID,
	  dbo.GetLookupDataDes(BreastID) as [Breast], LiverID, dbo.GetLookupDataDes(LiverID) as [Liver], SpleenID,
	   dbo.GetLookupDataDes(SpleenID) as [Spleen], BowelSoundsID, dbo.GetLookupDataDes(BowelSoundsID) as [BowelSounds], ScarID, 
	   dbo.GetLookupDataDes(ScarID) as [Scar], PupilReactionID, dbo.GetLookupDataDes(PupilReactionID) as [PupilReaction], 
	   ReflexesID, dbo.GetLookupDataDes(ReflexesID) as [Reflexes], OtherSTIID, dbo.GetLookupDataDes(OtherSTIID) as [OtherSTIs], 
	   STIDetails, SkeletalDeformityID, dbo.GetLookupDataDes(SkeletalDeformityID) as [SkeletalDeformity],AnenorrheaWeeks, FundalHeight,
	    PresentationID,dbo.GetLookupDataDes(PresentationID) as [Presentation], LieID, dbo.GetLookupDataDes(LieID) as [Lie],PositionID,dbo.GetLookupDataDes(PositionID) as [Position], RelationPPOrBrim, 
		FoetalHeart, TTGiven, IPTID, dbo.GetLookupDataDes(IPTID) as [IPT], NetUseID,dbo.GetLookupDataDes(NetUseID) as [NetUse], Remarks, ReturnDate, DoctorSpecialityID, dbo.GetLookupDataDes(DoctorSpecialityID) as [DoctorSpeciality], 
		  AntenatalVisits.DoctorID, NurseInChargeID, dbo.GetLookupDataDes(NurseInChargeID), AntenatalVisits.LoginID
	from AntenatalVisits
	inner join MaternalEnrollment on AntenatalVisits.ANCNo = MaternalEnrollment.ANCNo
	inner join Staff on AntenatalVisits.DoctorID = Staff.StaffNo 	
	inner join Logins on AntenatalVisits.LoginID = Logins.LoginID	

	where VisitNo = @VisitNo
	end

end
else
if ((@VisitNo is null) and not (@ANCNo is null))
begin
		select VisitNo, ANCNo
		from AntenatalVisits
		where ANCNo = @ANCNo
		order by VisitNo desc
end
else
if  ((@VisitNo is null) and (@ANCNo is null))
begin
	select VisitNo, AntenatalVisits.ANCNo, PallorID, dbo.GetLookupDataDes(PallorID) as [Pallor], JaundiceID, dbo.GetLookupDataDes(JaundiceID) as [Jaundice], 
	LynphadenopathyID, dbo.GetLookupDataDes(LynphadenopathyID) as [Lynphadenopathy], VaricoseID,
	 dbo.GetLookupDataDes(VaricoseID) as [Varicose], OedemaID, dbo.GetLookupDataDes(OedemaID) as [Oedema], HeartSoundID, 
	 dbo.GetLookupDataDes(HeartSoundID) as [HeartSound], AirEntryID, dbo.GetLookupDataDes(AirEntryID) as [AirEntry], BreastID,
	  dbo.GetLookupDataDes(BreastID) as [Breast], LiverID, dbo.GetLookupDataDes(LiverID) as [Liver], SpleenID,
	   dbo.GetLookupDataDes(SpleenID) as [Spleen], BowelSoundsID, dbo.GetLookupDataDes(BowelSoundsID) as [BowelSounds], ScarID, 
	   dbo.GetLookupDataDes(ScarID) as [Scar], PupilReactionID, dbo.GetLookupDataDes(PupilReactionID) as [PupilReaction], 
	   ReflexesID, dbo.GetLookupDataDes(ReflexesID) as [Reflexes], OtherSTIID, dbo.GetLookupDataDes(OtherSTIID) as [OtherSTIs], 
	   STIDetails, SkeletalDeformityID, dbo.GetLookupDataDes(SkeletalDeformityID) as [SkeletalDeformity],AnenorrheaWeeks, FundalHeight,
	    PresentationID,dbo.GetLookupDataDes(PresentationID) as [Presentation], LieID, dbo.GetLookupDataDes(LieID) as [Lie],PositionID,dbo.GetLookupDataDes(PositionID) as [Position], RelationPPOrBrim, 
		FoetalHeart, TTGiven,IPTID, dbo.GetLookupDataDes(IPTID) as [IPT], NetUseID,dbo.GetLookupDataDes(NetUseID) as [NetUse],Remarks, ReturnDate, DoctorSpecialityID, dbo.GetLookupDataDes(DoctorSpecialityID) as [DoctorSpeciality], 
		  AntenatalVisits.DoctorID, NurseInChargeID, dbo.GetLookupDataDes(NurseInChargeID), AntenatalVisits.LoginID
	from AntenatalVisits
	inner join MaternalEnrollment on AntenatalVisits.ANCNo = MaternalEnrollment.ANCNo
	inner join Staff on AntenatalVisits.DoctorID = Staff.StaffNo 	
	inner join Logins on AntenatalVisits.LoginID = Logins.LoginID	

	where VisitNo = @VisitNo
	end
return 0
go


/******************************************************************************************************
exec uspGetAntenatalVisits
******************************************************************************************************/
-- select * from AntenatalVisits
-- delete from AntenatalVisits

--------GetAntenatalVisitsByANCNo------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAntenatalVisitsByANCNo')
	drop proc uspGetAntenatalVisitsByANCNo
go

create proc uspGetAntenatalVisitsByANCNo(
@ANCNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ANCNo from AntenatalVisits where ANCNo = @ANCNo)
begin
	set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
	raiserror(@ErrorMSG,16,1, 'ANC No', @ANCNo, 'Antenatal Visits')	
	return 1
end
else
begin
	select VisitNo from AntenatalVisits
	where ANCNo = @ANCNo order by VisitNo
end
return 0
go


------------------------------------------------------------------------------------------------------
-------------- AntenatalVisits --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert AntenatalVisits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAntenatalVisits')
	drop proc uspInsertAntenatalVisits
go

create proc uspInsertAntenatalVisits(
@VisitNo Varchar(20),
@ANCNo Varchar(20),
@PallorID varchar(10),
@JaundiceID varchar(10),
@LynphadenopathyID varchar(10),
@VaricoseID varchar(10),
@OedemaID Varchar(10),
@HeartSoundID Varchar(10),
@AirEntryID varchar(10),
@BreastID Varchar(10),
@LiverID Varchar(10),
@SpleenID Varchar(10),
@BowelSoundsID varchar(10),
@ScarID Varchar(10),
@PupilReactionID Varchar(10),
@ReflexesID Varchar(10),
@OtherSTIID varchar(10),
@STIDetails Varchar(200),
@SkeletalDeformityID Varchar(10),
@AnenorrheaWeeks int,
@FundalHeight varchar(10),
@PresentationID varchar(10),
@LieID varchar(10),
@PositionID varchar(10),
@RelationPPOrBrim varchar(10),
@FoetalHeart int,
@TTGiven bit,
@IPTID varchar(10),
@NetUseID varchar(10),
@Remarks varchar(200),
@ReturnDate smalldatetime,
@DoctorSpecialityID varchar(10),
@DoctorID varchar(10),
@NurseInChargeID varchar(10),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @ANCVisitID int

declare @PaddingLEN tinyint

declare @PassedANCVisitID int
declare @PassedANCVisitNo varchar(20)
declare @PassedANCNo varchar(20)

if exists(select VisitNo from AntenatalVisits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, ' Visit No', @VisitNo)
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, ' Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select ANCNo from MaternalEnrollment where ANCNo  = @ANCNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ANC No', @ANCNo, 'MaternalEnrollment')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PallorID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pallor', @PallorID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @JaundiceID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Jaundice', @JaundiceID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LynphadenopathyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lynphadenopathy', @LynphadenopathyID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VaricoseID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Varicose', @VaricoseID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OedemaID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Oedema', @OedemaID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HeartSoundID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Heart Sound', @HeartSoundID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AirEntryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Air Entry', @AirEntryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BreastID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Breast', @BreastID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LiverID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Liver', @LiverID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @SpleenID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Spleen', @SpleenID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BowelSoundsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bowel Sounds', @BowelSoundsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ScarID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Scar', @ScarID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PupilReactionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pupil Reaction', @PupilReactionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ReflexesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Reflexes', @ReflexesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OtherSTIID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Other STIs', @OtherSTIID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @SkeletalDeformityID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Skeletal Deformity', @SkeletalDeformityID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PresentationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Presentation', @PresentationID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LieID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lie', @LieID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PositionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Position', @PositionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @IPTID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'IPT', @IPTID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @NetUseID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Net Use', @NetUseID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DoctorSpecialityID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Doctor Speciality', @DoctorSpecialityID, 'Lookup Data')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @DoctorID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Doctor', @DoctorID, 'Staff')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @NurseInChargeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Nurse In Charge', @NurseInChargeID, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin


----------------------------------------------------------------------------------------------------------

insert into AntenatalVisits
(VisitNo, ANCNo, PallorID, JaundiceID, LynphadenopathyID, VaricoseID, OedemaID, HeartSoundID, AirEntryID, BreastID,
 LiverID, SpleenID, BowelSoundsID, ScarID, PupilReactionID, ReflexesID, OtherSTIID, STIDetails, SkeletalDeformityID,
  AnenorrheaWeeks, FundalHeight, PresentationID, LieID, PositionID, RelationPPOrBrim, FoetalHeart, TTGiven, IPTID, NetUseID,
   Remarks, ReturnDate, DoctorSpecialityID, DoctorID, NurseInChargeID, LoginID)
values
(@VisitNo, @ANCNo, @PallorID, @JaundiceID, @LynphadenopathyID, @VaricoseID, @OedemaID, @HeartSoundID, @AirEntryID, @BreastID, 
@LiverID, @SpleenID, @BowelSoundsID, @ScarID, @PupilReactionID, @ReflexesID, @OtherSTIID, @STIDetails, @SkeletalDeformityID,
 @AnenorrheaWeeks, @FundalHeight, @PresentationID, @LieID, @PositionID,@RelationPPOrBrim, @FoetalHeart, @TTGiven, @IPTID, @NetUseID,
  @Remarks, @ReturnDate, @DoctorSpecialityID, @DoctorID, @NurseInChargeID, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertAntenatalVisits
******************************************************************************************************/
-- select * from AntenatalVisits
-- delete from AntenatalVisits


-------------- Update AntenatalVisits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateAntenatalVisits')
	drop proc uspUpdateAntenatalVisits
go

create proc uspUpdateAntenatalVisits(
@VisitNo Varchar(20),
@ANCNo Varchar(20),
@PallorID varchar(10),
@JaundiceID varchar(10),
@LynphadenopathyID varchar(10),
@VaricoseID varchar(10),
@OedemaID Varchar(10),
@HeartSoundID Varchar(10),
@AirEntryID varchar(10),
@BreastID Varchar(10),
@LiverID Varchar(10),
@SpleenID Varchar(10),
@BowelSoundsID varchar(10),
@ScarID Varchar(10),
@PupilReactionID Varchar(10),
@ReflexesID Varchar(10),
@OtherSTIID varchar(10),
@STIDetails Varchar(200),
@SkeletalDeformityID Varchar(10),
@AnenorrheaWeeks int,
@FundalHeight varchar(10),
@PresentationID varchar(10),
@LieID varchar(10),
@PositionID varchar(10),
@RelationPPOrBrim varchar(10),
@FoetalHeart int,
@TTGiven bit,
@IPTID varchar(10),
@NetUseID varchar(10),
@Remarks varchar(200),
@ReturnDate smalldatetime,
@DoctorSpecialityID varchar(10),
@DoctorID varchar(10),
@NurseInChargeID varchar(10),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select VisitNo from AntenatalVisits where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'ANC Visit No', @VisitNo)
		return 1
	end

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, ' Visit No', @VisitNo, 'Visits')
		return 1
	end

if not exists(select ANCNo from MaternalEnrollment where ANCNo  = @ANCNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ANC No', @ANCNo, 'MaternalEnrollment')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PallorID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pallor', @PallorID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @JaundiceID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Jaundice', @JaundiceID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LynphadenopathyID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lynphadenopathy', @LynphadenopathyID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @VaricoseID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Varicose', @VaricoseID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OedemaID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Oedema', @OedemaID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @HeartSoundID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Heart Sound', @HeartSoundID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @AirEntryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Air Entry', @AirEntryID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BreastID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Breast', @BreastID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LiverID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Liver', @LiverID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @SpleenID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Spleen', @SpleenID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @BowelSoundsID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Bowel Sounds', @BowelSoundsID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ScarID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Scar', @ScarID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PupilReactionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Pupil Reaction', @PupilReactionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @ReflexesID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Reflexes', @ReflexesID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @OtherSTIID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Other STIs', @OtherSTIID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @SkeletalDeformityID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Skeletal Deformity', @SkeletalDeformityID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PresentationID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Presentation', @PresentationID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @LieID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Lie', @LieID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @PositionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Position', @PositionID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @IPTID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'IPT', @IPTID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @NetUseID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Net Use', @NetUseID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @DoctorSpecialityID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Doctor Speciality', @DoctorSpecialityID, 'Lookup Data')
		return 1
	end

if not exists(select StaffNo from Staff where StaffNo  = @DoctorID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Doctor', @DoctorID, 'Staff')
		return 1
	end


if not exists(select StaffNo from Staff where StaffNo  = @NurseInChargeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Nurse In Charge', @NurseInChargeID, 'Staff')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update AntenatalVisits set
ANCNo = @ANCNo, PallorID = @PallorID, JaundiceID = @JaundiceID, LynphadenopathyID = @LynphadenopathyID, VaricoseID = @VaricoseID,
 OedemaID = @OedemaID, HeartSoundID = @HeartSoundID, AirEntryID = @AirEntryID, BreastID = @BreastID, LiverID = @LiverID, 
 SpleenID = @SpleenID, BowelSoundsID = @BowelSoundsID, ScarID = @ScarID, PupilReactionID = @PupilReactionID, ReflexesID = @ReflexesID,
  OtherSTIID = @OtherSTIID, STIDetails = @STIDetails, SkeletalDeformityID = @SkeletalDeformityID, AnenorrheaWeeks = @AnenorrheaWeeks,
    FundalHeight = @FundalHeight, PresentationID = @PresentationID, LieID = @LieID, PositionID = @PositionID, RelationPPOrBrim = @RelationPPOrBrim,
	 FoetalHeart = @FoetalHeart, TTGiven = @TTGiven, IPTID = @IPTID, NetUseID = @NetUseID, Remarks = @Remarks, ReturnDate = @ReturnDate,
	  DoctorSpecialityID = @DoctorSpecialityID, DoctorID = @DoctorID, NurseInChargeID = @NurseInChargeID, LoginID = @LoginID

where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateAntenatalVisits
******************************************************************************************************/
-- select * from AntenatalVisits
-- delete from AntenatalVisits


-------------- Get AntenatalVisits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAntenatalVisits')
	drop proc uspGetAntenatalVisits
go

create proc uspGetAntenatalVisits(
@VisitNo Varchar(20) = null,
@ANCNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if (not (@VisitNo is null) and (@ANCNo is null))
begin
	if not exists(select VisitNo from AntenatalVisits where VisitNo = @VisitNo)
		begin
			set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
			raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Antenatal Visits')
			return 1
		end
	else

begin
	select VisitNo, AntenatalVisits.ANCNo, PallorID, dbo.GetLookupDataDes(PallorID) as [Pallor], JaundiceID, dbo.GetLookupDataDes(JaundiceID) as [Jaundice], 
	LynphadenopathyID, dbo.GetLookupDataDes(LynphadenopathyID) as [Lynphadenopathy], VaricoseID,
	 dbo.GetLookupDataDes(VaricoseID) as [Varicose], OedemaID, dbo.GetLookupDataDes(OedemaID) as [Oedema], HeartSoundID, 
	 dbo.GetLookupDataDes(HeartSoundID) as [HeartSound], AirEntryID, dbo.GetLookupDataDes(AirEntryID) as [AirEntry], BreastID,
	  dbo.GetLookupDataDes(BreastID) as [Breast], LiverID, dbo.GetLookupDataDes(LiverID) as [Liver], SpleenID,
	   dbo.GetLookupDataDes(SpleenID) as [Spleen], BowelSoundsID, dbo.GetLookupDataDes(BowelSoundsID) as [BowelSounds], ScarID, 
	   dbo.GetLookupDataDes(ScarID) as [Scar], PupilReactionID, dbo.GetLookupDataDes(PupilReactionID) as [PupilReaction], 
	   ReflexesID, dbo.GetLookupDataDes(ReflexesID) as [Reflexes], OtherSTIID, dbo.GetLookupDataDes(OtherSTIID) as [OtherSTIs], 
	   STIDetails, SkeletalDeformityID, dbo.GetLookupDataDes(SkeletalDeformityID) as [SkeletalDeformity],AnenorrheaWeeks, FundalHeight,
	    PresentationID,dbo.GetLookupDataDes(PresentationID) as [Presentation], LieID, dbo.GetLookupDataDes(LieID) as [Lie],PositionID,dbo.GetLookupDataDes(PositionID) as [Position], RelationPPOrBrim, 
		FoetalHeart, TTGiven, IPTID, dbo.GetLookupDataDes(IPTID) as [IPT], NetUseID,dbo.GetLookupDataDes(NetUseID) as [NetUse], Remarks, ReturnDate, DoctorSpecialityID, dbo.GetLookupDataDes(DoctorSpecialityID) as [DoctorSpeciality], 
		  AntenatalVisits.DoctorID, NurseInChargeID, dbo.GetLookupDataDes(NurseInChargeID), AntenatalVisits.LoginID
	from AntenatalVisits
	inner join MaternalEnrollment on AntenatalVisits.ANCNo = MaternalEnrollment.ANCNo
	inner join Staff on AntenatalVisits.DoctorID = Staff.StaffNo 	
	inner join Logins on AntenatalVisits.LoginID = Logins.LoginID	

	where VisitNo = @VisitNo
	end

end
else
if ((@VisitNo is null) and not (@ANCNo is null))
begin
		select VisitNo, ANCNo
		from AntenatalVisits
		where ANCNo = @ANCNo
		order by VisitNo desc
end
else
if  ((@VisitNo is null) and (@ANCNo is null))
begin
	select VisitNo, AntenatalVisits.ANCNo, PallorID, dbo.GetLookupDataDes(PallorID) as [Pallor], JaundiceID, dbo.GetLookupDataDes(JaundiceID) as [Jaundice], 
	LynphadenopathyID, dbo.GetLookupDataDes(LynphadenopathyID) as [Lynphadenopathy], VaricoseID,
	 dbo.GetLookupDataDes(VaricoseID) as [Varicose], OedemaID, dbo.GetLookupDataDes(OedemaID) as [Oedema], HeartSoundID, 
	 dbo.GetLookupDataDes(HeartSoundID) as [HeartSound], AirEntryID, dbo.GetLookupDataDes(AirEntryID) as [AirEntry], BreastID,
	  dbo.GetLookupDataDes(BreastID) as [Breast], LiverID, dbo.GetLookupDataDes(LiverID) as [Liver], SpleenID,
	   dbo.GetLookupDataDes(SpleenID) as [Spleen], BowelSoundsID, dbo.GetLookupDataDes(BowelSoundsID) as [BowelSounds], ScarID, 
	   dbo.GetLookupDataDes(ScarID) as [Scar], PupilReactionID, dbo.GetLookupDataDes(PupilReactionID) as [PupilReaction], 
	   ReflexesID, dbo.GetLookupDataDes(ReflexesID) as [Reflexes], OtherSTIID, dbo.GetLookupDataDes(OtherSTIID) as [OtherSTIs], 
	   STIDetails, SkeletalDeformityID, dbo.GetLookupDataDes(SkeletalDeformityID) as [SkeletalDeformity],AnenorrheaWeeks, FundalHeight,
	    PresentationID,dbo.GetLookupDataDes(PresentationID) as [Presentation], LieID, dbo.GetLookupDataDes(LieID) as [Lie],PositionID,dbo.GetLookupDataDes(PositionID) as [Position], RelationPPOrBrim, 
		FoetalHeart, TTGiven,IPTID, dbo.GetLookupDataDes(IPTID) as [IPT], NetUseID,dbo.GetLookupDataDes(NetUseID) as [NetUse],Remarks, ReturnDate, DoctorSpecialityID, dbo.GetLookupDataDes(DoctorSpecialityID) as [DoctorSpeciality], 
		  AntenatalVisits.DoctorID, NurseInChargeID, dbo.GetLookupDataDes(NurseInChargeID), AntenatalVisits.LoginID
	from AntenatalVisits
	inner join MaternalEnrollment on AntenatalVisits.ANCNo = MaternalEnrollment.ANCNo
	inner join Staff on AntenatalVisits.DoctorID = Staff.StaffNo 	
	inner join Logins on AntenatalVisits.LoginID = Logins.LoginID	

	where VisitNo = @VisitNo
	end
return 0
go


/******************************************************************************************************
exec uspGetAntenatalVisits
******************************************************************************************************/
-- select * from AntenatalVisits
-- delete from AntenatalVisits

--------GetAntenatalVisitsByANCNo------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAntenatalVisitsByANCNo')
	drop proc uspGetAntenatalVisitsByANCNo
go

create proc uspGetAntenatalVisitsByANCNo(
@ANCNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ANCNo from AntenatalVisits where ANCNo = @ANCNo)
begin
	set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
	raiserror(@ErrorMSG,16,1, 'ANC No', @ANCNo, 'Antenatal Visits')	
	return 1
end
else
begin
	select VisitNo from AntenatalVisits
	where ANCNo = @ANCNo order by VisitNo
end
return 0
go


------------------------------------------------------------------------------------------------------
-------------- PelvicExamination --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PelvicExamination -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPelvicExamination')
	drop proc uspInsertPelvicExamination
go

create proc uspInsertPelvicExamination(
@VisitNo Varchar(20),
@ANCNo varchar(20),
@VulvaID Varchar(10),
@CervixID varchar(10),
@AdnexaID Varchar(10),
@VaginaID Varchar(10),
@UterusID Varchar(10),
@DiagonalConjugate int,
@SacralCurve int,
@IschialSpine int,
@SubPublicAngle int,
@IschialTuberosities int,
@ConclusionID varchar(10),
@RiskFactors varchar(200),
@Recommendations varchar(200),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'Visits')
		return 1
	end

if exists(select VisitNo from PelvicExamination where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo)
		return 1
	end

if not exists(select ANCNo from MaternalEnrollment where ANCNo  = @ANCNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ANC No', @ANCNo, 'MaternalEnrollment')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @VulvaID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Vulva', @VulvaID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @CervixID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cervix', @CervixID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @AdnexaID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Adnexa', @AdnexaID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @VaginaID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Vagina', @VaginaID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @UterusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Uterus', @UterusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @ConclusionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Conclusion', @ConclusionID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into PelvicExamination
(VisitNo, ANCNo, VulvaID, CervixID, AdnexaID, VaginaID, UterusID, DiagonalConjugate, SacralCurve, IschialSpine, SubPublicAngle, IschialTuberosities, ConclusionID, RiskFactors, Recommendations, LoginID)
values
(@VisitNo, @ANCNo, @VulvaID, @CervixID, @AdnexaID, @VaginaID, @UterusID, @DiagonalConjugate, @SacralCurve, @IschialSpine, @SubPublicAngle, @IschialTuberosities, @ConclusionID, @RiskFactors, @Recommendations, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertPelvicExamination
******************************************************************************************************/
-- select * from PelvicExamination
-- delete from PelvicExamination


-------------- Update PelvicExamination -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePelvicExamination')
	drop proc uspUpdatePelvicExamination
go

create proc uspUpdatePelvicExamination(
@VisitNo Varchar(20),
@ANCNo varchar(20),
@VulvaID Varchar(10),
@CervixID varchar(10),
@AdnexaID Varchar(10),
@VaginaID Varchar(10),
@UterusID Varchar(10),
@DiagonalConjugate int,
@SacralCurve int,
@IschialSpine int,
@SubPublicAngle int,
@IschialTuberosities int,
@ConclusionID varchar(10),
@RiskFactors varchar(200),
@Recommendations varchar(200),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from PelvicExamination where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'PelvicExamination')
		return 1
	end

if not exists(select ANCNo from MaternalEnrollment where ANCNo  = @ANCNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ANC No', @ANCNo, 'MaternalEnrollment')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @VulvaID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Vulva', @VulvaID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @CervixID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Cervix', @CervixID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @AdnexaID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Adnexa', @AdnexaID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @VaginaID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Vagina', @VaginaID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @UterusID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Uterus', @UterusID, 'Lookup Data')
		return 1
	end

if not exists(select DataID from Lookupdata where DataID = @ConclusionID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Conclusion', @ConclusionID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update PelvicExamination set
ANCNo = @ANCNo, VulvaID = @VulvaID, CervixID = @CervixID, AdnexaID = @AdnexaID, VaginaID = @VaginaID,
 UterusID = @UterusID, DiagonalConjugate = @DiagonalConjugate, SacralCurve = @SacralCurve, IschialSpine = @IschialSpine, 
 SubPublicAngle = @SubPublicAngle, IschialTuberosities = @IschialTuberosities, ConclusionID = @ConclusionID, RiskFactors = @RiskFactors,
  Recommendations = @Recommendations, LoginID = @LoginID
where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspUpdatePelvicExamination
******************************************************************************************************/
-- select * from PelvicExamination
-- delete from PelvicExamination


-------------- Get PelvicExamination -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPelvicExamination')
	drop proc uspGetPelvicExamination
go

create proc uspGetPelvicExamination(
@VisitNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from PelvicExamination where VisitNo = @VisitNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Visit No', @VisitNo, 'PelvicExamination')
		return 1
	end
else
begin
	select VisitNo, PelvicExamination.ANCNo, VulvaID, dbo.GetLookupDataDes(VulvaID) as [Vulva], CervixID,
	 dbo.GetLookupDataDes(CervixID) as [Cervix], AdnexaID, dbo.GetLookupDataDes(AdnexaID) as [Adnexa], VaginaID,
	  dbo.GetLookupDataDes(VaginaID) as [Vagina], UterusID, dbo.GetLookupDataDes(UterusID) as [Uterus], DiagonalConjugate,
	   SacralCurve, IschialSpine, SubPublicAngle, IschialTuberosities, ConclusionID, dbo.GetLookupDataDes(ConclusionID) as [Conclusion], 
	   RiskFactors, Recommendations, PelvicExamination.LoginID
	from PelvicExamination
	inner join MaternalEnrollment on PelvicExamination.ANCNo = MaternalEnrollment.ANCNo	
	inner join Logins on PelvicExamination.LoginID = Logins.LoginID	

	where VisitNo = @VisitNo
return 0
end
go

/******************************************************************************************************
exec uspGetPelvicExamination
******************************************************************************************************/
-- select * from PelvicExamination
-- delete from PelvicExamination

------------------------------------------------------------------------------------------------------
-------------- ReceiptReversals --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ReceiptReversals -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertReceiptReversals')
	drop proc uspInsertReceiptReversals
go

create proc uspInsertReceiptReversals(
@ReceiptNo varchar(20),
@RefundNo varchar(20),
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundNo from Refunds where RefundNo  = @RefundNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'RefundNo', @RefundNo, 'Refunds')
		return 1
	end

if exists(select RefundNo from ReceiptReversals where RefundNo = @RefundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'RefundNo', @RefundNo)
		return 1
	end

if not exists(select ReceiptNo from Payments where ReceiptNo  = @ReceiptNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ReceiptNo', @ReceiptNo, 'Payments')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into ReceiptReversals
(ReceiptNo, RefundNo, Notes, LoginID)
values
(@ReceiptNo, @RefundNo, @Notes, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertReceiptReversals '180000006601','180000006601','NA','Admin'
exec uspInsertReceiptReversals '1800000066','180000006601','NA','Admin'
exec uspInsertReceiptReversals '180000006601','180000006601','NA','Admin'
exec uspInsertReceiptReversals '1800000104','180000010401','NA','Admin'

******************************************************************************************************/
-- select * from ReceiptReversals
-- delete from ReceiptReversals


-------------- Update ReceiptReversals -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateReceiptReversals')
	drop proc uspUpdateReceiptReversals
go

create proc uspUpdateReceiptReversals(
@ReceiptNo varchar(20),
@RefundNo varchar(20),
@Notes varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundNo from ReceiptReversals where RefundNo = @RefundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'RefundNo', @RefundNo, 'ReceiptReversals')
		return 1
	end

if not exists(select ReceiptNo from Payments where ReceiptNo  = @ReceiptNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ReceiptNo', @ReceiptNo, 'Payments')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update ReceiptReversals set
ReceiptNo = @ReceiptNo, Notes = @Notes, LoginID = @LoginID
where RefundNo = @RefundNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateReceiptReversals
******************************************************************************************************/
-- select * from ReceiptReversals
-- delete from ReceiptReversals


-------------- Get ReceiptReversals -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetReceiptReversals')
	drop proc uspGetReceiptReversals
go

create proc uspGetReceiptReversals(
@RefundNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select RefundNo from ReceiptReversals where RefundNo = @RefundNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'RefundNo', @RefundNo, 'ReceiptReversals')
		return 1
	end
else
begin
	select ReceiptReversals.ReceiptNo, RefundNo, Notes, ReceiptReversals.LoginID, ClientMachine, RecordDateTime
	from ReceiptReversals
	where RefundNo = @RefundNo
return 0
end
go

/******************************************************************************************************
exec uspGetReceiptReversals
******************************************************************************************************/
-- select * from ReceiptReversals
-- delete from ReceiptReversals

------------------------------------------------------------------------------------------------------
-------------- PackageVisits --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PackageVisits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPackageVisits')
	drop proc uspInsertPackageVisits
go

create proc uspInsertPackageVisits(
@VisitNo varchar(20),
@PatientNo varchar(20),
@PackageNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)
declare @PackageVisitNo varchar(20)
declare @ServiceCode varchar(20)

set @ServiceCode = (select ServiceCode from Visits where VisitNo = @VisitNo)

set @PackageVisitNo = (select top 1 PackageVisitNo from AttachPackage where PatientNo = @PatientNo and PackageNo=@PackageNo
and DATEDIFF(day,PackageStartDate,(PackageEndDate)) > 0 ORDER BY RecordDateTime desc)

if not exists(select VisitNo from Visits where VisitNo  = @VisitNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'Visits')
		return 1
	end

if not exists(select PackageNo from Packages where PackageNo  = @PackageNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PackageNo', @PackageNo, 'Packages')
		return 1
	end

------------------------------------------------------------------------------------------------------------------


---- Check if Package has this consultation

if not exists (select Itemcode from PackagesEXT inner join Visits on Visits.ServiceCode =PackagesEXT.Itemcode
where PackagesEXT.PackageNo =@PackageNo and Visits.VisitNo =@VisitNo )
begin
set @ErrorMSG = 'The %s: %s, you are trying to enter is an Exclusion on this Patient Package.'
raiserror(@ErrorMSG,16,1,'Service Code',@ServiceCode,'PackagesEXT')	
return 1
end


if exists(select VisitNo from PackageVisits where VisitNo = @VisitNo and PackageNo = @PackageNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'PackageNo', @PackageNo)
		return 1
	end

if not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PatientNo', @PatientNo, 'Patients')
		return 1
	end

begin
insert into PackageVisits
(VisitNo, PatientNo, PackageNo,PackageVisitNo)
values
(@VisitNo, @PatientNo, @PackageNo,@PackageVisitNo)
return 0
end
go

/******************************************************************************************************
exec uspInsertPackageVisits
******************************************************************************************************/
-- select * from PackageVisits
-- delete from PackageVisits


-------------- Update PackageVisits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePackageVisits')
	drop proc uspUpdatePackageVisits
go

create proc uspUpdatePackageVisits(
@VisitNo varchar(20),
@PatientNo varchar(20),
@PackageNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from PackageVisits where VisitNo = @VisitNo and PackageNo = @PackageNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'PackageNo', @PackageNo, 'PackageVisits')
		return 1
	end

if not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PatientNo', @PatientNo, 'Patients')
		return 1
	end

begin
update PackageVisits set
PatientNo = @PatientNo
where VisitNo = @VisitNo and PackageNo = @PackageNo
return 0
end
go

/******************************************************************************************************
exec uspUpdatePackageVisits
******************************************************************************************************/
-- select * from PackageVisits
-- delete from PackageVisits


-------------- Get PackageVisits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPackageVisits')
	drop proc uspGetPackageVisits
go

create proc uspGetPackageVisits(
@VisitNo varchar(20),
@PackageNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select VisitNo from PackageVisits where VisitNo = @VisitNo and PackageNo = @PackageNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'VisitNo', @VisitNo, 'PackageNo', @PackageNo, 'PackageVisits')
		return 1
	end
else
begin
	select VisitNo, PackageVisits.PatientNo, PackageNo
	from PackageVisits
	inner join Patients on PackageVisits.PatientNo = Patients.PatientNo
	where VisitNo = @VisitNo and PackageNo = @PackageNo
return 0
end
go

/******************************************************************************************************
exec uspGetPackageVisits
******************************************************************************************************/
-- select * from PackageVisits
-- delete from PackageVisits

------------------------------------------------------------------------------------------------------
-------------- ApprovedLabResults --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert ApprovedLabResults -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertApprovedLabResults')
	drop proc uspInsertApprovedLabResults
go

create proc uspInsertApprovedLabResults(
@SpecimenNo varchar(20),
@TestCode varchar(20),
@TestName varchar(200),
@LoginID varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SpecimenNo from LabResults where SpecimenNo  = @SpecimenNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'SpecimenNo', @SpecimenNo, 'LabResults')
		return 1
	end

if not exists(select TestCode from LabResults where TestCode  = @TestCode)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TestCode', @TestCode, 'LabResults')
		return 1
	end

if exists(select SpecimenNo from ApprovedLabResults where SpecimenNo = @SpecimenNo and TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'SpecimenNo', @SpecimenNo, 'TestCode', @TestCode)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into ApprovedLabResults
(SpecimenNo, TestCode, TestName, LoginID)
values
(@SpecimenNo, @TestCode, @TestName, @LoginID)

--------------------------------------------------------------------------------------
declare @ApprovedStatusID varchar(10)
Set @ApprovedStatusID =dbo.GetLookupDataID('YesNo', 'Y')
	
update LabResults set ApprovedStatusID = @ApprovedStatusID where SpecimenNo = @SpecimenNo and TestCode = @TestCode	
--------------------------------------------------------------------------------------

return 0
end
go

/******************************************************************************************************
exec uspInsertApprovedLabResults
******************************************************************************************************/
-- select * from ApprovedLabResults
-- delete from ApprovedLabResults


-------------- Update ApprovedLabResults -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateApprovedLabResults')
	drop proc uspUpdateApprovedLabResults
go

create proc uspUpdateApprovedLabResults(
@SpecimenNo varchar(20),
@TestCode varchar(20),
@TestName varchar(200),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SpecimenNo from ApprovedLabResults where SpecimenNo = @SpecimenNo and TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'SpecimenNo', @SpecimenNo, 'TestCode', @TestCode, 'ApprovedLabResults')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update ApprovedLabResults set
TestName = @TestName, LoginID = @LoginID
where SpecimenNo = @SpecimenNo and TestCode = @TestCode
return 0
end
go

/******************************************************************************************************
exec uspUpdateApprovedLabResults
******************************************************************************************************/
-- select * from ApprovedLabResults
-- delete from ApprovedLabResults


-------------- Get ApprovedLabResults -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetApprovedLabResults')
	drop proc uspGetApprovedLabResults
go

create proc uspGetApprovedLabResults(
@SpecimenNo varchar(20),
@TestCode varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select SpecimenNo from ApprovedLabResults where SpecimenNo = @SpecimenNo and TestCode = @TestCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'SpecimenNo', @SpecimenNo, 'TestCode', @TestCode, 'ApprovedLabResults')
		return 1
	end
else
begin
	select SpecimenNo, TestCode, TestName, ApprovedLabResults.LoginID, ClientMachine, RecordDateTime
	from ApprovedLabResults
	inner join Logins on ApprovedLabResults.LoginID = Logins.LoginID
	where SpecimenNo = @SpecimenNo and TestCode = @TestCode
return 0
end
go

/******************************************************************************************************
exec uspGetApprovedLabResults
******************************************************************************************************/
-- select * from ApprovedLabResults
-- delete from ApprovedLabResults

------------------------------------------------------------------------------------------------------
-------------- AccountsEXT --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert AccountsEXT -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertAccountsEXT')
	drop proc uspInsertAccountsEXT
go

create proc uspInsertAccountsEXT(
@TranNo varchar(20),
@ReferenceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TranNo from Accounts where TranNo  = @TranNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TranNo', @TranNo, 'Accounts')
		return 1
	end

if not exists(select TranNo from Accounts where TranNo  = @ReferenceNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'ReferenceNo', @ReferenceNo, 'Accounts')
		return 1
	end

if exists(select ReferenceNo from AccountsEXT where ReferenceNo  = @ReferenceNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter has already been Reversed in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Previous Account No', @ReferenceNo, 'Accounts EXT')
		return 1
	end

if exists(select TranNo from AccountsEXT where TranNo = @TranNo and ReferenceNo = @ReferenceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'TranNo', @TranNo, 'ReferenceNo', @ReferenceNo)
		return 1
	end



begin
insert into AccountsEXT
(TranNo, ReferenceNo)
values
(@TranNo, @ReferenceNo)
return 0
end
go

/******************************************************************************************************
exec uspInsertAccountsEXT
******************************************************************************************************/
-- select * from AccountsEXT
-- delete from AccountsEXT



-------------- Get AccountsEXT -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAccountsEXT')
	drop proc uspGetAccountsEXT
go

create proc uspGetAccountsEXT(
@TranNo varchar(20),
@ReferenceNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select TranNo from AccountsEXT where TranNo = @TranNo and ReferenceNo = @ReferenceNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'TranNo', @TranNo, 'ReferenceNo', @ReferenceNo, 'AccountsEXT')
		return 1
	end
else
begin
	select TranNo, ReferenceNo
	from AccountsEXT

	where TranNo = @TranNo and ReferenceNo = @ReferenceNo
return 0
end
go

/******************************************************************************************************
exec uspGetAccountsEXT
******************************************************************************************************/
-- select * from AccountsEXT
-- delete from AccountsEXT

------------------------------------------------------------------------------------------------------
-------------- INTAgents --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert INTAgents -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertINTAgents')
	drop proc uspInsertINTAgents
go

create proc uspInsertINTAgents(
@AgentNo varchar(20),
@AgentName varchar(60),
@LoginID varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)

if exists(select AgentNo from INTAgents where AgentNo = @AgentNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'Agent No', @AgentNo)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
insert into INTAgents
(AgentNo, AgentName, LoginID)
values
(@AgentNo, @AgentName, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertINTAgents
******************************************************************************************************/
-- select * from INTAgents
-- delete from INTAgents


-------------- Update INTAgents -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateINTAgents')
	drop proc uspUpdateINTAgents
go

create proc uspUpdateINTAgents(
@AgentNo varchar(20),
@AgentName varchar(60),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select AgentNo from INTAgents where AgentNo = @AgentNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Agent No', @AgentNo, 'INTAgents')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

begin
update INTAgents set
AgentName = @AgentName, LoginID = @LoginID
where AgentNo = @AgentNo
return 0
end
go

/******************************************************************************************************
exec uspUpdateINTAgents
******************************************************************************************************/
-- select * from INTAgents
-- delete from INTAgents


-------------- Get INTAgents -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetINTAgents')
	drop proc uspGetINTAgents
go

create proc uspGetINTAgents(
@AgentNo varchar(20) = null
)with encryption as

declare @ErrorMSG varchar(200)

if  @AgentNo is not null
begin
if not exists(select AgentNo from INTAgents where AgentNo = @AgentNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Agent No', @AgentNo, 'INTAgents')
		return 1
	end
else
 begin
	select AgentNo, AgentName, INTAgents.LoginID
	from INTAgents
	where AgentNo = @AgentNo
return 0
 end
end
else
begin
	select AgentNo, AgentName, INTAgents.LoginID
	from INTAgents
	return 0
end
go

/******************************************************************************************************
exec uspGetINTAgents 'nav'
******************************************************************************************************/
-- select * from INTAgents
-- delete from INTAgents
------------------------------------------------------------------------------------------------------
-------------- LookupDataMappings --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit LookupDataMappings -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditLookupDataMappings')
	drop proc uspEditLookupDataMappings
go

create proc uspEditLookupDataMappings(
@DataID Varchar(10),
@AgentNo Varchar(20),
@AgentDataID Varchar(10),
@ObjectName Varchar(10),
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)



if not exists(select AgentNo from INTAgents where AgentNo  = @AgentNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Agent No', @AgentNo, 'INTAgents')
		return 1
	end

if not exists(select LoginID from Logins  where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins ')
		return 1
	end
 
 begin
if exists(select DataID from LookupDataMappings where DataID = @DataID and AgentNo = @AgentNo)
	begin
		--update LookupDataMappings set
		--AgentDataID = @AgentDataID, ObjectName = @ObjectName, LoginID = @LoginID
  --   where DataID = @DataID and AgentNo = @AgentNo

  set @ErrorMSG = 'The %s: %s, and %s: %s, you are trying to enter already exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'DataID', @DataID, 'Agent No ', @AgentNo, 'LookupDataMappings')
		return 1
		
	end
else
begin
	insert into LookupDataMappings
	(DataID, AgentNo,AgentDataID, ObjectName, LoginID)
	values
	(@DataID, @AgentNo, @AgentDataID, @ObjectName, @LoginID)
end
return 0
end
go

/******************************************************************************************************
exec uspEditLookupDataMappings
******************************************************************************************************/
-- select * from LookupDataMappings
-- delete from LookupDataMappings



-------------- Get LookupDataMappings -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetLookupDataMappings')
	drop proc uspGetLookupDataMappings
go

create proc uspGetLookupDataMappings(
@DataID Varchar(10),
@AgentNo varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DataID from LookupDataMappings where DataID = @DataID and AgentNo = @AgentNo)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Data ID', @DataID,'Agent No', @AgentNo, 'LookupDataMappings')
		return 1
	end
else
begin
	select LookupDataMappings.DataID, LookupDataMappings.AgentDataID, INTAgents.AgentNo, LookupDataMappings.ObjectName, LookupDataMappings.LoginID
	from LookupDataMappings
	inner join INTAgents on LookupDataMappings.AgentNo = INTAgents.AgentNo	
	inner join Logins  on LookupDataMappings.LoginID = Logins .LoginID
	where DataID = @DataID  and INTAgents.AgentNo = @AgentNo
return 0
end
go

/******************************************************************************************************
exec uspGetLookupDataMappings
******************************************************************************************************/
-- select * from LookupDataMappings
-- delete from LookupDataMappings


------------------------------------------------------------------------------------------------------
-------------- PatientConsent --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert PatientConsent -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspInsertPatientConsent')
	drop proc uspInsertPatientConsent
go

create proc uspInsertPatientConsent(
@PatientNo Varchar(20),
@PhoneNo Varchar(30),
@Notes Varchar(200),
@FingerprintVerified bit,
@LoginID Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from Patients where PatientNo  = @PatientNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PatientNo', @PatientNo, 'Patients')
		return 1
	end

if exists(select PatientNo from PatientConsent where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter already exists'
		raiserror(@ErrorMSG, 16, 1, 'PatientNo', @PatientNo)
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
insert into PatientConsent
(PatientNo, PhoneNo, Notes, FingerprintVerified, LoginID)
values
(@PatientNo, @PhoneNo, @Notes, @FingerprintVerified, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspInsertPatientConsent
******************************************************************************************************/
-- select * from PatientConsent
-- delete from PatientConsent


-------------- Update PatientConsent -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePatientConsent')
	drop proc uspUpdatePatientConsent
go

create proc uspUpdatePatientConsent(
@PatientNo Varchar(20),
@PhoneNo Varchar(30),
@Notes Varchar(200),
@FingerprintVerified bit,
@LoginID Varchar(20),
@ClientMachine Varchar(41),
@RecordDateTime smalldatetime
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from PatientConsent where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PatientNo', @PatientNo, 'PatientConsent')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'LoginID', @LoginID, 'Logins')
		return 1
	end

begin
update PatientConsent set
PhoneNo = @PhoneNo, Notes = @Notes, FingerprintVerified = @FingerprintVerified, LoginID = @LoginID
where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspUpdatePatientConsent
******************************************************************************************************/
-- select * from PatientConsent
-- delete from PatientConsent


-------------- Get PatientConsent -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatientConsent')
	drop proc uspGetPatientConsent
go

create proc uspGetPatientConsent(
@PatientNo Varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select PatientNo from PatientConsent where PatientNo = @PatientNo)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'PatientNo', @PatientNo, 'PatientConsent')
		return 1
	end
else
begin
	select PatientNo, PhoneNo, Notes, FingerprintVerified, PatientConsent.LoginID, ClientMachine, RecordDateTime
	from PatientConsent
	inner join Logins on PatientConsent.LoginID = Logins.LoginID
	where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspGetPatientConsent
******************************************************************************************************/
-- select * from PatientConsent
-- delete from PatientConsent

------------------------------------------------------------------------------------------------------
-------------- BillableMappings --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Insert BillableMappings -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditBillableMappings')
	drop proc uspEditBillableMappings
go

create proc uspEditBillableMappings(
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@MappedTypeID varchar(10),
@AgentNo varchar(20),
@MappedCode varchar(20),
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DataID from LookupData where DataID = @ItemCategoryID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category', @ItemCategoryID, 'Lookup Data')
		return 1
	end


if not exists(select AgentNo from INTAgents where AgentNo  = @AgentNo)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Agent No', @AgentNo, 'INTAgents')
		return 1
	end

if not exists(select DataID from LookupData where DataID = @MappedTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Mapped Type', @MappedTypeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select ItemCategoryID from BillableMappings where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode and MappedTypeID = @MappedTypeID and AgentNo = @AgentNo)
 begin
		update BillableMappings set
	MappedTypeID = @MappedTypeID, MappedCode= @MappedCode
where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode and MappedTypeID = @MappedTypeID and AgentNo = @AgentNo

end
else
begin
insert into BillableMappings
(ItemCategoryID, ItemCode, MappedTypeID, AgentNo, MappedCode, LoginID)
values
(@ItemCategoryID, @ItemCode, @MappedTypeID, @AgentNo, @MappedCode, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspEditBillableMappings '7D', 'DRG0005', '53504', 'NAV', 'A003', 'UGA\GMT'
******************************************************************************************************/
-- select * from BillableMappings order by RecordDateTime desc
-- delete from BillableMappings

-- select * from Logins


-------------- Get BillableMappings -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBillableMappings')
	drop proc uspGetBillableMappings
go

create proc uspGetBillableMappings(
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@MappedCode varchar(20),
@AgentNo varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select ItemCategoryID from BillableMappings where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode and MappedCode = @MappedCode)
	begin
		set @ErrorMSG = 'The record with %s: %s and %s: %s and %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Item Category ID', @ItemCategoryID, 'Item Code', @ItemCode, 'Mapped Code', @MappedCode, 'Agent No', @AgentNo, 'Billable Mappings')
		return 1
	end
else
begin
	select ItemCategoryID, ItemCode, MappedCode, BillableMappings.AgentNo, MappedTypeID, dbo.GetLookupDataDes(MappedTypeID) as MappedType,
	  BillableMappings.LoginID
	from BillableMappings
	inner join INTAgents on BillableMappings.AgentNo = INTAgents.AgentNo	

	where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode and MappedCode = @MappedCode and INTAgents.AgentNo = @AgentNo
return 0
end
go

/******************************************************************************************************
exec uspGetBillableMappings '7C', 'CON009', '12', 'NAV'
******************************************************************************************************/
-- select * from BillableMappings
-- delete from BillableMappings
-------------- Get BillableMappingsByItemCode -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetBillableMappingsByItemCategoryItemCode')
	drop proc uspGetBillableMappingsByItemCategoryItemCode
go

create proc uspGetBillableMappingsByItemCategoryItemCode(
@ItemCategoryID varchar(20),
@ItemCode varchar(20),
@AgentNo varchar(20)

)with encryption as

declare @ErrorMSG varchar(200)

begin
	select ItemCategoryID, ItemCode, MappedCode, BillableMappings.AgentNo, MappedTypeID, dbo.GetLookupDataDes(MappedTypeID) as MappedType,
	  BillableMappings.LoginID
	from BillableMappings
	inner join INTAgents on BillableMappings.AgentNo = INTAgents.AgentNo	
	inner join LookupData on LookupData.DataID = MappedTypeID and IsHidden = 'N'
	where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode and INTAgents.AgentNo = @AgentNo
return 0
end
go

/******************************************************************************************************
exec uspGetBillableMappingsByItemCategoryItemCode  '7D', 'DRG0006', 'NAV'
******************************************************************************************************/
-- select * from BillableMappings
-- delete from BillableMappings

/******************************************************************************************************
exec uspGetBillableMappingsByItemCode  'drg687'
*/



------------------------------------------------------------------------------------------------------
-------------- Get Bills Exceeding AllocatedValue -------------------------------------------------------------
------------------------------------------------------------------------------------------------------


if exists (select * from sysobjects where name = 'uspGetBillsExceedingAllocatedValue')
	drop proc uspGetBillsExceedingAllocatedValue
go

create proc uspGetBillsExceedingAllocatedValue(
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @NotPaidPayStatus  varchar(10)
declare @CashBillModesID varchar(10)
declare @ItemOfferedID varchar(10)
declare @ItemDoneID varchar(10)

set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @NotPaidPayStatus = dbo.GetLookupDataID('PayStatus', 'NP')
set @ItemOfferedID = dbo.GetLookupDataID('ItemStatus', 'O')
set @ItemDoneID = dbo.GetLookupDataID('ItemStatus', 'D')


if not(@StartDate is null) and not(@EndDate is null)
begin
select Items.VisitNo,Visits.PatientNo,dbo.GetHidePatientDetails(dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName),HideDetails) as FullName,
Phone,NOKName,NOKPhone, ItemCode,dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemName,Quantity,UnitPrice,Items.LoginID,CreatorLoginID,CreatorClientMachine,
dbo.FormatDate(Items.RecordDateTime) as RecordDate
from Items
inner join Visits on Visits.VisitNo =items.VisitNo 
inner join Patients on Patients.PatientNo =Visits.PatientNo
where dbo.FormatMoney(dbo.GetTotalBill(Visits.VisitNo, 'NP')) > 0 and BillModesID =@CashBillModesID
and ItemStatusID in (@ItemOfferedID,@ItemDoneID) AND PayStatusID =@NotPaidPayStatus
and Items.RecordDateTime between @StartDate and @EndDate
end
else
begin
select Items.VisitNo,Visits.PatientNo,dbo.GetHidePatientDetails(dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName),HideDetails) as FullName,
Phone,NOKName,NOKPhone, ItemCode,dbo.GetLookupDataDes(ItemCategoryID) as ItemCategory,ItemName,Quantity,UnitPrice,Items.LoginID,CreatorLoginID,CreatorClientMachine,
dbo.FormatDate(Items.RecordDateTime) as RecordDate
from Items
inner join Visits on Visits.VisitNo =items.VisitNo 
inner join Patients on Patients.PatientNo =Visits.PatientNo
where dbo.FormatMoney(dbo.GetTotalBill(Visits.VisitNo, 'NP')) > 0 and BillModesID =@CashBillModesID
and ItemStatusID in (@ItemOfferedID,@ItemDoneID) AND PayStatusID =@NotPaidPayStatus
end
return 0
go


-- exec uspGetBillsExceedingAllocatedValue
-- exec uspGetBillsExceedingAllocatedValue '1 jan 18','20 feb 18'
-- exec uspGetBillsExceedingAllocatedValue '1 jan 18','1 jun 18'

------------------------------------------------------------------------------------------------------
--------uspGetCountBillsExceedingAllocatedValue  ----------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCountBillsExceedingAllocatedValue')
	drop proc uspGetCountBillsExceedingAllocatedValue
go

create proc uspGetCountBillsExceedingAllocatedValue(
@StartDate smalldatetime,
@EndDate smalldatetime,
@CountedItems int = null output
)with encryption as

declare @ItemOfferedID varchar(10)
declare @ItemDoneID varchar(10)
declare @CashBillModesID varchar(10)

declare @NotPaidPayStatusID varchar(10)
declare @CopayPayments int
--------------------------------------------------------------------------
set @NotPaidPayStatusID = dbo.GetLookupDataID('PayStatus', 'NP')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @ItemOfferedID = dbo.GetLookupDataID('ItemStatus', 'O')
set @ItemDoneID = dbo.GetLookupDataID('ItemStatus', 'D')

set @CopayPayments = (select  count(*) from Items
			inner join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
			and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			
			where CashPayStatusID = @NotPaidPayStatusID	and ItemStatusID in (@ItemOfferedID,@ItemDoneID)
			and VisitDate between @StartDate and @EndDate)
--------------------------------------------------------------------------

 set @CountedItems=  (select (count(*)+@CopayPayments) 
   from Items 
			inner join Visits  on Items.VisitNo = Visits.VisitNo
			where PayStatusID = @NotPaidPayStatusID and BillModesID = @CashBillModesID and ItemStatusID in (@ItemOfferedID,@ItemDoneID)
			 and VisitDate between @StartDate and @EndDate)
			
	return 0
go


--- exec uspGetCountBillsExceedingAllocatedValue '1 jan 18','20 feb 18'

------------------------------------------------------------------------------------------------------
--------uspGetDashboardManualDebits  ----------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDashboardManualDebits')
	drop proc uspGetDashboardManualDebits
go

create proc uspGetDashboardManualDebits(
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as


declare @ManualEntryModeID varchar(10)
declare @DRAccountActionID varchar(10)

set @DRAccountActionID = dbo.GetLookupDataID('AccountAction', 'DR')
set @ManualEntryModeID = dbo.GetLookupDataID('EntryMode', 'MAN')

if not(@StartDate is null) and not(@EndDate is null)
begin
select dbo.FormatText(TranNo, 'Accounts', 'TranNo') as TranNo, 
dbo.GetLookupDataDes(AccountBillModesID) as AccountCategory, 
dbo.FormatDate(TranDate) as TranDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
AccountBillNo, ClientFullName as AccountName,
dbo.GetLookupDataDes(AccountActionID) as AccountAction, Amount,
dbo.FormatMoney(dbo.GetAccountAmount(TranNo)) as AccountAmount, DocumentNo, 
CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
AccountGroupID, dbo.GetLookupDataDes(AccountGroupID) as AccountGroup, 
EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,dbo.GetLookupDataDes(BranchID) as BranchName, 
AmountTendered, ExchangeRate, Change, Notes, LoginID,
dbo.FormatDate(dbo.GetShortDate(dbo.GetAccountsRecordDateTime(TranNo))) as RecordDate,
dbo.GetTime(dbo.GetAccountsRecordDateTime(TranNo)) as RecordTime,
dbo.FormatMoney(dbo.GetAccountBalance(AccountBillModesID, AccountBillNo)) as Balance
from Accounts where AccountActionID =@DRAccountActionID and EntryModeID =@ManualEntryModeID
and Accounts.RecordDateTime between @StartDate and @EndDate
end
else
begin
select dbo.FormatText(TranNo, 'Accounts', 'TranNo') as TranNo, 
dbo.GetLookupDataDes(AccountBillModesID) as AccountCategory, 
dbo.FormatDate(TranDate) as TranDate, dbo.GetLookupDataDes(PayModesID) as PayModes, 
AccountBillNo, ClientFullName as AccountName,
dbo.GetLookupDataDes(AccountActionID) as AccountAction, Amount,
dbo.FormatMoney(dbo.GetAccountAmount(TranNo)) as AccountAmount, DocumentNo, 
CurrenciesID, dbo.GetLookupDataDes(CurrenciesID) as Currency, 
AccountGroupID, dbo.GetLookupDataDes(AccountGroupID) as AccountGroup, 
EntryModeID, dbo.GetLookupDataDes(EntryModeID) as EntryMode,dbo.GetLookupDataDes(BranchID) as BranchName, 
AmountTendered, ExchangeRate, Change, Notes, LoginID,
dbo.FormatDate(dbo.GetShortDate(dbo.GetAccountsRecordDateTime(TranNo))) as RecordDate,
dbo.GetTime(dbo.GetAccountsRecordDateTime(TranNo)) as RecordTime,
dbo.FormatMoney(dbo.GetAccountBalance(AccountBillModesID, AccountBillNo)) as Balance
from Accounts where AccountActionID =@DRAccountActionID and EntryModeID =@ManualEntryModeID
end
go


-- exec uspGetDashboardManualDebits
-- exec uspGetDashboardManualDebits '16 jan 19','17 jan 19'
-- exec uspGetDashboardManualDebits '1 jan 18','1 jun 18'

------------------------------------------------------------------------------------------------------
--------uspGetCountDashboardManualDebits  ----------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCountDashboardManualDebits')
	drop proc uspGetCountDashboardManualDebits
go

create proc uspGetCountDashboardManualDebits(
@StartDate smalldatetime,
@EndDate smalldatetime,
@CountedItems int = null output
)with encryption as

declare @ManualEntryModeID varchar(10)
declare @DRAccountActionID varchar(10)

set @DRAccountActionID = dbo.GetLookupDataID('AccountAction', 'DR')
set @ManualEntryModeID = dbo.GetLookupDataID('EntryMode', 'MAN')

--------------------------------------------------------------------------

 set @CountedItems=  (select (count(*)) 
   from Accounts  where AccountActionID =@DRAccountActionID and EntryModeID =@ManualEntryModeID
and Accounts.RecordDateTime between @StartDate and @EndDate)
			
	return 0
go


--- exec uspGetCountDashboardManualDebits '1 jan 18','20 feb 18'

--------GetRefundRequestNo-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetRefundRequestNo')
drop proc uspGetRefundRequestNo
go

create proc uspGetRefundRequestNo(
@ReceiptNo varchar(20),
@RecordDateTime smalldatetime = null output,
@RefundRequestNo varchar(20) = null output
)with encryption as

declare @ErrorMSG varchar(200)

if (@RecordDateTime is null)
begin
if not exists(select RefundRequestNo from RefundRequests where ReceiptNo = @ReceiptNo)
begin
set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
raiserror(@ErrorMSG,16,1, 'Receipt No', @ReceiptNo, 'Refund Requests')	
return 1
end
else
begin
set @RefundRequestNo = (select top 1 RefundRequestNo from RefundRequests where ReceiptNo = @ReceiptNo
and RecordDateTime = (select max(RecordDateTime) from RefundRequests where ReceiptNo = @ReceiptNo)
order by RefundRequestID desc)
end
end
else
if not (@RecordDateTime is null)
begin

if not exists(select top 1 RefundRequestNo from RefundRequests where ReceiptNo = @ReceiptNo and RecordDateTime = @RecordDateTime)
begin
set @ErrorMSG = '%s: %s and %s: ' + dbo.FormatDate(@RecordDateTime) + ', you are trying to enter does not exist %s'
raiserror(@ErrorMSG,16,1, 'The record with Refund Request No', @ReceiptNo, 'Request Date', 'in the registered Refund Requests')	
return 1		
end
else
begin
set @RefundRequestNo = (select top 1 RefundRequestNo from RefundRequests 
where ReceiptNo = @ReceiptNo and RecordDateTime = @RecordDateTime order by RefundRequestID desc)
end
end

return 0

go

-- select * from RefundRequests
-- exec  uspGetReceiptRefundRequestNo '18000001'
-- exec uspGetReceiptRefundRequestNo '07022061', '23 Jan 2007'


-------------- Get PatientAccountBalances -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetPatientAccountBalances')
	drop proc uspGetPatientAccountBalances
go

create proc uspGetPatientAccountBalances(
@Accountbalance money = null
)with encryption as

declare @ErrorMSG varchar(200)


if (not (@Accountbalance is null))
begin
select PatientNo,dbo.GetFullName(LastName, MiddleName, FirstName) as FullName,Phone,NOKName,NOKPhone, 
AccountBalance,dbo.FormatDate(LastVisitDate) as LastVisitDate from Patients
where AccountBalance > @Accountbalance
end
else
begin
select PatientNo,dbo.GetFullName(LastName, MiddleName, FirstName) as FullName,Phone,NOKName,NOKPhone, 
AccountBalance,dbo.FormatDate(LastVisitDate) as LastVisitDate from Patients
where AccountBalance > 0
end


return 0

go

/******************************************************************************************************
exec uspGetPatientAccountBalances '2000000'
******************************************************************************************************/
-- select * from PatientAccountBalances
-- delete from PatientAccountBalances


--------GetCountPatientAccountBalances-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCountPatientAccountBalances')
	drop proc uspGetCountPatientAccountBalances
go

create proc uspGetCountPatientAccountBalances
with encryption as
begin

select AccountBalance from Patients where AccountBalance > 0
end
return 0
go


-------------- Edit Dimensions -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditDimensions')
	drop proc uspEditDimensions
go

create proc uspEditDimensions(
@DimensionCode varchar(20),
@DimensionTypeID varchar(10),
@DimensionName varchar(100),
@Blocked tinyint,
@LoginID varchar(20)
)with encryption as

declare @ErrorMSG varchar(200)

if not exists(select DataID from LookupData where DataID = @DimensionTypeID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Dimension Type ID', @DimensionTypeID, 'Lookup Data')
		return 1
	end

if not exists(select LoginID from Logins where LoginID  = @LoginID)
	begin
		set @ErrorMSG = 'The %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Login ID', @LoginID, 'Logins')
		return 1
	end

if exists(select DimensionCode from Dimensions where DimensionCode = @DimensionCode and DimensionTypeID = @DimensionTypeID)
	begin
		update Dimensions set
		DimensionTypeID = @DimensionTypeID, DimensionName = @DimensionName, Blocked = @Blocked, LoginID = @LoginID
		where DimensionCode = @DimensionCode and DimensionTypeID = @DimensionTypeID
		return 0
	end
else
begin
insert into Dimensions
(DimensionCode, DimensionTypeID, DimensionName, Blocked, LoginID)
values
(@DimensionCode, @DimensionTypeID, @DimensionName, @Blocked, @LoginID)
return 0
end
go

/******************************************************************************************************
exec uspEditDimensions '1000', '53501', 'Patient Charges', 0 , 'Admin'
exec uspEditDimensions '1003', '53502', 'Dental Charges', 0 , 'Admin'
exec uspEditDimensions '500', '53502', 'Other Charges', 0 , 'Admin'
******************************************************************************************************/
-- select * from Dimensions
-- delete from Dimensions
-- Select * from BillableMappings

-------------- Get Dimensions -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDimensions')
	drop proc uspGetDimensions
go

create proc uspGetDimensions(
@DimensionCode varchar(20)  = null,
@Blocked int = 0
)with encryption as

declare @ErrorMSG varchar(200)
if not @DimensionCode is null
begin
if not exists(select DimensionCode from Dimensions where DimensionCode = @DimensionCode)
	begin
		set @ErrorMSG = 'The record with %s: %s, you are trying to enter does not exist in the registered %s'
		raiserror(@ErrorMSG, 16, 1, 'Dimension Code', @DimensionCode, 'Dimensions')
		return 1
	end
else
begin
	select DimensionCode, DimensionTypeID, dbo.GetLookupDataDes(DimensionTypeID) as DimensionType, DimensionName, Blocked, Dimensions.LoginID, ClientMachine, RecordDateTime
	from Dimensions

	where DimensionCode = @DimensionCode
return 0
end
end
else
begin
	select DimensionCode, DimensionTypeID, dbo.GetLookupDataDes(DimensionTypeID) as DimensionTypeID, DimensionName, Blocked, Dimensions.LoginID, ClientMachine, RecordDateTime
	from Dimensions

	where Blocked = @Blocked
return 0
end
go

/******************************************************************************************************
exec uspGetDimensions '1000'
******************************************************************************************************/
-- select * from Dimensions
-- delete from Dimensions

-------------- Get Dimensions Dimension By Dimension Type ID -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetDimensionByDimensionTypeID ')
	drop proc uspGetDimensionByDimensionTypeID 
go

create proc uspGetDimensionByDimensionTypeID (
@DimensionTypeID varchar(10),
@Blocked bit = 0
)with encryption as

declare @ErrorMSG varchar(200)

begin
	select DimensionCode, DimensionTypeID, dbo.GetLookupDataDes(DimensionTypeID) as DimensionTypeID, DimensionName, dbo.GetMergedNameCode(DimensionName, DimensionCode) as AdmissionFullName, Blocked, Dimensions.LoginID, ClientMachine, RecordDateTime
	from Dimensions

	where DimensionTypeID = @DimensionTypeID and Blocked = @Blocked
return 0
end
go

/******************************************************************************************************
exec uspGetDimensionByDimensionTypeID  '53501'
******************************************************************************************************/

---------------------------------------------------------------------------------------------------------------------------------
