
/***************************************************************
This Script is a property of ClinicMaster INTERNATIONAL
Un authorised use or ammendment is not permitted
-- Last updated 10/02/2016 by Wilson Kutegeka
***************************************************************/

use ClinicMaster
go

------------------------------------------------------------------------------------------------------
---------------------- Functions -> Triggers -> Views ------------------------------------------------
------------------------------------------------------------------------------------------------------

-----------------------------------------------------------------------------------------------------------------
------------- Functions -----------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------

--------Function GetItemName-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetItemName')
drop function GetItemName
go

create function GetItemName(@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns varchar(800)
with encryption as

begin

declare @ItemName varchar(800)
declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)
declare @PackageID varchar(10)
declare @OtherItems varchar(10)

set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')
set @PackageID = dbo.GetLookupDataID('ItemCategory', 'G')
set @OtherItems = dbo.GetLookupDataID('ItemCategory', 'NM')

if @ItemCategoryID = @ServiceID -- Services
begin
set @ItemName = (select ServiceName from Services where ServiceCode = @ItemCode)
end

else
if @ItemCategoryID = @DrugID -- Drugs
begin
set @ItemName = (select DrugName from Drugs where DrugNo = @ItemCode)
end

else
if @ItemCategoryID = @ConsumableID -- ConsumableItems
begin
set @ItemName = (select ConsumableName from ConsumableItems where ConsumableNo = @ItemCode)
end

else
if @ItemCategoryID = @ProcedureID -- Procedures
begin
set @ItemName = (select ProcedureName from Procedures where ProcedureCode = @ItemCode)
end

else
if @ItemCategoryID = @DentalID -- DentalServices
begin
set @ItemName = (select DentalName from DentalServices where DentalCode = @ItemCode)
end

else
if @ItemCategoryID = @TheatreID -- TheatreServices
begin
set @ItemName = (select TheatreName from TheatreServices where TheatreCode = @ItemCode)
end

else
if @ItemCategoryID = @OpticalID -- OpticalServices
begin
set @ItemName = (select OpticalName from OpticalServices where OpticalCode = @ItemCode)
end

else
if @ItemCategoryID = @MaternityID -- MaternityServices
begin
set @ItemName = (select MaternityName from MaternityServices where MaternityCode = @ItemCode)
end

else
if @ItemCategoryID = @ICUID -- ICUServices
begin
set @ItemName = (select ICUName from ICUServices where ICUCode = @ItemCode)
end

else
if @ItemCategoryID = @TestID -- Test
begin
set @ItemName = (select TestName from LabTests where TestCode = @ItemCode)
end
	
else
if @ItemCategoryID = @CardiologyID -- Cardiology
begin
set @ItemName = (select ExamName from CardiologyExaminations where ExamCode = @ItemCode)
end

else
if @ItemCategoryID = @RadiologyID -- Radiology
begin
set @ItemName = (select ExamName from RadiologyExaminations where ExamCode = @ItemCode)
end

else
if @ItemCategoryID = @PathologyID -- Pathology
begin
set @ItemName = (select ExamName from PathologyExaminations where ExamCode = @ItemCode)
end

else
if @ItemCategoryID = @EyeID -- EyeServices
begin
set @ItemName = (select EyeName from EyeServices where EyeCode = @ItemCode)
end
	
else
if @ItemCategoryID = @AdmissionID -- Admission
begin
set @ItemName = (select BedName from Beds where BedNo = @ItemCode)
end
	
else
if @ItemCategoryID = @ExtrasID -- Extras
begin
set @ItemName = (select ExtraItemName from ExtraChargeItems where ExtraItemCode = @ItemCode)
end

else
if @ItemCategoryID = @OtherItems -- Other Items
begin
set @ItemName = (select ItemName from OtherItems where ItemCode = @ItemCode)
end


else
if @ItemCategoryID = @PackageID -- Packages
begin
set @ItemName = (select PackageName from Packages where PackageNo = @ItemCode)
end

return @ItemName

end
go

-- print dbo.GetItemName('7NM', 'A0002')
-- print dbo.GetItemName('7A', '2B')
/* select VisitNo, ItemCode, ItemDetails, ItemCategoryID,
dbo.GetItemName(ItemCategoryID, ItemCode) as ItemName
from Items
go*/



--------Function Get Hide Details----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHidePatientDetails')
	drop function GetHidePatientDetails
go

create function GetHidePatientDetails(@Details varchar(200), @hidden bit) returns varchar(200)
with encryption as

begin

declare @FullString varchar(200)

if (@hidden =1)
	begin set @FullString = '###########' end
else
begin set @FullString = @Details  end

return @FullString
end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetHidePatientDetails('Kutegeka', '1')
--  print dbo.GetHidePatientDetails('Kutegeka', 0)
----------------------------------------------------------------------------------------------------------------------------

-------------------------GetCurrentBankBalance-------------------------------

if exists (select * from sysobjects where name = 'GetCurrentBankBalance')
drop function GetCurrentBankBalance
go

create function GetCurrentBankBalance (@AccountNo varchar(20)) returns money
with encryption as

begin

declare @balance money
declare @bankedAmount money
declare @withdrawnAmount money

set @bankedAmount= (select sum(AmountBanked) from BankingRegister where AccountNo=@AccountNo)
set @withdrawnAmount= (select sum(Amount/ExchangeRate) from Expenditure where AccountNo=@AccountNo)  

set @bankedAmount= isnull(@bankedAmount,0)
set @withdrawnAmount= isnull(@withdrawnAmount,0)

   

set @balance= @bankedAmount-@withdrawnAmount


return @balance

end

go

--------Function GetExpenditureCategoryTotal----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetExpenditureCategoryTotal')
drop function GetExpenditureCategoryTotal
go

create function GetExpenditureCategoryTotal( @ExpenditureCategoryID varchar(10),@StartDateTime smalldatetime, @EndDateTime as smalldatetime) returns int
with encryption as

begin 

declare @Total int


begin
set @Total = (select sum(amount) from Expenditure where ExpenditureCategoryID = @ExpenditureCategoryID 
		and RecordDateTime between @StartDateTime and @EndDateTime)
end

	
set @Total = isnull(@Total, 0)

return @Total


end

go

-----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetVATPercentage')
drop function GetVATPercentage
go

create function GetVATPercentage(@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns decimal
with encryption as

begin

declare @VATPercentage decimal
declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)

set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')

if @ItemCategoryID = @ServiceID -- Services
begin
set @VATPercentage = (select VATPercentage from Services where ServiceCode = @ItemCode)
end

else
if @ItemCategoryID = @DrugID -- Drugs
begin
set  @VATPercentage = (select  VATPercentage from Drugs where DrugNo = @ItemCode)
end

else
if @ItemCategoryID = @ConsumableID -- ConsumableItems
begin
set  @VATPercentage = (select  VATPercentage from ConsumableItems where ConsumableNo = @ItemCode)
end

else
if @ItemCategoryID = @ProcedureID -- Procedures
begin
set @VATPercentage = (select  VATPercentage from Procedures where ProcedureCode = @ItemCode)
end

else
if @ItemCategoryID = @DentalID -- DentalServices
begin
set @VATPercentage = (select  VATPercentage from DentalServices where DentalCode = @ItemCode)
end

else
if @ItemCategoryID = @TheatreID -- TheatreServices
begin
set @VATPercentage = (select  VATPercentage from TheatreServices where TheatreCode = @ItemCode)
end

else
if @ItemCategoryID = @OpticalID -- OpticalServices
begin
set @VATPercentage = (select VATPercentage from OpticalServices where OpticalCode = @ItemCode)
end

else
if @ItemCategoryID = @MaternityID -- MaternityServices
begin
set @VATPercentage = (select VATPercentage from MaternityServices where MaternityCode = @ItemCode)
end

else
if @ItemCategoryID = @ICUID -- ICUServices
begin
set @VATPercentage = (select VATPercentage from ICUServices where ICUCode = @ItemCode)
end

else
if @ItemCategoryID = @TestID -- Test
begin
set @VATPercentage = (select VATPercentage from LabTests where TestCode = @ItemCode)
end
	
else
if @ItemCategoryID = @CardiologyID -- Cardiology
begin
set @VATPercentage = (select VATPercentage from CardiologyExaminations where ExamCode = @ItemCode)
end

else
if @ItemCategoryID = @RadiologyID -- Radiology
begin
set @VATPercentage = (select VATPercentage from RadiologyExaminations where ExamCode = @ItemCode)
end

else
if @ItemCategoryID = @PathologyID -- Pathology
begin
set @VATPercentage = (select VATPercentage from PathologyExaminations where ExamCode = @ItemCode)
end

else
if @ItemCategoryID = @EyeID -- EyeServices
begin
set @VATPercentage = (select VATPercentage from EyeServices where EyeCode = @ItemCode)
end
	
else
if @ItemCategoryID = @AdmissionID -- Admission
begin
set @VATPercentage = (select VATPercentage from Beds where BedNo = @ItemCode)
end
	
else
if @ItemCategoryID = @ExtrasID -- Extras
begin
set @VATPercentage = (select VATPercentage from ExtraChargeItems where ExtraItemCode = @ItemCode)
end
set @VATPercentage= isnull(@VATPercentage,0)
return @VATPercentage

end
go

------------------------------------------------------------------------------------------------------------------------------


if exists (select * from sysobjects where name = 'IsReturnableInventory')
	            drop function  IsReturnableInventory
----------------------------------------------

if exists (select * from sysobjects where name = 'GetReceiptInvoiceNo')
	drop function GetReceiptInvoiceNo
go

create function GetReceiptInvoiceNo(@ReceipNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @InvoiceNo varchar(20)
 set @InvoiceNo=(select InvoiceNo from  ReceiptInvoiceDetails WHERE ReceiptNo=@ReceipNo)
set @InvoiceNo = isnull(@InvoiceNo, '')

return @InvoiceNo

end
go


if exists (select * from sysobjects where name = 'IsReturnableOPDInventory')
	drop function  IsReturnableOPDInventory
go

create function  IsReturnableOPDInventory(@VisitNo varchar(20),
@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns bit
with encryption as

begin

declare @ItemStatusID varchar(10)
declare @Drug varchar(10)
declare @Consumable varchar(10)
declare @Offered varchar(10)
declare @IsReturnable bit 
declare @SystemEntryModeID varchar(10)

set @Drug = dbo.GetLookupDataID('ItemCategory', 'D')
set @Consumable =  dbo.GetLookupDataID('ItemCategory', 'C')
set @Offered = dbo.GetLookupDataID('ItemStatus', 'O')

if (not (@ItemCategoryID=@Drug or @ItemCategoryID=@Consumable)) begin set @IsReturnable=0 end

else
 
 begin
	if exists(select ItemStatusID from Items where VisitNo= @VisitNo and ItemCategoryID = @ItemCategoryID
	   and ItemCode= @ItemCode and ItemStatusID=@Offered) begin set @IsReturnable=1 end
    else begin set @IsReturnable=0 end
 end
	  set @IsReturnable = isnull(@IsReturnable,0)
  return @IsReturnable
end
go


--------Function GetAverageAgeItemConsumption------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAverageAgeItemConsumption')
drop function GetAverageAgeItemConsumption
go

create function GetAverageAgeItemConsumption(@ItemCode varchar(20),@ItemCategoryID varchar(10)) returns decimal(5,2)
with encryption as

begin

declare @OPDAvg Decimal
declare @IPDAvg Decimal
declare @FinalAvg Decimal

----------------------------------------------------------------------------------------------------------------------------
set @OPDAvg =isnull((select AVG (dbo.GetAge(BirthDate, getdate())) as Age from Items
inner join Visits on Items.VisitNo = visits.VisitNo
inner join Patients on patients.PatientNo = visits.PatientNo
 where ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode),0)

set @IPDAvg =isnull((select AVG (dbo.GetAge(BirthDate, getdate())) as Age from IPDItems
 inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
inner join Visits on Admissions.VisitNo = Visits.VisitNo
inner join Patients on patients.PatientNo = visits.PatientNo
 where ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode),0)

----------------------------------------------------------------------------------------------------------------------------

set @FinalAvg =NULLIF((@OPDAvg + @IPDAvg),0)/2
return @FinalAvg
end

go


----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetAverageAgeItemConsumption('LAB056', '7T')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetGenderSpecificItemConsumption------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetGenderSpecificItemConsumption')
drop function GetGenderSpecificItemConsumption
go

create function GetGenderSpecificItemConsumption(@ItemCode varchar(20),@ItemCategoryID varchar(10)) returns varchar(10)
with encryption as

begin

declare @MaleOPDAvg Decimal
declare @MaleIPDAvg Decimal

declare @FemaleOPDAvg Decimal
declare @FemaleIPDAvg Decimal

declare @FinalAvg Decimal

declare @MaleGenderID varchar(10)
declare @FemaleGenderID varchar(10)

declare @FemalePercentage Decimal (5,2)
declare @MalePercentage Decimal (5,2)

declare @FinalPercentage varchar(10)

set @MaleGenderID =  dbo.GetLookupDataID('Gender', 'M')
set @FemaleGenderID =  dbo.GetLookupDataID('Gender', 'F')
----------------------------------------------------------------------------------------------------------------------------
set @MaleOPDAvg =isnull((select COUNT (Items.VisitNo) as Gender from Items
inner join Visits on Items.VisitNo = visits.VisitNo
inner join Patients on patients.PatientNo = visits.PatientNo
 where ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode and GenderID = @MaleGenderID),0)

set @MaleIPDAvg =isnull((select COUNT (IPDItems.RoundNo) as Gender from IPDItems
 inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
inner join Visits on Admissions.VisitNo = Visits.VisitNo
inner join Patients on patients.PatientNo = visits.PatientNo
 where ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode and GenderID = @MaleGenderID),0)


 set @FemaleOPDAvg =isnull((select COUNT (Items.VisitNo) as Gender from Items
inner join Visits on Items.VisitNo = visits.VisitNo
inner join Patients on patients.PatientNo = visits.PatientNo
 where ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode and GenderID = @FemaleGenderID),0)

set @FemaleIPDAvg =isnull((select COUNT (IPDItems.RoundNo) as Gender from IPDItems
 inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
inner join Visits on Admissions.VisitNo = Visits.VisitNo
inner join Patients on patients.PatientNo = visits.PatientNo
 where ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode and GenderID = @FemaleGenderID),0)

----------------------------------------------------------------------------------------------------------------------------

set @FinalAvg =NULLIF((@FemaleOPDAvg + @FemaleIPDAvg+@MaleOPDAvg+@MaleIPDAvg),0)

set @MalePercentage = NULLIF(((@MaleOPDAvg+@MaleIPDAvg)/@FinalAvg) *100,0)

set @FemalePercentage = NULLIF(((@FemaleOPDAvg+@FemaleIPDAvg)/@FinalAvg) *100,0)

if (@FemalePercentage > @MalePercentage)
 
set @FinalPercentage = @FemaleGenderID

else set @FinalPercentage = @MaleGenderID

return @FinalPercentage
end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetGenderSpecificItemConsumption('LAB056', '7T')
-- print dbo.GetGenderSpecificItemConsumption('LAB136', '7T')
-- print dbo.GetGenderSpecificItemConsumption('LAB094', '7T')
----------------------------------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------------
----------Function  IsReturnableIPDInventory-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'IsReturnableIPDInventory')
	drop function  IsReturnableIPDInventory
go

create function  IsReturnableIPDInventory(@ExtraBillNo varchar(20),
@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns bit
with encryption as

begin

declare @ItemStatusID varchar(10)
declare @Drug varchar(10)
declare @Consumable varchar(10)
declare @IsReturnable bit
declare @EntryModeID varchar(10)  
declare @SystemEntryModeID varchar(10)

set @Drug = dbo.GetLookupDataID('ItemCategory', 'D')
set @Consumable =  dbo.GetLookupDataID('ItemCategory', 'C')
set @SystemEntryModeID = dbo.GetLookupDataID('EntryMode', 'SYS')

if (not (@ItemCategoryID=@Drug or @ItemCategoryID=@Consumable)) begin set @IsReturnable=0 end

else
  begin
		
		 
if not exists(select top 1 ExtraBillNo from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and 
				ItemCategoryID = @ItemCategoryID and EntryModeID = @SystemEntryModeID)		 
				begin set @IsReturnable=0 end
  else begin set @IsReturnable=1   end
	
  end
  set @IsReturnable = isnull(@IsReturnable,0)
  return @IsReturnable
end
go





----- Bill Adjustments




--------Function GetExtraBillItemReturnQuantity----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetExtraBillItemReturnQuantity')
drop function GetExtraBillItemReturnQuantity
go

create function GetExtraBillItemReturnQuantity(@ExtraBillNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns int
with encryption as

begin

declare @ReturnedQuantity int
declare @AdjustmentTypeID varchar(10)
set @AdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'D')

----------------------------------------------------------------------------------------------------------------
set @ReturnedQuantity = (select sum(Quantity) from ExtraBillItemAdjustments
inner join BillAdjustments on BillAdjustments.AdjustmentNo =ExtraBillItemAdjustments.AdjustmentNo
where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and AdjustmentTypeID = @AdjustmentTypeID)
	
set @ReturnedQuantity = isnull(@ReturnedQuantity, 0)

return @ReturnedQuantity

end

go

-- select * from ExtraBillItemAdjustments

--- print dbo.GetExtraBillItemReturnQuantity('1010161032', '7D', 'M569')

--------Function GetExtraBillItemReturnAmount----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetExtraBillItemReturnAmount')
drop function GetExtraBillItemReturnAmount
go

create function GetExtraBillItemReturnAmount(@ExtraBillNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns money
with encryption as

begin

declare @ReturnedAmount money
declare @AdjustmentTypeID varchar(10)
set @AdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'D')
----------------------------------------------------------------------------------------------------------------
set @ReturnedAmount = (select sum(Amount) from ExtraBillItemAdjustments
inner join BillAdjustments on BillAdjustments.AdjustmentNo =ExtraBillItemAdjustments.AdjustmentNo
where ExtraBillNo = @ExtraBillNo  and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and AdjustmentTypeID = @AdjustmentTypeID)
	
set @ReturnedAmount = isnull(@ReturnedAmount, 0.00)

return @ReturnedAmount

end

go

-- select * from ExtraBillItemAdjustments
--- print dbo.GetExtraBillItemReturnAmount('1010161032', '7D', 'M569')

--------Function IsExtraBillItemReturnable----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'IsExtraBillItemReturnable')
drop function IsExtraBillItemReturnable
go

create function IsExtraBillItemReturnable(@ExtraBillNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns bit
with encryption as

begin

declare @MannualEntryModesID varchar(10)
declare @DrugItemCategoryID varchar(10)
declare @ConsumableItemCategoryID varchar(10)
declare @NonMedicalItemCategoryID varchar(10)

declare @Returnable bit

set @MannualEntryModesID = dbo.GetLookupDataID('EntryMode', 'SYS')
set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')
set @NonMedicalItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'NM')

----------------------------------------------------------------------------------------------------------------
 if not (@ItemCategoryID = @DrugItemCategoryID or @ItemCategoryID = @ConsumableItemCategoryID or @ItemCategoryID = @NonMedicalItemCategoryID)
  begin  set @Returnable = 0 end
 else
  begin
	  if exists (select ExtraBillNo from ExtraBillItems
	  where ExtraBillNo = @ExtraBillNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
	  and EntryModeID = @MannualEntryModesID)
	  begin set @Returnable = 1 end
	 else  begin set @Returnable = 0 end
 end
  set @Returnable = isnull(@Returnable,0)

return @Returnable

end

go


--------Function GetReturnedItemQuantity----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetReturnedItemQuantity')
drop function GetReturnedItemQuantity
go

create function GetReturnedItemQuantity(@VisitNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns int
with encryption as

begin

declare @ReturnedQuantity int
declare @AdjustmentTypeID varchar(10)
set @AdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'D')
----------------------------------------------------------------------------------------------------------------
set @ReturnedQuantity = (select sum(Quantity) from ItemAdjustments
inner join BillAdjustments on BillAdjustments.AdjustmentNo = ItemAdjustments.AdjustmentNo
where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID and AdjustmentTypeID = @AdjustmentTypeID)
	
set @ReturnedQuantity = isnull(@ReturnedQuantity, 0)

return @ReturnedQuantity

end

go

/*----------------------------------------------------------------------------------------------------------------------------
print dbo.GetReturnedItemQuantity('103040003', 'M062','7D')
print dbo.GetReturnedItemQuantity('103040003', 'M062','7D')
----------------------------------------------------------------------------------------------------------------------------*/




----------Function  GetReturnedItemAmount-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetReturnedItemAmount')
	drop function  GetReturnedItemAmount
go

create function  GetReturnedItemAmount( @VisitNo varchar(20),
 @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns money
with encryption as

begin

declare @ReversedAmount money
 declare @AdjustmentTypeID varchar(10)
 set @AdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType', 'D')

	  set @ReversedAmount = (select sum(Amount) from ItemAdjustments
	  inner join BillAdjustments on BillAdjustments.AdjustmentNo = ItemAdjustments.AdjustmentNo
	  where VisitNo = @VisitNo and ItemCode=@ItemCode and ItemCategoryID = @ItemCategoryID and AdjustmentTypeID = @AdjustmentTypeID)


      set @ReversedAmount= isnull(@ReversedAmount,0.00)
  return @ReversedAmount
end
go


/************************************************************************************************************
print dbo.GetReturnedItemAmount('103040003', 'M062','7D')
select * from ItemAdjustments
************************************************************************************************************/

--------Function GetInvoicBalanceAmount----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInvoicBalanceAmount')
	drop function  GetInvoicBalanceAmount
go

create function  GetInvoicBalanceAmount(@InvoiceNo varchar(20), @VisitTypeID varchar(10)) returns money
with encryption as

begin
declare @AddedAmount money
declare @InvoiceAmount money
declare @ReducedAmount money
declare @NetAmount money

declare @OPDVisitTypeID varchar(10)
declare @IPDVisitTypeID varchar(10)

declare @DownAdjustmentTypeID varchar(10)
declare @UpAdjustmentTypeID varchar(10)

set @OPDVisitTypeID =  dbo.GetLookupDataID('VisitType','OPD')
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType','IPD')
set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','D')
set @UpAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','U')
 
 if (@VisitTypeID = @OPDVisitTypeID )
   begin
   	   
	  set @InvoiceAmount = (select sum(Amount) from InvoiceDetails Where InvoiceNo = @InvoiceNo)	

	  set @AddedAmount = (select sum(InvoiceDetailAdjustments.Amount) 
	  from InvoiceDetailAdjustments
	  inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceDetailAdjustments.AdjustmentNo
	  where InvoiceDetailAdjustments.InvoiceNo = @InvoiceNo and AdjustmentTypeID = @UpAdjustmentTypeID)

	   set @ReducedAmount = (select sum(InvoiceDetailAdjustments.Amount) 
	  from InvoiceDetailAdjustments
	  inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceDetailAdjustments.AdjustmentNo
	  where InvoiceDetailAdjustments.InvoiceNo = @InvoiceNo and AdjustmentTypeID = @DownAdjustmentTypeID)


   end

 else if (@VisitTypeID = @IPDVisitTypeID )
  begin
	   
	   set @InvoiceAmount = (select sum(Amount) from InvoiceExtraBillItems Where InvoiceNo = @InvoiceNo)

	  set @AddedAmount = (select sum(InvoiceExtraBillItemAdjustments.Amount) from InvoiceExtraBillItemAdjustments
	  inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo
	  where InvoiceExtraBillItemAdjustments.InvoiceNo = @InvoiceNo and AdjustmentTypeID = @UpAdjustmentTypeID)

	   set @ReducedAmount = (select sum(InvoiceExtraBillItemAdjustments.Amount) from InvoiceExtraBillItemAdjustments
	  inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo
	  where InvoiceExtraBillItemAdjustments.InvoiceNo= @InvoiceNo and AdjustmentTypeID = @DownAdjustmentTypeID)
	  
  end
      set @InvoiceAmount = isnull(@InvoiceAmount,0)
	  set @AddedAmount = isnull(@AddedAmount,0)
	  set @ReducedAmount = isnull(@ReducedAmount,0)
	  set @NetAmount = (@InvoiceAmount + @AddedAmount) - @ReducedAmount
 
  return @NetAmount

end
go


/*****************************************************************************************************************************
 print dbo.GetInvoicBalanceAmount('12000003','110OPD')
 print dbo.GetInvoicBalanceAmount('15039763', '110IPD')
 select * from InvoiceAdjustments where AdjustmentTypeID= '264U'
 select * from InvoiceExtraBillItemAdjustments
 inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo  
 where InvoiceExtraBillItemAdjustments.InvoiceNo = '15039763' and AdjustmentTypeID= '264U'
*****************************************************************************************************************************/



--------GetVisitInvoiceBalanceAmount----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetVisitInvoiceBalanceAmount')
	drop function  GetVisitInvoiceBalanceAmount
go

create function  GetVisitInvoiceBalanceAmount(@InvoiceNo varchar(20),@VisitNo varchar(20), @VisitTypeID varchar(10)) returns money
with encryption as

begin
declare @AddedAmount money
declare @InvoiceAmount money
declare @ReducedAmount money
declare @NetAmount money

declare @OPDVisitTypeID varchar(10)
declare @IPDVisitTypeID varchar(10)

declare @DownAdjustmentTypeID varchar(10)
declare @UpAdjustmentTypeID varchar(10)

set @OPDVisitTypeID =  dbo.GetLookupDataID('VisitType','OPD')
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType','IPD')
set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','D')
set @UpAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','U')
 
 if (@VisitTypeID = @OPDVisitTypeID )
   begin
   	   
	  set @InvoiceAmount = (select sum(Amount) from InvoiceDetails Where InvoiceNo = @InvoiceNo and VisitNo = @VisitNo)	

	  set @AddedAmount = (select sum(InvoiceDetailAdjustments.Amount) 
	  from InvoiceDetailAdjustments
	  inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceDetailAdjustments.AdjustmentNo
	  where InvoiceDetailAdjustments.InvoiceNo = @InvoiceNo and VisitNo = @VisitNo and AdjustmentTypeID = @UpAdjustmentTypeID)

	   set @ReducedAmount = (select sum(InvoiceDetailAdjustments.Amount) 
	  from InvoiceDetailAdjustments
	  inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceDetailAdjustments.AdjustmentNo
	  where InvoiceDetailAdjustments.InvoiceNo = @InvoiceNo and VisitNo = @VisitNo and AdjustmentTypeID = @DownAdjustmentTypeID)


   end

 else if (@VisitTypeID = @IPDVisitTypeID )
  begin
	   
	   set @InvoiceAmount = (select sum(Amount) from InvoiceExtraBillItems 
	    inner join ExtraBills on ExtraBills.ExtraBillNo = InvoiceExtraBillItems.ExtraBillNo
	    Where InvoiceNo = @InvoiceNo and VisitNo = @VisitNo)

	  set @AddedAmount = (select sum(InvoiceExtraBillItemAdjustments.Amount) from InvoiceExtraBillItemAdjustments
	  inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo
	  inner join ExtraBills on ExtraBills.ExtraBillNo = InvoiceExtraBillItemAdjustments.ExtraBillNo
	  where InvoiceExtraBillItemAdjustments.InvoiceNo = @InvoiceNo and VisitNo = @VisitNo and AdjustmentTypeID = @UpAdjustmentTypeID)

	   set @ReducedAmount = (select sum(InvoiceExtraBillItemAdjustments.Amount) from InvoiceExtraBillItemAdjustments
	  inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo
	  inner join ExtraBills on ExtraBills.ExtraBillNo = InvoiceExtraBillItemAdjustments.ExtraBillNo
	  where InvoiceExtraBillItemAdjustments.InvoiceNo= @InvoiceNo and AdjustmentTypeID = @DownAdjustmentTypeID)
	  
  end
      set @InvoiceAmount = isnull(@InvoiceAmount,0)
	  set @AddedAmount = isnull(@AddedAmount,0)
	  set @ReducedAmount = isnull(@ReducedAmount,0)
	  set @NetAmount = (@InvoiceAmount + @AddedAmount) - @ReducedAmount
 
  return @NetAmount

end
go


/*****************************************************************************************************************************
 print dbo.GetVisitInvoiceBalanceAmount('12000003','110OPD')
 print dbo.GetVisitInvoiceBalanceAmount('15039763', '110IPD')
 select * from InvoiceAdjustments where AdjustmentTypeID= '264U'
 select * from InvoiceExtraBillItemAdjustments
 inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo  
 where InvoiceExtraBillItemAdjustments.InvoiceNo = '15039763' and AdjustmentTypeID= '264U'
*****************************************************************************************************************************/




--------Function GetInvoiceItemBalanceQuantity----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInvoiceItemBalanceQuantity')
	drop function GetInvoiceItemBalanceQuantity
go

create function GetInvoiceItemBalanceQuantity(@InvoiceNo varchar(20), @VisitNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @InvoiceQuantity int
declare @UpQuantity int
declare @DownQuantity int
declare @NetQuantity int

declare @UpAdjustmentTypeID varchar(10)
declare @DownAdjustmentTypeID varchar(10)

set @UpAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','U')
set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','D')


----------------------------------------------------------------------------------------------------------------
set @InvoiceQuantity = (select sum(Quantity) from InvoiceDetails
				where InvoiceNo= @InvoiceNo and VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)

set @UpQuantity = (select sum(Quantity) from InvoiceDetailAdjustments
                 inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceDetailAdjustments.AdjustmentNo
				where InvoiceDetailAdjustments.InvoiceNo= @InvoiceNo and VisitNo = @VisitNo  
				and InvoiceDetailAdjustments.ItemCategoryID = @ItemCategoryID and InvoiceDetailAdjustments.ItemCode = @ItemCode 
				and AdjustmentTypeID = @UpAdjustmentTypeID)

set @DownQuantity = (select sum(Quantity) from InvoiceDetailAdjustments
                 inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceDetailAdjustments.AdjustmentNo
				where InvoiceDetailAdjustments.InvoiceNo= @InvoiceNo and VisitNo = @VisitNo  
				and InvoiceDetailAdjustments.ItemCategoryID = @ItemCategoryID and InvoiceDetailAdjustments.ItemCode = @ItemCode 
				and AdjustmentTypeID = @DownAdjustmentTypeID)
	
set @InvoiceQuantity = isnull(@InvoiceQuantity, 0)
set @UpQuantity = isnull(@UpQuantity, 0)
set @DownQuantity = isnull(@DownQuantity, 0)

set @NetQuantity = (@InvoiceQuantity + @UpQuantity) - @DownQuantity

return @NetQuantity

end

go

/**********************************************************************************************************
select * from InvoiceDetails
select * from InvoiceDetailAdjustments
print dbo.GetInvoiceItemBalanceQuantity('12000007', '1106647029', '7T', 'T117')
print dbo.GetInvoiceItemBalanceQuantity('12000001', '1106647032', '7T', 'T137')
***********************************************************************************************************/



--------Function GetInvoiceItemBalanceAmount----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInvoiceItemBalanceAmount')
	drop function GetInvoiceItemBalanceAmount
go

create function GetInvoiceItemBalanceAmount(@InvoiceNo varchar(20), @VisitNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @InvoiceAmount int
declare @UpAmount int
declare @DownAmount int
declare @NetAmount int

declare @UpAdjustmentTypeID varchar(10)
declare @DownAdjustmentTypeID varchar(10)

set @UpAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','U')
set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','D')


----------------------------------------------------------------------------------------------------------------
set @InvoiceAmount = (select sum(Amount) from InvoiceDetails
				where InvoiceNo= @InvoiceNo and VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)

set @UpAmount = (select sum(InvoiceDetailAdjustments.Amount) from InvoiceDetailAdjustments
                 inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceDetailAdjustments.AdjustmentNo
				where InvoiceDetailAdjustments.InvoiceNo= @InvoiceNo and VisitNo = @VisitNo  
				and InvoiceDetailAdjustments.ItemCategoryID = @ItemCategoryID and InvoiceDetailAdjustments.ItemCode = @ItemCode 
				and AdjustmentTypeID = @UpAdjustmentTypeID)

set @DownAmount = (select sum(InvoiceDetailAdjustments.Amount) from InvoiceDetailAdjustments
                 inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceDetailAdjustments.AdjustmentNo
				where InvoiceDetailAdjustments.InvoiceNo= @InvoiceNo and VisitNo = @VisitNo  
				and InvoiceDetailAdjustments.ItemCategoryID = @ItemCategoryID and InvoiceDetailAdjustments.ItemCode = @ItemCode 
				and AdjustmentTypeID = @DownAdjustmentTypeID)
	
set @InvoiceAmount = isnull(@InvoiceAmount, 0)
set @UpAmount = isnull(@UpAmount, 0)
set @DownAmount = isnull(@DownAmount, 0)

set @NetAmount = (@InvoiceAmount + @UpAmount) - @DownAmount

return @NetAmount

end

go

/**********************************************************************************************************
select * from InvoiceDetails
select * from InvoiceDetailAdjustments
print dbo.GetInvoiceItemBalanceAmount('12000007', '1106647029', '7T', 'T117')
print dbo.GetInvoiceItemBalanceAmount('12000001', '1106647032', '7T', 'T137')
***********************************************************************************************************/


-------------------------------------------------------------------------------------------------------------------

--------Function GetIPDInvoiceItemBalanceQuantity----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDInvoiceItemBalanceQuantity')
	drop function GetIPDInvoiceItemBalanceQuantity
go

create function GetIPDInvoiceItemBalanceQuantity(@InvoiceNo varchar(20), @ExtraBillNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @InvoiceQuantity int
declare @UpQuantity int
declare @DownQuantity int
declare @NetQuantity int

declare @UpAdjustmentTypeID varchar(10)
declare @DownAdjustmentTypeID varchar(10)

set @UpAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','U')
set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','D')


----------------------------------------------------------------------------------------------------------------
set @InvoiceQuantity = (select sum(Quantity) from InvoiceExtraBillItems
				where InvoiceNo= @InvoiceNo and ExtraBillNo = @ExtraBillNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)

set @UpQuantity = (select sum(Quantity) from InvoiceExtraBillItemAdjustments
                 inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo
				where InvoiceExtraBillItemAdjustments.InvoiceNo= @InvoiceNo and ExtraBillNo = @ExtraBillNo  
				and InvoiceExtraBillItemAdjustments.ItemCategoryID = @ItemCategoryID and InvoiceExtraBillItemAdjustments.ItemCode = @ItemCode 
				and AdjustmentTypeID = @UpAdjustmentTypeID)

set @DownQuantity = (select sum(Quantity) from InvoiceExtraBillItemAdjustments
                 inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo
				where InvoiceExtraBillItemAdjustments.InvoiceNo= @InvoiceNo and ExtraBillNo = @ExtraBillNo  
				and InvoiceExtraBillItemAdjustments.ItemCategoryID = @ItemCategoryID and InvoiceExtraBillItemAdjustments.ItemCode = @ItemCode 
				and AdjustmentTypeID = @DownAdjustmentTypeID)
	
set @InvoiceQuantity = isnull(@InvoiceQuantity, 0)
set @UpQuantity = isnull(@UpQuantity, 0)
set @DownQuantity = isnull(@DownQuantity, 0)

set @NetQuantity = (@InvoiceQuantity + @UpQuantity) - @DownQuantity

return @NetQuantity

end

go

/**********************************************************************************************************
select * from InvoiceExtraBillItems
select * from InvoiceExtraBillItemAdjustments
print dbo.GetIPDInvoiceItemBalanceQuantity('15039763', '1206726003', '7D', 'M488')
print dbo.GetIPDInvoiceItemBalanceQuantity('15040206', '1512356001', '7D', 'M287')
***********************************************************************************************************/


--------Function GetIPDInvoiceItemBalanceAmount----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDInvoiceItemBalanceAmount')
	drop function GetIPDInvoiceItemBalanceAmount
go

create function GetIPDInvoiceItemBalanceAmount(@InvoiceNo varchar(20), @ExtraBillNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @InvoiceAmount int
declare @UpAmount int
declare @DownAmount int
declare @NetAmount int

declare @UpAdjustmentTypeID varchar(10)
declare @DownAdjustmentTypeID varchar(10)

set @UpAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','U')
set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','D')


----------------------------------------------------------------------------------------------------------------
set @InvoiceAmount = (select sum(Amount) from InvoiceExtraBillItems
				where InvoiceNo= @InvoiceNo and ExtraBillNo = @ExtraBillNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)

set @UpAmount = (select sum(InvoiceExtraBillItemAdjustments.Amount) from InvoiceExtraBillItemAdjustments
                 inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo
				where InvoiceExtraBillItemAdjustments.InvoiceNo= @InvoiceNo and ExtraBillNo = @ExtraBillNo  
				and InvoiceExtraBillItemAdjustments.ItemCategoryID = @ItemCategoryID and InvoiceExtraBillItemAdjustments.ItemCode = @ItemCode 
				and AdjustmentTypeID = @UpAdjustmentTypeID)

set @DownAmount = (select sum(InvoiceExtraBillItemAdjustments.Amount) from InvoiceExtraBillItemAdjustments
                 inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo
				where InvoiceExtraBillItemAdjustments.InvoiceNo= @InvoiceNo and ExtraBillNo = @ExtraBillNo  
				and InvoiceExtraBillItemAdjustments.ItemCategoryID = @ItemCategoryID and InvoiceExtraBillItemAdjustments.ItemCode = @ItemCode 
				and AdjustmentTypeID = @DownAdjustmentTypeID)
	
set @InvoiceAmount = isnull(@InvoiceAmount, 0)
set @UpAmount = isnull(@UpAmount, 0)
set @DownAmount = isnull(@DownAmount, 0)

set @NetAmount = (@InvoiceAmount + @UpAmount) - @DownAmount

return @NetAmount

end

go

/**********************************************************************************************************
select * from InvoiceExtraBillItems
select * from InvoiceExtraBillItemAdjustments

print dbo.GetIPDInvoiceItemBalanceAmount('15039763', '1206726003', '7D', 'M488')
print dbo.GetIPDInvoiceItemBalanceAmount('15040206', '1512356001', '7D', 'M287')
***********************************************************************************************************/

if exists (select * from sysobjects where name = 'GetInvoiceReversedAmount')
	drop function  GetInvoiceReversedAmount
go

create function  GetInvoiceReversedAmount(@InvoiceNo varchar(20), @VisitTypeID varchar(10)) returns money
with encryption as

begin
declare @ReversedAmount money
declare @OPDVisitTypeID varchar(10)
declare @IPDVisitTypeID varchar(10)
declare @DownAdjustmentTypeID varchar(10)


set @OPDVisitTypeID =  dbo.GetLookupDataID('VisitType','OPD')
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType','IPD')
set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','D')
 
 if (@VisitTypeID = @OPDVisitTypeID )
	  set @ReversedAmount = (select sum(InvoiceDetailAdjustments.Amount) 
	  from InvoiceDetailAdjustments
	  inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceDetailAdjustments.AdjustmentNo
	  where InvoiceDetailAdjustments.InvoiceNo = @InvoiceNo and AdjustmentTypeID = @DownAdjustmentTypeID)

 else if (@VisitTypeID = @IPDVisitTypeID )
	  set @ReversedAmount = (select sum(InvoiceExtraBillItemAdjustments.Amount) from InvoiceExtraBillItemAdjustments
	  inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo
	  where InvoiceExtraBillItemAdjustments.InvoiceNo= @InvoiceNo and AdjustmentTypeID = @DownAdjustmentTypeID)

      set @ReversedAmount= isnull(@ReversedAmount,0)
  return @ReversedAmount
end
go


/*****************************************************************************************************************************
 print dbo.GetInvoiceReversedAmount('','110OPD')
 print dbo.GetInvoiceReversedAmount('17070561', '110IPD')
 select * from CreditNote
*****************************************************************************************************************************/

--------Function GetCreditNoteQuantity----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCreditNoteQuantity')
	drop function GetCreditNoteQuantity
go

create function GetCreditNoteQuantity(@InvoiceNo varchar(20), @VisitNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @Quantity int
declare @DownAdjustmentTypeID varchar(10)
set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','D')

----------------------------------------------------------------------------------------------------------------
set @Quantity = (select sum(Quantity) from InvoiceDetailAdjustments
                 inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceDetailAdjustments.AdjustmentNo
				where InvoiceDetailAdjustments.InvoiceNo= @InvoiceNo and VisitNo = @VisitNo  
				and InvoiceDetailAdjustments.ItemCategoryID = @ItemCategoryID and InvoiceDetailAdjustments.ItemCode = @ItemCode 
				and AdjustmentTypeID = @DownAdjustmentTypeID)
	
set @Quantity = isnull(@Quantity, 0)

return @Quantity

end

go

/**********************************************************************************************************
select * from InvoiceDetails
print dbo.GetCreditNoteQuantity('12000001', '1003/04004', 'RPT001', '7S')
print dbo.GetCreditNoteQuantity('12000002', '1106647031', 'M118', '7D')
***********************************************************************************************************/



--------Function GetCreditNoteAmount----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCreditNoteAmount')
	drop function GetCreditNoteAmount
go

create function GetCreditNoteAmount(@InvoiceNo varchar(20), @VisitNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns money
with encryption as

begin

declare @Amount money
declare @DownAdjustmentTypeID varchar(10)

set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','D')

----------------------------------------------------------------------------------------------------------------
set @Amount = (select sum(InvoiceDetailAdjustments.Amount) from InvoiceDetailAdjustments
                inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceDetailAdjustments.AdjustmentNo
				where InvoiceDetailAdjustments.InvoiceNo= @InvoiceNo and VisitNo = @VisitNo  and InvoiceDetailAdjustments.ItemCategoryID = @ItemCategoryID 
				and InvoiceDetailAdjustments.ItemCode = @ItemCode and AdjustmentTypeID = @DownAdjustmentTypeID)
	
set @Amount = isnull(@Amount, 0)

return @Amount

end

go

/**********************************************************************************************************
select * from InvoiceDetailAdjustments
print dbo.GetCreditNoteAmount('17071757', '1714857', 'T074', '7T')
print dbo.GetCreditNoteAmount('12000002', '1106647031', 'M118', '7D')
**********************************************************************************************************/
-------------------------------------------------------------------------------------------------------------------

--------Function GetCreditNoteIPDQuantity----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCreditNoteIPDQuantity')
	drop function GetCreditNoteIPDQuantity
go

create function GetCreditNoteIPDQuantity(@InvoiceNo varchar(20), @ExtraBillNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @Quantity varchar(20)
declare @DownAdjustmentTypeID varchar(10)

set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','D')
----------------------------------------------------------------------------------------------------------------
set @Quantity = (select sum(Quantity) from InvoiceExtraBillItemAdjustments
                 inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo
				where InvoiceExtraBillItemAdjustments.InvoiceNo= @InvoiceNo and ExtraBillNo = @ExtraBillNo  
				and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode and AdjustmentTypeID = @DownAdjustmentTypeID)
	
set @Quantity = isnull(@Quantity, 0)

return @Quantity

end

go

/**********************************************************************************************************
select * from CreditNoteExtraBillItems
print dbo.GetCreditNoteIPDQuantity('17071757', '1714857', 'T074', '7T')
print dbo.GetCreditNoteIPDQuantity('12000002', '1106647031', 'M118', '7D')
**********************************************************************************************************/


--------Function GetCreditNoteIPDAmount----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCreditNoteIPDAmount')
	drop function GetCreditNoteIPDAmount
go

create function GetCreditNoteIPDAmount(@InvoiceNo varchar(20), @ExtraBillNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns money
with encryption as

begin

declare @Amount money
declare @DownAdjustmentTypeID varchar(10)

set @DownAdjustmentTypeID = dbo.GetLookupDataID('AdjustmentType','D')
----------------------------------------------------------------------------------------------------------------
set @Amount = (select sum( InvoiceExtraBillItemAdjustments.Amount) from InvoiceExtraBillItemAdjustments 
               inner join InvoiceAdjustments on InvoiceAdjustments.AdjustmentNo = InvoiceExtraBillItemAdjustments.AdjustmentNo
				where  InvoiceExtraBillItemAdjustments.InvoiceNo= @InvoiceNo and ExtraBillNo = @ExtraBillNo  
				and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode and AdjustmentTypeID = @DownAdjustmentTypeID)
	
set @Amount = isnull(@Amount, 0.00)

return @Amount

end

go

/**********************************************************************************************************
select * from CreditNoteExtraBillItems
print dbo.GetCreditNoteIPDAmount('17071757', '1714857', 'T074', '7T')
print dbo.GetCreditNoteIPDAmount('12000002', '1106647031', 'M118', '7D')
**********************************************************************************************************/


--------Function GetInvoiceDetailsCategoryAmount ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInvoiceDetailsCategoryAmount')
drop function GetInvoiceDetailsCategoryAmount
go

create function GetInvoiceDetailsCategoryAmount(@InvoinceNo varchar(20), @VisitNo varchar(20), @ItemCategoryID varchar(10)) returns money
with encryption as

begin

declare @CategoryAmount money
set @CategoryAmount = (select sum(Amount) from InvoiceDetails where InvoiceNo = @InvoinceNo and VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID)
set @CategoryAmount = isnull(@CategoryAmount, 0.00)

return @CategoryAmount


end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetInvoiceDetailsCategoryAmount('17000001', 'EXP000019009', '7T'))
-- print dbo.FormatMoney(dbo.GetInvoiceDetailsCategoryAmount('17000001', 'EXP000019009', '7D'))
-- print dbo.FormatMoney(dbo.GetInvoiceDetailsCategoryAmount('17000018', 'EXP000907001', '7T'))
-- print dbo.FormatMoney(dbo.GetInvoiceDetailsCategoryAmount('17000001', 'EXP000019009', '7T'))
-- select * from InvoiceDetails


--------Function GetInvoiceDetailAdjustmentCategoryAmount ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInvoiceDetailAdjustmentCategoryAmount')
drop function GetInvoiceDetailAdjustmentCategoryAmount
go

create function GetInvoiceDetailAdjustmentCategoryAmount(@AdjustmentNo varchar(20), @InvoinceNo varchar(20), @VisitNo varchar(20), @ItemCategoryID varchar(10)) returns money
with encryption as

begin

declare @CategoryAmount money
set @CategoryAmount = (select sum(Amount) from InvoiceDetailAdjustments  where AdjustmentNo = @AdjustmentNo and InvoiceNo = @InvoinceNo and VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID)
set @CategoryAmount = isnull(@CategoryAmount, 0.00)

return @CategoryAmount


end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetInvoiceDetailAdjustmentCategoryAmount('18085920001', '18085920', '1700292005', '7S'))
-- print dbo.FormatMoney(dbo.GetInvoiceDetailAdjustmentCategoryAmount('1804325201' , '18043252', '1801650002', '7D'))
-- print dbo.FormatMoney(dbo.GetInvoiceDetailAdjustmentCategoryAmount('1806611701', '18066117', 'M037626004', '7E'))
-- select * from InvoiceDetailAdjustments where AdjustmentNo = '1806611701'



--------Function GetExtraBillItemsCategoryAmount ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetExtraBillItemsCategoryAmount')
drop function GetExtraBillItemsCategoryAmount
go

create function GetExtraBillItemsCategoryAmount(@ExtraBillNo varchar(20), @ItemCategoryID varchar(10)) returns money
with encryption as

begin

declare @CategoryAmount money
set @CategoryAmount = (select sum(OriginalQuantity * OriginalPrice) from ExtraBillItems where ExtraBillNo = @ExtraBillNo and ItemCategoryID = @ItemCategoryID)
set @CategoryAmount = isnull(@CategoryAmount, 0.00)

return @CategoryAmount


end

go

----------------------------------------------------------------------------------------------------------------------------
/***************************************************************************************************************************
 print dbo.FormatMoney(dbo.GetExtraBillItemsCategoryAmount('P16000020001', '7D'))
 print dbo.FormatMoney(dbo.GetExtraBillItemsCategoryAmount('P16000020001', '7C'))
 print dbo.FormatMoney(dbo.GetExtraBillItemsCategoryAmount('P16000020002', '7D'))
 print dbo.FormatMoney(dbo.GetExtraBillItemsCategoryAmount('P16000020002', '7C'))
 select * from ExtraBillItems
 ***************************************************************************************************************************/

--------Function GetExtraBillItemAdjustmentCategoryAmount ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetExtraBillItemAdjustmentCategoryAmount')
drop function GetExtraBillItemAdjustmentCategoryAmount
go

create function GetExtraBillItemAdjustmentCategoryAmount(@AdjustmentNo varchar(20), @ExtraBillNo varchar(20), @ItemCategoryID varchar(10)) returns money
with encryption as

begin

declare @CategoryAmount money
set @CategoryAmount = (select sum(Amount) from ExtraBillItemAdjustments  where AdjustmentNo = @AdjustmentNo and ExtraBillNo = @ExtraBillNo and ItemCategoryID = @ItemCategoryID)
set @CategoryAmount = isnull(@CategoryAmount, 0.00)

return @CategoryAmount


end

go

---------------------------------------------------------------------------------------------------------------------------

/*****************************************************************************************************************************
 print dbo.FormatMoney(dbo.GetExtraBillItemAdjustmentCategoryAmount('P170000159013001', 'P170000159013',  '7C'))
 print dbo.FormatMoney(dbo.GetExtraBillItemAdjustmentCategoryAmount('P170001021001001' , 'P170001021001', '7D'))
 print dbo.FormatMoney(dbo.GetExtraBillItemAdjustmentCategoryAmount('P170001021001001', 'P170001021001', '7C'))
 select * from ExtraBillItemAdjustments
****************************************************************************************************************************/

------------------------------------------------------------------------------------------------------------------
------------------------------------------  IsOPDBillReconciled  ----------------------------------------------------
------------------------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'IsOPDBillReconciled')
drop function  IsOPDBillReconciled
go

create function  IsOPDBillReconciled(@VisitNo varchar(20)) returns bit
with encryption as
begin

declare @UnpaidBill money
declare @AccountBal money
declare @PatientBill money
declare @AccountStatus bit
declare @NotPaidPayStatus  varchar(10)

------------------------------------------------------------------------------------------------------------------

set @NotPaidPayStatus = dbo.GetLookupDataID('PayStatus', 'NP')
------------------------------------------------------------------------------------------------------------------

set @UnpaidBill =isnull((select sum(Quantity* UnitPrice) as UnpaidAmount 
from Items
where Items.VisitNo =@VisitNo and PayStatusID =@NotPaidPayStatus),0)
------------------------------------------------------------------------------------------------------------------

set @AccountBal =isnull((select Balance from Accounts Where 
AccountID = (select Max(AccountID) from Accounts where 
AccountBillNo = dbo.GetPatientNo(@VisitNo))),0)

------------------------------------------------------------------------------------------------------------------

if (@UnpaidBill > 0 and @AccountBal >0)

begin set @AccountStatus=1 end
else begin set @AccountStatus=0 end   

return @AccountStatus
end
go


------------------------------------------------------------------------------------------------------------------
------------------------------------------  IsBillReconciled  ----------------------------------------------------
------------------------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'IsBillReconciled')
drop function  IsBillReconciled
go

create function  IsBillReconciled(@VisitNo varchar(20)) returns bit
with encryption as
begin

declare @UnpaidBill money
declare @AccountBal money
declare @PatientBill money
declare @AccountStatus bit
declare @NotPaidPayStatus  varchar(10)

------------------------------------------------------------------------------------------------------------------

set @NotPaidPayStatus = dbo.GetLookupDataID('PayStatus', 'NP')
------------------------------------------------------------------------------------------------------------------

set @UnpaidBill =isnull((select sum(dbo.GetConsumedQuantity(ExtraBillItems.ExtraBillNo, ItemCode, ItemCategoryID) * ExtraBillItems.UnitPrice) as 
UnpaidAmount from ExtraBillItems
inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
inner join Patients on Admissions.PatientNo = Patients.PatientNo
where Admissions.VisitNo =@VisitNo and PayStatusID =@NotPaidPayStatus),0)
------------------------------------------------------------------------------------------------------------------

set @AccountBal =isnull((select Balance from Accounts Where 
AccountID = (select Max(AccountID) from Accounts where 
AccountBillNo = dbo.GetPatientNo(@VisitNo))),0)

------------------------------------------------------------------------------------------------------------------

if (@UnpaidBill > 0 and @AccountBal >0)

begin set @AccountStatus=1 end
else begin set @AccountStatus=0 end   

return @AccountStatus
end
go

------------------------------------------------------------------------------------------------------------------
-----------------------------print dbo.IsBillReconciled('1449372005')
------------------------------------------------------------------------------------------------------------------


--------Function Get OPD Item InvoicedAmount ------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetOPDItemInvoicedAmount')
drop function GetOPDItemInvoicedAmount
go

create function GetOPDItemInvoicedAmount(@VisitNo varchar(20),  @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns money
with encryption as

begin

declare @InvoiceAmount money

--------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------
begin set @InvoiceAmount = (select top 1 Amount from InvoiceDetails
 Where VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
 order by InvoiceNo desc) end	

--------------------------------------------------------------------------------------------------------------

set @InvoiceAmount = isnull(@InvoiceAmount, 0.00)

return @InvoiceAmount

end

go

 
---- print dbo.GetOPDItemInvoicedAmount('1106647032','7S','10C')

--------Function Item Invoiced Amount ------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDItemInvoicedAmount')
drop function GetIPDItemInvoicedAmount
go

create function GetIPDItemInvoicedAmount(@ExtraBillNo varchar(20),  @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns money
with encryption as

begin


declare @InvoiceAmount money

--------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------
begin set @InvoiceAmount = (select top 1 Amount from InvoiceExtraBillItems
 Where ExtraBillNo = @ExtraBillNo and ItemCategoryID=@ItemCategoryID and ItemCode = @ItemCode
 order by InvoiceNo desc) end	

--------------------------------------------------------------------------------------------------------------

set @InvoiceAmount = isnull(@InvoiceAmount, 0.00)

return @InvoiceAmount

end

go

---- print dbo.GetIPDItemInvoicedAmount('1206726003','7D','M488')
---select * from InvoiceExtraBillItems where ExtraBillNo='1206726003'


--------Function Get IPD Item Invoiced No ------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetOPDItemInvoicedNo')
drop function GetOPDItemInvoicedNo
go

create function GetOPDItemInvoicedNo(@VisitNo varchar(20),  @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns varchar(20)
with encryption as

begin

declare @InvoiceNo varchar(20)

--------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------
begin set @InvoiceNo = (select top 1 InvoiceNo from InvoiceDetails
 Where VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
 order by InvoiceNo desc) end	

--------------------------------------------------------------------------------------------------------------

set @InvoiceNo = isnull(@InvoiceNo, '')

return @InvoiceNo

end

go


---- print dbo.GetIPDItemInvoicedNo('1106647032','7S','10C')


-------Get Extra Bill Item Invoiced No ------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetExtraBillItemInvoicedNo')
drop function GetExtraBillItemInvoicedNo
go

create function GetExtraBillItemInvoicedNo(@ExtraBillNo varchar(20),  @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns varchar(20)
with encryption as

begin


declare @InvoiceNo varchar(20)

--------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------
begin set @InvoiceNo = (select top 1 InvoiceNo from InvoiceExtraBillItems
 Where ExtraBillNo = @ExtraBillNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
 order by InvoiceNo desc) end	

--------------------------------------------------------------------------------------------------------------

set @InvoiceNo = isnull(@InvoiceNo, '')

return @InvoiceNo

end

go

---- print dbo.GetExtraBillItemInvoicedNo('1206726003','7D','M488')

------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInvoiceBillNo')
drop function GetInvoiceBillNo
go

create function GetInvoiceBillNo(@PayTypeID varchar(10), @PayNo varchar(20)) returns varchar(20)
with encryption as
begin

declare @BillModesID varchar(10)
declare @BillNo varchar(20)

declare @VisitBillPayTypeID varchar(10)
declare @AccountBillPayTypeID varchar(10)

----------------------------------------------------------------------------
set @VisitBillPayTypeID =  dbo.GetLookupDataID('PayType', 'CAS')
set @AccountBillPayTypeID =  dbo.GetLookupDataID('PayType', 'ACC')

----------------------------------------------------------------------------

begin

if (@PayTypeID = @VisitBillPayTypeID)
begin
set @BillNo = (select BillNo from Visits where VisitNo = @PayNo)
end

else if (@PayTypeID = @AccountBillPayTypeID)
begin
set @BillNo=  @PayNo
end

else set @BillNo = ''
set @BillNo = isnull(@BillNo, '')
end

return @BillNo

end
go


--------Function GetInvoiceBillPatientNo-----------------------------------------------------------------------------


if exists (select * from sysobjects where name = 'GetInvoiceBillPatientNo')
drop function GetInvoiceBillPatientNo
go

create function GetInvoiceBillPatientNo(@PayTypeID varchar(10), @PayNo varchar(20)) returns varchar(60)
with encryption as
begin

declare @BillModesID varchar(10)
declare @BillNo varchar(20)

declare @VisitBillPayTypeID varchar(10)
declare @BillName varchar(60)

----------------------------------------------------------------------------
set @VisitBillPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
----------------------------------------------------------------------------

begin

if (@PayTypeID = @VisitBillPayTypeID)
begin
set @BillModesID = (select BillModesID from Visits where VisitNo = @PayNo)
set @BillNo = (select top 1 PatientNo from Visits where VisitNo = @PayNo)
end
else set @BillNo = @PayNo
set @BillNo = isnull(@BillNo, '')
end

return @BillNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInvoiceBillPatientNo('47CAS', '1207290010')
-- print dbo.GetInvoiceBillPatientNo('47ACC', 'CM00304')
-- print dbo.GetInvoiceBillPatientNo('47INS', 'CMC')
-- print dbo.GetInvoiceBillPatientNo('', null)
----------------------------------------------------------------------------------------------------------------------------


---------------------------- Get Extra Charge Items CategoryID -------------------------------------------------------
if exists (select * from sysobjects where name = 'GetExtraChargeItemsCategoryID')
	drop function GetExtraChargeItemsCategoryID
go

create function GetExtraChargeItemsCategoryID(@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns varchar(20)
with encryption as

begin

declare @ExtraChargeItemCategoryID varchar (10)
declare @ExtraChargeCategory varchar(10)

set @ExtraChargeItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'E')

if not @ItemCategoryID = @ExtraChargeItemCategoryID set @ExtraChargeCategory = ''
else 
  begin
  set  @ExtraChargeCategory = (select ExtraChargeCategoryID from ExtraChargeItems where ExtraItemCode =  @ItemCode)
  end

 set @ExtraChargeCategory= isnull(@ExtraChargeCategory, '')

return @ExtraChargeCategory

end
go

/***************************************************************************************************
Usage
 Code: 
 dbo.GetExtraChargeItemsCategoryID('7E', 'ACC001')
 description: 
 dbo.GetLookupDataDes(dbo.GetExtraChargeItemsCategoryID('7E', 'ACC001'))
***************************************************************************************************/

-- select * from BillCustomers where AccountNo= 'P038981'

--------Function GetMappedCustomCodes-----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetMappedCustomCodes')
drop function GetMappedCustomCodes
go

create function GetMappedCustomCodes(@ItemCode varchar(20)) returns varchar(20)
with encryption as

begin

declare @customCode varchar(20)

set @customCode =isnull((select TOP 1 CustomCode from MappedCodes where  ItemCode =@ItemCode),@ItemCode)
 
return @customCode

end
go

---select * from MappedCodes
---print dbo.GetMappedCustomCodes('t001')
----------------------------------------------------------------------------------------------------------

--------Function GetMappedCustomCode-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetMappedCustomCode')
drop function GetMappedCustomCode
go

create function GetMappedCustomCode(@AccountNo varchar(20), @ItemCode varchar(20),@ItemCategoryID varchar(10)) returns varchar(20)
with encryption as

begin

declare @customCode varchar(20)

set @customCode =isnull((select TOP 1 CustomCode from MappedCodes where AccountNo =@AccountNo and ItemCode =@ItemCode
and ItemCategoryID = @ItemCategoryID),@ItemCode)
 
return @customCode

end
go

---select * from MappedCodes
---print dbo.GetMappedCustomCode('A17022','t001','7c')
----------------------------------------------------------------------------------------------------------

--------Function GetMappedCustomCodeByVisitNo-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetMappedCustomCodeByVisitNo')
drop function GetMappedCustomCodeByVisitNo
go

create function GetMappedCustomCodeByVisitNo(@VisitNo varchar(20), @ItemCode varchar(20),@ItemCategoryID varchar(10)) returns varchar(20)
with encryption as

begin

declare @customCode varchar(20)
declare @AccountNo varchar(20)

set @AccountNo = (select BillNo from Visits where VisitNo =  @VisitNo)
set @customCode =isnull((select TOP 1 CustomCode from MappedCodes where AccountNo =@AccountNo and ItemCode =@ItemCode
and ItemCategoryID = @ItemCategoryID),@ItemCode)
 
return @customCode

end
go

/*************************************************************************************************
select * from MappedCodes
print dbo.GetMappedCustomCodeByVisitNo('P17033904001','DRG0089','7D')
---------------------------------------------------------------------------------------------------*/


--------Function GetIPDItemInvoiceNo----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDItemInvoiceNo')
	drop function GetIPDItemInvoiceNo
go

create function GetIPDItemInvoiceNo(@ExtraBillNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns varchar(20)
with encryption as

begin

declare @InvoiceNo varchar(20)

----------------------------------------------------------------------------------------------------------------
set @InvoiceNo = (select top 1 InvoiceNo from InvoiceExtraBillItems
				where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	
set @InvoiceNo = isnull(@InvoiceNo, '')

return @InvoiceNo

end

go



----------------------------------------------------------------------------------------------------------------------

--------Function GetItemInvoiceNo----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetItemReceiptNo')
	drop function GetItemReceiptNo
go

create function GetItemReceiptNo(@VisitNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns varchar(20)
with encryption as

begin

declare @ReceiptNo varchar(20)

----------------------------------------------------------------------------------------------------------------
set @ReceiptNo = (select top 1 ReceiptNo from PaymentDetails
				where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID
				order by ReceiptNo desc)
	
set @ReceiptNo = isnull(@ReceiptNo, '')

return @ReceiptNo

end

go
--------------------------------------------------------------------------------------------------------------------------

--------Function GetIPDItemReceiptNo----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDItemReceiptNo')
	drop function GetIPDItemReceiptNo
go

create function GetIPDItemReceiptNo(@ExtraBillNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns varchar(20)
with encryption as

begin

declare @ReceiptNo varchar(20)

----------------------------------------------------------------------------------------------------------------
set @ReceiptNo = (select ReceiptNo from PaymentExtraBillItems
				where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	
set @ReceiptNo = isnull(@ReceiptNo, '')

return @ReceiptNo

end

go
------------------------------------------------------------------------------------------------------------------


----------Function  GetRefundItemAmount-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetRefundItemAmount')
drop function  GetRefundItemAmount
go

create function  GetRefundItemAmount(@ReceiptNo varchar(20), @VisitNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns money
with encryption as

begin

declare @RefundedAmount money
-----------------------------------------------------------------------------
 
 begin
	set @RefundedAmount = (select sum(Amount)
	from RefundDetails 
	where ReceiptNo= @ReceiptNo and VisitNo=@VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
 end
 
set @RefundedAmount= isnull(@RefundedAmount,0.00)
return @RefundedAmount
end
go

/*************************************************************************************************************
select * from RefundDetails
print dbo.GetRefundItemAmount('170058151', '', '', '')
*************************************************************************************************************/
--------------------------------------------------------------------------------------------------------------------------


----------Function  GetRefundItemQuantity-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetRefundItemQuantity')
drop function  GetRefundItemQuantity
go

create function  GetRefundItemQuantity(@ReceiptNo varchar(20), @VisitNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns int
with encryption as

begin

declare @PreviousRefunded money
-----------------------------------------------------------------------------

 begin
	set @PreviousRefunded = (select sum(Quantity) 
	from RefundDetails 
	where ReceiptNo = @ReceiptNo and ItemCode = @ItemCode and VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID)
 end
 
set @PreviousRefunded= isnull(@PreviousRefunded,0)
return @PreviousRefunded
end
go

/***************************************************************************************************
select * from RefundDetails
print dbo.GetRefundItemQuantity('10000001', '1715754005', 'RES868', '7M')
****************************************************************************************************/
----------Function  GetIPDRefundItemQuantity-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDRefundItemQuantity')
drop function  GetIPDRefundItemQuantity
go

create function  GetIPDRefundItemQuantity(@ReceiptNo varchar(20), @ExtraBillNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns int
with encryption as

begin

declare @PreviousRefunded money
-----------------------------------------------------------------------------

  begin
	set @PreviousRefunded = (select sum(Quantity) 
	from RefundExtraBillItems 
	where ReceiptNo = @ReceiptNo and ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
 end	  
set @PreviousRefunded= isnull(@PreviousRefunded,0)
return @PreviousRefunded
end
go

/***************************************************************************************************
select * from RefundRequestExtraBillItems
print dbo.GetIPDRefundItemQuantity('10000001', '1715754005', 'RES868', '7M')
****************************************************************************************************/

----------Function  GetIPDRefundItemAmount-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDRefundItemAmount')
drop function  GetIPDRefundItemAmount
go

create function  GetIPDRefundItemAmount(@ReceiptNo varchar(20), @ExtraBillNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns int
with encryption as

begin

declare @PreviousRefunded money
-----------------------------------------------------------------------------

  begin
	set @PreviousRefunded = (select sum(Amount) 
	from RefundExtraBillItems 
	where ReceiptNo = @ReceiptNo and ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
 end	  
set @PreviousRefunded= isnull(@PreviousRefunded,0.00)
return @PreviousRefunded
end
go

/***************************************************************************************************
select * from RefundRequestExtraBillItems
print dbo.GetIPDRefundItemAmount('10000001', '1715754005', 'RES868', '7M')
****************************************************************************************************/
------------------------------------------------------------------------------------------------------------------------------


--------Function IsExtraBillItemReturnable----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'IsExtraBillItemReturnable')
drop function IsExtraBillItemReturnable
go

create function IsExtraBillItemReturnable(@ExtraBillNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns bit
with encryption as

begin

declare @MannualEntryModesID varchar(10)
declare @DrugItemCategoryID varchar(10)
declare @ConsumableItemCategoryID varchar(10)
declare @NonMedicalItemCategoryID varchar(10)

declare @Returnable bit

set @MannualEntryModesID = dbo.GetLookupDataID('EntryMode', 'SYS')
set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')
set @NonMedicalItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'NM')

----------------------------------------------------------------------------------------------------------------
 if not (@ItemCategoryID = @DrugItemCategoryID or @ItemCategoryID = @ConsumableItemCategoryID or @ItemCategoryID = @NonMedicalItemCategoryID)
  begin  set @Returnable = 0 end
 else
  begin
	  if exists (select ExtraBillNo from ExtraBillItems
	  where ExtraBillNo = @ExtraBillNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
	  and EntryModeID = @MannualEntryModesID)
	  begin set @Returnable = 1 end
	 else  begin set @Returnable = 0 end
 end
  set @Returnable = isnull(@Returnable,0)

return @Returnable

end

go



----------Function  Get Client Patients-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetClientPatients')
drop function  GetClientPatients
go

create function GetClientPatients (@ReferenceNo varchar(20)) returns bit
with encryption as

begin

declare @saved bit
begin
if exists((select TOP 1 (PatientNo) from Patients where ReferenceNo= @ReferenceNo)) begin set @saved=1 end
else begin set @saved=0 end
end
return @saved 
 
end
go



-------------------------GetVATValue-------------------------------

if exists (select * from sysobjects where name = 'GetVATValue')
drop function GetVATValue
go

create function GetVATValue(@ItemCategoryID varchar(10), @ItemCode varchar(20), @Quantity int,
@UnitPrice money) returns money
with encryption as

begin

declare @VATPercentage decimal
declare @VATValue money

set @VATPercentage= dbo.GetVATPercentage(@ItemCategoryID, @ItemCode)

set @VATValue= (@Quantity*@UnitPrice*@VATPercentage)/100

set @VATValue= isnull(@VATValue,0)


return @VATValue

end

go


-------------------------GetVATValue----------------------

--------Function GetWeightedCostAverage------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetWeightedCostAverage')
drop function GetWeightedCostAverage
go

create function GetWeightedCostAverage(@ItemCategoryID varchar(10), @ItemCode varchar(20), 
						@StockTypeID as varchar(10),@Quantity int) returns int
with encryption as

begin

declare @IssuedStockTypeID varchar(10)
declare @ReceivedStockTypeID varchar(10)
declare @Balance money
declare @WeightedCost money
declare @UnitCost money
declare @MaxTranID int

set @MaxTranID=(select max(TranID) 
		from Inventory where 
			ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)

set @IssuedStockTypeID = dbo.GetLookupDataID('StockType', 'I')
set @ReceivedStockTypeID = dbo.GetLookupDataID('StockType', 'R')
---------------------------------------------------------------------------------------------------------------------
set @UnitCost= dbo.GetItemUnitCost(@ItemCategoryID, @ItemCode)

set @Balance = (select Balance from Inventory Where TranID=@MaxTranID)

set @WeightedCost  = (select WeightedCostAverage from Inventory Where TranID =@MaxTranID) 

if(@StockTypeID)=@IssuedStockTypeID
begin set @WeightedCost= @WeightedCost end
else if(@StockTypeID)=@ReceivedStockTypeID
begin 
set @WeightedCost=((@WeightedCost*@Balance)+(@Quantity*@UnitCost))/(@Balance+@Quantity)
end
set @WeightedCost = isnull(@WeightedCost, 0)
return @WeightedCost
end

go

----------------------------------------------------------------------------------------------------------------------------
--  print dbo.GetWeightedCostAverage('11702', '7D', 'M285','13R', 10)
-----select * from Inventory order by RecordDateTime desc

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetLocationUnits('11701', '7D', 'M423')
----------------------------------------------------------------------------------------------------------------------------


------------------------------------------------ GetStockTakeQuantity ---------------------------------------------------------

if exists (select * from sysobjects where name = 'GetStockTakeQuantity')
drop function  GetStockTakeQuantity
go

create function GetStockTakeQuantity (@PSCNO varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as


begin
declare @Quantity int

set @Quantity = (select sum(PhysicalCountQuantity) from PhysicalStockCountDetails 
where PSCNo = @PSCNO and ItemCategoryID =@ItemCategoryID and ItemCode = @ItemCode)

set @Quantity = isnull(@Quantity, 0)
return @Quantity
end
go

--- print dbo.GetStockTakeQuantity('180012', '7D', 'DRG0005')
--- print dbo.GetStockTakeQuantity('180012', '7C', 'C0001')





--------Function GetMaxInventoryTransID-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetMaxInventoryTransID')
drop function GetMaxInventoryTransID
go

create function GetMaxInventoryTransID(@LocationID varchar(10), @ItemCategoryID varchar(10), 
						@ItemCode varchar(20), @EndDateTime as smalldatetime) returns int
with encryption as

begin

declare @maxTranID int

if (@LocationID is null or @LocationID = '') 
begin
set @maxTranID = (select max(TranID) from Inventory where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
		and RecordDateTime <= @EndDateTime)
end
else
begin
set @maxTranID = (select max(TranID) from Inventory where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
		and RecordDateTime <= @EndDateTime)
end

set @maxTranID = isnull(@maxTranID, 0)

return @maxTranID

end

go

--------Function Get Total Bill Paid OnAccount--------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalBillPaidOnAccount')
drop function GetTotalBillPaidOnAccount
go
create function GetTotalBillPaidOnAccount(@VisitNo varchar(20)) returns money
with encryption as
begin
declare @TotalBill money
begin
set @TotalBill = isnull((select sum((PaymentDetails.Quantity * PaymentDetails.UnitPrice) - Discount) from PaymentDetails
inner join Payments on PaymentDetails.ReceiptNo = Payments.ReceiptNo
where VisitNo = @VisitNo and UseAccountBalance = 1),0)
end
return @TotalBill

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetTotalBillPaidOnAccount('1501148')
----------------------------------------------------------------------------------------------------------------------------

-------------------------GetTotalOrdered----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalOrdered')
drop function GetTotalOrdered
go

create function GetTotalOrdered (@PurchaseOrderNo varchar(10),@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @TotalOrdered int

set @TotalOrdered =(select (Quantity*PackSize) from PurchaseOrderDetails where PurChaseOrderNo=@PurchaseOrderNo and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode)
set @TotalOrdered = isnull(@TotalOrdered,0)
return @TotalOrdered 

end

go


-------------------------------------print dbo.GetTotalOrdered ('160047','7D','M2847')--------------------------------------------------------------------------

-------------------------GetTotalReceived----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalReceived')
drop function GetTotalReceived
go

create function GetTotalReceived (@GRNNo varchar(20),@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin


declare @TotalReceived int

set @TotalReceived=(select (ReceivedQuantity*PackSize) from GoodsReceivedNoteDetails where GRNNo=@GRNNo and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode)

set @TotalReceived= isnull(@TotalReceived,0)
return @TotalReceived

end

go

----print dbo.GetTotalReceived ('1600470001','7D','M2847')

-----------------------------------------------------------------------------------------------------------------


--------Function GetOPDIssuingLocation----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetOPDIssuingLocation')
drop function GetOPDIssuingLocation
go

create function GetOPDIssuingLocation( @VisitNo varchar(20), @ItemCategoryID varchar(10),@ItemCode varchar(20)) returns varchar(10)
with encryption as
begin 

declare @LocationID varchar(10)

begin
set @LocationID = (select LocationID from ItemsEXT where VisitNo = @VisitNo 
		and ItemCode= @ItemCode and ItemCategoryID= @ItemCategoryID)
end

set @LocationID = isnull(@LocationID,'')

return @LocationID
end

go

-----------------------------------------------------------------------------------------------------------------
-----print dbo.GetOPDIssuingLocation('1300001008','7D','M231')
-----------------------------------------------------------------------------------------------------------------


--------Function GetBankedInAccountCurrency-------------------------------------------------------------------------------------

if  exists(select * from sysObjects where name='GetBankedInAccountCurrency')
drop function GetBankedInAccountCurrency
go

create function GetBankedInAccountCurrency(
@AccountNo varchar(20),
@BankedInCurrency varchar(10),
@BankedAmount money
) returns money with encryption as

begin 
declare @AccountCurrency varchar(10)
declare @ExchangeRate money
declare @UGX  varchar(10)
declare @ConvertedAmount money

set @AccountCurrency= (select CurrencyID from BankAccounts where AccountNo=@AccountNo)
set @UGX = dbo.GetLookupDataID('Currencies', 'UGX')
set @ExchangeRate=(select  Buying from ExchangeRates where CurrenciesID = @BankedInCurrency)

if @BankedInCurrency=@AccountCurrency
begin
set @ConvertedAmount=@BankedAmount
end
else
begin
if  @AccountCurrency=@UGX
begin
set @ConvertedAmount=(@BankedAmount) *(@ExchangeRate)
	   
end
else
begin
set @ExchangeRate=(select  Buying from ExchangeRates where CurrenciesID =  @AccountCurrency)
set @ConvertedAmount=@BankedAmount/@ExchangeRate
end
end
set @ConvertedAmount= isnull(@ConvertedAmount,0.00)
return @ConvertedAmount
end
go
--------------print dbo.GetBankedInAccountCurrency('4667896556','49UGX','24160000.00')------------------

---------------------------------------------------------------------------------------------------


--------Function GetPriority-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPriority')
drop function GetPriority
go

create function GetPriority(@visitNo varchar(20)) returns varchar(10)
with encryption as

begin

declare @Priority varchar(10)
declare @NOPriority varchar(10)
set @NOPriority = dbo.GetLookupDataID('Priority', 'NO')
if exists(select TriagePriorityID from Triage where Triage.visitNo = @visitNo)
Begin set @Priority = (select dbo.GetLookUpDataDes(TriagePriorityID) from Triage where Triage.visitNo = @visitNo )end
else if exists(select VisitsPriorityID from Visits where Visits.visitNo = @visitNo)
Begin set @Priority = (select dbo.GetLookUpDataDes(VisitsPriorityID) from Visits where Visits.visitNo = @visitNo) end
else Begin set @Priority = dbo.GetLookUpDataDes(@NOPriority)  end
set @Priority = isnull(@Priority,  dbo.GetLookUpDataDes(@NOPriority))
return @Priority
end
go

-----------------------------------------------------------------------------------------------------------------
--------Function GetBankedInAccountCurrency-------------------------------------------------------------------------------------
if  exists(select * from sysObjects where name='GetBankedInAccountCurrency')
drop function GetBankedInAccountCurrency
go

create function GetBankedInAccountCurrency(
@AccountNo varchar(20),
@BankedInCurrency varchar(10),
@BankedAmount money
) returns money with encryption as

begin 
declare @AccountCurrency varchar(10)
declare @ExchangeRate money
declare @UGX  varchar(10)
declare @ConvertedAmount money

set @AccountCurrency= (select CurrencyID from BankAccounts where AccountNo=@AccountNo)
set @UGX = dbo.GetLookupDataID('Currencies', 'UGX')
set @ExchangeRate=(select  Buying from ExchangeRates where CurrenciesID = @BankedInCurrency)

if @BankedInCurrency=@AccountCurrency
begin
set @ConvertedAmount=@BankedAmount
end
else
begin
if  @AccountCurrency=@UGX
begin
set @ConvertedAmount=(@BankedAmount) *(@ExchangeRate)
	   
end
else
begin
set @ExchangeRate=(select  Buying from ExchangeRates where CurrenciesID =  @AccountCurrency)
set @ConvertedAmount=@BankedAmount/@ExchangeRate
end
end
set @ConvertedAmount= isnull(@ConvertedAmount,0.00)
return @ConvertedAmount
end
go
--------------print dbo.GetBankedInAccountCurrency('4667896556','49UGX','24160000.00')------------------
---------------------------------------------------------------------------------------------------

--------Function GetDrQuantityitemsEXT-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDrQuantityitemsEXT')
drop function GetDrQuantityitemsEXT
go

create function GetDrQuantityitemsEXT(@VisitNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as
begin

declare @DrQuantity int
--------------------------

if (exists(select DrQuantity from itemsEXT where VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode))
  
begin
set @DrQuantity =(select DrQuantity from itemsExt where VisitNo = @VisitNo 
and	ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)	
			 
end
else
begin 
		
set @DrQuantity = isnull(@DrQuantity, 0)
end
return @DrQuantity
	
end
go


----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetDrQuantityitemsEXT('16005768001','7D','M114')





--------Function GetItemUnitCost-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetItemUnitCost')
drop function GetItemUnitCost
go

create function GetItemUnitCost(@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns money
with encryption as

begin

declare @UnitCost money
declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)
declare @PackageID varchar(10)
declare @OtherItems varchar(10)

set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')
set @PackageID = dbo.GetLookupDataID('ItemCategory', 'G')
set @OtherItems = dbo.GetLookupDataID('ItemCategory', 'NM')

if @ItemCategoryID = @ServiceID -- Services
begin
set @UnitCost = (select UnitCost from Services where ServiceCode = @ItemCode)
end

else
if @ItemCategoryID = @DrugID -- Drugs
begin
set @UnitCost = (select UnitCost from Drugs where DrugNo = @ItemCode)
end

else
if @ItemCategoryID = @ConsumableID -- ConsumableItems
begin
set @UnitCost = (select UnitCost from ConsumableItems where ConsumableNo = @ItemCode)
end

else
if @ItemCategoryID = @ProcedureID -- Procedures
begin
set @UnitCost = 0 --(select UnitCost from Procedures where ProcedureCode = @ItemCode)
end

else
if @ItemCategoryID = @DentalID -- DentalServices
begin
set @UnitCost = 0 --(select UnitCost from DentalServices where DentalCode = @ItemCode)
end

else
if @ItemCategoryID = @TheatreID -- TheatreServices
begin
set @UnitCost = 0 --(select UnitCost from TheatreServices where TheatreCode = @ItemCode)
end

else
if @ItemCategoryID = @OpticalID -- OpticalServices
begin
set @UnitCost = 0 --(select UnitCost from OpticalServices where OpticalCode = @ItemCode)
end

else
if @ItemCategoryID = @MaternityID -- MaternityServices
begin
set @UnitCost = 0 --(select UnitCost from MaternityServices where MaternityCode = @ItemCode)
end

else
if @ItemCategoryID = @ICUID -- ICUServices
begin
set @UnitCost = 0 --(select UnitCost from ICUServices where ICUCode = @ItemCode)
end

else
if @ItemCategoryID = @TestID -- Test
begin
set @UnitCost = (select UnitCost from LabTests where TestCode = @ItemCode)
end
	
else
if @ItemCategoryID = @CardiologyID -- Cardiology
begin
set @UnitCost = 0 --(select UnitCost from CardiologyExaminations where ExamCode = @ItemCode)
end

else
if @ItemCategoryID = @RadiologyID -- Radiology
begin
set @UnitCost = 0 --(select UnitCost from RadiologyExaminations where ExamCode = @ItemCode)
end


else
if @ItemCategoryID = @PathologyID -- Pathology
begin
set @UnitCost = 0 --(select UnitCost from PathologyExaminations where ExamCode = @ItemCode)
end


else
if @ItemCategoryID = @EyeID -- EyeServices
begin
set @UnitCost = (select UnitCost from EyeServices where EyeCode = @ItemCode)
end
	
else
if @ItemCategoryID = @AdmissionID -- Admission
begin
set @UnitCost = (select UnitCost from Beds where BedNo = @ItemCode)
end
	
else
if @ItemCategoryID = @ExtrasID -- Extras
begin
set @UnitCost = (select UnitCost from ExtraChargeItems where ExtraItemCode = @ItemCode)
end

else
if @ItemCategoryID = @OtherItems -- Other Items
begin
set @UnitCost = (select UnitCost from OtherItems where ItemCode = @ItemCode)
end

else
if @ItemCategoryID = @PackageID -- Packages
begin
set @UnitCost = (select UnitCost from Packages where PackageNo = @ItemCode)
end
	
else set @UnitCost = 0 

set @UnitCost = isnull(@UnitCost, 0)

return @UnitCost

end
go

-------------------------------------------------------------------------------------
-- print dbo.GetItemUnitCost('7D', 'M516')
-- print dbo.GetItemUnitCost('7S', '10C')
-- print dbo.GetItemUnitCost('7A', '2B')
-------------------------------------------------------------------------------------

--------Function GetItemGroup-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetItemGroup')
drop function GetItemGroup
go

create function GetItemGroup(@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns varchar(100)
with encryption as

begin

declare @ItemGroup varchar(100)
declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)

set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')

if @ItemCategoryID = @ServiceID -- Services
begin set @ItemGroup = dbo.GetLookupDataDes(@ItemCategoryID) end

else
if @ItemCategoryID = @DrugID -- Drugs
begin
set @ItemGroup = (select dbo.GetLookupDataDes(GroupsID) from Drugs where DrugNo = @ItemCode)
end

else
if @ItemCategoryID = @ConsumableID -- ConsumableItems
begin set @ItemGroup = dbo.GetLookupDataDes(@ItemCategoryID) end

else
if @ItemCategoryID = @ProcedureID -- Procedures
begin set @ItemGroup = dbo.GetLookupDataDes(@ItemCategoryID) end

else
if @ItemCategoryID = @DentalID -- DentalServices
begin
set @ItemGroup = (select dbo.GetLookupDataDes(DentalCategoryID) from DentalServices where DentalCode = @ItemCode)
end

else
if @ItemCategoryID = @TheatreID -- TheatreServices
begin set @ItemGroup = dbo.GetLookupDataDes(@ItemCategoryID) end
	
else
if @ItemCategoryID = @OpticalID -- OpticalServices
begin
set @ItemGroup = (select dbo.GetLookupDataDes(OpticalCategoryID) from OpticalServices where OpticalCode = @ItemCode)
end

else
if @ItemCategoryID = @MaternityID -- MaternityServices
begin set @ItemGroup = dbo.GetLookupDataDes(@ItemCategoryID) end

else
if @ItemCategoryID = @ICUID -- ICUServices
begin set @ItemGroup = dbo.GetLookupDataDes(@ItemCategoryID) end

else
if @ItemCategoryID = @TestID -- Test
begin
set @ItemGroup = (select dbo.GetLookupDataDes(LabsID) from LabTests where TestCode = @ItemCode)
end

else
if @ItemCategoryID = @CardiologyID -- Cardiology
begin
set @ItemGroup = (select dbo.GetLookupDataDes(CardiologyCategoriesID) from CardiologyExaminations where ExamCode = @ItemCode)
end
	
else
if @ItemCategoryID = @RadiologyID -- Radiology
begin
set @ItemGroup = (select dbo.GetLookupDataDes(RadiologyCategoriesID) from RadiologyExaminations where ExamCode = @ItemCode)
end

else
if @ItemCategoryID = @PathologyID -- Pathology
begin
set @ItemGroup = (select dbo.GetLookupDataDes(PathologyCategoriesID) from PathologyExaminations where ExamCode = @ItemCode)
end

else
if @ItemCategoryID = @EyeID -- EyeServices
begin set @ItemGroup = dbo.GetLookupDataDes(@ItemCategoryID) end
	
else
if @ItemCategoryID = @AdmissionID -- Admission
begin
set @ItemGroup = (select dbo.GetLookupDataDes(WardsID) from Beds inner join Rooms on Beds.RoomNo = Rooms.RoomNo 
			where BedNo = @ItemCode)
end
	
else
if @ItemCategoryID = @ExtrasID -- Extras
begin
set @ItemGroup = (select dbo.GetLookupDataDes(ExtraChargeCategoryID) from ExtraChargeItems where ExtraItemCode = @ItemCode)
end
	
else begin set @ItemGroup = dbo.GetLookupDataDes(@ItemCategoryID) end

set @ItemGroup = isnull(@ItemGroup, dbo.GetLookupDataDes(@ItemCategoryID))

return @ItemGroup

end
go

-- print dbo.GetItemGroup('7S', '10C')
-- print dbo.GetItemGroup('7D', 'M004')
-- print dbo.GetItemGroup('7C', '2B')
-- print dbo.GetItemGroup('7T', 'T009')
-- print dbo.GetItemGroup('7R', 'CCS')
-- print dbo.GetItemGroup('7L', 'COD015')
-- print dbo.GetItemGroup('7A', '9')
-- print dbo.GetItemGroup('7E', 'CAFE')

--------Function GetUnitMeasure-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetUnitMeasure')
drop function GetUnitMeasure
go

create function GetUnitMeasure(@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns varchar(100)
with encryption as

begin

declare @UnitMeasure varchar(100)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @TestID varchar(10)

set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')

if @ItemCategoryID = @DrugID -- Drugs
begin
set @UnitMeasure = (select dbo.GetLookupDataDes(UnitMeasureID) from Drugs where DrugNo = @ItemCode)
end
else
if @ItemCategoryID = @ConsumableID -- ConsumableItems
begin
set @UnitMeasure = (select dbo.GetLookupDataDes(UnitMeasureID) from ConsumableItems where ConsumableNo = @ItemCode)
end
else
if @ItemCategoryID = @TestID -- Test
begin
set @UnitMeasure = (select dbo.GetLookupDataDes(UnitMeasureID) from LabTests where TestCode = @ItemCode)
end
else set @UnitMeasure = ''

return @UnitMeasure

end
go

-- print dbo.GetUnitMeasure('7T', 'HIVPCR2')
-- print dbo.GetUnitMeasure('7D', '4A')

--------Function GetUnitMeasureEXT-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetUnitMeasureEXT')
drop function GetUnitMeasureEXT
go

create function GetUnitMeasureEXT(@TestCode varchar(20), @SubTestCode varchar(20)) returns varchar(100)
with encryption as

begin

declare @UnitMeasure varchar(100)
	
set @UnitMeasure = (select dbo.GetLookupDataDes(UnitMeasureID) from LabTestsEXT 
		where TestCode = @TestCode and SubTestCode = @SubTestCode)	
set @UnitMeasure = isnull(@UnitMeasure, '')

return @UnitMeasure

end
go

-- print dbo.GetUnitMeasureEXT('T001', 'DBIL')
-- print dbo.GetUnitMeasureEXT('T001', 'GGT')


--------Function GetUnitMeasureID-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetUnitMeasureID')
drop function GetUnitMeasureID
go

create function GetUnitMeasureID(@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns varchar(10)
with encryption as

begin

declare @UnitMeasureID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @TestID varchar(10)

set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')

if @ItemCategoryID = @DrugID -- Drugs
begin
set @UnitMeasureID = (select UnitMeasureID from Drugs where DrugNo = @ItemCode)
end
else
if @ItemCategoryID = @ConsumableID -- ConsumableItems
begin
set @UnitMeasureID = (select UnitMeasureID from ConsumableItems where ConsumableNo = @ItemCode)
end
else
if @ItemCategoryID = @TestID -- Test
begin
set @UnitMeasureID = (select UnitMeasureID from LabTests where TestCode = @ItemCode)
end
else set @UnitMeasureID = ''

return @UnitMeasureID

end
go

-- print dbo.GetUnitMeasureID('7T', 'HIVPCR2')
-- print dbo.GetUnitMeasureID('7D', 'DRG0001')

--------Function GetLabTestsNormalRange-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetLabTestsNormalRange')
drop function GetLabTestsNormalRange
go

create function GetLabTestsNormalRange(@TestCode varchar(20)) returns varchar(800)
with encryption as

begin

declare @NormalRange varchar(800)
	
set @NormalRange = (select NormalRange from LabTests where TestCode = @TestCode)
set @NormalRange = isnull(@NormalRange, '')
	
return @NormalRange

end
go

-- print dbo.GetLabTestsNormalRange('T115')
-- print dbo.GetLabTestsNormalRange('T203')

----------Function  Get Test Requires Results Approval-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTestCodeRequiresResultsApproval')
drop function  GetTestCodeRequiresResultsApproval
go

create function GetTestCodeRequiresResultsApproval (@TestCode varchar(20)) returns bit
with encryption as

begin
declare @RequiresApproval bit
begin
if exists((select RequiresResultsApproval from LabTests where TestCode= @TestCode and RequiresResultsApproval =1)) begin set @RequiresApproval=1 end
else begin set @RequiresApproval=0 end
end
return @RequiresApproval 
 
end
go

---------- print dbo.GetTestCodeRequiresResultsApproval ('LAB117')
---------- print dbo.GetTestCodeRequiresResultsApproval ('LAB118')


--------Function GetLabTestsEXTNormalRange-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetLabTestsEXTNormalRange')
drop function GetLabTestsEXTNormalRange
go

create function GetLabTestsEXTNormalRange(@TestCode varchar(20), @SubTestCode varchar(20)) returns varchar(800)
with encryption as

begin

declare @NormalRange varchar(800)
	
set @NormalRange = (select NormalRange from LabTestsEXT where TestCode = @TestCode and SubTestCode = @SubTestCode)
set @NormalRange = isnull(@NormalRange, '')
	
return @NormalRange

end
go

-- print dbo.GetLabTestsEXTNormalRange('T118', 'PT')
-- print dbo.GetLabTestsEXTNormalRange('T118', 'INR')

--------Function GetItemLabTestTubeType-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetItemLabTestTubeType')
drop function GetItemLabTestTubeType
go

create function GetItemLabTestTubeType(@TestCode varchar(20)) returns varchar(100)
with encryption as

begin

declare @TubeType varchar(100)
	
set @TubeType = (select dbo.GetLookupDataName(TubeType)  from LabTests 
		where TestCode = @TestCode)	
set @TubeType = isnull(@TubeType, '')

return @TubeType

end
go

-- print dbo.GetItemLabTestTubeType('lab123')

----------Function IsCollectionSaved-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'IsCollectionSaved')
drop function      IsCollectionSaved
go

create function   IsCollectionSaved(@CollectionModesID varchar(10), @DocumentNo varchar(20)) returns bit
with encryption as

begin

declare @IsCollectionSaved bit 




begin
if exists(select RegisterNo from BankingRegisterDetails where CollectionModesID=@CollectionModesID and DocumentNo=@DocumentNo)
begin set @IsCollectionSaved=1 end
else begin set @IsCollectionSaved=0 end   
end

set @IsCollectionSaved= isnull(@IsCollectionSaved, 0)

return @IsCollectionSaved
	
end
go

----------Function  IsReturnableInventory-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'IsReturnableInventory')
drop function  IsReturnableInventory
go

create function  IsReturnableInventory(@VisitNo varchar(20), @VisitTypeID varchar(10),
@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns bit
with encryption as

begin

declare @ItemStatusID varchar(10)
declare @Drug varchar(10)
declare @Consumable varchar(10)
declare @IPDVisitTypeID varchar(10)
declare @Offered varchar(10)
declare @IsReturnable bit 

set @Drug = dbo.GetLookupDataID('ItemCategory', 'D')
set @Consumable =  dbo.GetLookupDataID('ItemCategory', 'C')
set @IPDVisitTypeID= dbo.GetLookupDataID('VisitType', 'IPD')

set @Offered = dbo.GetLookupDataID('ItemStatus', 'O')

if (not (@ItemCategoryID=@Drug or @ItemCategoryID=@Consumable)) begin set @IsReturnable=0 end

else
begin
if(@VisitTypeID=@IPDVisitTypeID) begin set @IsReturnable=1 end
  
else
begin 
set @ItemStatusID = (select ItemstatusID from Items where VisitNo= @VisitNo and ItemCategoryID = @ItemCategoryID
and ItemCode= @ItemCode)
set @ItemStatusID = isnull(@ItemStatusID, '')

if (@ItemStatusID=@Offered) begin set @IsReturnable=1 end
else begin set @IsReturnable=0   end
end

end

return @IsReturnable
end
go

----------------------------------------------------------------------------------------------------------

----------Function  Patient Visit no -----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetRefundVisitNo')
drop function  GetRefundVisitNo
go

create function  GetRefundVisitNo(@ReceiptNo varchar(20)) returns varchar(20)
with encryption as

begin

-----------------------------------------------------------------------------------------------
declare @CashVisitPayTypeID varchar(10)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)
declare @IPDRoundPayTypeID varchar(10)
declare @ExtraBillPayTypeID varchar(10)
declare @PayTypeID varchar(10)
declare @VisitNo varchar(20)
------------------------------------------------------------------------------------------------------------------
set @CashVisitPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')
set @IPDRoundPayTypeID = dbo.GetLookupDataID('PayType', 'IPR')
set @ExtraBillPayTypeID = dbo.GetLookupDataID('PayType', 'EXT')

set @PayTypeID =(select Top 1 PayTypeID from Payments where ReceiptNo =@ReceiptNo)


if 	@PayTypeID= @CashVisitPayTypeID set @VisitNo= (select top 1 VisitNo from PaymentDetails where ReceiptNo=@ReceiptNo)
else if @PayTypeID=@ExtraBillPayTypeID set @VisitNo= (select top 1 ExtraBillNo from PaymentExtraBillItems
where ReceiptNo=@ReceiptNo)

set @VisitNo= isnull(@VisitNo,'')
return @VisitNo
end
go
---------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetVisitBillModesID')
drop function  GetVisitBillModesID
go

create function  GetVisitBillModesID(@VisitNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @BillModesID varchar(20)
declare @VisitType varchar(10) 
declare @OPDVisitTypeID varchar(10)
declare @IPDVisitTypeID varchar(10)

set @OPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')

set @BillModesID = (select BillModesID from Visits where VisitNo= @VisitNo)

set @BillModesID= isnull(@BillModesID,'')
return @BillModesID
end
go
---------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------

----------Function GetItemStatusID-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetItemStatusID')
drop function GetItemStatusID
go

create function GetItemStatusID(@VisitNo varchar(20), @ItemCode varchar(20), @ID varchar(10)) returns varchar(100)
with encryption as

begin

declare @ItemStatusID varchar(100)
declare @ItemCategoryID varchar(10)

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', @ID)
set @ItemStatusID = (select ItemstatusID from Items where VisitNo= @VisitNo and ItemCode= @ItemCode and ItemCategoryID = @ItemCategoryID)
set @ItemStatusID = isnull(@ItemStatusID, '')

return @ItemStatusID

end
go

-- print dbo.GetItemStatusID('1010004007', 'T010', 'T')
-- select * from Items

--------Function Get Item Status-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetItemStatus')
drop function GetItemStatus
go

create function GetItemStatus(@VisitNo varchar(20), @ItemCode varchar(20), @ID varchar(10)) returns varchar(100)
with encryption as

begin

declare @ItemName varchar(100)
declare @ItemCategoryID varchar(10)

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', @ID)
set @ItemName = (select ItemstatusID from Items where VisitNo = @VisitNo and ItemCode= @ItemCode and ItemCategoryID = @ItemCategoryID)
set @ItemName = isnull(@ItemName, '')
set @ItemName = dbo.GetLookupDataDes(@ItemName)

return @ItemName

end
go

-- print dbo.GetItemStatus('000001BA21078001', 'AFETOP', 'T')
-- select * from Items

--------Function GetIsItemHidden-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIsItemHidden')
drop function GetIsItemHidden
go

create function GetIsItemHidden(@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns varchar(800)
with encryption as

begin

declare @Hidden bit

declare @DrugID varchar(10)
declare @ConsumableID varchar(10)

set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')

if @ItemCategoryID = @DrugID -- Drugs
begin
set @Hidden = (select Hidden from Drugs where DrugNo = @ItemCode)
end

else
if @ItemCategoryID = @ConsumableID -- ConsumableItems
begin
set @Hidden = (select Hidden from ConsumableItems where ConsumableNo = @ItemCode)
end

else

set @Hidden = isnull(@Hidden, 0)

return @Hidden

end
go

--------Function GetCountToOrderInventoryLocation----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCountToOrderInventoryLocation')
drop function GetCountToOrderInventoryLocation
go

create function GetCountToOrderInventoryLocation(@ItemCategoryID varchar(10), @LocationID varchar(10)) returns int
with encryption as

begin

declare @Hidden bit
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @Records int

-----------------------------------------------------------------------------------------------------------------------------
Set @Hidden = 0
set @Hidden = isnull(@Hidden, 0)
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
-----------------------------------------------------------------------------------------------------------------------------
	
if ((not (@LocationID is null)) and ((@ItemCategoryID = @DrugID)or(@ItemCategoryID = @ConsumableID)))
begin
set @Records = 	   (select Count(InventoryLocation.ItemCode) from InventoryLocation 
		inner join ItemLocationOrderLevels on ItemLocationOrderLevels.LocationID = InventoryLocation.LocationID
		and ItemLocationOrderLevels.ItemCategoryID = InventoryLocation.ItemCategoryID 
		and ItemLocationOrderLevels.ItemCode = InventoryLocation.ItemCode	
							
	    where InventoryLocation.ItemCategoryID = @ItemCategoryID 
	    and InventoryLocation.LocationID = @LocationID 
	    and ItemLocationOrderLevels.LocationID = @LocationID 
	    and UnitsAtHand <= ItemLocationOrderLevels.LocationOrderLevel)						
								
end
  
else if ( (@LocationID is null) and ((@ItemCategoryID = @DrugID)or(@ItemCategoryID = @ConsumableID)))
begin 
set @Records = (select Count(DrugNo) from Drugs where Hidden = @Hidden 
	and OrderLevel >= dbo.GetInventoryBalance(null, @ItemCategoryID , DrugNo))
end
else if ( (@LocationID is null) and not((@ItemCategoryID = @DrugID)or(@ItemCategoryID = @ConsumableID)))
begin
set @records = null
end
 
else if ( not(@LocationID is null) and not((@ItemCategoryID = @DrugID)or(@ItemCategoryID = @ConsumableID)))
begin
set @records = null
end
set @Records = isnull(@Records, 0)	

return @records	

end

go

----------------------------------------------------------------------------------------------------------------------------
--print dbo.GetCountToOrderInventoryLocation('7d','')
--print cast(dbo.GetCountToOrderInventoryLocation('7f',null) as varchar)
--print cast(dbo.GetCountToOrderInventoryLocation('7d',11717) as int)
----------------------------------------------------------------------------------------------------------------------------
--------Function GetItemLocationOrderLevel-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetItemLocationOrderLevel')
drop function GetItemLocationOrderLevel
go

create function GetItemLocationOrderLevel(@LocationID varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @LocationOrderLevel int
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)

-------------------------------------------------------------------------------------------------
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
-------------------------------------------------------------------------------------------------

set @LocationOrderLevel =(select LocationOrderLevel	from ItemLocationOrderLevels
where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	
if(@LocationOrderLevel is null)
begin

if(@ItemCategoryID = @DrugID)
begin set @LocationOrderLevel = (select OrderLevel from Drugs where DrugNo = @ItemCode)end
		
else if(@ItemCategoryID = @ConsumableID)
begin set @LocationOrderLevel = (select OrderLevel from ConsumableItems where ConsumableNo = @ItemCode)end
		
else set @LocationOrderLevel = 0
end
		
set @LocationOrderLevel = isnull(@LocationOrderLevel, 0)

return @LocationOrderLevel

end
go


----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetItemLocationOrderLevel('7d', '285') as varchar)
-- print cast(dbo.GetItemLocationOrderLevel('7d', '290') as varchar)
-- print cast(dbo.GetItemLocationOrderLevel('7c', 'C209') as varchar)
-- print cast(dbo.GetItemLocationOrderLevel('7c', 'c001') as varchar)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetItemLocationOrderLevel-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetItemLocationOrderLevel')
drop function GetItemLocationOrderLevel
go

create function GetItemLocationOrderLevel(@LocationID varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @LocationOrderLevel int
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)

-------------------------------------------------------------------------------------------------
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
-------------------------------------------------------------------------------------------------

set @LocationOrderLevel =(select LocationOrderLevel	from ItemLocationOrderLevels
where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
	
if(@LocationOrderLevel is null)
begin

if(@ItemCategoryID = @DrugID)
begin set @LocationOrderLevel = (select OrderLevel from Drugs where DrugNo = @ItemCode)end
		
else if(@ItemCategoryID = @ConsumableID)
begin set @LocationOrderLevel = (select OrderLevel from ConsumableItems where ConsumableNo = @ItemCode)end
		
else set @LocationOrderLevel = 0
end
		
set @LocationOrderLevel = isnull(@LocationOrderLevel, 0)

return @LocationOrderLevel

end
go


----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetItemLocationOrderLevel('7d', '285') as varchar)
-- print cast(dbo.GetItemLocationOrderLevel('7d', '290') as varchar)
-- print cast(dbo.GetItemLocationOrderLevel('7c', 'C209') as varchar)
-- print cast(dbo.GetItemLocationOrderLevel('7c', 'c001') as varchar)
----------------------------------------------------------------------------------------------------------------------------

--------Function Get Pay Status-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPayStatus')
drop function GetPayStatus
go

create function GetPayStatus(@VisitNo varchar(20), @ItemCode varchar(20), @ID varchar(10)) returns varchar(100)
with encryption as

begin

declare @ItemName varchar(100)
declare @ItemCategoryID varchar(10)

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', @ID)
set @ItemName = (select PayStatusID from Items where VisitNo= @VisitNo and ItemCode= @ItemCode and ItemCategoryID = @ItemCategoryID)
set @ItemName = isnull(@ItemName, '')
set @ItemName = dbo.GetLookupDataDes(@ItemName)

return @ItemName

end
go

-- print dbo.GetPayStatus('000001BA21078001', 'AFETOP', 'T')
-- select * from Items


--------Function GetVisitItemsCashPayStatusID-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetVisitItemsCashPayStatusID')
drop function GetVisitItemsCashPayStatusID
go

create function GetVisitItemsCashPayStatusID(@VisitNo varchar(20),@ItemCode varchar(20)) returns varchar(10)
with encryption as

begin

declare @ItemsCashPayStatusID varchar(10)
declare @PaidForStatusID varchar(10)
declare @ExtraChargeItemCategoryID varchar(10)

set @ExtraChargeItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'E')
set @PaidForStatusID =dbo.GetLookupDataID('PayStatus', 'PF')
set  @ItemCode = 'CPV'

set @ItemsCashPayStatusID =  (select CashPayStatusID from ItemsCASH
where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ExtraChargeItemCategoryID)
set @ItemsCashPayStatusID = isnull(@ItemsCashPayStatusID, @PaidForStatusID)

return @ItemsCashPayStatusID

end
go
----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetVisitItemsCashPayStatusID('P1900036580001','dee')


--------Function GetServicePayStatusID-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetServicePayStatusID')
drop function GetServicePayStatusID
go

create function GetServicePayStatusID(@VisitNo varchar(20), @ItemCode varchar(20)) returns varchar(100)
with encryption as

begin

declare @ItemName varchar(100)
declare @ItemCategoryID varchar(10)

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'S')
set @ItemName = (select PayStatusID from Items where VisitNo= @VisitNo and ItemCode= @ItemCode and ItemCategoryID = @ItemCategoryID)
set @ItemName = isnull(@ItemName, '')

return @ItemName

end
go

-- print dbo.GetServicePayStatusID('1300021001', '10C')
-- select * from Items

----------Function GetItemRecordDateTime-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetItemRecordDateTime')
drop function GetItemRecordDateTime
go

create function GetItemRecordDateTime(@VisitNo varchar(20), @ItemCode varchar(20), @ID varchar(10)) returns smalldatetime
with encryption as

begin

declare @RecordDateTime smalldatetime
declare @ItemCategoryID varchar(10)

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', @ID)
set @RecordDateTime = (select RecordDateTime from Items where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)

return @RecordDateTime

end
go

-- print dbo.GetItemRecordDateTime('1010004007', 'T010', 'T')
-- select * from Items

----------Function GetReceiptRecordDateTime-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetReceiptRecordDateTime')
drop function GetReceiptRecordDateTime
go

create function GetReceiptRecordDateTime(@ReceiptNo varchar(20)) returns smalldatetime
with encryption as

begin

declare @RecordDateTime smalldatetime

set @RecordDateTime = (select TOP 1 RecordDateTime from Payments where ReceiptNo = @ReceiptNo)

return @RecordDateTime

end
go

-- print dbo.GetReceiptRecordDateTime('R17000001')

----------------------------------------------------------------------------------------------------------------------
-------------- IPDItems ----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------

--------Function GetIPDItemStatusID-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDItemStatusID')
drop function GetIPDItemStatusID
go

create function GetIPDItemStatusID(@RoundNo varchar(20), @ItemCode varchar(20), @ID varchar(10)) returns varchar(100)
with encryption as

begin

declare @ItemStatusID varchar(100)
declare @ItemCategoryID varchar(10)

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', @ID)
set @ItemStatusID = (select ItemstatusID from IPDItems where RoundNo= @RoundNo and ItemCode= @ItemCode and ItemCategoryID = @ItemCategoryID)
set @ItemStatusID = isnull(@ItemStatusID, '')

return @ItemStatusID

end
go

-- print dbo.GetIPDItemStatusID('11047370101', 'T117', 'T')
-- select * from IPDItems

--------Function Get IPDItem Status-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDItemStatus')
drop function GetIPDItemStatus
go

create function GetIPDItemStatus(@RoundNo varchar(20), @ItemCode varchar(20), @ID varchar(10)) returns varchar(100)
with encryption as

begin

declare @ItemName varchar(100)
declare @ItemCategoryID varchar(10)

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', @ID)
set @ItemName = (select ItemstatusID from IPDItems where RoundNo= @RoundNo and ItemCode= @ItemCode and ItemCategoryID = @ItemCategoryID)
set @ItemName = isnull(@ItemName, '')
set @ItemName = dbo.GetLookupDataDes(@ItemName)

return @ItemName

end
go

-- print dbo.GetIPDItemStatus('11032750202', 'T010', 'T')
-- select * from IPDItems

--------Function GetIPDPayStatus-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDPayStatus')
drop function GetIPDPayStatus
go

create function GetIPDPayStatus(@RoundNo varchar(20), @ItemCode varchar(20), @ID varchar(10)) returns varchar(100)
with encryption as

begin

declare @ItemName varchar(100)
declare @ItemCategoryID varchar(10)

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', @ID)
set @ItemName = (select PayStatusID from IPDItems where RoundNo= @RoundNo and ItemCode= @ItemCode and ItemCategoryID = @ItemCategoryID)
set @ItemName = isnull(@ItemName, '')
set @ItemName = dbo.GetLookupDataDes(@ItemName)

return @ItemName

end
go

-- print dbo.GetIPDPayStatus('11032750202', 'T010', 'T')
-- select * from IPDItems

--------Function GetIPDServicePayStatusID-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDServicePayStatusID')
drop function GetIPDServicePayStatusID
go

create function GetIPDServicePayStatusID(@RoundNo varchar(20), @ItemCode varchar(20)) returns varchar(100)
with encryption as

begin

declare @ItemName varchar(100)
declare @ItemCategoryID varchar(10)

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'S')
set @ItemName = (select PayStatusID from IPDItems where RoundNo= @RoundNo and ItemCode= @ItemCode and ItemCategoryID = @ItemCategoryID)
set @ItemName = isnull(@ItemName, '')

return @ItemName

end
go

-- print dbo.GetIPDServicePayStatusID('11032750202', '10C')
-- select * from IPDItems

----------------------------------------------------------------------------------------------------------------------

--------Function Get Account Balance----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAccountBalance')
drop function GetAccountBalance
go

create function GetAccountBalance(@AccountBillModesID varchar(10), @AccountBillNo varchar(20)) returns money
with encryption as

begin

declare @Balance money

set @Balance = (select Balance from Accounts Where AccountID = (select Max(AccountID) from Accounts 
where AccountBillModesID = @AccountBillModesID and AccountBillNo = @AccountBillNo))

set @Balance = isnull(@Balance, 0.00)

return @Balance

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetAccountBalance('17A', 'SIL'))
----------------------------------------------------------------------------------------------------------------------------

--------Function GetCashAccountBalance----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCashAccountBalance')
drop function GetCashAccountBalance
go

create function GetCashAccountBalance(@PatientNo varchar(20)) returns money
with encryption as

begin

declare @CashBillModesID varchar(10)
declare @Balance money

set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')

set @Balance = (select Balance from Accounts Where AccountID = 
(select Max(AccountID) from Accounts 
where AccountBillModesID = @CashBillModesID and AccountBillNo = @PatientNo))

set @Balance = isnull(@Balance, 0.00)

return @Balance

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetCashAccountBalance('1115388'))
----------------------------------------------------------------------------------------------------------------------------

--------Function GetDebitCashAccountBalance----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDebitCashAccountBalance')
drop function GetDebitCashAccountBalance
go

create function GetDebitCashAccountBalance(@PatientNo varchar(20)) returns money
with encryption as

begin

declare @CashBillModesID varchar(10)
declare @Balance money
declare @DebitID varchar(10)

set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @DebitID = dbo.GetLookupDataID('AccountAction', 'DR')

set @Balance = (select Balance from Accounts Where AccountID = 
(select Max(AccountID) from Accounts 
where AccountBillModesID = @CashBillModesID and AccountBillNo = @PatientNo
and AccountActionID =@DebitID and Balance < 1))

set @Balance = isnull(@Balance, 0.00)

return @Balance

end

go

--------Function GetAccountAmount-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAccountAmount')
drop function GetAccountAmount
go

create function GetAccountAmount(@TranNo varchar(20)) returns money
with encryption as

begin

declare @AccountActionID varchar(10)
declare @CreditID varchar(10)
declare @DebitID varchar(10)
declare @Amount money

set @CreditID = dbo.GetLookupDataID('AccountAction', 'CR')
set @DebitID = dbo.GetLookupDataID('AccountAction', 'DR')

set @Amount = (select Amount from Accounts where TranNo = @TranNo)
set @AccountActionID = (select AccountActionID from Accounts where TranNo = @TranNo)

------------------------------------------------------------------------------------
if @AccountActionID = @CreditID	set @Amount =  @Amount
if @AccountActionID = @DebitID	set @Amount = - @Amount
------------------------------------------------------------------------------------

set @Amount = isnull(@Amount, 0.00)

return @Amount

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetAccountAmount('12000030'))
-- print dbo.FormatMoney(dbo.GetAccountAmount('12000051'))
----------------------------------------------------------------------------------------------------------------------------

--------Function GetAccountAmountTendered-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAccountAmountTendered')
drop function GetAccountAmountTendered
go

create function GetAccountAmountTendered(@TranNo varchar(20)) returns money
with encryption as

begin

declare @AccountActionID varchar(10)
declare @CreditID varchar(10)
declare @DebitID varchar(10)
declare @AmountTendered money

set @CreditID = dbo.GetLookupDataID('AccountAction', 'CR')
set @DebitID = dbo.GetLookupDataID('AccountAction', 'DR')

set @AmountTendered = (select AmountTendered from Accounts where TranNo = @TranNo)
set @AccountActionID = (select AccountActionID from Accounts where TranNo = @TranNo)

------------------------------------------------------------------------------------
if @AccountActionID = @CreditID	set @AmountTendered =  @AmountTendered
if @AccountActionID = @DebitID	set @AmountTendered = - @AmountTendered
------------------------------------------------------------------------------------

set @AmountTendered = isnull(@AmountTendered, 0.00)

return @AmountTendered

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetAccountAmountTendered('12000030'))
-- print dbo.FormatMoney(dbo.GetAccountAmountTendered('12000051'))
----------------------------------------------------------------------------------------------------------------------------

--------Function GetBillCustomFee ------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetBillCustomFee')
drop function GetBillCustomFee
go

create function GetBillCustomFee(@AccountNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns money
with encryption as

begin

declare @CustomFee money

declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)

set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')

if exists(select CustomFee from BillCustomFee where AccountNo = @AccountNo 
and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
begin
set @CustomFee = (select CustomFee from BillCustomFee where AccountNo = @AccountNo 
			and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)	
end
else
begin
if @ItemCategoryID = @ServiceID -- Services
begin
set @CustomFee = (select StandardFee from Services where ServiceCode = @ItemCode)
end

else
if @ItemCategoryID = @DrugID -- Drugs
begin
set @CustomFee = (select UnitPrice from Drugs where DrugNo = @ItemCode)
end

else
if @ItemCategoryID = @ConsumableID -- ConsumableItems
begin
set @CustomFee = (select UnitPrice from ConsumableItems where ConsumableNo = @ItemCode)
end

else
if @ItemCategoryID = @ProcedureID -- Procedures
begin
set @CustomFee = (select UnitPrice from Procedures where ProcedureCode = @ItemCode)
end

else
if @ItemCategoryID = @DentalID -- DentalServices
begin
set @CustomFee = (select UnitPrice from DentalServices where DentalCode = @ItemCode)
end

else
if @ItemCategoryID = @TheatreID -- TheatreServices
begin
set @CustomFee = (select UnitPrice from TheatreServices where TheatreCode = @ItemCode)
end

else
if @ItemCategoryID = @OpticalID -- OpticalServices
begin
set @CustomFee = (select UnitPrice from OpticalServices where OpticalCode = @ItemCode)
end

else
if @ItemCategoryID = @MaternityID -- MaternityServices
begin
set @CustomFee = (select UnitPrice from MaternityServices where MaternityCode = @ItemCode)
end

else
if @ItemCategoryID = @ICUID -- ICUServices
begin
set @CustomFee = (select UnitPrice from ICUServices where ICUCode = @ItemCode)
end

else
if @ItemCategoryID = @TestID -- Test
begin
set @CustomFee = (select TestFee from LabTests where TestCode = @ItemCode)
end
else


if @ItemCategoryID = @CardiologyID -- Cardiology
begin
set @CustomFee = (select UnitPrice from CardiologyExaminations where ExamCode = @ItemCode)
end
else


if @ItemCategoryID = @RadiologyID -- Radiology
begin
set @CustomFee = (select UnitPrice from RadiologyExaminations where ExamCode = @ItemCode)
end
else

if @ItemCategoryID = @PathologyID -- Pathology
begin
set @CustomFee = (select UnitPrice from PathologyExaminations where ExamCode = @ItemCode)
end
else
		
if @ItemCategoryID = @EyeID -- EyeServices
begin
set @CustomFee = (select UnitPrice from EyeServices where EyeCode = @ItemCode)
end

else
if @ItemCategoryID = @AdmissionID -- Admission
begin
set @CustomFee = (select UnitPrice from Beds where BedNo = @ItemCode)
end
		
else
if @ItemCategoryID = @ExtrasID -- Extras
begin
set @CustomFee = (select UnitPrice from ExtraChargeItems where ExtraItemCode = @ItemCode)
end
end

set @CustomFee = isnull(@CustomFee, 0.00)

return @CustomFee

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetBillCustomFee('CASH', 'M113', '7D'))
-- print dbo.FormatMoney(dbo.GetBillCustomFee('CASH', '2B', '7A'))
----------------------------------------------------------------------------------------------------------------------------

--------Function GetAccountName----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAccountName')
drop function GetAccountName
go

create function GetAccountName(@AccountBillModesID varchar(10), @AccountBillNo varchar(20)) returns varchar(100)
with encryption as

begin

declare @CashBillModesID varchar(10)
declare @AccBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)
declare @AccountName varchar(100)

------------------------------------------------------------------------------------------------------------------
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')

------------------------------------------------------------------------------------------------------------------
if (@AccountBillModesID = @CashBillModesID)
begin
set @AccountName = (select dbo.GetFullName(LastName, MiddleName, FirstName) from Patients
			where PatientNo = @AccountBillNo )
if (@AccountName is null)
begin
set @AccountName =(select SupplierName from Suppliers
			where SupplierNo = @AccountBillNo)
end
end
else if (@AccountBillModesID = @AccBillModesID)
begin set @AccountName = (select BillCustomerName from BillCustomers where AccountNo = @AccountBillNo) end

else if (@AccountBillModesID = @InsuranceBillModesID)
begin set @AccountName = (select InsuranceName from Insurances where InsuranceNo = @AccountBillNo) end


------------------------------------------------------------------------------------------------------------------

set @AccountName = isnull(@AccountName, '')

return @AccountName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetAccountName('17C', '1200089')
-- print dbo.GetAccountName('17A', 'CASH')
-- print dbo.GetAccountName('17I', 'SIL')

----------------------------------------------------------------------------------------------------------------------------

----------Function  GetAccountsRecordDateTime-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAccountsRecordDateTime')
	drop function  GetAccountsRecordDateTime
go

create function GetAccountsRecordDateTime (@TransNo varchar(20)) returns smallDateTime
with encryption as

begin
declare @ActualRecordDateTime smallDateTime

----------------------------------------------------------------------------------------------------------------
if exists(select TranNo from AccountsEXT where TranNo = @TransNo)

begin set @ActualRecordDateTime= (select RecordDateTime from Accounts
where Accounts.TranNo = (select ReferenceNo from AccountsEXT where TranNo = @TransNo))  end

else begin set @ActualRecordDateTime= (select RecordDateTime from Accounts where TranNo = @TransNo)  end
----------------------------------------------------------------------------------------------------------------

 return @ActualRecordDateTime

end


go
--- select * from AccountsEXT
----print dbo.GetAccountsRecordDateTime('18018063')
----print dbo.GetAccountsRecordDateTime('18018063')


------------------------------------------------ IsOPDReceiptNo ---------------------------------------------------------

if exists (select * from sysobjects where name = 'IsOPDReceiptNo')
drop function  IsOPDReceiptNo
go

create function IsOPDReceiptNo (@ReceiptNo varchar(20)) returns bit
with encryption as


begin
declare @IsOPD bit
declare @VisitTypeID varchar(10)
set @VisitTypeID = dbo.GetLookupDataID('VisitType','OPD')
begin
if exists((select TOP 1 (ReceiptNo) from Payments where ReceiptNo= @ReceiptNo and VisitTypeID =@VisitTypeID)) begin set @IsOPD=1 end
else begin set @IsOPD=0 end
end
return @IsOPD 
end
go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.IsOPDReceiptNo('x')
-- print dbo.IsOPDReceiptNo('1800000044')
-- print dbo.IsOPDReceiptNo('x')


--------Function GetBillCompanyNo------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetBillCompanyNo')
drop function GetBillCompanyNo
go

create function GetBillCompanyNo(@BillModesID varchar(10), @BillNo varchar(20)) returns varchar(60)
with encryption as

begin

declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

declare @BillName varchar(60)

----------------------------------------------------------------------------
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
----------------------------------------------------------------------------

begin

if (@BillModesID = @InsuranceBillModesID)
begin
set @BillName = (select SchemeMembers.CompanyNo from SchemeMembers	
			inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
			and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
			inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
			where MedicalCardNo = @BillNo)
end
else set @BillName = (select AccountNo from BillCustomers where AccountNo = @BillNo)
set @BillName = isnull(@BillName, '')
end

return @BillName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetBillCompanyNo('17C', 'CASH')
-- print dbo.GetBillCompanyNo('17A', 'STAFF')
-- print dbo.GetBillCompanyNo('17I', '123')
-- print dbo.GetBillCompanyNo('', null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetInvoiceName---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInvoiceName')
drop function GetInvoiceName
go

create function GetInvoiceName(@PayTypeID varchar(10), @PayNo varchar(20)) returns varchar(100)
with encryption as

begin

declare @CashVisitPayTypeID varchar(10)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)
declare @IPDRoundPayTypeID varchar(10)
declare @ExtraBillPayTypeID varchar(10)
declare @InvoiceName varchar(100)

------------------------------------------------------------------------------------------------------------------
set @CashVisitPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')
set @IPDRoundPayTypeID = dbo.GetLookupDataID('PayType', 'IPR')
set @ExtraBillPayTypeID = dbo.GetLookupDataID('PayType', 'EXT')

------------------------------------------------------------------------------------------------------------------
if (@PayTypeID = @CashVisitPayTypeID)
begin
set @InvoiceName = (select dbo.GetFullName(LastName, MiddleName, FirstName) from Visits
			inner join Patients on Visits.PatientNo = Patients.PatientNo where VisitNo = @PayNo)
end

else if (@PayTypeID = @AccountBillPayTypeID)
begin set @InvoiceName = (select BillCustomerName from BillCustomers where AccountNo = @PayNo) end

else if (@PayTypeID = @InsuranceBillPayTypeID)
begin set @InvoiceName = (select InsuranceName from Insurances where InsuranceNo = @PayNo) end
------------------------------------------------------------------------------------------------------------------

set @InvoiceName = isnull(@InvoiceName, '')

return @InvoiceName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInvoiceName('47CAS', '1106647030')
-- print dbo.GetInvoiceName('47ACC', 'CASH')
-- print dbo.GetInvoiceName('47ACC', '100041A')
-- print dbo.GetInvoiceName('47INS', 'CMC')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetPayeeName---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPayeeName')
drop function GetPayeeName
go

create function GetPayeeName(@PayTypeID varchar(10), @PayNo varchar(20)) returns varchar(100)
with encryption as

begin

declare @CashVisitPayTypeID varchar(10)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)
declare @IPDRoundPayTypeID varchar(10)
declare @ExtraBillPayTypeID varchar(10)
declare @PayeeName varchar(100)

------------------------------------------------------------------------------------------------------------------
set @CashVisitPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')
set @IPDRoundPayTypeID = dbo.GetLookupDataID('PayType', 'IPR')
set @ExtraBillPayTypeID = dbo.GetLookupDataID('PayType', 'EXT')

------------------------------------------------------------------------------------------------------------------
if (@PayTypeID = @CashVisitPayTypeID) or (@PayTypeID = @ExtraBillPayTypeID)
begin
set @PayeeName = (select dbo.GetFullName(LastName, MiddleName, FirstName) from Visits
			inner join Patients on Visits.PatientNo = Patients.PatientNo where VisitNo = @PayNo)
end

else if (@PayTypeID = @AccountBillPayTypeID)
begin set @PayeeName = (select BillCustomerName from BillCustomers where AccountNo = @PayNo) end

else if (@PayTypeID = @InsuranceBillPayTypeID)
begin set @PayeeName = (select InsuranceName from Insurances where InsuranceNo = @PayNo) end
------------------------------------------------------------------------------------------------------------------

set @PayeeName = isnull(@PayeeName, '')

return @PayeeName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetPayeeName('47CAS', '1106647030')
-- print dbo.GetPayeeName('47ACC', 'CASH')
-- print dbo.GetPayeeName('47ACC', '100041A')
-- print dbo.GetPayeeName('47INS', 'CMC')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetPayeeNo-------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPayeeNo')
drop function GetPayeeNo
go

create function GetPayeeNo(@PayTypeID varchar(10), @PayNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @CashVisitPayTypeID varchar(10)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)
declare @IPDRoundPayTypeID varchar(10)
declare @ExtraBillPayTypeID varchar(10)
declare @PayeeNo varchar(20)

------------------------------------------------------------------------------------------------------------------
set @CashVisitPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')
set @IPDRoundPayTypeID = dbo.GetLookupDataID('PayType', 'IPR')
set @ExtraBillPayTypeID = dbo.GetLookupDataID('PayType', 'EXT')

------------------------------------------------------------------------------------------------------------------
if (@PayTypeID = @CashVisitPayTypeID) or (@PayTypeID = @ExtraBillPayTypeID)
begin
set @PayeeNo = (select Visits.PatientNo from Visits 
		inner join Patients on Visits.PatientNo = Patients.PatientNo where VisitNo = @PayNo)
end

else if (@PayTypeID = @AccountBillPayTypeID)
begin set @PayeeNo = @PayNo end

else if (@PayTypeID = @InsuranceBillPayTypeID)
begin set @PayeeNo = @PayNo end
------------------------------------------------------------------------------------------------------------------

set @PayeeNo = isnull(@PayeeNo, '')

return @PayeeNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetPayeeNo('47CAS', '1106647030')
-- print dbo.GetPayeeNo('47ACC', 'CASH')
-- print dbo.GetPayeeNo('47ACC', '100041A')
-- print dbo.GetPayeeNo('47INS', 'CMC')
----------------------------------------------------------------------------------------------------------------------------

--------Function Get OutstandingBalance-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetOutstandingBalance')
drop function GetOutstandingBalance
go

create function GetOutstandingBalance(@PatientNo varchar(20)) returns money
with encryption as

begin

declare @NotPaidPayStatus  varchar(10)
declare @DoneItemStatusID varchar(10)
declare @OfferedItemStatusID varchar(10)
declare @TotalAmount money
declare @CashAmount money
declare @OutstandingBalance money

set @NotPaidPayStatus = dbo.GetLookupDataID('PayStatus', 'NP')
set @DoneItemStatusID = dbo.GetLookupDataID('ItemStatus', 'D')
set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')

-----------------------------------------------------------------------------------------------------------
set @TotalAmount = (select sum(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount 
from Items inner join Visits  on Items.VisitNo = Visits.VisitNo
where PatientNo = @PatientNo and PayStatusID = @NotPaidPayStatus
and (ItemStatusID = @DoneItemStatusID or ItemStatusID = @OfferedItemStatusID))

set @TotalAmount = isnull(@TotalAmount, 0.00)
-----------------------------------------------------------------------------------------------------------

set @CashAmount = (select sum(CashAmount) as Amount from Items
	inner join ItemsCASH on ItemsCASH.VisitNo = Items.VisitNo 
	and ItemsCASH.ItemCode = Items.ItemCode and ItemsCASH.ItemCategoryID = Items.ItemCategoryID
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	where PatientNo = @PatientNo and CashPayStatusID = @NotPaidPayStatus
	and (ItemStatusID = @DoneItemStatusID or ItemStatusID = @OfferedItemStatusID))

set @CashAmount = isnull(@CashAmount, 0.00)
-----------------------------------------------------------------------------------------------------------

set @OutstandingBalance = @TotalAmount + @CashAmount

return @OutstandingBalance

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetOutstandingBalance('08/02'))
-- print dbo.FormatMoney(dbo.GetOutstandingBalance('1012350'))
-- print dbo.FormatMoney(dbo.GetOutstandingBalance('1215770'))
----------------------------------------------------------------------------------------------------------------------------

--------Function GetActualIssuedAmount--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetActualIssuedAmount')
drop function GetActualIssuedAmount
go

create function GetActualIssuedAmount(@LocationID varchar(10), @DrugNo varchar(20), 
						@StartDate smalldatetime, @EndDate as smalldatetime) returns money
with encryption as

begin

declare @DrugItemCategoryID varchar(10)
declare @OfferedItemStatusID varchar(10)
declare @OPDAmount money
declare @IPDAmount money
declare @TotalAmount money

set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')

--------------------------------------------------------------------------------------------------------
if (@LocationID is null or @LocationID = '') 
begin
set @OPDAmount = (select sum(Quantity * UnitPrice) as Amount from Items
		left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
		and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
		where Items.ItemCategoryID =  @DrugItemCategoryID and Items.ItemCode = @DrugNo
		and ItemStatusID = @OfferedItemStatusID and dbo.GetShortDate(IssueDateTime) between @StartDate and @EndDate)
end
else
begin
set @OPDAmount = (select sum(Quantity * UnitPrice) as Amount from Items
	left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
	and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
	where ItemsEXT.LocationID = @LocationID and Items.ItemCategoryID =  @DrugItemCategoryID and Items.ItemCode = @DrugNo
	and ItemStatusID = @OfferedItemStatusID and dbo.GetShortDate(IssueDateTime) between @StartDate and @EndDate)
end
		
set @OPDAmount = isnull(@OPDAmount, 0.00)

--------------------------------------------------------------------------------------------------------	
if (@LocationID is null or @LocationID = '') 
begin
set @IPDAmount = (select sum(Quantity * UnitPrice) as Amount from IPDItems
		left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
		and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
		where IPDItems.ItemCategoryID =  @DrugItemCategoryID and IPDItems.ItemCode = @DrugNo
		and ItemStatusID = @OfferedItemStatusID and dbo.GetShortDate(IssueDateTime) between @StartDate and @EndDate)
end
else
begin
set @IPDAmount = (select sum(Quantity * UnitPrice) as Amount from IPDItems
		left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
		and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
		where IPDItemsEXT.LocationID = @LocationID and IPDItems.ItemCategoryID =  @DrugItemCategoryID and IPDItems.ItemCode = @DrugNo
		and ItemStatusID = @OfferedItemStatusID and dbo.GetShortDate(IssueDateTime) between @StartDate and @EndDate)
end

set @IPDAmount = isnull(@IPDAmount, 0.00)
--------------------------------------------------------------------------------------------------------

set @TotalAmount = @OPDAmount + @IPDAmount
return @TotalAmount

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetActualIssuedAmount('11702', 'D001', '1 Oct 2012', '20 Oct 2012')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetPaidIssuedAmount----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPaidIssuedAmount')
drop function GetPaidIssuedAmount
go

create function GetPaidIssuedAmount(@LocationID varchar(10), @DrugNo varchar(20), 
					@StartDate smalldatetime, @EndDate as smalldatetime) returns money
with encryption as

begin

declare @DrugItemCategoryID varchar(10)
declare @OfferedItemStatusID varchar(10)
declare @PaidForPayStatus  varchar(10)
declare @OPDAmount money
declare @IPDAmount money
declare @TotalAmount money

set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @OfferedItemStatusID = dbo.GetLookupDataID('ItemStatus', 'O')
set @PaidForPayStatus = dbo.GetLookupDataID('PayStatus', 'PF')

---------------------------------------------------------------------------------------------------------------------
if (@LocationID is null or @LocationID = '') 
begin
set @OPDAmount = (select sum((PaymentDetails.Quantity * PaymentDetails.UnitPrice) - Discount) as Amount 
		from Items left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
		and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID 
		inner join PaymentDetails on PaymentDetails.VisitNo = Items.VisitNo
		and PaymentDetails.ItemCode = Items.ItemCode and PaymentDetails.ItemCategoryID = Items.ItemCategoryID
		where PaymentDetails.ItemCategoryID = @DrugItemCategoryID and PaymentDetails.ItemCode = @DrugNo 
		and PayStatusID = @PaidForPayStatus	and ItemStatusID = @OfferedItemStatusID 
		and dbo.GetShortDate(IssueDateTime) between @StartDate and @EndDate)
end
else
begin
set @OPDAmount = (select sum((PaymentDetails.Quantity * PaymentDetails.UnitPrice) - Discount) as Amount 
		from Items left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
		and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID 
		inner join PaymentDetails on PaymentDetails.VisitNo = Items.VisitNo
		and PaymentDetails.ItemCode = Items.ItemCode and PaymentDetails.ItemCategoryID = Items.ItemCategoryID
		where ItemsEXT.LocationID = @LocationID and PaymentDetails.ItemCategoryID = @DrugItemCategoryID 
		and PaymentDetails.ItemCode = @DrugNo and PayStatusID = @PaidForPayStatus	and ItemStatusID = @OfferedItemStatusID 
		and dbo.GetShortDate(IssueDateTime) between @StartDate and @EndDate)
end
	
set @OPDAmount = isnull(@OPDAmount, 0.00)

---------------------------------------------------------------------------------------------------------------------	
if (@LocationID is null or @LocationID = '') 
begin
set @IPDAmount = (select sum(Quantity * UnitPrice) as Amount from IPDItems
		left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
		and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
		where IPDItems.ItemCategoryID =  @DrugItemCategoryID and IPDItems.ItemCode = @DrugNo and PayStatusID = @PaidForPayStatus
		and ItemStatusID = @OfferedItemStatusID and dbo.GetShortDate(IssueDateTime) between @StartDate and @EndDate)
end
else
begin
set @IPDAmount = (select sum(Quantity * UnitPrice) as Amount from IPDItems
	left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
	and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
	where IPDItemsEXT.LocationID = @LocationID and IPDItems.ItemCategoryID =  @DrugItemCategoryID 
	and IPDItems.ItemCode = @DrugNo and PayStatusID = @PaidForPayStatus
	and ItemStatusID = @OfferedItemStatusID and dbo.GetShortDate(IssueDateTime) between @StartDate and @EndDate)
end
		
set @IPDAmount = isnull(@IPDAmount, 0.00)
---------------------------------------------------------------------------------------------------------------------

set @TotalAmount = @OPDAmount + @IPDAmount
return @TotalAmount

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetPaidIssuedAmount('D001', '1 Oct 2012', '20 Oct 2012')
----------------------------------------------------------------------------------------------------------------------------

--------Function IsInventoryOrderAcknowledged----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'IsInventoryOrderAcknowledged')
drop function IsInventoryOrderAcknowledged
go

create function IsInventoryOrderAcknowledged(@OrderNo varchar(20)) returns integer
with encryption as

begin

declare @Result integer
	
if  exists(select * from inventoryOrders where OrderNo = @OrderNo)
begin
if exists(select * from InventoryTransfers where OrderNo = @OrderNo)
begin	
if exists(select * from dbo.inventoryAcknowledges where transferNo = @OrderNo)
	begin	
		set @Result = 2
	end
if not exists(select * from dbo.inventoryAcknowledges where transferNo = @OrderNo)
	begin
		set @Result = 3
	end
end
else if not exists(select * from InventoryTransfers where OrderNo = @OrderNo)
begin
set @Result = 1
end
end
	
else if not exists(select * from inventoryOrders where OrderNo = @OrderNo)
begin
set @Result = 0
end  	

return @Result

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.IsInventoryOrderAcknowledged('1610021')1610061
-- print dbo.IsInventoryOrderAcknowledged('1610061')1610021 
-- print dbo.IsInventoryOrderAcknowledged('1610081')

----------------------------------------------------------------------------------------------------------------------------


--------Function GetInventoryLocationUnits----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInventoryLocationUnits')
drop function GetInventoryLocationUnits
go

create function GetInventoryLocationUnits(@LocationID varchar(10), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @Balance int

set @Balance = (select UnitsAtHand from InventoryLocation where LocationID = @LocationID 
and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)

set @Balance = isnull(@Balance, 0)

return @Balance

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInventoryLocationUnits('11702', '7D', 'M012')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetInventoryLocationDetails------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInventoryLocationDetails')
drop function GetInventoryLocationDetails
go

create function GetInventoryLocationDetails(@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns varchar(2000)
with encryption as
begin

declare @Location varchar(100)
declare @UnitsAtHand int
declare @LocationDetails varchar(2000)

set @LocationDetails = ''

begin
	
DECLARE LocationDetails_Cursor CURSOR FOR

select dbo.GetLookupDataDes(LocationID), UnitsAtHand from InventoryLocation 
where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode

OPEN LocationDetails_Cursor
FETCH NEXT FROM LocationDetails_Cursor INTO @Location, @UnitsAtHand
WHILE (@@FETCH_STATUS <> -1)
BEGIN
SET @LocationDetails = @LocationDetails + @Location + ': ' + cast(@UnitsAtHand as varchar(12)) + ', '
FETCH NEXT FROM LocationDetails_Cursor INTO @Location, @UnitsAtHand
END

CLOSE LocationDetails_Cursor
DEALLOCATE LocationDetails_Cursor

if len(@LocationDetails) > 0 set @LocationDetails = left(@LocationDetails, len(@LocationDetails)-1)
end

return @LocationDetails

end

go

----------------------------------------------------------------------------------------------------------------
-- print dbo.GetInventoryLocationDetails('7D', 'M012')
----------------------------------------------------------------------------------------------------------------

--------Function GetInventoryBalance----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInventoryBalance')
drop function GetInventoryBalance
go

create function GetInventoryBalance(@LocationID varchar(10), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @OtherItemsID varchar(10)
declare @Balance int

set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @OtherItemsID = dbo.GetLookupDataID('ItemCategory', 'NM')

if (@ItemCategoryID = @DrugID)-- Drugs
begin 	
if (@LocationID is null or @LocationID = '') 
begin set @Balance = (select UnitsInStock from Drugs where DrugNo = @ItemCode) end
else begin set @Balance = dbo.GetInventoryLocationUnits(@LocationID, @ItemCategoryID, @ItemCode) end
end
	
else if (@ItemCategoryID = @ConsumableID)-- ConsumableItems
begin  	
if (@LocationID is null or @LocationID = '') 
begin set @Balance = (select UnitsInStock from ConsumableItems where ConsumableNo = @ItemCode) end
else begin set @Balance = dbo.GetInventoryLocationUnits(@LocationID, @ItemCategoryID, @ItemCode) end
end


else if (@ItemCategoryID = @OtherItemsID)-- Other Items
begin  	
if (@LocationID is null or @LocationID = '') 
begin set @Balance = (select Quantity from OtherItems where ItemCode = @ItemCode) end
else begin set @Balance = dbo.GetInventoryLocationUnits(@LocationID, @ItemCategoryID, @ItemCode) end
end

set @Balance = isnull(@Balance, 0)

return @Balance

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInventoryBalance('', '7D', 'M012')
-- print dbo.GetInventoryBalance('11702', '7D', 'M012')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetAverageItemConsumption------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAverageItemConsumption')
drop function GetAverageItemConsumption
go

create function GetAverageItemConsumption(@ItemCode varchar(20),@ItemCategoryID varchar(10)) returns decimal(5,2)
with encryption as

begin

declare @OPDAvg Decimal
declare @IPDAvg Decimal
declare @FinalAvg Decimal

----------------------------------------------------------------------------------------------------------------------------
set @OPDAvg =isnull((SELECT SUM(Quantity) as Quantity
FROM (SELECT TOP(100) ItemCode,Quantity FROM Items where ItemCode =@ItemCode and ItemCategoryID = @ItemCategoryID) AS OPD),0)

set @IPDAvg =isnull((SELECT SUM(Quantity) as Quantity
FROM (SELECT TOP(100) ItemCode,Quantity FROM ExtraBillItems where ItemCode = @ItemCode and ItemCategoryID =@ItemCategoryID) AS IPD),0)
----------------------------------------------------------------------------------------------------------------------------


set @FinalAvg =NULLIF((@OPDAvg + @IPDAvg),0)/200



return @FinalAvg

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetAverageItemConsumption('DRG0172', '7d')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetLocationUnits---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetLocationUnits')
drop function GetLocationUnits
go

create function GetLocationUnits(@LocationID varchar(10), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @Balance int

if (@LocationID is null or @LocationID = '') begin return null end
else
begin
set @Balance = (select UnitsAtHand from InventoryLocation  
		where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
					
set @Balance = isnull(@Balance, 0)	
end

return @Balance

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetLocationUnits('11701', '7D', 'M423')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetInventoryStartBalance-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInventoryStartBalance')
drop function GetInventoryStartBalance
go

create function GetInventoryStartBalance(@LocationID varchar(10), @ItemCategoryID varchar(10), 
						@ItemCode varchar(20), @StartDateTime smalldatetime) returns int
with encryption as

begin

declare @Balance int

if (@LocationID is null or @LocationID = '') 
begin
set @Balance = (select Balance from Inventory Where TranID = (select max(TranID)
		from Inventory where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
		and RecordDateTime < @StartDateTime))
end
else
begin
set @Balance = (select LocationUnits from Inventory Where TranID = (select max(TranID)
		from Inventory where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
		and RecordDateTime < @StartDateTime))
end

set @Balance = isnull(@Balance, 0)

return @Balance

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInventoryStartBalance('11702', '7D', 'M506', '1 Sep 2012')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetInventoryEndBalance-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInventoryEndBalance')
drop function GetInventoryEndBalance
go

create function GetInventoryEndBalance(@LocationID varchar(10), @ItemCategoryID varchar(10), 
						@ItemCode varchar(20), @EndDateTime as smalldatetime) returns int
with encryption as

begin

declare @Balance int

if (@LocationID is null or @LocationID = '') 
begin
set @Balance = (select Balance from Inventory Where TranID =(select max(TranID) 
		from Inventory where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
		and RecordDateTime <= @EndDateTime))
end
else
begin
set @Balance = (select LocationUnits from Inventory Where TranID =(select max(TranID) 
		from Inventory where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
		and RecordDateTime <= @EndDateTime))
end

set @Balance = isnull(@Balance, 0)

return @Balance

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInventoryEndBalance('11702', '7D', 'M506', '16 Sep 2013')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetInventoryTotalReceived----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInventoryTotalReceived')
drop function GetInventoryTotalReceived
go

create function GetInventoryTotalReceived(@LocationID varchar(10), @ItemCategoryID varchar(10), @ItemCode varchar(20), 
							@StartDateTime smalldatetime, @EndDateTime as smalldatetime) returns int
with encryption as

begin

declare @ReceivedStockTypeID varchar(10)
declare @Total int

set @ReceivedStockTypeID = dbo.GetLookupDataID('StockType', 'R')

if (@LocationID is null or @LocationID = '') 
begin
set @Total = (select sum(Quantity) from Inventory where StockTypeID = @ReceivedStockTypeID 
		and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
		and RecordDateTime between @StartDateTime and @EndDateTime)
end
else
begin
set @Total = (select sum(Quantity) from Inventory where StockTypeID = @ReceivedStockTypeID 
		and LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
		and RecordDateTime between @StartDateTime and @EndDateTime)
end
				
set @Total = isnull(@Total, 0)

return @Total

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInventoryTotalReceived('11702', '7D', 'M506', '1 Oct 2012', '19 Oct 2013')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetInventoryTotalIssued------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInventoryTotalIssued')
drop function GetInventoryTotalIssued
go

create function GetInventoryTotalIssued(@LocationID varchar(10), @ItemCategoryID varchar(10), @ItemCode varchar(20), 
						@StartDateTime smalldatetime, @EndDateTime as smalldatetime) returns int
with encryption as

begin

declare @IssuedStockTypeID varchar(10)
declare @Total int

set @IssuedStockTypeID = dbo.GetLookupDataID('StockType', 'I')

if (@LocationID is null or @LocationID = '') 
begin
set @Total = (select sum(Quantity) from Inventory where StockTypeID = @IssuedStockTypeID 
		and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
		and RecordDateTime between @StartDateTime and @EndDateTime)
end
else
begin
set @Total = (select sum(Quantity) from Inventory where StockTypeID = @IssuedStockTypeID 
		and LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
		and RecordDateTime between @StartDateTime and @EndDateTime)
end
				
set @Total = isnull(@Total, 0)

return @Total

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInventoryTotalIssued('11702', '7D', 'M506', '1 Oct 2012', '19 Oct 2013') 

----------------------------------------------------------------------------------------------------------------------------

--------Function GetInventoryTotalManualIssued------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInventoryTotalManualIssued')
drop function GetInventoryTotalManualIssued
go

create function GetInventoryTotalManualIssued(@LocationID varchar(10), @ItemCategoryID varchar(10), @ItemCode varchar(20), 
							@StartDateTime smalldatetime, @EndDateTime as smalldatetime) returns int
with encryption as

begin

declare @IssuedStockTypeID varchar(10)
declare @ManualEntryModeID varchar(10)

declare @Total int

set @IssuedStockTypeID = dbo.GetLookupDataID('StockType', 'I')
set @ManualEntryModeID = dbo.GetLookupDataID('EntryMode', 'MAN')

if (@LocationID is null or @LocationID = '') 
begin
set @Total = (select sum(Quantity) from Inventory 
	where StockTypeID = @IssuedStockTypeID and EntryModeID = @ManualEntryModeID
	and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
	and RecordDateTime between @StartDateTime and @EndDateTime)
end
else
begin
set @Total = (select sum(Quantity) from Inventory 
	where StockTypeID = @IssuedStockTypeID and EntryModeID = @ManualEntryModeID
	and LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
	and RecordDateTime between @StartDateTime and @EndDateTime)
end
			
set @Total = isnull(@Total, 0)

return @Total

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInventoryTotalManualIssued('11702', '7D', 'M1379', '1 Oct 2012', '24 Oct 2014')

----------------------------------------------------------------------------------------------------------------------------



if exists (select * from sysobjects where name = 'GetInventoryTotalSystemIssued')
drop function GetInventoryTotalSystemIssued
go

create function GetInventoryTotalSystemIssued(@LocationID varchar(10), @ItemCategoryID varchar(10), @ItemCode varchar(20), 
						@StartDateTime smalldatetime, @EndDateTime as smalldatetime) returns int
with encryption as

begin

declare @IssuedStockTypeID varchar(10)
declare @SystemEntryModesID varchar(10)
declare @Total int

set @IssuedStockTypeID = dbo.GetLookupDataID('StockType', 'I')
set @SystemEntryModesID = dbo.GetLookupDataID('EntryMode', 'SYS')


if (@LocationID is null or @LocationID = '') 
begin
set @Total = (select sum(Quantity) from Inventory where StockTypeID = @IssuedStockTypeID  and EntryModeID = @SystemEntryModesID
		and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
		and RecordDateTime between @StartDateTime and @EndDateTime)
end
else
begin
set @Total = (select sum(Quantity) from Inventory where StockTypeID = @IssuedStockTypeID  and EntryModeID = @SystemEntryModesID
		and LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode 
		and RecordDateTime between @StartDateTime and @EndDateTime)
end
				
set @Total = isnull(@Total, 0)

return @Total

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInventoryTotalSystemIssued('11702', '7D', 'M506', '1 Oct 2012', '19 Oct 2013') 

----------------------------------------------------------------------------------------------------------------------------



--------Function GetAvailableStock------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAvailableStock')
drop function GetAvailableStock
go

create function GetAvailableStock(@DrugNo varchar(20), @Today smalldatetime) returns int
with encryption as

begin

declare @Balance int

declare @DrugItemCategoryID varchar(10)
declare @PendingItemStatusID varchar(10)
declare @StartDate smalldatetime
declare @EndDate smalldatetime

----------------------------------------------------------------------------------------------------------------------------
set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @PendingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @StartDate = dateadd(hour, -12, @Today)
set @EndDate = dbo.GetShortDate(dateadd(day, 1, @Today))

----------------------------------------------------------------------------------------------------------------------------
set @Balance = (select sum(PendingQuantity) from (
select  isnull(UnitsInStock, 0) as PendingQuantity from Drugs where DrugNo = @DrugNo
union
select sum(isnull(-Quantity, 0)) as PendingQuantity from Items 
where ItemCategoryID = @DrugItemCategoryID and ItemStatusID = @PendingItemStatusID
and ItemCode = @DrugNo and RecordDateTime >= @StartDate and RecordDateTime < @EndDate					
union		
select sum(isnull(-Quantity, 0))as PendingQuantity from IPDItems 
		where ItemCategoryID = @DrugItemCategoryID and ItemStatusID = @PendingItemStatusID
		and ItemCode = @DrugNo and RecordDateTime >= @StartDate and RecordDateTime < @EndDate
) as AvailableStock)

----------------------------------------------------------------------------------------------------------------------------

return @Balance

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetAvailableStock('M112', getdate())
-- print dbo.GetAvailableStock('M516', getdate())
-- print dbo.GetAvailableStock('D001', getdate())
----------------------------------------------------------------------------------------------------------------------------

--------Function GetAvailableStock------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAvailableToPayForDrugs')
drop function GetAvailableToPayForDrugs
go

create function GetAvailableToPayForDrugs(@DrugNo varchar(20), @Today smalldatetime) returns int
with encryption as

begin

declare @Balance int

declare @DrugItemCategoryID varchar(10)
declare @PendingItemStatusID varchar(10)
declare @PaidStatusID varchar(10)
declare @StartDate smalldatetime
declare @EndDate smalldatetime

----------------------------------------------------------------------------------------------------------------------------
set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
set @PendingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'P')
set @PaidStatusID = dbo.GetLookupDataID('PayStatus', 'PF')

set @StartDate = dateadd(hour, -12, @Today)
set @EndDate = dbo.GetShortDate(dateadd(day, 1, @Today))

----------------------------------------------------------------------------------------------------------------------------
set @Balance = (select sum(PendingQuantity) from (
select  isnull(UnitsInStock, 0) as PendingQuantity from Drugs where DrugNo = @DrugNo
union

select sum(isnull(-Quantity, 0)) as PendingQuantity from Items 
where ItemCategoryID = @DrugItemCategoryID and ItemStatusID = @PendingItemStatusID and PayStatusID = @PaidStatusID
and ItemCode = @DrugNo and RecordDateTime >= @StartDate and RecordDateTime < @EndDate
				
union		
select sum(isnull(-Quantity, 0))as PendingQuantity from IPDItems 
		where ItemCategoryID = @DrugItemCategoryID and ItemStatusID = @PendingItemStatusID and PayStatusID =@PaidStatusID
		and ItemCode = @DrugNo and RecordDateTime >= @StartDate and RecordDateTime < @EndDate
) as AvailableStock)

----------------------------------------------------------------------------------------------------------------------------
set @Balance = isnull(@Balance,0)
return @Balance
end
go

/* ----------------------------------------------------------------------------------------------------------------------------
select top 2 * from Inventory 
print dbo.GetAvailableStock('DRG0014', getdate())
print dbo.GetAvailableToPayForDrugs('DRG0014', getdate())
print dbo.GetAvailableToPayForDrugs('DRG0045', getdate())
print dbo.GetAvailableToPayForDrugs('DRG0014', getdate())
----------------------------------------------------------------------------------------------------------------------------*/

--------Function GetInventoryExpiryDate-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInventoryExpiryDate')
drop function GetInventoryExpiryDate
go

create function GetInventoryExpiryDate(@LocationID varchar(10), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns smalldatetime
with encryption as

begin

declare @Balance int 
declare @ExpiryDate smalldatetime

set @Balance = dbo.GetInventoryBalance(@LocationID, @ItemCategoryID, @ItemCode)

if (@LocationID is null or @LocationID = '') 
begin
set @ExpiryDate = (select ExpiryDate from InventoryReceiving 
			where TranID = (select max(InventoryReceiving.TranID) from InventoryReceiving 
			inner join Inventory on Inventory.TranID = InventoryReceiving.TranID 
			where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode))
end
else
begin
set @ExpiryDate = (select ExpiryDate from InventoryReceiving 
			where TranID = (select max(InventoryReceiving.TranID) from InventoryReceiving 
			inner join Inventory on Inventory.TranID = InventoryReceiving.TranID 
			where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode))
end
								
if (@Balance > 0) begin set @ExpiryDate = isnull(@ExpiryDate, dbo.GetOptionValue('NullDateValue')) end
else begin set @ExpiryDate = dbo.GetOptionValue('NullDateValue') end

return @ExpiryDate

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInventoryExpiryDate('7D', 'M516')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetInventoryBatchNo----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInventoryBatchNo')
drop function GetInventoryBatchNo
go

create function GetInventoryBatchNo(@LocationID varchar(10), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns varchar(20)
with encryption as

begin

declare @Balance int 
declare @BatchNo varchar(20)

set @Balance = dbo.GetInventoryBalance(@LocationID, @ItemCategoryID, @ItemCode)	

if (@LocationID is null or @LocationID = '') 
begin
set @BatchNo = (select BatchNo from InventoryReceiving 
			where TranID = (select max(InventoryReceiving.TranID) from InventoryReceiving 
			inner join Inventory on Inventory.TranID = InventoryReceiving.TranID 
			where ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode))
end
else
begin				
set @BatchNo = (select BatchNo from InventoryReceiving 
			where TranID = (select max(InventoryReceiving.TranID) from InventoryReceiving 
			inner join Inventory on Inventory.TranID = InventoryReceiving.TranID 
			where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode))
end			
				
if (@Balance > 0) begin set @BatchNo = isnull(@BatchNo, '') end
else begin set @BatchNo = '' end

return @BatchNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInventoryBatchNo('M516')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetExpiryRemainingDays-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetExpiryRemainingDays')
drop function GetExpiryRemainingDays
go

create function GetExpiryRemainingDays(@Today as smalldatetime, @ExpiryDate as smalldatetime) returns int
with encryption as

begin

declare @RemainingDays int

if (@ExpiryDate = dbo.GetOptionValue('NullDateValue')) begin set @RemainingDays = 0 end
else begin set @RemainingDays = (datediff(day, @Today, @ExpiryDate)) end

set @RemainingDays = isnull(@RemainingDays, 0)

return @RemainingDays

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetExpiryRemainingDays(getdate(), '23 Jan 2013')
-- print dbo.GetExpiryRemainingDays(getdate(), '1 Jan 1900')

--------Function GetChartCategoryLookupName------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetChartCategoryLookupName')
drop function GetChartCategoryLookupName
go

create function GetChartCategoryLookupName(@CategoryID varchar(20)) returns varchar(41)
with encryption as
begin

declare @therItemCategoryName varchar(41)

if dbo.GetOptionValue('EnableClinicMasterFinanceItengration')>0
begin
  set @therItemCategoryName = (select AccountName from ClinicMasterFinance.dbo.ChartAccounts where AccountNo = @CategoryID)
end

else
begin
  set @therItemCategoryName = dbo.GetLookupDataDes(@CategoryID)
end
 set @therItemCategoryName = isnull(@therItemCategoryName, '')

return @therItemCategoryName
end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetChartCategoryLookupName('117BIOMED')



----------------------------------------------------------------------------------------------------------------------------

--------Function GetTotalVisits---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalVisits')
drop function GetTotalVisits
go

create function GetTotalVisits(@PatientNo varchar(20)) returns int
with encryption as

begin

declare @TotalVisits int

set @TotalVisits = (select count(PatientNo) from Visits where PatientNo = @PatientNo)
set @TotalVisits = isnull(@TotalVisits, 0)

return @TotalVisits

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetTotalVisits('000001BA21078') as varchar)
----------------------------------------------------------------------------------------------------------------------------

--------Function Get Visit Position-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetVisitPosition')
drop function GetVisitPosition
go

create function GetVisitPosition(@PatientNo varchar(20), @VisitDate smalldatetime, @VisitID smallint) returns varchar(20)
with encryption as

begin

declare @VisitPosition varchar(20)
declare @Count smallint
declare @MinVisitDate smalldatetime
declare @MaxVisitDate smalldatetime
declare @MinVisitID smallint
declare @MaxVisitID smallint

set @Count = (select count(*) from Visits where PatientNo = @PatientNo)
set @MinVisitDate = (select min(VisitDate) from Visits where PatientNo = @PatientNo)
set @MaxVisitDate = (select max(VisitDate) from Visits where PatientNo = @PatientNo)
set @MinVisitID = (select min(VisitID) from Visits where PatientNo = @PatientNo and VisitDate = @MinVisitDate)
set @MaxVisitID = (select max(VisitID) from Visits where PatientNo = @PatientNo and VisitDate = @MaxVisitDate)

if @Count = 1 set @VisitPosition = 'First and Last'
else if @VisitDate = @MinVisitDate and @VisitID = @MinVisitID set @VisitPosition = 'First'
else if @VisitDate = @MaxVisitDate and @VisitID = @MaxVisitID set @VisitPosition = 'Last'
else if @VisitID <= 1 or @VisitID >= @Count set @VisitPosition = '0'
else set @VisitPosition = cast(@VisitID as varchar(20))

return @VisitPosition

end
go

-- print dbo.GetVisitPosition('08022062', 'Feb 14 2008', 98)

--------Function Get To-Visit Today------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetToVisitToday')
drop function GetToVisitToday
go

create function GetToVisitToday(@StartDate smalldatetime, @EndDate as smalldatetime, 
@AppointmentStatusID as varchar(10), @Today as smalldatetime) 
returns bit
with encryption as
begin

declare @ToVisitToday bit
declare @NextDay as smalldatetime
declare @_AppointmentStatusID varchar(10)

set @NextDay = dateadd(day, 1, dbo.FormatDate(@Today))
set @_AppointmentStatusID = dbo.GetLookupDataID('AppointmentStatus', 'WT')

if @StartDate < @NextDay and @EndDate >= dbo.FormatDate(@Today) and @AppointmentStatusID = @_AppointmentStatusID 
set @ToVisitToday = 1
else set @ToVisitToday = 0

return @ToVisitToday

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetToVisitToday('27 Mar 2007', '28 Mar 2007', '21WT', getdate()) as varchar)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetVisitFileStatus-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetVisitFileStatus')
drop function GetVisitFileStatus
go

create function GetVisitFileStatus(@VisitNo varchar(20)) returns varchar(100)
with encryption as

begin

declare @FileStatus varchar(100)

set @FileStatus = (select dbo.GetLookupDataDes(FileStatusID) from VisitFiles where VisitNo = @VisitNo)
set @FileStatus = isnull(@FileStatus, '')

return @FileStatus

end
go
----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetVisitFileStatus('08022062')
-- print dbo.GetVisitFileStatus('1210883003')

----------------------------------------------------------------------------------------------------------------------------

--------Function GetHasVisitTriage------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasVisitTriage')
drop function GetHasVisitTriage
go

create function GetHasVisitTriage(@VisitNo varchar(20)) returns bit
with encryption as
begin

declare @HasVisitTriage bit

if exists (select VisitNo from Triage where VisitNo = @VisitNo)
set @HasVisitTriage = 1
else set @HasVisitTriage = 0

return @HasVisitTriage

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetHasVisitTriage('VCX') as varchar)
----------------------------------------------------------------------------------------------------------------------------

----------Function IsAdmitted-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'IsAdmitted')
drop function IsAdmitted
go

create function IsAdmitted(@SpecimenNo varchar(20),@RoundNo varchar(20) =null) returns bit
with encryption as

begin

declare @IsAdmitted bit 

begin
if exists(select TOP 1 SpecimenNo from LabRequestsIPD where SpecimenNo=@SpecimenNo and RoundNo =@RoundNo)
begin set @IsAdmitted=1 end
else begin set @IsAdmitted=0 end   
end

set @IsAdmitted= isnull(@IsAdmitted, 0)

return @IsAdmitted
	
end
go

--- print dbo.IsAdmitted('1409935003','130002501002') -----------------------------------------------------------------------------------

----------Function PatientAdmissionStatus---------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'PatientAdmissionStatus')
drop function PatientAdmissionStatus
go

create function PatientAdmissionStatus(@SpecimenNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @PatientAdmissionStatus varchar(20) 
declare @InPatientVisitStatusID as varchar(10)
set @InPatientVisitStatusID = dbo.GetLookupDataID('AdmissionStatus', 'I')

begin
if exists(select TOP 1 SpecimenNo from LabRequestsIPD where SpecimenNo=@SpecimenNo)
begin set @PatientAdmissionStatus='In-Patient' end
else begin set @PatientAdmissionStatus='Out-Patient' end   
end

set @PatientAdmissionStatus= isnull(@PatientAdmissionStatus, 0)

return @PatientAdmissionStatus
	
end
go

--- print dbo.PatientAdmissionStatus('1409935003') ---------------------------------------------------------------------------


--------Function Get Total Bill--------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalBill')
drop function GetTotalBill
go

create function GetTotalBill(@VisitNo varchar(20), @PayStatus  varchar(10)) returns money
with encryption as

begin

declare @TotalBill money

if (@PayStatus is null) or (@PayStatus = '')
begin set @TotalBill = (select sum(Quantity * UnitPrice)from Items where VisitNo = @VisitNo) end
else
begin
declare @PayStatusID  varchar(10)
set @PayStatusID = dbo.GetLookupDataID('PayStatus', @PayStatus)
set @TotalBill = (select sum(Quantity * UnitPrice)from Items where VisitNo = @VisitNo and PayStatusID = @PayStatusID)
end

return @TotalBill

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetTotalBill('07022068001', null) as varchar)
-- print cast(dbo.GetTotalBill('07022068001', 'PF') as varchar)
-- print cast(dbo.GetTotalBill('07022068001', 'NP') as varchar)
----------------------------------------------------------------------------------------------------------------------------

--------Function Get IPD Total Bill--------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDTotalBill')
drop function GetIPDTotalBill
go

create function GetIPDTotalBill(@AdmissionNo varchar(20), @PayStatus  varchar(10)) returns money
with encryption as

begin

declare @TotalBill money

if (@PayStatus is null) or (@PayStatus = '')
begin set @TotalBill = (select sum(Quantity * UnitPrice)from IPDItems
inner join IPDDoctor on IPDDoctor.RoundNo =IPDItems.RoundNo
where AdmissionNo = @AdmissionNo) end
else
begin
declare @PayStatusID  varchar(10)
set @PayStatusID = dbo.GetLookupDataID('PayStatus', @PayStatus)
set @TotalBill = (select sum(Quantity * UnitPrice)from IPDItems
inner join IPDDoctor on IPDDoctor.RoundNo =IPDItems.RoundNo
where AdmissionNo = @AdmissionNo and PayStatusID = @PayStatusID)
end

return @TotalBill

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetIPDTotalBill('07022068001', null) as varchar)
-- print cast(dbo.GetIPDTotalBill('07022068001', 'PF') as varchar)
-- print cast(dbo.GetIPDTotalBill('07022068001', 'NP') as varchar)
----------------------------------------------------------------------------------------------------------------------------



if exists (select * from sysobjects where name = 'GetPackagePayment')
drop function GetPackagePayment
go

create function GetPackagePayment(@VisitNo varchar(20), @PayStatus varchar(10)) returns money
with encryption as
begin
declare @PackagePayment money
declare @ItemCategoryID varchar(10)

set @ItemCategoryID =  dbo.GetLookupDataID('ItemCategory', 'G')


if (@PayStatus is null) or (@PayStatus = '')
begin set @PackagePayment = (select sum(UnitPrice)from Items where VisitNo = @VisitNo and ItemCategoryID =@ItemCategoryID) end
else
begin
declare @PayStatusID  varchar(10)
set @PayStatusID = dbo.GetLookupDataID('PayStatus', @PayStatus)
set @PackagePayment =(select sum(UnitPrice) as UnitPrice from Items where VisitNo =@VisitNo and ItemCategoryID =@ItemCategoryID and PayStatusID=@PayStatusID)
end
return @PackagePayment
end

go
----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetPackagePayment('00354/16002','') as varchar)
--print cast(dbo.GetPackagePayment('00109/16001','PF') as varchar)


if exists (select * from sysobjects where name = 'GetPackagePaymentBalance')
drop function GetPackagePaymentBalance
go

create function GetPackagePaymentBalance(@VisitNo varchar(20)) returns money
with encryption as
begin
declare @PackagePaymentBalance money
declare @Paid money
declare @NotPaid money
declare @ItemCategoryID varchar(10)
declare @PaidStatusID varchar(10)
-------------------------------------------------------------------------

set @ItemCategoryID =  dbo.GetLookupDataID('ItemCategory', 'G')
set @PaidStatusID = dbo.GetLookupDataID('PayStatus', 'PF')
-------------------------------------------------------------------------
begin

set @Paid =isnull((select (UnitPrice) from Items where VisitNo =@VisitNo and ItemCategoryID =@ItemCategoryID and PayStatusID=@PaidStatusID),0)

set @NotPaid =isnull((select (UnitPrice) from Items where VisitNo =@VisitNo and ItemCategoryID =@ItemCategoryID),0)

set @PackagePaymentBalance = Abs(@Paid-@NotPaid)
end
return @PackagePaymentBalance
end
go

--------------------------------------------------------------------------------------------------------------------------

-------print cast(dbo.GetPackagePaymentBalance('00354/16002') as varchar)

--------Function GetPayItemsNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPayItemsNo')
drop function GetPayItemsNo
go

create function GetPayItemsNo(@VisitNo varchar(20)) returns int
with encryption as

begin

declare @PayItemsNo int
begin 
set @PayItemsNo = (select count(*)from Items where VisitNo = @VisitNo)
set @PayItemsNo = isnull(@PayItemsNo, 0)
end

return @PayItemsNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetPayItemsNo('1013113022')
-- print dbo.GetPayItemsNo('SR1203893001')
-- print dbo.GetPayItemsNo('1213486001')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetPrescriptionsNo-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPrescriptionsNo')
drop function GetPrescriptionsNo
go

create function GetPrescriptionsNo(@VisitNo varchar(20)) returns int
with encryption as

begin

------------------------------------------------------------------------------------------------------------------------
declare @PrescriptionsNo int
declare @DrugItemCategoryID varchar(10)
set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
------------------------------------------------------------------------------------------------------------------------

begin 
set @PrescriptionsNo = (select count(*) from Items where VisitNo = @VisitNo and ItemCategoryID = @DrugItemCategoryID)
set @PrescriptionsNo = isnull(@PrescriptionsNo, 0)
end

return @PrescriptionsNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetPrescriptionsNo('1013113022')
-- print dbo.GetPrescriptionsNo('SR1203893001')
-- print dbo.GetPrescriptionsNo('1213486001')
----------------------------------------------------------------------------------------------------------------------------

--------Function Get Remaining Days------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetRemainingDays')
drop function GetRemainingDays
go

create function GetRemainingDays(@StartDate smalldatetime, @AppointmentStatusID as varchar(10), @Today as smalldatetime) 
returns int
with encryption as
begin

declare @RemainingDays int
declare @_AppointmentStatusID varchar(10)

set @_AppointmentStatusID = dbo.GetLookupDataID('AppointmentStatus', 'WT')

if @AppointmentStatusID = @_AppointmentStatusID 
begin
set @RemainingDays = datediff(day, dbo.FormatDate(@Today), dbo.FormatDate(@StartDate))
if @RemainingDays < 0 set @RemainingDays = 0
end
else set @RemainingDays = null

return @RemainingDays

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetRemainingDays('28 Mar 2007', '21WT', getdate()) as varchar)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetDoctorFullName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDoctorFullName')
drop function GetDoctorFullName
go

create function GetDoctorFullName(@VisitNo varchar(20)) returns varchar(41)
with encryption as

begin

declare @DoctorFullName varchar(41)

begin

set @DoctorFullName = (select dbo.GetFullName(Staff.LastName, null, Staff.FirstName) from DoctorVisits
		inner join Staff on DoctorVisits.StaffNo = Staff.StaffNo where VisitNo = @VisitNo)
						
if (@DoctorFullName is null or @DoctorFullName = '') 
begin
set @DoctorFullName = (select dbo.GetFullName(Staff.LastName, null, Staff.FirstName) from Visits
				inner join Staff on Visits.StaffNo = Staff.StaffNo where VisitNo = @VisitNo)	
end
						
set @DoctorFullName = isnull(@DoctorFullName, 'SELF REQUEST')
	
end

return @DoctorFullName

end
go


----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetDoctorFullName('07022066001')
-- print dbo.GetDoctorFullName('003001')
-- print dbo.GetDoctorFullName(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetDoctorContactNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDoctorContactNo')
drop function GetDoctorContactNo
go

create function GetDoctorContactNo(@VisitNo varchar(20)) returns varchar(41)
with encryption as

begin

declare @DoctorContactNo varchar(41)

begin

set @DoctorContactNo = (select Phone from DoctorVisits
		inner join Staff on DoctorVisits.StaffNo = Staff.StaffNo where VisitNo = @VisitNo)
						
if (@DoctorContactNo is null or @DoctorContactNo = '') 
begin
set @DoctorContactNo = (select Phone from Visits
				inner join Staff on Visits.StaffNo = Staff.StaffNo where VisitNo = @VisitNo)	
end
						
set @DoctorContactNo = isnull(@DoctorContactNo, 'Contact Unavailable')
	
end

return @DoctorContactNo

end
go


----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetDoctorContactNo('1300001008')
-- print dbo.GetDoctorContactNo('003001')
-- print dbo.GetDoctorContactNo(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetSeenDoctor----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetSeenDoctor')
drop function GetSeenDoctor
go

create function GetSeenDoctor(@VisitNo varchar(20)) returns varchar(41)
with encryption as

begin

declare @DoctorFullName varchar(41)

begin

set @DoctorFullName = (select dbo.GetFullName(Staff.LastName, null, Staff.FirstName) from DoctorVisits
		inner join Staff on DoctorVisits.StaffNo = Staff.StaffNo where VisitNo = @VisitNo)
					
set @DoctorFullName = isnull(@DoctorFullName, '')
	
end

return @DoctorFullName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetSeenDoctor('07022066001')
-- print dbo.GetSeenDoctor('003001')
-- print dbo.GetSeenDoctor(null)
----------------------------------------------------------------------------------------------------------------------------


--------Function GetFileSeenDoctor----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetFileSeenDoctor')
drop function GetFileSeenDoctor
go

create function GetFileSeenDoctor(@VisitNo varchar(20),@startDate SmallDateTime,@EndDate SmallDateTime) returns varchar(41)
with encryption as

begin

declare @DoctorFullName varchar(41)

begin

set @DoctorFullName = (select dbo.GetFullName(Staff.LastName, null, Staff.FirstName) from DoctorVisits
		inner join Staff on DoctorVisits.StaffNo = Staff.StaffNo where VisitNo = @VisitNo and DoctorVisits.RecordDateTime between @startDate and @EndDate)
					
set @DoctorFullName = isnull(@DoctorFullName, '')
	
end

return @DoctorFullName

end

go

----------------------------------------------------------------------------------------------------------------------------

--------Function GetStaffSpecialty-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetStaffSpecialty')
drop function GetStaffSpecialty
go

create function GetStaffSpecialty(@StaffNo varchar(10)) returns varchar(100)
with encryption as

begin

declare @StaffSpecialty varchar(100)

begin						
set @StaffSpecialty = (select dbo.GetLookupDataDes(DoctorSpecialtyID) from Staff where StaffNo = @StaffNo)			
set @StaffSpecialty = isnull(@StaffSpecialty, '')	
end

return @StaffSpecialty

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetStaffSpecialty('0001')
-- print dbo.GetStaffSpecialty('007')
-- print dbo.GetStaffSpecialty(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetDoctorSpecialty-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDoctorSpecialty')
drop function GetDoctorSpecialty
go

create function GetDoctorSpecialty(@VisitNo varchar(20)) returns varchar(100)
with encryption as

begin

declare @DoctorSpecialty varchar(100)

begin
set @DoctorSpecialty = (select dbo.GetLookupDataDes(DoctorSpecialtyID) from DoctorVisits
		inner join Staff on DoctorVisits.StaffNo = Staff.StaffNo where VisitNo = @VisitNo)
												
if (@DoctorSpecialty is null or @DoctorSpecialty = '') 
begin
set @DoctorSpecialty = (select dbo.GetLookupDataDes(DoctorSpecialtyID) from Visits where VisitNo = @VisitNo)	
end
						
set @DoctorSpecialty = isnull(@DoctorSpecialty, '')
	
end

return @DoctorSpecialty

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetDoctorSpecialty('07022066001')
-- print dbo.GetDoctorSpecialty('003001')
-- print dbo.GetDoctorSpecialty(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetSeenDoctorSpecialty-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetSeenDoctorSpecialty')
drop function GetSeenDoctorSpecialty
go

create function GetSeenDoctorSpecialty(@VisitNo varchar(20)) returns varchar(100)
with encryption as

begin

declare @DoctorSpecialty varchar(100)

begin
set @DoctorSpecialty = (select dbo.GetLookupDataDes(DoctorSpecialtyID) from DoctorVisits
		inner join Staff on DoctorVisits.StaffNo = Staff.StaffNo where VisitNo = @VisitNo)
				
set @DoctorSpecialty = isnull(@DoctorSpecialty, '')
	
end

return @DoctorSpecialty

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetSeenDoctorSpecialty('07022066001')
-- print dbo.GetSeenDoctorSpecialty('003001')
-- print dbo.GetSeenDoctorSpecialty(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetDoctorStaffNo-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDoctorStaffNo')
drop function GetDoctorStaffNo
go

create function GetDoctorStaffNo(@VisitNo varchar(20)) returns varchar(10)
with encryption as

begin

declare @DoctorStaffNo varchar(10)

begin
set @DoctorStaffNo = (select StaffNo from DoctorVisits where VisitNo = @VisitNo)
set @DoctorStaffNo = isnull(@DoctorStaffNo, '')
end

return @DoctorStaffNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetDoctorStaffNo('100002001')
-- print dbo.GetDoctorStaffNo(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetDoctorServiceCode----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDoctorServiceCode')
drop function GetDoctorServiceCode
go

create function GetDoctorServiceCode(@VisitNo varchar(20)) returns varchar(10)
with encryption as

begin

declare @DoctorServiceCode varchar(10)

begin
set @DoctorServiceCode = (select ServiceCode from DoctorVisits where VisitNo= @VisitNo)
set @DoctorServiceCode = isnull(@DoctorServiceCode, '')
end

return @DoctorServiceCode

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetDoctorServiceCode('10 10390001')
-- print dbo.GetDoctorServiceCode(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetDoctorServiceName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDoctorServiceName')
drop function GetDoctorServiceName
go

create function GetDoctorServiceName(@VisitNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @DoctorServiceName varchar(20)

begin
set @DoctorServiceName = (select ServiceName from DoctorVisits 
			left outer join Services on DoctorVisits.ServiceCode = Services.ServiceCode
			where VisitNo= @VisitNo)
set @DoctorServiceName = isnull(@DoctorServiceName, '')
end

return @DoctorServiceName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetDoctorServiceName('10 10390001')
-- print dbo.GetDoctorServiceName(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetDoctorVisitClosed---------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDoctorVisitClosed')
drop function GetDoctorVisitClosed
go

create function GetDoctorVisitClosed(@VisitNo varchar(20)) returns bit
with encryption as

begin

declare @DoctorVisitClosed bit

begin
set @DoctorVisitClosed = (select Closed from DoctorVisits where VisitNo = @VisitNo)
set @DoctorVisitClosed = isnull(@DoctorVisitClosed, 0)
end

return @DoctorVisitClosed

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetDoctorVisitClosed('100002001')
-- print dbo.GetDoctorVisitClosed(null)
----------------------------------------------------------------------------------------------------------------------------

----------Function GetDoctorRecordDateTime----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDoctorRecordDateTime')
drop function GetDoctorRecordDateTime
go

create function GetDoctorRecordDateTime(@VisitNo varchar(20)) returns smalldatetime
with encryption as

begin
declare @RecordDateTime smalldatetime
set @RecordDateTime = (select RecordDateTime from DoctorVisits where VisitNo = @VisitNo)
	
return @RecordDateTime
end
go

-- print dbo.GetDoctorRecordDateTime('1010004007')
-- select * from DoctorVisits

--------Function GetProvisionalDiagnosis---------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetProvisionalDiagnosis')
drop function GetProvisionalDiagnosis
go

create function GetProvisionalDiagnosis(@VisitNo varchar(20)) returns varchar(1000)
with encryption as

begin

declare @ProvisionalDiagnosis varchar(1000)

begin
set @ProvisionalDiagnosis = (select ProvisionalDiagnosis from ClinicalFindings where VisitNo = @VisitNo)
set @ProvisionalDiagnosis = isnull(@ProvisionalDiagnosis, '')
end

return @ProvisionalDiagnosis

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetProvisionalDiagnosis('1302865001')
-- print dbo.GetProvisionalDiagnosis(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetProvisionalIPDDiagnosis---------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetProvisionalIPDDiagnosis')
drop function GetProvisionalIPDDiagnosis
go

create function GetProvisionalIPDDiagnosis(@RoundNo varchar(20)) returns varchar(1000)
with encryption as

begin

declare @ProvisionalIPDDiagnosis varchar(1000)

begin
set @ProvisionalIPDDiagnosis = (select ClinicalDiagnosis from IPDClinicalFindings where RoundNo = @RoundNo)
set @ProvisionalIPDDiagnosis = isnull(@ProvisionalIPDDiagnosis, '')
end

return @ProvisionalIPDDiagnosis

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetProvisionalIPDDiagnosis('10104250301')
-- print dbo.GetProvisionalIPDDiagnosis(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function Get StaffFullName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetStaffFullName')
drop function GetStaffFullName
go

create function GetStaffFullName(@StaffNo varchar(10)) returns varchar(41)
with encryption as

begin

declare @StaffFullName varchar(41)

begin
set @StaffFullName = (select dbo.GetMergedNameCode(dbo.GetFullName(LastName, null, FirstName), StaffNo) 
			from Staff where StaffNo = @StaffNo)
set @StaffFullName = isnull(@StaffFullName, '')
end

return @StaffFullName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetStaffFullName('1')
-- print dbo.GetStaffFullName(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetStaffName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetStaffName')
drop function GetStaffName
go

create function GetStaffName(@StaffNo varchar(10)) returns varchar(41)
with encryption as

begin

declare @StaffName varchar(41)

begin
set @StaffName = (select dbo.GetFullName(LastName, null, FirstName) 
			from Staff where StaffNo = @StaffNo)
set @StaffName = isnull(@StaffName, '')
end

return @StaffName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetStaffName('1')
-- print dbo.GetStaffName(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetStaffLoginID----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetStaffLoginID')
drop function GetStaffLoginID
go

create function GetStaffLoginID(@StaffNo varchar(10)) returns varchar(20)
with encryption as

begin

declare @StaffLoginID varchar(20)

begin
set @StaffLoginID = (select top 1 LoginID from Staff where StaffNo = @StaffNo)
set @StaffLoginID = isnull(@StaffLoginID, '')
end

return @StaffLoginID

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetStaffLoginID('100')
-- print dbo.GetStaffLoginID(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetStaffPhoneNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetStaffPhoneNo')
drop function GetStaffPhoneNo
go

create function GetStaffPhoneNo(@StaffNo varchar(10)) returns varchar(41)
with encryption as

begin

declare @StaffPhoneNo varchar(41)

begin
set @StaffPhoneNo = (select Phone 
			from Staff where StaffNo = @StaffNo)
set @StaffPhoneNo = isnull(@StaffPhoneNo, 'Phone Unavailable')
end

return @StaffPhoneNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetStaffPhoneNo('1')
-- print dbo.GetStaffPhoneNo(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetStaffNoforLoginID----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetStaffNoforLoginID')
drop function GetStaffNoforLoginID
go

create function GetStaffNoforLoginID(@LoginID varchar(20)) returns varchar(10)
with encryption as

begin

declare @LoginStaffNo varchar(10)

begin
set @LoginStaffNo = (select top 1 StaffNo from Staff where LoginID = @LoginID)
set @LoginStaffNo = isnull(@LoginStaffNo, '')
end

return @LoginStaffNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetStaffNoforLoginID('Administrator')
-- print dbo.GetStaffNoforLoginID(null)
----------------------------------------------------------------------------------------------------------------------------


--------Function GetDoctorSpecialtyID----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDoctorSpecialtyID')
drop function GetDoctorSpecialtyID
go

create function GetDoctorSpecialtyID(@LoginID varchar(20)) returns varchar(10)
with encryption as

begin

declare @DoctorSpecialtyID varchar(10)

begin
set @DoctorSpecialtyID = (select top 1 DoctorSpecialtyID from Staff where LoginID = @LoginID)
set @DoctorSpecialtyID = isnull(@DoctorSpecialtyID, '')
end

return @DoctorSpecialtyID

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetDoctorSpecialtyID('Admin')
-- print dbo.GetDoctorSpecialtyID(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetDoctorLoginID----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDoctorLoginID')
drop function GetDoctorLoginID
go

create function GetDoctorLoginID(@VisitNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @StaffNo varchar(10)
declare @DoctorLoginID varchar(20)

begin
set @StaffNo = (select StaffNo from DoctorVisits where VisitNo= @VisitNo)
set @DoctorLoginID = (select LoginID from Staff where StaffNo = @StaffNo)
set @DoctorLoginID = isnull(@DoctorLoginID, '')
end

return @DoctorLoginID

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetDoctorLoginID('1101413001')
-- print dbo.GetDoctorLoginID(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function Get First Visit Date--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetFirstVisitDate')
drop function GetFirstVisitDate
go

create function GetFirstVisitDate(@PatientNo varchar(20)) returns smalldatetime
with encryption as

begin
declare @FirstVisitDate smalldatetime
select @FirstVisitDate = Min(VisitDate) from Visits where PatientNo = @PatientNo
return @FirstVisitDate
end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetFirstVisitDate('T020098JK')
----------------------------------------------------------------------------------------------------------------------------

--------Function Get Last Visit Date--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetLastVisitDate')
drop function GetLastVisitDate
go

create function GetLastVisitDate(@PatientNo varchar(20)) returns smalldatetime
with encryption as

begin
declare @LastVisitDate smalldatetime
select @LastVisitDate = Max(VisitDate) from Visits where PatientNo = @PatientNo
return @LastVisitDate
end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetLastVisitDate('T020098JK')
----------------------------------------------------------------------------------------------------------------------------

--------Function Get Last Asset service Date--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetLastAssetServiceDate')
drop function GetLastAssetServiceDate
go

create function GetLastAssetServiceDate(@SerialNo varchar(20)) returns smalldatetime
with encryption as

begin
declare @LastVisitDate smalldatetime
select @LastVisitDate = Max(MaintainanceDate) from AssetMaintainanceLog where SerialNo = @SerialNo
return @LastVisitDate
end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetLastAssetServiceDate('001')
----------------------------------------------------------------------------------------------------------------------------


-------------------------Get Patient Visit Status-----------------------------------------------

if exists (select * from sysobjects where name = 'GetPatientVisitStatusID')
drop function GetPatientVisitStatusID
go

create function GetPatientVisitStatusID (@VisitNo varchar(20)) returns varchar(10)
with encryption as
begin
declare @VisitStatusID varchar(10)
SET @VisitStatusID = (select VisitStatusID  from Visits 
where VisitNo =@VisitNo)
return @VisitStatusID
end
go

--print dbo.GetPatientVisitStatusID('11304446001')
-------select  Top 5 * from Visits
------------------------------------------------------------------------------------------------------


--------Function Get Total Lab Request Tests-----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalLabRequestDetails')
drop function GetTotalLabRequestDetails
go

create function GetTotalLabRequestDetails(@SpecimenNo varchar(20)) returns int
with encryption as

begin

declare @TotalLabRequestDetails int

set @TotalLabRequestDetails = (select count(SpecimenNo) from LabRequestDetails where SpecimenNo = @SpecimenNo)
set @TotalLabRequestDetails = isnull(@TotalLabRequestDetails, 0)

return @TotalLabRequestDetails

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetTotalLabRequestDetails('004193NJ01') as varchar)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetHasPossibleResults------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasPossibleResults')
drop function GetHasPossibleResults
go

create function GetHasPossibleResults(@TestCode varchar(20)) returns bit
with encryption as
begin

declare @HasPossibleResults bit

if exists (select TestCode from LabPossibleResults where TestCode = @TestCode)
set @HasPossibleResults = 1
else set @HasPossibleResults = 0

return @HasPossibleResults

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetHasPossibleResults('VCX') as varchar)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetHasSubTests---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasSubTests')
drop function GetHasSubTests
go

create function GetHasSubTests(@TestCode varchar(20)) returns bit
with encryption as
begin

declare @HasSubTests bit

if exists (select TestCode from LabTestsEXT where TestCode = @TestCode)
set @HasSubTests = 1
else set @HasSubTests = 0

return @HasSubTests

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetHasSubTests('CBC') as varchar)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetLabResultsEXT------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetLabResultsEXT')
drop function GetLabResultsEXT
go

create function GetLabResultsEXT(@SpecimenNo varchar(20), @TestCode varchar(20), @Result varchar(200)) 
returns varchar(4000)
with encryption as
begin

declare @ResultEXT varchar(200)
declare @SubTestName varchar(40)
declare @NormalRange varchar(800)

declare @LabResultsEXT varchar(6000)
set @LabResultsEXT = ''

if dbo.GetHasSubTests(@TestCode) = 0
set @LabResultsEXT = @Result
else 
begin
	
DECLARE LabResultsEXT_Cursor CURSOR FOR

select SubTestName, Result, LabResultsEXT.NormalRange from LabResultsEXT 
inner join LabtestsEXT on  LabResultsEXT.TestCode = LabtestsEXT.TestCode
and LabResultsEXT.SubTestCode = LabtestsEXT.SubTestCode
where SpecimenNo = @SpecimenNo and LabResultsEXT.TestCode = @TestCode
order by SortOrder

OPEN LabResultsEXT_Cursor
FETCH NEXT FROM LabResultsEXT_Cursor INTO @SubTestName, @ResultEXT, @NormalRange
WHILE (@@FETCH_STATUS <> -1)
BEGIN
if @NormalRange = '' or @NormalRange is null
SET @LabResultsEXT = @LabResultsEXT + @SubTestName + '=' + @ResultEXT + ', '
else SET @LabResultsEXT = @LabResultsEXT + @SubTestName + '=' + @ResultEXT + ' (' + @NormalRange + ') ' + ', '
FETCH NEXT FROM LabResultsEXT_Cursor INTO  @SubTestName, @ResultEXT, @NormalRange
END

CLOSE LabResultsEXT_Cursor
DEALLOCATE LabResultsEXT_Cursor

if len(@LabResultsEXT) > 0 set @LabResultsEXT = left(@LabResultsEXT, len(@LabResultsEXT)-1)

if @Result = '' or @Result is null set @LabResultsEXT = @LabResultsEXT
else set @LabResultsEXT = @Result  + ' (' + @LabResultsEXT + ')'
end
 
return @LabResultsEXT

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetLabResultsEXT('170043002', 'T138', '') as varchar)
----------------------------------------------------------------------------------------------------------------------------

--------Function Get Combination Currently On------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCombinationCurrentlyOn')
drop function GetCombinationCurrentlyOn
go

create function GetCombinationCurrentlyOn(@PatientNo varchar(20)) returns varchar(30)
with encryption as

begin

declare @Combination varchar(30)
declare @ARTStatusID varchar(10)

set @ARTStatusID = dbo.GetLookupDataID('ARTStatus', 'O')

set @Combination = (select top 1 Combination from ARTRegimen
	inner join Visits on ARTRegimen.VisitNo = Visits.VisitNo
	where (Visits.PatientNo = @PatientNo) and (ARTStatusID = @ARTStatusID)
	order by StartDate desc)

set @Combination = isnull(@Combination, '')

return @Combination

end
go

-- print dbo.GetCombinationCurrentlyOn('07022064')
-- select * from Items

--------Function GetAmountPaid ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAmountPaid')
drop function GetAmountPaid
go

create function GetAmountPaid(@PayTypeID varchar(10), @VisitTypeID varchar(10), @ReceiptNo varchar(20)) returns money
with encryption as

begin

declare @CashVisitPayTypeID varchar(10)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)
declare @IPDRoundPayTypeID varchar(10)
declare @ExtraBillPayTypeID varchar(10)

declare @OPDVisitTypeID varchar(10)
declare @IPDVisitTypeID varchar(10)

declare @AmountPaid money

-------------------------------------------------------------------------------------------------------------------------
set @CashVisitPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')
set @IPDRoundPayTypeID = dbo.GetLookupDataID('PayType', 'IPR')
set @ExtraBillPayTypeID = dbo.GetLookupDataID('PayType', 'EXT')

set @OPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')
-------------------------------------------------------------------------------------------------------------------------

if (((@PayTypeID = @CashVisitPayTypeID) or (@PayTypeID = @AccountBillPayTypeID) or (@PayTypeID = @InsuranceBillPayTypeID)) 
and (@VisitTypeID = @OPDVisitTypeID))
begin set @AmountPaid = (select sum(Amount) from PaymentDetails where ReceiptNo = @ReceiptNo) end	
else if (((@PayTypeID = @CashVisitPayTypeID) or (@PayTypeID = @AccountBillPayTypeID) or (@PayTypeID = @InsuranceBillPayTypeID)) 
and (@VisitTypeID = @IPDVisitTypeID))
begin set @AmountPaid = (select sum(Amount) from PaymentExtraBillItems where ReceiptNo = @ReceiptNo) end	
else if (@PayTypeID = @ExtraBillPayTypeID)
begin set @AmountPaid = (select sum(Amount) from PaymentExtraBillItems where ReceiptNo = @ReceiptNo) end
else begin set @AmountPaid = (select sum(Amount) from PaymentDetails where ReceiptNo = @ReceiptNo) end
	
set @AmountPaid = isnull(@AmountPaid, 0.00)

return @AmountPaid

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetAmountPaid('47CAS', '12030320'))
-- print dbo.FormatMoney(dbo.GetAmountPaid('47ACC', '12030324'))
-- print dbo.FormatMoney(dbo.GetAmountPaid('47INS', '12030327'))
-- print dbo.FormatMoney(dbo.GetAmountPaid('47EXT', '12030325'))

----------------------------------------------------------------------------------------------------------------------------
--------Function GetTotalDiscount ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalDiscount')
drop function GetTotalDiscount
go

create function GetTotalDiscount(@PayTypeID varchar(10), @VisitTypeID varchar(10), @ReceiptNo varchar(20)) returns money
with encryption as

begin

declare @CashVisitPayTypeID varchar(10)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)
declare @IPDRoundPayTypeID varchar(10)
declare @ExtraBillPayTypeID varchar(10)

declare @OPDVisitTypeID varchar(10)
declare @IPDVisitTypeID varchar(10)

declare @DiscountPaid money

-------------------------------------------------------------------------------------------------------------------------
set @CashVisitPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')
set @IPDRoundPayTypeID = dbo.GetLookupDataID('PayType', 'IPR')
set @ExtraBillPayTypeID = dbo.GetLookupDataID('PayType', 'EXT')

set @OPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')
-------------------------------------------------------------------------------------------------------------------------

if (((@PayTypeID = @CashVisitPayTypeID) or (@PayTypeID = @AccountBillPayTypeID) or (@PayTypeID = @InsuranceBillPayTypeID)) 
and (@VisitTypeID = @OPDVisitTypeID))
begin set @DiscountPaid = (select sum(Discount) from PaymentDetails where ReceiptNo = @ReceiptNo) end	
else if (((@PayTypeID = @CashVisitPayTypeID) or (@PayTypeID = @AccountBillPayTypeID) or (@PayTypeID = @InsuranceBillPayTypeID)) 
and (@VisitTypeID = @IPDVisitTypeID))
begin set @DiscountPaid = (select sum(Discount) from PaymentExtraBillItems where ReceiptNo = @ReceiptNo) end	
else if (@PayTypeID = @ExtraBillPayTypeID)
begin set @DiscountPaid = (select sum(Discount) from PaymentExtraBillItems where ReceiptNo = @ReceiptNo) end
else begin set @DiscountPaid = (select sum(Discount) from PaymentDetails where ReceiptNo = @ReceiptNo) end
	
set @DiscountPaid = isnull(@DiscountPaid, 0.00)

return @DiscountPaid

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetTotalDiscount('47CAS', '12030320'))
-- print dbo.FormatMoney(dbo.GetTotalDiscount('47ACC', '12030324'))
-- print dbo.FormatMoney(dbo.GetTotalDiscount('47INS', '12030327'))
-- print dbo.FormatMoney(dbo.GetTotalDiscount('47EXT', '12030325'))

----------------------------------------------------------------------------------------------------------------------------
--------Function GetAmountRefunded ------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAmountRefunded')
drop function GetAmountRefunded
go

create function GetAmountRefunded(@ReceiptNo varchar(20)) returns money
with encryption as

begin

declare @AmountRefunded money

set @AmountRefunded = (select sum(Amount) from Refunds Where ReceiptNo = @ReceiptNo)
set @AmountRefunded = isnull(@AmountRefunded, 0.00)

return @AmountRefunded

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetAmountRefunded('13010334'))

----------------------------------------------------------------------------------------------------------------------------

--------Function GetInvoiceAmount ------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInvoiceAmount')
drop function GetInvoiceAmount
go

create function GetInvoiceAmount(@InvoiceNo varchar(20), @VisitTypeID varchar(10)) returns money
with encryption as

begin

declare @OPDVisitTypeID varchar(10)
declare @IPDVisitTypeID varchar(10)
declare @CombinedVisitTypeID varchar(10)

declare @InvoiceAmount money

--------------------------------------------------------------------------------------------------------------
set @OPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')
set @CombinedVisitTypeID = dbo.GetLookupDataID('VisitType', 'COM')

--------------------------------------------------------------------------------------------------------------
if (@VisitTypeID = @OPDVisitTypeID)
begin set @InvoiceAmount = (select sum(Amount) from InvoiceDetails Where InvoiceNo = @InvoiceNo) end	
		
else if  (@VisitTypeID = @IPDVisitTypeID)
begin set @InvoiceAmount = (select sum(Amount) from InvoiceExtraBillItems Where InvoiceNo = @InvoiceNo) end
else if  (@VisitTypeID = @CombinedVisitTypeID)		
begin set @InvoiceAmount = (select sum(Amount) from InvoiceExtraBillItems Where InvoiceNo = @InvoiceNo) 
+(select sum(Amount) from InvoiceDetails Where InvoiceNo = @InvoiceNo) end
else begin set @InvoiceAmount = (select sum(Amount) from InvoiceDetails Where InvoiceNo = @InvoiceNo) end
--------------------------------------------------------------------------------------------------------------

set @InvoiceAmount = isnull(@InvoiceAmount, 0.00)

return @InvoiceAmount

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetInvoiceAmount('13000120', '110IPD'))
----------------------------------------------------------------------------------------------------------------------------

--------Function GetQuotationAmount ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetQuotationAmount')
drop function GetQuotationAmount
go

create function GetQuotationAmount(@QuotationNo varchar(20)) returns money
with encryption as

begin

declare @QuotationAmount money

--------------------------------------------------------------------------------------------------------------
set @QuotationAmount = (select sum(Amount) from QuotationDetails Where QuotationNo = @QuotationNo) 
--------------------------------------------------------------------------------------------------------------

set @QuotationAmount = isnull(@QuotationAmount, 0.00)

return @QuotationAmount

end

go

--------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetQuotationAmount('13000120'))
--------------------------------------------------------------------------------------------------------------


--------Function IsItemBalanceStatusOffered-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'IsItemBalanceStatusOffered')
drop function IsItemBalanceStatusOffered
go

create function IsItemBalanceStatusOffered(@VisitNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns bit
with encryption as
begin

declare @ItemStatusOffered varchar(10)
declare @ItemStatusPending varchar(10)
declare @result bit

set @ItemStatusOffered = dbo.GetLookupDataID('ItemStatus','O')
set @ItemStatusPending = dbo.GetLookupDataID('ItemStatus','P')

--------------------------
if (exists(select VisitNo from Visits) and  exists(select VisitNo from ItemsBalanceDetails where 
VisitNo = @VisitNo and	ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode))
begin
if((select BalanceStatus from ItemsBalanceDetails where 
VisitNo = @VisitNo and	ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode) = @ItemStatusPending)
set @result = 1
				
else if((select BalanceStatus from ItemsBalanceDetails where 
VisitNo = @VisitNo and	ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode) = @ItemStatusOffered)
set @result = 0
end
return @result
end
go


----------------------------------------------------------------------------------------------------------------------------
-- print dbo.IsItemBalanceStatusOffered('160001')
-- print dbo.IsItemBalanceStatusOffered('160001','7D','ME059') ME059


--------Function GetPurchaseOrderAmount ----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPurchaseOrderAmount')
drop function GetPurchaseOrderAmount
go

create function GetPurchaseOrderAmount(@PurchaseOrderNo varchar(20)) returns money
with encryption as

begin

declare @PurchaseOrderAmount money

--------------------------------------------------------------------------------------------------------------------------
set @PurchaseOrderAmount = (select sum(Amount) from PurchaseOrderDetails where PurchaseOrderNo = @PurchaseOrderNo) 
--------------------------------------------------------------------------------------------------------------------------

set @PurchaseOrderAmount = isnull(@PurchaseOrderAmount, 0.00)

return @PurchaseOrderAmount

end

go

--------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetPurchaseOrderAmount('13000120'))
--------------------------------------------------------------------------------------------------------------------------

--------Function GetServiceInvoicesAmount ----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetServiceInvoicesAmount')
drop function GetServiceInvoicesAmount
go

create function GetServiceInvoicesAmount(@ServiceInvoicesNo varchar(20)) returns money
with encryption as

begin

declare @ServiceInvoicesAmount money

--------------------------------------------------------------------------------------------------------------------------
set @ServiceInvoicesAmount = (select sum(Amount) from ServiceInvoiceDetails where ServiceInvoiceNo = @ServiceInvoicesNo) 
--------------------------------------------------------------------------------------------------------------------------

set @ServiceInvoicesAmount = isnull(@ServiceInvoicesAmount, 0.00)

return @ServiceInvoicesAmount

end

go

--------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetServiceInvoicesAmount('170001'))
--------------------------------------------------------------------------------------------------------------------------


--------Function GetPurchaseOrderDetailsItemTotals-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetGoodsReceivedNoteTotalQuantity')
drop function GetGoodsReceivedNoteTotalQuantity
go

create function GetGoodsReceivedNoteTotalQuantity(@PurchaseOrderNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as
begin

declare @Total int
--------------------------
if (exists(select PurchaseOrderNo from GoodsReceivedNote
inner join  GoodsReceivedNoteDetails on GoodsReceivedNoteDetails.GRNNo = GoodsReceivedNote.GRNNo
where
PurchaseOrderNo = @PurchaseOrderNo and
ItemCategoryID = @ItemCategoryID and
ItemCode = @ItemCode))
   
begin
set @Total =(select sum(GoodsReceivedNoteDetails.ReceivedQuantity) from GoodsReceivedNoteDetails 
inner join  GoodsReceivedNote on GoodsReceivedNote.GRNNo = GoodsReceivedNoteDetails.GRNNo
where
ItemCategoryID = @ItemCategoryID
and ItemCode = @ItemCode 
and GoodsReceivedNote.PurchaseOrderNo = @PurchaseOrderNo
)		   
end
else
begin 
set @Total = 0
		
end
return @Total
	
end
go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetGoodsReceivedNoteTotalQuantity('0001','7D','M389')
-- print dbo.GetGoodsReceivedNoteTotalQuantity('160001','7D','ME059') ME059


--------Function GetPurchaseOrderPayAmount ----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPurchaseOrderPayAmount')
drop function GetPurchaseOrderPayAmount
go

create function GetPurchaseOrderPayAmount(@PurchaseOrderNo varchar(20),@PayStatusID varchar(10)) returns money
with encryption as

begin

declare @PurchaseOrderPayAmount money
--------------------------------------------------------------------------------------------------------------------------
set @PurchaseOrderPayAmount =(select sum(Amount) As UnpaidAmount from GoodsReceivedNoteDetails
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo =GoodsReceivedNoteDetails.GRNNo
where PurchaseOrderNo =@PurchaseOrderNo and PayStatusID =@PayStatusID)
--------------------------------------------------------------------------------------------------------------------------
set @PurchaseOrderPayAmount = isnull(@PurchaseOrderPayAmount, 0.00)
return @PurchaseOrderPayAmount
end

go

--------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetPurchaseOrderPayAmount('170004','12NP'))
-- print dbo.FormatMoney(dbo.GetPurchaseOrderPayAmount('170004','12PF'))
--------------------------------------------------------------------------------------------------------------------------

--------Function GetServiceInvoicePayAmount ----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetServiceInvoicePayAmount')
drop function GetServiceInvoicePayAmount
go

create function GetServiceInvoicePayAmount(@ServiceInvoiceNo varchar(20),@PayStatusID varchar(10)) returns money
with encryption as

begin

declare @ServiceInvoicePayAmount money
--------------------------------------------------------------------------------------------------------------------------
set @ServiceInvoicePayAmount =(select sum(Amount) As UnpaidAmount from ServiceInvoiceDetails
inner join ServiceInvoices on ServiceInvoices.ServiceInvoiceNo =ServiceInvoiceDetails.ServiceInvoiceNo
where ServiceInvoiceDetails.ServiceInvoiceNo =@ServiceInvoiceNo and PayStatusID =@PayStatusID)
--------------------------------------------------------------------------------------------------------------------------
set @ServiceInvoicePayAmount = isnull(@ServiceInvoicePayAmount, 0.00)
return @ServiceInvoicePayAmount
end

go

--------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetServiceInvoicePayAmount('170001','12NP'))
-- print dbo.FormatMoney(dbo.GetServiceInvoicePayAmount('170001','12PF'))
--------------------------------------------------------------------------------------------------------------------------


--------Function Get PurchaseOrderDetailsItemBalance----------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPurchaseOrderDetailsItemBalance')
drop function GetPurchaseOrderDetailsItemBalance
go

create function GetPurchaseOrderDetailsItemBalance(@PurchaseOrderNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as
begin

declare @ReceivedItems int
declare @Balance int
--------------------------
if (exists(select PurchaseOrderNo from GoodsReceivedNote
inner join  GoodsReceivedNoteDetails on GoodsReceivedNoteDetails.GRNNo = GoodsReceivedNote.GRNNo
where
PurchaseOrderNo = @PurchaseOrderNo and
ItemCategoryID = @ItemCategoryID and
ItemCode = @ItemCode))
begin
set @Balance =(
(select Quantity from PurchaseOrderDetails where PurchaseOrderNo = @PurchaseOrderNo
and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode) - 
(dbo.GetGoodsReceivedNoteTotalQuantity(@PurchaseOrderNo, @ItemCategoryID, @ItemCode)))		   
end
else
begin 
set @Balance = (select Quantity from PurchaseOrderDetails where PurchaseOrderNo = @PurchaseOrderNo
and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
		
end
return @balance
	
end
go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetPurchaseOrderDetailsItemBalance('0001','7D','M389')
-- print dbo.GetPurchaseOrderDetailsItemBalance('160001','7D','ME059') ME059


--------Function GetPeriodicSupplierNotPaidForAmount ----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPeriodicSupplierNotPaidForAmount')
drop function GetPeriodicSupplierNotPaidForAmount
go

create function GetPeriodicSupplierNotPaidForAmount(@SupplierNo varchar(20), @PayStatusID varchar(10), @StartDate smalldatetime, @EndDate as smalldatetime) returns money
with encryption as

begin

declare @PurchaseOrderPayAmount money
declare @ServiceInvoicePayAmount money
declare @ReturnedAmount money
declare @TotalAmount money

--------------------------------------------------------------------------------------------------------------------------
set @PurchaseOrderPayAmount = (select sum(Amount) As UnpaidAmount from GoodsReceivedNoteDetails
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo = GoodsReceivedNoteDetails.GRNNo
inner join PurchaseOrders on PurchaseOrders.PurchaseOrderNo = GoodsReceivedNote.PurchaseOrderNo
where SupplierNo =@SupplierNo and PayStatusID =@PayStatusID and ReceivedDate between @StartDate and @EndDate)
set @PurchaseOrderPayAmount = isnull(@PurchaseOrderPayAmount, 0.00)

set @ServiceInvoicePayAmount =(select sum(Amount) As UnpaidAmount from ServiceInvoiceDetails
inner join ServiceInvoices on ServiceInvoices.ServiceInvoiceNo = ServiceInvoiceDetails.ServiceInvoiceNo
where SupplierNo =@SupplierNo and PayStatusID = @PayStatusID and InvoiceDate between @StartDate and @EndDate)

set @ServiceInvoicePayAmount = isnull(@ServiceInvoicePayAmount, 0.00)
--------------------------------------------------------------------------------------------------------------------------
set @ReturnedAmount = (select sum(ReturnQuantity*Rate) 
from GoodsReturnedNoteDetails 
inner join GoodsReturnedNote on GoodsReturnedNote.ReturnNo=GoodsReturnedNoteDetails.ReturnNo
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo=GoodsReturnedNote.GRNNo
inner join  GoodsReceivedNoteDetails on GoodsReceivedNoteDetails.GRNNo=GoodsReturnedNote.GRNNo 
and GoodsReceivedNoteDetails.ItemCategoryID = GoodsReturnedNoteDetails.ItemCategoryID 
and GoodsReceivedNoteDetails.ItemCode = GoodsReturnedNoteDetails.ItemCode
inner join PurchaseOrders on PurchaseOrders.PurchaseOrderNo=GoodsReceivedNote.PurchaseOrderNo
inner join Suppliers on Suppliers.SupplierNo=PurchaseOrders.SupplierNo
where Suppliers.SupplierNo = @SupplierNo and PayStatusID=@PayStatusID and ReceivedDate between @StartDate and @EndDate) 

set @ReturnedAmount = isnull(@ReturnedAmount, 0)

set @TotalAmount = (@PurchaseOrderPayAmount + @ServiceInvoicePayAmount)-@ReturnedAmount


return @TotalAmount
end

go

/*-------------------------------------------------------------------------------------------------------------------------
 print dbo.FormatMoney(dbo.GetPeriodicSupplierNotPaidForAmount('S15001','12NP','Feb 12, 2011', 'Dec 20, 2015'))
 print dbo.FormatMoney(dbo.GetPeriodicSupplierNotPaidForAmount('S15001','12PF','Feb 12, 2011', 'Dec 20, 2015'))

print dbo.FormatMoney(dbo.GetPeriodicSupplierNotPaidForAmount('VEN00027','12PF','Feb 12, 2017', 'Dec 20, 2017'))
print dbo.FormatMoney(dbo.GetPeriodicSupplierNotPaidForAmount('VEN00027','12NP','Feb 12, 2017', 'Dec 20, 2017'))

print dbo.FormatMoney(dbo.GetPeriodicSupplierNotPaidForAmount('S16001','12NP','Feb 12, 2014', 'Dec 20, 2017'))
print dbo.FormatMoney(dbo.GetPeriodicSupplierNotPaidForAmount('S16001','12PF','Feb 12, 2014', 'Dec 20, 2017'))

print dbo.FormatMoney(dbo.GetPeriodicSupplierNotPaidForAmount('S16001','12NP','Jan 12, 2014', 'Dec 20, 2018'))
print dbo.FormatMoney(dbo.GetPeriodicSupplierNotPaidForAmount('S16001','12NP','Feb 11, 2014', 'Dec 20, 2017'))


--------------------------------------------------------------------------------------------------------------------------*/


--------Function Get Supplier Openning Balance ----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetSupplierOpenningBalance')
drop function GetSupplierOpenningBalance
go

create function GetSupplierOpenningBalance(@SupplierNo varchar(20),@PayStatusID varchar(10), @StartDate smalldatetime) returns money
with encryption as

begin

declare @PurchaseOrderPayAmount money
declare @ServiceInvoicePayAmount money
declare @ReturnedAmount money
declare @TotalAmount money
--------------------------------------------------------------------------------------------------------------------------
set @PurchaseOrderPayAmount =(select sum(Amount) As UnpaidAmount from GoodsReceivedNoteDetails
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo = GoodsReceivedNoteDetails.GRNNo
inner join PurchaseOrders on PurchaseOrders.PurchaseOrderNo = GoodsReceivedNote.PurchaseOrderNo
where SupplierNo = @SupplierNo and PayStatusID = @PayStatusID and ReceivedDate < @StartDate)
--------------------------------------------------------------------------------------------------------------------------
set @PurchaseOrderPayAmount = isnull(@PurchaseOrderPayAmount, 0.00)

set @ServiceInvoicePayAmount =(select sum(Amount) As UnpaidAmount from ServiceInvoiceDetails
inner join ServiceInvoices on ServiceInvoices.ServiceInvoiceNo = ServiceInvoiceDetails.ServiceInvoiceNo
where SupplierNo =@SupplierNo and PayStatusID =@PayStatusID and InvoiceDate < @StartDate)

set @ServiceInvoicePayAmount = isnull(@ServiceInvoicePayAmount, 0.00)

set @ReturnedAmount = (select sum(ReturnQuantity*Rate) 
from GoodsReturnedNoteDetails 
inner join GoodsReturnedNote on GoodsReturnedNote.ReturnNo=GoodsReturnedNoteDetails.ReturnNo
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo=GoodsReturnedNote.GRNNo
inner join  GoodsReceivedNoteDetails on GoodsReceivedNoteDetails.GRNNo=GoodsReturnedNote.GRNNo 
and GoodsReceivedNoteDetails.ItemCategoryID = GoodsReturnedNoteDetails.ItemCategoryID 
and GoodsReceivedNoteDetails.ItemCode = GoodsReturnedNoteDetails.ItemCode
inner join PurchaseOrders on PurchaseOrders.PurchaseOrderNo=GoodsReceivedNote.PurchaseOrderNo
inner join Suppliers on Suppliers.SupplierNo=PurchaseOrders.SupplierNo
where Suppliers.SupplierNo = @SupplierNo and PayStatusID=@PayStatusID and ReceivedDate <  @StartDate) 

set @ReturnedAmount = isnull(@ReturnedAmount, 0)

set @TotalAmount = (@PurchaseOrderPayAmount + @ServiceInvoicePayAmount)-@ReturnedAmount
return @TotalAmount
end

go

/*-------------------------------------------------------------------------------------------------------------------------
 print dbo.FormatMoney(dbo.GetSupplierOpenningBalance('S15001','12NP','Feb 12, 2011'))
 print dbo.FormatMoney(dbo.GetSupplierOpenningBalance('S15001','12PF','Feb 12, 2011'))

print dbo.FormatMoney(dbo.GetSupplierOpenningBalance('VEN00027','12PF','Feb 12, 2017'))
print dbo.FormatMoney(dbo.GetSupplierOpenningBalance('VEN00027','12NP','Feb 12, 2017'))

print dbo.FormatMoney(dbo.GetSupplierOpenningBalance('S16001','12NP','Feb 12, 2014'))
print dbo.FormatMoney(dbo.GetSupplierOpenningBalance('S16001','12PF','Feb 12, 2014'))

print dbo.FormatMoney(dbo.GetSupplierOpenningBalance('S16001','12NP','Jan 31, 2017'))
print dbo.FormatMoney(dbo.GetSupplierOpenningBalance('S16001','12PF','Dec 31, 2017'))


--------------------------------------------------------------------------------------------------------------------------*/




--------Function GetTotalPeriodicSupplierNotPaidForAmount ----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalPeriodicSupplierNotPaidForAmount')
drop function GetTotalPeriodicSupplierNotPaidForAmount
go

create function GetTotalPeriodicSupplierNotPaidForAmount(@PayStatusID varchar(10), @StartDate smalldatetime, @EndDate as smalldatetime) returns money
with encryption as

begin

declare @PurchaseOrderPayAmount money
declare @ServiceInvoicePayAmount money
declare @ReturnedAmount money
declare @TotalAmount money

--------------------------------------------------------------------------------------------------------------------------
set @PurchaseOrderPayAmount = (select sum(Amount) As UnpaidAmount from GoodsReceivedNoteDetails
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo = GoodsReceivedNoteDetails.GRNNo
inner join PurchaseOrders on PurchaseOrders.PurchaseOrderNo = GoodsReceivedNote.PurchaseOrderNo
where PayStatusID =@PayStatusID and ReceivedDate between @StartDate and @EndDate)
set @PurchaseOrderPayAmount = isnull(@PurchaseOrderPayAmount, 0.00)

set @ServiceInvoicePayAmount =(select sum(Amount) As UnpaidAmount from ServiceInvoiceDetails
inner join ServiceInvoices on ServiceInvoices.ServiceInvoiceNo = ServiceInvoiceDetails.ServiceInvoiceNo
where PayStatusID = @PayStatusID and InvoiceDate between @StartDate and @EndDate)

set @ServiceInvoicePayAmount = isnull(@ServiceInvoicePayAmount, 0.00)
--------------------------------------------------------------------------------------------------------------------------
set @ReturnedAmount = (select sum(ReturnQuantity*Rate) 
from GoodsReturnedNoteDetails 
inner join GoodsReturnedNote on GoodsReturnedNote.ReturnNo=GoodsReturnedNoteDetails.ReturnNo
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo=GoodsReturnedNote.GRNNo
inner join  GoodsReceivedNoteDetails on GoodsReceivedNoteDetails.GRNNo=GoodsReturnedNote.GRNNo 
and GoodsReceivedNoteDetails.ItemCategoryID = GoodsReturnedNoteDetails.ItemCategoryID 
and GoodsReceivedNoteDetails.ItemCode = GoodsReturnedNoteDetails.ItemCode
inner join PurchaseOrders on PurchaseOrders.PurchaseOrderNo=GoodsReceivedNote.PurchaseOrderNo
inner join Suppliers on Suppliers.SupplierNo=PurchaseOrders.SupplierNo
where PayStatusID=@PayStatusID and ReceivedDate between @StartDate and @EndDate) 

set @ReturnedAmount = isnull(@ReturnedAmount, 0)

set @TotalAmount = (@PurchaseOrderPayAmount + @ServiceInvoicePayAmount)-@ReturnedAmount


return @TotalAmount
end

go

/*-------------------------------------------------------------------------------------------------------------------------
 print dbo.FormatMoney(dbo.GetTotalPeriodicSupplierNotPaidForAmount('12NP','Feb 12, 2011', 'Dec 20, 2015'))
 print dbo.FormatMoney(dbo.GetTotalPeriodicSupplierNotPaidForAmount('12PF','Feb 12, 2011', 'Dec 20, 2015'))

print dbo.FormatMoney(dbo.GetTotalPeriodicSupplierNotPaidForAmount('12PF','Feb 12, 2017', 'Dec 20, 2017'))
print dbo.FormatMoney(dbo.GetTotalPeriodicSupplierNotPaidForAmount('12NP','Feb 12, 2017', 'Dec 20, 2017'))

print dbo.FormatMoney(dbo.GetTotalPeriodicSupplierNotPaidForAmount('12NP','Feb 12, 2014', 'Dec 20, 2017'))
print dbo.FormatMoney(dbo.GetTotalPeriodicSupplierNotPaidForAmount('12PF','Feb 12, 2014', 'Dec 20, 2017'))

print dbo.FormatMoney(dbo.GetTotalPeriodicSupplierNotPaidForAmount('12NP','Jan 12, 2014', 'Dec 20, 2018'))
print dbo.FormatMoney(dbo.GetTotalPeriodicSupplierNotPaidForAmount('12NP','Feb 11, 2014', 'Dec 20, 2017'))

--------------------------------------------------------------------------------------------------------------------------*/


if exists (select * from sysobjects where name = 'GetTotalSupplierOpenningBalance')
drop function GetTotalSupplierOpenningBalance
go

create function GetTotalSupplierOpenningBalance(@PayStatusID varchar(10), @StartDate smalldatetime) returns money
with encryption as

begin

declare @PurchaseOrderPayAmount money
declare @ServiceInvoicePayAmount money
declare @ReturnedAmount money
declare @TotalAmount money
--------------------------------------------------------------------------------------------------------------------------
set @PurchaseOrderPayAmount =(select sum(Amount) As UnpaidAmount from GoodsReceivedNoteDetails
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo = GoodsReceivedNoteDetails.GRNNo
inner join PurchaseOrders on PurchaseOrders.PurchaseOrderNo = GoodsReceivedNote.PurchaseOrderNo
where PayStatusID = @PayStatusID and ReceivedDate < @StartDate)
--------------------------------------------------------------------------------------------------------------------------
set @PurchaseOrderPayAmount = isnull(@PurchaseOrderPayAmount, 0.00)

set @ServiceInvoicePayAmount =(select sum(Amount) As UnpaidAmount from ServiceInvoiceDetails
inner join ServiceInvoices on ServiceInvoices.ServiceInvoiceNo = ServiceInvoiceDetails.ServiceInvoiceNo
where PayStatusID =@PayStatusID and InvoiceDate < @StartDate)

set @ServiceInvoicePayAmount = isnull(@ServiceInvoicePayAmount, 0.00)

set @ReturnedAmount = (select sum(ReturnQuantity*Rate) 
from GoodsReturnedNoteDetails 
inner join GoodsReturnedNote on GoodsReturnedNote.ReturnNo=GoodsReturnedNoteDetails.ReturnNo
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo=GoodsReturnedNote.GRNNo
inner join  GoodsReceivedNoteDetails on GoodsReceivedNoteDetails.GRNNo=GoodsReturnedNote.GRNNo 
and GoodsReceivedNoteDetails.ItemCategoryID = GoodsReturnedNoteDetails.ItemCategoryID 
and GoodsReceivedNoteDetails.ItemCode = GoodsReturnedNoteDetails.ItemCode
inner join PurchaseOrders on PurchaseOrders.PurchaseOrderNo=GoodsReceivedNote.PurchaseOrderNo
inner join Suppliers on Suppliers.SupplierNo=PurchaseOrders.SupplierNo
where PayStatusID=@PayStatusID and ReceivedDate <  @StartDate) 

set @ReturnedAmount = isnull(@ReturnedAmount, 0)

set @TotalAmount = (@PurchaseOrderPayAmount + @ServiceInvoicePayAmount)-@ReturnedAmount
return @TotalAmount
end

go

/*-------------------------------------------------------------------------------------------------------------------------
 print dbo.FormatMoney(dbo.GetTotalSupplierOpenningBalance('12NP','Feb 12, 2011'))
 print dbo.FormatMoney(dbo.GetTotalSupplierOpenningBalance('S15001','12PF','Feb 12, 2011'))

print dbo.FormatMoney(dbo.GetTotalSupplierOpenningBalance('12PF','Feb 12, 2017'))
print dbo.FormatMoney(dbo.GetTotalSupplierOpenningBalance('12NP','Feb 12, 2017'))

print dbo.FormatMoney(dbo.GetTotalSupplierOpenningBalance('12NP','Feb 12, 2014'))
print dbo.FormatMoney(dbo.GetTotalSupplierOpenningBalance('12PF','Feb 12, 2014'))

print dbo.FormatMoney(dbo.GetTotalSupplierOpenningBalance('12NP','Jan 31, 2017'))
print dbo.FormatMoney(dbo.GetTotalSupplierOpenningBalance('12PF','Dec 31, 2017'))


--------------------------------------------------------------------------------------------------------------------------*/

--------Function GetPrescriptionItemBalance-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPrescriptionItemBalance')
drop function GetPrescriptionItemBalance
go

create function GetPrescriptionItemBalance(@VisitNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as
begin

declare @Balance int
--------------------------

if (exists(select Quantity from items where	VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID and	ItemCode = @ItemCode)and 
exists(select DrQuantity from itemsEXT where VisitNo = @VisitNo and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode))
  
begin
set @Balance =(select DrQuantity from itemsExt where VisitNo = @VisitNo 
and	ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode) - 
(select Quantity from items where VisitNo = @VisitNo 
and	ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
)	
			 
end
else
begin 
		
set @Balance = isnull(@Balance, 0)
end
return @balance
	
end
go


----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetPrescriptionItemBalance('16005768001','7D','M114')
-- print dbo.GetPrescriptionItemBalance('160001','7D','ME059') ME059




--------Function GetIsPurchaseOrderReceived-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIsPurchaseOrderReceived')
drop function GetIsPurchaseOrderReceived
go

create function GetIsPurchaseOrderReceived(@PurchaseOrderNo varchar(20)) returns bit
with encryption as

begin

declare @IsPurchaseOrderReceived bit

if exists (select PurchaseOrderNo from GoodsReceivedNote where PurchaseOrderNo = @PurchaseOrderNo)
set @IsPurchaseOrderReceived = 1
else set @IsPurchaseOrderReceived = 0

return @IsPurchaseOrderReceived

end
go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetIsPurchaseOrderReceived('0001')
-- print dbo.GetIsPurchaseOrderReceived('0002')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetGoodsReceivedNoteTotalAmount ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetGoodsReceivedNoteTotalAmount')
drop function GetGoodsReceivedNoteTotalAmount
go

create function GetGoodsReceivedNoteTotalAmount(@GRNNo varchar(20)) returns money
with encryption as

begin

declare @TotalAmount money

--------------------------------------------------------------------------------------------
set @TotalAmount = (select sum(Amount) from GoodsReceivedNoteDetails where GRNNo = @GRNNo) 
--------------------------------------------------------------------------------------------

set @TotalAmount = isnull(@TotalAmount, 0.00)

return @TotalAmount

end
go

--------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetGoodsReceivedNoteTotalAmount('0067'))
--------------------------------------------------------------------------------------------------------------------------

--------Function GetGoodsReceivedNoteNetAmount ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetGoodsReceivedNoteNetAmount')
drop function GetGoodsReceivedNoteNetAmount
go

create function GetGoodsReceivedNoteNetAmount(@GRNNo varchar(20)) returns money
with encryption as

begin

declare @TotalAmount money
declare @DiscountTotal money
declare @VATValue money
declare @NetAmount money

set @TotalAmount = dbo.GetGoodsReceivedNoteTotalAmount(@GRNNo)
---------------------------------------------------------------------------------------
set @DiscountTotal = (select DiscountTotal from GoodsReceivedNote where GRNNo = @GRNNo)
set @VATValue = (select TotalVAT from GoodsReceivedNote where GRNNo = @GRNNo)

set @NetAmount = @TotalAmount - @DiscountTotal + @VATValue
---------------------------------------------------------------------------------------

set @NetAmount = isnull(@NetAmount, 0.00)

return @NetAmount

end

go

--------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetGoodsReceivedNoteNetAmount('0067'))
--------------------------------------------------------------------------------------------------------------------------

--------Function GetPaymentsPayNo ----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPaymentsPayNo')
drop function GetPaymentsPayNo
go

create function GetPaymentsPayNo(@ReceiptNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @PayNo varchar(20)

set @PayNo = (select PayNo from Payments Where ReceiptNo = @ReceiptNo)
set @PayNo = isnull(@PayNo, '')

return @PayNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetPaymentsPayNo('11000001')

----------------------------------------------------------------------------------------------------------------------------

--------Function GetClaimAmount --------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetClaimAmount')
drop function GetClaimAmount
go

create function GetClaimAmount(@ClaimNo varchar(20)) returns money
with encryption as

begin

declare @ClaimAmount money

set @ClaimAmount = (select Sum(Amount) from ClaimDetails Where ClaimNo = @ClaimNo)
set @ClaimAmount = isnull(@ClaimAmount, 0.00)

return @ClaimAmount

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetClaimAmount('00034'))
----------------------------------------------------------------------------------------------------------------------------



--------Function Get Comma Separated Diseases ----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCommaSeparatedDiseases')
	drop function GetCommaSeparatedDiseases
go

create function GetCommaSeparatedDiseases(@VisitNo varchar(20)) returns varchar(400)
with encryption as

begin

declare @DiseaseNames varchar(400)

set @DiseaseNames = (select top 1 stuff((select ', ' + DiseaseName FROM Diagnosis
                                           inner join diseases on Diagnosis.diseaseCode = diseases.diseaseCode
                                           where VisitNo = @VisitNo 
                                           group by DiseaseName  for xml path('')
                                           )
                                            , 1, 2, ''
                                        ) as DiseaseName from diagnosis where VisitNo = @VisitNo
                        )

return @DiseaseNames
end

go
--------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetCommaSeparatedDiseases('0000065001')
--------------------------------------------------------------------------------------------------------------------------------

--------Function GetExtraBillAmount ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetExtraBillAmount')
drop function GetExtraBillAmount
go

create function GetExtraBillAmount(@ExtraBillNo varchar(20)) returns money
with encryption as

begin

declare @ExtraBillAmount money

set @ExtraBillAmount = (select Sum(Quantity * UnitPrice) from ExtraBillItems Where ExtraBillNo = @ExtraBillNo)
set @ExtraBillAmount = isnull(@ExtraBillAmount, 0.00)

return @ExtraBillAmount

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetExtraBillAmount('00034'))
----------------------------------------------------------------------------------------------------------------------------

--------Function GetConsumptionUnitPrice ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetConsumptionUnitPrice')
drop function GetConsumptionUnitPrice
go

create function GetConsumptionUnitPrice(@VisitNo varchar(20),@ItemCode varchar(20), @ItemCategoryID varchar(10)) returns money
with encryption as

begin

declare @GetConsumptionUnitPrice money

set @GetConsumptionUnitPrice = (select  UnitPrice from Items Where VisitNo = @VisitNo and ItemCode =@ItemCode and ItemCategoryID =@ItemCategoryID)
set @GetConsumptionUnitPrice = isnull(@GetConsumptionUnitPrice, 0.00)

return @GetConsumptionUnitPrice

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetGetConsumptionUnitPrice('00034'))
----------------------------------------------------------------------------------------------------------------------------



------------ PackageCheck  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'PackageCheck')
	drop view PackageCheck
go

create view PackageCheck
with encryption 
as 
select  PatientNo,AttachPackage.VisitNo,AttachPackage.PackageVisitNo,Items.UnitPrice, Packages.PackageNo,PackageName,AttachPackage.RecordDateTime,
PackageEndDate as ExpireOn,
DATEDIFF(day,PackageStartDate,(PackageEndDate)) as RemainingDays
from Packages
inner join AttachPackage on AttachPackage.PackageNo = Packages.PackageNo
inner join Items on Items.VisitNo = AttachPackage.VisitNo and Items.ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'G')
go


-- select * from PackageCheck
----------------------------------------------------------------------------------------------------------------------------

--------Function GetHasPackage------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasPackage')
drop function GetHasPackage
go

create function GetHasPackage(@PatientNo varchar(20),@PackageNo varchar(20)) returns bit
with encryption as
begin

declare @HasActivePackage bit



if exists (select Top 1 PatientNo from AttachPackage where PatientNo =@PatientNo and PackageNo =@PackageNo and DATEDIFF(day,PackageStartDate,(PackageEndDate)) >0)
set @HasActivePackage = 1
else set @HasActivePackage = 0

return @HasActivePackage

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetHasPackage('VCX','') as varchar)
----------------------------------------------------------------------------------------------------------------------------


--------Function GetHasPaidPackage------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasPaidPackage')
drop function GetHasPaidPackage
go

create function GetHasPaidPackage(@VisitNo varchar(20),@PackageNo varchar(20)) returns bit
with encryption as
begin

declare @PackageCategoryID varchar(10)
declare @HasPaidActivePackage bit
set @PackageCategoryID = dbo.GetLookupDataID('ItemCategory', 'G')


if exists(select ReceiptNo from PaymentDetails where VisitNo = (select Top 1 VisitNo  from PackageCheck where PatientNo=dbo.GetPatientNo(@VisitNo)
and PackageNo = @PackageNo and RemainingDays  >= 1 ) 
and ItemCode = @PackageNo and ItemCategoryID =@PackageCategoryID)

set @HasPaidActivePackage = 1
else set @HasPaidActivePackage = 0

return @HasPaidActivePackage

end

go


----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetHasPaidPackage('170121008','100Q') as varchar)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetHasServiceFee------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasServiceFee')
drop function GetHasServiceFee
go

create function GetHasServiceFee(@VisitNo varchar(20)) returns bit
with encryption as
begin

declare @ItemCode varchar(20)
declare @ItemCategoryID varchar(10)
declare @HasActivePackage bit

set @ItemCode ='SF'
set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'S')

if exists (select Top 1 ItemCode  from Items where VisitNo=@VisitNo and ItemCode =@ItemCode and ItemCategoryID=@ItemCategoryID)

set @HasActivePackage = 1
else set @HasActivePackage = 0

return @HasActivePackage

end

go

----------------------------------------------------------------------------------------------------------------------------

---------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------- MainMemberTotalConsumption  --------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'MainMemberTotalConsumption')
	drop view MainMemberTotalConsumption
go

create view MainMemberTotalConsumption
with encryption 
as 
	select MemberTypeID, dbo.GetLookupDataDes(MemberTypeID) as MemberType, 
	MainMemberNo, dbo.GetSchemeMemberName(MainMemberNo) as MainMemberName,
	MedicalCardNo, SchemeMembers.CompanyNo, CompanyName,
	SchemeMembers.PolicyNo, PolicyName, InsurancePolicies.InsuranceNo, InsuranceName, 
	SchemeStartDate, SchemeEndDate, ReferenceNo, Surname, FirstName, MiddleName, 
	dbo.GetFullName(Surname, MiddleName, FirstName) as FullName,  
	dbo.GetLookupDataDes(GenderID) as Gender, 
	PolicyStartDate, PolicyEndDate, MemberStatusID, dbo.GetLookupDataDes(MemberStatusID) as MemberStatus,
	 dbo.GetLookupDataDes(SchemeStatusID) as SchemeStatus,
	dbo.GetMergedNameCode(dbo.GetFullName(Surname, MiddleName, FirstName),MedicalCardNo) as MemberFullName,
	AnnualPremium,dbo.GetMemberPremiumUsageBalance(MedicalCardNo) as Balance,(AnnualPremium -dbo.GetMemberPremiumUsageBalance(MedicalCardNo)) as UsedAmount
	from SchemeMembers	
	inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
	and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
	inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
	inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
	inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
	Where MemberTypeID = dbo.GetLookupDataID('MemberType', '01')
go

----- select * from MainMemberTotalConsumption

--------Function GetIsPackageLimited----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIsPackageLimited')
drop function GetIsPackageLimited
go

create function GetIsPackageLimited(@PackageNo varchar(20)) returns int
with encryption as

begin

declare @Limit int

set @Limit = (select MonitorQty from Packages where PackageNo =@PackageNo)

set @Limit = isnull(@Limit, 0)

return @Limit

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetIsPackageLimited('A002')
----------------------------------------------------------------------------------------------------------------------------

--------IsPackageItem-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspIsPackageItem')
drop proc uspIsPackageItem
go

create proc uspIsPackageItem(
@PackageNo varchar(20),
@ItemCode varchar(20),
@ItemCategoryID varchar(10),
@Records tinyint = null output
)with encryption as

set @Records = (select count(ItemCode) from PackagesEXT Where PackageNo =@PackageNo and ItemCode =@ItemCode and ItemCategoryID =@ItemCategoryID)
set @Records = isnull(@Records, 0)

return 0
go


--------IsPackageItem-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'usphasPackage')
drop proc usphasPackage
go

create proc usphasPackage(
@PatientNo varchar(20),
@PackageNo varchar(20),
@Records tinyint = null output
)with encryption as

set @Records = (select count(PatientNo) from AttachPackage Where PackageNo =@PackageNo and PatientNo =@PatientNo and 
DATEDIFF(day,PackageStartDate,(PackageEndDate)) >0)
set @Records = isnull(@Records, 0)

return 0
go

--------Function GetCurrentPackage----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCurrentPackage')
drop function GetCurrentPackage
go

create function GetCurrentPackage(@PackageNo varchar(20)) returns varchar(40)
with encryption as

begin

declare @CurrentPackage varchar(40)

begin
set @CurrentPackage = (select PackageName from Packages where PackageNo = @PackageNo)
set @CurrentPackage = isnull(@CurrentPackage, '')
end

return @CurrentPackage

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetCurrentPackage('A001')
-- print dbo.GetCurrentPackage(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetHasActivePackage------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasActivePackage')
drop function GetHasActivePackage
go

create function GetHasActivePackage(@PatientNo varchar(20),@PackageNo varchar(20)) returns varchar(10)
with encryption as
begin

declare @HasActivePackage varchar(10)
declare @ActiveStatusID varchar(10)
declare @InactiveStatusID varchar(10)

set @ActiveStatusID = dbo.GetLookupDataID('Status', 'A')
set @InactiveStatusID = dbo.GetLookupDataID('Status', 'I')

if exists (select Top 1 PatientNo from PackageCheck where PatientNo =@PatientNo and PackageNo =@PackageNo and RemainingDays>0 )
set @HasActivePackage = @ActiveStatusID
else set @HasActivePackage = @InactiveStatusID

return @HasActivePackage

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetHasActivePackage('VCX','') as varchar)
-- select RemainingDays from PackageCheck
----------------------------------------------------------------------------------------------------------------------------

--------Function GetPackageRemainingQuantities---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPackageRemainingQuantities')
drop function GetPackageRemainingQuantities
go

create function GetPackageRemainingQuantities(@PackageVisitNo varchar(20)= null,@PackageNo varchar(20),@ItemCode varchar(20),@ItemCategoryID varchar(10)) returns int
with encryption as

begin

declare @TotalConsumed int
declare @IPDTotalConsumed int
declare @PackageQuantity int
declare @RemainingQuantity int
declare @Offered varchar(10)
declare @done varchar(10)
declare @IPDOPDConsumed int
set @Offered = dbo.GetLookupDataID('ItemStatus', 'O')
set @done = dbo.GetLookupDataID('ItemStatus', 'D')
begin
---------------------------------------------------------------------------------------------------------------------------------------------------------------

--Gets total so far consumed on the package by a patient OPD

set @TotalConsumed = (select sum (Quantity) as TotalConsumed from PackageConsumption
where PackageConsumption.PackageVisitNo =@PackageVisitNo and ItemCode =@ItemCode and PackageNo =@PackageNo
and ItemCategoryID =@ItemCategoryID and ItemStatusID In(@Offered,@done))


--Gets total so far consumed on the package by a patient IPD
---------------------------------------------------------------------------------------------------------------------------------------------------------------

set @IPDTotalConsumed = (select sum (Quantity) as TotalConsumed from IPDPackageConsumption
where IPDPackageConsumption.PackageVisitNo =@PackageVisitNo and ItemCode =@ItemCode
and ItemCategoryID =@ItemCategoryID and PackageNo =@PackageNo and ItemStatusID In(@Offered,@done))
---------------------------------------------------------------------------------------------------------------------------------------------------------------
set @PackageQuantity= (select Quantity from PackagesEXT where PackageNo =@PackageNo and ItemCategoryID =@ItemCategoryID and ItemCode =@ItemCode)

---------------------------------------------------------------------------------------------------------------------------------------------------------------
set @TotalConsumed= isnull(@TotalConsumed,0)
set @IPDTotalConsumed=isnull(@IPDTotalConsumed,0)

set @IPDOPDConsumed = (@TotalConsumed+@IPDTotalConsumed)

set @PackageQuantity= (@PackageQuantity)

set @RemainingQuantity = isnull((@PackageQuantity - @IPDOPDConsumed),0)
---------------------------------------------------------------------------------------------------------------------------------------------------------------

end

return  @RemainingQuantity

end
go


--print dbo.GetPackageRemainingQuantities ('18001','ANC FULL','10C','7s')

-------------------------------------------------------------------------------------------------------------------------------

-------------------------------------------------------------------------------------------------------------------------------

--------Function GetPatientLatestPackageVisitNo---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPatientLatestPackageVisitNo')
drop function GetPatientLatestPackageVisitNo
go

create function GetPatientLatestPackageVisitNo(@PatientNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @VisitNo varchar(20)

begin
set @VisitNo = (select Top 1 VisitNo from Visits 
		where PatientNo = @PatientNo and len(PackageNo) > 0 order by RecordDateTime desc)
set @VisitNo = isnull(@VisitNo, '')
end

return @VisitNo

end

go

-- print dbo.GetPatientLatestPackageVisitNo('SR170151')

--------Function GetVisitPackageStatus------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetVisitPackageStatus')
drop function GetVisitPackageStatus
go

create function GetVisitPackageStatus(@PatientNo varchar(20),@PackageNo varchar(20)) returns bit

with encryption as
begin

declare @VisitPackageStatus bit

declare @servicecode varchar(20)
declare @ReceiptNo varchar(20)
declare @ItemCode varchar(20)

set @ReceiptNo = (select Top 1 VisitNo  from PackageCheck where PatientNo=@PatientNo
and PackageNo = @PackageNo and RemainingDays  >= 1)

set @servicecode =  dbo.GetLookupDataID('ItemCategory', 'S')

set @ItemCode = (select Top 1 ItemCode  from PackageConsumption where VisitNo = dbo.GetPatientLatestPackageVisitNo(@PatientNo)
and PackageNo = @PackageNo and ItemCategoryID = @servicecode)


if exists (select top 1  AttachPackage.PatientNo as Remainingqty from PackagesEXT 
INNER JOIN AttachPackage on PackagesEXT.PackageNo =AttachPackage.PackageNo and PackagesEXT.ItemCode =PackagesEXT.ItemCode and PackagesEXT.ItemCategoryID =PackagesEXT.ItemCategoryID
inner join PackageCheck on AttachPackage.PatientNo =PackageCheck.PatientNo and AttachPackage.PackageNo =PackageCheck.PackageNo
where AttachPackage.PatientNo =@PatientNo and AttachPackage.PackageNo =@PackageNo and  RemainingDays  > 0
and (dbo.GetPackageRemainingQuantities(@ReceiptNo,@PackageNo,@ItemCode,@servicecode)) > 0)

set @VisitPackageStatus = 1

else set @VisitPackageStatus = 0

return @VisitPackageStatus

end

go
----------------------------------------------------------------------------------------------------------------------------

----print dbo.GetVisitPackageStatus ('SR170151','100Q')

--------Function GetExtraBillVisitNo-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetExtraBillVisitNo')
drop function GetExtraBillVisitNo
go

create function GetExtraBillVisitNo(@ExtraBillNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @VisitNo varchar(100)

set @VisitNo = (select top 1 VisitNo from ExtraBillItems
inner join ExtraBills on ExtraBills.ExtraBillNo = ExtraBillItems.ExtraBillNo where ExtraBillItems.ExtraBillNo =@ExtraBillNo)
set @VisitNo = isnull(@VisitNo, '')

return @VisitNo

end
go
----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetExtraBillVisitNo('170114003')
-- print dbo.GetExtraBillVisitNo('1210883003')

----------------------------------------------------------------------------------------------------------------------------


--------Function GetAdmissionDays------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAdmissionDays')
drop function GetAdmissionDays
go

create function GetAdmissionDays(@StartDate smalldatetime, @EndDate as smalldatetime) 
returns int
with encryption as
begin

declare @AdmissionDays int

begin
set @AdmissionDays = datediff(day, dbo.FormatDate(@StartDate), dbo.FormatDate(@EndDate))
if @AdmissionDays = 0 set @AdmissionDays = 1
end

return @AdmissionDays

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetAdmissionDays('15 May 2010', '10 may 2010')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetDischargeDateTime-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDischargeDateTime')
drop function GetDischargeDateTime
go

create function GetDischargeDateTime(@AdmissionNo varchar(20)) returns smalldatetime
with encryption as

begin

declare @DischargeDateTime smalldatetime
set @DischargeDateTime = (select DischargeDateTime from Discharges where AdmissionNo = @AdmissionNo)
return @DischargeDateTime

end
go

-- print dbo.GetDischargeDateTime('150024101')
-- select * from Discharges

--------Function GetSupplierName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetSupplierName')
drop function GetSupplierName
go

create function GetSupplierName(@SupplierNo varchar(20)) returns varchar(60)
with encryption as

begin

declare @SupplierName varchar(60)

begin
set @SupplierName = (select SupplierName from Suppliers where SupplierNo = @SupplierNo)
set @SupplierName = isnull(@SupplierName, '')
end

return @SupplierName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetSupplierName('S15002')
-- print dbo.GetSupplierName(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetSupplierFullName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetSupplierFullName')
drop function GetSupplierFullName
go

create function GetSupplierFullName(@SupplierNo varchar(20)) returns varchar(74)
with encryption as

begin

declare @SupplierName varchar(60)
declare @SupplierFullName varchar(74)

begin

set @SupplierName = (select SupplierName from Suppliers where SupplierNo = @SupplierNo)
set @SupplierFullName = dbo.GetMergedNameCode(@SupplierName, @SupplierNo)
		
set @SupplierFullName = isnull(@SupplierFullName, '')
end

return @SupplierFullName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetSupplierFullName('S15002')
-- print dbo.GetSupplierFullName(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetBillCustomerName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetBillCustomerName')
drop function GetBillCustomerName
go

create function GetBillCustomerName(@AccountNo varchar(20)) returns varchar(40)
with encryption as

begin

declare @BillCustomerName varchar(40)

begin
set @BillCustomerName = (select BillCustomerName from BillCustomers where AccountNo = @AccountNo)
set @BillCustomerName = isnull(@BillCustomerName, '')
end

return @BillCustomerName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetBillCustomerName('STAFF')
-- print dbo.GetBillCustomerName(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function Get Account Opening Balance----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAccountOpeningBalance')
drop function GetAccountOpeningBalance
go

create function GetAccountOpeningBalance(@AccountBillNo varchar(20),@AccountBillModesID varchar(10),@RecordDateTime smalldatetime) returns money
with encryption as

begin

declare @Balance money
set @Balance=( select top 1 Balance from Accounts where
AccountID = (select Max(AccountID) from Accounts 
where  AccountBillNo =@AccountBillNo and AccountBillModesID=@AccountBillModesID and dbo.FormatDate(RecordDateTime) < =dbo.FormatDate(@RecordDateTime))
ORDER BY TranDate DESC)

set @Balance = isnull(@Balance, 0.00)

return @Balance

end

go
---------------------------------------------------------------------------------------------------------------------------

--------Function GetPatientAccountBalance----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPatientAccountBalance')
drop function GetPatientAccountBalance
go

create function GetPatientAccountBalance(@AccountBillNo varchar(20)) returns money
with encryption as

begin

declare @Balance money

set @Balance = (select TOP 1 Balance from Accounts Where AccountBillNo = @AccountBillNo ORDER BY RecordDateTime desc)

set @Balance = isnull(@Balance, 0.00)

return @Balance

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetPatientAccountBalance('16005801'))
----------------------------------------------------------------------------------------------------------------------------


--------Function GetBillCustomerFullName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetBillCustomerFullName')
drop function GetBillCustomerFullName
go

create function GetBillCustomerFullName(@AccountNo varchar(20)) returns varchar(60)
with encryption as

begin

declare @BillCustomerName varchar(40)
declare @BillCustomerFullName varchar(60)

begin

set @BillCustomerName = (select BillCustomerName from BillCustomers where AccountNo = @AccountNo)
set @BillCustomerFullName = dbo.GetMergedNameCode(@BillCustomerName, @AccountNo)
		
set @BillCustomerFullName = isnull(@BillCustomerFullName, '')
end

return @BillCustomerFullName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetBillCustomerFullName('STAFF')
-- print dbo.GetBillCustomerFullName(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetBillInsuranceName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetBillInsuranceName')
drop function GetBillInsuranceName
go

create function GetBillInsuranceName(@AccountNo varchar(20)) returns varchar(60)
with encryption as

begin

declare @BillInsuranceName varchar(60)

begin
set @BillInsuranceName = (select BillCustomers.BillCustomerName from BillCustomers
inner join BillCustomers Insurances on Insurances.InsuranceNo = BillCustomers.AccountNo
where Insurances.AccountNo = @AccountNo)

set @BillInsuranceName = isnull(@BillInsuranceName, '')
end

return @BillInsuranceName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetBillInsuranceName('100105A')
-- print dbo.GetBillInsuranceName(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetBillInsuranceNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetBillInsuranceNo')
drop function GetBillInsuranceNo
go

create function GetBillInsuranceNo(@AccountNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @BillInsuranceNo varchar(20)

begin
set @BillInsuranceNo = (select InsuranceNo from BillCustomers where AccountNo = @AccountNo)
set @BillInsuranceNo = isnull(@BillInsuranceNo, '')
end

return @BillInsuranceNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetBillInsuranceNo('100105A')
-- print dbo.GetBillInsuranceNo(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetBillName------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetBillName')
drop function GetBillName
go

create function GetBillName(@BillModesID varchar(10), @BillNo varchar(20)) returns varchar(60)
with encryption as

begin

declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

declare @BillName varchar(60)

----------------------------------------------------------------------------
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
----------------------------------------------------------------------------

begin

if (@BillModesID = @InsuranceBillModesID)
begin
set @BillName = (select CompanyName from SchemeMembers	
			inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
			and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
			inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
			where MedicalCardNo = @BillNo)
end
else set @BillName = (select BillCustomerName from BillCustomers where AccountNo = @BillNo)
set @BillName = isnull(@BillName, '')
end

return @BillName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetBillName('17C', 'CASH')
-- print dbo.GetBillName('17A', 'STAFF')
-- print dbo.GetBillName('17I', '123')
-- print dbo.GetBillName('', null)
----------------------------------------------------------------------------------------------------------------------------

--------Function InvoiceCategoryOPDINvoiceNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInvoiceCategoryOPDINvoiceNo')
drop function GetInvoiceCategoryOPDINvoiceNo
go

create function GetInvoiceCategoryOPDINvoiceNo(@VisitNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @invoiceNo varchar(20)

begin
set @invoiceNo = (select TOP 1 InvoiceNo from InvoiceDetails where VisitNo = @VisitNo)
set @invoiceNo = isnull(@invoiceNo, '')
end

return @invoiceNo

end

go
----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInvoiceCategoryOPDINvoiceNo('100105A')
-- print dbo.GetInvoiceCategoryOPDINvoiceNo(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function InvoiceCategoryIPDINvoiceNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInvoiceCategoryIPDINvoiceNo')
drop function GetInvoiceCategoryIPDINvoiceNo
go

create function GetInvoiceCategoryIPDINvoiceNo(@VisitNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @invoiceNo varchar(20)

begin
set @invoiceNo = (select TOP 1 InvoiceExtraBillItems.InvoiceNo from InvoiceExtraBillItems 
inner join Invoices on invoices.InvoiceNo = InvoiceExtraBillItems.InvoiceNo
inner join extrabills on InvoiceExtraBillItems.ExtraBillNo =ExtraBills.ExtraBillNo
where VisitNo = @VisitNo)
set @invoiceNo = isnull(@invoiceNo, '')
end

return @invoiceNo

end

go
----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInvoiceCategoryIPDINvoiceNo('100105A')
-- print dbo.GetInvoiceCategoryIPDINvoiceNo(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function VisitMainMemberName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetVisitMainMemberName')
drop function GetVisitMainMemberName
go

create function GetVisitMainMemberName(@VisitNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @MainMemberName varchar(20)

begin
set @MainMemberName = (select TOP 1 MainMemberName from Visits 
where VisitNo = @VisitNo)
set @MainMemberName = isnull(@MainMemberName, '')
end

return @MainMemberName

end

go
----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetVisitMainMemberName('100105A')
-- print dbo.GetVisitMainMemberName(null)
----------------------------------------------------------------------------------------------------------------------------


--------Function VisitClaimReferenceNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetVisitClaimReferenceNo')
drop function GetVisitClaimReferenceNo
go

create function GetVisitClaimReferenceNo(@VisitNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @ClaimReferenceNo varchar(20)

begin
set @ClaimReferenceNo = (select TOP 1 ClaimReferenceNo from Visits 
where VisitNo = @VisitNo)
set @ClaimReferenceNo = isnull(@ClaimReferenceNo, '')
end

return @ClaimReferenceNo

end

go
----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetVisitClaimReferenceNo('100105A')
-- print dbo.GetVisitClaimReferenceNo(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function PatientFullNameWithReceiptNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPatientFullNameWithReceiptNo')
drop function GetPatientFullNameWithReceiptNo
go

create function GetPatientFullNameWithReceiptNo(@ReceiptNo varchar(20)) returns varchar(100)
with encryption as

begin

declare @PatientFullName varchar(20)

begin
set @PatientFullName = (select TOP 1 dbo.GetFullName(LastName,MiddleName,FirstName) from Payments
inner join Visits on Visits.VisitNo = Payments.payNo
inner join Patients on Patients.patientNo = Visits.PatientNo
where ReceiptNo =@ReceiptNo)
set @PatientFullName = isnull(@PatientFullName, '')
end

return @PatientFullName

end

go
----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetPatientFullNameWithReceiptNo('17032037')
-- print dbo.GetPatientFullNameWithReceiptNo(null)
----------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------
--------------------------------------GetPeriodicTotalPerService------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPeriodicTotalPerService')
drop function GetPeriodicTotalPerService
go

create function GetPeriodicTotalPerService(
@VisitNo varchar(20)=null,
@ItemCategoryID varchar(10)= null,
@ExcludePendingItems bit,
@StartDateTime smalldatetime,
@EndDateTime smalldatetime) returns money
with encryption as

begin
declare @total money


    declare @Offered varchar(10)
    declare @Done varchar(10)
    declare @Pending varchar(10)

	----------------------------------------------------------------------------
	set @Offered = dbo.GetLookupDataID('ItemStatus', 'O')
	set @Done = dbo.GetLookupDataID('ItemStatus', 'D')
	set @Pending = dbo.GetLookupDataID('ItemStatus', 'P')

if @ItemCategoryID is null and @VisitNo is null and @ExcludePendingItems = 0
begin
set @total  = (select sum(Items.Quantity * Items.UnitPrice) as total
               from items
               where (items.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime))
               and (ItemStatusID = @Offered  or ItemStatusID = @Done or ItemStatusID = @pending ))
end

else if   not(@VisitNo is null) and @ItemCategoryID is null and @ExcludePendingItems = 0
begin
set @total  = (select sum(Items.Quantity * Items.UnitPrice) as total
               from items
               where (visitno = @VisitNo and items.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime))
               and (ItemStatusID = @Offered  or ItemStatusID = @Done or ItemStatusID = @pending ))
end

else if @VisitNo is null and not(@ItemCategoryID is null) and @ExcludePendingItems = 0
begin
set @total  = (select sum(Items.Quantity * Items.UnitPrice) as total
               from items
               where (ItemCategoryID = @ItemCategoryID and items.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime))
               and (ItemStatusID = @Offered  or ItemStatusID = @Done or ItemStatusID = @pending ))
end

else if @VisitNo is null and @ItemCategoryID is null and @ExcludePendingItems = 1
begin
set @total  = (select sum(Items.Quantity * Items.UnitPrice) as total
               from items
               where ItemStatusID = @Offered  or ItemStatusID = @Done and items.RecordDateTime between dbo.FormatDate(@StartDateTime) and 
               dbo.FormatDate(@EndDateTime))
end

else if not(@VisitNo is  null) and @ItemCategoryID is null and @ExcludePendingItems = 1

begin
set @total  = (select sum(Items.Quantity * Items.UnitPrice) as total
               from items
              where (visitno = @VisitNo and
              items.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime)) and
              (ItemStatusID = @Offered  or ItemStatusID = @Done))
end

else if @VisitNo is null and not(@ItemCategoryID is null) and @ExcludePendingItems = 1
begin
set @total  = (select sum(Items.Quantity * Items.UnitPrice) as total
               from items
               where (ItemCategoryID = @ItemCategoryID and
               items.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime))and
               (ItemStatusID = @Offered  or ItemStatusID = @Done))
end

else if not(@VisitNo is null) and not(@ItemCategoryID is null) and @ExcludePendingItems = 0
begin
set @total  = (select sum(Items.Quantity * Items.UnitPrice) as total
               from items
               where (ItemCategoryID = @ItemCategoryID and visitno = @VisitNo and 
               items.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime))
               and (ItemStatusID = @Offered  or ItemStatusID = @Done or ItemStatusID = @pending ))
end

else
begin
set @total  = (select sum(Items.Quantity * Items.UnitPrice) as total
               from items
               where (ItemCategoryID = @ItemCategoryID and visitno = @VisitNo and 
               items.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime)) and
               (ItemStatusID = @Offered  or ItemStatusID = @Done))
end

set @total =isnull(@total,0)

return @total

end
go

--print dbo.GetPeriodicTotalPerService('1300001012',NULL,'11o','22 nov 2013','22 nov 2017') as phamacy


--------------------------------------------------------------------------------------------------------------------------------
--------------------------------------GetIPDPeriodicTotalPerService------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'GetIPDPeriodicTotalPerService')
drop function GetIPDPeriodicTotalPerService
go

create function GetIPDPeriodicTotalPerService(
@VisitNo varchar(20)=null,
@ItemCategoryID varchar(10)= null,
@ExcludePaidFor bit,
@StartDateTime smalldatetime,
@EndDateTime smalldatetime) returns money
with encryption as

begin
declare @total money


    declare @PaidFor varchar(10)
    declare @NotPaid varchar(10)
 

	----------------------------------------------------------------------------
	set @PaidFor = dbo.GetLookupDataID('PayStatus', 'PF')
    set @NotPaid = dbo.GetLookupDataID('PayStatus', 'NP')

if @ItemCategoryID is null and @VisitNo is null and @ExcludePaidFor = 0
begin
set @total  = (select sum(ExtraBillItems.Quantity * ExtraBillItems.UnitPrice) as total
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
                where 
               ExtraBillItems.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime))
end

else if   not(@VisitNo is null) and @ItemCategoryID is null and @ExcludePaidFor = 0
begin
set @total  = (select sum(ExtraBillItems.Quantity * ExtraBillItems.UnitPrice) as total
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
                where 
               ExtraBills.visitno = @VisitNo and
               ExtraBillItems.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime))
end

else if @VisitNo is null and not(@ItemCategoryID is null) and @ExcludePaidFor = 0
begin
set @total  = (select sum(ExtraBillItems.Quantity * ExtraBillItems.UnitPrice) as total
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
                where 
                ItemCategoryID = @ItemCategoryID and
               ExtraBillItems.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime))
end

else if @VisitNo is null and @ItemCategoryID is null and @ExcludePaidFor = 1
begin
set @total  = (select sum(ExtraBillItems.Quantity * ExtraBillItems.UnitPrice) as total
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
                where 
               PaystatusID =@NotPaid  and
               ExtraBillItems.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime))
end

else if not(@VisitNo is  null) and @ItemCategoryID is null and @ExcludePaidFor = 1

begin
set @total  = (select sum(ExtraBillItems.Quantity * ExtraBillItems.UnitPrice) as total
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
                where 
               ExtraBills.visitno = @VisitNo and PaystatusID= @NotPaid and
               ExtraBillItems.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime))
end

else if @VisitNo is null and not(@ItemCategoryID is null) and @ExcludePaidFor = 1
begin
set @total  = (select sum(ExtraBillItems.Quantity * ExtraBillItems.UnitPrice) as total
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
                where 
                ItemCategoryID = @ItemCategoryID and PaystatusID= @NotPaid  and
               ExtraBillItems.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime))
end

else if not(@VisitNo is null) and not(@ItemCategoryID is null) and @ExcludePaidFor = 1
begin
set @total  = (select sum(ExtraBillItems.Quantity * ExtraBillItems.UnitPrice) as total
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
                where 
                ItemCategoryID = @ItemCategoryID and ExtraBills.visitno = @VisitNo and PaystatusID= @NotPaid  and 
               ExtraBillItems.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime))
end

else
begin
set @total  = (select sum(ExtraBillItems.Quantity * ExtraBillItems.UnitPrice) as total
				from ExtraBillItems 
				inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
				inner join Admissions on ExtraBills.VisitNo = Admissions.VisitNo
                where 
                ItemCategoryID = @ItemCategoryID and ExtraBills.visitno = @VisitNo and
               ExtraBillItems.RecordDateTime between dbo.FormatDate(@StartDateTime) and dbo.FormatDate(@EndDateTime))
end

set @total =isnull(@total,0)

return @total

end
go

--print dbo.GetIPDPeriodicTotalPerService('1300001012',NULL,0,'22 nov 2013','22 nov 2017') as phamacy


--------Function GetInvoiceBillName------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInvoiceBillName')
drop function GetInvoiceBillName
go

create function GetInvoiceBillName(@PayTypeID varchar(10), @PayNo varchar(20)) returns varchar(60)
with encryption as
begin

declare @BillModesID varchar(10)
declare @BillNo varchar(20)

declare @VisitBillPayTypeID varchar(10)
declare @BillName varchar(60)

----------------------------------------------------------------------------
set @VisitBillPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
----------------------------------------------------------------------------

begin

if (@PayTypeID = @VisitBillPayTypeID)
begin
set @BillModesID = (select BillModesID from Visits where VisitNo = @PayNo)
set @BillNo = (select BillNo from Visits where VisitNo = @PayNo)
set @BillName = dbo.GetBillName(@BillModesID, @BillNo)
end
else set @BillName = ''
set @BillName = isnull(@BillName, '')
end

return @BillName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInvoiceBillName('47CAS', '1207290010')
-- print dbo.GetInvoiceBillName('47ACC', 'CM00304')
-- print dbo.GetInvoiceBillName('47INS', 'CMC')
-- print dbo.GetInvoiceBillName('', null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetSchemeInsuranceName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetSchemeInsuranceName')
drop function GetSchemeInsuranceName
go

create function GetSchemeInsuranceName(@BillNo varchar(20)) returns varchar(60)
with encryption as

begin

declare @SchemeInsuranceName varchar(60)

set @SchemeInsuranceName = (select InsuranceName from SchemeMembers	
		inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
		and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
		inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
		inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
		inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
		where MedicalCardNo = @BillNo)
	
set @SchemeInsuranceName = isnull(@SchemeInsuranceName, '')

return @SchemeInsuranceName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetSchemeInsuranceName('123')
-- print dbo.GetSchemeInsuranceName(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetSchemeInsuranceNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetSchemeInsuranceNo')
drop function GetSchemeInsuranceNo
go

create function GetSchemeInsuranceNo(@BillNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @SchemeInsuranceNo varchar(20)

set @SchemeInsuranceNo = (select InsurancePolicies.InsuranceNo from SchemeMembers	
		inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
		and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
		inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
		inner join InsurancePolicies on InsuranceSchemes.PolicyNo = InsurancePolicies.PolicyNo
		inner join Insurances on InsurancePolicies.InsuranceNo = Insurances.InsuranceNo
		where MedicalCardNo = @BillNo)
	
set @SchemeInsuranceNo = isnull(@SchemeInsuranceNo, '')

return @SchemeInsuranceNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetSchemeInsuranceNo('INT12')
-- print dbo.GetSchemeInsuranceNo(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetDefaultInsuranceName------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDefaultInsuranceName')
drop function GetDefaultInsuranceName
go

create function GetDefaultInsuranceName(@BillModesID varchar(10), @BillNo varchar(20)) returns varchar(60)
with encryption as

begin

declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

declare @InsuranceName varchar(60)

----------------------------------------------------------------------------
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
----------------------------------------------------------------------------

begin
if (@BillModesID = @InsuranceBillModesID)
begin set @InsuranceName = dbo.GetSchemeInsuranceName(@BillNo) end
else set @InsuranceName = dbo.GetBillInsuranceName(@BillNo)
set @InsuranceName = isnull(@InsuranceName, '')
end

return @InsuranceName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetDefaultInsuranceName('17A', '100105A')
-- print dbo.GetDefaultInsuranceName('17I', '123')
-- print dbo.GetDefaultInsuranceName('17C', 'CASH')

-- print dbo.GetBillInsuranceName('100105A')
-- print dbo.GetSchemeInsuranceName('123')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetInsuranceName--------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInsuranceName')
drop function GetInsuranceName
go

create function GetInsuranceName(@BillModesID varchar(10), @InsuranceNo varchar(20)) returns varchar(60)
with encryption as

begin

declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

declare @InsuranceName varchar(60)

----------------------------------------------------------------------------
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
----------------------------------------------------------------------------

begin
if (@BillModesID = @InsuranceBillModesID)
begin set @InsuranceName = (select InsuranceName from Insurances where InsuranceNo = @InsuranceNo) end
else set @InsuranceName = (select BillCustomerName from BillCustomers where AccountNo = @InsuranceNo)
set @InsuranceName = isnull(@InsuranceName, '')
end

return @InsuranceName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInsuranceName('17A', '100105A')
-- print dbo.GetInsuranceName('17I', 'CMC')
-- print dbo.GetInsuranceName('17C', 'CASH')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetInvoiceInsuranceName--------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInvoiceInsuranceName')
drop function GetInvoiceInsuranceName
go

create function GetInvoiceInsuranceName(@PayTypeID varchar(10), @PayNo varchar(20)) returns varchar(60)
with encryption as

begin

declare @BillModesID varchar(10)
declare @InsuranceNo varchar(20)

declare @VisitBillPayTypeID varchar(10)
declare @InsuranceName varchar(60)

----------------------------------------------------------------------------
set @VisitBillPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
----------------------------------------------------------------------------

begin

if (@PayTypeID = @VisitBillPayTypeID)
begin
set @BillModesID = (select BillModesID from Visits where VisitNo = @PayNo)
set @InsuranceNo = (select InsuranceNo from Visits where VisitNo = @PayNo)
set @InsuranceName = dbo.GetInsuranceName(@BillModesID, @InsuranceNo)
end
else set @InsuranceName = ''
set @InsuranceName = isnull(@InsuranceName, '')
end

return @InsuranceName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInvoiceInsuranceName('47CAS', '1207290010')
-- print dbo.GetInvoiceInsuranceName('47ACC', 'CM00304')
-- print dbo.GetInvoiceInsuranceName('47INS', 'CMC')
-- print dbo.GetInvoiceInsuranceName('', null)

----------------------------------------------------------------------------------------------------------------------------

--------Function GetInsuranceNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInsuranceNo')
drop function GetInsuranceNo
go

create function GetInsuranceNo(@BillModesID varchar(10), @BillNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

declare @InsuranceNo varchar(20)

----------------------------------------------------------------------------
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
----------------------------------------------------------------------------

begin
if (@BillModesID = @InsuranceBillModesID)
begin set @InsuranceNo = dbo.GetSchemeInsuranceNo(@BillNo) end
else set @InsuranceNo = dbo.GetBillInsuranceNo(@BillNo)
set @InsuranceNo = isnull(@InsuranceNo, '')
end

return @InsuranceNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetInsuranceNo('17A', '100105A')
-- print dbo.GetInsuranceNo('17I', 'CPS80')
-- print dbo.GetInsuranceNo('17C', 'CASH')
-- print dbo.GetInsuranceNo('17A', 'CUST0031')

-- print dbo.GetBillInsuranceNo('CUST0031')
-- print dbo.GetSchemeInsuranceNo('123')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetSchemeMemberName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetSchemeMemberName')
drop function GetSchemeMemberName
go

create function GetSchemeMemberName(@MedicalCardNo varchar(20)) returns varchar(100)
with encryption as

begin

declare @SchemeMemberName varchar(100)

begin
set @SchemeMemberName = (select dbo.GetFullName(Surname, MiddleName, FirstName) 
			from SchemeMembers where MedicalCardNo = @MedicalCardNo)
set @SchemeMemberName = isnull(@SchemeMemberName, '')
end

return @SchemeMemberName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetSchemeMemberName('M01034582')
-- print dbo.GetSchemeMemberName(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetSchemeCompanyNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetSchemeCompanyNo')
drop function GetSchemeCompanyNo
go

create function GetSchemeCompanyNo(@BillNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @SchemeCompanyNo varchar(20)

set @SchemeCompanyNo = (select InsuranceSchemes.CompanyNo from SchemeMembers	
		inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
		and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
		inner join Companies on InsuranceSchemes.CompanyNo = Companies.CompanyNo
		where MedicalCardNo = @BillNo)
	
set @SchemeCompanyNo = isnull(@SchemeCompanyNo, '')

return @SchemeCompanyNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetSchemeCompanyNo('CPS80')
-- print dbo.GetSchemeCompanyNo(null)
----------------------------------------------------------------------------------------------------------------------------


-------------------------------------------------------------------------------------------------------------------
----------------------------Function GetMemberPremiumUsageBalance -------------------------------------------------
-------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetMemberPremiumUsageBalance')
	drop function GetMemberPremiumUsageBalance
go

create function GetMemberPremiumUsageBalance(@MedicalCardNo varchar(20)) returns Money
with encryption as


begin
-------------------------------------------------------------------------------------------------------------------

declare @MainMemberNo varchar(20)
declare @PolicyNo varchar(20)
declare @CompanyNo varchar(20)
declare @TotalConsumedOPD decimal
declare @TotalConsumedIPD decimal
declare @AnnualPremium decimal
declare @RemainingBalance decimal

-------------------------------------------------------------------------------------------------------------------
set @MainMemberNo = (select  MainMemberNo from SchemeMembers where MedicalCardNo =@MedicalCardNo)
-------------------------------------------------------------------------------------------------------------------
set @PolicyNo=( select PolicyNo from SchemeMembers where MedicalCardNo =@MedicalCardNo)
-------------------------------------------------------------------------------------------------------------------
set @CompanyNo=( select CompanyNo from SchemeMembers where MedicalCardNo =@MedicalCardNo)
-------------------------------------------------------------------------------------------------------------------
set @AnnualPremium =isnull((select MemberPremium from InsuranceSchemes where CompanyNo =@CompanyNo and PolicyNo =@PolicyNo),0)
-------------------------------------------------------------------------------------------------------------------


set @TotalConsumedOPD =isnull((select sum(dbo.GetInvoiceItemBalanceAmount(InvoiceDetails.InvoiceNo, InvoiceDetails.VisitNo, InvoiceDetails.ItemCategoryID, InvoiceDetails.ItemCode)) 
as InvoiceAmount from InvoiceDetails
inner join Invoices on InvoiceDetails.InvoiceNo =Invoices.InvoiceNo
inner join Visits on InvoiceDetails.VisitNo = Visits.VisitNo
inner join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
where MainMemberNo = @MainMemberNo and Invoices.InvoiceDate between PolicyStartDate and PolicyEndDate),0)


set @TotalConsumedIPD = isnull((select sum(dbo.GetIPDItemInvoicedAmount(ExtraBillItems.ExtraBillNo,ExtraBillItems.ItemCategoryID,ExtraBillItems.ItemCode)) as InvoiceAmount 
from ExtraBillItems
inner join ExtraBills on ExtraBillItems.ExtraBillNo = ExtraBills.ExtraBillNo
inner join Visits on ExtraBills.VisitNo = Visits.VisitNo
inner join SchemeMembers on SchemeMembers.MedicalCardNo = Visits.MemberCardNo
where MainMemberNo = @MainMemberNo and ExtraBillItems.RecordDateTime between PolicyStartDate and PolicyEndDate),0)


-------------------------------------------------------------------------------------------------------------------
if (dbo.GetOptionValue('EnforceCreditLimitOnInPatientAndOutPatient') > 0)
begin
set @RemainingBalance =(@AnnualPremium -@TotalConsumedOPD)
end
else
begin
set @RemainingBalance =(@AnnualPremium -(@TotalConsumedOPD + @TotalConsumedIPD))
end

-------------------------------------------------------------------------------------------------------------------

return @RemainingBalance
end
go



--------Function GetBillsPaymentCustomerName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetBillsPaymentCustomerName')
drop function GetBillsPaymentCustomerName
go

create function GetBillsPaymentCustomerName(@PayTypeID varchar(10), @PayNo varchar(20)) returns varchar(60)
with encryption as

begin

declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)

declare @BillsPaymentCustomerName varchar(60)

set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')

begin
if (@PayTypeID = @AccountBillPayTypeID)
begin set @BillsPaymentCustomerName = (select BillCustomerName from BillCustomers where AccountNo = @PayNo) end
else if (@PayTypeID = @InsuranceBillPayTypeID)
begin set @BillsPaymentCustomerName = (select InsuranceName from Insurances where InsuranceNo = @PayNo) end
	
set @BillsPaymentCustomerName = isnull(@BillsPaymentCustomerName, '')
end

return @BillsPaymentCustomerName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetBillsPaymentCustomerName('47ACC', '100108A')
-- print dbo.GetBillsPaymentCustomerName('47INS', 'CMC')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetSmartCardApplicable-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetSmartCardApplicable')
drop function GetSmartCardApplicable
go

create function GetSmartCardApplicable(@BillModesID varchar(10), @BillNo varchar(20)) returns bit
with encryption as

begin

declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

declare @SmartCardApplicable bit

----------------------------------------------------------------------------
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
----------------------------------------------------------------------------

begin
if (@BillModesID = @InsuranceBillModesID)
begin 
set @SmartCardApplicable = (select SmartCardApplicable from SchemeMembers	
						inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
						and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
						where MedicalCardNo = @BillNo)
end
else begin set @SmartCardApplicable = (select SmartCardApplicable from BillCustomers where AccountNo = @BillNo) end
set @SmartCardApplicable = isnull(@SmartCardApplicable, 0)
end

return @SmartCardApplicable

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetSmartCardApplicable('17A', '100105A')
-- print dbo.GetSmartCardApplicable('17I', '123')
-- print dbo.GetSmartCardApplicable('17C', 'CASH')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetAllowOnlyListedMember-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAllowOnlyListedMember')
drop function GetAllowOnlyListedMember
go

create function GetAllowOnlyListedMember(@AccountNo varchar(20)) returns bit
with encryption as

begin

declare @AllowOnlyListedMember bit

begin
set @AllowOnlyListedMember = (select AllowOnlyListedMember from BillCustomers where AccountNo = @AccountNo) 		
set @AllowOnlyListedMember = isnull(@AllowOnlyListedMember, 0)
end

return @AllowOnlyListedMember

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetAllowOnlyListedMember('100105A')
-- print dbo.GetAllowOnlyListedMember('123')
-- print dbo.GetAllowOnlyListedMember('CASH')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetCaptureMemberCardNo-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCaptureMemberCardNo')
drop function GetCaptureMemberCardNo
go

create function GetCaptureMemberCardNo(@AccountNo varchar(20)) returns bit
with encryption as

begin

declare @CaptureMemberCardNo bit

begin
set @CaptureMemberCardNo = (select CaptureMemberCardNo from BillCustomers where AccountNo = @AccountNo) 		
set @CaptureMemberCardNo = isnull(@CaptureMemberCardNo, 0)
end

return @CaptureMemberCardNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetCaptureMemberCardNo('100105A')
-- print dbo.GetCaptureMemberCardNo('123')
-- print dbo.GetCaptureMemberCardNo('CASH')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetCaptureClaimReferenceNo-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCaptureClaimReferenceNo')
drop function GetCaptureClaimReferenceNo
go

create function GetCaptureClaimReferenceNo(@AccountNo varchar(20)) returns bit
with encryption as

begin

declare @CaptureClaimReferenceNo bit

begin
set @CaptureClaimReferenceNo = (select CaptureClaimReferenceNo from BillCustomers where AccountNo = @AccountNo) 		
set @CaptureClaimReferenceNo = isnull(@CaptureClaimReferenceNo, 0)
end

return @CaptureClaimReferenceNo

end

go

-------------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetCaptureClaimReferenceNo('100105A')
-- print dbo.GetCaptureClaimReferenceNo('123')
-- print dbo.GetCaptureClaimReferenceNo('CASH')
-------------------------------------------------------------------------------------------------------------------------------

--------Function GetCoPayTypeID------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCoPayTypeID')
drop function GetCoPayTypeID
go

create function GetCoPayTypeID(@BillModesID varchar(10), @BillNo varchar(20)) returns varchar(10)
with encryption as

begin

declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

declare @CoPayTypeID varchar(10)

----------------------------------------------------------------------------
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
----------------------------------------------------------------------------

begin

if (@BillModesID = @InsuranceBillModesID)
begin
set @CoPayTypeID = (select CoPayTypeID from SchemeMembers	
			inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
			and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
			where MedicalCardNo = @BillNo)
end
else set @CoPayTypeID = (select CoPayTypeID from BillCustomers where AccountNo = @BillNo)
set @CoPayTypeID = isnull(@CoPayTypeID, '')
end

return @CoPayTypeID

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetCoPayTypeID('17C', 'CASH')
-- print dbo.GetCoPayTypeID('17A', 'ICEA')
-- print dbo.GetCoPayTypeID('17I', '123')
-- print dbo.GetCoPayTypeID('17I', 'M001')
-- print dbo.GetCoPayTypeID('', null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetCoPayPercent------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCoPayPercent')
drop function GetCoPayPercent
go

create function GetCoPayPercent(@BillModesID varchar(10), @BillNo varchar(20)) returns decimal(5,2)
with encryption as

begin

declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

declare @CoPayPercent decimal(5,2)

----------------------------------------------------------------------------
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
----------------------------------------------------------------------------

begin

if (@BillModesID = @InsuranceBillModesID)
begin
set @CoPayPercent = (select CoPayPercent from SchemeMembers	
			inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
			and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
			where MedicalCardNo = @BillNo)
end
else set @CoPayPercent = (select CoPayPercent from BillCustomers where AccountNo = @BillNo)
set @CoPayPercent = isnull(@CoPayPercent, 0.00)
end

return @CoPayPercent

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetCoPayPercent('17C', 'CASH')
-- print dbo.GetCoPayPercent('17A', 'ICEA')
-- print dbo.GetCoPayPercent('17A', 'ERA')
-- print dbo.GetCoPayPercent('17I', '123')
-- print dbo.GetCoPayPercent('17I', 'M001')
-- print dbo.GetCoPayPercent('', null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetCoPayValue------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCoPayValue')
drop function GetCoPayValue
go

create function GetCoPayValue(@BillModesID varchar(10), @BillNo varchar(20)) returns money
with encryption as

begin

declare @CashBillModesID varchar(10)
declare @AccountBillModesID varchar(10)
declare @InsuranceBillModesID varchar(10)

declare @CoPayValue money

----------------------------------------------------------------------------
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @InsuranceBillModesID = dbo.GetLookupDataID('BillModes', 'I')
----------------------------------------------------------------------------

begin

if (@BillModesID = @InsuranceBillModesID)
begin
set @CoPayValue = (select CoPayValue from SchemeMembers	
			inner join InsuranceSchemes on InsuranceSchemes.CompanyNo = SchemeMembers.CompanyNo
			and InsuranceSchemes.PolicyNo = SchemeMembers.PolicyNo
			where MedicalCardNo = @BillNo)
end
else set @CoPayValue = (select CoPayValue from BillCustomers where AccountNo = @BillNo)
set @CoPayValue = isnull(@CoPayValue, 0.00)
end

return @CoPayValue

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetCoPayValue('17C', 'CASH')
-- print dbo.GetCoPayValue('17A', 'ICEA')
-- print dbo.GetCoPayValue('17A', 'ERA')
-- print dbo.GetCoPayValue('17I', '123')
-- print dbo.GetCoPayValue('17I', 'M001')
-- print dbo.GetCoPayValue('', null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetCoPayFee------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCoPayFee')
drop function GetCoPayFee
go

create function GetCoPayFee(@CoPayTypeID varchar(10), @CoPayPercent decimal(5,2), @Fee money) returns money
with encryption as

begin

declare @PercentCoPayTypeID varchar(10)
declare @CoPayFee money

--------------------------------------------------------------------
set @PercentCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'PCT')
--------------------------------------------------------------------

begin
if (@CoPayTypeID = @PercentCoPayTypeID)
begin set @CoPayFee = @Fee * (100-@CoPayPercent)/100 end
else set @CoPayFee = @Fee
set @CoPayFee = isnull(@CoPayFee, 0.00)
end

return @CoPayFee

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetCoPayFee('44NA', 15, 1000)
-- print dbo.GetCoPayFee('44PCT', 10, 1500)
-- print dbo.GetCoPayFee('44VAL', 15, 1500)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetCoPayCashAmount-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCoPayCashAmount')
drop function GetCoPayCashAmount
go

create function GetCoPayCashAmount(@CoPayTypeID varchar(10), @CoPayPercent decimal(5,2), @CashAmount money) returns money
with encryption as

begin

declare @PercentCoPayTypeID varchar(10)
declare @CoPayCashAmount money

--------------------------------------------------------------------
set @PercentCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'PCT')
--------------------------------------------------------------------

begin
if (@CoPayTypeID = @PercentCoPayTypeID)
begin set @CoPayCashAmount = (@CashAmount * @CoPayPercent)/100 end
else set @CoPayCashAmount = @CashAmount
set @CoPayCashAmount = isnull(@CoPayCashAmount, 0.00)
end

set @CoPayCashAmount = Abs(@CoPayCashAmount)

return @CoPayCashAmount

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetCoPayCashAmount('44NA', 15, 1500)
-- print dbo.GetCoPayCashAmount('44PCT', 20, 1500)
-- print dbo.GetCoPayCashAmount('44VAL', 15, -1500)
----------------------------------------------------------------------------------------------------------------------------


--------Function GetItemUnitPrice------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetItemUnitPrice')
drop function GetItemUnitPrice
go

create function GetItemUnitPrice(@VisitNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10), @CoPayTypeID varchar(10), @CoPayPercent decimal(5,2), @UnitPrice money) returns money
with encryption as

begin

declare @PercentCoPayTypeID varchar(10)
declare @ValueCoPayTypeID as varchar(10)
declare @NACoPayTypeID varchar(10)
declare @ExtraChargeItemCategoryID varchar(10)
declare @CoPayItemCode varchar(20)



declare @ItemUnitPrice money
declare @VisitBill money
--------------------------------------------------------------------
set @PercentCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'PCT')
set @ValueCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'VAL')
set @NACoPayTypeID = dbo.GetLookupDataID('CoPayType', 'NA')
set @ExtraChargeItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'E')
set @CoPayItemCode = 'CPV'

--------------------------------------------------------------------

begin

 if (@CoPayTypeID = @PercentCoPayTypeID)
	begin set @ItemUnitPrice = dbo.GetCoPayFee(@CoPayTypeID, @CoPayPercent, @UnitPrice) end

else if (@CoPayTypeID = @ValueCoPayTypeID)
begin 
	if @ItemCode = @CoPayItemCode and @ItemCategoryID = @ExtraChargeItemCategoryID
		begin
			set @VisitBill = (select sum(UnitPrice * Quantity) from Items 
							where VisitNo = @VisitNo and not (ItemCode = @CoPayItemCode and ItemCategoryID = @ExtraChargeItemCategoryID))

            set @VisitBill = isnull(@VisitBill, 0.00)
			set @ItemUnitPrice = abs(@UnitPrice)
		
		    if @VisitBill = 0 begin set @ItemUnitPrice = 0 end
			else if(@VisitBill >= @ItemUnitPrice) begin set @ItemUnitPrice = @UnitPrice end
			else if @VisitBill < @ItemUnitPrice begin set @ItemUnitPrice =  -@VisitBill end
			else begin set @ItemUnitPrice = @UnitPrice end
		end
     else  set @ItemUnitPrice = @UnitPrice 
end

else if @CoPayTypeID = @NACoPayTypeID set @ItemUnitPrice = @UnitPrice

else set @ItemUnitPrice = @UnitPrice

set @ItemUnitPrice = isnull(@ItemUnitPrice, 0.00)
end

return @ItemUnitPrice

end

go
/****************************************************************************************************************************
select dbo.GetItemUnitPrice(Items.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as ItemUnitPrice,  * 
from Items
inner join Visits on  Visits.VisitNo = Items.VisitNo 
where Items.VisitNo = 'P160009550006' 
go


****************************************************************************************************************************/



--------Function GetExtraBillItemUnitPrice------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetExtraBillItemUnitPrice')
drop function GetExtraBillItemUnitPrice
go

create function GetExtraBillItemUnitPrice(@VisitNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10), @CoPayTypeID varchar(10), @CoPayPercent decimal(5,2), @UnitPrice money) returns money
with encryption as

begin

declare @PercentCoPayTypeID varchar(10)
declare @ValueCoPayTypeID as varchar(10)
declare @NACoPayTypeID varchar(10)
declare @ExtraChargeItemCategoryID varchar(10)
declare @CoPayItemCode varchar(20)



declare @ItemUnitPrice money
declare @VisitBill money
--------------------------------------------------------------------
set @PercentCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'PCT')
set @ValueCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'VAL')
set @NACoPayTypeID = dbo.GetLookupDataID('CoPayType', 'NA')
set @ExtraChargeItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'E')
set @CoPayItemCode = 'CPV'

--------------------------------------------------------------------

begin

 if (@CoPayTypeID = @PercentCoPayTypeID)
	begin set @ItemUnitPrice = dbo.GetCoPayFee(@CoPayTypeID, @CoPayPercent, @UnitPrice) end

else if (@CoPayTypeID = @ValueCoPayTypeID)
begin 
	if @ItemCode = @CoPayItemCode and @ItemCategoryID = @ExtraChargeItemCategoryID
		begin
		
			set @VisitBill = (select sum(UnitPrice * Quantity) from ExtraBillItems
			inner join ExtraBills on ExtraBills.ExtraBillNo = ExtraBillItems.ExtraBillNo
			where VisitNo = @VisitNo and not (ItemCategoryID = @ExtraChargeItemCategoryID and ItemCode = @CoPayItemCode))


            set @VisitBill = isnull(@VisitBill, 0.00)
			set @ItemUnitPrice = abs(@UnitPrice)
		
		    if @VisitBill = 0 begin set @ItemUnitPrice = 0 end
			else if(@VisitBill >= @ItemUnitPrice) begin set @ItemUnitPrice = @UnitPrice end
			else if @VisitBill < @ItemUnitPrice begin set @ItemUnitPrice =  -@VisitBill end
			else begin set @ItemUnitPrice = @UnitPrice end
		end
     else  set @ItemUnitPrice = @UnitPrice 
end

else if @CoPayTypeID = @NACoPayTypeID set @ItemUnitPrice = @UnitPrice

else set @ItemUnitPrice = @UnitPrice

set @ItemUnitPrice = isnull(@ItemUnitPrice, 0.00)
end

return @ItemUnitPrice

end

go

/****************************************************************************************************************************
select dbo.GetItemUnitPrice(ExtraBills.VisitNo, ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as ItemUnitPrice, *
from ExtraBillItems 
inner join ExtraBills on ExtraBills.ExtraBillNo = ExtraBillItems.ExtraBillNo
inner join Admissions on Admissions.VisitNo = Admissions.VisitNo

****************************************************************************************************************************/



--------Function GetCoPayCashUnitPrice------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCoPayCashUnitPrice')
drop function GetCoPayCashUnitPrice
go

create function GetCoPayCashUnitPrice(@ItemCode varchar(20), @ItemCategoryID varchar(10), @CoPayTypeID varchar(10), @CoPayPercent decimal(5,2), @UnitPrice money) returns money
with encryption as

begin

declare @PercentCoPayTypeID varchar(10)
declare @ValueCoPayTypeID as varchar(10)
declare @NACoPayTypeID varchar(10)
declare @ExtraChargeItemCategoryID varchar(10)
declare @CoPayItemCode varchar(20)



declare @CoPayCashUnitPrice money
--------------------------------------------------------------------
set @PercentCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'PCT')
set @ValueCoPayTypeID = dbo.GetLookupDataID('CoPayType', 'VAL')
set @NACoPayTypeID = dbo.GetLookupDataID('CoPayType', 'NA')
set @ExtraChargeItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'E')
set @CoPayItemCode = 'CPV'

--------------------------------------------------------------------

 if (@CoPayTypeID = @PercentCoPayTypeID)
	begin set @CoPayCashUnitPrice = dbo.GetCoPayCashAmount(@CoPayTypeID, @CoPayPercent, @UnitPrice) end

else if (@CoPayTypeID = @ValueCoPayTypeID)
begin
  if @ItemCode = @CoPayItemCode and @ItemCategoryID = @ExtraChargeItemCategoryID
  begin set @CoPayCashUnitPrice = abs(@UnitPrice)end
  else begin set @CoPayCashUnitPrice = abs(@UnitPrice) end
end

else if @CoPayTypeID = @NACoPayTypeID 
  begin  set @CoPayCashUnitPrice = @UnitPrice end
else begin set @CoPayCashUnitPrice = @UnitPrice end

set @CoPayCashUnitPrice = isnull(@CoPayCashUnitPrice, 0.00)
return @CoPayCashUnitPrice

end

go
/****************************************************************************************************************************
select dbo.GetCoPayCashUnitPrice(ItemCode, ItemCategoryID, CoPayTypeID, CoPayPercent, UnitPrice) as ItemCASHUnitPrice,  * 
from Items
inner join Visits on  Visits.VisitNo = Items.VisitNo 
where Items.VisitNo = 'PLH393670002' 
print dbo.GetCoPayCashUnitPrice('CONC', '7D', '44PCT', 20, 2000)
select * from ItemsCASH

****************************************************************************************************************************/


-------------- Get Logins FullName-------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetLoginsFullName')
	drop function GetLoginsFullName
go

create function GetLoginsFullName(@LoginID varchar(20)) returns varchar(200)

with encryption as
begin
declare @fullName varchar(200)

set @fullName=(select dbo.GetFullName(LastName,'',FirstName) as FullName from Logins
	where LoginID =@LoginID)

return @fullName
end
go
-----------------------------------------------------------------------------------------------
---------------------------------- uspGetMessengerUsers ---------------------------------------
-----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetMessengerUsers')
	drop proc uspGetMessengerUsers
go

create proc uspGetMessengerUsers
with encryption as

declare @ErrorMSG varchar(200)

Select LoginID,dbo.GetFullName(LastName,'',FirstName) as FullName from Logins


return 0
go

-----------------------------------------------------------------------------------------------

--------Function GetNextLabTestsEXTSortOrder--------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetNextLabTestsEXTSortOrder')
drop function GetNextLabTestsEXTSortOrder
go

create function GetNextLabTestsEXTSortOrder(@TestCode varchar(20)) returns tinyint
with encryption as

begin

declare @NextLabTestsEXTSortOrder tinyint

set @NextLabTestsEXTSortOrder = (select Max(SortOrder) from LabTestsEXT where TestCode = @TestCode)
set @NextLabTestsEXTSortOrder = isnull(@NextLabTestsEXTSortOrder, 0) + 1

return @NextLabTestsEXTSortOrder

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetNextLabTestsEXTSortOrder('T007')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetHasSubResults------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasSubResults')
drop function GetHasSubResults
go

create function GetHasSubResults(@SpecimenNo varchar(20), @TestCode varchar(20)) returns bit
with encryption as
begin

declare @HasSubResults bit

if exists (select SpecimenNo from LabResultsEXT where SpecimenNo = @SpecimenNo and TestCode = @TestCode)
set @HasSubResults = 1
else set @HasSubResults = 0

return @HasSubResults

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetHasSubResults('', 'T001') as varchar)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetHasTriage-----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasTriage')
drop function GetHasTriage
go

create function GetHasTriage(@VisitNo varchar(20)) returns bit
with encryption as
begin

declare @HasTriage bit

if exists (select VisitNo from Triage where VisitNo = @VisitNo)
set @HasTriage = 1
else set @HasTriage = 0

return @HasTriage

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetHasTriage('103536002')
----------------------------------------------------------------------------------------------------------------------------


----------Function Get RejectionStatus-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetRejectionStatus')
drop function      GetRejectionStatus
go

create function GetRejectionStatus(@VisitNo varchar(20), @ItemCategoryID varchar(10)) returns varchar(10)
with encryption as

begin

declare @Rejected varchar(10) 

if not @ItemCategoryID= dbo.GetLookupDataID('ItemCategory', 'T')
begin set @Rejected='False' end  
	

else
begin
if exists(select specimenNo from RejectedSpecimens where VisitNo=@VisitNo and IsReAccepted=0)
begin set @Rejected='True' end
else begin set @Rejected='False' end   
end

set @Rejected= isnull(@Rejected, 'False')

return @Rejected
	
end
go


----------------------------------------------------------------------------------------------------------
--print dbo.GetRejectionStatus('1302274009','7T')
--select * from RejectedSpecimens





--------Function CalculateBMI-----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'CalculateBMI')
drop function CalculateBMI
go

create function CalculateBMI(@Weight float , @Height float) returns float
with encryption as
begin

declare @BMI float

if @Weight <= 0 or @Height <= 0 begin set @BMI = 0 end
else begin set @BMI = (@Weight / (@Height * @Height)) end

set @BMI =dbo.FormatMoney(@BMI)

return @BMI

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.CalculateBMI(75, 1.76)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetHasVisionAssessment--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasVisionAssessment')
drop function GetHasVisionAssessment
go

create function GetHasVisionAssessment(@VisitNo varchar(20)) returns bit
with encryption as
begin

declare @HasVisionAssessment bit

if exists (select VisitNo from VisionAssessment where VisitNo = @VisitNo)
set @HasVisionAssessment = 1
else set @HasVisionAssessment = 0

return @HasVisionAssessment

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetHasVisionAssessment('103536002')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetHasRefractionVisionAssessment--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasRefractionVisionAssessment')
drop function GetHasRefractionVisionAssessment
go

create function GetHasRefractionVisionAssessment(@VisitNo varchar(20)) returns bit
with encryption as
begin

declare @HasRefractionVisionAssessment bit
declare @VisionAssessmentID varchar(10)
set @VisionAssessmentID = dbo.GetLookupDataID('EyeTest', 'RF')

if exists (select VisitNo from VisionAssessment where VisitNo = @VisitNo and EyeTestID=@VisionAssessmentID )
set @HasRefractionVisionAssessment = 1
else set @HasRefractionVisionAssessment = 0

return @HasRefractionVisionAssessment

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetHasRefractionVisionAssessment('1494815002')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetLabApprovedStatusID--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetLabApprovedStatusID')
drop function GetLabApprovedStatusID
go

create function GetLabApprovedStatusID(@VisitNo varchar(20),@TestCode varchar(20)) returns varchar(20)
with encryption as
begin
declare @LabApprovedStatusID varchar(20)
declare @ApprovedStatusID varchar(10)
declare @NotApprovedStatusID varchar(10)
declare @TestID varchar(10)

Set @NotApprovedStatusID =dbo.GetLookupDataID('YesNo', 'N')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')

if exists (select ApprovedStatusID from LabRequests
inner join LabResults on LabRequests.SpecimenNo =LabResults.SpecimenNo
inner join LabRequestDetails on LabRequestDetails.TestCode =LabResults.TestCode and
LabRequestDetails.SpecimenNo =LabResults.SpecimenNo
where VisitNo =@VisitNo and ApprovedStatusID =@NotApprovedStatusID and LabResults.TestCode =@TestCode)


set @LabApprovedStatusID = 'Pending Approval'


else set @LabApprovedStatusID = (select dbo.GetLookupDataDes(ItemStatusID) from Items
where VisitNo =@VisitNo and ItemCode =@TestCode and ItemCategoryID =  @TestID)

return @LabApprovedStatusID

end
go
----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetLabApprovedStatusID('1303378005','t227')

-- select * from LabResults where SpecimenNo ='1303378001'
----------------------------------------------------------------------------------------------------------------------------

--------Function GetIPDLabApprovedStatusID--------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDLabApprovedStatusID')
drop function GetIPDLabApprovedStatusID
go

create function GetIPDLabApprovedStatusID(@RoundNo varchar(20),@TestCode varchar(20)) returns varchar(20)
with encryption as
begin
declare @LabApprovedStatusID varchar(20)
declare @ApprovedStatusID varchar(10)
declare @NotApprovedStatusID varchar(10)
declare @TestID varchar(10)

Set @NotApprovedStatusID =dbo.GetLookupDataID('YesNo', 'N')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')

if exists (select ApprovedStatusID from LabRequests
inner join LabResults on LabRequests.SpecimenNo =LabResults.SpecimenNo
inner join LabRequestDetails on LabRequestDetails.TestCode =LabResults.TestCode and 
LabRequestDetails.SpecimenNo =LabResults.SpecimenNo
inner join LabRequestsIPD on LabRequestsIPD.SpecimenNo =LabResults.SpecimenNo
where LabRequestsIPD.RoundNo =@RoundNo and ApprovedStatusID =@NotApprovedStatusID and LabResults.TestCode =@TestCode)


set @LabApprovedStatusID = 'Pending Approval'

else set @LabApprovedStatusID = (select dbo.GetLookupDataDes(ItemStatusID) from IPDItems
where RoundNo =@RoundNo and ItemCode =@TestCode and ItemCategoryID =  @TestID)

return @LabApprovedStatusID

end
go
----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetIPDLabApprovedStatusID('145833302001','T002')
-- dbo.GetIPDLabApprovedStatusID(Items.VisitNo,Items.ItemCode) as LabApprovedStatusID
-- select * from LabRequestsIPD where RoundNo ='145833302001'
----------------------------------------------------------------------------------------------------------------------------


--------Function GetHasIPDVisualAssessment-----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasIPDVisualAssessment')
drop function GetHasIPDVisualAssessment
go

create function GetHasIPDVisualAssessment(@AdmissionNo varchar(20)) returns bit
with encryption as
begin

declare @HasIPDVisualAssessment bit

if exists (select VARoundNo from IPDVisionAssessment 
where AdmissionNo = @AdmissionNo)
set @HasIPDVisualAssessment = 1
else set @HasIPDVisualAssessment = 0

return @HasIPDVisualAssessment

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetHasIPDVisualAssessment('103536002')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetTotalItemRequests---------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalItemRequests')
drop function GetTotalItemRequests
go

create function GetTotalItemRequests(@VisitNo varchar(20), @ItemID varchar(10)) returns int
with encryption as

begin

declare @TotalItemRequests int

set @TotalItemRequests = (select count(VisitNo) from Items 
				where VisitNo = @VisitNo and ItemCategoryID = @ItemID )
set @TotalItemRequests = isnull(@TotalItemRequests, 0)

return @TotalItemRequests

end

go

----------------------------------------------------------------------------------------------------------------------------
/*****************************************************

declare @ItemID varchar(10)
set @ItemID = dbo.GetLookupDataID('ItemCategory', 'R')
print dbo.GetTotalItemRequests('1001/03001', @ItemID)

*****************************************************/

----------------------------------------------------------------------------------------------------------------------------



--------Function GetTotalCardiologyRequests----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalCardiologyRequests')
drop function GetTotalCardiologyRequests
go

create function GetTotalCardiologyRequests(@VisitNo varchar(20)) returns int
with encryption as

begin

declare @TotalCardiologyRequests int
declare @CardiologyID varchar(10)

set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @TotalCardiologyRequests = (select count(VisitNo) from Items 
				where VisitNo = @VisitNo and ItemCategoryID = @CardiologyID )
set @TotalCardiologyRequests = isnull(@TotalCardiologyRequests, 0)

return @TotalCardiologyRequests

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetTotalCardiologyRequests('1001/03001')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetTotalIPDCardiologyRequests-------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalIPDCardiologyRequests')
drop function GetTotalIPDCardiologyRequests
go

create function GetTotalIPDCardiologyRequests(@RoundNo varchar(20)) returns int
with encryption as

begin

declare @TotalIPDCardiologyRequests int
declare @CardiologyID varchar(10)

set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @TotalIPDCardiologyRequests = (select count(RoundNo) from IPDItems 
				where RoundNo = @RoundNo and ItemCategoryID = @CardiologyID )
set @TotalIPDCardiologyRequests = isnull(@TotalIPDCardiologyRequests, 0)

return @TotalIPDCardiologyRequests

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetTotalIPDCardiologyRequests('1001/03001')
----------------------------------------------------------------------------------------------------------------------------



--------Function GetTotalRadiologyRequests----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalRadiologyRequests')
drop function GetTotalRadiologyRequests
go

create function GetTotalRadiologyRequests(@VisitNo varchar(20)) returns int
with encryption as

begin

declare @TotalRadiologyRequests int
declare @RadiologyID varchar(10)

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')

set @TotalRadiologyRequests = (select count(VisitNo) from Items 
				where VisitNo = @VisitNo and ItemCategoryID = @RadiologyID )
set @TotalRadiologyRequests = isnull(@TotalRadiologyRequests, 0)

return @TotalRadiologyRequests

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetTotalRadiologyRequests('1001/03001')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetTotalIPDRadiologyRequests-------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalIPDRadiologyRequests')
drop function GetTotalIPDRadiologyRequests
go

create function GetTotalIPDRadiologyRequests(@RoundNo varchar(20)) returns int
with encryption as

begin

declare @TotalIPDRadiologyRequests int
declare @RadiologyID varchar(10)

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')

set @TotalIPDRadiologyRequests = (select count(RoundNo) from IPDItems 
				where RoundNo = @RoundNo and ItemCategoryID = @RadiologyID )
set @TotalIPDRadiologyRequests = isnull(@TotalIPDRadiologyRequests, 0)

return @TotalIPDRadiologyRequests

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetTotalIPDRadiologyRequests('1001/03001')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetTotalIPDPathologyRequests-------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalIPDPathologyRequests')
drop function GetTotalIPDPathologyRequests
go

create function GetTotalIPDPathologyRequests(@RoundNo varchar(20)) returns int
with encryption as

begin

declare @TotalIPDPathologyRequests int
declare @PathologyID varchar(10)

set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')

set @TotalIPDPathologyRequests = (select count(RoundNo) from IPDItems 
				where RoundNo = @RoundNo and ItemCategoryID = @PathologyID )
set @TotalIPDPathologyRequests = isnull(@TotalIPDPathologyRequests, 0)

return @TotalIPDPathologyRequests

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetTotalIPDPathologyRequests('1001/03001')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetTotalPathologyRequests----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalPathologyRequests')
drop function GetTotalPathologyRequests
go

create function GetTotalPathologyRequests(@VisitNo varchar(20)) returns int
with encryption as

begin

declare @TotalPathologyRequests int
declare @PathologyID varchar(10)

set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')

set @TotalPathologyRequests = (select count(VisitNo) from Items 
				where VisitNo = @VisitNo and ItemCategoryID = @PathologyID )
set @TotalPathologyRequests = isnull(@TotalPathologyRequests, 0)

return @TotalPathologyRequests

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetTotalPathologyRequests('1001/03001')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetTotalDentalRequests-----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalDentalRequests')
drop function GetTotalDentalRequests
go

create function GetTotalDentalRequests(@VisitNo varchar(20)) returns int
with encryption as

begin

declare @TotalDentalRequests int
declare @DentalID varchar(10)

set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')

set @TotalDentalRequests = (select count(VisitNo) from Items 
				where VisitNo = @VisitNo and ItemCategoryID = @DentalID)

set @TotalDentalRequests = isnull(@TotalDentalRequests, 0)
return @TotalDentalRequests

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetTotalDentalRequests('1001/03001')

----------------------------------------------------------------------------------------------------------------------------

--------Function GetTotalIPDDentalRequests----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalIPDDentalRequests')
drop function GetTotalIPDDentalRequests
go

create function GetTotalIPDDentalRequests(@RoundNo varchar(20)) returns int
with encryption as

begin

declare @TotalIPDDentalRequests int
declare @DentalID varchar(10)

set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')

set @TotalIPDDentalRequests = (select count(RoundNo) from IPDItems 
				where RoundNo = @RoundNo and ItemCategoryID = @DentalID)

set @TotalIPDDentalRequests = isnull(@TotalIPDDentalRequests, 0)

return @TotalIPDDentalRequests

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetTotalIPDDentalRequests('1001/03001')

----------------------------------------------------------------------------------------------------------------------------

--------Function GetNextAppointmentDate-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetNextAppointmentDate')
drop function GetNextAppointmentDate
go

create function GetNextAppointmentDate(@PatientNo varchar(20), @VisitDate smalldatetime) returns smalldatetime
with encryption as

begin

declare @NextAppointmentDate smalldatetime

set @NextAppointmentDate = (select min(EndDate) from Appointments 
			where PatientNo = @PatientNo and EndDate > dbo.GetShortDate(@VisitDate))
return @NextAppointmentDate

end
go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetNextAppointmentDate('080/05', 'Mar 9 2011')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetIsScheduledVisit-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIsScheduledVisit')
drop function GetIsScheduledVisit
go

create function GetIsScheduledVisit(@PatientNo varchar(20), @VisitDate smalldatetime) returns bit
with encryption as

begin

declare @IsScheduledVisit bit

if exists (select EndDate from Appointments 
		where PatientNo = @PatientNo and StartDate <= dbo.GetShortDate(@VisitDate)
		and EndDate >= dbo.GetShortDate(@VisitDate))
set @IsScheduledVisit = 1
else set @IsScheduledVisit = 0

return @IsScheduledVisit

end
go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetIsScheduledVisit('080/05', 'May 10 2011')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetARTStartDate--------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetARTStartDate')
drop function GetARTStartDate
go

create function GetARTStartDate(@PatientNo varchar(20)) returns varchar(12)
with encryption as

begin

declare @StartDate varchar(12)

declare @StartingARTCategoryID varchar(10)
declare @ReferredARTCategoryID varchar(10)

set @StartingARTCategoryID = dbo.GetLookupDataID('ARTCategory', 'STA')
set @ReferredARTCategoryID = dbo.GetLookupDataID('ARTCategory', 'REF')

set @StartDate = (select top 1 cast(StartDate as varchar(12)) from ARTRegimen
	inner join Visits on ARTRegimen.VisitNo = Visits.VisitNo
	where (Visits.PatientNo = @PatientNo) and 
	((ARTCategoryID = @StartingARTCategoryID) or (ARTCategoryID = @ReferredARTCategoryID))
	order by StartDate asc)

set @StartDate = isnull(@StartDate, '')

return @StartDate
-- comment: sp_password
end
go

-- print dbo.GetARTStartDate('07022064')
-- print dbo.GetARTStartDate('125516')
-- print dbo.GetARTStartDate('4480/10')

--------Function GetDurationStartART-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDurationStartART')
drop function GetDurationStartART
go

create function GetDurationStartART(@PatientNo varchar(20), @VisitDate smalldatetime) returns int
with encryption as

begin

declare @DurationStartART int
declare @TransferredInARTCategoryID varchar(10)
declare @StartingARTCategoryID varchar(10)

set @StartingARTCategoryID = dbo.GetLookupDataID('ARTCategory', 'STA')
set @TransferredInARTCategoryID = dbo.GetLookupDataID('ARTCategory', 'REF')

set @DurationStartART =	(select top 1 datediff(month, StartDate, @VisitDate) from ARTRegimen
		inner join Visits on ARTRegimen.VisitNo = Visits.VisitNo
		where (Visits.PatientNo = @PatientNo) and 
		(ARTCategoryID = @StartingARTCategoryID or ARTCategoryID = @TransferredInARTCategoryID)
		order by StartDate asc)

return @DurationStartART

end
go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetDurationStartART('2381/07/08', 'Jun 23 2011')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetMainMemberDependantsTotal----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetMainMemberDependantsTotal')
drop function GetMainMemberDependantsTotal
go

create function GetMainMemberDependantsTotal( @MainMemberNo varchar(20)) returns int
with encryption as
begin 
declare @Total int
declare @DependantMemberTypeID varchar(10)

set @DependantMemberTypeID = dbo.GetLookupDataID('MemberType', '02')
begin
set @Total = (select count(MainMemberNo) as MainMemberNo from SchemeMembers
where MainMemberNo = @MainMemberNo and MemberTypeID = @DependantMemberTypeID)
end
set @Total = isnull(@Total, 0)
return @Total
end
go

-----------------------------------------------------------------------------------------------------------------
------ print dbo.GetMainMemberDependantsTotal ('14000300')
-----------------------------------------------------------------------------------------------------------------

--------Function GetDurationCurrentART-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDurationCurrentART')
drop function GetDurationCurrentART
go

create function GetDurationCurrentART(@PatientNo varchar(20), @VisitDate smalldatetime) returns int
with encryption as

begin

declare @DurationCurrentART int
declare @ARTStatusID varchar(10)

set @ARTStatusID = dbo.GetLookupDataID('ARTStatus', 'O')

set @DurationCurrentART = (select top 1 datediff(month, StartDate, @VisitDate) from ARTRegimen
		inner join Visits on ARTRegimen.VisitNo = Visits.VisitNo
		where (Visits.PatientNo = @PatientNo) and (ARTStatusID = @ARTStatusID)
		order by StartDate desc)

return @DurationCurrentART

end
go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetDurationCurrentART('1133/06', 'Jun 23 2011')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetPatientNo---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPatientNo')
drop function GetPatientNo
go

create function GetPatientNo(@VisitNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @PatientNo varchar(20)

begin
set @PatientNo = (select Top 1 PatientNo from Visits 
		where VisitNo = @VisitNo order by RecordDateTime desc)
set @PatientNo = isnull(@PatientNo, '')
end

return @PatientNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetPatientNo('150065003')
-- print dbo.GetPatientNo(null)
----------------------------------------------------------------------------------------------------------------------------


--------Function GetAdmissionNo---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAdmissionNo')
drop function GetAdmissionNo
go

create function GetAdmissionNo(@VisitNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @AdmissionNo varchar(20)

begin
set @AdmissionNo = (select top 1 AdmissionNo from Admissions 
		where VisitNo = @VisitNo order by AdmissionDateTime desc)
set @AdmissionNo = isnull(@AdmissionNo, '')
end

return @AdmissionNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetAdmissionNo('07022066001')
-- print dbo.GetAdmissionNo(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetRoundNo-------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetRoundNo')
drop function GetRoundNo
go

create function GetRoundNo(@SpecimenNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @RoundNo varchar(20)

begin
set @RoundNo = (select RoundNo from LabRequestsIPD where SpecimenNo = @SpecimenNo)
set @RoundNo = isnull(@RoundNo, '')
end

return @RoundNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetRoundNo('110223102')
-- print dbo.GetRoundNo(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function Get Round VisitNo-------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetRoundVisitNo')
drop function GetRoundVisitNo
go

create function GetRoundVisitNo(@RoundNo varchar(20)) returns varchar(20)
with encryption as

begin
declare @VisitNo varchar(20)
begin

set @VisitNo =(select Top 1 VisitNo from IPDDoctor
inner join Admissions on Admissions.AdmissionNo =IPDDoctor.AdmissionNo where RoundNo =@RoundNo)

end
return @VisitNo
end

go

--------Function GetExtraBillRoundNo-------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetExtraBillRoundNo')
drop function GetExtraBillRoundNo
go

create function GetExtraBillRoundNo(@ExtraBillNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @RoundNo varchar(20)

begin
set @RoundNo = (select RoundNo from ExtraBillsEXT where ExtraBillNo = @ExtraBillNo)
set @RoundNo = isnull(@RoundNo, '')
end

return @RoundNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetExtraBillRoundNo('101161802')
-- print dbo.GetExtraBillRoundNo(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetAttendingDoctorNo---------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAttendingDoctorNo')
drop function GetAttendingDoctorNo
go

create function GetAttendingDoctorNo(@RoundNo varchar(20)) returns varchar(10)
with encryption as

begin

declare @AttendingDoctorNo varchar(10)

begin
set @AttendingDoctorNo = (select StaffNo from IPDDoctor where RoundNo = @RoundNo)
set @AttendingDoctorNo = isnull(@AttendingDoctorNo, '')
end

return @AttendingDoctorNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetAttendingDoctorNo('10148040101')
-- print dbo.GetAttendingDoctorNo(null)
------------------------------------------------------------------------------------------------------------------------------

--------Function GetVisitPackageNo-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetVisitPackageNo')
drop function GetVisitPackageNo
go

create function GetVisitPackageNo(@VisitNo varchar(20)) returns varchar(20)
with encryption as

begin

declare @PackageNo varchar(100)

set @PackageNo = (select top 1 PackageNo from Visits where VisitNo =@VisitNo)
set @PackageNo = isnull(@PackageNo, '')

return @PackageNo

end
go
----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetVisitPackageNo('00213/16004')
-- print dbo.GetVisitPackageNo('SR170176001')


--------Function GetAttendingDoctor-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAttendingDoctor')
drop function GetAttendingDoctor
go

create function GetAttendingDoctor(@RoundNo varchar(20)) returns varchar(41)
with encryption as

begin

declare @AttendingDoctor varchar(41)

begin
set @AttendingDoctor = (select dbo.GetStaffName(StaffNo) from IPDDoctor where RoundNo = @RoundNo)
set @AttendingDoctor = isnull(@AttendingDoctor, '')
end

return @AttendingDoctor

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetAttendingDoctor('10148040101')
-- print dbo.GetAttendingDoctor(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetLastSeenDoctor-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetLastSeenDoctor')
drop function GetLastSeenDoctor
go

create function GetLastSeenDoctor(@VisitNo varchar(20), @RoundNo varchar(20)) returns varchar(41)
with encryption as

begin

declare @LastSeenDoctor varchar(41)

if (@RoundNo is null or @RoundNo = '')
begin set @LastSeenDoctor = dbo.GetDoctorFullName(@VisitNo) end
else begin set @LastSeenDoctor = dbo.GetAttendingDoctor(@RoundNo) end
	
set @LastSeenDoctor = isnull(@LastSeenDoctor, '')
return @LastSeenDoctor

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetLastSeenDoctor('', '10148040101')
-- print dbo.GetLastSeenDoctor('104566010', '1045660203')
-- print dbo.GetLastSeenDoctor(null, null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetTotalIPDDoctorRounds--------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalIPDDoctorRounds')
drop function GetTotalIPDDoctorRounds
go

create function GetTotalIPDDoctorRounds(@AdmissionNo varchar(20)) returns int
with encryption as

begin

declare @TotalIPDDoctorRounds int

set @TotalIPDDoctorRounds = (select count(AdmissionNo) from IPDDoctor where AdmissionNo = @AdmissionNo)
set @TotalIPDDoctorRounds = isnull(@TotalIPDDoctorRounds, 0)

return @TotalIPDDoctorRounds

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetTotalIPDDoctorRounds('101315401')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetLastRoundDateTime--------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetLastRoundDateTime')
drop function GetLastRoundDateTime
go

create function GetLastRoundDateTime(@AdmissionNo varchar(20)) returns smalldatetime
with encryption as

begin
declare @LastRoundDateTime smalldatetime
select @LastRoundDateTime = MAX(RoundDateTime) from IPDDoctor where AdmissionNo = @AdmissionNo
return @LastRoundDateTime
end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetLastRoundDateTime('T020098JK')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetHasAlternateDrugs---------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasAlternateDrugs')
drop function GetHasAlternateDrugs
go

create function GetHasAlternateDrugs(@DrugNo varchar(20)) returns bit
with encryption as
begin

declare @HasAlternateDrugs bit

if exists (select DrugNo from AlternateDrugs where DrugNo = @DrugNo)
set @HasAlternateDrugs = 1
else set @HasAlternateDrugs = 0

return @HasAlternateDrugs

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetHasAlternateDrugs('A002')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetDentalCategory-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetDentalCategory')
drop function GetDentalCategory
go

create function GetDentalCategory(@DentalCode varchar(10)) returns varchar(100)
with encryption as

begin

declare @DentalCategory varchar(100)

set @DentalCategory = (select dbo.GetLookupDataDes(DentalCategoryID) 
		from DentalServices where DentalCode = @DentalCode)

set @DentalCategory = isnull(@DentalCategory, '')

return @DentalCategory

end
go

-- print dbo.GetDentalCategory('D001X')
-- print dbo.GetDentalCategory('8.5')

--------Function GetPathologyCategory-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPathologyCategory')
drop function GetPathologyCategory
go

create function GetPathologyCategory(@ExamCode varchar(10)) returns varchar(100)
with encryption as

begin

declare @PathologyCategory varchar(100)

set @PathologyCategory = (select dbo.GetLookupDataDes(PathologyCategoriesID) 
		from PathologyExaminations where ExamCode = @ExamCode)

set @PathologyCategory = isnull(@PathologyCategory, '')

return @PathologyCategory

end
go

-- print dbo.GetPathologyCategory('CT08')
-- print dbo.GetPathologyCategory('R010')



--------Function GetCardiologyCategory-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetCardiologyCategory')
drop function GetCardiologyCategory
go

create function GetCardiologyCategory(@ExamCode varchar(10)) returns varchar(100)
with encryption as

begin

declare @CardiologyCategory varchar(100)

set @CardiologyCategory = (select dbo.GetLookupDataDes(CardiologyCategoriesID) 
		from CardiologyExaminations where ExamCode = @ExamCode)

set @CardiologyCategory = isnull(@CardiologyCategory, '')

return @CardiologyCategory

end
go

-- print dbo.GetCardiologyCategory('CT08')
-- print dbo.GetCardiologyCategory('R010')


--------Function GetRadiologyCategory-----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetRadiologyCategory')
drop function GetRadiologyCategory
go

create function GetRadiologyCategory(@ExamCode varchar(10)) returns varchar(100)
with encryption as

begin

declare @RadiologyCategory varchar(100)

set @RadiologyCategory = (select dbo.GetLookupDataDes(RadiologyCategoriesID) 
		from RadiologyExaminations where ExamCode = @ExamCode)

set @RadiologyCategory = isnull(@RadiologyCategory, '')

return @RadiologyCategory

end
go

-- print dbo.GetRadiologyCategory('CT08')
-- print dbo.GetRadiologyCategory('R010')



--------Function GetItemsLastUpdate ------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetItemsLastUpdate')
drop function GetItemsLastUpdate
go

create function GetItemsLastUpdate(@VisitNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns smalldatetime
with encryption as

begin

declare @LastUpdate smalldatetime

begin
set @LastUpdate = (select LastUpdate from Items where VisitNo = @VisitNo 
		and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)	
end

return @LastUpdate

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetItemsLastUpdate('001002', 'M603', '7D')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetItemsLoginID ------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetItemsLoginID')
drop function GetItemsLoginID
go

create function GetItemsLoginID(@VisitNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns varchar(20)
with encryption as

begin

declare @LoginID varchar(20)

begin
set @LoginID = (select LoginID from Items where VisitNo = @VisitNo 
		and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)	
end

return @LoginID

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetItemsLoginID('001002', 'M603', '7D')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetIPDItemsLastUpdate ------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDItemsLastUpdate')
drop function GetIPDItemsLastUpdate
go

create function GetIPDItemsLastUpdate(@RoundNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns smalldatetime
with encryption as

begin

declare @LastUpdate smalldatetime

begin
set @LastUpdate = (select LastUpdate from IPDItems where RoundNo = @RoundNo 
		and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)	
end

return @LastUpdate

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetIPDItemsLastUpdate('001002', 'M603', '7D')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetIPDItemsLoginID ------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDItemsLoginID')
drop function GetIPDItemsLoginID
go

create function GetIPDItemsLoginID(@RoundNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns varchar(20)
with encryption as

begin

declare @LoginID varchar(20)

begin
set @LoginID = (select LoginID from IPDItems where RoundNo = @RoundNo 
		and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)	
end

return @LoginID

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetIPDItemsLoginID('001002', 'M603', '7D')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetAdministeredIPDDrugs----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAdministeredIPDDrugs')
drop function GetAdministeredIPDDrugs
go

create function GetAdministeredIPDDrugs(@RoundNo varchar(20), @ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @Total int

set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')

if (@ItemCategoryID = @DrugID)-- Drugs
begin 	
if not(@RoundNo is null or @RoundNo = '') 
begin set @Total = (select sum(QuantityTaken)  from IPDDrugAdministration
inner join IPDNurse on IPDNurse.NurseRoundNo = IPDDrugAdministration.NurseRoundNo
where IPDNurse.RoundNo = @RoundNo and ItemCategoryID = @DrugID and ItemCode = @ItemCode)
end
end
else if (@ItemCategoryID = @ConsumableID)-- ConsumableItems
begin 	
if not(@RoundNo is null or @RoundNo = '') 
begin set @Total = (select sum(QuantityTaken) as QuantityTaken from IPDDrugAdministration
inner join IPDNurse on IPDNurse.NurseRoundNo = IPDDrugAdministration.NurseRoundNo
where IPDNurse.RoundNo = @RoundNo and ItemCategoryID = @ConsumableID and ItemCode = @ItemCode)
end	
end

set @Total = isnull(@Total, 0)

return @Total
end
go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetAdministeredIPDDrugs('1600006301020', '7D', 'M0017')
-- print dbo.GetAdministeredIPDDrugs('1600006301015', '7D', 'M256')
----------------------------------------------------------------------------------------------------------------------------


--------Function GetFileReturned------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetFileReturned')
drop function GetFileReturned
go

create function GetFileReturned(@OutwardNo varchar(20)) returns bit
with encryption as
begin

declare @FileReturned bit

if exists (select TOP 1 OutwardNo from InwardFiles where OutwardNo = @OutwardNo)
set @FileReturned = 1
else set @FileReturned = 0

return @FileReturned

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetFileReturned('1402063001')
-- print dbo.GetFileReturned('1402063002')
----------------------------------------------------------------------------------------------------------------------------
--------Function GetFileReturnedBy ------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetFileReturnedBy')
drop function GetFileReturnedBy
go

create function GetFileReturnedBy(@FileNo varchar(20)) returns bit
with encryption as
begin

declare @FileReturned bit

if exists (SELECT OutwardFiles.OutwardNo
FROM OutwardFiles
LEFT JOIN InwardFiles  ON InwardFiles.OutwardNo = OutwardFiles.OutwardNo
WHERE InwardFiles.OutwardNo IS NULL AND FileNo = @FileNo)
set @FileReturned = 1
else set @FileReturned = 0

return @FileReturned

end

go
----------------------------------------------------------------------------------------------------------------------------
---print dbo.GetFileReturnedBy('1301094')


----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetFileReturnedByName')
drop function GetFileReturnedByName
go

create function GetFileReturnedByName(@FileNo varchar(20)) returns varchar(100)
with encryption as
begin

declare @FileReturnedByName varchar(100)

set @FileReturnedByName = (select Top 1  BillAccountName from OutwardFiles  where FileNo = @FileNo)
set @FileReturnedByName = isnull(@FileReturnedByName, '')

return @FileReturnedByName

end

go
----------------------------------------------------------------------------------------------------------------------------

----print dbo.GetFileReturnedByName('1301094')


--------Function GetConsumedQuantity----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetConsumedQuantity')
drop function GetConsumedQuantity
go

create function GetConsumedQuantity(@ExtraBillNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns int
with encryption as

begin

declare @DispensedQuantity int
declare @Balance int

----------------------------------------------------------------------------------------------------------------
set @DispensedQuantity = (select Quantity from ExtraBillItems
where ExtraBillNo = @ExtraBillNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	
set @DispensedQuantity = isnull(@DispensedQuantity, 0)


return @DispensedQuantity

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetConsumedQuantity('140123103', 'M1067', '7D')
-- print dbo.GetConsumedQuantity('140123103', 'M0279', '7D')

-------
--------Function GetConsumedItemQuantity----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetConsumedItemQuantity')
drop function GetConsumedItemQuantity
go

create function GetConsumedItemQuantity(@VisitNo varchar(20), @ItemCode varchar(20), @ItemCategoryID varchar(10)) returns int
with encryption as

begin

declare @DispensedQuantity int

----------------------------------------------------------------------------------------------------------------
set @DispensedQuantity = (select Quantity from Items
where VisitNo = @VisitNo and ItemCode = @ItemCode and ItemCategoryID = @ItemCategoryID)
	
set @DispensedQuantity = isnull(@DispensedQuantity, 0)

----------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------

return @DispensedQuantity

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetConsumedItemQuantity('1300003003',	'M111', '7D')
-- print dbo.GetConsumedItemQuantity('1300003003',	'M158', '7D')
-- print dbo.GetConsumedItemQuantity('1300003003', 'M141', '7D')
----------------------------------------------------------------------------------------------------------------------------




--------Function GetIsPatientActive-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIsPatientActive')
drop function GetIsPatientActive
go

create function GetIsPatientActive(@PatientNo varchar(20)) returns bit
with encryption as

begin

declare @IsPatientActive bit

if exists (select PatientNo from Patients where PatientNo = @PatientNo and StatusID = dbo.GetLookupDataID('Status', 'A'))
set @IsPatientActive = 1
else set @IsPatientActive = 0

return @IsPatientActive

end
go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetIsPatientActive('1400897')
----------------------------------------------------------------------------------------------------------------------------

--------Function GetAdmissionLocation-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAdmissionLocation')
drop function GetAdmissionLocation
go

create function GetAdmissionLocation(@VisitNo varchar(20)) returns varchar(200)
with encryption as

begin

declare @AdmissionLocation varchar(200)

set @AdmissionLocation = (select top 1 dbo.GetLookupDataDes(WardsID) + ' => ' + RoomName + ' => ' + BedName as AdmissionLocation 
from Admissions inner join Beds on Admissions.BedNo = Beds.BedNo inner join Rooms on Beds.RoomNo = Rooms.RoomNo
where VisitNo = @VisitNo)
	
set @AdmissionLocation = isnull(@AdmissionLocation, '')
return @AdmissionLocation

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetAdmissionLocation('104566010')
-- print dbo.GetAdmissionLocation(104566008)
----------------------------------------------------------------------------------------------------------------------------


-------------------------Get Patient Appointments Details-----------------------------------------------

if exists (select * from sysobjects where name = 'GetPatientAppointmentsDetails')
drop function GetPatientAppointmentsDetails
go

create function GetPatientAppointmentsDetails (@PatientNo varchar(20)) returns varchar(600)
with encryption as
begin
declare @appDetails varchar(600)
SET @appDetails = (SELECT TOP 1 AppointmentDes FROM Appointments WHERE PatientNo =@PatientNo
ORDER BY RecordDateTime DESC)
set @appDetails = isnull(@appDetails, '')
return @appDetails
end
go
--print dbo.GetPatientAppointmentsDetails('1501087')

-----------------------------------------------------------------------------------------------------

-------------------------Get Patient Visit Date-----------------------------------------------

if exists (select * from sysobjects where name = 'GetPatientVisitDate')
drop function GetPatientVisitDate
go

create function GetPatientVisitDate (@VisitNo varchar(20)) returns date
with encryption as
begin
declare @VisitDate date
SET @VisitDate = (select VisitDate  from Visits 
where VisitNo =@VisitNo)
return @VisitDate
end
go

--print dbo.GetPatientVisitDate('11304446001')
-------select  Top 5 * from Visits
------------------------------------------------------------------------------------------------------


-------------------------Get Patient Appointments Date-----------------------------------------------

if exists (select * from sysobjects where name = 'GetPatientAppointmentsDate')
drop function GetPatientAppointmentsDate
go

create function GetPatientAppointmentsDate (@PatientNo varchar(20)) returns date
with encryption as
begin
declare @appDate date
SET @appDate = (SELECT TOP 1 cast(EndDate as date) FROM Appointments WHERE PatientNo =@PatientNo
ORDER BY RecordDateTime DESC)
--set @appDate = isnull(@appDate, '')
return @appDate
end
go

--print dbo.GetPatientAppointmentsDate('1501087')

------------------------------------------------------------------------------------------------------

--------Function GetMemberLimit-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetMemberLimit')
drop function GetMemberLimit
go

create function GetMemberLimit(@MedicalCardNo varchar(20), @AccountNo varchar(20), @BenefitCode varchar(20)) returns money
with encryption as

begin

declare @MemberLimit money
--------------------------------------------------------------------------------------------------------------------------
set @MemberLimit = (select MemberLimit from MemberLimits
	inner join BillCustomerMembers on BillCustomerMembers.MedicalCardNo = MemberLimits.MedicalCardNo
	and BillCustomerMembers.AccountNo = MemberLimits.AccountNo
	where MemberLimits.MedicalCardNo = @MedicalCardNo 
	and MemberLimits.AccountNo = @AccountNo and BenefitCode = @BenefitCode) 

set @MemberLimit = isnull(@MemberLimit, 0.00)
--------------------------------------------------------------------------------------------------------------------------

return @MemberLimit

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetMemberLimit('0503666501', 'CM00455', '7D'))
-- print dbo.FormatMoney(dbo.GetMemberLimit('0503666501', 'A130176', '7H'))
----------------------------------------------------------------------------------------------------------------------------

--------Function GetPolicyLimit---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPolicyLimit')
drop function GetPolicyLimit
go

create function GetPolicyLimit(@MedicalCardNo varchar(20), @BenefitCode varchar(20)) returns money
with encryption as

begin

declare @CompanyNo varchar(20)
declare @PolicyNo varchar(20)

declare @PolicyLimit money
---------------------------------------------------------------------------------------------------------
set @CompanyNo = (select CompanyNo from SchemeMembers where MedicalCardNo = @MedicalCardNo)
set @PolicyNo = (select PolicyNo from SchemeMembers where MedicalCardNo = @MedicalCardNo)

---------------------------------------------------------------------------------------------------------
set @PolicyLimit = (select PolicyLimit from PolicyLimits
	where CompanyNo = @CompanyNo and PolicyNo = @PolicyNo and BenefitCode = @BenefitCode) 

set @PolicyLimit = isnull(@PolicyLimit, 0.00)
---------------------------------------------------------------------------------------------------------

return @PolicyLimit

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetPolicyLimit('DDA97/2', '7N'))
-- print dbo.FormatMoney(dbo.GetPolicyLimit('RAS03', '7O'))
----------------------------------------------------------------------------------------------------------------------------

--------Function GetPolicyConsumedAmount---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetPolicyConsumedAmount')
drop function GetPolicyConsumedAmount
go

create function GetPolicyConsumedAmount(@MedicalCardNo varchar(20), @BenefitCode varchar(20)) returns money
with encryption as

begin

declare @PolicyStartDate smalldatetime
declare @PolicyEndDate smalldatetime

declare @PolicyConsumedAmount money
---------------------------------------------------------------------------------------------------------
set @PolicyStartDate = (select PolicyStartDate from SchemeMembers where MedicalCardNo = @MedicalCardNo)
set @PolicyEndDate = (select PolicyEndDate from SchemeMembers where MedicalCardNo = @MedicalCardNo)

---------------------------------------------------------------------------------------------------------
set @PolicyConsumedAmount = (select Sum(Amount) from ClaimDetails
			inner join Claims on ClaimDetails.ClaimNo = Claims.ClaimNo
			where MedicalCardNo = @MedicalCardNo and BenefitCode = @BenefitCode
			and VisitDate between @PolicyStartDate and @PolicyEndDate) 

set @PolicyConsumedAmount = isnull(@PolicyConsumedAmount, 0.00)
---------------------------------------------------------------------------------------------------------

return @PolicyConsumedAmount

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetPolicyConsumedAmount('DDA97/2', '7S'))
-- print dbo.FormatMoney(dbo.GetPolicyConsumedAmount('RAS03', '7T'))
-- print dbo.FormatMoney(dbo.GetPolicyConsumedAmount('IDI215/1', '7S'))
----------------------------------------------------------------------------------------------------------------------------

--------Function GetIPDVisitNo----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDVisitNo')
drop function GetIPDVisitNo
go

create function GetIPDVisitNo(@RoundNo varchar(20)) returns varchar(20)
with encryption as
begin
declare @VisitNo varchar(20)
begin
set @VisitNo = (select TOP 1 Visits.VisitNo from IPDItems
inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
inner join Visits on Admissions.VisitNo = Visits.VisitNo
where IPDItems.RoundNo = @RoundNo)
	
set @VisitNo = isnull(@VisitNo, '')
	
end

return @VisitNo

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetIPDVisitNo('161469701002')
-- print dbo.GetIPDVisitNo('160994603003')
-- print dbo.GetIPDVisitNo(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetVisitsBranchID----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetVisitsBranchID')
drop function GetVisitsBranchID
go

create function GetVisitsBranchID(@VisitNo varchar(20)) returns varchar(10)
with encryption as
begin
declare @BranchID varchar(10)
begin
set @BranchID = (select BranchID from Visits
where VisitNo = @VisitNo)
set @BranchID = isnull(@BranchID, '')
	
end

return @BranchID

end

go

--------Function GetMyCurrentBranch----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetMyCurrentBranch')
drop function GetMyCurrentBranch
go

create function GetMyCurrentBranch(@LoginID varchar(20)) returns varchar(10)
with encryption as
begin
declare @BranchID varchar(10)
declare @DefaultBranchID varchar(10)
begin
set @DefaultBranchID = dbo.GetLookupDataID('BranchName', 'NA')
set @BranchID = (select TOP 1 LocationID from StaffLocations where StaffLoginID = @LoginID Order by RecordDateTime Desc)
	
set @BranchID = isnull(@BranchID, @DefaultBranchID)
	
end
return @BranchID
end

go
----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetMyCurrentBranch('Admin')
-- print dbo.GetMyCurrentBranch(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetWardName----------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetWardName')
drop function GetWardName
go

create function GetWardName(@BedNo varchar(20)) returns varchar(100)
with encryption as

begin

declare @WardName varchar(100)

begin
set @WardName = (select dbo.GetLookupDataDes(WardsID) from Beds 
	inner join Rooms on Beds.RoomNo = Rooms.RoomNo where BedNo = @BedNo)
set @WardName = isnull(@WardName, '')
end

return @WardName

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetWardName('10')
-- print dbo.GetWardName('WING D 1')
-- print dbo.GetWardName(null)
----------------------------------------------------------------------------------------------------------------------------


--------Function GetWardInitial---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetWardInitial')
drop function GetWardInitial
go

create function GetWardInitial(@WardName varchar(100)) returns varchar(1)
with encryption as

begin

declare @Nursery varchar(100)
declare @Neonatal varchar(100)
declare @Medical varchar(100)
declare @Surgical varchar(100)
declare @Children varchar(100)
declare @Child varchar(100)
declare @Paediatric varchar(100)
declare @Maternity varchar(100)
declare @Labour varchar(100)

declare @WardInitial as varchar(1)

set @Nursery = dbo.GetLookupDataDes(dbo.GetLookupDataID('CustomAdmissionNoWards', 'N01'))
set @Neonatal = dbo.GetLookupDataDes(dbo.GetLookupDataID('CustomAdmissionNoWards', 'N02'))
set @Medical = dbo.GetLookupDataDes(dbo.GetLookupDataID('CustomAdmissionNoWards', 'H01'))
set @Surgical = dbo.GetLookupDataDes(dbo.GetLookupDataID('CustomAdmissionNoWards', 'H02'))
set @Children = dbo.GetLookupDataDes(dbo.GetLookupDataID('CustomAdmissionNoWards', 'H03'))
set @Child = dbo.GetLookupDataDes(dbo.GetLookupDataID('CustomAdmissionNoWards', 'H04'))
set @Paediatric = dbo.GetLookupDataDes(dbo.GetLookupDataID('CustomAdmissionNoWards', 'H05'))
set @Maternity = dbo.GetLookupDataDes(dbo.GetLookupDataID('CustomAdmissionNoWards', 'M01'))
set @Labour = dbo.GetLookupDataDes(dbo.GetLookupDataID('CustomAdmissionNoWards', 'M02'))

begin
	
if exists(select DataDes from LookupData where ObjectID = dbo.GetLookupObjectID('CustomAdmissionNoWards') 
and (charindex(DataDes, @WardName) > 0) and (DataDes = @Nursery or DataDes = @Neonatal))
begin set @WardInitial = 'N' end

else if exists(select DataDes from LookupData where ObjectID = dbo.GetLookupObjectID('CustomAdmissionNoWards') 
and (charindex(DataDes, @WardName) > 0) and (DataDes = @Maternity or DataDes = @Labour))
begin set @WardInitial = 'M' end

else begin set @WardInitial = 'H' end

set @WardInitial = isnull(@WardInitial, '')
end

return @WardInitial

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetWardInitial('Labour Ward')
-- print dbo.GetWardInitial('Nursery')
-- print dbo.GetWardInitial('Children''s Ward')
-- print dbo.GetWardInitial(null)
----------------------------------------------------------------------------------------------------------------------------

--------Function GetStaffFullNameWithLoginID---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetStaffFullNameWithLoginID')
drop function GetStaffFullNameWithLoginID
go

create function GetStaffFullNameWithLoginID(@LoginID varchar(20)) returns varchar(40)
with encryption as

begin

declare @StaffFullName varchar(40)

begin
set @StaffFullName = (select dbo.GetFullName(LastName,'',FirstName) as FullName from Logins WHERE LoginID = @LoginID)
set @StaffFullName = isnull(@StaffFullName, '')
end

return @StaffFullName
end
go

----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetStaffFullNameWithLoginID('allan')
----------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------
------------- Views ----------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------

------------ CancerAndNormalDiagnosis  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'CancerAndNormalDiagnosis')
drop view CancerAndNormalDiagnosis
go

create view CancerAndNormalDiagnosis
with encryption 
as 
select Patients.PatientNo,CancerDiagnosis.VisitNo ,ReferenceNo, FirstName, LastName, MiddleName, BirthDate, 	
dbo.GetAge(BirthDate, getdate()) as Age, 
dbo.GetAgeInMonths(BirthDate, getdate()) as AgeInMonths, 
dbo.GetAgeInDays(BirthDate, getdate()) as AgeInDays, 
dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, 
GenderID, dbo.GetLookupDataDes(GenderID) as Gender ,VisitDate
,Diagnosis.DiseaseCode, Diseases.DiseaseName, DiseaseCategoriesID, 
dbo.GetLookupDataDes(DiseaseCategoriesID) as DiseaseCategories, Diagnosis.Notes As DiagnosisNotes,	 
CancerDiseases.DiseaseNo, TopologySites.TopographicalNo, 
BasisOfDiagnosisID, dbo.GetLookupDataDes(BasisOfDiagnosisID) as BasisOfDiagnosis
,CancerStageID, dbo.GetLookupDataDes(CancerStageID) as CancerStage, CancerDiagnosis.Notes As CancerDiagnosisNotes,
CancerDiagnosis.DiseaseNo As CancerDiagnosisDiseaseCode
,CancerDiseaseCategoriesID, dbo.GetLookupDataDes(CancerDiseaseCategoriesID) as CancerDiseaseCategories,
CancerDiagnosis.RecordDateTime As CancerRecordDateTime,HideDetails
from CancerDiagnosis 
inner join Visits on CancerDiagnosis.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo
inner join Diagnosis on CancerDiagnosis.VisitNo = Diagnosis.VisitNo
inner join Diseases on Diagnosis.DiseaseCode = Diseases.DiseaseCode
inner join CancerDiseases on CancerDiagnosis.DiseaseNo = CancerDiseases.DiseaseNo
inner join TopologySites on CancerDiagnosis.TopographicalNo = TopologySites.TopographicalNo
--where VisitNo = @VisitNo
go

-- select * from CancerAndNormalDiagnosis

--------DiagnosisOccurances------------------------------------------------------------------------------------------


if exists (select * from sysobjects where name = 'DiagnosisOccurances')
drop view DiagnosisOccurances
go

create view DiagnosisOccurances
with encryption 
as
 
SELECT ROW_NUMBER() OVER (PARTITION BY Diagnosis.DiseaseCode,visits.PatientNo Order by Diagnosis.RecordDateTime) AS Occurances,
visits.PatientNo,DiseaseCode,Diagnosis.RecordDateTime as RecordDate 
FROM Diagnosis
inner JOIN Visits oN Diagnosis.VisitNo =visits.VisitNo
go


--------Function GetHasDiagnosisReoccurance------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasDiagnosisReoccurance')
drop function GetHasDiagnosisReoccurance
go

create function GetHasDiagnosisReoccurance(@PatientNo varchar(20),@DiseaseCode varchar(20)) returns bit
with encryption as
begin
declare @Occurance int
declare @HasDiagnosisReoccurance bit

Set @Occurance=(select max (Occurances) from DiagnosisOccurances where PatientNo = @PatientNo and DiseaseCode=@DiseaseCode
and RecordDate between (DATEADD(dd, -30, RecordDate)) and RecordDate)


if @Occurance ='1'
set @HasDiagnosisReoccurance = 0
else if @Occurance is null or @Occurance =''
set @HasDiagnosisReoccurance = 0
else set @HasDiagnosisReoccurance = 1
return @HasDiagnosisReoccurance

end

go

---------------------------------------------------------------------------------------------------------------------
-- print dbo.GetHasDiagnosisReoccurance('1489183','A0100-212')
---------------------------------------------------------------------------------------------------------------------


------------ AllLocations  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'AllLocations')
drop view AllLocations
go

create view AllLocations
with encryption 
as 
select DataID, ObjectID, DataDes
from LookupData
where IsHidden='N' and (ObjectID = 117 or ObjectID=189)
go


----------------------------------------------------------------------------------------------------------------------------
-- print dbo.GetHasDiagnosisReoccurance('170153','D105','170153004')
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'AllBillableItems')
drop view AllBillableItems
go

create view AllBillableItems
with encryption 
as

select DrugNo as ItemCode, DrugName as ItemName,'7D' as ItemCategoryID, dbo.GetLookupDataDes('7D') as ItemCategory,
	  UnitCost,UnitPrice,'7D' as RevenueStream from Drugs
union
select ConsumableNo as ItemCode, ConsumableName as ItemName,'7C' as ItemCategoryID, dbo.GetLookupDataDes('7C') as ItemCategory,
	  UnitCost,UnitPrice,'7C' as RevenueStream from ConsumableItems
union
select ProcedureCode as ItemCode, ProcedureName as ItemName,'7P' as ItemCategoryID, dbo.GetLookupDataDes('7P') as ItemCategory,
	  0 as UnitCost,UnitPrice,'7P' as RevenueStream from Procedures
union
Select TestCode as ItemCode, TestName as ItemName,'7T' as ItemCategoryID, dbo.GetLookupDataDes('7T') as ItemCategory,
	  UnitCost,TestFee,'7T' as RevenueStream from LabTests
union
select ExamCode as ItemCode, ExamName as ItemName,'7R' as ItemCategoryID, dbo.GetLookupDataDes('7R') as ItemCategory,
	  0 as UnitCost,UnitPrice,'7R' as RevenueStream from RadiologyExaminations
union
select DentalCode as ItemCode, DentalName as ItemName,'7N' as ItemCategoryID, dbo.GetLookupDataDes('7N') as ItemCategory,
	  0 as UnitCost,UnitPrice,'7N' as RevenueStream from DentalServices
union
select ServiceCode as ItemCode, ServiceName as ItemName,'7S' as ItemCategoryID, dbo.GetLookupDataDes('7S') as ItemCategory,
	  UnitCost,StandardFee,RevenueStreamCode as RevenueStream from Services
union
select TheatreCode as ItemCode, TheatreName as ItemName,'7H' as ItemCategoryID, dbo.GetLookupDataDes('7H') as ItemCategory,
	  0 as UnitCost,UnitPrice,'7H' as RevenueStream from TheatreServices
union
select OpticalCode as ItemCode, OpticalName as ItemName,'7O' as ItemCategoryID, dbo.GetLookupDataDes('7O') as ItemCategory,
	  UnitCost,UnitPrice,'7O' as RevenueStream from OpticalServices
union
select MaternityCode as ItemCode, MaternityName as ItemName,'7M' as ItemCategoryID, dbo.GetLookupDataDes('7M') as ItemCategory,
	  0 as UnitCost,UnitPrice,'7M' as RevenueStream from MaternityServices
union
select ICUCode as ItemCode, ICUName as ItemName,'7I' as ItemCategoryID, dbo.GetLookupDataDes('7I') as ItemCategory,
	  0 as UnitCost,UnitPrice,'7I' as RevenueStream from ICUServices
union
select ExtraItemCode as ItemCode, ExtraItemName as ItemName,'7E' as ItemCategoryID, dbo.GetLookupDataDes('7E') as ItemCategory,
	  UnitCost,UnitPrice,RevenueStreamCode as RevenueStream from ExtraChargeItems
union
select EyeCode as ItemCode, EyeName as ItemName,'7Y' as ItemCategoryID, dbo.GetLookupDataDes('7Y') as ItemCategory,
	  UnitCost,UnitPrice,'7Y' as RevenueStream from EyeServices
union
select ExamCode as ItemCode, ExamName as ItemName,'7L' as ItemCategoryID, dbo.GetLookupDataDes('7L') as ItemCategory,
	 0 as UnitCost,UnitPrice,'7L' as RevenueStream from PathologyExaminations
union
select PackageNo as ItemCode, PackageName as ItemName,'7G' as ItemCategoryID, dbo.GetLookupDataDes('7G') as ItemCategory,
	  UnitCost,UnitPrice,RevenueStreamCode as RevenueStream from Packages
union
select ExamCode as ItemCode, ExamName as ItemName,'7CA' as ItemCategoryID, dbo.GetLookupDataDes('7CA') as ItemCategory,
	 0 as UnitCost, UnitPrice,'7CA' as RevenueStream from CardiologyExaminations
union
select ItemCode as ItemCode, ItemName, '7NM' as ItemCategoryID, dbo.GetLookupDataDes('7NM') as ItemCategory,
	 UnitCost, 0 as UnitPrice,'7NM' as RevenueStream from OtherItems
go





--------Function GetIsPatientOnPackage-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIsPatientOnPackage')
drop function GetIsPatientOnPackage
go

create function GetIsPatientOnPackage(@PatientNo varchar(20)) returns bit
with encryption as

begin

declare @PatientOnPackage bit

begin
if exists (select Top 1 PatientNo from PackageCheck where PatientNo = @PatientNo) 		
set @PatientOnPackage = 1
else set @PatientOnPackage = 0
end

return @PatientOnPackage

end

go
---------------------------------------------------------------------------------------------------------------------------
--------------------------print dbo.GetIsPatientOnPackage('SR17015ddd1')
---------------------------------------------------------------------------------------------------------------------------

------------ Accessed Services -----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'AccessedServices')
drop view AccessedServices
go

create view AccessedServices
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, ItemCode,ItemName,HideDetails, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor, 
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate,dbo.GetLookupDataDes(Visits.BranchID) as BranchName, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime
from Items 
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo	
where ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'S')
go

-- select * from AccessedServices

------------ Doctor  Laboratory  -------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DoctorLaboratory')
drop view DoctorLaboratory
go

create view DoctorLaboratory
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, ItemCode,ItemName, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor,	
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate,dbo.GetLookupDataDes(Visits.BranchID) as BranchName, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime,
Items.CreatorClientMachine as ItemCreatorMachine,Items.CreatorLoginID as CreatorLogin,HideDetails
from Items 
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo	
where ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'T')
go

-- select * from DoctorLaboratory
      
------------ Doctor  Prescription  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DoctorPrescription')
drop view DoctorPrescription
go

create view DoctorPrescription
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, CombinationOn, Items.ItemCode,ItemName, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor,	
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime,	
ItemsEXT.Dosage, ItemsEXT.Duration, ItemsEXT.DrQuantity, ItemsEXT.IssueDateTime, 
dbo.GetInventoryBalance(null, Items.ItemCategoryID, Items.ItemCode) as UnitsInStock, 
dbo.GetStaffName(Pharmacist) as Pharmacist, ItemsEXT.ClientMachine,dbo.GetLookupDataDes(Visits.BranchID) as BranchName,
dbo.GetLookupDataDes(ItemsEXT.LocationID) as Location,Items.CreatorClientMachine as ItemCreatorMachine,
Items.CreatorLoginID as CreatorLogin,HideDetails
from Items
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo
left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
where Items.ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
go

-- select * from DoctorPrescription


------------ IPDDoctorPrescription  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'IPDDoctorPrescription')
drop view IPDDoctorPrescription
go
create view IPDDoctorPrescription
with encryption 
as
select Visits.PatientNo as VisitsPatientNo ,Admissions.VisitNo as AdmissionsVisitNo,IPDDoctor.AdmissionNo,IPDItems.RoundNo,
IPDDoctor.StaffNo,VisitDate,Patients.LastName as LastName ,Patients.FirstName as FirstName,
Patients.MiddleName as MiddleName,GenderID, dbo.GetAge(Patients.BirthDate, getdate()) as Age,BirthDate,
RoundDateTime,VisitCategoryID,IPDItems.ItemCode,IPDItems.ItemCategoryID,Quantity,UnitCost,UnitPrice,
ItemDetails,ItemStatusID,PayStatusID,Admissions.InsuranceNo,Admissions.BillModesID ,Admissions.BillNo,LastUpdate,IPDItems.LoginID as IPDItemsLoginID,
IPDItems.ClientMachine As IPDItemsClientMachine,
IPDItems.RecordDateTime as IPDItemsRecordDateTime,CombinationOn,
IPDItemsEXT.Dosage, IPDItemsEXT.Duration, IPDItemsEXT.DrQuantity, IPDItemsEXT.IssueDateTime,
dbo.GetInventoryBalance(null, IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitsInStock, 
dbo.GetStaffName(Pharmacist) as Pharmacist, IPDItemsEXT.ClientMachine,dbo.GetLookupDataDes(IPDItemsEXT.LocationID) as Location,
dbo.GetLookupDataDes(Visits.BranchID) as BranchName,ItemName,HideDetails
from IPDItems 
inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
inner join Visits on Admissions.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo
left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
where IPDItems.ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
go

-- select * from IPDDoctorPrescription

    
------------ Doctor  Procedures  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DoctorProcedures')
drop view DoctorProcedures
go

create view DoctorProcedures
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, ItemCode,ItemName, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor,	
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate,dbo.GetLookupDataDes(Visits.BranchID) as BranchName, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime,
Items.CreatorClientMachine as ItemCreatorMachine,Items.CreatorLoginID as CreatorLogin,HideDetails
from Items 
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo		
where ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'P')
go

-- select * from DoctorProcedures



------------ Doctor  Cardiology  -------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DoctorCardiology')
drop view DoctorCardiology
go

create view DoctorCardiology
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, ItemCode,ItemName, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor, 
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate,dbo.GetLookupDataDes(Visits.BranchID) as BranchName, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime,
Items.CreatorClientMachine as ItemCreatorMachine,Items.CreatorLoginID as CreatorLogin,HideDetails
from Items 
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo	
where ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'CA')
go

-- select * from DoctorCardiology



------------ Doctor  Radiology  -------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DoctorRadiology')
drop view DoctorRadiology
go

create view DoctorRadiology
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, ItemCode,ItemName, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor, 
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate,dbo.GetLookupDataDes(Visits.BranchID) as BranchName, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime,
Items.CreatorClientMachine as ItemCreatorMachine,Items.CreatorLoginID as CreatorLogin,HideDetails
from Items 
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo	
where ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'R')
go

-- select * from DoctorRadiology

------------ Doctor  Pathology  -------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DoctorPathology')
drop view DoctorPathology
go

create view DoctorPathology
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, ItemCode,ItemName, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor, 
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate,dbo.GetLookupDataDes(Visits.BranchID) as BranchName, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime,HideDetails
from Items 
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo	
where ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'L')
go
-- select * from DoctorPathology

------------ Doctor  Theatre  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DoctorTheatre')
drop view DoctorTheatre
go

create view DoctorTheatre
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, ItemCode,ItemName, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor, 
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate,dbo.GetLookupDataDes(Visits.BranchID) as BranchName, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime,
Items.CreatorClientMachine as ItemCreatorMachine,Items.CreatorLoginID as CreatorLogin,HideDetails
from Items 
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo
where ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'H')
go

-- select * from DoctorTheatre

------------ Doctor  Dental  -------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DoctorDental')
drop view DoctorDental
go

create view DoctorDental
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, ItemCode, ItemName as DentalServiceName, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor, 
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate,dbo.GetLookupDataDes(Visits.BranchID) as BranchName, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime,
dbo.GetDentalCategory(ItemCode) as DentalCategory,HideDetails
from Items 
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo
where ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'N')
go

-- select * from DoctorDental

------------ Doctor  Eye  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DoctorEye')
drop view DoctorEye
go

create view DoctorEye
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, ItemCode,ItemName, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor,	
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate,dbo.GetLookupDataDes(Visits.BranchID) as BranchName, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime,HideDetails
from Items 
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo	
where ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'Y')
go

-- select * from DoctorEye

------------ Doctor  Optical  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DoctorOptical')
drop view DoctorOptical
go

create view DoctorOptical
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, ItemCode,ItemName, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor,	
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate,dbo.GetLookupDataDes(Visits.BranchID) as BranchName, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime,HideDetails
from Items 
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo	
where ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'O')
go

-- select * from DoctorOptical


------------ Doctor  Prescription  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DoctorConsumables')
drop view DoctorConsumables
go

create view DoctorConsumables
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, CombinationOn, Items.ItemCode,ItemName, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor,	
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime,	
ItemsEXT.Dosage, ItemsEXT.Duration, ItemsEXT.DrQuantity, ItemsEXT.IssueDateTime, 
dbo.GetInventoryBalance(null, Items.ItemCategoryID, Items.ItemCode) as UnitsInStock,HideDetails, 
dbo.GetStaffName(Pharmacist) as Pharmacist, ItemsEXT.ClientMachine,dbo.GetLookupDataDes(Visits.BranchID) as BranchName,
dbo.GetLookupDataDes(ItemsEXT.LocationID) as Location,Items.CreatorClientMachine as ItemCreatorMachine,Items.CreatorLoginID as CreatorLogin
from Items
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo
left outer join ItemsEXT on ItemsEXT.VisitNo = Items.VisitNo 
and ItemsEXT.ItemCode = Items.ItemCode and ItemsEXT.ItemCategoryID = Items.ItemCategoryID
where Items.ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')
go

-- select * from DoctorConsumables


------------ IPDDoctorPrescription  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'IPDDoctorConsumables')
drop view IPDDoctorConsumables
go
create view IPDDoctorConsumables
with encryption 
as
select Visits.PatientNo as VisitsPatientNo ,Admissions.VisitNo as AdmissionsVisitNo,IPDDoctor.AdmissionNo,IPDItems.RoundNo,
IPDDoctor.StaffNo,VisitDate,Patients.LastName as LastName ,Patients.FirstName as FirstName,
Patients.MiddleName as MiddleName,GenderID, dbo.GetAge(Patients.BirthDate, getdate()) as Age,BirthDate,
RoundDateTime,VisitCategoryID,IPDItems.ItemCode,IPDItems.ItemCategoryID,Quantity,UnitCost,UnitPrice,
ItemDetails,ItemStatusID,PayStatusID,Admissions.InsuranceNo,Admissions.BillModesID ,Admissions.BillNo,LastUpdate,IPDItems.LoginID as IPDItemsLoginID,
IPDItems.ClientMachine As IPDItemsClientMachine,IPDItems.ItemName,
IPDItems.RecordDateTime as IPDItemsRecordDateTime,CombinationOn,
IPDItemsEXT.Dosage, IPDItemsEXT.Duration, IPDItemsEXT.DrQuantity, IPDItemsEXT.IssueDateTime,
dbo.GetInventoryBalance(null, IPDItems.ItemCategoryID, IPDItems.ItemCode) as UnitsInStock, 
dbo.GetStaffName(Pharmacist) as Pharmacist, IPDItemsEXT.ClientMachine,dbo.GetLookupDataDes(IPDItemsEXT.LocationID) as Location,
dbo.GetLookupDataDes(Visits.BranchID) as BranchName,HideDetails
from IPDItems 
inner join IPDDoctor on IPDDoctor.RoundNo = IPDItems.RoundNo
inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
inner join Visits on Admissions.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo
left outer join IPDItemsEXT on IPDItemsEXT.RoundNo = IPDItems.RoundNo 
and IPDItemsEXT.ItemCode = IPDItems.ItemCode and IPDItemsEXT.ItemCategoryID = IPDItems.ItemCategoryID
where IPDItems.ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')
go

/*
select * from IPDDoctorConsumbles
select * from DoctorConsumables
*/


------------ Consumables  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'Consumables')
drop view Consumables
go

create view Consumables
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, ItemCode,ItemName, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor, 
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate,dbo.GetLookupDataDes(Visits.BranchID) as BranchName, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime,HideDetails
from Items 
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo
where ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')
go

-- select * from Consumables

------------ ExtraCharge  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'ExtraCharge')
drop view ExtraCharge
go

create view ExtraCharge
with encryption 
as 
select Visits.PatientNo, Items.VisitNo, VisitDate, Patients.LastName, Patients.FirstName, Patients.MiddleName,
dbo.GetFullName(Patients.LastName, Patients.MiddleName, Patients.FirstName) as FullName, 
dbo.GetLookupDataDes(Patients.GenderID) as Gender, dbo.GetAge(Patients.BirthDate, getdate()) as Age, 
Patients.JoinDate, ItemCode,ItemName, 
dbo.GetStaffName(Visits.StaffNo) as ToSeeDoctor, dbo.GetSeenDoctor(Visits.VisitNo) as SeenDoctor, 
Quantity, UnitCost, (Quantity * UnitCost) as TotalCost, UnitPrice, (Quantity * UnitPrice) as TotalBill, 
(Quantity * dbo.GetCoPayFee(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount, ItemDetails,
dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, dbo.GetLookupDataDes(PayStatusID) as PayStatus,
dbo.GetLookupDataDes(BillModesID) as BillModes, BillNo, dbo.GetBillName(BillModesID, BillNo) as BillName,
dbo.GetInsuranceName(BillModesID, InsuranceNo) as InsuranceName, LastUpdate,dbo.GetLookupDataDes(Visits.BranchID) as BranchName, 
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory, Items.LoginID, Items.RecordDateTime,HideDetails
from Items 
inner join Visits on Items.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo
where Items.ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'E')
go

-- select * from ExtraCharge
      
------------ DrugInventory  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DrugInventory')
drop view DrugInventory
go

create view DrugInventory
with encryption 
as 
select Inventory.TranID, LocationID, dbo.GetLookupDataDes(LocationID) as Location, Inventory.ItemCode, 
Inventory.ItemCategoryID, dbo.GetItemName(Inventory.ItemCategoryID, Inventory.ItemCode) as ItemName, 
TranDate, dbo.GetLookupDataDes(StockTypeID) as StockType, Quantity, LocationUnits, Balance, Details, 
dbo.GetLookupDataDes(EntryModeID) as EntryMode, InventoryReceiving.BatchNo, InventoryReceiving.ExpiryDate, 
Inventory.LoginID, Inventory.ClientMachine, Inventory.RecordDateTime, 
dbo.GetShortDate(Inventory.RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
from Inventory 
left outer join InventoryReceiving on Inventory.TranID = InventoryReceiving.TranID
where Inventory.ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
go

-- select * from DrugInventory
      
------------ ConsumableInventory  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'ConsumableInventory')
drop view ConsumableInventory
go

create view ConsumableInventory
with encryption 
as 
select Inventory.TranID, LocationID, dbo.GetLookupDataDes(LocationID) as Location, Inventory.ItemCode, 
Inventory.ItemCategoryID, dbo.GetItemName(Inventory.ItemCategoryID, Inventory.ItemCode) as ItemName, 
TranDate, dbo.GetLookupDataDes(StockTypeID) as StockType, Quantity, LocationUnits, Balance, Details, 
dbo.GetLookupDataDes(EntryModeID) as EntryMode, InventoryReceiving.BatchNo, InventoryReceiving.ExpiryDate, 
Inventory.LoginID, Inventory.ClientMachine, Inventory.RecordDateTime, 
dbo.GetShortDate(Inventory.RecordDateTime) as RecordDate, dbo.GetTime(RecordDateTime) as RecordTime
from Inventory 
left outer join InventoryReceiving on Inventory.TranID = InventoryReceiving.TranID
where Inventory.ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')
go

-- select * from ConsumableInventory

-------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------- IPD Total Cash Payments Per Service ----------------------------------------------
if exists (select * from sysobjects where name = 'GetIPDTotalCashPaymentsPerService')
drop function GetIPDTotalCashPaymentsPerService
go

create function GetIPDTotalCashPaymentsPerService(
@ReceiptNo varchar(20)=null,
@ItemCategoryID varchar(10)= null) returns money
with encryption as

begin

declare @total money

if @ItemCategoryID is null
    begin
    set @total  = (select sum(Amount) from PaymentExtraBillItems where ReceiptNo = @ReceiptNo)
    end
else
 begin
    set @total  = (select sum(Amount) from PaymentExtraBillItems where ReceiptNo = @ReceiptNo and ItemCategoryID = @ItemCategoryID)
   end

set @total =isnull(@total,0)

return @total
end
go

--print dbo.GetIPDTotalCashPaymentsPerService('18003743',null)
--print dbo.GetIPDTotalCashPaymentsPerService('18003745',null)

-------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------- OPD Total Cash Payments Per Service ----------------------------------------------

if exists (select * from sysobjects where name = 'GetOPDTotalCashPaymentsPerService')
drop function GetOPDTotalCashPaymentsPerService
go

create function GetOPDTotalCashPaymentsPerService(
@ReceiptNo varchar(20)=null,
@ItemCategoryID varchar(10)= null) returns money
with encryption as

begin

declare @total money

if @ItemCategoryID is null
    begin
    set @total  = (select sum(Amount) from PaymentDetails where ReceiptNo = @ReceiptNo)
    end
else
 begin
    set @total  = (select sum(Amount) from PaymentDetails where ReceiptNo = @ReceiptNo and ItemCategoryID = @ItemCategoryID)
   end

set @total =isnull(@total,0)

return @total
end
go
--print dbo.GetOPDTotalCashPaymentsPerService('18003743',null)
--print dbo.GetOPDTotalCashPaymentsPerService('18003745',null)

-------------------------------------------------------------------------------------------------------------------------------
----------------------- Function Credit Sale Amount ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'CreditSaleAmount')
drop function CreditSaleAmount
go

create function CreditSaleAmount(@ReceiptNo varchar(20)) returns money
with encryption as

begin

declare @CreditSaleAmount money
declare @AmountToPay money
declare @AmountTendered money
declare @SendBalanceToAccount bit
Declare @UseAccountBalance bit

    set @AmountToPay = (select dbo.GetAmountPaid(PayTypeID, VisitTypeID, @ReceiptNo) 
	from payments where ReceiptNo = @ReceiptNo)

    set @AmountTendered = (select AmountTendered from payments where ReceiptNo = @ReceiptNo)

if (@AmountToPay > @AmountTendered)
    begin
    set @CreditSaleAmount = @AmountToPay - @AmountTendered
    end
else
    begin
    set @CreditSaleAmount = 0
    end

return @CreditSaleAmount
end

go   


--print dbo.CreditSaleAmount('18003743')
--print dbo.CreditSaleAmount('18003745')
-----------------------------------------------------------------------------------------------------------------
-------- Function calculateCollections --------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'calculateCollections')
drop function calculateCollections
go

create function calculateCollections(@ReceiptNo varchar(20)) returns money
with encryption as

begin

declare @TotalCollected money
declare @AmountToPay money
declare @AmountTendered money
declare @SendBalanceToAccount bit
Declare @UseAccountBalance bit

set @SendBalanceToAccount = (select SendBalanceToAccount from payments where ReceiptNo = @ReceiptNo)

    set @AmountToPay = (select dbo.GetAmountPaid(PayTypeID, VisitTypeID, @ReceiptNo) from payments where ReceiptNo = @ReceiptNo)

    set @AmountTendered = (select AmountTendered from payments where ReceiptNo = @ReceiptNo)

if (@AmountToPay < @AmountTendered) and (@SendBalanceToAccount = 1)
    begin
    set @TotalCollected =  @AmountTendered - @AmountToPay
    end
else
    begin
    set @TotalCollected = 0
    end

return @TotalCollected
end

go   


--print dbo.calculateCollections('13000017')
--print dbo.calculateCollections('13000029')

--------Function GetInvoiceAmountPaid ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetInvoiceAmountPaid')
	drop function GetInvoiceAmountPaid
go

create function GetInvoiceAmountPaid(@PayTypeID varchar(10), @VisitTypeID varchar(10), @VisitNo varchar(20)) returns money
with encryption as

begin

declare @CashVisitPayTypeID varchar(10)
declare @AccountBillPayTypeID varchar(10)
declare @InsuranceBillPayTypeID varchar(10)
declare @IPDRoundPayTypeID varchar(10)
declare @ExtraBillPayTypeID varchar(10)

declare @OPDVisitTypeID varchar(10)
declare @IPDVisitTypeID varchar(10)

declare @AmountPaid money

-------------------------------------------------------------------------------------------------------------------------
set @CashVisitPayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @InsuranceBillPayTypeID = dbo.GetLookupDataID('PayType', 'INS')
set @IPDRoundPayTypeID = dbo.GetLookupDataID('PayType', 'IPR')
set @ExtraBillPayTypeID = dbo.GetLookupDataID('PayType', 'EXT')

set @OPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')
set @IPDVisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')
-------------------------------------------------------------------------------------------------------------------------

if (((@PayTypeID = @CashVisitPayTypeID) or (@PayTypeID = @AccountBillPayTypeID) or (@PayTypeID = @InsuranceBillPayTypeID))and (@VisitTypeID = @OPDVisitTypeID))
begin set @AmountPaid = (select sum(Amount) from PaymentDetails where visitNo = @visitNo) end	
	
set @AmountPaid = isnull(@AmountPaid, 0.00)

return @AmountPaid
end
go


-------------------------------------- GetIPDTotalCreditPaymentsPerService -------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDTotalCreditPaymentsPerService')
drop function GetIPDTotalCreditPaymentsPerService
go

create function GetIPDTotalCreditPaymentsPerService(
@InvoiceNo varchar(20)= null,
@ItemCategoryID varchar(10)= null) returns money
with encryption as

begin

declare @total money

if @ItemCategoryID is null
    begin
    set @total  = (select sum(Amount) from InvoiceExtraBillItems where InvoiceNo = @InvoiceNo)
    end
else
 begin
    set @total  = (select sum(Amount) from InvoiceExtraBillItems where InvoiceNo = @InvoiceNo and ItemCategoryID = @ItemCategoryID)
   end

set @total =isnull(@total,0)

return @total
end
go


-------------------------------------- GetOPDTotalCreditPaymentsPerService -------------------------------------------------------

if exists (select * from sysobjects where name = 'GetOPDTotalCreditPaymentsPerService')
drop function GetOPDTotalCreditPaymentsPerService
go

create function GetOPDTotalCreditPaymentsPerService(
@InvoiceNo varchar(20)= null,
@ItemCategoryID varchar(10)= null) returns money
with encryption as

begin

declare @total money

if @ItemCategoryID is null
    begin
    set @total  = (select sum(Amount) from InvoiceDetails where InvoiceNo = @InvoiceNo)
    end
else
 begin
    set @total  = (select sum(Amount) from InvoiceDetails where InvoiceNo = @InvoiceNo and ItemCategoryID = @ItemCategoryID)
   end

set @total =isnull(@total,0)

return @total
end
go



------------ CashPayments  -----------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'CashPayments')
	drop view CashPayments
go

create view CashPayments
with encryption 
as 
	select Payments.*, dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo) as AmountPaid, 
	dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded,(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)- (WithholdingTax+GrandDiscount+dbo.GetAmountRefunded(ReceiptNo))) as NetAmount,
	 VisitNo, VisitDate, CoPayTypeID, 
	CoPayPercent, CoPayValue, Visits.PatientNo, LastName, FirstName, MiddleName, GenderID, BirthDate,	
	dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory,VisitCategoryID,Payments.BranchID as VisitsBranchID,
	dbo.GetLookupDataDes(Payments.BranchID) as VisitsBranch,HideDetails
	from Payments 
	left outer join Visits on Payments.PayNo = Visits.VisitNo
	left outer join Patients on Visits.PatientNo = Patients.PatientNo
	where Payments.PayTypeID = dbo.GetLookupDataID('PayType', 'CAS')
go

-- select * from CashPayments
------------ CreditBillFormPayment  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'CreditBillFormPayment')
drop view CreditBillFormPayment
go

create view CreditBillFormPayment
with encryption 
as 	
select Payments.*, dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo) as AmountPaid, 
dbo.GetBillsPaymentCustomerName(PayTypeID, PayNo) as BillCustomerName,
BranchID as VisitsBranchID,
dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded,(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)-(WithholdingTax+GrandDiscount+dbo.GetAmountRefunded(ReceiptNo))) as NetAmount,
dbo.GetLookupDataDes(BranchID) as VisitsBranch
from Payments 
where Payments.PayTypeID in (dbo.GetLookupDataID('PayType', 'ACC'), dbo.GetLookupDataID('PayType', 'INS'))
and Payments.VisitTypeID = dbo.GetLookupDataID('VisitType', 'IPD')
			
go

-- select * from CreditBillFormPayment

-------------- Account Deposits -------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetAccountDeposits')
	drop proc uspGetAccountDeposits
go

create proc uspGetAccountDeposits(
@StartDateTime smalldatetime,
@EndDateTime smalldatetime
)with encryption as
declare @ErrorMSG varchar(200)
declare @CRAccountActionID varchar(10)
declare @ManualEntryModeID varchar(10)

set @CRAccountActionID = dbo.GetLookupDataID('AccountAction', 'CR')
set @ManualEntryModeID = dbo.GetLookupDataID('EntryMode', 'MAN')

begin

        select dbo.FormatDate(Trandate) as TransactionDate, TranNo,dbo.GetAccountName(AccountBillModesID, AccountBillNo) as AccountName, AccountBillNo,
                ReferenceNo, AmountTendered,
                dbo.FormatMoney(Amount)as Deposit,
                LoginID,dbo.FormatDate(RecordDateTime) as RecordDate,Balance, 
                dbo.GetTime(RecordDateTime) as RecordTime 
                FROM Accounts where EntryModeID ='46man' 
                and accountactionID = '19CR'
                and  dbo.GetAccountsRecordDateTime(Accounts.TranNo) between @StartDateTime and @EndDateTime
return 0
end
go

------------ BillsPayment  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'BillsPayment')
drop view BillsPayment
go

create view BillsPayment
with encryption 
as 	
select Payments.*, dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo) as AmountPaid, 
dbo.GetBillsPaymentCustomerName(PayTypeID, PayNo) as BillCustomerName,
dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded,(dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)-(WithholdingTax+GrandDiscount+dbo.GetAmountRefunded(ReceiptNo))) as NetAmount,
BranchID as VisitsBranchID, 
dbo.GetLookupDataDes(BranchID) as VisitsBranch from Payments
where Payments.PayTypeID in (dbo.GetLookupDataID('PayType', 'ACC'), dbo.GetLookupDataID('PayType', 'INS'))
and Payments.VisitTypeID = dbo.GetLookupDataID('VisitType', 'OPD')
			
go


---print dbo.GetVisitsBranchID('A16013')
-- select top 2 * from BillsPayment
-- select * from Payments



------------ BillFormPayment  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'BillFormPayment')
drop view BillFormPayment
go

create view BillFormPayment
with encryption 
as 
select Payments.*, dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo) as AmountPaid, FirstName, LastName, MiddleName, 
dbo.GetAmountRefunded(ReceiptNo) as AmountRefunded, (dbo.GetAmountPaid(PayTypeID, VisitTypeID, ReceiptNo)-(WithholdingTax+GrandDiscount+dbo.GetAmountRefunded(ReceiptNo))) as NetAmount,
VisitNo, VisitDate, CoPayTypeID, 
CoPayPercent, CoPayValue, Visits.PatientNo, GenderID, BirthDate,	
dbo.GetLookupDataDes(VisitCategoryID) as VisitCategory,dbo.GetLookupDataDes(Payments.BranchID) as BranchName,
(Payments.BranchID) as VisitsBranchID,HideDetails
from Payments 
left outer join Visits on Payments.PayNo = Visits.VisitNo
left outer join Patients on Visits.PatientNo = Patients.PatientNo
where Payments.PayTypeID = dbo.GetLookupDataID('PayType', 'EXT')
go

-- select * from BillFormPayment


------------ UniqueVisits ----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'UniqueVisits')
drop view UniqueVisits
go

create view UniqueVisits
with encryption 
as 
select Visits.PatientNo, VisitDate, LastName, FirstName, MiddleName,
dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, JoinDate,
dbo.GetLookupDataDes(GenderID) as Gender, BirthDate,Phone,
dbo.GetAge(BirthDate, getdate()) as Age,
--VisitCategoryID,
FirstVisitDate, LastVisitDate, CombinationOn, TotalVisits,
dbo.GetLookupDataDes(StatusID) as [Status],HideDetails
from Visits
inner join Patients on Visits.PatientNo = Patients.PatientNo
go

-- select * from UniqueVisits
-- select  distinct PatientNo, LastName, FirstName, MiddleName, JoinDate, Gender, BirthDate, Age, FirstVisitDate,LastVisitDate, CombinationOn, [Status] from UniqueVisitsgroup by 
		
------------ LabRequestSummaries -----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'LabRequestSummaries')
drop view LabRequestSummaries
go

create view LabRequestSummaries
with encryption 
as 
select Visits.PatientNo, LabRequests.VisitNo, LabRequestDetails.SpecimenNo, TestName, VisitDate, 	
dbo.GetItemStatusID(LabRequests.VisitNo, LabRequestDetails.TestCode, 'T') as ItemStatusID,
dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, 
dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, DrawnDateTime,HideDetails
from LabRequestDetails
inner join LabTests on LabRequestDetails.TestCode = LabTests.TestCode 
inner join LabRequests on LabRequestDetails.SpecimenNo = LabRequests.SpecimenNo
inner join Visits on Visits.VisitNo = LabRequests.VisitNo 
inner join Patients on Visits.PatientNo = Patients.PatientNo
go

-- select * from LabRequestSummaries

------------ IPDLabRequestSummaries -----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'IPDLabRequestSummaries')
drop view IPDLabRequestSummaries
go

create view IPDLabRequestSummaries
with encryption 
as 
select Admissions.VisitNo,Visits.PatientNo, LabRequestsIPD.RoundNo, LabRequestDetails.SpecimenNo, TestName, RoundDateTime, 
dbo.GetIPDItemStatusID(LabRequestsIPD.RoundNo, LabRequestDetails.TestCode, 'T') as ItemStatusID,
dbo.GetFullName(LastName, MiddleName, FirstName) as FullName,HideDetails, 
dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, DrawnDateTime
from LabRequestDetails
inner join LabTests on LabRequestDetails.TestCode = LabTests.TestCode
inner join LabRequests on LabRequestDetails.SpecimenNo = LabRequests.SpecimenNo
inner join LabRequestsIPD on LabRequestDetails.SpecimenNo = LabRequestsIPD.SpecimenNo
inner join IPDDoctor on IPDDoctor.RoundNo = LabRequestsIPD.RoundNo
inner join Admissions on IPDDoctor.AdmissionNo = Admissions.AdmissionNo
inner join Visits on Admissions.VisitNo = Visits.VisitNo
inner join Patients on Visits.PatientNo = Patients.PatientNo
go

-- select * from IPDLabRequestSummaries

------------ ExtraBillServices  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'ExtraBillServices')
drop view ExtraBillServices
go

create view ExtraBillServices
with encryption 
as 
select ServiceCode, ServiceName, ServicePointID,dbo.GetLookupDataDes(ServicePointID) as ServicePoint, 
ServiceBillAtID, dbo.GetLookupDataDes(ServiceBillAtID) as ServiceBillAt, Hidden, 
dbo.GetMergedNameCode(ServiceName, ServiceCode) as ServiceFullName, dbo.FormatMoney(UnitCost) as UnitCost, 
dbo.FormatMoney(StandardFee)as StandardFee 
from Services
where ServicePointID = dbo.GetLookupDataID('ServicePoint', 'BIL')
go

-- select * from ExtraBillServices

------------ DentalServiceItems  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DentalServiceItems')
drop view DentalServiceItems
go

create view DentalServiceItems
with encryption 
as 
select DentalCode, DentalName, UnitPrice, Hidden, 
DentalCategoryID, dbo.GetLookupDataDes(DentalCategoryID) as DentalCategory
from DentalServices
where DentalCategoryID = dbo.GetLookupDataID('DentalCategory', 'S')
go

-- select * from DentalServiceItems

------------ DentalLabItems  -----------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'DentalLabItems')
drop view DentalLabItems
go

create view DentalLabItems
with encryption 
as 
select DentalCode, DentalName, UnitPrice, Hidden, 
DentalCategoryID, dbo.GetLookupDataDes(DentalCategoryID) as DentalCategory
from DentalServices
where DentalCategoryID = dbo.GetLookupDataID('DentalCategory', 'L')
go

-- select * from DentalLabItems

--------Function GetHasVisitDiagnosis------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetHasVisitDiagnosis')
drop function GetHasVisitDiagnosis
go

create function GetHasVisitDiagnosis(@VisitNo varchar(20)) returns bit
with encryption as
begin

declare @HasVisitDiagnosis bit

if exists (select VisitNo from Diagnosis where VisitNo = @VisitNo)
set @HasVisitDiagnosis = 1
else set @HasVisitDiagnosis = 0

return @HasVisitDiagnosis

end

go

----------------------------------------------------------------------------------------------------------------------------
-- print cast(dbo.GetHasVisitDiagnosis('1010017030') as varchar)
----------------------------------------------------------------------------------------------------------------------------
--------GetTotalReturnedQuantity ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalReturnedQuantity')
drop function GetTotalReturnedQuantity
go

create function GetTotalReturnedQuantity(@GRNO varchar(20)) returns int
with encryption as

begin

declare @returnedQuantity int

--------------------------------------------------------------------------------------------

set @returnedQuantity = (select sum(ReturnQuantity) 
from GoodsReturnedNoteDetails 
inner join GoodsReturnedNote on GoodsReturnedNote.ReturnNo=GoodsReturnedNoteDetails.ReturnNo
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo=GoodsReturnedNote.GRNNo
where GoodsReturnedNote.GRNNo = @GRNO) 
--------------------------------------------------------------------------------------------

set @returnedQuantity = isnull(@returnedQuantity, 0)

return @returnedQuantity

end
go
------------print dbo.GetTotalReturnedQuantity('1600030001')

--------GetTotalReturnedItemQuantity ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalReturnedItemQuantity')
drop function GetTotalReturnedItemQuantity
go

create function GetTotalReturnedItemQuantity(@GRNO varchar(20),@ItemCode varchar(20)) returns int
with encryption as

begin

declare @returnedItemQuantity int
declare @returnNo varchar(20)

--------------------------------------------------------------------------------------------
set @returnedItemQuantity = (select sum(ReturnQuantity) 
from GoodsReturnedNoteDetails 
inner join GoodsReturnedNote on GoodsReturnedNote.ReturnNo=GoodsReturnedNoteDetails.ReturnNo
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo=GoodsReturnedNote.GRNNo
where GoodsReturnedNote.GRNNo = @GRNO and ItemCode=@ItemCode) 
--------------------------------------------------------------------------------------------

set @returnedItemQuantity = isnull(@returnedItemQuantity, 0)

return @returnedItemQuantity

end
go
------------print dbo.GetTotalReturnedItemQuantity('1600030001','M007')


--------GetTotalGoodsReturnedAmount ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalGoodsReturnedAmount')
drop function GetTotalGoodsReturnedAmount
go

create function GetTotalGoodsReturnedAmount(@GRNO varchar(20)) returns money
with encryption as

begin

declare @ReturnedAmount money

--------------------------------------------------------------------------------------------

set @ReturnedAmount = (select sum(ReturnQuantity*Rate) 
from GoodsReturnedNoteDetails 
inner join GoodsReturnedNote on GoodsReturnedNote.ReturnNo=GoodsReturnedNoteDetails.ReturnNo
inner join GoodsReceivedNote on GoodsReceivedNote.GRNNo=GoodsReturnedNote.GRNNo
inner join  GoodsReceivedNoteDetails on GoodsReceivedNoteDetails.GRNNo=GoodsReturnedNote.GRNNo and GoodsReceivedNoteDetails.ItemCategoryID = GoodsReturnedNoteDetails.ItemCategoryID and GoodsReceivedNoteDetails.ItemCode = GoodsReturnedNoteDetails.ItemCode
where GoodsReceivedNoteDetails.GRNNo = @GRNO) 
--------------------------------------------------------------------------------------------

set @ReturnedAmount = isnull(@ReturnedAmount, 0)

return @ReturnedAmount

end
go
------------ print dbo.GetTotalGoodsReturnedAmount('16137901')

---select * from GoodsReturnedNoteDetails


--------GetTotalReceivedQuantity ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalReceivedQuantity')
drop function GetTotalReceivedQuantity
go

create function GetTotalReceivedQuantity(@GRNNo varchar(20)) returns int
with encryption as

begin

declare @receivedQuantity int

--------------------------------------------------------------------------------------------
set @receivedQuantity = (select sum(ReceivedQuantity) from GoodsReceivedNoteDetails where GRNNo = @GRNNo) 
--------------------------------------------------------------------------------------------

set @receivedQuantity = isnull(@receivedQuantity, 0)

return @receivedQuantity

end
go
--print dbo.GetTotalReceivedQuantity('1600020001')


--------GetIPDNurseFluidsINputTotal ---------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetIPDNurseFluidsINputTotal')
drop function GetIPDNurseFluidsINputTotal
go

create function GetIPDNurseFluidsINputTotal(@RoundNo varchar(20), @FluidTypeID varchar(10), @FluidCategoryID varchar(10)) returns int
with encryption as

begin

declare @InputFluidCategoryID varchar(10)
declare @OutputFluidCategoryID varchar(10)
declare @Total int

set @InputFluidCategoryID = dbo.GetLookupDataID('FluidCategoryID', 'IN')
set @OutputFluidCategoryID = dbo.GetLookupDataID('FluidCategoryID', 'OUT')

if (@FluidCategoryID = @InputFluidCategoryID)
Begin
set @Total = (select  sum(quantity)as total from IPDNurseFluids 
inner join IPDNurse on IPDNurse.nurseRoundNo = IPDNurseFluids.NurseRoundNo
Where IPDNurse.RoundNo = @RoundNo and FluidTypeID = @FluidTypeID and FluidCategoryID =@InputFluidCategoryID)
end
if (@FluidCategoryID = @OutputFluidCategoryID)
Begin
set @Total = (select sum (quantity) as total from IPDNurseFluids 
inner join IPDNurse on IPDNurse.nurseRoundNo = IPDNurseFluids.NurseRoundNo
Where IPDNurse.RoundNo = @RoundNo and FluidTypeID = @FluidTypeID and FluidCategoryID =@OutputFluidCategoryID)
end

set @Total = isnull(@Total, 0.00)

return @Total

end

go


----------------------------------------------------------------------------------------------------------------------------
------------- Stored Procedures --------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

--------SpecialEditObjects--------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspSpecialEditObjects')
drop proc uspSpecialEditObjects
go

create proc uspSpecialEditObjects(
@ObjectName varchar(40),
@OldValue varchar(20),
@NewValue varchar(20),
@DeleteOld bit
)with encryption as

declare @ErrorMSG varchar(200)
declare @KeyColumnCaption varchar(100)
declare @ObjectCaption varchar(60)

--------------------------------------------------------------------------------------------------
declare @CashBillModesID varchar(10)
--------------------------------------------------------------------------------------------------

if not exists(select ObjectName from SpecialEdits where ObjectName = @ObjectName)
begin
set @ErrorMSG = 'The %s: %s, you are trying to enter does not exists in the registered %s'
raiserror(@ErrorMSG,16, 1, 'Object Name', @ObjectName, 'Special Edits')	
return 1
end
else

--------------------------------------------------------------------------------------------------
set @KeyColumnCaption = (select KeyColumnCaption from SpecialEdits where ObjectName = @ObjectName)
set @ObjectCaption = (select ObjectCaption from SpecialEdits 
	inner join AccessObjects on SpecialEdits.ObjectName = AccessObjects.ObjectName
	where SpecialEdits.ObjectName = @ObjectName)
--------------------------------------------------------------------------------------------------
if (@ObjectName = 'BillCustomers')
begin
----------------------------------------------------------------------------------------------
declare @AccountBillModesID varchar(10)
declare @AccountBillPayTypeID varchar(10)
declare @NACoPayTypeID varchar(10)
	
set @AccountBillPayTypeID = dbo.GetLookupDataID('PayType', 'ACC')
set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
set @NACoPayTypeID = dbo.GetLookupDataID('CoPayType', 'NA')
----------------------------------------------------------------------------------------------
	
if @OldValue = 'CASH'
begin
set @ErrorMSG = 'Cash account for Cash Customer can''t be the old value!'
raiserror(@ErrorMSG,16, 1)	
return 1
end
else
if not exists(select AccountNo from BillCustomers where AccountNo = @OldValue)
begin
set @ErrorMSG = 'The %s: %s, you want replaced with: %s, does not exist in the registered %s'
raiserror(@ErrorMSG, 16, 1, @KeyColumnCaption, @OldValue, @NewValue, @ObjectCaption)	
return 1
end
else
if not exists(select AccountNo from BillCustomers where AccountNo = @NewValue)
begin
set @ErrorMSG = 'The %s: %s, you want to replace: %s, does not exist in the registered %s'
raiserror(@ErrorMSG, 16, 1, @KeyColumnCaption, @NewValue, @OldValue, @ObjectCaption)	
return 1
end
else
if (@NewValue = 'CASH') and exists(select PayNo from Payments 
where PayTypeID = @AccountBillPayTypeID and PayNo = @OldValue)
begin
set @ErrorMSG = 'The record with %s: %s, has payment(s) that can''t be transferred to cash customer'
raiserror(@ErrorMSG, 16, 1, @KeyColumnCaption, @OldValue)
return 1
end
else	
if (@NewValue = 'CASH') and exists(select AccountBillNo from Accounts 
where AccountBillModesID = @AccountBillModesID and AccountBillNo = @OldValue)
begin
set @ErrorMSG = 'The record with %s: %s, has accounts entries that can''t be transferred to cash customer'
raiserror(@ErrorMSG, 16, 1, @KeyColumnCaption, @OldValue)
return 1
end
else
if (@NewValue = 'CASH') and exists(select BillNo from Visits 
where BillModesID = @AccountBillModesID and BillNo = @OldValue and (not CoPayTypeID = @NACoPayTypeID))
begin
set @ErrorMSG = 'The record with %s: %s, has co-pay entries that can''t be transferred to cash customer'
raiserror(@ErrorMSG, 16, 1, @KeyColumnCaption, @OldValue)
return 1
end
else	
begin tran
-------------------------------------------------------------------------------------------
update Payments set PayNo = @NewValue
where PayTypeID = @AccountBillPayTypeID and PayNo = @OldValue

update Accounts set AccountBillNo = @NewValue
where AccountBillModesID = @AccountBillModesID and AccountBillNo = @OldValue

if (@NewValue = 'CASH')
begin 
update Visits set BillNo = @NewValue, BillModesID = @CashBillModesID, MemberCardNo = ''
where BillModesID = @AccountBillModesID and BillNo = @OldValue
				
update Patients set DefaultBillNo = @NewValue, DefaultBillModesID = @CashBillModesID, DefaultMemberCardNo = ''
where DefaultBillModesID = @AccountBillModesID and DefaultBillNo = @OldValue
end	
else
begin 
update Visits set BillNo = @NewValue
where BillModesID = @AccountBillModesID and BillNo = @OldValue
				
update Patients set DefaultBillNo = @NewValue
where DefaultBillModesID = @AccountBillModesID and DefaultBillNo = @OldValue
end		
	
-------------------------------------------------------------------------------------------
if (@DeleteOld = 1) begin exec uspDeleteBillCustomers @OldValue end
-------------------------------------------------------------------------------------------

if @@error > 0
begin
rollback tran
return 1		
end
commit tran
return 1
end
else if (@ObjectName = 'Drugs')
begin

----------------------------------------------------------------------------------------------
declare @DrugItemCategoryID varchar(10)
set @DrugItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')
----------------------------------------------------------------------------------------------

if not exists(select DrugNo from Drugs where DrugNo = @OldValue)
begin
set @ErrorMSG = 'The %s: %s, you want replaced with: %s, does not exist in the registered %s'
raiserror(@ErrorMSG, 16, 1, @KeyColumnCaption, @OldValue, @NewValue, @ObjectCaption)	
return 1
end
else
if not exists(select DrugNo from Drugs where DrugNo = @NewValue)
begin
set @ErrorMSG = 'The %s: %s, you want to replace: %s, does not exist in the registered %s'
raiserror(@ErrorMSG, 16, 1, @KeyColumnCaption, @NewValue, @OldValue, @ObjectCaption)	
return 1
end
else	
begin tran
-------------------------------------------------------------------------------------------	
							
update Items set ItemCode = @NewValue
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @OldValue
		
update IPDItems set ItemCode = @NewValue
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @OldValue
		
update ExtraBillItems set ItemCode = @NewValue
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @OldValue
		
-------------------------------------------------------------------------------------------				
if exists(select ItemCode from BillCustomFee 
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @NewValue)
begin
delete from BillCustomFee 
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @OldValue						
end
else
begin
update BillCustomFee set ItemCode = @NewValue
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @OldValue		
end	
		
-------------------------------------------------------------------------------------------				
if exists(select ItemCode from InsuranceCustomFee 
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @NewValue)
begin
delete from InsuranceCustomFee
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @OldValue						
end
else
begin				
update InsuranceCustomFee set ItemCode = @NewValue
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @OldValue	
end	
		
-------------------------------------------------------------------------------------------				
if exists(select ItemCode from BillExcludedItems 
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @NewValue)
begin
delete from BillExcludedItems
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @OldValue						
end
else
begin				
update BillExcludedItems set ItemCode = @NewValue
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @OldValue		
end

-------------------------------------------------------------------------------------------				
if exists(select ItemCode from InsuranceExclusions 
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @NewValue)
begin
delete from InsuranceExclusions
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @OldValue						
end
else
begin				
update InsuranceExclusions set ItemCode = @NewValue
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @OldValue		
end	

-------------------------------------------------------------------------------------------				
if exists(select ItemCode from InsuranceExcludedItems 
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @NewValue)
begin
delete from InsuranceExcludedItems
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @OldValue						
end
else
begin				
update InsuranceExcludedItems set ItemCode = @NewValue
where ItemCategoryID = @DrugItemCategoryID and ItemCode = @OldValue		
end	

-------------------------------------------------------------------------------------------
if (@DeleteOld = 1) begin delete from Drugs where DrugNo = @OldValue end
-------------------------------------------------------------------------------------------
		
if @@error > 0
begin
rollback tran
return 1		
end
commit tran
return 1
end
--------------------------------------------------------------------------------------------------
else if (@ObjectName = 'Patients')
begin
----------------------------------------------------------------------------------------------		
set @CashBillModesID = dbo.GetLookupDataID('BillModes', 'C')
----------------------------------------------------------------------------------------------
	
if not exists(select PatientNo from Patients where PatientNo = @OldValue)
begin
set @ErrorMSG = 'The %s: %s, you want replaced with: %s, does not exist in the registered %s'
raiserror(@ErrorMSG, 16, 1, @KeyColumnCaption, @OldValue, @NewValue, @ObjectCaption)	
return 1
end
else
if not exists(select PatientNo from Patients where PatientNo = @NewValue)
begin
set @ErrorMSG = 'The %s: %s, you want to replace: %s, does not exist in the registered %s'
raiserror(@ErrorMSG, 16, 1, @KeyColumnCaption, @NewValue, @OldValue, @ObjectCaption)	
return 1
end
else	
begin tran
-------------------------------------------------------------------------------------------
update Accounts set AccountBillNo = @NewValue
where AccountBillModesID = @CashBillModesID and AccountBillNo = @OldValue
			
update Visits set PatientNo = @NewValue where PatientNo = @OldValue
update Appointments set PatientNo = @NewValue where PatientNo = @OldValue			
update Deaths set PatientNo = @NewValue where PatientNo = @OldValue		
	
-------------------------------------------------------------------------------------------
if (@DeleteOld = 1) begin exec uspDeletePatients @OldValue end
-------------------------------------------------------------------------------------------

if @@error > 0
begin
rollback tran
return 1		
end
commit tran
return 1
end

return 0

go

-- exec uspSpecialEditObjects 'BillCustomers', 'SYN', 'SIL', 1
-- select * from Accounts

---------Update Missed Appointments-----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdateMissedAppointments')
drop proc uspUpdateMissedAppointments
go

create proc uspUpdateMissedAppointments
with encryption as
begin

declare  @Today as smalldatetime
declare @AppointmentStatusID varchar(10)	
	
set @Today = getdate()
set @Today = dbo.FormatDate(@Today)
set @AppointmentStatusID = dbo.GetLookupDataID('AppointmentStatus', 'NV')
	
update Appointments set AppointmentStatusID = @AppointmentStatusID
where ((@Today > EndDate) and (AppointmentStatusID = dbo.GetLookupDataID('AppointmentStatus', 'WT')))

return @@rowcount
end
go

-- exec uspUpdateMissedAppointments
-- select * from Appointments

-------------- Patient CombinationOn --------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePatientCombinationOn')
drop proc uspUpdatePatientCombinationOn
go

create proc uspUpdatePatientCombinationOn(
@VisitNo varchar(20)
) with encryption as

declare @PatientNo varchar(20)

begin
set @PatientNo = (select PatientNo from Visits where VisitNo = @VisitNo)

update Patients set CombinationOn = dbo.GetCombinationCurrentlyOn(@PatientNo)
where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspUpdatePatientCombinationOn '001001'
******************************************************************************************************/

----------------- Update PatientVisitDates -------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspUpdatePatientCalculatedFields')
drop proc uspUpdatePatientCalculatedFields
go

create proc uspUpdatePatientCalculatedFields(
@PatientNo varchar(20)
) with encryption as

begin
update Patients set 
FirstVisitDate = dbo.GetFirstVisitDate(@PatientNo),
LastVisitDate = dbo.GetLastVisitDate(@PatientNo),
TotalVisits = dbo.GetTotalVisits(@PatientNo)  
where PatientNo = @PatientNo
return 0
end
go

/******************************************************************************************************
exec uspUpdatePatientCalculatedFields ''

******************************************************************************************************/
-- select * from Patients

------------------------------------------------------------------------------------------------------
-------------- InventoryLocation ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

-------------- Edit InventoryLocation ----------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspEditInventoryLocation')
drop proc uspEditInventoryLocation
go

create proc uspEditInventoryLocation(
@LocationID varchar(10),
@ItemCategoryID varchar(10),
@ItemCode varchar(20),
@UnitsAtHand int,
@BatchNo varchar(20) = null,
@ExpiryDate smalldatetime = null
)with encryption as

declare @ErrorMSG varchar(200)

if exists(select LocationID from InventoryLocation where LocationID = @LocationID 
	and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode)
begin
if (not (@BatchNo is null or @BatchNo = ''))
begin
if (@UnitsAtHand > 0)
	begin
		update InventoryLocation set UnitsAtHand = @UnitsAtHand, BatchNo = @BatchNo, ExpiryDate = @ExpiryDate
		where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
	end
else
	begin
		update InventoryLocation set UnitsAtHand = @UnitsAtHand, BatchNo = null, ExpiryDate = null
		where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
	end	
end
else
begin
update InventoryLocation set UnitsAtHand = @UnitsAtHand
where LocationID = @LocationID and ItemCategoryID = @ItemCategoryID and ItemCode = @ItemCode
end
return 0
end
else
begin
if (not (@BatchNo is null or @BatchNo = ''))
begin
insert into InventoryLocation (LocationID, ItemCategoryID, ItemCode, UnitsAtHand, BatchNo, ExpiryDate)
values (@LocationID, @ItemCategoryID, @ItemCode, @UnitsAtHand, @BatchNo, @ExpiryDate)
end
else
begin
insert into InventoryLocation (LocationID, ItemCategoryID, ItemCode, UnitsAtHand)
values (@LocationID, @ItemCategoryID, @ItemCode, @UnitsAtHand)
end			
return 0
end
go

/******************************************************************************************************
exec uspEditInventoryLocation
******************************************************************************************************/
-- select * from InventoryLocation
-- delete from InventoryLocation

--------GetInventoryStartBalance-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInventoryStartBalance')
drop proc uspGetInventoryStartBalance
go

create proc uspGetInventoryStartBalance(
@LocationID varchar(10) = null, 
@ItemCategoryID varchar(10), 
@ItemCode varchar(20), 
@StartDate smalldatetime,
@StartBalance int = null output
)with encryption as

begin set @StartBalance = dbo.GetInventoryStartBalance(@LocationID, @ItemCategoryID, @ItemCode, @StartDate) end	
set @StartBalance = isnull(@StartBalance, 0)

return 0

go

-- exec uspGetInventoryStartBalance '', '7D', 'M516', '20 Nov 2014'
-- exec uspGetInventoryStartBalance '11702', '7D', 'M516', '20 Nov 2014'

--------GetInventoryEndBalance-------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetInventoryEndBalance')
drop proc uspGetInventoryEndBalance
go

create proc uspGetInventoryEndBalance(
@LocationID varchar(10) = null, 
@ItemCategoryID varchar(10), 
@ItemCode varchar(20), 
@EndDate as smalldatetime,
@EndBalance int = null output
)with encryption as

begin set @EndBalance = dbo.GetInventoryEndBalance(@LocationID, @ItemCategoryID, @ItemCode, @EndDate) end	
set @EndBalance = isnull(@EndBalance, 0)

return 0

go

-- exec uspGetInventoryEndBalance  '', '7D', 'M516', '30 Nov 2014'
-- exec uspGetInventoryEndBalance  '11702', '7D', 'M516', '30 Nov 2014'

-------Function GetAccessedCashServicesAuthorized-------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetAccessedCashServicesAuthorized')
drop function GetAccessedCashServicesAuthorized
go

create function GetAccessedCashServicesAuthorized(@VisitNo varchar(20)) returns bit
with encryption as
begin
declare @AccessedCashServicesAuthorized bit
begin
begin set @AccessedCashServicesAuthorized = (select VisitNo from AccessedCashServices 
where VisitNo = @VisitNo) end
set @AccessedCashServicesAuthorized = isnull(@AccessedCashServicesAuthorized, 0)
end
return @AccessedCashServicesAuthorized
end

go


--------Function GetConsumedAmountPerClaimNo---------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetConsumedAmountPerClaimNo')
drop function GetConsumedAmountPerClaimNo
go

create function GetConsumedAmountPerClaimNo(@ClaimNo varchar(20)) returns money
with encryption as

begin

declare @ConsumedAmountPerClaimNo money


---------------------------------------------------------------------------------------------------------
set @ConsumedAmountPerClaimNo = (select Sum(ConsumedAmount) from ClaimDetails
			inner join Claims on ClaimDetails.ClaimNo = Claims.ClaimNo
			where Claims.ClaimNo = @ClaimNo)
							
set @ConsumedAmountPerClaimNo = isnull(@ConsumedAmountPerClaimNo, 0.00)
---------------------------------------------------------------------------------------------------------

return @ConsumedAmountPerClaimNo

end

go

-------------------------GetNextTokenNo-------------------------------

if exists (select * from sysobjects where name = 'GetNextTokenNo')
drop function GetNextTokenNo
go

create function GetNextTokenNo (@VisitNo varchar(20), @ServicePointID varchar(10),
@BranchID varchar(10), @PriorityID varchar(10)) returns varchar(10)
with encryption as

begin

declare @TokenID as int
declare @TokenNo as Varchar(20)

set @TokenID = (select max(TokenID) from Queues 
where PriorityID=@PriorityID and BranchID=@BranchID and ServicePointID=@ServicePointID and
year(RecordDateTime)=year(getdate()) and month(RecordDateTime)=month(getdate()) and day(RecordDateTime)=day(getdate()))
   
set @TokenID= isnull(@TokenID,1)

set @TokenNo=right(@PriorityID,2)+''+cast(@TokenID as Varchar)

return @TokenNo

end

go

-------------------------GetNextTokenNo------------------------------------------------------------------------------------------
------------------------print dbo.GetNextTokenNo('13157001', '16CAS','177NA' , '155NO')-------------------------------------------



----------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetConsumedAmountPerClaimNo('14000300002'))
-- print dbo.FormatMoney(dbo.GetConsumedAmountPerClaimNo('14000300003'))
-- print dbo.FormatMoney(dbo.GetConsumedAmountPerClaimNo('14000300004'))
----------------------------------------------------------------------------------------------------------------------------


if exists (select * from sysobjects where name = 'GetTotalVisitsPerDoctor')
drop function GetTotalVisitsPerDoctor
go

create function GetTotalVisitsPerDoctor(@StaffNo varchar(10), @StartDate smalldatetime, @EndDate smalldatetime) returns int
with encryption as

begin

declare @Total int
if not(@StartDate is null) and not(@EndDate is null)
Begin
set @Total = (select  count(visits.VisitNo) from visits
Where visits.StaffNo = @StaffNo and Visits.VisitDate between @StartDate and @EndDate)
end
else
begin
set @Total = (select  count(visits.VisitNo) from visits
Where visits.StaffNo = @StaffNo)
end
set @Total = isnull(@Total, 0.00)

return @Total

end
go
/*
print dbo.GetTotalVisitsPerDoctor('MH/171', '2016-01-01', '2016-01-30')
*/



if exists (select * from sysobjects where name = 'GetCountVisitsPerDoctorPerVisitStatus')
drop function GetCountVisitsPerDoctorPerVisitStatus
go

create function GetCountVisitsPerDoctorPerVisitStatus(@StaffNo varchar(10), @VisitStatusID varchar(10), @StartDate smalldatetime, @EndDate smalldatetime) returns int
with encryption as

begin

declare @Total int
declare @CompletedVisitStatusID as varchar(10)
declare @SeeDoctorVisitStatusID as varchar(10)
declare @CancelledVisitStatusID as varchar(10)
declare @InPatientVisitStatusID as varchar(10)
-------------------------------------------------------------------------------------
set @CompletedVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'CO')
set @SeeDoctorVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'DR')
set @CancelledVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'CA')
set @InPatientVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'IP')
-------------------------------------------------------------------------------------
if not(@StartDate is null) and not(@EndDate is null)
Begin
if(@VisitStatusID = @CompletedVisitStatusID)
begin
set @Total = (select  count(DoctorVisits.VisitNo) from DoctorVisits
inner join visits on DoctorVisits.visitno = Visits .visitNo 
Where DoctorVisits.StaffNo = @StaffNo and visits.visitStatusID = @CompletedVisitStatusID
and DoctorVisits.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate))
--visits.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate)
end
if(@VisitStatusID = @SeeDoctorVisitStatusID)
begin
set @Total = (select  count(VisitNo) from visits 
Where visits.StaffNo = @StaffNo and visits.visitStatusID = @SeeDoctorVisitStatusID
and visits.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate))
end
if(@VisitStatusID = @CancelledVisitStatusID)
begin
set @Total = (select  count(VisitNo) from visits 
Where visits.StaffNo = @StaffNo and visits.visitStatusID = @CancelledVisitStatusID
and visits.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate))
end
if(@VisitStatusID = @InPatientVisitStatusID)
begin
set @Total = (select  count(visits.VisitNo) from visits
left join DoctorVisits on DoctorVisits.visitno = Visits .visitNo
Where visits.StaffNo = @StaffNo and visits.visitStatusID = @InPatientVisitStatusID
and visits.RecordDateTime between dbo.FormatDateTime(@StartDate) and dbo.FormatDateTime(@EndDate))
end
end
else
Begin
if(@VisitStatusID = @CompletedVisitStatusID)
begin
set @Total = (select  count(DoctorVisits.VisitNo) from DoctorVisits
inner join visits on DoctorVisits.visitno = Visits .visitNo 
Where DoctorVisits.StaffNo = @StaffNo and visits.visitStatusID = @CompletedVisitStatusID)
end
if(@VisitStatusID = @SeeDoctorVisitStatusID)
begin
set @Total = (select  count(VisitNo) from visits 
Where visits.StaffNo = @StaffNo and visits.visitStatusID = @SeeDoctorVisitStatusID)
end
if(@VisitStatusID = @CancelledVisitStatusID)
begin
set @Total = (select  count(VisitNo) from visits 
Where visits.StaffNo = @StaffNo and visits.visitStatusID = @CancelledVisitStatusID)
end
if(@VisitStatusID = @InPatientVisitStatusID)
begin
set @Total = (select  count(visits.VisitNo) from visits
left join DoctorVisits on DoctorVisits.visitno = Visits .visitNo
Where visits.StaffNo = @StaffNo and visits.visitStatusID = @InPatientVisitStatusID)
end
end
set @Total = isnull(@Total, 0.00)

return @Total

end
go
/*
print dbo.GetCountVisitsPerDoctorPerVisitStatus('MHIN/63','9CO', '2016-11-01', '2016-12-30')
print dbo.GetCountVisitsPerDoctorPerVisitStatus('MHIN/63','9CA', '2016-11-01', '2016-12-30')
print dbo.GetCountVisitsPerDoctorPerVisitStatus('MHIN/63','9DR', '2016-11-01', '2016-12-30')
print dbo.GetCountVisitsPerDoctorPerVisitStatus('MHIN/63','9IP', '2016-11-01', '2016-12-30')
*/




/******************************************************************************************************/
if exists (select * from sysobjects where name = 'GetTotalAmmountOnVisitsPerDoctorPerVisitStatus')
drop function GetTotalAmmountOnVisitsPerDoctorPerVisitStatus
go

create function GetTotalAmmountOnVisitsPerDoctorPerVisitStatus(@StaffNo varchar(10), @VisitStatusID varchar(10), @StartDate smalldatetime, @EndDate smalldatetime) returns money
with encryption as

begin

declare @Total money
declare @CompletedVisitStatusID as varchar(10)
declare @SeeDoctorVisitStatusID as varchar(10)
declare @CancelledVisitStatusID as varchar(10)
declare @InPatientVisitStatusID as varchar(10)
-------------------------------------------------------------------------------------
set @CompletedVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'CO')
set @SeeDoctorVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'DR')
set @CancelledVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'CA')
set @InPatientVisitStatusID =  dbo.GetLookupDataID('VisitStatus', 'IP')
-------------------------------------------------------------------------------------
if not(@StartDate is null) and not(@EndDate is null)
Begin
if(@VisitStatusID = @CompletedVisitStatusID)
begin
set @Total = (select  sum(services.standardFee) from DoctorVisits
inner join visits on DoctorVisits.visitno = Visits .visitNo 
inner join services on visits.ServiceCode = services.ServiceCode
Where DoctorVisits.StaffNo = @StaffNo and visits.visitStatusID = @CompletedVisitStatusID
and DoctorVisits.RecordDateTime between @StartDate and @EndDate
)
end
if(@VisitStatusID = @SeeDoctorVisitStatusID)
begin
set @Total = (select  sum(services.standardFee) from visits
--left join visits on DoctorVisits.visitno = Visits .visitNo 
inner join services on visits.ServiceCode = services.ServiceCode
Where visits.StaffNo = @StaffNo and visits.visitStatusID = @SeeDoctorVisitStatusID
and Visits.VisitDate between @StartDate and @EndDate
)
end
if(@VisitStatusID = @CancelledVisitStatusID)
begin
set @Total = (select  sum(services.standardFee) from visits
inner join services on visits.ServiceCode = services.ServiceCode
Where visits.StaffNo = @StaffNo and visits.visitStatusID = @CancelledVisitStatusID
and Visits.VisitDate between @StartDate and @EndDate
)
end
if(@VisitStatusID = @InPatientVisitStatusID)
begin
set @Total = (select  sum(services.standardFee) from visits
--inner join visits on DoctorVisits.visitno = Visits .visitNo 
inner join services on visits.ServiceCode = services.ServiceCode
Where visits.StaffNo = @StaffNo and visits.visitStatusID = @InPatientVisitStatusID
and Visits.VisitDate between @StartDate and @EndDate
)
end
end
else
Begin
if(@VisitStatusID = @CompletedVisitStatusID)
begin
set @Total = (select  sum(services.standardFee) from DoctorVisits
inner join visits on DoctorVisits.visitno = Visits .visitNo 
inner join services on visits.ServiceCode = services.ServiceCode
Where DoctorVisits.StaffNo = @StaffNo and visits.visitStatusID = @CompletedVisitStatusID)
end
if(@VisitStatusID = @SeeDoctorVisitStatusID)
begin
set @Total = (select  sum(services.standardFee) from visits
--left join visits on DoctorVisits.visitno = Visits .visitNo 
inner join services on visits.ServiceCode = services.ServiceCode
Where visits.StaffNo = @StaffNo and visits.visitStatusID = @SeeDoctorVisitStatusID)
end
if(@VisitStatusID = @CancelledVisitStatusID)
begin
set @Total = (select  sum(services.standardFee) from visits
inner join services on visits.ServiceCode = services.ServiceCode
Where visits.StaffNo = @StaffNo and visits.visitStatusID = @CancelledVisitStatusID)
end
if(@VisitStatusID = @InPatientVisitStatusID)
begin
set @Total = (select  sum(services.standardFee) from visits
--inner join visits on DoctorVisits.visitno = Visits .visitNo 
inner join services on visits.ServiceCode = services.ServiceCode
Where visits.StaffNo = @StaffNo and visits.visitStatusID = @InPatientVisitStatusID)
end
end
set @Total = isnull(@Total, 0.00)

return @Total

end
go
/*
print dbo.FormatMoney(dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus('MHIN/63','9CO', '2016-11-01', '2016-12-30'))
print dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus('MHIN/63','9CA', '2016-11-01', '2016-12-30')
print dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus('MHIN/63','9DR', '2016-11-01', '2016-12-30')
print dbo.GetTotalAmmountOnVisitsPerDoctorPerVisitStatus('MHIN/63','9IP', '2016-11-01', '2016-12-30')
*/



/******************************************************************************************************/
if exists (select * from sysobjects where name = 'fn_Split')
drop function fn_Split
go

CREATE  FUNCTION fn_Split(@text varchar(8000), @delimiter varchar(20) = ' ')
RETURNS @Strings TABLE
(   
position int IDENTITY PRIMARY KEY,
value varchar(8000)  
)
AS
BEGIN

DECLARE @index int
SET @index = -1

WHILE (LEN(@text) > 0)
BEGIN 
SET @index = CHARINDEX(@delimiter , @text) 
IF (@index = 0) AND (LEN(@text) > 0) 
BEGIN  
INSERT INTO @Strings VALUES (@text)
BREAK 
END 
IF (@index > 1) 
BEGIN  
INSERT INTO @Strings VALUES (LEFT(@text, @index - 1))  
SET @text = RIGHT(@text, (LEN(@text) - @index)) 
END 
ELSE
SET @text = RIGHT(@text, (LEN(@text) - @index))
END
RETURN
END
go
/*

print dbo.fn_Split '7s'

*/
/******************************************************************************************************/


-------------------------------------------------------------------------------------------------
-------------- Insert updateHistory -------------------------------------------------------------
-------------------------------------------------------------------------------------------------

declare @ClientMachine varchar(40)
declare @RecordDateTime smalldatetime
declare @SystemUser varchar(500)
declare @OriginalLogin varchar(500)
Set nocount on
Set @OriginalLogin = ORIGINAL_LOGIN()
Set @SystemUser = SYSTEM_USER
Set @ClientMachine  = host_name()
Set @RecordDateTime  = getdate()
begin
insert into updateHistory
(OriginalLogin,SystemUser,ClientMachine, RecordDateTime)
values
(@OriginalLogin,@SystemUser,@ClientMachine, @RecordDateTime)

end
go


/******************************************************************************************************
exec uspInsertupdateHistory
******************************************************************************************************/
-- select * from updateHistory


----------------------------------------------------------------------------------------------------------------------------
------------- Search Data --------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

--------Search	Appointments -------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspSearchAppointments')
drop proc uspSearchAppointments
go

create proc uspSearchAppointments(
@SearchText varchar(3000)
)with encryption as

begin
exec uspUpdateMissedAppointments
exec uspSearchObject @SearchText
end

return 0

go

-- select * from Appointments
-- exec uspSearchAppointments '* from Appointments'

----------------------------------------------------------------------------------------------------------------------------
------------- Triggers -----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
-------------- Update: Staff -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateStaff')
drop trigger utrUpdateStaff
go

create trigger utrUpdateStaff
on Staff
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(StaffID)
begin
set @ErrorMSG = 'You can''t update Staff ID for Staff, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

if update(StaffNo)
begin
set @ErrorMSG = 'You can''t update Staff No for Staff, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Staff' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-StaffNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted
on Inserted.StaffNo = Deleted.StaffNo
end

-------------------  FirstName  -----------------------------------------------------

if update(FirstName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FirstName', Deleted.FirstName, Inserted.FirstName
from Inserted inner join Deleted
on Inserted.StaffNo = Deleted.StaffNo
and Inserted.FirstName <> Deleted.FirstName
end

-------------------  LastName  -----------------------------------------------------

if update(LastName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastName', Deleted.LastName, Inserted.LastName
from Inserted inner join Deleted
on Inserted.StaffNo = Deleted.StaffNo
and Inserted.LastName <> Deleted.LastName
end

-------------------  GenderID  -----------------------------------------------------

if update(GenderID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GenderID', Deleted.GenderID, Inserted.GenderID
from Inserted inner join Deleted
on Inserted.StaffNo = Deleted.StaffNo
and Inserted.GenderID <> Deleted.GenderID
end

-------------------  StaffTitleID  -----------------------------------------------------

if update(StaffTitleID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffTitleID', Deleted.StaffTitleID, Inserted.StaffTitleID
from Inserted inner join Deleted
on Inserted.StaffNo = Deleted.StaffNo
and Inserted.StaffTitleID <> Deleted.StaffTitleID
end

-------------------  Qualifications  -----------------------------------------------------

if update(Qualifications)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Qualifications', Deleted.Qualifications, Inserted.Qualifications
from Inserted inner join Deleted
on Inserted.StaffNo = Deleted.StaffNo
and Inserted.Qualifications <> Deleted.Qualifications
end

-------------------  Email  -----------------------------------------------------

if update(Email)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Email', Deleted.Email, Inserted.Email
from Inserted inner join Deleted
on Inserted.StaffNo = Deleted.StaffNo
and Inserted.Email <> Deleted.Email
end

-------------------  JoinDate  -----------------------------------------------------

if update(JoinDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'JoinDate', dbo.FormatDate(Deleted.JoinDate), dbo.FormatDate(Inserted.JoinDate)
from Inserted inner join Deleted
on Inserted.StaffNo = Deleted.StaffNo
and Inserted.JoinDate <> Deleted.JoinDate
end

-------------------  Phone  -----------------------------------------------------

if update(Phone)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, Inserted.Phone
from Inserted inner join Deleted
on Inserted.StaffNo = Deleted.StaffNo
and Inserted.Phone <> Deleted.Phone
end

-------------------  Location  -----------------------------------------------------

if update(Location)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Location', Deleted.Location, Inserted.Location
from Inserted inner join Deleted
on Inserted.StaffNo = Deleted.StaffNo
and Inserted.Location <> Deleted.Location
end

-------------------  DoctorSpecialtyID  -----------------------------------------------------

if update(DoctorSpecialtyID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, Inserted.DoctorSpecialtyID
from Inserted inner join Deleted
on Inserted.StaffNo = Deleted.StaffNo
and Inserted.DoctorSpecialtyID <> Deleted.DoctorSpecialtyID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.StaffNo = Deleted.StaffNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.StaffNo = Deleted.StaffNo
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Staff -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteStaff')
drop trigger utrDeleteStaff
go

create trigger utrDeleteStaff
on Staff
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Staff' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  StaffNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted

-------------------  FirstName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FirstName', Deleted.FirstName, null from Deleted

-------------------  LastName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastName', Deleted.LastName, null from Deleted

-------------------  GenderID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GenderID', Deleted.GenderID, null from Deleted

-------------------  StaffTitleID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffTitleID', Deleted.StaffTitleID, null from Deleted

-------------------  Qualifications  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Qualifications', Deleted.Qualifications, null from Deleted

-------------------  Email  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Email', Deleted.Email, null from Deleted

-------------------  JoinDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'JoinDate', dbo.FormatDate(Deleted.JoinDate), null from Deleted

-------------------  Phone  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, null from Deleted

-------------------  Location  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Location', Deleted.Location, null from Deleted

-------------------  DoctorSpecialtyID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted
go

----------------------------------------------------------------------------------------------------------------------------
------------- Update: Patients ----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePatients')
drop trigger utrUpdatePatients
go

create trigger utrUpdatePatients
on Patients
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

if update(PatientID)
begin
set @ErrorMSG = 'You can''t update Patient ID for Patients, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(PatientNo)
begin
set @ErrorMSG = 'You can''t update Patient No for Patients, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(FirstVisitDate) return
if update(LastVisitDate) return
if update(TotalVisits) return
if update(AccountBalance) return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Patients' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-PatientNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
end

------------------- ReferenceNo -----------------------------------------------------

if update(ReferenceNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferenceNo', Deleted.ReferenceNo, Inserted.ReferenceNo
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.ReferenceNo <> Deleted.ReferenceNo
end
------------------- NationalIDNo -----------------------------------------------------

if update(NationalIDNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NationalIDNo', Deleted.NationalIDNo, Inserted.NationalIDNo
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.NationalIDNo <> Deleted.NationalIDNo
end
------------------- FirstName -----------------------------------------------------

if update(FirstName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FirstName', Deleted.FirstName, Inserted.FirstName
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.FirstName <> Deleted.FirstName
end

------------------- LastName -----------------------------------------------------

if update(LastName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastName', Deleted.LastName, Inserted.LastName
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.LastName <> Deleted.LastName
end

------------------- MiddleName -----------------------------------------------------

if update(MiddleName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MiddleName', Deleted.MiddleName, Inserted.MiddleName
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.MiddleName <> Deleted.MiddleName
end

------------------- BirthDate -----------------------------------------------------

if update(BirthDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BirthDate', dbo.FormatDate(Deleted.BirthDate), dbo.FormatDate(Inserted.BirthDate)
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BirthDate <> Deleted.BirthDate
end

------------------- GenderID -----------------------------------------------------

if update(GenderID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GenderID', Deleted.GenderID, Inserted.GenderID
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.GenderID <> Deleted.GenderID
end

-------------------  BirthPlace  -----------------------------------------------------

if update(BirthPlace)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BirthPlace', Deleted.BirthPlace, Inserted.BirthPlace
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BirthPlace <> Deleted.BirthPlace
end

-------------------  Address  -----------------------------------------------------

if update(Address)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, Inserted.Address
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.Address <> Deleted.Address
end

-------------------  Occupation  -----------------------------------------------------

if update(Occupation)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Occupation', Deleted.Occupation, Inserted.Occupation
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.Occupation <> Deleted.Occupation
end

-------------------  Phone  -----------------------------------------------------

if update(Phone)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, Inserted.Phone
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.Phone <> Deleted.Phone
end

-------------------  Email  -----------------------------------------------------

if update(Email)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Email', Deleted.Email, Inserted.Email
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.Email <> Deleted.Email
end

------------------- JoinDate -----------------------------------------------------

if update(JoinDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'JoinDate', dbo.FormatDate(Deleted.JoinDate), dbo.FormatDate(Inserted.JoinDate)
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.JoinDate <> Deleted.JoinDate
end

-------------------  Location  -----------------------------------------------------

if update(Location)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Location', Deleted.Location, Inserted.Location
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.Location <> Deleted.Location
end

-------------------  NOKName  -----------------------------------------------------

if update(NOKName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NOKName', Deleted.NOKName, Inserted.NOKName
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.NOKName <> Deleted.NOKName
end

-------------------  NOKRelationship  -----------------------------------------------------

if update(NOKRelationship)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NOKRelationship', Deleted.NOKRelationship, Inserted.NOKRelationship
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.NOKRelationship <> Deleted.NOKRelationship
end

-------------------  NOKPhone  -----------------------------------------------------

if update(NOKPhone)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NOKPhone', Deleted.NOKPhone, Inserted.NOKPhone
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.NOKPhone <> Deleted.NOKPhone
end

-------------------  DefaultBillModesID  -----------------------------------------------------

if update(DefaultBillModesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DefaultBillModesID', Deleted.DefaultBillModesID, Inserted.DefaultBillModesID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.DefaultBillModesID <> Deleted.DefaultBillModesID
end

------------------- DefaultBillNo -----------------------------------------------------

if update(DefaultBillNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DefaultBillNo', Deleted.DefaultBillNo, Inserted.DefaultBillNo
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.DefaultBillNo <> Deleted.DefaultBillNo
end

-------------------  DefaultMemberCardNo  -----------------------------------------------------

if update(DefaultMemberCardNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DefaultMemberCardNo', Deleted.DefaultMemberCardNo, Inserted.DefaultMemberCardNo
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.DefaultMemberCardNo <> Deleted.DefaultMemberCardNo
end

-------------------  DefaultMainMemberName  -----------------------------------------------------

if update(DefaultMainMemberName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DefaultMainMemberName', Deleted.DefaultMainMemberName, Inserted.DefaultMainMemberName
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.DefaultMainMemberName <> Deleted.DefaultMainMemberName
end

------------------- EnforceDefaultBillNo -----------------------------------------------------

if update(EnforceDefaultBillNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EnforceDefaultBillNo', Deleted.EnforceDefaultBillNo, Inserted.EnforceDefaultBillNo
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.EnforceDefaultBillNo <> Deleted.EnforceDefaultBillNo
end

-------------------  HideDetails  ------------------------------------------------------

if update(HideDetails)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HideDetails', Deleted.HideDetails, Inserted.HideDetails
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.HideDetails <> Deleted.HideDetails
end

------------------- StatusID -----------------------------------------------------------

if update(StatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StatusID', Deleted.StatusID, Inserted.StatusID
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StatusID <> Deleted.StatusID
end

-------------------  BloodGroupID  -----------------------------------------------------

if update(BloodGroupID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodGroupID', Deleted.BloodGroupID, Inserted.BloodGroupID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BloodGroupID <> Deleted.BloodGroupID
end

-------------------  VillageCode  -----------------------------------------------------

if update(VillageCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VillageCode', Deleted.VillageCode, Inserted.VillageCode
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.VillageCode <> Deleted.VillageCode
end

-------------------  CountryID  -----------------------------------------------------

if update(CountryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CountryID', Deleted.CountryID, Inserted.CountryID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.CountryID <> Deleted.CountryID
end

-------------------  BranchID  -----------------------------------------------------

if update(BranchID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BranchID', Deleted.BranchID, Inserted.BranchID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BranchID <> Deleted.BranchID
end

-------------------  TribeID  -----------------------------------------------------

if update(TribeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TribeID', Deleted.TribeID, Inserted.TribeID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.TribeID <> Deleted.TribeID
end

-------------------  ReligionID  -----------------------------------------------------

if update(ReligionID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReligionID', Deleted.ReligionID, Inserted.ReligionID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.ReligionID <> Deleted.ReligionID
end

-------------------  Employer  -----------------------------------------------------

if update(Employer)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Employer', Deleted.Employer, Inserted.Employer
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.Employer <> Deleted.Employer
end

-------------------  EmployerAddress  -----------------------------------------------------

if update(EmployerAddress)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EmployerAddress', Deleted.EmployerAddress, Inserted.EmployerAddress
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.EmployerAddress <> Deleted.EmployerAddress
end

-------------------  ReferringMedicalOfficer  -----------------------------------------------------

if update(ReferringMedicalOfficer)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferringMedicalOfficer', Deleted.ReferringMedicalOfficer, Inserted.ReferringMedicalOfficer
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.ReferringMedicalOfficer <> Deleted.ReferringMedicalOfficer
end

-------------------  NearestDispensary  -----------------------------------------------------

if update(NearestDispensary)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NearestDispensary', Deleted.NearestDispensary, Inserted.NearestDispensary
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.NearestDispensary <> Deleted.NearestDispensary
end

-------------------  PreviousAdmissions  -----------------------------------------------------

if update(PreviousAdmissions)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreviousAdmissions', Deleted.PreviousAdmissions, Inserted.PreviousAdmissions
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PreviousAdmissions <> Deleted.PreviousAdmissions
end

-------------------  ChronicDiseases  -----------------------------------------------------

if update(ChronicDiseases)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ChronicDiseases', Deleted.ChronicDiseases, Inserted.ChronicDiseases
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.ChronicDiseases <> Deleted.ChronicDiseases
end

------------------- ReferringFacility -----------------------------------------------------

if update(ReferringFacility)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferringFacility', Deleted.ReferringFacility, Inserted.ReferringFacility
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.ReferringFacility <> Deleted.ReferringFacility
end

------------------- LoginID ------------------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

go

----------------------------------------------------------------------------------------------------------------------------
------------- Delete: Patients ---------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePatients')
drop trigger utrDeletePatients
go

create trigger utrDeletePatients
on Patients
for  delete
as

declare @ErrorMSG varchar(200)
declare @AccountBillModesID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

-----------------------------------------------------------------------------------------------------------------------

set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'C')

if exists (select AccountBillNo from Accounts 
where (AccountBillNo in (select PatientNo from Deleted) and AccountBillModesID = @AccountBillModesID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Accounts'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

-----------------------------------------------------------------------------------------------------------------------

------------------- Log Deletes ---------------------------------------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return

set @Identity = ident_current('AuditTrail') 
if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Patients' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- PatientNo -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted 

------------------- ReferenceNo -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferenceNo', Deleted.ReferenceNo, null from Deleted 

------------------- NationalIDNo -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NationalIDNo', Deleted.NationalIDNo, null from Deleted 

------------------- FirstName -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FirstName', Deleted.FirstName, null from Deleted 

------------------- LastName -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastName', Deleted.LastName, null from Deleted 

------------------- MiddleName -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MiddleName', Deleted.MiddleName, null from Deleted 

------------------- BirthDate -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BirthDate', dbo.FormatDate(Deleted.BirthDate), null from Deleted 

------------------- GenderID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GenderID', Deleted.GenderID, null from Deleted 

-------------------  BirthPlace  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BirthPlace', Deleted.BirthPlace, null from Deleted

-------------------  Address  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, null from Deleted

-------------------  Occupation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Occupation', Deleted.Occupation, null from Deleted

-------------------  Phone  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, null from Deleted

-------------------  Email  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Email', Deleted.Email, null from Deleted

------------------- JoinDate -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'JoinDate', dbo.FormatDate(Deleted.JoinDate), null from Deleted 

-------------------  Location  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Location', Deleted.Location, null from Deleted

-------------------  NOKName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NOKName', Deleted.NOKName, null from Deleted

-------------------  NOKRelationship  ------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NOKRelationship', Deleted.NOKRelationship, null from Deleted

-------------------  NOKPhone  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NOKPhone', Deleted.NOKPhone, null from Deleted

-------------------  DefaultBillModesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DefaultBillModesID', Deleted.DefaultBillModesID, null from Deleted

------------------- DefaultBillNo -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DefaultBillNo', Deleted.DefaultBillNo, null from Deleted 

-------------------  DefaultMemberCardNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DefaultMemberCardNo', Deleted.DefaultMemberCardNo, null from Deleted

-------------------  DefaultMainMemberName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DefaultMainMemberName', Deleted.DefaultMainMemberName, null from Deleted

------------------- EnforceDefaultBillNo -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EnforceDefaultBillNo', Deleted.EnforceDefaultBillNo, null from Deleted 

-------------------  HideDetails  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HideDetails', Deleted.HideDetails, null from Deleted

------------------- StatusID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StatusID', Deleted.StatusID, null from Deleted 

-------------------  BloodGroupID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodGroupID', Deleted.BloodGroupID, null from Deleted

-------------------  VillageCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VillageCode', Deleted.VillageCode, null from Deleted

-------------------  CountryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CountryID', Deleted.CountryID, null from Deleted

-------------------  BranchID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BranchID', Deleted.BranchID, null from Deleted

-------------------  TribeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TribeID', Deleted.TribeID, null from Deleted

-------------------  ReligionID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReligionID', Deleted.ReligionID, null from Deleted

-------------------  Employer  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Employer', Deleted.Employer, null from Deleted

-------------------  EmployerAddress  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EmployerAddress', Deleted.EmployerAddress, null from Deleted

-------------------  ReferringMedicalOfficer  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferringMedicalOfficer', Deleted.ReferringMedicalOfficer, null from Deleted

-------------------  NearestDispensary  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NearestDispensary', Deleted.NearestDispensary, null from Deleted

-------------------  PreviousAdmissions  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreviousAdmissions', Deleted.PreviousAdmissions, null from Deleted

-------------------  ChronicDiseases  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ChronicDiseases', Deleted.ChronicDiseases, null from Deleted

-------------------  ReferringFacility  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferringFacility', Deleted.ReferringFacility, null from Deleted

------------------- LoginID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted 

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

------------------- RecordDateTime -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted 
go

------------------------------------------------------------------------------------------------------
-------------- Update: PatientsEXT -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePatientsEXT')
drop trigger utrUpdatePatientsEXT
go

create trigger utrUpdatePatientsEXT
on PatientsEXT
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ---------------------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PatientsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-PatientNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.AlternateNo = Deleted.AlternateNo
end

------------------- Key-AlternateNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AlternateNo', Deleted.AlternateNo, Inserted.AlternateNo
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.AlternateNo = Deleted.AlternateNo
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.AlternateNo = Deleted.AlternateNo
and Inserted.Notes <> Deleted.Notes
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PatientsEXT -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePatientsEXT')
drop trigger utrDeletePatientsEXT
go

create trigger utrDeletePatientsEXT
on PatientsEXT
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ---------------------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PatientsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  AlternateNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AlternateNo', Deleted.AlternateNo, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted
go

----------------------------------------------------------------------------------------------------------------------------
------------- Update: BillCustomers ----------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateBillCustomers')
drop trigger utrUpdateBillCustomers
go

create trigger utrUpdateBillCustomers
on BillCustomers
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(AccountID)
begin
set @ErrorMSG = 'You can''t update Account ID for Bill Customers, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(AccountNo)
begin
set @ErrorMSG = 'You can''t update Account No for Bill Customers, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(AccountBalance) return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'BillCustomers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-AccountNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
end

-------------------  BillCustomerName  -----------------------------------------------------

if update(BillCustomerName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillCustomerName', Deleted.BillCustomerName, Inserted.BillCustomerName
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.BillCustomerName <> Deleted.BillCustomerName
end

-------------------  BillCustomerTypeID  -----------------------------------------------------

if update(BillCustomerTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillCustomerTypeID', Deleted.BillCustomerTypeID, Inserted.BillCustomerTypeID
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.BillCustomerTypeID <> Deleted.BillCustomerTypeID
end

-------------------  InsuranceNo  -----------------------------------------------------

if update(InsuranceNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, Inserted.InsuranceNo
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.InsuranceNo <> Deleted.InsuranceNo
end

-------------------  ContactPerson  -----------------------------------------------------

if update(ContactPerson)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContactPerson', Deleted.ContactPerson, Inserted.ContactPerson
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.ContactPerson <> Deleted.ContactPerson
end

-------------------  Address  -----------------------------------------------------

if update(Address)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, Inserted.Address
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.Address <> Deleted.Address
end

-------------------  Phone  -----------------------------------------------------

if update(Phone)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, Inserted.Phone
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.Phone <> Deleted.Phone
end

-------------------  Fax  -----------------------------------------------------

if update(Fax)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Fax', Deleted.Fax, Inserted.Fax
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.Fax <> Deleted.Fax
end

-------------------  Email  -----------------------------------------------------

if update(Email)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Email', Deleted.Email, Inserted.Email
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.Email <> Deleted.Email
end

-------------------  Website  -----------------------------------------------------

if update(Website)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Website', Deleted.Website, Inserted.Website
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.Website <> Deleted.Website
end

-------------------  MemberDeclaration  -----------------------------------------------------

if update(MemberDeclaration)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberDeclaration', Deleted.MemberDeclaration, Inserted.MemberDeclaration
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.MemberDeclaration <> Deleted.MemberDeclaration
end

-------------------  DoctorDeclaration  -----------------------------------------------------

if update(DoctorDeclaration)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorDeclaration', Deleted.DoctorDeclaration, Inserted.DoctorDeclaration
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.DoctorDeclaration <> Deleted.DoctorDeclaration
end

-------------------  CoPayTypeID  -----------------------------------------------------

if update(CoPayTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayTypeID', Deleted.CoPayTypeID, Inserted.CoPayTypeID
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.CoPayTypeID <> Deleted.CoPayTypeID
end

-------------------  CoPayPercent  -----------------------------------------------------

if update(CoPayPercent)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayPercent', Deleted.CoPayPercent, Inserted.CoPayPercent
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.CoPayPercent <> Deleted.CoPayPercent
end

-------------------  CoPayValue  -----------------------------------------------------

if update(CoPayValue)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayValue', cast(Deleted.CoPayValue as varchar(20)), cast(Inserted.CoPayValue as varchar(20))
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.CoPayValue <> Deleted.CoPayValue
end

-------------------  CreditLimit  -----------------------------------------------------

if update(CreditLimit)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CreditLimit', cast(Deleted.CreditLimit as varchar(20)), cast(Inserted.CreditLimit as varchar(20))
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.CreditLimit <> Deleted.CreditLimit
end

-------------------  AllowOnlyListedMember  -----------------------------------------------------

if update(AllowOnlyListedMember)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AllowOnlyListedMember', Deleted.AllowOnlyListedMember, Inserted.AllowOnlyListedMember
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.AllowOnlyListedMember <> Deleted.AllowOnlyListedMember
end

-------------------  UseCustomFee  -----------------------------------------------------

if update(UseCustomFee)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UseCustomFee', Deleted.UseCustomFee, Inserted.UseCustomFee
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.UseCustomFee <> Deleted.UseCustomFee
end

-------------------  SmartCardApplicable  -----------------------------------------------------

if update(SmartCardApplicable)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SmartCardApplicable', Deleted.SmartCardApplicable, Inserted.SmartCardApplicable
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.SmartCardApplicable <> Deleted.SmartCardApplicable
end

-------------------  CaptureMemberCardNo  -----------------------------------------------------

if update(CaptureMemberCardNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CaptureMemberCardNo', Deleted.CaptureMemberCardNo, Inserted.CaptureMemberCardNo
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.CaptureMemberCardNo <> Deleted.CaptureMemberCardNo
end

-------------------  CaptureClaimReferenceNo  -----------------------------------------------------

if update(CaptureClaimReferenceNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CaptureClaimReferenceNo', Deleted.CaptureClaimReferenceNo, Inserted.CaptureClaimReferenceNo
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.CaptureClaimReferenceNo <> Deleted.CaptureClaimReferenceNo
end

-------------------  Hidden  ------------------------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.Hidden <> Deleted.Hidden
end

-------------------  AccountStatusID  -----------------------------------------------------

if update(AccountStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountStatusID', Deleted.AccountStatusID, Inserted.AccountStatusID
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.AccountStatusID <> Deleted.AccountStatusID
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: BillCustomers -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteBillCustomers')
drop trigger utrDeleteBillCustomers
go

create trigger utrDeleteBillCustomers
on BillCustomers
for delete
as

declare @ErrorMSG varchar(200)
declare @BillModesID varchar(10)
declare @PayTypeID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

-----------------------------------------------------------------------------------------------------------------------

set @BillModesID = dbo.GetLookupDataID('BillModes', 'A')
set @PayTypeID = dbo.GetLookupDataID('PayType', 'ACC')

if exists (select AccountNo from Deleted where AccountNo = 'CASH')
begin
set @ErrorMSG = 'Cash Customer can''t be deleted!'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if exists (select DefaultBillNo from Patients 
where (DefaultBillNo in (select AccountNo from Deleted) and DefaultBillModesID = @BillModesID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Patients'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select BillNo from Visits 
where (BillNo in (select AccountNo from Deleted) and BillModesID = @BillModesID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Visits'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select AccountBillNo from Accounts 
where (AccountBillNo in (select AccountNo from Deleted) and AccountBillModesID = @BillModesID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Accounts'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select PayNo from Payments 
where (PayNo in (select AccountNo from Deleted) and PayTypeID = @PayTypeID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payments'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

-----------------------------------------------------------------------------------------------------------------------

------------------- Log Deletes ---------------------------------------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'BillCustomers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AccountNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, null from Deleted

-------------------  BillCustomerName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillCustomerName', Deleted.BillCustomerName, null from Deleted

-------------------  BillCustomerTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillCustomerTypeID', Deleted.BillCustomerTypeID, null from Deleted

-------------------  InsuranceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, null from Deleted

-------------------  ContactPerson  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContactPerson', Deleted.ContactPerson, null from Deleted

-------------------  Address  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, null from Deleted

-------------------  Phone  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, null from Deleted

-------------------  Fax  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Fax', Deleted.Fax, null from Deleted

-------------------  Email  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Email', Deleted.Email, null from Deleted

-------------------  Website  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Website', Deleted.Website, null from Deleted

-------------------  MemberDeclaration  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberDeclaration', Deleted.MemberDeclaration, null from Deleted

-------------------  DoctorDeclaration  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorDeclaration', Deleted.DoctorDeclaration, null from Deleted

-------------------  CoPayTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayTypeID', Deleted.CoPayTypeID, null from Deleted

-------------------  CoPayPercent  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayPercent', Deleted.CoPayPercent, null from Deleted

-------------------  CoPayValue  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayValue', cast(Deleted.CoPayValue as varchar(20)), null from Deleted

-------------------  AllowOnlyListedMember  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AllowOnlyListedMember', Deleted.AllowOnlyListedMember, null from Deleted

-------------------  CreditLimit  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CreditLimit', cast(Deleted.CreditLimit as varchar(20)), null from Deleted

-------------------  UseCustomFee  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UseCustomFee', Deleted.UseCustomFee, null from Deleted

-------------------  SmartCardApplicable  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SmartCardApplicable', Deleted.SmartCardApplicable, null from Deleted

-------------------  CaptureMemberCardNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CaptureMemberCardNo', Deleted.CaptureMemberCardNo, null from Deleted

-------------------  CaptureClaimReferenceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CaptureClaimReferenceNo', Deleted.CaptureClaimReferenceNo, null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted

-------------------  AccountStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountStatusID', Deleted.AccountStatusID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: AssociatedBillCustomers -------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAssociatedBillCustomers')
drop trigger utrUpdateAssociatedBillCustomers
go

create trigger utrUpdateAssociatedBillCustomers
on AssociatedBillCustomers
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'AssociatedBillCustomers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-AccountNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.AssociatedBillNo = Deleted.AssociatedBillNo
end

------------------- Key-AssociatedBillNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AssociatedBillNo', Deleted.AssociatedBillNo, Inserted.AssociatedBillNo
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.AssociatedBillNo = Deleted.AssociatedBillNo
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: AssociatedBillCustomers -------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAssociatedBillCustomers')
drop trigger utrDeleteAssociatedBillCustomers
go

create trigger utrDeleteAssociatedBillCustomers
on AssociatedBillCustomers
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'AssociatedBillCustomers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AccountNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, null from Deleted

-------------------  AssociatedBillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AssociatedBillNo', Deleted.AssociatedBillNo, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: BillCustomFee -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateBillCustomFee')
drop trigger utrUpdateBillCustomFee
go

create trigger utrUpdateBillCustomFee
on BillCustomFee
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'BillCustomFee' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-AccountNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  CustomFee  -----------------------------------------------------

if update(CustomFee)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CustomFee', cast(Deleted.CustomFee as varchar(20)), cast(Inserted.CustomFee as varchar(20))
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CustomFee <> Deleted.CustomFee
end

-------------------  CurrenciesID  -----------------------------------------------------

if update(CurrenciesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, Inserted.CurrenciesID
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CurrenciesID <> Deleted.CurrenciesID
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: BillCustomFee -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteBillCustomFee')
drop trigger utrDeleteBillCustomFee
go

create trigger utrDeleteBillCustomFee
on BillCustomFee
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'BillCustomFee' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AccountNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  CustomFee  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CustomFee', cast(Deleted.CustomFee as varchar(20)), null from Deleted

-------------------  CurrenciesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: BillExcludedItems -------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateBillExcludedItems')
drop trigger utrUpdateBillExcludedItems
go

create trigger utrUpdateBillExcludedItems
on BillExcludedItems
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'BillExcludedItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-AccountNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

go

------------------------------------------------------------------------------------------------------
-------------- Delete: BillExcludedItems -------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteBillExcludedItems')
drop trigger utrDeleteBillExcludedItems
go

create trigger utrDeleteBillExcludedItems
on BillExcludedItems
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'BillExcludedItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AccountNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: BillCustomerMembers -----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateBillCustomerMembers')
drop trigger utrUpdateBillCustomerMembers
go

create trigger utrUpdateBillCustomerMembers
on BillCustomerMembers
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'BillCustomerMembers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-MedicalCardNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalCardNo', Deleted.MedicalCardNo, Inserted.MedicalCardNo
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
end

------------------- Key-AccountNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
end

-------------------  Surname  -----------------------------------------------------

if update(Surname)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Surname', Deleted.Surname, Inserted.Surname
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
and Inserted.Surname <> Deleted.Surname
end

-------------------  FirstName  -----------------------------------------------------

if update(FirstName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FirstName', Deleted.FirstName, Inserted.FirstName
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
and Inserted.FirstName <> Deleted.FirstName
end

-------------------  MiddleName  -----------------------------------------------------

if update(MiddleName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MiddleName', Deleted.MiddleName, Inserted.MiddleName
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
and Inserted.MiddleName <> Deleted.MiddleName
end

-------------------  PolicyStartDate  -----------------------------------------------------

if update(PolicyStartDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyStartDate', dbo.FormatDate(Deleted.PolicyStartDate), dbo.FormatDate(Inserted.PolicyStartDate)
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
and Inserted.PolicyStartDate <> Deleted.PolicyStartDate
end

-------------------  PolicyEndDate  -----------------------------------------------------

if update(PolicyEndDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyEndDate', dbo.FormatDate(Deleted.PolicyEndDate), dbo.FormatDate(Inserted.PolicyEndDate)
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
and Inserted.PolicyEndDate <> Deleted.PolicyEndDate
end

-------------------  CreditLimit  -----------------------------------------------------

if update(CreditLimit)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CreditLimit', cast(Deleted.CreditLimit as varchar(20)), cast(Inserted.CreditLimit as varchar(20))
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
and Inserted.CreditLimit <> Deleted.CreditLimit
end

-------------------  MemberStatusID  -----------------------------------------------------

if update(MemberStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberStatusID', Deleted.MemberStatusID, Inserted.MemberStatusID
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
and Inserted.MemberStatusID <> Deleted.MemberStatusID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: BillCustomerMembers -----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteBillCustomerMembers')
drop trigger utrDeleteBillCustomerMembers
go

create trigger utrDeleteBillCustomerMembers
on BillCustomerMembers
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'BillCustomerMembers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  MedicalCardNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalCardNo', Deleted.MedicalCardNo, null from Deleted

-------------------  AccountNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, null from Deleted

-------------------  Surname  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Surname', Deleted.Surname, null from Deleted

-------------------  FirstName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FirstName', Deleted.FirstName, null from Deleted

-------------------  MiddleName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MiddleName', Deleted.MiddleName, null from Deleted

-------------------  PolicyStartDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyStartDate', dbo.FormatDate(Deleted.PolicyStartDate), null from Deleted

-------------------  PolicyEndDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyEndDate', dbo.FormatDate(Deleted.PolicyEndDate), null from Deleted

-------------------  CreditLimit  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CreditLimit', cast(Deleted.CreditLimit as varchar(20)), null from Deleted

-------------------  MemberStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberStatusID', Deleted.MemberStatusID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: MemberBenefits ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateMemberBenefits')
drop trigger utrUpdateMemberBenefits
go

create trigger utrUpdateMemberBenefits
on MemberBenefits
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'MemberBenefits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-BenefitCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BenefitCode', Deleted.BenefitCode, Inserted.BenefitCode
from Inserted inner join Deleted
on Inserted.BenefitCode = Deleted.BenefitCode
end

-------------------  BenefitName  -----------------------------------------------------

if update(BenefitName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BenefitName', Deleted.BenefitName, Inserted.BenefitName
from Inserted inner join Deleted
on Inserted.BenefitCode = Deleted.BenefitCode
and Inserted.BenefitName <> Deleted.BenefitName
end

-------------------  ItemCategoryID  -----------------------------------------------------

if update(ItemCategoryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.BenefitCode = Deleted.BenefitCode
and Inserted.ItemCategoryID <> Deleted.ItemCategoryID
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: MemberBenefits ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteMemberBenefits')
drop trigger utrDeleteMemberBenefits
go

create trigger utrDeleteMemberBenefits
on MemberBenefits
for delete
as

declare @ErrorMSG varchar(200)
declare @ServiceID varchar(10)
declare @DrugID varchar(10)
declare @ConsumableID varchar(10)
declare @ProcedureID varchar(10)
declare @TestID varchar(10)
declare @CardiologyID varchar(10)

declare @RadiologyID varchar(10)
declare @PathologyID varchar(10)
declare @DentalID varchar(10)
declare @TheatreID varchar(10)
declare @OpticalID varchar(10)
declare @MaternityID varchar(10)
declare @ICUID varchar(10)
declare @EyeID varchar(10)
declare @AdmissionID varchar(10)
declare @ExtrasID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

---------------------------------------------------------------------------------------------------------------------------
set @ServiceID = dbo.GetLookupDataID('ItemCategory', 'S')
set @DrugID = dbo.GetLookupDataID('ItemCategory', 'D')
set @ConsumableID = dbo.GetLookupDataID('ItemCategory', 'C')
set @ProcedureID = dbo.GetLookupDataID('ItemCategory', 'P')
set @TestID = dbo.GetLookupDataID('ItemCategory', 'T')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')

set @RadiologyID = dbo.GetLookupDataID('ItemCategory', 'R')
set @PathologyID = dbo.GetLookupDataID('ItemCategory', 'L')
set @DentalID = dbo.GetLookupDataID('ItemCategory', 'N')
set @TheatreID = dbo.GetLookupDataID('ItemCategory', 'H')
set @OpticalID = dbo.GetLookupDataID('ItemCategory', 'O')
set @MaternityID = dbo.GetLookupDataID('ItemCategory', 'M')
set @ICUID = dbo.GetLookupDataID('ItemCategory', 'I')
set @EyeID = dbo.GetLookupDataID('ItemCategory', 'Y')
set @AdmissionID = dbo.GetLookupDataID('ItemCategory', 'A')
set @ExtrasID = dbo.GetLookupDataID('ItemCategory', 'E')

---------------------------------------------------------------------------------------------------------------------------
if exists (select BenefitCode from Deleted where BenefitCode in(@ServiceID, @DrugID, @ConsumableID, @ProcedureID, @TestID, @CardiologyID, 
@RadiologyID,@PathologyID, @DentalID, @TheatreID, @OpticalID, @MaternityID, @ICUID, @EyeID, @AdmissionID, @ExtrasID))
begin
set @ErrorMSG = 'Member Benefit Items that match with Item Category can''t be deleted!'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'MemberBenefits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  BenefitCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BenefitCode', Deleted.BenefitCode, null from Deleted

-------------------  BenefitName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BenefitName', Deleted.BenefitName, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: MemberLimits ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateMemberLimits')
drop trigger utrUpdateMemberLimits
go

create trigger utrUpdateMemberLimits
on MemberLimits
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'MemberLimits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-MedicalCardNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalCardNo', Deleted.MedicalCardNo, Inserted.MedicalCardNo
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
and Inserted.BenefitCode = Deleted.BenefitCode
end

------------------- Key-AccountNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
and Inserted.BenefitCode = Deleted.BenefitCode
end

------------------- Key-BenefitCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BenefitCode', Deleted.BenefitCode, Inserted.BenefitCode
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
and Inserted.BenefitCode = Deleted.BenefitCode
end

-------------------  MemberLimit  -----------------------------------------------------

if update(MemberLimit)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberLimit', cast(Deleted.MemberLimit as varchar(20)), cast(Inserted.MemberLimit as varchar(20))
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.AccountNo = Deleted.AccountNo
and Inserted.BenefitCode = Deleted.BenefitCode
and Inserted.MemberLimit <> Deleted.MemberLimit
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: MemberLimits ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteMemberLimits')
drop trigger utrDeleteMemberLimits
go

create trigger utrDeleteMemberLimits
on MemberLimits
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'MemberLimits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  MedicalCardNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalCardNo', Deleted.MedicalCardNo, null from Deleted

-------------------  AccountNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, null from Deleted

-------------------  BenefitCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BenefitCode', Deleted.BenefitCode, null from Deleted

-------------------  MemberLimit  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberLimit', cast(Deleted.MemberLimit as varchar(20)), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Insurances --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInsurances')
drop trigger utrUpdateInsurances
go

create trigger utrUpdateInsurances
on Insurances
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(InsuranceID)
begin
set @ErrorMSG = 'You can''t update Insurance ID for Insurances, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(InsuranceNo)
begin
set @ErrorMSG = 'You can''t update Insurance No for Insurances, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Insurances' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-InsuranceNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, Inserted.InsuranceNo
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
end

-------------------  InsuranceName  -----------------------------------------------------

if update(InsuranceName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceName', Deleted.InsuranceName, Inserted.InsuranceName
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.InsuranceName <> Deleted.InsuranceName
end

-------------------  ContactPerson  -----------------------------------------------------

if update(ContactPerson)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContactPerson', Deleted.ContactPerson, Inserted.ContactPerson
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.ContactPerson <> Deleted.ContactPerson
end

-------------------  Address  -----------------------------------------------------

if update(Address)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, Inserted.Address
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.Address <> Deleted.Address
end

-------------------  Phone  -----------------------------------------------------

if update(Phone)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, Inserted.Phone
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.Phone <> Deleted.Phone
end

-------------------  Fax  -----------------------------------------------------

if update(Fax)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Fax', Deleted.Fax, Inserted.Fax
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.Fax <> Deleted.Fax
end

-------------------  Email  -----------------------------------------------------

if update(Email)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Email', Deleted.Email, Inserted.Email
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.Email <> Deleted.Email
end

-------------------  Website  -----------------------------------------------------

if update(Website)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Website', Deleted.Website, Inserted.Website
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.Website <> Deleted.Website
end

-------------------  MemberDeclaration  -----------------------------------------------------

if update(MemberDeclaration)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberDeclaration', Deleted.MemberDeclaration, Inserted.MemberDeclaration
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.MemberDeclaration <> Deleted.MemberDeclaration
end

-------------------  DoctorDeclaration  -----------------------------------------------------

if update(DoctorDeclaration)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorDeclaration', Deleted.DoctorDeclaration, Inserted.DoctorDeclaration
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.DoctorDeclaration <> Deleted.DoctorDeclaration
end

-------------------  UseCustomFee  -----------------------------------------------------

if update(UseCustomFee)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UseCustomFee', Deleted.UseCustomFee, Inserted.UseCustomFee
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.UseCustomFee <> Deleted.UseCustomFee
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Insurances --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInsurances')
drop trigger utrDeleteInsurances
go

create trigger utrDeleteInsurances
on Insurances
for delete
as

declare @ErrorMSG varchar(200)
declare @AccountBillModesID varchar(10)
declare @PayTypeID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

-----------------------------------------------------------------------------------------------------------------------

set @AccountBillModesID = dbo.GetLookupDataID('BillModes', 'I')
set @PayTypeID = dbo.GetLookupDataID('PayType', 'INS')

if exists (select AccountBillNo from Accounts 
where (AccountBillNo in (select InsuranceNo from Deleted) and AccountBillModesID = @AccountBillModesID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Accounts'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select PayNo from Payments 
where (PayNo in (select InsuranceNo from Deleted) and PayTypeID = @PayTypeID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payments'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

-----------------------------------------------------------------------------------------------------------------------

------------------- Log Deletes ---------------------------------------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Insurances' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  InsuranceNo  -------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, null from Deleted

-------------------  InsuranceName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceName', Deleted.InsuranceName, null from Deleted

-------------------  ContactPerson  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContactPerson', Deleted.ContactPerson, null from Deleted

-------------------  Address  -----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, null from Deleted

-------------------  Phone  --------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, null from Deleted

-------------------  Fax  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Fax', Deleted.Fax, null from Deleted

-------------------  Email  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Email', Deleted.Email, null from Deleted

-------------------  Website  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Website', Deleted.Website, null from Deleted

-------------------  MemberDeclaration  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberDeclaration', Deleted.MemberDeclaration, null from Deleted

-------------------  DoctorDeclaration  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorDeclaration', Deleted.DoctorDeclaration, null from Deleted

-------------------  UseCustomFee  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UseCustomFee', Deleted.UseCustomFee, null from Deleted

-------------------  Hidden  -------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: InsurancePolicies -------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInsurancePolicies')
drop trigger utrUpdateInsurancePolicies
go

create trigger utrUpdateInsurancePolicies
on InsurancePolicies
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(PolicyID)
begin
set @ErrorMSG = 'You can''t update Policy ID for Insurance Policies, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(PolicyNo)
begin
set @ErrorMSG = 'You can''t update Policy No for Insurance Policies, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InsurancePolicies' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-PolicyNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyNo', Deleted.PolicyNo, Inserted.PolicyNo
from Inserted inner join Deleted
on Inserted.PolicyNo = Deleted.PolicyNo
end

-------------------  InsuranceNo  -----------------------------------------------------

if update(InsuranceNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, Inserted.InsuranceNo
from Inserted inner join Deleted
on Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.InsuranceNo <> Deleted.InsuranceNo
end

-------------------  PolicyName  -----------------------------------------------------

if update(PolicyName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyName', Deleted.PolicyName, Inserted.PolicyName
from Inserted inner join Deleted
on Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.PolicyName <> Deleted.PolicyName
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: InsurancePolicies -------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInsurancePolicies')
drop trigger utrDeleteInsurancePolicies
go

create trigger utrDeleteInsurancePolicies
on InsurancePolicies
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InsurancePolicies' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PolicyNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyNo', Deleted.PolicyNo, null from Deleted

-------------------  InsuranceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, null from Deleted

-------------------  PolicyName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyName', Deleted.PolicyName, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Companies ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateCompanies')
drop trigger utrUpdateCompanies
go

create trigger utrUpdateCompanies
on Companies
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(CompanyID)
begin
set @ErrorMSG = 'You can''t update Company ID for Companies, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(CompanyNo)
begin
set @ErrorMSG = 'You can''t update Company No for Companies, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Companies' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-CompanyNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CompanyNo', Deleted.CompanyNo, Inserted.CompanyNo
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
end

-------------------  CompanyName  -----------------------------------------------------

if update(CompanyName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CompanyName', Deleted.CompanyName, Inserted.CompanyName
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.CompanyName <> Deleted.CompanyName
end

-------------------  ContactPerson  -----------------------------------------------------

if update(ContactPerson)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContactPerson', Deleted.ContactPerson, Inserted.ContactPerson
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.ContactPerson <> Deleted.ContactPerson
end

-------------------  ContractStartDate  -----------------------------------------------------

if update(ContractStartDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContractStartDate', dbo.FormatDate(Deleted.ContractStartDate), dbo.FormatDate(Inserted.ContractStartDate)
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.ContractStartDate <> Deleted.ContractStartDate
end

-------------------  ContractEndDate  -----------------------------------------------------

if update(ContractEndDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContractEndDate', dbo.FormatDate(Deleted.ContractEndDate), dbo.FormatDate(Inserted.ContractEndDate)
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.ContractEndDate <> Deleted.ContractEndDate
end

-------------------  Address  -----------------------------------------------------

if update(Address)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, Inserted.Address
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.Address <> Deleted.Address
end

-------------------  Phone  -----------------------------------------------------

if update(Phone)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, Inserted.Phone
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.Phone <> Deleted.Phone
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Companies ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteCompanies')
drop trigger utrDeleteCompanies
go

create trigger utrDeleteCompanies
on Companies
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Companies' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  CompanyNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CompanyNo', Deleted.CompanyNo, null from Deleted

-------------------  CompanyName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CompanyName', Deleted.CompanyName, null from Deleted

-------------------  ContactPerson  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContactPerson', Deleted.ContactPerson, null from Deleted

-------------------  ContractStartDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContractStartDate', dbo.FormatDate(Deleted.ContractStartDate), null from Deleted

-------------------  ContractEndDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContractEndDate', dbo.FormatDate(Deleted.ContractEndDate), null from Deleted

-------------------  Address  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, null from Deleted

-------------------  Phone  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: InsuranceSchemes --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInsuranceSchemes')
drop trigger utrUpdateInsuranceSchemes
go

create trigger utrUpdateInsuranceSchemes
on InsuranceSchemes
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InsuranceSchemes' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-CompanyNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CompanyNo', Deleted.CompanyNo, Inserted.CompanyNo
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
end

------------------- Key-PolicyNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyNo', Deleted.PolicyNo, Inserted.PolicyNo
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
end

-------------------  SchemeJoinDate  -----------------------------------------------------

if update(SchemeJoinDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SchemeJoinDate', dbo.FormatDate(Deleted.SchemeJoinDate), dbo.FormatDate(Inserted.SchemeJoinDate)
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.SchemeJoinDate <> Deleted.SchemeJoinDate
end

-------------------  SchemeStartDate  -----------------------------------------------------

if update(SchemeStartDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SchemeStartDate', dbo.FormatDate(Deleted.SchemeStartDate), dbo.FormatDate(Inserted.SchemeStartDate)
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.SchemeStartDate <> Deleted.SchemeStartDate
end

-------------------  SchemeEndDate  -----------------------------------------------------

if update(SchemeEndDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SchemeEndDate', dbo.FormatDate(Deleted.SchemeEndDate), dbo.FormatDate(Inserted.SchemeEndDate)
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.SchemeEndDate <> Deleted.SchemeEndDate
end

-------------------  CoPayTypeID  -----------------------------------------------------

if update(CoPayTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayTypeID', Deleted.CoPayTypeID, Inserted.CoPayTypeID
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.CoPayTypeID <> Deleted.CoPayTypeID
end

-------------------  CoPayPercent  -----------------------------------------------------

if update(CoPayPercent)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayPercent', Deleted.CoPayPercent, Inserted.CoPayPercent
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.CoPayPercent <> Deleted.CoPayPercent
end

-------------------  CoPayValue  -----------------------------------------------------

if update(CoPayValue)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayValue', cast(Deleted.CoPayValue as varchar(20)), cast(Inserted.CoPayValue as varchar(20))
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.CoPayValue <> Deleted.CoPayValue
end

-------------------  AnnualPremium  -----------------------------------------------------

if update(AnnualPremium)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AnnualPremium', cast(Deleted.AnnualPremium as varchar(20)), cast(Inserted.AnnualPremium as varchar(20))
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.AnnualPremium <> Deleted.AnnualPremium
end

-------------------  MemberPremium  -----------------------------------------------------

if update(MemberPremium)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberPremium', cast(Deleted.MemberPremium as varchar(20)), cast(Inserted.MemberPremium as varchar(20))
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.MemberPremium <> Deleted.MemberPremium
end

-------------------  SmartCardApplicable  -----------------------------------------------------

if update(SmartCardApplicable)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SmartCardApplicable', Deleted.SmartCardApplicable, Inserted.SmartCardApplicable
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.SmartCardApplicable <> Deleted.SmartCardApplicable
end

-------------------  SchemeStatusID  -----------------------------------------------------

if update(SchemeStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SchemeStatusID', Deleted.SchemeStatusID, Inserted.SchemeStatusID
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.SchemeStatusID <> Deleted.SchemeStatusID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: InsuranceSchemes --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInsuranceSchemes')
drop trigger utrDeleteInsuranceSchemes
go

create trigger utrDeleteInsuranceSchemes
on InsuranceSchemes
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InsuranceSchemes' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  CompanyNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CompanyNo', Deleted.CompanyNo, null from Deleted

-------------------  PolicyNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyNo', Deleted.PolicyNo, null from Deleted

-------------------  SchemeJoinDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SchemeJoinDate', dbo.FormatDate(Deleted.SchemeJoinDate), null from Deleted

-------------------  SchemeStartDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SchemeStartDate', dbo.FormatDate(Deleted.SchemeStartDate), null from Deleted

-------------------  SchemeEndDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SchemeEndDate', dbo.FormatDate(Deleted.SchemeEndDate), null from Deleted

-------------------  CoPayTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayTypeID', Deleted.CoPayTypeID, null from Deleted

-------------------  CoPayPercent  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayPercent', Deleted.CoPayPercent, null from Deleted

-------------------  CoPayValue  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayValue', cast(Deleted.CoPayValue as varchar(20)), null from Deleted

-------------------  AnnualPremium  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AnnualPremium', cast(Deleted.AnnualPremium as varchar(20)), null from Deleted

-------------------  MemberPremium  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberPremium', cast(Deleted.MemberPremium as varchar(20)), null from Deleted

-------------------  SmartCardApplicable  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SmartCardApplicable', Deleted.SmartCardApplicable, null from Deleted

-------------------  SchemeStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SchemeStatusID', Deleted.SchemeStatusID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: PolicyLimits ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePolicyLimits')
drop trigger utrUpdatePolicyLimits
go

create trigger utrUpdatePolicyLimits
on PolicyLimits
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PolicyLimits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-CompanyNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CompanyNo', Deleted.CompanyNo, Inserted.CompanyNo
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.BenefitCode = Deleted.BenefitCode
end

------------------- Key-PolicyNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyNo', Deleted.PolicyNo, Inserted.PolicyNo
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.BenefitCode = Deleted.BenefitCode
end

------------------- Key-BenefitCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BenefitCode', Deleted.BenefitCode, Inserted.BenefitCode
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.BenefitCode = Deleted.BenefitCode
end

-------------------  PolicyLimit  -----------------------------------------------------

if update(PolicyLimit)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyLimit', cast(Deleted.PolicyLimit as varchar(20)), cast(Inserted.PolicyLimit as varchar(20))
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.BenefitCode = Deleted.BenefitCode
and Inserted.PolicyLimit <> Deleted.PolicyLimit
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: PolicyLimits ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePolicyLimits')
drop trigger utrDeletePolicyLimits
go

create trigger utrDeletePolicyLimits
on PolicyLimits
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PolicyLimits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  CompanyNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CompanyNo', Deleted.CompanyNo, null from Deleted

-------------------  PolicyNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyNo', Deleted.PolicyNo, null from Deleted

-------------------  BenefitCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BenefitCode', Deleted.BenefitCode, null from Deleted

-------------------  PolicyLimit  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyLimit', cast(Deleted.PolicyLimit as varchar(20)), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: InsuranceCustomFee ------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInsuranceCustomFee')
drop trigger utrUpdateInsuranceCustomFee
go

create trigger utrUpdateInsuranceCustomFee
on InsuranceCustomFee
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InsuranceCustomFee' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-InsuranceNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, Inserted.InsuranceNo
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  CustomFee  -----------------------------------------------------

if update(CustomFee)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CustomFee', cast(Deleted.CustomFee as varchar(20)), cast(Inserted.CustomFee as varchar(20))
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CustomFee <> Deleted.CustomFee
end

-------------------  CurrenciesID  -----------------------------------------------------

if update(CurrenciesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, Inserted.CurrenciesID
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CurrenciesID <> Deleted.CurrenciesID
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: InsuranceCustomFee ------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInsuranceCustomFee')
drop trigger utrDeleteInsuranceCustomFee
go

create trigger utrDeleteInsuranceCustomFee
on InsuranceCustomFee
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InsuranceCustomFee' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  InsuranceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  CustomFee  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CustomFee', cast(Deleted.CustomFee as varchar(20)), null from Deleted

-------------------  CurrenciesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: InsuranceExclusions -----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInsuranceExclusions')
drop trigger utrUpdateInsuranceExclusions
go

create trigger utrUpdateInsuranceExclusions
on InsuranceExclusions
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InsuranceExclusions' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-InsuranceNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, Inserted.InsuranceNo
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.InsuranceNo = Deleted.InsuranceNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

go

------------------------------------------------------------------------------------------------------
-------------- Delete: InsuranceExclusions -----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInsuranceExclusions')
drop trigger utrDeleteInsuranceExclusions
go

create trigger utrDeleteInsuranceExclusions
on InsuranceExclusions
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InsuranceExclusions' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  InsuranceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: InsuranceExcludedItems --------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInsuranceExcludedItems')
drop trigger utrUpdateInsuranceExcludedItems
go

create trigger utrUpdateInsuranceExcludedItems
on InsuranceExcludedItems
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InsuranceExcludedItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-CompanyNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CompanyNo', Deleted.CompanyNo, Inserted.CompanyNo
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-PolicyNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyNo', Deleted.PolicyNo, Inserted.PolicyNo
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.CompanyNo = Deleted.CompanyNo
and Inserted.PolicyNo = Deleted.PolicyNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: InsuranceExcludedItems --------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInsuranceExcludedItems')
drop trigger utrDeleteInsuranceExcludedItems
go

create trigger utrDeleteInsuranceExcludedItems
on InsuranceExcludedItems
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InsuranceExcludedItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  CompanyNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CompanyNo', Deleted.CompanyNo, null from Deleted

-------------------  PolicyNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyNo', Deleted.PolicyNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: SchemeMembers -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateSchemeMembers')
drop trigger utrUpdateSchemeMembers
go

create trigger utrUpdateSchemeMembers
on SchemeMembers
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(MedicalCardID)
begin
set @ErrorMSG = 'You can''t update Medical Card ID for Scheme Members, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

if update(MainMemberID)
begin
set @ErrorMSG = 'You can''t update Main Member ID for Scheme Members, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

if update(MedicalCardNo)
begin
set @ErrorMSG = 'You can''t update Medical Card No for Scheme Members, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'SchemeMembers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-MedicalCardNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalCardNo', Deleted.MedicalCardNo, Inserted.MedicalCardNo
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
end

-------------------  MemberTypeID  -----------------------------------------------------

if update(MemberTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberTypeID', Deleted.MemberTypeID, Inserted.MemberTypeID
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.MemberTypeID <> Deleted.MemberTypeID
end

-------------------  MainMemberNo  -----------------------------------------------------

if update(MainMemberNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MainMemberNo', Deleted.MainMemberNo, Inserted.MainMemberNo
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.MainMemberNo <> Deleted.MainMemberNo
end

-------------------  CompanyNo  -----------------------------------------------------

if update(CompanyNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CompanyNo', Deleted.CompanyNo, Inserted.CompanyNo
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.CompanyNo <> Deleted.CompanyNo
end

-------------------  PolicyNo  -----------------------------------------------------

if update(PolicyNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyNo', Deleted.PolicyNo, Inserted.PolicyNo
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.PolicyNo <> Deleted.PolicyNo
end

-------------------  ReferenceNo  -----------------------------------------------------

if update(ReferenceNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferenceNo', Deleted.ReferenceNo, Inserted.ReferenceNo
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.ReferenceNo <> Deleted.ReferenceNo
end

-------------------  Surname  -----------------------------------------------------

if update(Surname)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Surname', Deleted.Surname, Inserted.Surname
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.Surname <> Deleted.Surname
end

-------------------  FirstName  -----------------------------------------------------

if update(FirstName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FirstName', Deleted.FirstName, Inserted.FirstName
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.FirstName <> Deleted.FirstName
end

-------------------  MiddleName  -----------------------------------------------------

if update(MiddleName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MiddleName', Deleted.MiddleName, Inserted.MiddleName
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.MiddleName <> Deleted.MiddleName
end

-------------------  BirthDate  -----------------------------------------------------

if update(BirthDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BirthDate', dbo.FormatDate(Deleted.BirthDate), dbo.FormatDate(Inserted.BirthDate)
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.BirthDate <> Deleted.BirthDate
end

-------------------  GenderID  -----------------------------------------------------

if update(GenderID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GenderID', Deleted.GenderID, Inserted.GenderID
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.GenderID <> Deleted.GenderID
end

-------------------  Address  -----------------------------------------------------

if update(Address)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, Inserted.Address
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.Address <> Deleted.Address
end

-------------------  PhoneWork  -----------------------------------------------------

if update(PhoneWork)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhoneWork', Deleted.PhoneWork, Inserted.PhoneWork
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.PhoneWork <> Deleted.PhoneWork
end

-------------------  PhoneMobile  -----------------------------------------------------

if update(PhoneMobile)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhoneMobile', Deleted.PhoneMobile, Inserted.PhoneMobile
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.PhoneMobile <> Deleted.PhoneMobile
end

-------------------  PhoneHome  -----------------------------------------------------

if update(PhoneHome)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhoneHome', Deleted.PhoneHome, Inserted.PhoneHome
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.PhoneHome <> Deleted.PhoneHome
end

-------------------  Email  -----------------------------------------------------

if update(Email)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Email', Deleted.Email, Inserted.Email
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.Email <> Deleted.Email
end

-------------------  JoinDate  -----------------------------------------------------

if update(JoinDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'JoinDate', dbo.FormatDate(Deleted.JoinDate), dbo.FormatDate(Inserted.JoinDate)
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.JoinDate <> Deleted.JoinDate
end

-------------------  Relationship  -----------------------------------------------------

if update(Relationship)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Relationship', Deleted.Relationship, Inserted.Relationship
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.Relationship <> Deleted.Relationship
end

-------------------  PolicyStartDate  -----------------------------------------------------

if update(PolicyStartDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyStartDate', dbo.FormatDate(Deleted.PolicyStartDate), dbo.FormatDate(Inserted.PolicyStartDate)
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.PolicyStartDate <> Deleted.PolicyStartDate
end

-------------------  PolicyEndDate  -----------------------------------------------------

if update(PolicyEndDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyEndDate', dbo.FormatDate(Deleted.PolicyEndDate), dbo.FormatDate(Inserted.PolicyEndDate)
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.PolicyEndDate <> Deleted.PolicyEndDate
end

-------------------  MemberStatusID  -----------------------------------------------------

if update(MemberStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberStatusID', Deleted.MemberStatusID, Inserted.MemberStatusID
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.MemberStatusID <> Deleted.MemberStatusID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.MedicalCardNo = Deleted.MedicalCardNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: SchemeMembers -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteSchemeMembers')
drop trigger utrDeleteSchemeMembers
go

create trigger utrDeleteSchemeMembers
on SchemeMembers
for delete
as

declare @ErrorMSG varchar(200)
declare @BillModesID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

-----------------------------------------------------------------------------------------------------------------------

set @BillModesID = dbo.GetLookupDataID('BillModes', 'I')

if exists (select DefaultBillNo from Patients 
where (DefaultBillNo in (select MedicalCardNo from Deleted) and DefaultBillModesID = @BillModesID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Patients'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select BillNo from Visits 
where (BillNo in (select MedicalCardNo from Deleted) and BillModesID = @BillModesID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Visits'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

-----------------------------------------------------------------------------------------------------------------------

------------------- Log Deletes ---------------------------------------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'SchemeMembers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  MedicalCardNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalCardNo', Deleted.MedicalCardNo, null from Deleted

-------------------  MemberTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberTypeID', Deleted.MemberTypeID, null from Deleted

-------------------  MainMemberNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MainMemberNo', Deleted.MainMemberNo, null from Deleted

-------------------  CompanyNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CompanyNo', Deleted.CompanyNo, null from Deleted

-------------------  PolicyNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyNo', Deleted.PolicyNo, null from Deleted

-------------------  ReferenceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferenceNo', Deleted.ReferenceNo, null from Deleted

-------------------  Surname  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Surname', Deleted.Surname, null from Deleted

-------------------  FirstName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FirstName', Deleted.FirstName, null from Deleted

-------------------  MiddleName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MiddleName', Deleted.MiddleName, null from Deleted

-------------------  BirthDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BirthDate', dbo.FormatDate(Deleted.BirthDate), null from Deleted

-------------------  GenderID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GenderID', Deleted.GenderID, null from Deleted

-------------------  Address  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, null from Deleted

-------------------  PhoneWork  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhoneWork', Deleted.PhoneWork, null from Deleted

-------------------  PhoneMobile  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhoneMobile', Deleted.PhoneMobile, null from Deleted

-------------------  PhoneHome  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhoneHome', Deleted.PhoneHome, null from Deleted

-------------------  Email  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Email', Deleted.Email, null from Deleted

-------------------  JoinDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'JoinDate', dbo.FormatDate(Deleted.JoinDate), null from Deleted

-------------------  Relationship  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Relationship', Deleted.Relationship, null from Deleted

-------------------  PolicyStartDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyStartDate', dbo.FormatDate(Deleted.PolicyStartDate), null from Deleted

-------------------  PolicyEndDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PolicyEndDate', dbo.FormatDate(Deleted.PolicyEndDate), null from Deleted

-------------------  MemberStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberStatusID', Deleted.MemberStatusID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: HealthUnits -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateHealthUnits')
drop trigger utrUpdateHealthUnits
go

create trigger utrUpdateHealthUnits
on HealthUnits
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'HealthUnits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-HealthUnitCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HealthUnitCode', Deleted.HealthUnitCode, Inserted.HealthUnitCode
from Inserted inner join Deleted
on Inserted.HealthUnitCode = Deleted.HealthUnitCode
end

-------------------  HealthUnitName  -----------------------------------------------------

if update(HealthUnitName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HealthUnitName', Deleted.HealthUnitName, Inserted.HealthUnitName
from Inserted inner join Deleted
on Inserted.HealthUnitCode = Deleted.HealthUnitCode
and Inserted.HealthUnitName <> Deleted.HealthUnitName
end

-------------------  DistrictsID  -----------------------------------------------------

if update(DistrictsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DistrictsID', Deleted.DistrictsID, Inserted.DistrictsID
from Inserted inner join Deleted
on Inserted.HealthUnitCode = Deleted.HealthUnitCode
and Inserted.DistrictsID <> Deleted.DistrictsID
end

-------------------  ContactPerson  -----------------------------------------------------

if update(ContactPerson)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContactPerson', Deleted.ContactPerson, Inserted.ContactPerson
from Inserted inner join Deleted
on Inserted.HealthUnitCode = Deleted.HealthUnitCode
and Inserted.ContactPerson <> Deleted.ContactPerson
end

-------------------  Address  -----------------------------------------------------

if update(Address)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, Inserted.Address
from Inserted inner join Deleted
on Inserted.HealthUnitCode = Deleted.HealthUnitCode
and Inserted.Address <> Deleted.Address
end

-------------------  Phone  -----------------------------------------------------

if update(Phone)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, Inserted.Phone
from Inserted inner join Deleted
on Inserted.HealthUnitCode = Deleted.HealthUnitCode
and Inserted.Phone <> Deleted.Phone
end

go

------------------------------------------------------------------------------------------------------
-------------- Delete: HealthUnits -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteHealthUnits')
drop trigger utrDeleteHealthUnits
go

create trigger utrDeleteHealthUnits
on HealthUnits
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'HealthUnits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  HealthUnitCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HealthUnitCode', Deleted.HealthUnitCode, null from Deleted

-------------------  HealthUnitName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HealthUnitName', Deleted.HealthUnitName, null from Deleted

-------------------  DistrictsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DistrictsID', Deleted.DistrictsID, null from Deleted

-------------------  ContactPerson  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContactPerson', Deleted.ContactPerson, null from Deleted

-------------------  Address  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, null from Deleted

-------------------  Phone  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Counties ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateCounties')
drop trigger utrUpdateCounties
go

create trigger utrUpdateCounties
on Counties
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Counties' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(minute, @FullDate, getdate()) > 1 return

------------------- Key-CountyCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CountyCode', Deleted.CountyCode, Inserted.CountyCode
from Inserted inner join Deleted
on Inserted.CountyCode = Deleted.CountyCode
end

-------------------  CountyName  -----------------------------------------------------

if update(CountyName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CountyName', Deleted.CountyName, Inserted.CountyName
from Inserted inner join Deleted
on Inserted.CountyCode = Deleted.CountyCode
and Inserted.CountyName <> Deleted.CountyName
end

-------------------  DistrictsID  -----------------------------------------------------

if update(DistrictsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DistrictsID', Deleted.DistrictsID, Inserted.DistrictsID
from Inserted inner join Deleted
on Inserted.CountyCode = Deleted.CountyCode
and Inserted.DistrictsID <> Deleted.DistrictsID
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Counties ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteCounties')
drop trigger utrDeleteCounties
go

create trigger utrDeleteCounties
on Counties
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Counties' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(minute, @FullDate, getdate()) > 1 return

-------------------  CountyCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CountyCode', Deleted.CountyCode, null from Deleted

-------------------  CountyName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CountyName', Deleted.CountyName, null from Deleted

-------------------  DistrictsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DistrictsID', Deleted.DistrictsID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: SubCounties -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateSubCounties')
drop trigger utrUpdateSubCounties
go

create trigger utrUpdateSubCounties
on SubCounties
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'SubCounties' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(minute, @FullDate, getdate()) > 1 return

------------------- Key-SubCountyCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SubCountyCode', Deleted.SubCountyCode, Inserted.SubCountyCode
from Inserted inner join Deleted
on Inserted.SubCountyCode = Deleted.SubCountyCode
end

-------------------  SubCountyName  -----------------------------------------------------

if update(SubCountyName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SubCountyName', Deleted.SubCountyName, Inserted.SubCountyName
from Inserted inner join Deleted
on Inserted.SubCountyCode = Deleted.SubCountyCode
and Inserted.SubCountyName <> Deleted.SubCountyName
end

-------------------  CountyCode  -----------------------------------------------------

if update(CountyCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CountyCode', Deleted.CountyCode, Inserted.CountyCode
from Inserted inner join Deleted
on Inserted.SubCountyCode = Deleted.SubCountyCode
and Inserted.CountyCode <> Deleted.CountyCode
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: SubCounties -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteSubCounties')
drop trigger utrDeleteSubCounties
go

create trigger utrDeleteSubCounties
on SubCounties
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'SubCounties' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(minute, @FullDate, getdate()) > 1 return

-------------------  SubCountyCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SubCountyCode', Deleted.SubCountyCode, null from Deleted

-------------------  SubCountyName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SubCountyName', Deleted.SubCountyName, null from Deleted

-------------------  CountyCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CountyCode', Deleted.CountyCode, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Parishes ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateParishes')
drop trigger utrUpdateParishes
go

create trigger utrUpdateParishes
on Parishes
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Parishes' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(minute, @FullDate, getdate()) > 1 return

------------------- Key-ParishCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ParishCode', Deleted.ParishCode, Inserted.ParishCode
from Inserted inner join Deleted
on Inserted.ParishCode = Deleted.ParishCode
end

-------------------  ParishName  -----------------------------------------------------

if update(ParishName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ParishName', Deleted.ParishName, Inserted.ParishName
from Inserted inner join Deleted
on Inserted.ParishCode = Deleted.ParishCode
and Inserted.ParishName <> Deleted.ParishName
end

-------------------  SubCountyCode  -----------------------------------------------------

if update(SubCountyCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SubCountyCode', Deleted.SubCountyCode, Inserted.SubCountyCode
from Inserted inner join Deleted
on Inserted.ParishCode = Deleted.ParishCode
and Inserted.SubCountyCode <> Deleted.SubCountyCode
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Parishes ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteParishes')
drop trigger utrDeleteParishes
go

create trigger utrDeleteParishes
on Parishes
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Parishes' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(minute, @FullDate, getdate()) > 1 return

-------------------  ParishCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ParishCode', Deleted.ParishCode, null from Deleted

-------------------  ParishName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ParishName', Deleted.ParishName, null from Deleted

-------------------  SubCountyCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SubCountyCode', Deleted.SubCountyCode, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Villages ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateVillages')
drop trigger utrUpdateVillages
go

create trigger utrUpdateVillages
on Villages
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Villages' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(minute, @FullDate, getdate()) > 1 return

------------------- Key-VillageCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VillageCode', Deleted.VillageCode, Inserted.VillageCode
from Inserted inner join Deleted
on Inserted.VillageCode = Deleted.VillageCode
end

-------------------  VillageName  -----------------------------------------------------

if update(VillageName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VillageName', Deleted.VillageName, Inserted.VillageName
from Inserted inner join Deleted
on Inserted.VillageCode = Deleted.VillageCode
and Inserted.VillageName <> Deleted.VillageName
end

-------------------  ParishCode  -----------------------------------------------------

if update(ParishCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ParishCode', Deleted.ParishCode, Inserted.ParishCode
from Inserted inner join Deleted
on Inserted.VillageCode = Deleted.VillageCode
and Inserted.ParishCode <> Deleted.ParishCode
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Villages ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteVillages')
drop trigger utrDeleteVillages
go

create trigger utrDeleteVillages
on Villages
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Villages' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(minute, @FullDate, getdate()) > 1 return

-------------------  VillageCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VillageCode', Deleted.VillageCode, null from Deleted

-------------------  VillageName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VillageName', Deleted.VillageName, null from Deleted

-------------------  ParishCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ParishCode', Deleted.ParishCode, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Suppliers ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateSuppliers')
drop trigger utrUpdateSuppliers
go

create trigger utrUpdateSuppliers
on Suppliers
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(SupplierID)
begin
set @ErrorMSG = 'You can''t update Supplier ID for Suppliers, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(SupplierNo)
begin
set @ErrorMSG = 'You can''t update Supplier No for Suppliers, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Suppliers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-SupplierNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SupplierNo', Deleted.SupplierNo, Inserted.SupplierNo
from Inserted inner join Deleted
on Inserted.SupplierNo = Deleted.SupplierNo
end

-------------------  SupplierName  -----------------------------------------------------

if update(SupplierName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SupplierName', Deleted.SupplierName, Inserted.SupplierName
from Inserted inner join Deleted
on Inserted.SupplierNo = Deleted.SupplierNo
and Inserted.SupplierName <> Deleted.SupplierName
end

-------------------  ContactPerson  -----------------------------------------------------

if update(ContactPerson)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContactPerson', Deleted.ContactPerson, Inserted.ContactPerson
from Inserted inner join Deleted
on Inserted.SupplierNo = Deleted.SupplierNo
and Inserted.ContactPerson <> Deleted.ContactPerson
end

-------------------  Address  -----------------------------------------------------

if update(Address)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, Inserted.Address
from Inserted inner join Deleted
on Inserted.SupplierNo = Deleted.SupplierNo
and Inserted.Address <> Deleted.Address
end

-------------------  Phone  -----------------------------------------------------

if update(Phone)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, Inserted.Phone
from Inserted inner join Deleted
on Inserted.SupplierNo = Deleted.SupplierNo
and Inserted.Phone <> Deleted.Phone
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Suppliers ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteSuppliers')
drop trigger utrDeleteSuppliers
go

create trigger utrDeleteSuppliers
on Suppliers
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Suppliers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  SupplierNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SupplierNo', Deleted.SupplierNo, null from Deleted

-------------------  SupplierName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SupplierName', Deleted.SupplierName, null from Deleted

-------------------  ContactPerson  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContactPerson', Deleted.ContactPerson, null from Deleted

-------------------  Address  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Address', Deleted.Address, null from Deleted

-------------------  Phone  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, null from Deleted
go

----------------------------------------------------------------------------------------------------------------------------
------------- Update: Visits -----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateVisits')
drop trigger utrUpdateVisits
go

create trigger utrUpdateVisits
on Visits
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

if update(VisitID)
begin
set @ErrorMSG = 'You can''t update Visit ID for Visits, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(VisitNo)
begin
set @ErrorMSG = 'You can''t update Visit No for Visits, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Visits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
end

------------------- VisitDate -----------------------------------------------------

if update(VisitDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitDate', dbo.FormatDate(Deleted.VisitDate), dbo.FormatDate(Inserted.VisitDate)
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.VisitDate <> Deleted.VisitDate
end

------------------- DoctorSpecialtyID -----------------------------------------------------

if update(DoctorSpecialtyID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, Inserted.DoctorSpecialtyID
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DoctorSpecialtyID <> Deleted.DoctorSpecialtyID
end

------------------- StaffNo -----------------------------------------------------

if update(StaffNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.StaffNo <> Deleted.StaffNo
end

------------------- VisitStatusID -----------------------------------------------------

if update(VisitStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitStatusID', Deleted.VisitStatusID, Inserted.VisitStatusID
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.VisitStatusID <> Deleted.VisitStatusID
end

------------------- BranchID -----------------------------------------------------

if update(BranchID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BranchID', Deleted.BranchID, Inserted.BranchID
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID <> Deleted.BranchID
end

------------------- AccessCashServices -----------------------------------------------------

if update(AccessCashServices)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccessCashServices', Deleted.AccessCashServices, Inserted.AccessCashServices
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.AccessCashServices <> Deleted.AccessCashServices
end

------------------- FingerprintVerified -----------------------------------------------------

if update(FingerprintVerified)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FingerprintVerified', Deleted.FingerprintVerified, Inserted.FingerprintVerified
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.FingerprintVerified <> Deleted.FingerprintVerified
end

-------------------  InsuranceNo  -----------------------------------------------------

if update(InsuranceNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, Inserted.InsuranceNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.InsuranceNo <> Deleted.InsuranceNo
end

-------------------  AssociatedBillNo  -----------------------------------------------------

if update(AssociatedBillNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AssociatedBillNo', Deleted.AssociatedBillNo, Inserted.AssociatedBillNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.AssociatedBillNo <> Deleted.AssociatedBillNo
end

-------------------  MemberCardNo  -----------------------------------------------------

if update(MemberCardNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberCardNo', Deleted.MemberCardNo, Inserted.MemberCardNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.MemberCardNo <> Deleted.MemberCardNo
end

-------------------  MainMemberName  -----------------------------------------------------

if update(MainMemberName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MainMemberName', Deleted.MainMemberName, Inserted.MainMemberName
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.MainMemberName <> Deleted.MainMemberName
end

-------------------  ClaimReferenceNo  -----------------------------------------------------

if update(ClaimReferenceNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimReferenceNo', Deleted.ClaimReferenceNo, Inserted.ClaimReferenceNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ClaimReferenceNo <> Deleted.ClaimReferenceNo
end

-------------------  CoPayTypeID  -----------------------------------------------------

if update(CoPayTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayTypeID', Deleted.CoPayTypeID, Inserted.CoPayTypeID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CoPayTypeID <> Deleted.CoPayTypeID
end

-------------------  CoPayPercent  -----------------------------------------------------

if update(CoPayPercent)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayPercent', Deleted.CoPayPercent, Inserted.CoPayPercent
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CoPayPercent <> Deleted.CoPayPercent
end

-------------------  Locked  ------------------------------------------------------

if update(Locked)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Locked', Deleted.Locked, Inserted.Locked
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Locked <> Deleted.Locked
end

-------------------  CoPayValue  -----------------------------------------------------

if update(CoPayValue)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayValue', cast(Deleted.CoPayValue as varchar(20)), cast(Inserted.CoPayValue as varchar(20))
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CoPayValue <> Deleted.CoPayValue
end

-------------------  SmartCardApplicable  -----------------------------------------------------

if update(SmartCardApplicable)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SmartCardApplicable', Deleted.SmartCardApplicable, Inserted.SmartCardApplicable
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.SmartCardApplicable <> Deleted.SmartCardApplicable
end

------------------- LoginID ----------------------------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

go

----------------------------------------------------------------------------------------------------------------------------
------------- Delete: Visits -----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteVisits')
drop trigger utrDeleteVisits
go

create trigger utrDeleteVisits
on Visits
for  delete
as

declare @ErrorMSG varchar(200)
declare @PayTypeID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

-----------------------------------------------------------------------------------------------------------------------

set @PayTypeID = dbo.GetLookupDataID('PayType', 'CAS')

if exists (select PayNo from Payments 
where (PayNo in (select VisitNo from Deleted) and PayTypeID = @PayTypeID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payments'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

-----------------------------------------------------------------------------------------------------------------------

------------------- Log Deletes ---------------------------------------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return

set @Identity = ident_current('AuditTrail') 
if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Visits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- VisitNo -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted 

------------------- PatientNo -----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted 

------------------- VisitDate -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitDate', dbo.FormatDate(Deleted.VisitDate), null from Deleted 

------------------- DoctorSpecialtyID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, null from Deleted 

------------------- StaffNo -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted 

------------------- VisitCategoryID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitCategoryID', Deleted.VisitCategoryID, null from Deleted 

------------------- BranchID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BranchID', Deleted.BranchID, null from Deleted

------------------- ReferredBy -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferredBy', Deleted.ReferredBy, null from Deleted 

------------------- ServiceCode -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceCode', Deleted.ServiceCode, null from Deleted 

------------------- BillNo -----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillNo', Deleted.BillNo, null from Deleted 

-------------------  InsuranceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, null from Deleted

-------------------  AssociatedBillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AssociatedBillNo', Deleted.AssociatedBillNo, null from Deleted

-------------------  MemberCardNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberCardNo', Deleted.MemberCardNo, null from Deleted

-------------------  MainMemberName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MainMemberName', Deleted.MainMemberName, null from Deleted

-------------------  ClaimReferenceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimReferenceNo', Deleted.ClaimReferenceNo, null from Deleted

------------------- VisitStatusID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitStatusID', Deleted.VisitStatusID, null from Deleted 

------------------- AccessCashServices -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccessCashServices', Deleted.AccessCashServices, null from Deleted

-------------------  Locked  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Locked', Deleted.Locked, null from Deleted

------------------- FingerprintVerified -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FingerprintVerified', Deleted.FingerprintVerified, null from Deleted 

-------------------  CoPayTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayTypeID', Deleted.CoPayTypeID, null from Deleted

-------------------  CoPayPercent  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayPercent', Deleted.CoPayPercent, null from Deleted

-------------------  CoPayValue  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayValue', cast(Deleted.CoPayValue as varchar(20)), null from Deleted

-------------------  SmartCardApplicable  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SmartCardApplicable', Deleted.SmartCardApplicable, null from Deleted

------------------- LoginID -----------------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted 

-------------------  ClientMachine  ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

------------------- RecordDateTime ----------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted 
go

------------------------------------------------------------------------------------------------------
-------------- Update: VisitFiles --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateVisitFiles')
drop trigger utrUpdateVisitFiles
go

create trigger utrUpdateVisitFiles
on VisitFiles
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'VisitFiles' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  FileStatusID  -----------------------------------------------------

if update(FileStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FileStatusID', Deleted.FileStatusID, Inserted.FileStatusID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.FileStatusID <> Deleted.FileStatusID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: VisitFiles --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteVisitFiles')
drop trigger utrDeleteVisitFiles
go

create trigger utrDeleteVisitFiles
on VisitFiles
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'VisitFiles' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  FileStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FileStatusID', Deleted.FileStatusID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: SmartCardAuthorisations -------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateSmartCardAuthorisations')
drop trigger utrUpdateSmartCardAuthorisations
go

create trigger utrUpdateSmartCardAuthorisations
on SmartCardAuthorisations
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'SmartCardAuthorisations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-PatientNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BillModesID = Deleted.BillModesID
and Inserted.BillNo = Deleted.BillNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
end

------------------- Key-BillModesID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillModesID', Deleted.BillModesID, Inserted.BillModesID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BillModesID = Deleted.BillModesID
and Inserted.BillNo = Deleted.BillNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
end

------------------- Key-BillNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillNo', Deleted.BillNo, Inserted.BillNo
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BillModesID = Deleted.BillModesID
and Inserted.BillNo = Deleted.BillNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
end

------------------- Key-ToVisitDate -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ToVisitDate', dbo.FormatDate(Deleted.ToVisitDate), dbo.FormatDate(Inserted.ToVisitDate)
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BillModesID = Deleted.BillModesID
and Inserted.BillNo = Deleted.BillNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
end

-------------------  MedicalCardNo  -----------------------------------------------------

if update(MedicalCardNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalCardNo', Deleted.MedicalCardNo, Inserted.MedicalCardNo
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BillModesID = Deleted.BillModesID
and Inserted.BillNo = Deleted.BillNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
and Inserted.MedicalCardNo <> Deleted.MedicalCardNo
end

-------------------  AuthorisedBy  -----------------------------------------------------

if update(AuthorisedBy)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AuthorisedBy', Deleted.AuthorisedBy, Inserted.AuthorisedBy
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BillModesID = Deleted.BillModesID
and Inserted.BillNo = Deleted.BillNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
and Inserted.AuthorisedBy <> Deleted.AuthorisedBy
end

-------------------  AuthorisationReason  -----------------------------------------------------

if update(AuthorisationReason)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AuthorisationReason', Deleted.AuthorisationReason, Inserted.AuthorisationReason
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BillModesID = Deleted.BillModesID
and Inserted.BillNo = Deleted.BillNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
and Inserted.AuthorisationReason <> Deleted.AuthorisationReason
end

-------------------  ClaimReferenceNo  -----------------------------------------------------

if update(ClaimReferenceNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimReferenceNo', Deleted.ClaimReferenceNo, Inserted.ClaimReferenceNo
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BillModesID = Deleted.BillModesID
and Inserted.BillNo = Deleted.BillNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
and Inserted.ClaimReferenceNo <> Deleted.ClaimReferenceNo
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BillModesID = Deleted.BillModesID
and Inserted.BillNo = Deleted.BillNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BillModesID = Deleted.BillModesID
and Inserted.BillNo = Deleted.BillNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.BillModesID = Deleted.BillModesID
and Inserted.BillNo = Deleted.BillNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: SmartCardAuthorisations -------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteSmartCardAuthorisations')
drop trigger utrDeleteSmartCardAuthorisations
go

create trigger utrDeleteSmartCardAuthorisations
on SmartCardAuthorisations
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'SmartCardAuthorisations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  BillModesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillModesID', Deleted.BillModesID, null from Deleted

-------------------  BillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillNo', Deleted.BillNo, null from Deleted

-------------------  ToVisitDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ToVisitDate', dbo.FormatDate(Deleted.ToVisitDate), null from Deleted

-------------------  MedicalCardNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalCardNo', Deleted.MedicalCardNo, null from Deleted

-------------------  AuthorisedBy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AuthorisedBy', Deleted.AuthorisedBy, null from Deleted

-------------------  AuthorisationReason  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AuthorisationReason', Deleted.AuthorisationReason, null from Deleted

-------------------  ClaimReferenceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimReferenceNo', Deleted.ClaimReferenceNo, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Triage ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateTriage')
drop trigger utrUpdateTriage
go

create trigger utrUpdateTriage
on Triage
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates -----------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Triage' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  Weight  -----------------------------------------------------

if update(Weight)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Weight', Deleted.Weight, Inserted.Weight
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Weight <> Deleted.Weight
end

-------------------  Temperature  -----------------------------------------------------

if update(Temperature)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Temperature', Deleted.Temperature, Inserted.Temperature
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Temperature <> Deleted.Temperature
end

-------------------  Height  -----------------------------------------------------

if update(Height)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Height', Deleted.Height, Inserted.Height
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Height <> Deleted.Height
end

-------------------  Pulse  -----------------------------------------------------

if update(Pulse)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pulse', Deleted.Pulse, Inserted.Pulse
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Pulse <> Deleted.Pulse
end

-------------------  BloodPressure  -----------------------------------------------------

if update(BloodPressure)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodPressure', Deleted.BloodPressure, Inserted.BloodPressure
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BloodPressure <> Deleted.BloodPressure
end

-------------------  HeadCircum  -----------------------------------------------------

if update(HeadCircum)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeadCircum', Deleted.HeadCircum, Inserted.HeadCircum
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.HeadCircum <> Deleted.HeadCircum
end

-------------------  BodySurfaceArea  -----------------------------------------------------

if update(BodySurfaceArea)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BodySurfaceArea', Deleted.BodySurfaceArea, Inserted.BodySurfaceArea
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BodySurfaceArea <> Deleted.BodySurfaceArea
end

-------------------  RespirationRate  -----------------------------------------------------

if update(RespirationRate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RespirationRate', Deleted.RespirationRate, Inserted.RespirationRate
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RespirationRate <> Deleted.RespirationRate
end

-------------------  OxygenSaturation  -----------------------------------------------------

if update(OxygenSaturation)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OxygenSaturation', Deleted.OxygenSaturation, Inserted.OxygenSaturation
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OxygenSaturation <> Deleted.OxygenSaturation
end

-------------------  HeartRate  -----------------------------------------------------

if update(HeartRate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeartRate', Deleted.HeartRate, Inserted.HeartRate
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.HeartRate <> Deleted.HeartRate
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Triage ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteTriage')
drop trigger utrDeleteTriage
go

create trigger utrDeleteTriage
on Triage
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Triage' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  Weight  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Weight', Deleted.Weight, null from Deleted

-------------------  Temperature  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Temperature', Deleted.Temperature, null from Deleted

-------------------  Height  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Height', Deleted.Height, null from Deleted

-------------------  Pulse  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pulse', Deleted.Pulse, null from Deleted

-------------------  BloodPressure  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodPressure', Deleted.BloodPressure, null from Deleted

-------------------  HeadCircum  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeadCircum', Deleted.HeadCircum, null from Deleted

-------------------  BodySurfaceArea  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BodySurfaceArea', Deleted.BodySurfaceArea, null from Deleted

-------------------  RespirationRate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RespirationRate', Deleted.RespirationRate, null from Deleted

-------------------  OxygenSaturation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OxygenSaturation', Deleted.OxygenSaturation, null from Deleted

-------------------  HeartRate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeartRate', Deleted.HeartRate, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: VisionAssessment --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateVisionAssessment')
drop trigger utrUpdateVisionAssessment
go

create trigger utrUpdateVisionAssessment
on VisionAssessment
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'VisionAssessment' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EyeTestID = Deleted.EyeTestID
end

------------------- Key-EyeTestID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EyeTestID', Deleted.EyeTestID, Inserted.EyeTestID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EyeTestID = Deleted.EyeTestID
end

-------------------  VisualAcuityRightID  -----------------------------------------------------

if update(VisualAcuityRightID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityRightID', Deleted.VisualAcuityRightID, Inserted.VisualAcuityRightID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.VisualAcuityRightID <> Deleted.VisualAcuityRightID
end

-------------------  VisualAcuityRightExtID  -----------------------------------------------------

if update(VisualAcuityRightExtID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityRightExtID', Deleted.VisualAcuityRightExtID, Inserted.VisualAcuityRightExtID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.VisualAcuityRightExtID <> Deleted.VisualAcuityRightExtID
end

-------------------  VisualAcuityLeftID  -----------------------------------------------------

if update(VisualAcuityLeftID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityLeftID', Deleted.VisualAcuityLeftID, Inserted.VisualAcuityLeftID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.VisualAcuityLeftID <> Deleted.VisualAcuityLeftID
end

-------------------  VisualAcuityLeftExtID  -----------------------------------------------------

if update(VisualAcuityLeftExtID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityLeftExtID', Deleted.VisualAcuityLeftExtID, Inserted.VisualAcuityLeftExtID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.VisualAcuityLeftExtID <> Deleted.VisualAcuityLeftExtID
end


-------------------  PreferentialLookingRightID  -----------------------------------------------------

if update(PreferentialLookingRightID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreferentialLookingRightID', Deleted.PreferentialLookingRightID, Inserted.PreferentialLookingRightID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.PreferentialLookingRightID <> Deleted.PreferentialLookingRightID
end

-------------------  PreferentialLookingLeftID  -----------------------------------------------------

if update(PreferentialLookingLeftID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreferentialLookingLeftID', Deleted.PreferentialLookingLeftID, Inserted.PreferentialLookingLeftID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.PreferentialLookingLeftID <> Deleted.PreferentialLookingLeftID
end


-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.ClientMachine <> Deleted.ClientMachine
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: VisionAssessment --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteVisionAssessment')
drop trigger utrDeleteVisionAssessment
go

create trigger utrDeleteVisionAssessment
on VisionAssessment
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'VisionAssessment' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  EyeTestID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EyeTestID', Deleted.EyeTestID, null from Deleted

-------------------  VisualAcuityRightID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityRightID', Deleted.VisualAcuityRightID, null from Deleted

-------------------  VisualAcuityRightExtID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityRightExtID', Deleted.VisualAcuityRightExtID, null from Deleted

-------------------  VisualAcuityLeftID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityLeftID', Deleted.VisualAcuityLeftID, null from Deleted

-------------------  VisualAcuityLeftExtID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityLeftExtID', Deleted.VisualAcuityLeftExtID, null from Deleted


-------------------  PreferentialLookingRightID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreferentialLookingRightID', Deleted.PreferentialLookingRightID, null from Deleted

-------------------  PreferentialLookingLeftID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreferentialLookingLeftID', Deleted.PreferentialLookingLeftID, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: DrugCategories ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateDrugCategories')
drop trigger utrUpdateDrugCategories
go

create trigger utrUpdateDrugCategories
on DrugCategories
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'DrugCategories' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-CategoryNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CategoryNo', Deleted.CategoryNo, Inserted.CategoryNo
from Inserted inner join Deleted
on Inserted.CategoryNo = Deleted.CategoryNo
end

-------------------  CategoryName  -----------------------------------------------------

if update(CategoryName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CategoryName', Deleted.CategoryName, Inserted.CategoryName
from Inserted inner join Deleted
on Inserted.CategoryNo = Deleted.CategoryNo
and Inserted.CategoryName <> Deleted.CategoryName
end

-------------------  VaryPrescribedQty  -----------------------------------------------------

if update(VaryPrescribedQty)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VaryPrescribedQty', Deleted.VaryPrescribedQty, Inserted.VaryPrescribedQty
from Inserted inner join Deleted
on Inserted.CategoryNo = Deleted.CategoryNo
and Inserted.VaryPrescribedQty <> Deleted.VaryPrescribedQty
end

-------------------  DefaultPrescribedQty  -----------------------------------------------------

if update(DefaultPrescribedQty)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DefaultPrescribedQty', Deleted.DefaultPrescribedQty, Inserted.DefaultPrescribedQty
from Inserted inner join Deleted
on Inserted.CategoryNo = Deleted.CategoryNo
and Inserted.DefaultPrescribedQty <> Deleted.DefaultPrescribedQty
end

-------------------  DosageSeparator  -----------------------------------------------------

if update(DosageSeparator)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DosageSeparator', Deleted.DosageSeparator, Inserted.DosageSeparator
from Inserted inner join Deleted
on Inserted.CategoryNo = Deleted.CategoryNo
and Inserted.DosageSeparator <> Deleted.DosageSeparator
end

-------------------  DosageCalculationID  -----------------------------------------------------

if update(DosageCalculationID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DosageCalculationID', Deleted.DosageCalculationID, Inserted.DosageCalculationID
from Inserted inner join Deleted
on Inserted.CategoryNo = Deleted.CategoryNo
and Inserted.DosageCalculationID <> Deleted.DosageCalculationID
end

-------------------  DosageFormat  -----------------------------------------------------

if update(DosageFormat)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DosageFormat', Deleted.DosageFormat, Inserted.DosageFormat
from Inserted inner join Deleted
on Inserted.CategoryNo = Deleted.CategoryNo
and Inserted.DosageFormat <> Deleted.DosageFormat
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: DrugCategories ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteDrugCategories')
drop trigger utrDeleteDrugCategories
go

create trigger utrDeleteDrugCategories
on DrugCategories
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'DrugCategories' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  CategoryNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CategoryNo', Deleted.CategoryNo, null from Deleted

-------------------  CategoryName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CategoryName', Deleted.CategoryName, null from Deleted

-------------------  VaryPrescribedQty  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VaryPrescribedQty', Deleted.VaryPrescribedQty, null from Deleted

-------------------  DefaultPrescribedQty  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DefaultPrescribedQty', Deleted.DefaultPrescribedQty, null from Deleted

-------------------  DosageSeparator  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DosageSeparator', Deleted.DosageSeparator, null from Deleted

-------------------  DosageCalculationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DosageCalculationID', Deleted.DosageCalculationID, null from Deleted

-------------------  DosageFormat  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DosageFormat', Deleted.DosageFormat, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Drugs -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
-------------- Update: Drugs -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateDrugs')
drop trigger utrUpdateDrugs
go

create trigger utrUpdateDrugs
on Drugs
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(UnitsInStock) return
if update(BatchNo) return
if update(ExpiryDate) return

if update(DrugID)
begin
set @ErrorMSG = 'You can''t update Drug ID for Drugs, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

if update(DrugNo)
begin
set @ErrorMSG = 'You can''t update Drug No for Drugs, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Drugs' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-DrugNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrugNo', Deleted.DrugNo, Inserted.DrugNo
from Inserted inner join Deleted
on Inserted.DrugNo = Deleted.DrugNo
end

-------------------  DrugName  -----------------------------------------------------

if update(DrugName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrugName', Deleted.DrugName, Inserted.DrugName
from Inserted inner join Deleted
on Inserted.DrugNo = Deleted.DrugNo
and Inserted.DrugName <> Deleted.DrugName
end

-------------------  AlternateName  -----------------------------------------------------

if update(AlternateName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AlternateName', Deleted.AlternateName, Inserted.AlternateName
from Inserted inner join Deleted
on Inserted.DrugNo = Deleted.DrugNo
and Inserted.AlternateName <> Deleted.AlternateName
end

-------------------  CategoryNo  -----------------------------------------------------

if update(CategoryNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CategoryNo', Deleted.CategoryNo, Inserted.CategoryNo
from Inserted inner join Deleted
on Inserted.DrugNo = Deleted.DrugNo
and Inserted.CategoryNo <> Deleted.CategoryNo
end

-------------------  GroupsID  -----------------------------------------------------

if update(GroupsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GroupsID', Deleted.GroupsID, Inserted.GroupsID
from Inserted inner join Deleted
on Inserted.CategoryNo = Deleted.CategoryNo
and Inserted.GroupsID <> Deleted.GroupsID
end

-------------------  UnitMeasureID  -----------------------------------------------------

if update(UnitMeasureID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasureID', Deleted.UnitMeasureID, Inserted.UnitMeasureID
from Inserted inner join Deleted
on Inserted.DrugNo = Deleted.DrugNo
and Inserted.UnitMeasureID <> Deleted.UnitMeasureID
end

-------------------  OrderLevel  -----------------------------------------------------

if update(OrderLevel)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderLevel', Deleted.OrderLevel, Inserted.OrderLevel
from Inserted inner join Deleted
on Inserted.DrugNo = Deleted.DrugNo
and Inserted.OrderLevel <> Deleted.OrderLevel
end

-------------------  KeepingUnit  -----------------------------------------------------

if update(KeepingUnit)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'KeepingUnit', Deleted.KeepingUnit, Inserted.KeepingUnit
from Inserted inner join Deleted
on Inserted.DrugNo = Deleted.DrugNo
and Inserted.KeepingUnit <> Deleted.KeepingUnit
end

-------------------  UnitCost  -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
from Inserted inner join Deleted
on Inserted.DrugNo = Deleted.DrugNo
and Inserted.UnitCost <> Deleted.UnitCost
end


-------------------  VATPercentage  -----------------------------------------------------

if update(VATPercentage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.UnitCost as decimal), cast(Inserted.VATPercentage as money)
from Inserted inner join Deleted
on Inserted.DrugNo = Deleted.DrugNo
and Inserted.VATPercentage <> Deleted.VATPercentage
end

-------------------  UnitPrice  -----------------------------------------------------


if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.DrugNo = Deleted.DrugNo
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  LastUpdate  -------------------------------------------------------------------

if update(LastUpdate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastUpdate', dbo.FormatDate(Deleted.LastUpdate), dbo.FormatDate(Inserted.LastUpdate)
from Inserted inner join Deleted
on Inserted.DrugNo = Deleted.DrugNo
and Inserted.LastUpdate <> Deleted.LastUpdate
end

-------------------  Halted  -----------------------------------------------------

if update(Halted)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Halted', Deleted.Halted, Inserted.Halted
from Inserted inner join Deleted
on Inserted.DrugNo = Deleted.DrugNo
and Inserted.Halted <> Deleted.Halted
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.DrugNo = Deleted.DrugNo
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Drugs -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteDrugs')
drop trigger utrDeleteDrugs
go

create trigger utrDeleteDrugs
on Drugs
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'D')

if exists (select ItemCode from Items 
where (ItemCode in (select DrugNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select DrugNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select DrugNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select DrugNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select DrugNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select DrugNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select DrugNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select DrugNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select DrugNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select DrugNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
	
------------------------------------------------------------------------------
delete from Inventory where ItemCategoryID = @ItemCategoryID 
and (ItemCode in (select DrugNo from Deleted))
				
delete from InventoryLocation where ItemCategoryID = @ItemCategoryID 
and (ItemCode in (select DrugNo from Deleted))
			
delete from InventoryAcknowledges where ItemCategoryID = @ItemCategoryID 
and (ItemCode in (select DrugNo from Deleted))
			
delete from InventoryTransferDetails where ItemCategoryID = @ItemCategoryID 
and (ItemCode in (select DrugNo from Deleted))
			
delete from InventoryOrderDetails where ItemCategoryID = @ItemCategoryID 
and (ItemCode in (select DrugNo from Deleted))
------------------------------------------------------------------------------

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Drugs' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  DrugNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrugNo', Deleted.DrugNo, null from Deleted

-------------------  DrugName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrugName', Deleted.DrugName, null from Deleted

-------------------  AlternateName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AlternateName', Deleted.AlternateName, null from Deleted

-------------------  CategoryNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CategoryNo', Deleted.CategoryNo, null from Deleted

-------------------  GroupsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GroupsID', Deleted.GroupsID, null from Deleted

-------------------  UnitMeasureID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasureID', Deleted.UnitMeasureID, null from Deleted

-------------------  OrderLevel  --------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderLevel', Deleted.OrderLevel, null from Deleted

-------------------  KeepingUnit  -------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'KeepingUnit', Deleted.KeepingUnit, null from Deleted

-------------------  UnitCost  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted

-------------------  VATPercentage  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as decimal), null from Deleted

-------------------  UnitPrice  ---------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  LastUpdate  --------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastUpdate', dbo.FormatDate(Deleted.LastUpdate), null from Deleted

-------------------  Halted  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Halted', Deleted.Halted, null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted

-------------------  UnitsInStock  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitsInStock', Deleted.UnitsInStock, null from Deleted

-------------------  BatchNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BatchNo', Deleted.BatchNo, null from Deleted

-------------------  ExpiryDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpiryDate', dbo.FormatDate(Deleted.ExpiryDate), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Delete: AlternateDrugs ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAlternateDrugs')
drop trigger utrDeleteAlternateDrugs
go

create trigger utrDeleteAlternateDrugs
on AlternateDrugs
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'AlternateDrugs' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  DrugNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrugNo', Deleted.DrugNo, null from Deleted

-------------------  AlternateDrugNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AlternateDrugNo', Deleted.AlternateDrugNo, null from Deleted
go

------------------------------------------------------------------------------------------------------
--------------- Update: ConsumableItems ---------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateConsumableItems')
drop trigger utrUpdateConsumableItems
go

create trigger utrUpdateConsumableItems
on ConsumableItems
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(UnitsInStock) return
if update(BatchNo) return
if update(ExpiryDate) return

if update(ConsumableID)
begin
set @ErrorMSG = 'You can''t update Consumable ID for Consumable Items, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

if update(ConsumableNo)
begin
set @ErrorMSG = 'You can''t update Consumable No for Consumable Items, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ConsumableItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ConsumableNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConsumableNo', Deleted.ConsumableNo, Inserted.ConsumableNo
from Inserted inner join Deleted
on Inserted.ConsumableNo = Deleted.ConsumableNo
end

-------------------  ConsumableName  -----------------------------------------------------

if update(ConsumableName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConsumableName', Deleted.ConsumableName, Inserted.ConsumableName
from Inserted inner join Deleted
on Inserted.ConsumableNo = Deleted.ConsumableNo
and Inserted.ConsumableName <> Deleted.ConsumableName
end

-------------------  AlternateName  -----------------------------------------------------

if update(AlternateName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AlternateName', Deleted.AlternateName, Inserted.AlternateName
from Inserted inner join Deleted
on Inserted.ConsumableNo = Deleted.ConsumableNo
and Inserted.AlternateName <> Deleted.AlternateName
end

-------------------  UnitMeasureID  -----------------------------------------------------

if update(UnitMeasureID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasureID', Deleted.UnitMeasureID, Inserted.UnitMeasureID
from Inserted inner join Deleted
on Inserted.ConsumableNo = Deleted.ConsumableNo
and Inserted.UnitMeasureID <> Deleted.UnitMeasureID
end

-------------------  OrderLevel  -----------------------------------------------------

if update(OrderLevel)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderLevel', Deleted.OrderLevel, Inserted.OrderLevel
from Inserted inner join Deleted
on Inserted.ConsumableNo = Deleted.ConsumableNo
and Inserted.OrderLevel <> Deleted.OrderLevel
end

-------------------  KeepingUnit  -----------------------------------------------------

if update(KeepingUnit)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'KeepingUnit', Deleted.KeepingUnit, Inserted.KeepingUnit
from Inserted inner join Deleted
on Inserted.ConsumableNo = Deleted.ConsumableNo
and Inserted.KeepingUnit <> Deleted.KeepingUnit
end

-------------------  UnitCost  -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
from Inserted inner join Deleted
on Inserted.ConsumableNo = Deleted.ConsumableNo
and Inserted.UnitCost <> Deleted.UnitCost
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.ConsumableNo = Deleted.ConsumableNo
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  VATPercentage  -----------------------------------------------------

if update(VATPercentage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.VATPercentage as decimal)
from Inserted inner join Deleted
on Inserted.ConsumableNo = Deleted.ConsumableNo
and Inserted.UnitPrice <> Deleted.UnitPrice
end


-------------------  LastUpdate  -----------------------------------------------------

if update(LastUpdate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastUpdate', dbo.FormatDate(Deleted.LastUpdate), dbo.FormatDate(Inserted.LastUpdate)
from Inserted inner join Deleted
on Inserted.ConsumableNo = Deleted.ConsumableNo
and Inserted.LastUpdate <> Deleted.LastUpdate
end

-------------------  Halted  -----------------------------------------------------

if update(Halted)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Halted', Deleted.Halted, Inserted.Halted
from Inserted inner join Deleted
on Inserted.ConsumableNo = Deleted.ConsumableNo
and Inserted.Halted <> Deleted.Halted
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.ConsumableNo = Deleted.ConsumableNo
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ConsumableItems ---------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteConsumableItems')
drop trigger utrDeleteConsumableItems
go

create trigger utrDeleteConsumableItems
on ConsumableItems
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'C')

if exists (select ItemCode from Items 
where (ItemCode in (select ConsumableNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select ConsumableNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select ConsumableNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select ConsumableNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select ConsumableNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select ConsumableNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select ConsumableNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select ConsumableNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select ConsumableNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select ConsumableNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
	
------------------------------------------------------------------------------
delete from Inventory where ItemCategoryID = @ItemCategoryID 
and (ItemCode in (select ConsumableNo from Deleted))
				
delete from InventoryLocation where ItemCategoryID = @ItemCategoryID 
and (ItemCode in (select ConsumableNo from Deleted))
			
delete from InventoryAcknowledges where ItemCategoryID = @ItemCategoryID 
and (ItemCode in (select ConsumableNo from Deleted))
			
delete from InventoryTransferDetails where ItemCategoryID = @ItemCategoryID 
and (ItemCode in (select ConsumableNo from Deleted))
			
delete from InventoryOrderDetails where ItemCategoryID = @ItemCategoryID 
and (ItemCode in (select ConsumableNo from Deleted))
------------------------------------------------------------------------------

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ConsumableItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ConsumableNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConsumableNo', Deleted.ConsumableNo, null from Deleted

-------------------  ConsumableName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConsumableName', Deleted.ConsumableName, null from Deleted

-------------------  AlternateName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AlternateName', Deleted.AlternateName, null from Deleted

-------------------  UnitMeasureID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasureID', Deleted.UnitMeasureID, null from Deleted

-------------------  OrderLevel  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderLevel', Deleted.OrderLevel, null from Deleted

-------------------  KeepingUnit  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'KeepingUnit', Deleted.KeepingUnit, null from Deleted

-------------------  UnitCost  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted

insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as money), null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  LastUpdate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastUpdate', dbo.FormatDate(Deleted.LastUpdate), null from Deleted

-------------------  Halted  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Halted', Deleted.Halted, null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted

-------------------  UnitsInStock  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitsInStock', Deleted.UnitsInStock, null from Deleted

-------------------  BatchNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BatchNo', Deleted.BatchNo, null from Deleted

-------------------  ExpiryDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpiryDate', dbo.FormatDate(Deleted.ExpiryDate), null from Deleted
go

----------------------------------------------------------------------------------------------------------------------------
------------- Update: Services ---------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateServices')
drop trigger utrUpdateServices
go

create trigger utrUpdateServices
on Services
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Services' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ServiceCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceCode', Deleted.ServiceCode, Inserted.ServiceCode
from Inserted inner join Deleted 
on Inserted.ServiceCode = Deleted.ServiceCode
end

------------------- ServiceName -----------------------------------------------------

if update(ServiceName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceName', Deleted.ServiceName, Inserted.ServiceName
from Inserted inner join Deleted 
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.ServiceName <> Deleted.ServiceName
end

------------------- ServicePointID -----------------------------------------------------

if update(ServicePointID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServicePointID', Deleted.ServicePointID, Inserted.ServicePointID
from Inserted inner join Deleted 
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.ServicePointID <> Deleted.ServicePointID
end

------------------- ServiceBillAtID -----------------------------------------------------

if update(ServiceBillAtID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceBillAtID', Deleted.ServiceBillAtID, Inserted.ServiceBillAtID
from Inserted inner join Deleted 
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.ServiceBillAtID <> Deleted.ServiceBillAtID
end

------------------- UnitCost -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
from Inserted inner join Deleted 
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.UnitCost <> Deleted.UnitCost
end

------------------- VATPercentage -----------------------------------------------------

if update(VATPercentage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), cast(Inserted.VATPercentage as varchar(20))
from Inserted inner join Deleted 
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.VATPercentage <> Deleted.VATPercentage
end

------------------- StandardFee -----------------------------------------------------

if update(StandardFee)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StandardFee', cast(Deleted.StandardFee as varchar(20)), cast(Inserted.StandardFee as varchar(20))
from Inserted inner join Deleted 
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.StandardFee <> Deleted.StandardFee
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.Hidden <> Deleted.Hidden
end
go

----------------------------------------------------------------------------------------------------------------------------
------------- Delete: Services ----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteServices')
drop trigger utrDeleteServices
go

create trigger utrDeleteServices
on Services
for  delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'S')

if exists (select ServiceCode from Deleted where ServiceCode = 'NA')
begin
set @ErrorMSG = 'NA service can''t be deleted!'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if exists (select ServiceCode from Deleted where ServiceCode = '10C')
begin
set @ErrorMSG = 'Consultation service can''t be deleted!'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if exists (select ServiceCode from Deleted where ServiceCode = 'REV')
begin
set @ErrorMSG = 'Review service can''t be deleted!'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if exists (select ItemCode from Items 
where (ItemCode in (select ServiceCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select ServiceCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select ServiceCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select ServiceCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else
		
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select ServiceCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select ServiceCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select ServiceCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select ServiceCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select ServiceCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select ServiceCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return

set @Identity = ident_current('AuditTrail') 
if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Services' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- ServiceCode -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceCode', Deleted.ServiceCode, null from Deleted 

------------------- ServiceName -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceName', Deleted.ServiceName, null from Deleted 

------------------- ServicePointID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServicePointID', Deleted.ServicePointID, null from Deleted 

------------------- ServiceBillAtID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceBillAtID', Deleted.ServiceBillAtID, null from Deleted 

------------------- UnitCost ---------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted 

------------------- VATPercentage ---------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), null from Deleted

------------------- StandardFee -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StandardFee', cast(Deleted.StandardFee as varchar(20)), null from Deleted 

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ServicesDrSpecialtyFee --------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateServicesDrSpecialtyFee')
drop trigger utrUpdateServicesDrSpecialtyFee
go

create trigger utrUpdateServicesDrSpecialtyFee
on ServicesDrSpecialtyFee
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ServicesDrSpecialtyFee' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ServiceCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceCode', Deleted.ServiceCode, Inserted.ServiceCode
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
end

------------------- Key-DoctorSpecialtyID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, Inserted.DoctorSpecialtyID
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
end

-------------------  SpecialtyFee  -----------------------------------------------------

if update(SpecialtyFee)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecialtyFee', cast(Deleted.SpecialtyFee as varchar(20)), cast(Inserted.SpecialtyFee as varchar(20))
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
and Inserted.SpecialtyFee <> Deleted.SpecialtyFee
end

-------------------  CurrenciesID  -----------------------------------------------------

if update(CurrenciesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, Inserted.CurrenciesID
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
and Inserted.CurrenciesID <> Deleted.CurrenciesID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ServicesDrSpecialtyFee --------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteServicesDrSpecialtyFee')
drop trigger utrDeleteServicesDrSpecialtyFee
go

create trigger utrDeleteServicesDrSpecialtyFee
on ServicesDrSpecialtyFee
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ServicesDrSpecialtyFee' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ServiceCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceCode', Deleted.ServiceCode, null from Deleted

-------------------  DoctorSpecialtyID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, null from Deleted

-------------------  SpecialtyFee  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecialtyFee', cast(Deleted.SpecialtyFee as varchar(20)), null from Deleted

-------------------  CurrenciesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ServicesStaffFee --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateServicesStaffFee')
drop trigger utrUpdateServicesStaffFee
go

create trigger utrUpdateServicesStaffFee
on ServicesStaffFee
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ServicesStaffFee' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ServiceCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceCode', Deleted.ServiceCode, Inserted.ServiceCode
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.StaffNo = Deleted.StaffNo
end

------------------- Key-StaffNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.StaffNo = Deleted.StaffNo
end

-------------------  StaffFee  -----------------------------------------------------

if update(StaffFee)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffFee', cast(Deleted.StaffFee as varchar(20)), cast(Inserted.StaffFee as varchar(20))
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.StaffNo = Deleted.StaffNo
and Inserted.StaffFee <> Deleted.StaffFee
end

-------------------  CurrenciesID  -----------------------------------------------------

if update(CurrenciesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, Inserted.CurrenciesID
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.StaffNo = Deleted.StaffNo
and Inserted.CurrenciesID <> Deleted.CurrenciesID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.StaffNo = Deleted.StaffNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.StaffNo = Deleted.StaffNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ServiceCode = Deleted.ServiceCode
and Inserted.StaffNo = Deleted.StaffNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ServicesStaffFee --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteServicesStaffFee')
drop trigger utrDeleteServicesStaffFee
go

create trigger utrDeleteServicesStaffFee
on ServicesStaffFee
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ServicesStaffFee' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ServiceCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceCode', Deleted.ServiceCode, null from Deleted

-------------------  StaffNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted

-------------------  StaffFee  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffFee', cast(Deleted.StaffFee as varchar(20)), null from Deleted

-------------------  CurrenciesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: ServicesSpecialtyBillCustomFee ------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateServicesSpecialtyBillCustomFee')
	drop trigger utrUpdateServicesSpecialtyBillCustomFee
go

create trigger utrUpdateServicesSpecialtyBillCustomFee
on ServicesSpecialtyBillCustomFee
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ServicesSpecialtyBillCustomFee' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return


------------------- Key-ServiceCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ServiceCode', Deleted.ServiceCode, Inserted.ServiceCode
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
	and Inserted.AccountNo = Deleted.AccountNo
end

------------------- Key-DoctorSpecialtyID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, Inserted.DoctorSpecialtyID
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
	and Inserted.AccountNo = Deleted.AccountNo
end

------------------- Key-AccountNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
	and Inserted.AccountNo = Deleted.AccountNo
end

-------------------  CustomFee  -----------------------------------------------------

if update(CustomFee)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CustomFee', cast(Deleted.CustomFee as varchar(20)), cast(Inserted.CustomFee as varchar(20))
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
	and Inserted.AccountNo = Deleted.AccountNo
	and Inserted.CustomFee <> Deleted.CustomFee
end

-------------------  CurrenciesID  -----------------------------------------------------

if update(CurrenciesID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CurrenciesID', Deleted.CurrenciesID, Inserted.CurrenciesID
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
	and Inserted.AccountNo = Deleted.AccountNo
	and Inserted.CurrenciesID <> Deleted.CurrenciesID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
	and Inserted.AccountNo = Deleted.AccountNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
	and Inserted.AccountNo = Deleted.AccountNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
	and Inserted.AccountNo = Deleted.AccountNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ServicesSpecialtyBillCustomFee ------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteServicesSpecialtyBillCustomFee')
	drop trigger utrDeleteServicesSpecialtyBillCustomFee
go

create trigger utrDeleteServicesSpecialtyBillCustomFee
on ServicesSpecialtyBillCustomFee
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ServicesSpecialtyBillCustomFee' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ServiceCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceCode', Deleted.ServiceCode, null from Deleted

-------------------  DoctorSpecialtyID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, null from Deleted

-------------------  AccountNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, null from Deleted

-------------------  CustomFee  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CustomFee', cast(Deleted.CustomFee as varchar(20)), null from Deleted

-------------------  CurrenciesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ServicesStaffBillCustomFee ----------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateServicesStaffBillCustomFee')
	drop trigger utrUpdateServicesStaffBillCustomFee
go

create trigger utrUpdateServicesStaffBillCustomFee
on ServicesStaffBillCustomFee
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ServicesStaffBillCustomFee' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ServiceCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ServiceCode', Deleted.ServiceCode, Inserted.ServiceCode
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.StaffNo = Deleted.StaffNo
	and Inserted.AccountNo = Deleted.AccountNo
end

------------------- Key-StaffNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.StaffNo = Deleted.StaffNo
	and Inserted.AccountNo = Deleted.AccountNo
end

------------------- Key-AccountNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.StaffNo = Deleted.StaffNo
	and Inserted.AccountNo = Deleted.AccountNo
end

-------------------  CustomFee  -----------------------------------------------------

if update(CustomFee)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CustomFee', cast(Deleted.CustomFee as varchar(20)), cast(Inserted.CustomFee as varchar(20))
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.StaffNo = Deleted.StaffNo
	and Inserted.AccountNo = Deleted.AccountNo
	and Inserted.CustomFee <> Deleted.CustomFee
end

-------------------  CurrenciesID  -----------------------------------------------------

if update(CurrenciesID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CurrenciesID', Deleted.CurrenciesID, Inserted.CurrenciesID
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.StaffNo = Deleted.StaffNo
	and Inserted.AccountNo = Deleted.AccountNo
	and Inserted.CurrenciesID <> Deleted.CurrenciesID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.StaffNo = Deleted.StaffNo
	and Inserted.AccountNo = Deleted.AccountNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.StaffNo = Deleted.StaffNo
	and Inserted.AccountNo = Deleted.AccountNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.StaffNo = Deleted.StaffNo
	and Inserted.AccountNo = Deleted.AccountNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ServicesStaffBillCustomFee ----------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteServicesStaffBillCustomFee')
	drop trigger utrDeleteServicesStaffBillCustomFee
go

create trigger utrDeleteServicesStaffBillCustomFee
on ServicesStaffBillCustomFee
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ServicesStaffBillCustomFee' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ServiceCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceCode', Deleted.ServiceCode, null from Deleted

-------------------  StaffNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted

-------------------  AccountNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, null from Deleted

-------------------  CustomFee  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CustomFee', cast(Deleted.CustomFee as varchar(20)), null from Deleted

-------------------  CurrenciesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ServicesSpecialtyCustomCode ---------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateServicesSpecialtyCustomCode')
	drop trigger utrUpdateServicesSpecialtyCustomCode
go

create trigger utrUpdateServicesSpecialtyCustomCode
on ServicesSpecialtyCustomCode
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ServicesSpecialtyCustomCode' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return


------------------- Key-ServiceCode -----------------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ServiceCode', Deleted.ServiceCode, Inserted.ServiceCode
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
end

------------------- Key-DoctorSpecialtyID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, Inserted.DoctorSpecialtyID
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
end

-------------------  CustomCode  -----------------------------------------------------

if update(CustomCode)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CustomCode', Deleted.CustomCode, Inserted.CustomCode
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
	and Inserted.CustomCode <> Deleted.CustomCode
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.ServiceCode = Deleted.ServiceCode
	and Inserted.DoctorSpecialtyID = Deleted.DoctorSpecialtyID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ServicesSpecialtyCustomCode ---------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteServicesSpecialtyCustomCode')
	drop trigger utrDeleteServicesSpecialtyCustomCode
go

create trigger utrDeleteServicesSpecialtyCustomCode
on ServicesSpecialtyCustomCode
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ServicesSpecialtyCustomCode' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ServiceCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceCode', Deleted.ServiceCode, null from Deleted

-------------------  DoctorSpecialtyID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, null from Deleted

-------------------  CustomCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CustomCode', Deleted.CustomCode, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: ItemsBalanceDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateItemsBalanceDetails')
drop trigger utrUpdateItemsBalanceDetails
go

create trigger utrUpdateItemsBalanceDetails
on ItemsBalanceDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ItemsBalanceDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  Balance  -----------------------------------------------------

if update(Balance)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Balance', Deleted.Balance, Inserted.Balance
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Balance <> Deleted.Balance
end

-------------------  BalanceStatus  -----------------------------------------------------

if update(BalanceStatus)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BalanceStatus', Deleted.BalanceStatus, Inserted.BalanceStatus
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.BalanceStatus <> Deleted.BalanceStatus
end


-------------------  nextVisitNo  -----------------------------------------------------

if update(nextVisitNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'nextVisitNo', Deleted.nextVisitNo, Inserted.nextVisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.nextVisitNo <> Deleted.nextVisitNo
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ClientMachine <> Deleted.ClientMachine
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: ItemsBalanceDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteItemsBalanceDetails')
drop trigger utrDeleteItemsBalanceDetails
go

create trigger utrDeleteItemsBalanceDetails
on ItemsBalanceDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ItemsBalanceDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  Balance  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Balance', Deleted.Balance, null from Deleted

-------------------  BalanceStatus  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BalanceStatus', Deleted.BalanceStatus, null from Deleted

-------------------  nextVisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'nextVisitNo', Deleted.nextVisitNo, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted
go

----------------------------------------------------------------------------------------------------------------------------
------------- Update: Items -------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateItems')
drop trigger utrUpdateItems
go

create trigger utrUpdateItems
on Items 
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Items' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ItemName  -----------------------------------------------------

if update(ItemName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ItemName <> Deleted.ItemName
end

-------------------  InvoiceNo  -----------------------------------------------------

if update(InvoiceNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'InvoiceNo', Deleted.InvoiceNo, Inserted.InvoiceNo
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.InvoiceNo <> Deleted.InvoiceNo
end

-------------------  UnitMeasure  -----------------------------------------------------

if update(UnitMeasure)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'UnitMeasure', Deleted.UnitMeasure, Inserted.UnitMeasure
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.UnitMeasure <> Deleted.UnitMeasure
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Quantity <> Deleted.Quantity
end

-------------------  UnitCost  -----------------------------------------------------

if update(UnitCost)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.UnitCost <> Deleted.UnitCost
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  VATValue  -----------------------------------------------------

if update(VATValue)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VATValue', cast(Deleted.VATValue as varchar(20)), cast(Inserted.VATValue as varchar(20))
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.VATValue <> Deleted.VATValue
end

-------------------  ItemDetails  -----------------------------------------------------

if update(ItemDetails)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemDetails', cast(Deleted.ItemDetails as varchar(20)), cast(Inserted.ItemDetails as varchar(20))
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ItemDetails <> Deleted.ItemDetails
end

-------------------  LastUpdate  -----------------------------------------------------

if update(LastUpdate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LastUpdate', dbo.FormatDate(Deleted.LastUpdate), dbo.FormatDate(Inserted.LastUpdate)
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LastUpdate <> Deleted.LastUpdate
end

-------------------  ItemStatusID  -----------------------------------------------------

if update(ItemStatusID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemStatusID', Deleted.ItemStatusID, Inserted.ItemStatusID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ItemStatusID <> Deleted.ItemStatusID
end

-------------------  PayStatusID  -----------------------------------------------------

if update(PayStatusID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PayStatusID', Deleted.PayStatusID, Inserted.PayStatusID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.PayStatusID <> Deleted.PayStatusID
end

-------------------  OriginalQuantity  -----------------------------------------------------

if update(OriginalQuantity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'OriginalQuantity', Deleted.OriginalQuantity, Inserted.OriginalQuantity
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.OriginalQuantity <> Deleted.OriginalQuantity
end

-------------------  OriginalPrice  -----------------------------------------------------

if update(OriginalPrice)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'OriginalPrice', Deleted.OriginalPrice, Inserted.OriginalPrice
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.OriginalPrice <> Deleted.OriginalPrice
end




-------------------  ConclusionDate  -----------------------------------------------------

if update(ConclusionDate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ConclusionDate', dbo.FormatDate(Deleted.ConclusionDate), dbo.FormatDate(Inserted.ConclusionDate)
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ConclusionDate <> Deleted.ConclusionDate
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end

-------------------  CreatorLoginID  -----------------------------------------------------

if update(CreatorLoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CreatorLoginID', Deleted.CreatorLoginID, Inserted.CreatorLoginID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.CreatorLoginID <> Deleted.CreatorLoginID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end
go

----------------------------------------------------------------------------------------------------------------------------
------------- Delete: Items ------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------------------------------
------------- Delete: Items ------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteItems')
drop trigger utrDeleteItems
go

create trigger utrDeleteItems
on Items
for  delete
as

declare @ErrorMSG varchar(200)
declare @OfferedItemStatus varchar(10)
declare @DoneItemStatus varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------------------------------------------------------------------
set @OfferedItemStatus = dbo.GetLookupDataID('ItemStatus', 'O')
set @DoneItemStatus = dbo.GetLookupDataID('ItemStatus', 'D')

if exists (select ItemCode from Deleted where ItemStatusID = @OfferedItemStatus or ItemStatusID = @DoneItemStatus)
begin
set @ErrorMSG = 'Can''t delete record entries in Items that are Offered or Done'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return

set @Identity = ident_current('AuditTrail') 
if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Items' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return
-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  InvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, null from Deleted

-------------------  UnitMeasure  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  UnitCost  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  VATValue  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATValue', cast(Deleted.VATValue as varchar(20)), null from Deleted

-------------------  ItemDetails  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemDetails', cast(Deleted.ItemDetails as varchar(20)), null from Deleted

-------------------  LastUpdate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastUpdate', dbo.FormatDate(Deleted.LastUpdate), null from Deleted

-------------------  ItemStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemStatusID', Deleted.ItemStatusID, null from Deleted

-------------------  PayStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayStatusID', Deleted.PayStatusID, null from Deleted

-------------------  OriginalQuantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OriginalQuantity', Deleted.OriginalQuantity, null from Deleted

-------------------  OriginalPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OriginalPrice', Deleted.OriginalPrice, null from Deleted

-------------------  ConclusionDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConclusionDate', dbo.FormatDate(Deleted.ConclusionDate), null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted

-------------------  CreatorLoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CreatorLoginID', Deleted.CreatorLoginID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ItemsCASH --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateItemsCASH')
drop trigger utrUpdateItemsCASH
go

create trigger utrUpdateItemsCASH
on ItemsCASH
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ItemsCASH' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  InvoiceNo  -----------------------------------------------------

if update(InvoiceNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'InvoiceNo', Deleted.InvoiceNo, Inserted.InvoiceNo
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.InvoiceNo <> Deleted.InvoiceNo
end

-------------------  CashAmount  -----------------------------------------------------

if update(CashAmount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CashAmount', cast(Deleted.CashAmount as varchar(20)), cast(Inserted.CashAmount as varchar(20))
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CashAmount <> Deleted.CashAmount
end

-------------------  CashPayStatusID  -----------------------------------------------------

if update(CashPayStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CashPayStatusID', Deleted.CashPayStatusID, Inserted.CashPayStatusID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CashPayStatusID <> Deleted.CashPayStatusID
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ItemsCASH --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteItemsCASH')
drop trigger utrDeleteItemsCASH
go

create trigger utrDeleteItemsCASH
on ItemsCASH
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ItemsCASH' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  InvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, null from Deleted


-------------------  CashAmount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CashAmount', cast(Deleted.CashAmount as varchar(20)), null from Deleted

-------------------  CashPayStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CashPayStatusID', Deleted.CashPayStatusID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ItemsEXT ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateItemsEXT')
drop trigger utrUpdateItemsEXT
go

create trigger utrUpdateItemsEXT
on ItemsEXT
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ItemsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  Dosage  -----------------------------------------------------

if update(Dosage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Dosage', Deleted.Dosage, Inserted.Dosage
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Dosage <> Deleted.Dosage
end

-------------------  Duration  -----------------------------------------------------

if update(Duration)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Duration', Deleted.Duration, Inserted.Duration
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Duration <> Deleted.Duration
end

-------------------  DrQuantity  -----------------------------------------------------

if update(DrQuantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrQuantity', Deleted.DrQuantity, Inserted.DrQuantity
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.DrQuantity <> Deleted.DrQuantity
end

-------------------  IssueDateTime  -----------------------------------------------------

if update(IssueDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IssueDateTime', dbo.FormatDateTime(Deleted.IssueDateTime), dbo.FormatDateTime(Inserted.IssueDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.IssueDateTime <> Deleted.IssueDateTime
end

-------------------  Pharmacist  -----------------------------------------------------

if update(Pharmacist)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pharmacist', Deleted.Pharmacist, Inserted.Pharmacist
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Pharmacist <> Deleted.Pharmacist
end

-------------------  LocationID  -----------------------------------------------------

if update(LocationID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationID', Deleted.LocationID, Inserted.LocationID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LocationID <> Deleted.LocationID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ClientMachine <> Deleted.ClientMachine
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ItemsEXT ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteItemsEXT')
drop trigger utrDeleteItemsEXT
go

create trigger utrDeleteItemsEXT
on ItemsEXT
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ItemsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  Dosage  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Dosage', Deleted.Dosage, null from Deleted

-------------------  Duration  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Duration', Deleted.Duration, null from Deleted

-------------------  DrQuantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrQuantity', Deleted.DrQuantity, null from Deleted

-------------------  IssueDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IssueDateTime', dbo.FormatDateTime(Deleted.IssueDateTime), null from Deleted

-------------------  Pharmacist  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pharmacist', Deleted.Pharmacist, null from Deleted

-------------------  LocationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationID', Deleted.LocationID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ExchangeRates -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateExchangeRates')
drop trigger utrUpdateExchangeRates
go

create trigger utrUpdateExchangeRates
on ExchangeRates
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ExchangeRates' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-CurrenciesID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, Inserted.CurrenciesID
from Inserted inner join Deleted
on Inserted.CurrenciesID = Deleted.CurrenciesID
end

-------------------  Buying  -----------------------------------------------------

if update(Buying)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Buying', cast(Deleted.Buying as varchar(20)), cast(Inserted.Buying as varchar(20))
from Inserted inner join Deleted
on Inserted.CurrenciesID = Deleted.CurrenciesID
and Inserted.Buying <> Deleted.Buying
end

-------------------  Selling  -----------------------------------------------------

if update(Selling)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Selling', cast(Deleted.Selling as varchar(20)), cast(Inserted.Selling as varchar(20))
from Inserted inner join Deleted
on Inserted.CurrenciesID = Deleted.CurrenciesID
and Inserted.Selling <> Deleted.Selling
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.CurrenciesID = Deleted.CurrenciesID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.CurrenciesID = Deleted.CurrenciesID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ExchangeRates -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteExchangeRates')
drop trigger utrDeleteExchangeRates
go

create trigger utrDeleteExchangeRates
on ExchangeRates
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ExchangeRates' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  CurrenciesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, null from Deleted

-------------------  Buying  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Buying', cast(Deleted.Buying as varchar(20)), null from Deleted

-------------------  Selling  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Selling', cast(Deleted.Selling as varchar(20)), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

----------------------------------------------------------------------------------------------------------------------------
------------- Update: Payments ---------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePayments')
drop trigger utrUpdatePayments
go

create trigger utrUpdatePayments
on Payments
for update
as
declare @ErrorMSG varchar(200)

if @@rowcount = 0 return 

if update(ReceiptID)
begin
set @ErrorMSG = 'You can''t update Receipt ID for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ReceiptNo)
begin
set @ErrorMSG = 'You can''t update Receipt No for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(PayTypeID)
begin
set @ErrorMSG = 'You can''t update Pay Type ID for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(PayNo)
begin
set @ErrorMSG = 'You can''t update Pay No for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ClientFullName)
begin
set @ErrorMSG = 'You can''t update Client Full Name for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(PayDate)
begin
set @ErrorMSG = 'You can''t update Pay Date for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(PayModesID)
begin
set @ErrorMSG = 'You can''t update Pay Modes ID for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(DocumentNo)
begin
set @ErrorMSG = 'You can''t update Document No for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(AmountWords)
begin
set @ErrorMSG = 'You can''t update Amount in Words for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Notes)
begin
set @ErrorMSG = 'You can''t update Notes for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(CurrenciesID)
begin
set @ErrorMSG = 'You can''t update Currencies ID for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(WithholdingTax)
begin
set @ErrorMSG = 'You can''t update Withholding Tax for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
end

if update(GrandDiscount)
begin
	set @ErrorMSG = 'You can''t update Grand Discount for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
end


if update(AmountTendered)
begin
set @ErrorMSG = 'You can''t update Amount Tendered for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ExchangeRate)
begin
set @ErrorMSG = 'You can''t update Exchange Rate for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Change)
begin
set @ErrorMSG = 'You can''t update Change for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(SendBalanceToAccount)
begin
set @ErrorMSG = 'You can''t update Send Balance To Account for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(UseAccountBalance)
begin
set @ErrorMSG = 'You can''t update Use Account Balance for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(VisitTypeID)
begin
set @ErrorMSG = 'You can''t update Visit Type ID for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(FilterNo)
begin
set @ErrorMSG = 'You can''t update Filter No for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(LoginID)
begin
set @ErrorMSG = 'You can''t update Login ID for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ClientMachine)
begin
set @ErrorMSG = 'You can''t update Client Machine for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(RecordDateTime)
begin
set @ErrorMSG = 'You can''t update Record Date Time for Payments, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
go

------------------------------------------------------------------------------------------------------
-------------- Update: Refunds -----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRefunds')
drop trigger utrUpdateRefunds
go

create trigger utrUpdateRefunds
on Refunds
for update
as
declare @ErrorMSG varchar(200)

if @@rowcount = 0 return 

if update(RefundID)
begin
set @ErrorMSG = 'You can''t update Refund ID for Refunds, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(RefundNo)
begin
set @ErrorMSG = 'You can''t update Refund No for Refunds, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ReceiptNo)
begin
set @ErrorMSG = 'You can''t update Receipt No for Refunds, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(RefundRequestNo)
begin
set @ErrorMSG = 'You can''t update Refund Request No for Refunds, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(RefundDate)
begin
set @ErrorMSG = 'You can''t update Refund Date for Refunds, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Amount)
begin
set @ErrorMSG = 'You can''t update Amount for Refunds, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(AmountWords)
begin
set @ErrorMSG = 'You can''t update Amount in Words for Refunds, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Notes)
begin
set @ErrorMSG = 'You can''t update Notes for Refunds, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(LoginID)
begin
set @ErrorMSG = 'You can''t update Login ID for Refunds, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ClientMachine)
begin
set @ErrorMSG = 'You can''t update Client Machine for Refunds, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(RecordDateTime)
begin
set @ErrorMSG = 'You can''t update Record Date Time for Refunds, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Refunds -----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRefunds')
drop trigger utrDeleteRefunds
go

create trigger utrDeleteRefunds
on Refunds
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Refunds' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RefundID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundID', Deleted.RefundID, null from Deleted

-------------------  RefundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundNo', Deleted.RefundNo, null from Deleted

-------------------  RefundRequestNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundRequestNo', Deleted.RefundNo, null from Deleted

-------------------  ReceiptNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, null from Deleted

-------------------  RefundDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundDate', dbo.FormatDate(Deleted.RefundDate), null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  AmountWords  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountWords', Deleted.AmountWords, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: PaymentDetails ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePaymentDetails')
drop trigger utrUpdatePaymentDetails
go

create trigger utrUpdatePaymentDetails
on PaymentDetails
for update
as
declare @ErrorMSG varchar(200)

if @@rowcount = 0 return

if update(ReceiptNo)
begin
set @ErrorMSG = 'You can''t update Receipt No for Payment Details, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(VisitNo)
begin
set @ErrorMSG = 'You can''t update Visit No for Payment Details, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ItemCode)
begin
set @ErrorMSG = 'You can''t update Item Code for Payment Details, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ItemCategoryID)
begin
set @ErrorMSG = 'You can''t update Item Category ID for Payment Details, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Quantity)
begin
set @ErrorMSG = 'You can''t update Quantity for Payment Details, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(UnitPrice)
begin
set @ErrorMSG = 'You can''t update Unit Price for Payment Details, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Discount)
begin
set @ErrorMSG = 'You can''t update Discount for Payment Details, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Amount)
begin
set @ErrorMSG = 'You can''t update Amount for Payment Details, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
go

------------------------------------------------------------------------------------------------------
-------------- Update: PaymentExtraBillItems ---------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePaymentExtraBillItems')
drop trigger utrUpdatePaymentExtraBillItems
go

create trigger utrUpdatePaymentExtraBillItems
on PaymentExtraBillItems
for update
as
declare @ErrorMSG varchar(200)

if @@rowcount = 0 return

if update(ReceiptNo)
begin
set @ErrorMSG = 'You can''t update Receipt No for Payment Extra Bill Items, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

if update(ExtraBillNo)
begin
set @ErrorMSG = 'You can''t update Extra Bill No for Payment Extra Bill Items, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

if update(ItemCode)
begin
set @ErrorMSG = 'You can''t update Item Code for Payment Extra Bill Items, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

if update(ItemCategoryID)
begin
set @ErrorMSG = 'You can''t update Item Category ID for Payment Extra Bill Items, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

if update(Quantity)
begin
set @ErrorMSG = 'You can''t update Quantity for Payment Extra Bill Items, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(UnitPrice)
begin
set @ErrorMSG = 'You can''t update Unit Price for Payment Extra Bill Items, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Discount)
begin
set @ErrorMSG = 'You can''t update Discount for Payment Extra Bill Items, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Amount)
begin
set @ErrorMSG = 'You can''t update Amount for Payment Extra Bill Items, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
go

------------------------------------------------------------------------------------------------------
-------------- Update: Quotations --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateQuotations')
drop trigger utrUpdateQuotations
go

create trigger utrUpdateQuotations
on Quotations
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(QuotationID)
begin
set @ErrorMSG = 'You can''t update Quotation ID for Quotations, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(QuotationNo)
begin
set @ErrorMSG = 'You can''t update Quotation No for Quotations, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Quotations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-QuotationNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QuotationNo', Deleted.QuotationNo, Inserted.QuotationNo
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
end

-------------------  QuotationID  -----------------------------------------------------

if update(QuotationID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QuotationID', Deleted.QuotationID, Inserted.QuotationID
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.QuotationID <> Deleted.QuotationID
end

-------------------  QuotationDate  -----------------------------------------------------

if update(QuotationDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QuotationDate', dbo.FormatDate(Deleted.QuotationDate), dbo.FormatDate(Inserted.QuotationDate)
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.QuotationDate <> Deleted.QuotationDate
end

-------------------  AmountWords  -----------------------------------------------------

if update(AmountWords)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountWords', Deleted.AmountWords, Inserted.AmountWords
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.AmountWords <> Deleted.AmountWords
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Quotations --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteQuotations')
drop trigger utrDeleteQuotations
go

create trigger utrDeleteQuotations
on Quotations
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Quotations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  QuotationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QuotationID', Deleted.QuotationID, null from Deleted

-------------------  QuotationNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QuotationNo', Deleted.QuotationNo, null from Deleted

-------------------  QuotationDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QuotationDate', dbo.FormatDate(Deleted.QuotationDate), null from Deleted

-------------------  AmountWords  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountWords', Deleted.AmountWords, null from Deleted

-------------------  LoginID  ---------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: QuotationDetails --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateQuotationDetails')
drop trigger utrUpdateQuotationDetails
go

create trigger utrUpdateQuotationDetails
on QuotationDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'QuotationDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-QuotationNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QuotationNo', Deleted.QuotationNo, Inserted.QuotationNo
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

-------------------  ItemName  -----------------------------------------------------

if update(ItemName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemName <> Deleted.ItemName
end

-------------------  UnitMeasure  -----------------------------------------------------

if update(UnitMeasure)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, Inserted.UnitMeasure
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.UnitMeasure <> Deleted.UnitMeasure
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  Discount  -----------------------------------------------------

if update(Discount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Discount', cast(Deleted.Discount as varchar(20)), cast(Inserted.Discount as varchar(20))
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Discount <> Deleted.Discount
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Amount <> Deleted.Amount
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.QuotationNo = Deleted.QuotationNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: QuotationDetails --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteQuotationDetails')
drop trigger utrDeleteQuotationDetails
go

create trigger utrDeleteQuotationDetails
on QuotationDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'QuotationDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  QuotationNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QuotationNo', Deleted.QuotationNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  UnitMeasure  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  Discount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Discount', cast(Deleted.Discount as varchar(20)), null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Invoices ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInvoices')
drop trigger utrUpdateInvoices
go

create trigger utrUpdateInvoices
on Invoices
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(InvoiceID)
begin
set @ErrorMSG = 'You can''t update Invoice ID for Invoices, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(InvoiceNo)
begin
set @ErrorMSG = 'You can''t update Invoice No for Invoices, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Invoices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-InvoiceNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, Inserted.InvoiceNo
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
end

-------------------  InvoiceID  -----------------------------------------------------

if update(InvoiceID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceID', Deleted.InvoiceID, Inserted.InvoiceID
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.InvoiceID <> Deleted.InvoiceID
end

-------------------  PayTypeID  -----------------------------------------------------

if update(PayTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayTypeID', Deleted.PayTypeID, Inserted.PayTypeID
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.PayTypeID <> Deleted.PayTypeID
end

-------------------  PayNo  -----------------------------------------------------

if update(PayNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayNo', Deleted.PayNo, Inserted.PayNo
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.PayNo <> Deleted.PayNo
end

-------------------  InvoiceDate  -----------------------------------------------------

if update(InvoiceDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceDate', dbo.FormatDate(Deleted.InvoiceDate), dbo.FormatDate(Inserted.InvoiceDate)
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.InvoiceDate <> Deleted.InvoiceDate
end

-------------------  StartDate  -----------------------------------------------------

if update(StartDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartDate', dbo.FormatDate(Deleted.StartDate), dbo.FormatDate(Inserted.StartDate)
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.StartDate <> Deleted.StartDate
end

-------------------  EndDate  -----------------------------------------------------

if update(EndDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EndDate', dbo.FormatDate(Deleted.EndDate), dbo.FormatDate(Inserted.EndDate)
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.EndDate <> Deleted.EndDate
end

-------------------  AmountWords  -----------------------------------------------------

if update(AmountWords)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountWords', Deleted.AmountWords, Inserted.AmountWords
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.AmountWords <> Deleted.AmountWords
end

-------------------  VisitTypeID  -----------------------------------------------------

if update(VisitTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitTypeID', Deleted.VisitTypeID, Inserted.VisitTypeID
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.VisitTypeID <> Deleted.VisitTypeID
end

-------------------  Cancelled  -----------------------------------------------------

if update(Cancelled)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Cancelled', Deleted.Cancelled, Inserted.Cancelled
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.Cancelled <> Deleted.Cancelled
end

-------------------  EntryModeID  -----------------------------------------------------

if update(EntryModeID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'EntryModeID', Deleted.EntryModeID, Inserted.EntryModeID
	from Inserted inner join Deleted
	on Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.EntryModeID <> Deleted.EntryModeID
end


-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Invoices ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInvoices')
drop trigger utrDeleteInvoices
go

create trigger utrDeleteInvoices
on Invoices
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Invoices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  InvoiceID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceID', Deleted.InvoiceID, null from Deleted

-------------------  InvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, null from Deleted

-------------------  PayTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayTypeID', Deleted.PayTypeID, null from Deleted

-------------------  PayNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayNo', Deleted.PayNo, null from Deleted

-------------------  InvoiceDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceDate', dbo.FormatDate(Deleted.InvoiceDate), null from Deleted

-------------------  StartDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartDate', dbo.FormatDate(Deleted.StartDate), null from Deleted

-------------------  EndDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EndDate', dbo.FormatDate(Deleted.EndDate), null from Deleted

-------------------  AmountWords  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountWords', Deleted.AmountWords, null from Deleted

-------------------  VisitTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitTypeID', Deleted.VisitTypeID, null from Deleted

-------------------  Cancelled  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Cancelled', Deleted.Cancelled, null from Deleted

-------------------  EntryModeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EntryModeID', Deleted.EntryModeID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: InvoiceDetails ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInvoiceDetails')
drop trigger utrUpdateInvoiceDetails
go

create trigger utrUpdateInvoiceDetails
on InvoiceDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InvoiceDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-InvoiceNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, Inserted.InvoiceNo
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ObjectName  -----------------------------------------------------

if update(ObjectName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ObjectName', Deleted.ObjectName, Inserted.ObjectName
	from Inserted inner join Deleted
	on Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ObjectName <> Deleted.ObjectName
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  Discount  -----------------------------------------------------

if update(Discount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Discount', cast(Deleted.Discount as varchar(20)), cast(Inserted.Discount as varchar(20))
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Discount <> Deleted.Discount
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Amount <> Deleted.Amount
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: InvoiceDetails ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInvoiceDetails')
drop trigger utrDeleteInvoiceDetails
go

create trigger utrDeleteInvoiceDetails
on InvoiceDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InvoiceDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  InvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ObjectName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ObjectName', Deleted.ObjectName, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  Discount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Discount', cast(Deleted.Discount as varchar(20)), null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: InvoiceExtraBillItems ---------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInvoiceExtraBillItems')
drop trigger utrUpdateInvoiceExtraBillItems
go

create trigger utrUpdateInvoiceExtraBillItems
on InvoiceExtraBillItems
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InvoiceExtraBillItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-InvoiceNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, Inserted.InvoiceNo
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ExtraBillNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, Inserted.ExtraBillNo
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ObjectName  -----------------------------------------------------

if update(ObjectName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ObjectName', Deleted.ObjectName, Inserted.ObjectName
	from Inserted inner join Deleted
	on Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ObjectName <> Deleted.ObjectName
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  Discount  -----------------------------------------------------

if update(Discount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Discount', cast(Deleted.Discount as varchar(20)), cast(Inserted.Discount as varchar(20))
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Discount <> Deleted.Discount
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Amount <> Deleted.Amount
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: InvoiceExtraBillItems ---------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInvoiceExtraBillItems')
drop trigger utrDeleteInvoiceExtraBillItems
go

create trigger utrDeleteInvoiceExtraBillItems
on InvoiceExtraBillItems
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InvoiceExtraBillItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  InvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, null from Deleted

-------------------  ExtraBillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ObjectName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ObjectName', Deleted.ObjectName, null from Deleted


-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  Discount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Discount', cast(Deleted.Discount as varchar(20)), null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted
go

----------------------------------------------------------------------------------------------------------------------------
------------- Update: Accounts ---------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAccounts')
drop trigger utrUpdateAccounts
go

create trigger utrUpdateAccounts
on Accounts
for update
as
declare @ErrorMSG varchar(200)

if @@rowcount = 0 return 

if update(TranID)
begin
set @ErrorMSG = 'You can''t update Tran ID for Accounts, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(TranNo)
begin
set @ErrorMSG = 'You can''t update Tran No for Accounts, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
if update(Amount)
begin
set @ErrorMSG = 'You can''t update Amount for Accounts, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Balance)
begin
set @ErrorMSG = 'You can''t update Balance for Accounts, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(AmountWords)
begin
set @ErrorMSG = 'You can''t update Amount Words for Accounts, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(CurrenciesID)
begin
set @ErrorMSG = 'You can''t update Currencies ID for Accounts, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(AmountTendered)
begin
set @ErrorMSG = 'You can''t update Amount Tendered for Accounts, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ExchangeRate)
begin
set @ErrorMSG = 'You can''t update Exchange Rate for Accounts, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Change)
begin
set @ErrorMSG = 'You can''t update Change for Accounts, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(EntryModeID)
begin
set @ErrorMSG = 'You can''t update Entry Mode ID for Accounts, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(LoginID)
begin
set @ErrorMSG = 'You can''t update Login ID for Accounts, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ClientMachine)
begin
set @ErrorMSG = 'You can''t update Client Machine for Accounts, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(RecordDateTime)
begin
set @ErrorMSG = 'You can''t update Record Date Time for Accounts, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
go

------------------------------------------------------------------------------------------------------
-------------- Update: ClinicalFindings --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateClinicalFindings')
drop trigger utrUpdateClinicalFindings
go

create trigger utrUpdateClinicalFindings
on ClinicalFindings
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ClinicalFindings' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  PresentingComplaint  -----------------------------------------------------

if update(PresentingComplaint)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PresentingComplaint', Deleted.PresentingComplaint, Inserted.PresentingComplaint
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PresentingComplaint <> Deleted.PresentingComplaint
end

-------------------  ClinicalNotes  -----------------------------------------------------

if update(ClinicalNotes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClinicalNotes', Deleted.ClinicalNotes, Inserted.ClinicalNotes
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ClinicalNotes <> Deleted.ClinicalNotes
end

-------------------  ROS  -----------------------------------------------------

if update(ROS)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ROS', Deleted.ROS, Inserted.ROS
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ROS <> Deleted.ROS
end

-------------------  PMH  -----------------------------------------------------

if update(PMH)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PMH', Deleted.PMH, Inserted.PMH
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PMH <> Deleted.PMH
end

-------------------  POH  -----------------------------------------------------

if update(POH)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'POH', Deleted.POH, Inserted.POH
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.POH <> Deleted.POH
end

-------------------  PGH  -----------------------------------------------------

if update(PGH)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PGH', Deleted.PGH, Inserted.PGH
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PGH <> Deleted.PGH
end

-------------------  FSH  -----------------------------------------------------

if update(FSH)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FSH', Deleted.FSH, Inserted.FSH
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.FSH <> Deleted.FSH
end

-------------------  GeneralAppearance  -----------------------------------------------------

if update(GeneralAppearance)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GeneralAppearance', Deleted.GeneralAppearance, Inserted.GeneralAppearance
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.GeneralAppearance <> Deleted.GeneralAppearance
end

-------------------  Respiratory  -----------------------------------------------------

if update(Respiratory)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Respiratory', Deleted.Respiratory, Inserted.Respiratory
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Respiratory <> Deleted.Respiratory
end

-------------------  CVS  -----------------------------------------------------

if update(CVS)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CVS', Deleted.CVS, Inserted.CVS
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CVS <> Deleted.CVS
end

-------------------  ENT  -----------------------------------------------------

if update(ENT)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ENT', Deleted.ENT, Inserted.ENT
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ENT <> Deleted.ENT
end

-------------------  Abdomen  -----------------------------------------------------

if update(Abdomen)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Abdomen', Deleted.Abdomen, Inserted.Abdomen
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Abdomen <> Deleted.Abdomen
end

-------------------  CNS  -----------------------------------------------------

if update(CNS)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CNS', Deleted.CNS, Inserted.CNS
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CNS <> Deleted.CNS
end

-------------------  EYE  -----------------------------------------------------

if update(EYE)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EYE', Deleted.EYE, Inserted.EYE
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EYE <> Deleted.EYE
end

-------------------  MuscularSkeletal  -----------------------------------------------------

if update(MuscularSkeletal)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MuscularSkeletal', Deleted.MuscularSkeletal, Inserted.MuscularSkeletal
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.MuscularSkeletal <> Deleted.MuscularSkeletal
end

-------------------  Skin  -----------------------------------------------------

if update(Skin)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Skin', Deleted.Skin, Inserted.Skin
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Skin <> Deleted.Skin
end

-------------------  PV  -----------------------------------------------------

if update(PV)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PV', Deleted.PV, Inserted.PV
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PV <> Deleted.PV
end

-------------------  PsychologicalStatus  -----------------------------------------------------

if update(PsychologicalStatus)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PsychologicalStatus', Deleted.PsychologicalStatus, Inserted.PsychologicalStatus
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PsychologicalStatus <> Deleted.PsychologicalStatus
end

-------------------  ProvisionalDiagnosis  -----------------------------------------------------

if update(ProvisionalDiagnosis)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProvisionalDiagnosis', Deleted.ProvisionalDiagnosis, Inserted.ProvisionalDiagnosis
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ProvisionalDiagnosis <> Deleted.ProvisionalDiagnosis
end

-------------------  TreatmentPlan  -----------------------------------------------------

if update(TreatmentPlan)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TreatmentPlan', Deleted.TreatmentPlan, Inserted.TreatmentPlan
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TreatmentPlan <> Deleted.TreatmentPlan
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ClinicalFindings --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteClinicalFindings')
drop trigger utrDeleteClinicalFindings
go

create trigger utrDeleteClinicalFindings
on ClinicalFindings
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ClinicalFindings' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  PresentingComplaint  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PresentingComplaint', Deleted.PresentingComplaint, null from Deleted

-------------------  ClinicalNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClinicalNotes', Deleted.ClinicalNotes, null from Deleted

-------------------  ROS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ROS', Deleted.ROS, null from Deleted

-------------------  PMH  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PMH', Deleted.PMH, null from Deleted

-------------------  POH  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'POH', Deleted.POH, null from Deleted

-------------------  PGH  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PGH', Deleted.PGH, null from Deleted

-------------------  FSH  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FSH', Deleted.FSH, null from Deleted

-------------------  GeneralAppearance  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GeneralAppearance', Deleted.GeneralAppearance, null from Deleted

-------------------  Respiratory  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Respiratory', Deleted.Respiratory, null from Deleted

-------------------  CVS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CVS', Deleted.CVS, null from Deleted

-------------------  ENT  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ENT', Deleted.ENT, null from Deleted

-------------------  Abdomen  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Abdomen', Deleted.Abdomen, null from Deleted

-------------------  CNS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CNS', Deleted.CNS, null from Deleted

-------------------  EYE  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EYE', Deleted.EYE, null from Deleted

-------------------  MuscularSkeletal  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MuscularSkeletal', Deleted.MuscularSkeletal, null from Deleted

-------------------  Skin  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Skin', Deleted.Skin, null from Deleted

-------------------  PV  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PV', Deleted.PV, null from Deleted

-------------------  PsychologicalStatus  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PsychologicalStatus', Deleted.PsychologicalStatus, null from Deleted

-------------------  ProvisionalDiagnosis  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProvisionalDiagnosis', Deleted.ProvisionalDiagnosis, null from Deleted

-------------------  TreatmentPlan  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TreatmentPlan', Deleted.TreatmentPlan, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Optical -----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateOptical')
drop trigger utrUpdateOptical
go

create trigger utrUpdateOptical
on Optical
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Optical' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  RightSPH  -----------------------------------------------------

if update(RightSPH)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightSPH', Deleted.RightSPH, Inserted.RightSPH
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightSPH <> Deleted.RightSPH
end

-------------------  RightCYL  -----------------------------------------------------

if update(RightCYL)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightCYL', Deleted.RightCYL, Inserted.RightCYL
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightCYL <> Deleted.RightCYL
end

-------------------  RightAXIS  -----------------------------------------------------

if update(RightAXIS)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAXIS', Deleted.RightAXIS, Inserted.RightAXIS
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightAXIS <> Deleted.RightAXIS
end

-------------------  RightPRISM  -----------------------------------------------------

if update(RightPRISM)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightPRISM', Deleted.RightPRISM, Inserted.RightPRISM
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightPRISM <> Deleted.RightPRISM
end

-------------------  RightADD  -----------------------------------------------------

if update(RightADD)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightADD', Deleted.RightADD, Inserted.RightADD
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightADD <> Deleted.RightADD
end

-------------------  LeftSPH  -----------------------------------------------------

if update(LeftSPH)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftSPH', Deleted.LeftSPH, Inserted.LeftSPH
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftSPH <> Deleted.LeftSPH
end

-------------------  LeftCYL  -----------------------------------------------------

if update(LeftCYL)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftCYL', Deleted.LeftCYL, Inserted.LeftCYL
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftCYL <> Deleted.LeftCYL
end

-------------------  LeftAXIS  -----------------------------------------------------

if update(LeftAXIS)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAXIS', Deleted.LeftAXIS, Inserted.LeftAXIS
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftAXIS <> Deleted.LeftAXIS
end

-------------------  LeftPRISM  -----------------------------------------------------

if update(LeftPRISM)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftPRISM', Deleted.LeftPRISM, Inserted.LeftPRISM
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftPRISM <> Deleted.LeftPRISM
end

-------------------  LeftADD  -----------------------------------------------------

if update(LeftADD)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftADD', Deleted.LeftADD, Inserted.LeftADD
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftADD <> Deleted.LeftADD
end

-------------------  LenseTypeID  -----------------------------------------------------

if update(LenseTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LenseTypeID', Deleted.LenseTypeID, Inserted.LenseTypeID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LenseTypeID <> Deleted.LenseTypeID
end

-------------------  Pd  -----------------------------------------------------

if update(Pd)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pd', Deleted.Pd, Inserted.Pd
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Pd <> Deleted.Pd
end

-------------------  Sg  -----------------------------------------------------

if update(Sg)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Sg', Deleted.Sg, Inserted.Sg
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Sg <> Deleted.Sg
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Optical -----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteOptical')
drop trigger utrDeleteOptical
go

create trigger utrDeleteOptical
on Optical
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Optical' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  RightSPH  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightSPH', Deleted.RightSPH, null from Deleted

-------------------  RightCYL  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightCYL', Deleted.RightCYL, null from Deleted

-------------------  RightAXIS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAXIS', Deleted.RightAXIS, null from Deleted

-------------------  RightPRISM  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightPRISM', Deleted.RightPRISM, null from Deleted

-------------------  RightADD  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightADD', Deleted.RightADD, null from Deleted

-------------------  LeftSPH  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftSPH', Deleted.LeftSPH, null from Deleted

-------------------  LeftCYL  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftCYL', Deleted.LeftCYL, null from Deleted

-------------------  LeftAXIS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAXIS', Deleted.LeftAXIS, null from Deleted

-------------------  LeftPRISM  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftPRISM', Deleted.LeftPRISM, null from Deleted

-------------------  LeftADD  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftADD', Deleted.LeftADD, null from Deleted

-------------------  LenseTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LenseTypeID', Deleted.LenseTypeID, null from Deleted

-------------------  Pd  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pd', Deleted.Pd, null from Deleted

-------------------  Sg  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Sg', Deleted.Sg, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: EyeAssessment -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateEyeAssessment')
drop trigger utrUpdateEyeAssessment
go

create trigger utrUpdateEyeAssessment
on EyeAssessment
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'EyeAssessment' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  LeftPupil  -----------------------------------------------------

if update(LeftPupil)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftPupil', Deleted.LeftPupil, Inserted.LeftPupil
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftPupil <> Deleted.LeftPupil
end

-------------------  RightPupil  -----------------------------------------------------

if update(RightPupil)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightPupil', Deleted.RightPupil, Inserted.RightPupil
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightPupil <> Deleted.RightPupil
end

-------------------  LeftLidMargin  -----------------------------------------------------

if update(LeftLidMargin)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftLidMargin', Deleted.LeftLidMargin, Inserted.LeftLidMargin
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftLidMargin <> Deleted.LeftLidMargin
end

-------------------  RightLidMargin  -----------------------------------------------------

if update(RightLidMargin)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightLidMargin', Deleted.RightLidMargin, Inserted.RightLidMargin
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightLidMargin <> Deleted.RightLidMargin
end

-------------------  LeftConjuctiva  -----------------------------------------------------

if update(LeftConjuctiva)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftConjuctiva', Deleted.LeftConjuctiva, Inserted.LeftConjuctiva
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftConjuctiva <> Deleted.LeftConjuctiva
end

-------------------  RightConjuctiva  -----------------------------------------------------

if update(RightConjuctiva)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightConjuctiva', Deleted.RightConjuctiva, Inserted.RightConjuctiva
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightConjuctiva <> Deleted.RightConjuctiva
end

-------------------  LeftBulbarConjuctiva  -----------------------------------------------------

if update(LeftBulbarConjuctiva)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftBulbarConjuctiva', Deleted.LeftBulbarConjuctiva, Inserted.LeftBulbarConjuctiva
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftBulbarConjuctiva <> Deleted.LeftBulbarConjuctiva
end

-------------------  RightBulbarConjuctiva  -----------------------------------------------------

if update(RightBulbarConjuctiva)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightBulbarConjuctiva', Deleted.RightBulbarConjuctiva, Inserted.RightBulbarConjuctiva
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightBulbarConjuctiva <> Deleted.RightBulbarConjuctiva
end

-------------------  LeftCentralCornea  -----------------------------------------------------

if update(LeftCentralCornea)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftCentralCornea', Deleted.LeftCentralCornea, Inserted.LeftCentralCornea
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftCentralCornea <> Deleted.LeftCentralCornea
end

-------------------  RightCentralCornea  -----------------------------------------------------

if update(RightCentralCornea)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightCentralCornea', Deleted.RightCentralCornea, Inserted.RightCentralCornea
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightCentralCornea <> Deleted.RightCentralCornea
end

-------------------  LeftVerticalCornea  -----------------------------------------------------

if update(LeftVerticalCornea)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftVerticalCornea', Deleted.LeftVerticalCornea, Inserted.LeftVerticalCornea
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftVerticalCornea <> Deleted.LeftVerticalCornea
end

-------------------  RightVerticalCornea  -----------------------------------------------------

if update(RightVerticalCornea)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightVerticalCornea', Deleted.RightVerticalCornea, Inserted.RightVerticalCornea
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightVerticalCornea <> Deleted.RightVerticalCornea
end

-------------------  LeftAnteriorChamber  -----------------------------------------------------

if update(LeftAnteriorChamber)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAnteriorChamber', Deleted.LeftAnteriorChamber, Inserted.LeftAnteriorChamber
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftAnteriorChamber <> Deleted.LeftAnteriorChamber
end

-------------------  RightAnteriorChamber  -----------------------------------------------------

if update(RightAnteriorChamber)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAnteriorChamber', Deleted.RightAnteriorChamber, Inserted.RightAnteriorChamber
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightAnteriorChamber <> Deleted.RightAnteriorChamber
end

-------------------  LeftIrish  -----------------------------------------------------

if update(LeftIrish)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftIrish', Deleted.LeftIrish, Inserted.LeftIrish
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftIrish <> Deleted.LeftIrish
end

-------------------  RightIrish  -----------------------------------------------------

if update(RightIrish)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightIrish', Deleted.RightIrish, Inserted.RightIrish
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightIrish <> Deleted.RightIrish
end

-------------------  LeftAnteriorChamberAngle  -----------------------------------------------------

if update(LeftAnteriorChamberAngle)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAnteriorChamberAngle', Deleted.LeftAnteriorChamberAngle, Inserted.LeftAnteriorChamberAngle
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftAnteriorChamberAngle <> Deleted.LeftAnteriorChamberAngle
end

-------------------  RightAnteriorChamberAngle  -----------------------------------------------------

if update(RightAnteriorChamberAngle)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAnteriorChamberAngle', Deleted.RightAnteriorChamberAngle, Inserted.RightAnteriorChamberAngle
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightAnteriorChamberAngle <> Deleted.RightAnteriorChamberAngle
end

-------------------  LeftRetina  -----------------------------------------------------

if update(LeftRetina)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftRetina', Deleted.LeftRetina, Inserted.LeftRetina
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftRetina <> Deleted.LeftRetina
end

-------------------  RightRetina  -----------------------------------------------------

if update(RightRetina)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightRetina', Deleted.RightRetina, Inserted.RightRetina
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightRetina <> Deleted.RightRetina
end

-------------------  LeftMacular  -----------------------------------------------------

if update(LeftMacular)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftMacular', Deleted.LeftMacular, Inserted.LeftMacular
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftMacular <> Deleted.LeftMacular
end

-------------------  RightMacular  -----------------------------------------------------

if update(RightMacular)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightMacular', Deleted.RightMacular, Inserted.RightMacular
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightMacular <> Deleted.RightMacular
end

-------------------  LeftOpticDisc  -----------------------------------------------------

if update(LeftOpticDisc)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftOpticDisc', Deleted.LeftOpticDisc, Inserted.LeftOpticDisc
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftOpticDisc <> Deleted.LeftOpticDisc
end

-------------------  RightOpticDisc  -----------------------------------------------------

if update(RightOpticDisc)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightOpticDisc', Deleted.RightOpticDisc, Inserted.RightOpticDisc
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightOpticDisc <> Deleted.RightOpticDisc
end

-------------------  LeftIOP  -----------------------------------------------------

if update(LeftIOP)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftIOP', Deleted.LeftIOP, Inserted.LeftIOP
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftIOP <> Deleted.LeftIOP
end

-------------------  RightIOP  -----------------------------------------------------

if update(RightIOP)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightIOP', Deleted.RightIOP, Inserted.RightIOP
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightIOP <> Deleted.RightIOP
end

-------------------  LeftVitreous  -----------------------------------------------------

if update(LeftVitreous)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftVitreous', Deleted.LeftVitreous, Inserted.LeftVitreous
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftVitreous <> Deleted.LeftVitreous
end

-------------------  RightVitreous  -----------------------------------------------------

if update(RightVitreous)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightVitreous', Deleted.RightVitreous, Inserted.RightVitreous
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightVitreous <> Deleted.RightVitreous
end

-------------------  LeftLense  -----------------------------------------------------

if update(LeftLense)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftLense', Deleted.LeftLense, Inserted.LeftLense
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftLense <> Deleted.LeftLense
end

-------------------  RightLense  -----------------------------------------------------

if update(RightLense)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightLense', Deleted.RightLense, Inserted.RightLense
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightLense <> Deleted.RightLense
end

-------------------  EyeNotes  -----------------------------------------------------

if update(EyeNotes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EyeNotes', Deleted.EyeNotes, Inserted.EyeNotes
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EyeNotes <> Deleted.EyeNotes
end

-------------------  LeftEyeBall  -----------------------------------------------------

if update(LeftEyeBall)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftEyeBall', Deleted.LeftEyeBall, Inserted.LeftEyeBall
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftEyeBall <> Deleted.LeftEyeBall
end

-------------------  RightEyeBall  -----------------------------------------------------

if update(RightEyeBall)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightEyeBall', Deleted.RightEyeBall, Inserted.RightEyeBall
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightEyeBall <> Deleted.RightEyeBall
end

-------------------  LeftOrbit  -----------------------------------------------------

if update(LeftOrbit)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftOrbit', Deleted.LeftOrbit, Inserted.LeftOrbit
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftOrbit <> Deleted.LeftOrbit
end

-------------------  RightOrbit  -----------------------------------------------------

if update(RightOrbit)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightOrbit', Deleted.RightOrbit, Inserted.RightOrbit
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightOrbit <> Deleted.RightOrbit
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: EyeAssessment -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteEyeAssessment')
drop trigger utrDeleteEyeAssessment
go

create trigger utrDeleteEyeAssessment
on EyeAssessment
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'EyeAssessment' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  LeftPupil  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftPupil', Deleted.LeftPupil, null from Deleted

-------------------  RightPupil  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightPupil', Deleted.RightPupil, null from Deleted

-------------------  LeftLidMargin  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftLidMargin', Deleted.LeftLidMargin, null from Deleted

-------------------  RightLidMargin  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightLidMargin', Deleted.RightLidMargin, null from Deleted

-------------------  LeftConjuctiva  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftConjuctiva', Deleted.LeftConjuctiva, null from Deleted

-------------------  RightConjuctiva  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightConjuctiva', Deleted.RightConjuctiva, null from Deleted

-------------------  LeftBulbarConjuctiva  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftBulbarConjuctiva', Deleted.LeftBulbarConjuctiva, null from Deleted

-------------------  RightBulbarConjuctiva  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightBulbarConjuctiva', Deleted.RightBulbarConjuctiva, null from Deleted

-------------------  LeftCentralCornea  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftCentralCornea', Deleted.LeftCentralCornea, null from Deleted

-------------------  RightCentralCornea  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightCentralCornea', Deleted.RightCentralCornea, null from Deleted

-------------------  LeftVerticalCornea  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftVerticalCornea', Deleted.LeftVerticalCornea, null from Deleted

-------------------  RightVerticalCornea  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightVerticalCornea', Deleted.RightVerticalCornea, null from Deleted

-------------------  LeftAnteriorChamber  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAnteriorChamber', Deleted.LeftAnteriorChamber, null from Deleted

-------------------  RightAnteriorChamber  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAnteriorChamber', Deleted.RightAnteriorChamber, null from Deleted

-------------------  LeftIrish  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftIrish', Deleted.LeftIrish, null from Deleted

-------------------  RightIrish  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightIrish', Deleted.RightIrish, null from Deleted

-------------------  LeftAnteriorChamberAngle  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAnteriorChamberAngle', Deleted.LeftAnteriorChamberAngle, null from Deleted

-------------------  RightAnteriorChamberAngle  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAnteriorChamberAngle', Deleted.RightAnteriorChamberAngle, null from Deleted

-------------------  LeftRetina  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftRetina', Deleted.LeftRetina, null from Deleted

-------------------  RightRetina  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightRetina', Deleted.RightRetina, null from Deleted

-------------------  LeftMacular  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftMacular', Deleted.LeftMacular, null from Deleted

-------------------  RightMacular  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightMacular', Deleted.RightMacular, null from Deleted

-------------------  LeftOpticDisc  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftOpticDisc', Deleted.LeftOpticDisc, null from Deleted

-------------------  RightOpticDisc  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightOpticDisc', Deleted.RightOpticDisc, null from Deleted

-------------------  LeftIOP  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftIOP', Deleted.LeftIOP, null from Deleted

-------------------  RightIOP  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightIOP', Deleted.RightIOP, null from Deleted

-------------------  LeftVitreous  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftVitreous', Deleted.LeftVitreous, null from Deleted

-------------------  RightVitreous  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightVitreous', Deleted.RightVitreous, null from Deleted

-------------------  LeftLense  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftLense', Deleted.LeftLense, null from Deleted

-------------------  RightLense  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightLense', Deleted.RightLense, null from Deleted

-------------------  EyeNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EyeNotes', Deleted.EyeNotes, null from Deleted

-------------------  LeftEyeBall  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftEyeBall', Deleted.LeftEyeBall, null from Deleted

-------------------  RightEyeBall  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightEyeBall', Deleted.RightEyeBall, null from Deleted
-------------------  LeftOrbit  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftOrbit', Deleted.LeftOrbit, null from Deleted

-------------------  RightOrbit  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightOrbit', Deleted.RightOrbit, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Procedures ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateProcedures')
	drop trigger utrUpdateProcedures
go

create trigger utrUpdateProcedures
on Procedures
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Procedures' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-ProcedureCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ProcedureCode', Deleted.ProcedureCode, Inserted.ProcedureCode
	from Inserted inner join Deleted
	on Inserted.ProcedureCode = Deleted.ProcedureCode
end

-------------------  ProcedureID  -----------------------------------------------------

if update(ProcedureID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ProcedureID', Deleted.ProcedureID, Inserted.ProcedureID
	from Inserted inner join Deleted
	on Inserted.ProcedureCode = Deleted.ProcedureCode
	and Inserted.ProcedureID <> Deleted.ProcedureID
end

-------------------  ProcedureName  -----------------------------------------------------

if update(ProcedureName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ProcedureName', Deleted.ProcedureName, Inserted.ProcedureName
	from Inserted inner join Deleted
	on Inserted.ProcedureCode = Deleted.ProcedureCode
	and Inserted.ProcedureName <> Deleted.ProcedureName
end

-------------------  ShortName  -----------------------------------------------------

if update(ShortName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ShortName', Deleted.ShortName, Inserted.ShortName
	from Inserted inner join Deleted
	on Inserted.ProcedureCode = Deleted.ProcedureCode
	and Inserted.ShortName <> Deleted.ShortName
end

-------------------  ProcedureCategoryID  -----------------------------------------------------

if update(ProcedureCategoryID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ProcedureCategoryID', Deleted.ProcedureCategoryID, Inserted.ProcedureCategoryID
	from Inserted inner join Deleted
	on Inserted.ProcedureCode = Deleted.ProcedureCode
	and Inserted.ProcedureCategoryID <> Deleted.ProcedureCategoryID
end

-------------------  UnitCost  -----------------------------------------------------

if update(UnitCost)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
	from Inserted inner join Deleted
	on Inserted.ProcedureCode = Deleted.ProcedureCode
	and Inserted.UnitCost <> Deleted.UnitCost
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
	from Inserted inner join Deleted
	on Inserted.ProcedureCode = Deleted.ProcedureCode
	and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
	from Inserted inner join Deleted
	on Inserted.ProcedureCode = Deleted.ProcedureCode
	and Inserted.Hidden <> Deleted.Hidden
end

-------------------  RevenueStream  -----------------------------------------------------

if update(RevenueStream)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RevenueStream', Deleted.RevenueStream, Inserted.RevenueStream
	from Inserted inner join Deleted
	on Inserted.ProcedureCode = Deleted.ProcedureCode
	and Inserted.RevenueStream <> Deleted.RevenueStream
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.ProcedureCode = Deleted.ProcedureCode
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.ProcedureCode = Deleted.ProcedureCode
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.ProcedureCode = Deleted.ProcedureCode
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go
------------------------------------------------------------------------------------------------------
-------------- Delete: Procedures --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteProcedures')
drop trigger utrDeleteProcedures
go

create trigger utrDeleteProcedures
on Procedures
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

-------------------------------------------------------------------------------------------------------
set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'P')

if exists (select ItemCode from Items 
where (ItemCode in (select ProcedureCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select ProcedureCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
	
if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select ProcedureCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
	
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select ProcedureCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
	
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select ProcedureCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select ProcedureCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select ProcedureCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select ProcedureCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select ProcedureCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select ProcedureCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Procedures' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ProcedureID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProcedureID', Deleted.ProcedureID, null from Deleted

-------------------  ProcedureCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProcedureCode', Deleted.ProcedureCode, null from Deleted

-------------------  ProcedureName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProcedureName', Deleted.ProcedureName, null from Deleted

-------------------  ShortName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ShortName', Deleted.ShortName, null from Deleted

-------------------  ProcedureCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProcedureCategoryID', Deleted.ProcedureCategoryID, null from Deleted

-------------------  UnitCost  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted

-------------------  RevenueStream  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RevenueStream', Deleted.RevenueStream, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: DentalServices ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateDentalServices')
drop trigger utrUpdateDentalServices
go

create trigger utrUpdateDentalServices
on DentalServices
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'DentalServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-DentalCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DentalCode', Deleted.DentalCode, Inserted.DentalCode
from Inserted inner join Deleted
on Inserted.DentalCode = Deleted.DentalCode
end

-------------------  DentalName  -----------------------------------------------------

if update(DentalName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DentalName', Deleted.DentalName, Inserted.DentalName
from Inserted inner join Deleted
on Inserted.DentalCode = Deleted.DentalCode
and Inserted.DentalName <> Deleted.DentalName
end

-------------------  DentalCategoryID  -----------------------------------------------------

if update(DentalCategoryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DentalCategoryID', Deleted.DentalCategoryID, Inserted.DentalCategoryID
from Inserted inner join Deleted
on Inserted.DentalCode = Deleted.DentalCode
and Inserted.DentalCategoryID <> Deleted.DentalCategoryID
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.DentalCode = Deleted.DentalCode
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  VATPercentage  -----------------------------------------------------

if update(VATPercentage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), cast(Inserted.VATPercentage as varchar(20))
from Inserted inner join Deleted
on Inserted.DentalCode = Deleted.DentalCode
and Inserted.VATPercentage <> Deleted.VATPercentage
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.DentalCode = Deleted.DentalCode
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: DentalServices ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteDentalServices')
drop trigger utrDeleteDentalServices
go

create trigger utrDeleteDentalServices
on DentalServices
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

-------------------------------------------------------------------------------------------------------
set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'N')

if exists (select ItemCode from Items 
where (ItemCode in (select DentalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select DentalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select DentalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select DentalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select DentalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select DentalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select DentalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select DentalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select DentalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select DentalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'DentalServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  DentalCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DentalCode', Deleted.DentalCode, null from Deleted

-------------------  DentalName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DentalName', Deleted.DentalName, null from Deleted

-------------------  DentalCategoryID  -----------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DentalCategoryID', Deleted.DentalCategoryID, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  VATPercentage  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), null from Deleted


-------------------  Hidden  --------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: TheatreServices ---------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateTheatreServices')
drop trigger utrUpdateTheatreServices
go

create trigger utrUpdateTheatreServices
on TheatreServices
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'TheatreServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return


------------------- Key-TheatreCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TheatreCode', Deleted.TheatreCode, Inserted.TheatreCode
from Inserted inner join Deleted
on Inserted.TheatreCode = Deleted.TheatreCode
end

-------------------  TheatreName  -----------------------------------------------------

if update(TheatreName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TheatreName', Deleted.TheatreName, Inserted.TheatreName
from Inserted inner join Deleted
on Inserted.TheatreCode = Deleted.TheatreCode
and Inserted.TheatreName <> Deleted.TheatreName
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.TheatreCode = Deleted.TheatreCode
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  VATPercentage -----------------------------------------------------

if update(VATPercentage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), cast(Inserted.VATPercentage as varchar(20))
from Inserted inner join Deleted
on Inserted.TheatreCode = Deleted.TheatreCode
and Inserted.VATPercentage <> Deleted.VATPercentage
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.TheatreCode = Deleted.TheatreCode
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: TheatreServices ---------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteTheatreServices')
drop trigger utrDeleteTheatreServices
go

create trigger utrDeleteTheatreServices
on TheatreServices
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return
-------------------------------------------------------------------------------------------------------
set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'H')

if exists (select ItemCode from Items 
where (ItemCode in (select TheatreCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select TheatreCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select TheatreCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select TheatreCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select TheatreCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select TheatreCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select TheatreCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select TheatreCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select TheatreCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select TheatreCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'TheatreServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  TheatreCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TheatreCode', Deleted.TheatreCode, null from Deleted

-------------------  TheatreName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TheatreName', Deleted.TheatreName, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  VATPercentage  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: EyeServices -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateEyeServices')
drop trigger utrUpdateEyeServices
go

create trigger utrUpdateEyeServices
on EyeServices
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'EyeServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-EyeCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EyeCode', Deleted.EyeCode, Inserted.EyeCode
from Inserted inner join Deleted
on Inserted.EyeCode = Deleted.EyeCode
end

-------------------  EyeName  -----------------------------------------------------

if update(EyeName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EyeName', Deleted.EyeName, Inserted.EyeName
from Inserted inner join Deleted
on Inserted.EyeCode = Deleted.EyeCode
and Inserted.EyeName <> Deleted.EyeName
end

-------------------  UnitCost  -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
from Inserted inner join Deleted
on Inserted.EyeCode = Deleted.EyeCode
and Inserted.UnitCost <> Deleted.UnitCost
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.EyeCode = Deleted.EyeCode
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  VATPercentage  -----------------------------------------------------

if update(VATPercentage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), cast(Inserted.VATPercentage as varchar(20))
from Inserted inner join Deleted
on Inserted.EyeCode = Deleted.EyeCode
and Inserted.VATPercentage <> Deleted.VATPercentage
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.EyeCode = Deleted.EyeCode
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: EyeServices -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteEyeServices')
drop trigger utrDeleteEyeServices
go

create trigger utrDeleteEyeServices
on EyeServices
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

-------------------------------------------------------------------------------------------------------
set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'Y')

if exists (select ItemCode from Items 
where (ItemCode in (select EyeCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select EyeCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select EyeCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select EyeCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select EyeCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select EyeCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select EyeCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select EyeCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select EyeCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select EyeCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
	
------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'EyeServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  EyeCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EyeCode', Deleted.EyeCode, null from Deleted

-------------------  EyeName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EyeName', Deleted.EyeName, null from Deleted

-------------------  UnitCost  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  VATPercentage  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Delete: Refraction ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRefraction')
drop trigger utrDeleteRefraction
go

create trigger utrDeleteRefraction
on Refraction
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Refraction' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  RightMRSPH  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightMRSPH', Deleted.RightMRSPH, null from Deleted

-------------------  LeftMRSPH  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftMRSPH', Deleted.LeftMRSPH, null from Deleted

-------------------  RightMRCYL  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightMRCYL', Deleted.RightMRCYL, null from Deleted

-------------------  LeftMRCYL  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftMRCYL', Deleted.LeftMRCYL, null from Deleted

-------------------  RightMRAXIS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightMRAXIS', Deleted.RightMRAXIS, null from Deleted

-------------------  LeftMRAXIS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftMRAXIS', Deleted.LeftMRAXIS, null from Deleted

-------------------  RightCRSPH  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightCRSPH', Deleted.RightCRSPH, null from Deleted

-------------------  LeftCRSPH  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftCRSPH', Deleted.LeftCRSPH, null from Deleted

-------------------  RightCRCYL  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightCRCYL', Deleted.RightCRCYL, null from Deleted

-------------------  LeftCRCYL  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftCRCYL', Deleted.LeftCRCYL, null from Deleted

-------------------  RightCRAXIS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightCRAXIS', Deleted.RightCRAXIS, null from Deleted

-------------------  LeftCRAXIS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftCRAXIS', Deleted.LeftCRAXIS, null from Deleted

-------------------  RightPCRSPH  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightPCRSPH', Deleted.RightPCRSPH, null from Deleted

-------------------  LeftPCRSPH  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftPCRSPH', Deleted.LeftPCRSPH, null from Deleted

-------------------  RightPCRCYL  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightPCRCYL', Deleted.RightPCRCYL, null from Deleted

-------------------  LeftPCRCYL  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftPCRCYL', Deleted.LeftPCRCYL, null from Deleted

-------------------  RightPCRAXIS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightPCRAXIS', Deleted.RightPCRAXIS, null from Deleted

-------------------  LeftPCRRAXIS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftPCRRAXIS', Deleted.LeftPCRRAXIS, null from Deleted

------------------- PD -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PD', Deleted.PD, null from Deleted

------------------- SegmentHeights -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SegmentHeights', Deleted.SegmentHeights, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: OpticalServices ---------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateOpticalServices')
drop trigger utrUpdateOpticalServices
go

create trigger utrUpdateOpticalServices
on OpticalServices
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'OpticalServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-OpticalCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OpticalCode', Deleted.OpticalCode, Inserted.OpticalCode
from Inserted inner join Deleted
on Inserted.OpticalCode = Deleted.OpticalCode
end

-------------------  OpticalName  -----------------------------------------------------

if update(OpticalName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OpticalName', Deleted.OpticalName, Inserted.OpticalName
from Inserted inner join Deleted
on Inserted.OpticalCode = Deleted.OpticalCode
and Inserted.OpticalName <> Deleted.OpticalName
end

-------------------  OpticalCategoryID  -----------------------------------------------------

if update(OpticalCategoryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OpticalCategoryID', Deleted.OpticalCategoryID, Inserted.OpticalCategoryID
from Inserted inner join Deleted
on Inserted.OpticalCode = Deleted.OpticalCode
and Inserted.OpticalCategoryID <> Deleted.OpticalCategoryID
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.OpticalCode = Deleted.OpticalCode
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.OpticalCode = Deleted.OpticalCode
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: OpticalServices ---------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteOpticalServices')
drop trigger utrDeleteOpticalServices
go

create trigger utrDeleteOpticalServices
on OpticalServices
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

-------------------------------------------------------------------------------------------------------
set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'O')

if exists (select ItemCode from Items 
where (ItemCode in (select OpticalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select OpticalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select OpticalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select OpticalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select OpticalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select OpticalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select OpticalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select OpticalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select OpticalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select OpticalCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
	
------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'OpticalServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  OpticalCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OpticalCode', Deleted.OpticalCode, null from Deleted

-------------------  OpticalName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OpticalName', Deleted.OpticalName, null from Deleted

-------------------  OpticalCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OpticalCategoryID', Deleted.OpticalCategoryID, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: MaternityServices -------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateMaternityServices')
drop trigger utrUpdateMaternityServices
go

create trigger utrUpdateMaternityServices
on MaternityServices
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'MaternityServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-MaternityCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MaternityCode', Deleted.MaternityCode, Inserted.MaternityCode
from Inserted inner join Deleted
on Inserted.MaternityCode = Deleted.MaternityCode
end

-------------------  MaternityName  -----------------------------------------------------

if update(MaternityName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MaternityName', Deleted.MaternityName, Inserted.MaternityName
from Inserted inner join Deleted
on Inserted.MaternityCode = Deleted.MaternityCode
and Inserted.MaternityName <> Deleted.MaternityName
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.MaternityCode = Deleted.MaternityCode
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  VATPercentage  -----------------------------------------------------

if update(VATPercentage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), cast(Inserted.VATPercentage as varchar(20))
from Inserted inner join Deleted
on Inserted.MaternityCode = Deleted.MaternityCode
and Inserted.VATPercentage <> Deleted.VATPercentage
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.MaternityCode = Deleted.MaternityCode
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: MaternityServices -------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteMaternityServices')
drop trigger utrDeleteMaternityServices
go

create trigger utrDeleteMaternityServices
on MaternityServices
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

-------------------------------------------------------------------------------------------------------
set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'M')

if exists (select ItemCode from Items 
where (ItemCode in (select MaternityCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select MaternityCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select MaternityCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select MaternityCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select MaternityCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select MaternityCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select MaternityCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select MaternityCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select MaternityCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select MaternityCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'MaternityServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  MaternityCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MaternityCode', Deleted.MaternityCode, null from Deleted

-------------------  MaternityName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MaternityName', Deleted.MaternityName, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-----------  VATPercentage  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), null from Deleted


-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ICUServices -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateICUServices')
drop trigger utrUpdateICUServices
go

create trigger utrUpdateICUServices
on ICUServices
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ICUServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ICUCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ICUCode', Deleted.ICUCode, Inserted.ICUCode
from Inserted inner join Deleted
on Inserted.ICUCode = Deleted.ICUCode
end

-------------------  ICUName  -----------------------------------------------------

if update(ICUName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ICUName', Deleted.ICUName, Inserted.ICUName
from Inserted inner join Deleted
on Inserted.ICUCode = Deleted.ICUCode
and Inserted.ICUName <> Deleted.ICUName
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.ICUCode = Deleted.ICUCode
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  VATPercentage  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), cast(Inserted.VATPercentage as varchar(20))
from Inserted inner join Deleted
on Inserted.ICUCode = Deleted.ICUCode
and Inserted.VATPercentage <> Deleted.VATPercentage
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.ICUCode = Deleted.ICUCode
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ICUServices -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteICUServices')
drop trigger utrDeleteICUServices
go

create trigger utrDeleteICUServices
on ICUServices
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

-------------------------------------------------------------------------------------------------------
set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'I')

if exists (select ItemCode from Items 
where (ItemCode in (select ICUCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select ICUCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select ICUCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select ICUCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select ICUCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select ICUCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select ICUCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select ICUCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select ICUCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select ICUCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ICUServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ICUCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ICUCode', Deleted.ICUCode, null from Deleted

-------------------  ICUName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ICUName', Deleted.ICUName, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-----------  VATPercentage  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted
go
------------------------------------------------------------------------------------------------------
-------------- Update: Diseases ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateDiseases')
drop trigger utrUpdateDiseases
go

create trigger utrUpdateDiseases
on Diseases
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Diseases' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-DiseaseCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseCode', Deleted.DiseaseCode, Inserted.DiseaseCode
from Inserted inner join Deleted
on Inserted.DiseaseCode = Deleted.DiseaseCode
end

-------------------  DiseaseName  -----------------------------------------------------

if update(DiseaseName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseName', Deleted.DiseaseName, Inserted.DiseaseName
from Inserted inner join Deleted
on Inserted.DiseaseCode = Deleted.DiseaseCode
and Inserted.DiseaseName <> Deleted.DiseaseName
end

-------------------  DiseaseCategoriesID  -----------------------------------------------------

if update(DiseaseCategoriesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseCategoriesID', Deleted.DiseaseCategoriesID, Inserted.DiseaseCategoriesID
from Inserted inner join Deleted
on Inserted.DiseaseCode = Deleted.DiseaseCode
and Inserted.DiseaseCategoriesID <> Deleted.DiseaseCategoriesID
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.DiseaseCode = Deleted.DiseaseCode
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Diseases ----------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteDiseases')
drop trigger utrDeleteDiseases
go

create trigger utrDeleteDiseases
on Diseases
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Diseases' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  DiseaseCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseCode', Deleted.DiseaseCode, null from Deleted

-------------------  DiseaseName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseName', Deleted.DiseaseName, null from Deleted

-------------------  DiseaseCategoriesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseCategoriesID', Deleted.DiseaseCategoriesID, null from Deleted

-------------------  Hidden  ----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Referrals ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateReferrals')
drop trigger utrUpdateReferrals
go

create trigger utrUpdateReferrals
on Referrals
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Referrals' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  ReferralDate  -----------------------------------------------------

if update(ReferralDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferralDate', dbo.FormatDate(Deleted.ReferralDate), dbo.FormatDate(Inserted.ReferralDate)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ReferralDate <> Deleted.ReferralDate
end

-------------------  ReferredBy  -----------------------------------------------------

if update(ReferredBy)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferredBy', Deleted.ReferredBy, Inserted.ReferredBy
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ReferredBy <> Deleted.ReferredBy
end

-------------------  DoctorSpecialtyID  -----------------------------------------------------

if update(DoctorSpecialtyID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, Inserted.DoctorSpecialtyID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DoctorSpecialtyID <> Deleted.DoctorSpecialtyID
end

-------------------  ReferredTo  -----------------------------------------------------

if update(ReferredTo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferredTo', Deleted.ReferredTo, Inserted.ReferredTo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ReferredTo <> Deleted.ReferredTo
end

-------------------  ReferralNotes  -----------------------------------------------------

if update(ReferralNotes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferralNotes', Deleted.ReferralNotes, Inserted.ReferralNotes
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ReferralNotes <> Deleted.ReferralNotes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Referrals ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteReferrals')
drop trigger utrDeleteReferrals
go

create trigger utrDeleteReferrals
on Referrals
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Referrals' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ReferralDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferralDate', dbo.FormatDate(Deleted.ReferralDate), null from Deleted

-------------------  ReferredBy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferredBy', Deleted.ReferredBy, null from Deleted

-------------------  DoctorSpecialtyID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, null from Deleted

-------------------  ReferredTo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferredTo', Deleted.ReferredTo, null from Deleted

-------------------  ReferralNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferralNotes', Deleted.ReferralNotes, null from Deleted

-------------------  LoginID  -----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

----------------------------------------------------------------------------------------------------------------------------
------------- Update: LabTests ---------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateLabTests')
drop trigger utrUpdateLabTests
go

create trigger utrUpdateLabTests
on LabTests
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'LabTests' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-TestCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestCode', Deleted.TestCode, Inserted.TestCode
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
end

------------------- TestName -----------------------------------------------------

if update(TestName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestName', Deleted.TestName, Inserted.TestName
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.TestName <> Deleted.TestName
end

------------------- SpecimenTypeID -----------------------------------------------------

if update(SpecimenTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecimenTypeID', Deleted.SpecimenTypeID, Inserted.SpecimenTypeID
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.SpecimenTypeID <> Deleted.SpecimenTypeID
end

------------------- LabsID -----------------------------------------------------

if update(LabsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LabsID', Deleted.LabsID, Inserted.LabsID
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.LabsID <> Deleted.LabsID
end

------------------- NormalRange -----------------------------------------------------

if update(NormalRange)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NormalRange', Deleted.NormalRange, Inserted.NormalRange
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.NormalRange <> Deleted.NormalRange
end

------------------- UnitMeasureID -----------------------------------------------------

if update(UnitMeasureID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasureID', Deleted.UnitMeasureID, Inserted.UnitMeasureID
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.UnitMeasureID <> Deleted.UnitMeasureID
end

------------------- UnitCost -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.UnitCost <> Deleted.UnitCost
end

------------------- TestFee -----------------------------------------------------

if update(TestFee)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestFee', cast(Deleted.TestFee as varchar(20)), cast(Inserted.TestFee as varchar(20))
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.TestFee <> Deleted.TestFee
end



------------------- ResultDataTypeID -----------------------------------------------------

if update(ResultDataTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultDataTypeID', Deleted.ResultDataTypeID, Inserted.ResultDataTypeID
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.ResultDataTypeID <> Deleted.ResultDataTypeID
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.TestCode = Deleted.TestCode
and Inserted.Hidden <> Deleted.Hidden
end

-------------------  RequiresResultsApproval  -----------------------------------------------------

if update(RequiresResultsApproval)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RequiresResultsApproval', Deleted.RequiresResultsApproval, Inserted.RequiresResultsApproval
from Inserted inner join Deleted
on Inserted.TestCode = Deleted.TestCode
and Inserted.RequiresResultsApproval <> Deleted.RequiresResultsApproval
end
------------------- TubeType -------------------------------------------------------------

if update(TubeType)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TubeType', Deleted.TubeType, Inserted.TubeType
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.TubeType <> Deleted.TubeType
end

------------------- TestDescription -------------------------------------------------------------

if update(TestDescription)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestDescription', Deleted.TestDescription, Inserted.TestDescription
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.TestDescription <> Deleted.TestDescription
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.TestCode  = Deleted.TestCode 
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.TestCode  = Deleted.TestCode 
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.TestCode  = Deleted.TestCode 
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

----------------------------------------------------------------------------------------------------------------------------
------------- Delete: LabTests -----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteLabTests')
drop trigger utrDeleteLabTests
go

create trigger utrDeleteLabTests
on LabTests
for  delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'T')

if exists (select ItemCode from Items 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return

set @Identity = ident_current('AuditTrail') 
if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'LabTests' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- TestCode -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestCode', Deleted.TestCode, null from Deleted 

------------------- TestName -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestName', Deleted.TestName, null from Deleted 

------------------- SpecimenTypeID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecimenTypeID', Deleted.SpecimenTypeID, null from Deleted 

------------------- LabsID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LabsID', Deleted.LabsID, null from Deleted 

------------------- NormalRange -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NormalRange', Deleted.NormalRange, null from Deleted 

------------------- UnitMeasureID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasureID', Deleted.UnitMeasureID, null from Deleted 

------------------- UnitCost -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted 

------------------- TestFee -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestFee', cast(Deleted.TestFee as varchar(20)), null from Deleted 

------------------- ResultDataTypeID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultDataTypeID', Deleted.ResultDataTypeID, null from Deleted 

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted

-------------------  RequiresResultsApproval  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RequiresResultsApproval', Deleted.RequiresResultsApproval, null from Deleted

------------------- TubeType -------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TubeType', Deleted.TubeType, null from Deleted 

------------------- TestDescription ----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestDescription', Deleted.TestDescription, null from Deleted 

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: LabPossibleResults ------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateLabPossibleResults')
drop trigger utrUpdateLabPossibleResults
go

create trigger utrUpdateLabPossibleResults
on LabPossibleResults
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'LabPossibleResults' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-TestCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestCode', Deleted.TestCode, Inserted.TestCode
from Inserted inner join Deleted
on Inserted.TestCode = Deleted.TestCode
and Inserted.PossibleResult = Deleted.PossibleResult
end

------------------- Key-PossibleResult -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PossibleResult', Deleted.PossibleResult, Inserted.PossibleResult
from Inserted inner join Deleted
on Inserted.TestCode = Deleted.TestCode
and Inserted.PossibleResult = Deleted.PossibleResult
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: LabPossibleResults ------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteLabPossibleResults')
drop trigger utrDeleteLabPossibleResults
go

create trigger utrDeleteLabPossibleResults
on LabPossibleResults
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'LabPossibleResults' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  TestCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestCode', Deleted.TestCode, null from Deleted

-------------------  PossibleResult  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PossibleResult', Deleted.PossibleResult, null from Deleted
go

------------------------------------------------------------------------------------------------------
------------- Update: LabTests ---------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateLabTests')
drop trigger utrUpdateLabTests
go

create trigger utrUpdateLabTests
on LabTests
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'LabTests' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-TestCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestCode', Deleted.TestCode, Inserted.TestCode
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
end

------------------- TestName -----------------------------------------------------

if update(TestName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestName', Deleted.TestName, Inserted.TestName
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.TestName <> Deleted.TestName
end

------------------- SpecimenTypeID -----------------------------------------------------

if update(SpecimenTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecimenTypeID', Deleted.SpecimenTypeID, Inserted.SpecimenTypeID
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.SpecimenTypeID <> Deleted.SpecimenTypeID
end

------------------- LabsID -----------------------------------------------------

if update(LabsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LabsID', Deleted.LabsID, Inserted.LabsID
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.LabsID <> Deleted.LabsID
end

------------------- NormalRange -----------------------------------------------------

if update(NormalRange)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NormalRange', Deleted.NormalRange, Inserted.NormalRange
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.NormalRange <> Deleted.NormalRange
end

------------------- UnitMeasureID -----------------------------------------------------

if update(UnitMeasureID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasureID', Deleted.UnitMeasureID, Inserted.UnitMeasureID
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.UnitMeasureID <> Deleted.UnitMeasureID
end

------------------- UnitCost -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.UnitCost <> Deleted.UnitCost
end

------------------- VATPercentage------------------------------------------

if update(VATPercentage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage',cast(Deleted.VATPercentage as varchar(20)), cast(Inserted.VATPercentage as varchar(20))
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.VATPercentage <> Deleted.VATPercentage
end

------------------- TestFee -----------------------------------------------------

if update(TestFee)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestFee', cast(Deleted.TestFee as varchar(20)), cast(Inserted.TestFee as varchar(20))
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.TestFee <> Deleted.TestFee
end

------------------- ResultDataTypeID -----------------------------------------------------

if update(ResultDataTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultDataTypeID', Deleted.ResultDataTypeID, Inserted.ResultDataTypeID
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.ResultDataTypeID <> Deleted.ResultDataTypeID
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.TestCode = Deleted.TestCode
and Inserted.Hidden <> Deleted.Hidden
end

------------------- TubeType -------------------------------------------------------------

if update(TubeType)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TubeType', Deleted.TubeType, Inserted.TubeType
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.TubeType <> Deleted.TubeType
end

------------------- TestDescription -------------------------------------------------------------

if update(TestDescription)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestDescription', Deleted.TestDescription, Inserted.TestDescription
from Inserted inner join Deleted 
on Inserted.TestCode = Deleted.TestCode
and Inserted.TestDescription <> Deleted.TestDescription
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.TestCode  = Deleted.TestCode 
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.TestCode  = Deleted.TestCode 
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.TestCode  = Deleted.TestCode 
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

----------------------------------------------------------------------------------------------------------------------------
------------- Delete: LabTests -----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteLabTests')
drop trigger utrDeleteLabTests
go

create trigger utrDeleteLabTests
on LabTests
for  delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'T')

if exists (select ItemCode from Items 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select TestCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return

set @Identity = ident_current('AuditTrail') 
if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'LabTests' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- TestCode -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestCode', Deleted.TestCode, null from Deleted 

------------------- TestName -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestName', Deleted.TestName, null from Deleted 

------------------- SpecimenTypeID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecimenTypeID', Deleted.SpecimenTypeID, null from Deleted 

------------------- LabsID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LabsID', Deleted.LabsID, null from Deleted 

------------------- NormalRange -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NormalRange', Deleted.NormalRange, null from Deleted 

------------------- UnitMeasureID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasureID', Deleted.UnitMeasureID, null from Deleted 

------------------- UnitCost -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted 

------------------- VATPercentage------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), null from Deleted 


------------------- TestFee -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestFee', cast(Deleted.TestFee as varchar(20)), null from Deleted 

------------------- ResultDataTypeID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultDataTypeID', Deleted.ResultDataTypeID, null from Deleted 

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted

------------------- TubeType -------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TubeType', Deleted.TubeType, null from Deleted 

------------------- TestDescription ----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestDescription', Deleted.TestDescription, null from Deleted 

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: LabRequestsIPD ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateLabRequestsIPD')
drop trigger utrUpdateLabRequestsIPD
go

create trigger utrUpdateLabRequestsIPD
on LabRequestsIPD
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'LabRequestsIPD' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-SpecimenNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecimenNo', Deleted.SpecimenNo, Inserted.SpecimenNo
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
end

-------------------  RoundNo  -----------------------------------------------------

if update(RoundNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.RoundNo <> Deleted.RoundNo
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: LabRequestsIPD ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteLabRequestsIPD')
drop trigger utrDeleteLabRequestsIPD
go

create trigger utrDeleteLabRequestsIPD
on LabRequestsIPD
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'LabRequestsIPD' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  SpecimenNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecimenNo', Deleted.SpecimenNo, null from Deleted

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted
go

----------------------------------------------------------------------------------------------------------------------------
------------- Update: LabResults -------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateLabResults')
drop trigger utrUpdateLabResults
go

create trigger utrUpdateLabResults
on LabResults
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'LabResults' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-SpecimenNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecimenNo', Deleted.SpecimenNo, Inserted.SpecimenNo
from Inserted inner join Deleted 
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
end

------------------- Key-TestCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestCode', Deleted.TestCode, Inserted.TestCode
from Inserted inner join Deleted 
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
end

------------------- TestDateTime -----------------------------------------------------

if update(TestDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestDateTime', dbo.FormatDateTime(Deleted.TestDateTime), dbo.FormatDateTime(Inserted.TestDateTime)
from Inserted inner join Deleted 
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.TestDateTime <> Deleted.TestDateTime
end

------------------- Result -----------------------------------------------------

if update(Result)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Result', Deleted.Result, Inserted.Result
from Inserted inner join Deleted 
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.Result <> Deleted.Result
end

-------------------  UnitMeasure  -----------------------------------------------------

if update(UnitMeasure)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, Inserted.UnitMeasure
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.UnitMeasure <> Deleted.UnitMeasure
end

-------------------  NormalRange  -----------------------------------------------------

if update(NormalRange)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NormalRange', Deleted.NormalRange, Inserted.NormalRange
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.NormalRange <> Deleted.NormalRange
end

-------------------  ResultFlagID  -----------------------------------------------------

if update(ResultFlagID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultFlagID', Deleted.ResultFlagID, Inserted.ResultFlagID
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.ResultFlagID <> Deleted.ResultFlagID
end

------------------- Report -----------------------------------------------------

if update(Report)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, Inserted.Report
from Inserted inner join Deleted 
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.Report <> Deleted.Report
end

------------------- LabTechnologist -----------------------------------------------------

if update(LabTechnologist)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LabTechnologist', Deleted.LabTechnologist, Inserted.LabTechnologist
from Inserted inner join Deleted 
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.LabTechnologist <> Deleted.LabTechnologist
end

-------------------  EntryModeID  -----------------------------------------------------

if update(EntryModeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EntryModeID', Deleted.EntryModeID, Inserted.EntryModeID
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.EntryModeID <> Deleted.EntryModeID
end

-------------------  ApprovedStatusID  -----------------------------------------------------

if update(ApprovedStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovedStatusID', Deleted.ApprovedStatusID, Inserted.ApprovedStatusID
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.ApprovedStatusID <> Deleted.ApprovedStatusID
end
------------------- LoginID -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted 
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.LoginID <> Deleted.LoginID
end

go

----------------------------------------------------------------------------------------------------------------------------
------------- Delete: LabResults -------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteLabResults')
drop trigger utrDeleteLabResults
go

create trigger utrDeleteLabResults
on LabResults
for  delete
as

declare @ErrorMSG varchar(200)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Deletes ----------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return

set @Identity = ident_current('AuditTrail') 
if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'LabResults' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- SpecimenNo -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecimenNo', Deleted.SpecimenNo, null from Deleted 

------------------- TestCode ---------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestCode', Deleted.TestCode, null from Deleted 

------------------- TestDateTime ----------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestDateTime', dbo.FormatDateTime(Deleted.TestDateTime), null from Deleted 

------------------- Result -------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Result', Deleted.Result, null from Deleted 

-------------------  UnitMeasure  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, null from Deleted

-------------------  NormalRange  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NormalRange', Deleted.NormalRange, null from Deleted

-------------------  ResultFlagID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultFlagID', Deleted.ResultFlagID, null from Deleted

------------------- Report -------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, null from Deleted 

------------------- LabTechnologist -------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LabTechnologist', Deleted.LabTechnologist, null from Deleted 

-------------------  EntryModeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EntryModeID', Deleted.EntryModeID, null from Deleted

-------------------  ApprovedStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovedStatusID', Deleted.ApprovedStatusID, null from Deleted

------------------- LoginID --------------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted 

------------------- RecordDateTime --------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted 

go

------------------------------------------------------------------------------------------------------
-------------- Update: LabResultsEXT -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateLabResultsEXT')
drop trigger utrUpdateLabResultsEXT
go

create trigger utrUpdateLabResultsEXT
on LabResultsEXT
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'LabResultsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-SpecimenNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecimenNo', Deleted.SpecimenNo, Inserted.SpecimenNo
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
end

------------------- Key-TestCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestCode', Deleted.TestCode, Inserted.TestCode
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
end

------------------- Key-SubTestCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SubTestCode', Deleted.SubTestCode, Inserted.SubTestCode
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
end

-------------------  Result  -----------------------------------------------------

if update(Result)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Result', Deleted.Result, Inserted.Result
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
and Inserted.Result <> Deleted.Result
end

-------------------  UnitMeasure  -----------------------------------------------------

if update(UnitMeasure)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, Inserted.UnitMeasure
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
and Inserted.UnitMeasure <> Deleted.UnitMeasure
end

-------------------  NormalRange  -----------------------------------------------------

if update(NormalRange)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NormalRange', Deleted.NormalRange, Inserted.NormalRange
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
and Inserted.NormalRange <> Deleted.NormalRange
end

-------------------  ResultFlagID  -----------------------------------------------------

if update(ResultFlagID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultFlagID', Deleted.ResultFlagID, Inserted.ResultFlagID
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
and Inserted.ResultFlagID <> Deleted.ResultFlagID
end

-------------------  Report  -----------------------------------------------------

if update(Report)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, Inserted.Report
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
and Inserted.Report <> Deleted.Report
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: LabResultsEXT -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteLabResultsEXT')
drop trigger utrDeleteLabResultsEXT
go

create trigger utrDeleteLabResultsEXT
on LabResultsEXT
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'LabResultsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  SpecimenNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecimenNo', Deleted.SpecimenNo, null from Deleted

-------------------  TestCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestCode', Deleted.TestCode, null from Deleted

-------------------  SubTestCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SubTestCode', Deleted.SubTestCode, null from Deleted

-------------------  Result  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Result', Deleted.Result, null from Deleted

-------------------  UnitMeasure  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, null from Deleted

-------------------  NormalRange  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NormalRange', Deleted.NormalRange, null from Deleted

-------------------  ResultFlagID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultFlagID', Deleted.ResultFlagID, null from Deleted

-------------------  Report  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, null from Deleted
go





------------------------------------------------------------------------------------------------------
-------------- Update: RadiologyExaminations ---------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRadiologyExaminations')
drop trigger utrUpdateRadiologyExaminations
go

create trigger utrUpdateRadiologyExaminations
on RadiologyExaminations
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'RadiologyExaminations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ExamCode --------------------------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamCode', Deleted.ExamCode, Inserted.ExamCode
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
end

-------------------  ExamName  -----------------------------------------------------

if update(ExamName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamName', Deleted.ExamName, Inserted.ExamName
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.ExamName <> Deleted.ExamName
end

-------------------  RadiologyCategoriesID  -----------------------------------------------------

if update(RadiologyCategoriesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RadiologyCategoriesID', Deleted.RadiologyCategoriesID, Inserted.RadiologyCategoriesID
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.RadiologyCategoriesID <> Deleted.RadiologyCategoriesID
end

-------------------  RadiologySiteID  -----------------------------------------------------

if update(RadiologySiteID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RadiologySiteID', Deleted.RadiologySiteID, Inserted.RadiologySiteID
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.RadiologySiteID <> Deleted.RadiologySiteID
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: RadiologyExaminations ---------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRadiologyExaminations')
drop trigger utrDeleteRadiologyExaminations
go

create trigger utrDeleteRadiologyExaminations
on RadiologyExaminations
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'R')

if exists (select ItemCode from Items 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'RadiologyExaminations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ExamCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamCode', Deleted.ExamCode, null from Deleted

-------------------  ExamName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamName', Deleted.ExamName, null from Deleted

-------------------  RadiologyCategoriesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RadiologyCategoriesID', Deleted.RadiologyCategoriesID, null from Deleted

-------------------  RadiologySiteID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RadiologySiteID', Deleted.RadiologySiteID, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: PathologyExaminations ---------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePathologyExaminations')
drop trigger utrUpdatePathologyExaminations
go

create trigger utrUpdatePathologyExaminations
on PathologyExaminations
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PathologyExaminations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ExamCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamCode', Deleted.ExamCode, Inserted.ExamCode
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
end

-------------------  ExamName  -----------------------------------------------------

if update(ExamName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamName', Deleted.ExamName, Inserted.ExamName
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.ExamName <> Deleted.ExamName
end

-------------------  PathologyCategoriesID  -----------------------------------------------------

if update(PathologyCategoriesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PathologyCategoriesID', Deleted.PathologyCategoriesID, Inserted.PathologyCategoriesID
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.PathologyCategoriesID <> Deleted.PathologyCategoriesID
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.Hidden <> Deleted.Hidden
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: PathologyExaminations ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePathologyExaminations')
drop trigger utrDeletePathologyExaminations
go

create trigger utrDeletePathologyExaminations
on PathologyExaminations
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'L')

if exists (select ItemCode from Items 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PathologyExaminations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ExamCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamCode', Deleted.ExamCode, null from Deleted

-------------------  ExamName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamName', Deleted.ExamName, null from Deleted

-------------------  PathologyCategoriesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PathologyCategoriesID', Deleted.PathologyCategoriesID, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: PathologyReports ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePathologyReports')
drop trigger utrUpdatePathologyReports
go

create trigger utrUpdatePathologyReports
on PathologyReports
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PathologyReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ReportTypeID  -----------------------------------------------------

if update(ReportTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReportTypeID', Deleted.ReportTypeID, Inserted.ReportTypeID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ReportTypeID <> Deleted.ReportTypeID
end

-------------------  ExamDateTime  -----------------------------------------------------

if update(ExamDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamDateTime', dbo.FormatDate(Deleted.ExamDateTime), dbo.FormatDate(Inserted.ExamDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ExamDateTime <> Deleted.ExamDateTime
end

-------------------  Indication  -----------------------------------------------------

if update(Indication)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Indication', Deleted.Indication, Inserted.Indication
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Indication <> Deleted.Indication
end

-------------------  Diagnosis  -----------------------------------------------------

if update(Diagnosis)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Diagnosis', Deleted.Diagnosis, Inserted.Diagnosis
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Diagnosis <> Deleted.Diagnosis
end

-------------------  Pathologist  -----------------------------------------------------

if update(Pathologist)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pathologist', Deleted.Pathologist, Inserted.Pathologist
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Pathologist <> Deleted.Pathologist
end

-------------------  PathologyTitleID  -----------------------------------------------------

if update(PathologyTitleID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PathologyTitleID', Deleted.PathologyTitleID, Inserted.PathologyTitleID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.PathologyTitleID <> Deleted.PathologyTitleID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PathologyReports ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePathologyReports')
drop trigger utrDeletePathologyReports
go

create trigger utrDeletePathologyReports
on PathologyReports
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PathologyReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ReportTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReportTypeID', Deleted.ReportTypeID, null from Deleted

-------------------  ExamDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamDateTime', dbo.FormatDate(Deleted.ExamDateTime), null from Deleted

-------------------  Indication  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Indication', Deleted.Indication, null from Deleted

-------------------  Diagnosis  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Diagnosis', Deleted.Diagnosis, null from Deleted

-------------------  Pathologist  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pathologist', Deleted.Pathologist, null from Deleted

-------------------  PathologyTitleID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PathologyTitleID', Deleted.PathologyTitleID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: PathologyImages ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePathologyImages')
drop trigger utrUpdatePathologyImages
go

create trigger utrUpdatePathologyImages
on PathologyImages
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PathologyImages' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ImageName = Deleted.ImageName
end

------------------- Key-ImageName -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ImageName', Deleted.ImageName, Inserted.ImageName
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ImageName = Deleted.ImageName
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ImageName = Deleted.ImageName
and Inserted.LoginID <> Deleted.LoginID
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PathologyImages ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePathologyImages')
drop trigger utrDeletePathologyImages
go

create trigger utrDeletePathologyImages
on PathologyImages
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PathologyImages' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ImageName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ImageName', Deleted.ImageName, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: RadiologyReports --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRadiologyReports')
drop trigger utrUpdateRadiologyReports
go

create trigger utrUpdateRadiologyReports
on RadiologyReports
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'RadiologyReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ExamDateTime  -----------------------------------------------------

if update(ExamDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamDateTime', dbo.FormatDate(Deleted.ExamDateTime), dbo.FormatDate(Inserted.ExamDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ExamDateTime <> Deleted.ExamDateTime
end

-------------------  Indication  -----------------------------------------------------

if update(Indication)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Indication', Deleted.Indication, Inserted.Indication
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Indication <> Deleted.Indication
end


-------------------  Report  -----------------------------------------------------

if update(Report)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, Inserted.Report
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Report <> Deleted.Report
end

-------------------  Conclusion  -----------------------------------------------------

if update(Conclusion)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Conclusion', Deleted.Conclusion, Inserted.Conclusion
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Conclusion <> Deleted.Conclusion
end

-------------------  Radiologist  -----------------------------------------------------

if update(Radiologist)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Radiologist', Deleted.Radiologist, Inserted.Radiologist
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Radiologist <> Deleted.Radiologist
end

-------------------  RadiologyTitleID  -----------------------------------------------------

if update(RadiologyTitleID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RadiologyTitleID', Deleted.RadiologyTitleID, Inserted.RadiologyTitleID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RadiologyTitleID <> Deleted.RadiologyTitleID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: RadiologyReports --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRadiologyReports')
drop trigger utrDeleteRadiologyReports
go

create trigger utrDeleteRadiologyReports
on RadiologyReports
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'RadiologyReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ExamDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamDateTime', dbo.FormatDate(Deleted.ExamDateTime), null from Deleted

-------------------  Indication  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Indication', Deleted.Indication, null from Deleted

-------------------  Report  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, null from Deleted

-------------------  Conclusion  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Conclusion', Deleted.Conclusion, null from Deleted

-------------------  Radiologist  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Radiologist', Deleted.Radiologist, null from Deleted

-------------------  RadiologyTitleID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RadiologyTitleID', Deleted.RadiologyTitleID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: IPDRadiologyReports -----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDRadiologyReports')
drop trigger utrUpdateIPDRadiologyReports
go

create trigger utrUpdateIPDRadiologyReports
on IPDRadiologyReports
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDRadiologyReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-RoundNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ExamDateTime  -----------------------------------------------------

if update(ExamDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamDateTime', dbo.FormatDate(Deleted.ExamDateTime), dbo.FormatDate(Inserted.ExamDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ExamDateTime <> Deleted.ExamDateTime
end

-------------------  Indication  -----------------------------------------------------

if update(Indication)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Indication', Deleted.Indication, Inserted.Indication
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Indication <> Deleted.Indication
end

-------------------  Report  -----------------------------------------------------

if update(Report)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, Inserted.Report
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Report <> Deleted.Report
end

-------------------  Conclusion  -----------------------------------------------------

if update(Conclusion)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Conclusion', Deleted.Conclusion, Inserted.Conclusion
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Conclusion <> Deleted.Conclusion
end

-------------------  Radiologist  -----------------------------------------------------

if update(Radiologist)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Radiologist', Deleted.Radiologist, Inserted.Radiologist
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Radiologist <> Deleted.Radiologist
end

-------------------  RadiologyTitleID  -----------------------------------------------------

if update(RadiologyTitleID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RadiologyTitleID', Deleted.RadiologyTitleID, Inserted.RadiologyTitleID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RadiologyTitleID <> Deleted.RadiologyTitleID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: IPDRadiologyReports -----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDRadiologyReports')
drop trigger utrDeleteIPDRadiologyReports
go

create trigger utrDeleteIPDRadiologyReports
on IPDRadiologyReports
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDRadiologyReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ExamDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamDateTime', dbo.FormatDate(Deleted.ExamDateTime), null from Deleted

-------------------  Indication  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Indication', Deleted.Indication, null from Deleted

-------------------  Report  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, null from Deleted

-------------------  Conclusion  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Conclusion', Deleted.Conclusion, null from Deleted

-------------------  Radiologist  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Radiologist', Deleted.Radiologist, null from Deleted

-------------------  RadiologyTitleID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RadiologyTitleID', Deleted.RadiologyTitleID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: DentalReports -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateDentalReports')
drop trigger utrUpdateDentalReports
go

create trigger utrUpdateDentalReports
on DentalReports
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'DentalReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ReportDate  -----------------------------------------------------

if update(ReportDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReportDate', dbo.FormatDate(Deleted.ReportDate), dbo.FormatDate(Inserted.ReportDate)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ReportDate <> Deleted.ReportDate
end

-------------------  Report  -----------------------------------------------------

if update(Report)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, Inserted.Report
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Report <> Deleted.Report
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: DentalReports -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteDentalReports')
drop trigger utrDeleteDentalReports
go

create trigger utrDeleteDentalReports
on DentalReports
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'DentalReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ReportDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReportDate', dbo.FormatDate(Deleted.ReportDate), null from Deleted

-------------------  Report  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: IPDDentalReports --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDDentalReports')
drop trigger utrUpdateIPDDentalReports
go

create trigger utrUpdateIPDDentalReports
on IPDDentalReports
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDDentalReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-RoundNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ReportDate  -----------------------------------------------------

if update(ReportDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReportDate', dbo.FormatDate(Deleted.ReportDate), dbo.FormatDate(Inserted.ReportDate)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ReportDate <> Deleted.ReportDate
end

-------------------  Report  -----------------------------------------------------

if update(Report)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, Inserted.Report
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Report <> Deleted.Report
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: IPDDentalReports --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDDentalReports')
drop trigger utrDeleteIPDDentalReports
go

create trigger utrDeleteIPDDentalReports
on IPDDentalReports
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDDentalReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ReportDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReportDate', dbo.FormatDate(Deleted.ReportDate), null from Deleted

-------------------  Report  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: TheatreOperations -------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateTheatreOperations')
drop trigger utrUpdateTheatreOperations
go

create trigger utrUpdateTheatreOperations
on TheatreOperations
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'TheatreOperations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  OperationDateTime  -----------------------------------------------------

if update(OperationDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OperationDateTime', dbo.FormatDate(Deleted.OperationDateTime), dbo.FormatDate(Inserted.OperationDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OperationDateTime <> Deleted.OperationDateTime
end

-------------------  LeadSurgeon  -----------------------------------------------------

if update(LeadSurgeon)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeadSurgeon', Deleted.LeadSurgeon, Inserted.LeadSurgeon
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeadSurgeon <> Deleted.LeadSurgeon
end

-------------------  OtherSurgeon  -----------------------------------------------------

if update(OtherSurgeon)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherSurgeon', Deleted.OtherSurgeon, Inserted.OtherSurgeon
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OtherSurgeon <> Deleted.OtherSurgeon
end

-------------------  LeadAnaesthetist  -----------------------------------------------------

if update(LeadAnaesthetist)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeadAnaesthetist', Deleted.LeadAnaesthetist, Inserted.LeadAnaesthetist
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeadAnaesthetist <> Deleted.LeadAnaesthetist
end

-------------------  OtherAnaesthetist  -----------------------------------------------------

if update(OtherAnaesthetist)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherAnaesthetist', Deleted.OtherAnaesthetist, Inserted.OtherAnaesthetist
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OtherAnaesthetist <> Deleted.OtherAnaesthetist
end

-------------------  LeadNurse  -----------------------------------------------------

if update(LeadNurse)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeadNurse', Deleted.LeadNurse, Inserted.LeadNurse
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeadNurse <> Deleted.LeadNurse
end

-------------------  OtherNurse  -----------------------------------------------------

if update(OtherNurse)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherNurse', Deleted.OtherNurse, Inserted.OtherNurse
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OtherNurse <> Deleted.OtherNurse
end

-------------------  AnaesthesiaTypeID  -----------------------------------------------------

if update(AnaesthesiaTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AnaesthesiaTypeID', Deleted.AnaesthesiaTypeID, Inserted.AnaesthesiaTypeID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.AnaesthesiaTypeID <> Deleted.AnaesthesiaTypeID
end

-------------------  OperationClassID  -----------------------------------------------------

if update(OperationClassID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OperationClassID', Deleted.OperationClassID, Inserted.OperationClassID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OperationClassID <> Deleted.OperationClassID
end

-------------------  PreoperativeDiagnosis  -----------------------------------------------------

if update(PreoperativeDiagnosis)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreoperativeDiagnosis', Deleted.PreoperativeDiagnosis, Inserted.PreoperativeDiagnosis
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PreoperativeDiagnosis <> Deleted.PreoperativeDiagnosis
end

-------------------  PlannedProcedures  -----------------------------------------------------

if update(PlannedProcedures)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PlannedProcedures', Deleted.PlannedProcedures, Inserted.PlannedProcedures
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PlannedProcedures <> Deleted.PlannedProcedures
end

-------------------  Report  -----------------------------------------------------

if update(Report)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, Inserted.Report
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Report <> Deleted.Report
end

-------------------  PostoperativeInstructions  -----------------------------------------------------

if update(PostoperativeInstructions)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PostoperativeInstructions', Deleted.PostoperativeInstructions, Inserted.PostoperativeInstructions
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PostoperativeInstructions <> Deleted.PostoperativeInstructions
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: TheatreOperations -------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteTheatreOperations')
drop trigger utrDeleteTheatreOperations
go

create trigger utrDeleteTheatreOperations
on TheatreOperations
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'TheatreOperations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  OperationDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OperationDateTime', dbo.FormatDate(Deleted.OperationDateTime), null from Deleted

-------------------  LeadSurgeon  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeadSurgeon', Deleted.LeadSurgeon, null from Deleted

-------------------  OtherSurgeon  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherSurgeon', Deleted.OtherSurgeon, null from Deleted

-------------------  LeadAnaesthetist  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeadAnaesthetist', Deleted.LeadAnaesthetist, null from Deleted

-------------------  OtherAnaesthetist  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherAnaesthetist', Deleted.OtherAnaesthetist, null from Deleted

-------------------  LeadNurse  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeadNurse', Deleted.LeadNurse, null from Deleted

-------------------  OtherNurse  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherNurse', Deleted.OtherNurse, null from Deleted

-------------------  AnaesthesiaTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AnaesthesiaTypeID', Deleted.AnaesthesiaTypeID, null from Deleted

-------------------  OperationClassID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OperationClassID', Deleted.OperationClassID, null from Deleted

-------------------  PreoperativeDiagnosis  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreoperativeDiagnosis', Deleted.PreoperativeDiagnosis, null from Deleted

-------------------  PlannedProcedures  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PlannedProcedures', Deleted.PlannedProcedures, null from Deleted

-------------------  Report  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, null from Deleted

-------------------  PostoperativeInstructions  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PostoperativeInstructions', Deleted.PostoperativeInstructions, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: IPDTheatreOperations ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDTheatreOperations')
drop trigger utrUpdateIPDTheatreOperations
go

create trigger utrUpdateIPDTheatreOperations
on IPDTheatreOperations
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDTheatreOperations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-RoundNo ------------------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
end

-------------------  OperationDateTime  -----------------------------------------------------

if update(OperationDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OperationDateTime', dbo.FormatDate(Deleted.OperationDateTime), dbo.FormatDate(Inserted.OperationDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.OperationDateTime <> Deleted.OperationDateTime
end

-------------------  LeadSurgeon  -----------------------------------------------------

if update(LeadSurgeon)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeadSurgeon', Deleted.LeadSurgeon, Inserted.LeadSurgeon
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeadSurgeon <> Deleted.LeadSurgeon
end

-------------------  OtherSurgeon  -----------------------------------------------------

if update(OtherSurgeon)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherSurgeon', Deleted.OtherSurgeon, Inserted.OtherSurgeon
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.OtherSurgeon <> Deleted.OtherSurgeon
end

-------------------  LeadAnaesthetist  -----------------------------------------------------

if update(LeadAnaesthetist)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeadAnaesthetist', Deleted.LeadAnaesthetist, Inserted.LeadAnaesthetist
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeadAnaesthetist <> Deleted.LeadAnaesthetist
end

-------------------  OtherAnaesthetist  -----------------------------------------------------

if update(OtherAnaesthetist)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherAnaesthetist', Deleted.OtherAnaesthetist, Inserted.OtherAnaesthetist
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.OtherAnaesthetist <> Deleted.OtherAnaesthetist
end

-------------------  LeadNurse  -----------------------------------------------------

if update(LeadNurse)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeadNurse', Deleted.LeadNurse, Inserted.LeadNurse
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeadNurse <> Deleted.LeadNurse
end

-------------------  OtherNurse  -----------------------------------------------------

if update(OtherNurse)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherNurse', Deleted.OtherNurse, Inserted.OtherNurse
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.OtherNurse <> Deleted.OtherNurse
end

-------------------  AnaesthesiaTypeID  -----------------------------------------------------

if update(AnaesthesiaTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AnaesthesiaTypeID', Deleted.AnaesthesiaTypeID, Inserted.AnaesthesiaTypeID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.AnaesthesiaTypeID <> Deleted.AnaesthesiaTypeID
end

-------------------  OperationClassID  -----------------------------------------------------

if update(OperationClassID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OperationClassID', Deleted.OperationClassID, Inserted.OperationClassID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.OperationClassID <> Deleted.OperationClassID
end

-------------------  PreoperativeDiagnosis  -----------------------------------------------------

if update(PreoperativeDiagnosis)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreoperativeDiagnosis', Deleted.PreoperativeDiagnosis, Inserted.PreoperativeDiagnosis
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.PreoperativeDiagnosis <> Deleted.PreoperativeDiagnosis
end

-------------------  PlannedProcedures  -----------------------------------------------------

if update(PlannedProcedures)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PlannedProcedures', Deleted.PlannedProcedures, Inserted.PlannedProcedures
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.PlannedProcedures <> Deleted.PlannedProcedures
end

-------------------  Report  -----------------------------------------------------

if update(Report)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, Inserted.Report
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.Report <> Deleted.Report
end

-------------------  PostoperativeInstructions  -----------------------------------------------------

if update(PostoperativeInstructions)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PostoperativeInstructions', Deleted.PostoperativeInstructions, Inserted.PostoperativeInstructions
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.PostoperativeInstructions <> Deleted.PostoperativeInstructions
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: IPDTheatreOperations ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDTheatreOperations')
drop trigger utrDeleteIPDTheatreOperations
go

create trigger utrDeleteIPDTheatreOperations
on IPDTheatreOperations
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDTheatreOperations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  OperationDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OperationDateTime', dbo.FormatDate(Deleted.OperationDateTime), null from Deleted

-------------------  LeadSurgeon  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeadSurgeon', Deleted.LeadSurgeon, null from Deleted

-------------------  OtherSurgeon  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherSurgeon', Deleted.OtherSurgeon, null from Deleted

-------------------  LeadAnaesthetist  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeadAnaesthetist', Deleted.LeadAnaesthetist, null from Deleted

-------------------  OtherAnaesthetist  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherAnaesthetist', Deleted.OtherAnaesthetist, null from Deleted

-------------------  LeadNurse  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeadNurse', Deleted.LeadNurse, null from Deleted

-------------------  OtherNurse  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherNurse', Deleted.OtherNurse, null from Deleted

-------------------  AnaesthesiaTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AnaesthesiaTypeID', Deleted.AnaesthesiaTypeID, null from Deleted

-------------------  OperationClassID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OperationClassID', Deleted.OperationClassID, null from Deleted

-------------------  PreoperativeDiagnosis  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreoperativeDiagnosis', Deleted.PreoperativeDiagnosis, null from Deleted

-------------------  PlannedProcedures  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PlannedProcedures', Deleted.PlannedProcedures, null from Deleted

-------------------  Report  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, null from Deleted

-------------------  PostoperativeInstructions  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PostoperativeInstructions', Deleted.PostoperativeInstructions, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ExtraChargeItems --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateExtraChargeItems')
drop trigger utrUpdateExtraChargeItems
go

create trigger utrUpdateExtraChargeItems
on ExtraChargeItems
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ExtraChargeItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ExtraItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraItemCode', Deleted.ExtraItemCode, Inserted.ExtraItemCode
from Inserted inner join Deleted
on Inserted.ExtraItemCode = Deleted.ExtraItemCode
end

-------------------  ExtraItemName  -----------------------------------------------------

if update(ExtraItemName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraItemName', Deleted.ExtraItemName, Inserted.ExtraItemName
from Inserted inner join Deleted
on Inserted.ExtraItemCode = Deleted.ExtraItemCode
and Inserted.ExtraItemName <> Deleted.ExtraItemName
end

-------------------  ExtraChargeCategoryID  -----------------------------------------------------

if update(ExtraChargeCategoryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraChargeCategoryID', Deleted.ExtraChargeCategoryID, Inserted.ExtraChargeCategoryID
from Inserted inner join Deleted
on Inserted.ExtraItemCode = Deleted.ExtraItemCode
and Inserted.ExtraChargeCategoryID <> Deleted.ExtraChargeCategoryID
end

-------------------  UnitCost  -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
from Inserted inner join Deleted
on Inserted.ExtraItemCode = Deleted.ExtraItemCode
and Inserted.UnitCost <> Deleted.UnitCost
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.ExtraItemCode = Deleted.ExtraItemCode
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.ExtraItemCode = Deleted.ExtraItemCode
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ExtraChargeItems --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteExtraChargeItems')
drop trigger utrDeleteExtraChargeItems
go

create trigger utrDeleteExtraChargeItems
on ExtraChargeItems
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return
-----------------------------------------------------------------------------------------------------------------------

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'E')

if exists (select ExtraItemCode from Deleted where ExtraItemCode = 'RTN')
begin
set @ErrorMSG = 'RETURN item can''t be deleted!'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if exists (select ExtraItemCode from Deleted where ExtraItemCode = 'CPV')
begin
set @ErrorMSG = 'CO-PAY VALUE item can''t be deleted!'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if exists (select ItemCode from Items 
where (ItemCode in (select ExtraItemCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select ExtraItemCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select ExtraItemCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select ExtraItemCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select ExtraItemCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ExtraChargeItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ExtraItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraItemCode', Deleted.ExtraItemCode, null from Deleted

-------------------  ExtraItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraItemName', Deleted.ExtraItemName, null from Deleted

-------------------  ExtraChargeCategoryID  ---------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraChargeCategoryID', Deleted.ExtraChargeCategoryID, null from Deleted

-------------------  UnitCost  ----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted
go

----------------------------------------------------------------------------------------------------------------------------
------------- Update: Appointments ------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAppointments')
drop trigger utrUpdateAppointments
go

create trigger utrUpdateAppointments
on Appointments
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Appointments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-PatientNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartDate = Deleted.StartDate
end

------------------- Key-StartDate -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartDate', Deleted.StartDate, Inserted.StartDate
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartDate = Deleted.StartDate
end

------------------- AppointmentPrecisionID -----------------------------------------------------

if update(AppointmentPrecisionID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AppointmentPrecisionID', Deleted.AppointmentPrecisionID, Inserted.AppointmentPrecisionID
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartDate = Deleted.StartDate
and Inserted.AppointmentPrecisionID <> Deleted.AppointmentPrecisionID
end

------------------- StartTime -----------------------------------------------------

if update(StartTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartTime', Deleted.StartTime, Inserted.StartTime
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartDate = Deleted.StartDate
and Inserted.StartTime <> Deleted.StartTime
end

------------------- Duration -----------------------------------------------------

if update(Duration)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Duration', cast(Deleted.Duration as varchar(20)), Inserted.Duration
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartDate = Deleted.StartDate
and Inserted.Duration <> Deleted.Duration
end

------------------- EndDate -----------------------------------------------------

if update(EndDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EndDate', dbo.FormatDate(Deleted.EndDate), dbo.FormatDate(Inserted.EndDate)
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartDate = Deleted.StartDate
and Inserted.EndDate <> Deleted.EndDate
end

------------------- DoctorSpecialtyID -----------------------------------------------------

if update(DoctorSpecialtyID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, Inserted.DoctorSpecialtyID
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.DoctorSpecialtyID <> Deleted.DoctorSpecialtyID
end

------------------- StaffNo -----------------------------------------------------

if update(StaffNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartDate = Deleted.StartDate
and Inserted.StaffNo <> Deleted.StaffNo
end

------------------- AppointmentCategoryID -----------------------------------------------------

if update(AppointmentCategoryID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AppointmentCategoryID', Deleted.AppointmentCategoryID, Inserted.AppointmentCategoryID
	from Inserted inner join Deleted 
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.StartDate = Deleted.StartDate
	and Inserted.AppointmentCategoryID <> Deleted.AppointmentCategoryID
end

------------------- CommunityID -----------------------------------------------------

if update(CommunityID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CommunityID', Deleted.CommunityID, Inserted.CommunityID
	from Inserted inner join Deleted 
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.CommunityID <> Deleted.CommunityID
end

------------------- AppointmentDes -----------------------------------------------------

if update(AppointmentDes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AppointmentDes', Deleted.AppointmentDes, Inserted.AppointmentDes
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartDate = Deleted.StartDate
and Inserted.AppointmentDes <> Deleted.AppointmentDes
end

------------------- AppointmentStatusID -----------------------------------------------------

if update(AppointmentStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AppointmentStatusID', Deleted.AppointmentStatusID, Inserted.AppointmentStatusID
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartDate = Deleted.StartDate
and Inserted.AppointmentStatusID <> Deleted.AppointmentStatusID
end

------------------- LoginID -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartDate = Deleted.StartDate
and Inserted.LoginID <> Deleted.LoginID
end

go

----------------------------------------------------------------------------------------------------------------------------
------------- Delete: Appointments -----------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAppointments')
drop trigger utrDeleteAppointments
go

create trigger utrDeleteAppointments
on Appointments
for  delete
as

declare @ErrorMSG varchar(200)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Deletes ----------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return

set @Identity = ident_current('AuditTrail') 
if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Appointments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- PatientNo ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted 

------------------- StartDate ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartDate', dbo.FormatDate(Deleted.StartDate), null from Deleted 

------------------- AppointmentPrecisionID --------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AppointmentPrecisionID', Deleted.AppointmentPrecisionID, null from Deleted 

------------------- StartTime ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartTime', Deleted.StartTime, null from Deleted 

------------------- Duration ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Duration', cast(Deleted.Duration as varchar(20)), null from Deleted 

------------------- EndDate ----------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EndDate', dbo.FormatDate(Deleted.EndDate), null from Deleted 

------------------- DoctorSpecialtyID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, null from Deleted 

------------------- StaffNo ----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted 

------------------- CommunityID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CommunityID', Deleted.CommunityID, null from Deleted 

------------------- AppointmentCategoryID ----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AppointmentCategoryID', Deleted.AppointmentCategoryID, null from Deleted 

------------------- AppointmentDes ----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AppointmentDes', Deleted.AppointmentDes, null from Deleted 

------------------- AppointmentStatusID ----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AppointmentStatusID', Deleted.AppointmentStatusID, null from Deleted 

------------------- LoginID --------------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted 

------------------- RecordDateTime --------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted 
go

------------------------------------------------------------------------------------------------------
-------------- Update: ExtraBills --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateExtraBills')
drop trigger utrUpdateExtraBills
go

create trigger utrUpdateExtraBills
on ExtraBills
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(ExtraBillID)
begin
set @ErrorMSG = 'You can''t update Extra Bill ID for Extra Bills, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ExtraBillNo)
begin
set @ErrorMSG = 'You can''t update Extra Bill No for Extra Bills, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ExtraBills' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ExtraBillNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, Inserted.ExtraBillNo
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
end

-------------------  ExtraBillID  -----------------------------------------------------

if update(ExtraBillID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillID', Deleted.ExtraBillID, Inserted.ExtraBillID
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ExtraBillID <> Deleted.ExtraBillID
end

-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.VisitNo <> Deleted.VisitNo
end

-------------------  ExtraBillDate  -----------------------------------------------------

if update(ExtraBillDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillDate', dbo.FormatDate(Deleted.ExtraBillDate), dbo.FormatDate(Inserted.ExtraBillDate)
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ExtraBillDate <> Deleted.ExtraBillDate
end

-------------------  StaffNo  -----------------------------------------------------

if update(StaffNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.StaffNo <> Deleted.StaffNo
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ExtraBills --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteExtraBills')
drop trigger utrDeleteExtraBills
go

create trigger utrDeleteExtraBills
on ExtraBills
for delete
as

declare @ErrorMSG varchar(200)
declare @PayTypeID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

-----------------------------------------------------------------------------------------------------------------------

set @PayTypeID = dbo.GetLookupDataID('PayType', 'EXT')

if exists (select PayNo from Payments 
where (PayNo in (select ExtraBillNo from Deleted) and PayTypeID = @PayTypeID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payments'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

-----------------------------------------------------------------------------------------------------------------------

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ExtraBills' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ExtraBillID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillID', Deleted.ExtraBillID, null from Deleted

-------------------  ExtraBillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ExtraBillDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillDate', dbo.FormatDate(Deleted.ExtraBillDate), null from Deleted

-------------------  StaffNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ExtraBillsEXT -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateExtraBillsEXT')
drop trigger utrUpdateExtraBillsEXT
go

create trigger utrUpdateExtraBillsEXT
on ExtraBillsEXT
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ExtraBillsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ExtraBillNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, Inserted.ExtraBillNo
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
end

-------------------  RoundNo  -----------------------------------------------------

if update(RoundNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.RoundNo <> Deleted.RoundNo
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ExtraBillsEXT -----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteExtraBillsEXT')
drop trigger utrDeleteExtraBillsEXT
go

create trigger utrDeleteExtraBillsEXT
on ExtraBillsEXT
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ExtraBillsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ExtraBillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, null from Deleted

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ExtraBillItems ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateExtraBillItems')
drop trigger utrUpdateExtraBillItems
go

create trigger utrUpdateExtraBillItems
on ExtraBillItems
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ExtraBillItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ExtraBillNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, Inserted.ExtraBillNo
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemName -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemName = Deleted.ItemName
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------- InvoiceNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, Inserted.InvoiceNo
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end



------------------- Key-UnitMeasure -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, Inserted.UnitMeasure
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.UnitMeasure = Deleted.UnitMeasure
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  UnitCost  -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.UnitCost <> Deleted.UnitCost
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  VATValue  -------------------------------------------------------------

if update(VATValue)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATValue', cast(Deleted.VATValue as varchar(20)), cast(Inserted.VATValue as varchar(20))
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.VATValue <> Deleted.VATValue
end

-------------------  Notes  -----------------------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Notes <> Deleted.Notes
end

-------------------  LastUpdate  -----------------------------------------------------

if update(LastUpdate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastUpdate', dbo.FormatDate(Deleted.LastUpdate), dbo.FormatDate(Inserted.LastUpdate)
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LastUpdate <> Deleted.LastUpdate
end

-------------------  PayStatusID  -----------------------------------------------------

if update(PayStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayStatusID', Deleted.PayStatusID, Inserted.PayStatusID
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.PayStatusID <> Deleted.PayStatusID
end

-------------------  EntryModeID  -----------------------------------------------------

if update(EntryModeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EntryModeID', Deleted.EntryModeID, Inserted.EntryModeID
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.EntryModeID <> Deleted.EntryModeID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
-------------------  CreatorLoginID  -----------------------------------------------------

if update(CreatorLoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CreatorLoginID', Deleted.CreatorLoginID, Inserted.CreatorLoginID
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CreatorLoginID <> Deleted.CreatorLoginID
end

-------------------  CreatorClientMachine  -----------------------------------------------------

if update(CreatorClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CreatorClientMachine', Deleted.CreatorClientMachine, Inserted.CreatorClientMachine
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CreatorClientMachine <> Deleted.CreatorClientMachine
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ExtraBillItems ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteExtraBillItems')
drop trigger utrDeleteExtraBillItems
go

create trigger utrDeleteExtraBillItems
on ExtraBillItems
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ExtraBillItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ExtraBillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  UnitCost  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  InvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, null from Deleted

-------------------  UnitMeasure  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, null from Deleted

-------------------  LastUpdate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastUpdate', dbo.FormatDate(Deleted.LastUpdate), null from Deleted

-------------------  PayStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayStatusID', Deleted.PayStatusID, null from Deleted

-------------------  EntryModeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EntryModeID', Deleted.EntryModeID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
-------------------  CreatorLoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CreatorLoginID', Deleted.CreatorLoginID, null from Deleted

-------------------  CreatorClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CreatorClientMachine', Deleted.CreatorClientMachine, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ExtraBillItemsCASH ------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateExtraBillItemsCASH')
drop trigger utrUpdateExtraBillItemsCASH
go

create trigger utrUpdateExtraBillItemsCASH
on ExtraBillItemsCASH
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ExtraBillItemsCASH' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ExtraBillNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, Inserted.ExtraBillNo
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  InvoiceNo  -----------------------------------------------------

if update(InvoiceNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'InvoiceNo', Deleted.InvoiceNo, Inserted.InvoiceNo
	from Inserted inner join Deleted
	on Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.InvoiceNo <> Deleted.InvoiceNo
end

-------------------  CashAmount  -----------------------------------------------------

if update(CashAmount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CashAmount', cast(Deleted.CashAmount as varchar(20)), cast(Inserted.CashAmount as varchar(20))
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CashAmount <> Deleted.CashAmount
end

-------------------  CashPayStatusID  -----------------------------------------------------

if update(CashPayStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CashPayStatusID', Deleted.CashPayStatusID, Inserted.CashPayStatusID
from Inserted inner join Deleted
on Inserted.ExtraBillNo = Deleted.ExtraBillNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CashPayStatusID <> Deleted.CashPayStatusID
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ExtraBillItemsCASH ------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteExtraBillItemsCASH')
drop trigger utrDeleteExtraBillItemsCASH
go

create trigger utrDeleteExtraBillItemsCASH
on ExtraBillItemsCASH
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ExtraBillItemsCASH' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ExtraBillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  InvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, null from Deleted

-------------------  CashAmount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CashAmount', cast(Deleted.CashAmount as varchar(20)), null from Deleted

-------------------  CashPayStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CashPayStatusID', Deleted.CashPayStatusID, null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: Claims ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateClaims')
drop trigger utrUpdateClaims
go

create trigger utrUpdateClaims
on Claims
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(ClaimID)
begin
set @ErrorMSG = 'You can''t update Claim ID for Claims, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ClaimNo)
begin
set @ErrorMSG = 'You can''t update Claim No for Claims, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Claims' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ClaimNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimNo', Deleted.ClaimNo, Inserted.ClaimNo
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
end

-------------------  MedicalCardNo  -----------------------------------------------------

if update(MedicalCardNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalCardNo', Deleted.MedicalCardNo, Inserted.MedicalCardNo
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.MedicalCardNo <> Deleted.MedicalCardNo
end

-------------------  PatientNo  -----------------------------------------------------

if update(PatientNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.PatientNo <> Deleted.PatientNo
end

-------------------  VisitDate  -----------------------------------------------------

if update(VisitDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitDate', dbo.FormatDate(Deleted.VisitDate), dbo.FormatDate(Inserted.VisitDate)
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.VisitDate <> Deleted.VisitDate
end

-------------------  VisitTime  -----------------------------------------------------

if update(VisitTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitTime', Deleted.VisitTime, Inserted.VisitTime
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.VisitTime <> Deleted.VisitTime
end

-------------------  HealthUnitCode  -----------------------------------------------------

if update(HealthUnitCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HealthUnitCode', Deleted.HealthUnitCode, Inserted.HealthUnitCode
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.HealthUnitCode <> Deleted.HealthUnitCode
end

-------------------  PrimaryDoctor  -----------------------------------------------------

if update(PrimaryDoctor)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PrimaryDoctor', Deleted.PrimaryDoctor, Inserted.PrimaryDoctor
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.PrimaryDoctor <> Deleted.PrimaryDoctor
end

-------------------  ClaimStatusID  -----------------------------------------------------

if update(ClaimStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimStatusID', Deleted.ClaimStatusID, Inserted.ClaimStatusID
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ClaimStatusID <> Deleted.ClaimStatusID
end

-------------------  ClaimEntryID  -----------------------------------------------------

if update(ClaimEntryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimEntryID', Deleted.ClaimEntryID, Inserted.ClaimEntryID
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ClaimEntryID <> Deleted.ClaimEntryID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: Claims ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteClaims')
drop trigger utrDeleteClaims
go

create trigger utrDeleteClaims
on Claims
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Claims' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ClaimNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimNo', Deleted.ClaimNo, null from Deleted

-------------------  MedicalCardNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalCardNo', Deleted.MedicalCardNo, null from Deleted

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  VisitDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitDate', dbo.FormatDate(Deleted.VisitDate), null from Deleted

-------------------  VisitTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitTime', Deleted.VisitTime, null from Deleted

-------------------  HealthUnitCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HealthUnitCode', Deleted.HealthUnitCode, null from Deleted

-------------------  PrimaryDoctor  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PrimaryDoctor', Deleted.PrimaryDoctor, null from Deleted

-------------------  ClaimStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimStatusID', Deleted.ClaimStatusID, null from Deleted

-------------------  ClaimEntryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimEntryID', Deleted.ClaimEntryID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ClaimsEXT ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateClaimsEXT')
drop trigger utrUpdateClaimsEXT
go

create trigger utrUpdateClaimsEXT
on ClaimsEXT
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ClaimsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ClaimNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimNo', Deleted.ClaimNo, Inserted.ClaimNo
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
end

-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.VisitNo <> Deleted.VisitNo
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ClaimsEXT ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteClaimsEXT')
drop trigger utrDeleteClaimsEXT
go

create trigger utrDeleteClaimsEXT
on ClaimsEXT
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ClaimsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ClaimNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimNo', Deleted.ClaimNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ClaimDiagnosis ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateClaimDiagnosis')
drop trigger utrUpdateClaimDiagnosis
go

create trigger utrUpdateClaimDiagnosis
on ClaimDiagnosis
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ClaimDiagnosis' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ClaimNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimNo', Deleted.ClaimNo, Inserted.ClaimNo
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.DiseaseCode = Deleted.DiseaseCode
end

------------------- Key-DiseaseCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseCode', Deleted.DiseaseCode, Inserted.DiseaseCode
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.DiseaseCode = Deleted.DiseaseCode
end

go

------------------------------------------------------------------------------------------------------
-------------- Delete: ClaimDiagnosis ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteClaimDiagnosis')
drop trigger utrDeleteClaimDiagnosis
go

create trigger utrDeleteClaimDiagnosis
on ClaimDiagnosis
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ClaimDiagnosis' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ClaimNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimNo', Deleted.ClaimNo, null from Deleted

-------------------  DiseaseCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseCode', Deleted.DiseaseCode, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ClaimDetails ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateClaimDetails')
drop trigger utrUpdateClaimDetails
go

create trigger utrUpdateClaimDetails
on ClaimDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ClaimDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ClaimNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimNo', Deleted.ClaimNo, Inserted.ClaimNo
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ItemName = Deleted.ItemName
end

------------------- Key-ItemName -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ItemName = Deleted.ItemName
end

-------------------  BenefitCode  -----------------------------------------------------

if update(BenefitCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BenefitCode', Deleted.BenefitCode, Inserted.BenefitCode
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ItemName = Deleted.ItemName
and Inserted.BenefitCode <> Deleted.BenefitCode
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ItemName = Deleted.ItemName
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ItemName = Deleted.ItemName
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  Adjustment  -----------------------------------------------------

if update(Adjustment)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Adjustment', cast(Deleted.Adjustment as varchar(20)), cast(Inserted.Adjustment as varchar(20))
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ItemName = Deleted.ItemName
and Inserted.Adjustment <> Deleted.Adjustment
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ItemName = Deleted.ItemName
and Inserted.Amount <> Deleted.Amount
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ItemName = Deleted.ItemName
and Inserted.Notes <> Deleted.Notes
end

-------------------  LimitAmount  -----------------------------------------------------

if update(LimitAmount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LimitAmount', cast(Deleted.LimitAmount as varchar(20)), cast(Inserted.LimitAmount as varchar(20))
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ItemName = Deleted.ItemName
and Inserted.LimitAmount <> Deleted.LimitAmount
end

-------------------  ConsumedAmount  -----------------------------------------------------

if update(ConsumedAmount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConsumedAmount', cast(Deleted.ConsumedAmount as varchar(20)), cast(Inserted.ConsumedAmount as varchar(20))
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ItemName = Deleted.ItemName
and Inserted.ConsumedAmount <> Deleted.ConsumedAmount
end

-------------------  LimitBalance  -----------------------------------------------------

if update(LimitBalance)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LimitBalance', cast(Deleted.LimitBalance as varchar(20)), cast(Inserted.LimitBalance as varchar(20))
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ItemName = Deleted.ItemName
and Inserted.LimitBalance <> Deleted.LimitBalance
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ClaimDetails ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteClaimDetails')
drop trigger utrDeleteClaimDetails
go

create trigger utrDeleteClaimDetails
on ClaimDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ClaimDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ClaimNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimNo', Deleted.ClaimNo, null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  BenefitCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BenefitCode', Deleted.BenefitCode, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  Adjustment  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Adjustment', cast(Deleted.Adjustment as varchar(20)), null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LimitAmount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LimitAmount', cast(Deleted.LimitAmount as varchar(20)), null from Deleted

-------------------  ConsumedAmount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConsumedAmount', cast(Deleted.ConsumedAmount as varchar(20)), null from Deleted

-------------------  LimitBalance  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LimitBalance', cast(Deleted.LimitBalance as varchar(20)), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Allergies ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAllergies')
drop trigger utrUpdateAllergies
go

create trigger utrUpdateAllergies
on Allergies
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Allergies' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-AllergyNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AllergyNo', Deleted.AllergyNo, Inserted.AllergyNo
from Inserted inner join Deleted
on Inserted.AllergyNo = Deleted.AllergyNo
end

-------------------  AllergyName  -----------------------------------------------------

if update(AllergyName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AllergyName', Deleted.AllergyName, Inserted.AllergyName
from Inserted inner join Deleted
on Inserted.AllergyNo = Deleted.AllergyNo
and Inserted.AllergyName <> Deleted.AllergyName
end

-------------------  AllergyCategoryID  -----------------------------------------------------

if update(AllergyCategoryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AllergyCategoryID', Deleted.AllergyCategoryID, Inserted.AllergyCategoryID
from Inserted inner join Deleted
on Inserted.AllergyNo = Deleted.AllergyNo
and Inserted.AllergyCategoryID <> Deleted.AllergyCategoryID
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Allergies ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAllergies')
drop trigger utrDeleteAllergies
go

create trigger utrDeleteAllergies
on Allergies
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Allergies' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AllergyNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AllergyNo', Deleted.AllergyNo, null from Deleted

-------------------  AllergyName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AllergyName', Deleted.AllergyName, null from Deleted

-------------------  AllergyCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AllergyCategoryID', Deleted.AllergyCategoryID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: AllergyDrugs ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAllergyDrugs')
drop trigger utrUpdateAllergyDrugs
go

create trigger utrUpdateAllergyDrugs
on AllergyDrugs
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'AllergyDrugs' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-AllergyNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AllergyNo', Deleted.AllergyNo, Inserted.AllergyNo
from Inserted inner join Deleted
on Inserted.AllergyNo = Deleted.AllergyNo
and Inserted.DrugNo = Deleted.DrugNo
end

------------------- Key-DrugNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrugNo', Deleted.DrugNo, Inserted.DrugNo
from Inserted inner join Deleted
on Inserted.AllergyNo = Deleted.AllergyNo
and Inserted.DrugNo = Deleted.DrugNo
end

go

------------------------------------------------------------------------------------------------------
-------------- Delete: AllergyDrugs ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAllergyDrugs')
drop trigger utrDeleteAllergyDrugs
go

create trigger utrDeleteAllergyDrugs
on AllergyDrugs
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'AllergyDrugs' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AllergyNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AllergyNo', Deleted.AllergyNo, null from Deleted

-------------------  DrugNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrugNo', Deleted.DrugNo, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: PatientAllergies --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePatientAllergies')
drop trigger utrUpdatePatientAllergies
go

create trigger utrUpdatePatientAllergies
on PatientAllergies
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PatientAllergies' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-PatientNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.AllergyNo = Deleted.AllergyNo
end

------------------- Key-AllergyNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AllergyNo', Deleted.AllergyNo, Inserted.AllergyNo
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.AllergyNo = Deleted.AllergyNo
end

-------------------  Reaction  -----------------------------------------------------

if update(Reaction)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Reaction', Deleted.Reaction, Inserted.Reaction
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.AllergyNo = Deleted.AllergyNo
and Inserted.Reaction <> Deleted.Reaction
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: PatientAllergies --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePatientAllergies')
drop trigger utrDeletePatientAllergies
go

create trigger utrDeletePatientAllergies
on PatientAllergies
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PatientAllergies' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  AllergyNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AllergyNo', Deleted.AllergyNo, null from Deleted

-------------------  Reaction  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Reaction', Deleted.Reaction, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Diagnosis ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateDiagnosis')
drop trigger utrUpdateDiagnosis
go

create trigger utrUpdateDiagnosis
on Diagnosis
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Diagnosis' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseCode = Deleted.DiseaseCode
end

------------------- Key-DiseaseCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseCode', Deleted.DiseaseCode, Inserted.DiseaseCode
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseCode = Deleted.DiseaseCode
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseCode = Deleted.DiseaseCode
and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseCode = Deleted.DiseaseCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseCode = Deleted.DiseaseCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Diagnosis ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteDiagnosis')
drop trigger utrDeleteDiagnosis
go

create trigger utrDeleteDiagnosis
on Diagnosis
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Diagnosis' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  DiseaseCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseCode', Deleted.DiseaseCode, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Rooms -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRooms')
drop trigger utrUpdateRooms
go

create trigger utrUpdateRooms
on Rooms
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Rooms' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-RoomNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoomNo', Deleted.RoomNo, Inserted.RoomNo
from Inserted inner join Deleted
on Inserted.RoomNo = Deleted.RoomNo
end

-------------------  RoomName  -----------------------------------------------------

if update(RoomName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoomName', Deleted.RoomName, Inserted.RoomName
from Inserted inner join Deleted
on Inserted.RoomNo = Deleted.RoomNo
and Inserted.RoomName <> Deleted.RoomName
end

-------------------  WardsID  -----------------------------------------------------

if update(WardsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WardsID', Deleted.WardsID, Inserted.WardsID
from Inserted inner join Deleted
on Inserted.RoomNo = Deleted.RoomNo
and Inserted.WardsID <> Deleted.WardsID
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: Rooms -------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRooms')
drop trigger utrDeleteRooms
go

create trigger utrDeleteRooms
on Rooms
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Rooms' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoomNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoomNo', Deleted.RoomNo, null from Deleted

-------------------  RoomName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoomName', Deleted.RoomName, null from Deleted

-------------------  WardsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WardsID', Deleted.WardsID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Beds --------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
-------------- Update: Beds --------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateBeds')
drop trigger utrUpdateBeds
go

create trigger utrUpdateBeds
on Beds
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Beds' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-BedNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BedNo', Deleted.BedNo, Inserted.BedNo
from Inserted inner join Deleted
on Inserted.BedNo = Deleted.BedNo
end

-------------------  BedName  -----------------------------------------------------

if update(BedName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BedName', Deleted.BedName, Inserted.BedName
from Inserted inner join Deleted
on Inserted.BedNo = Deleted.BedNo
and Inserted.BedName <> Deleted.BedName
end

-------------------  RoomNo  -----------------------------------------------------

if update(RoomNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoomNo', Deleted.RoomNo, Inserted.RoomNo
from Inserted inner join Deleted
on Inserted.BedNo = Deleted.BedNo
and Inserted.RoomNo <> Deleted.RoomNo
end

-------------------  UnitCost  -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
from Inserted inner join Deleted
on Inserted.BedNo = Deleted.BedNo
and Inserted.UnitCost <> Deleted.UnitCost
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.BedNo = Deleted.BedNo
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  VATPercentage  -----------------------------------------------------

if update(VATPercentage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), cast(Inserted.VATPercentage as varchar(20))
from Inserted inner join Deleted
on Inserted.BedNo = Deleted.BedNo
and Inserted.VATPercentage <> Deleted.VATPercentage
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.BedNo = Deleted.BedNo
and Inserted.Hidden <> Deleted.Hidden
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Beds --------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteBeds')
drop trigger utrDeleteBeds
go

create trigger utrDeleteBeds
on Beds
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'A')

if exists (select ItemCode from Items 
where (ItemCode in (select BedNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select BedNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select BedNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select BedNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select BedNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select BedNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select BedNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select BedNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select BedNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select BedNo from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Beds' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  BedNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BedNo', Deleted.BedNo, null from Deleted

-------------------  BedName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BedName', Deleted.BedName, null from Deleted

-------------------  RoomNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoomNo', Deleted.RoomNo, null from Deleted

-------------------  UnitCost  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  VATPercentage  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATPercentage', cast(Deleted.VATPercentage as varchar(20)), null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Admissions --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAdmissions')
drop trigger utrUpdateAdmissions
go

create trigger utrUpdateAdmissions
on Admissions
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(AdmissionID)
begin
set @ErrorMSG = 'You can''t update Admission ID for Admissions, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(AdmissionNo)
begin
set @ErrorMSG = 'You can''t update Admission No for Admissions, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Admissions' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-AdmissionNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionNo', Deleted.AdmissionNo, Inserted.AdmissionNo
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
end

-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.VisitNo <> Deleted.VisitNo
end

-------------------  StaffNo  -----------------------------------------------------

if update(StaffNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.StaffNo <> Deleted.StaffNo
end

-------------------  AdmissionDateTime  -----------------------------------------------------

if update(AdmissionDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionDateTime', dbo.FormatDateTime(Deleted.AdmissionDateTime), dbo.FormatDateTime(Inserted.AdmissionDateTime)
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.AdmissionDateTime <> Deleted.AdmissionDateTime
end

-------------------  AdmissionNotes  -----------------------------------------------------

if update(AdmissionNotes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionNotes', Deleted.AdmissionNotes, Inserted.AdmissionNotes
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.AdmissionNotes <> Deleted.AdmissionNotes
end

-------------------  AdmissionStatusID  -----------------------------------------------------

if update(AdmissionStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionStatusID', Deleted.AdmissionStatusID, Inserted.AdmissionStatusID
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.AdmissionStatusID <> Deleted.AdmissionStatusID
end

-------------------  BillModesID  -----------------------------------------------------

if update(BillModesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillModesID', Deleted.BillModesID, Inserted.BillModesID
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.BillModesID <> Deleted.BillModesID
end

-------------------  BillNo  -----------------------------------------------------

if update(BillNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillNo', Deleted.BillNo, Inserted.BillNo
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.BillNo <> Deleted.BillNo
end

-------------------  InsuranceNo  -----------------------------------------------------

if update(InsuranceNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, Inserted.InsuranceNo
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.InsuranceNo <> Deleted.InsuranceNo
end

-------------------  AssociatedBillNo  -----------------------------------------------------

if update(AssociatedBillNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AssociatedBillNo', Deleted.AssociatedBillNo, Inserted.AssociatedBillNo
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.AssociatedBillNo <> Deleted.AssociatedBillNo
end

-------------------  MemberCardNo  -----------------------------------------------------

if update(MemberCardNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberCardNo', Deleted.MemberCardNo, Inserted.MemberCardNo
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.MemberCardNo <> Deleted.MemberCardNo
end

-------------------  MainMemberName  -----------------------------------------------------

if update(MainMemberName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MainMemberName', Deleted.MainMemberName, Inserted.MainMemberName
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.MainMemberName <> Deleted.MainMemberName
end

-------------------  ClaimReferenceNo  -----------------------------------------------------

if update(ClaimReferenceNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimReferenceNo', Deleted.ClaimReferenceNo, Inserted.ClaimReferenceNo
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.ClaimReferenceNo <> Deleted.ClaimReferenceNo
end

-------------------  CoPayTypeID  -----------------------------------------------------

if update(CoPayTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayTypeID', Deleted.CoPayTypeID, Inserted.CoPayTypeID
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.CoPayTypeID <> Deleted.CoPayTypeID
end

-------------------  CoPayPercent  -----------------------------------------------------

if update(CoPayPercent)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayPercent', Deleted.CoPayPercent, Inserted.CoPayPercent
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.CoPayPercent <> Deleted.CoPayPercent
end

-------------------  CoPayValue  -----------------------------------------------------

if update(CoPayValue)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayValue', Deleted.CoPayValue, Inserted.CoPayValue
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.CoPayValue <> Deleted.CoPayValue
end

-------------------  AccessCashServices  -----------------------------------------------------

if update(AccessCashServices)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccessCashServices', Deleted.AccessCashServices, Inserted.AccessCashServices
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.AccessCashServices <> Deleted.AccessCashServices
end

-------------------  SmartCardApplicable  -----------------------------------------------------

if update(SmartCardApplicable)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SmartCardApplicable', Deleted.SmartCardApplicable, Inserted.SmartCardApplicable
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.SmartCardApplicable <> Deleted.SmartCardApplicable
end


-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Admissions --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAdmissions')
drop trigger utrDeleteAdmissions
go

create trigger utrDeleteAdmissions
on Admissions
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Admissions' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AdmissionNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionNo', Deleted.AdmissionNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  StaffNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted

-------------------  AdmissionDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionDateTime', dbo.FormatDateTime(Deleted.AdmissionDateTime), null from Deleted

-------------------  AdmissionNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionNotes', Deleted.AdmissionNotes, null from Deleted

-------------------  AdmissionStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionStatusID', Deleted.AdmissionStatusID, null from Deleted


-------------------  BillModesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillModesID', Deleted.BillModesID, null from Deleted

-------------------  BillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillNo', Deleted.BillNo, null from Deleted

-------------------  InsuranceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InsuranceNo', Deleted.InsuranceNo, null from Deleted

-------------------  AssociatedBillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AssociatedBillNo', Deleted.AssociatedBillNo, null from Deleted

-------------------  MemberCardNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemberCardNo', Deleted.MemberCardNo, null from Deleted

-------------------  MainMemberName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MainMemberName', Deleted.MainMemberName, null from Deleted

-------------------  ClaimReferenceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimReferenceNo', Deleted.ClaimReferenceNo, null from Deleted

-------------------  CoPayTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayTypeID', Deleted.CoPayTypeID, null from Deleted

-------------------  CoPayPercent  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayPercent', Deleted.CoPayPercent, null from Deleted

-------------------  CoPayValue  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoPayValue', Deleted.CoPayValue, null from Deleted

-------------------  AccessCashServices  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccessCashServices', Deleted.AccessCashServices, null from Deleted

-------------------  SmartCardApplicable  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SmartCardApplicable', Deleted.SmartCardApplicable, null from Deleted


-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: IPDDoctor ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDDoctor')
drop trigger utrUpdateIPDDoctor
go

create trigger utrUpdateIPDDoctor
on IPDDoctor
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(RoundID)
begin
set @ErrorMSG = 'You can''t update Round ID for IPD Doctor, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(RoundNo)
begin
set @ErrorMSG = 'You can''t update Round No for IPD Doctor, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDDoctor' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-RoundNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
end

-------------------  AdmissionNo  -----------------------------------------------------

if update(AdmissionNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionNo', Deleted.AdmissionNo, Inserted.AdmissionNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.AdmissionNo <> Deleted.AdmissionNo
end

-------------------  StaffNo  -----------------------------------------------------

if update(StaffNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.StaffNo <> Deleted.StaffNo
end

-------------------  RoundDateTime  -----------------------------------------------------

if update(RoundDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundDateTime', dbo.FormatDateTime(Deleted.RoundDateTime), dbo.FormatDateTime(Inserted.RoundDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RoundDateTime <> Deleted.RoundDateTime
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: IPDDoctor ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDDoctor')
drop trigger utrDeleteIPDDoctor
go

create trigger utrDeleteIPDDoctor
on IPDDoctor
for delete
as

declare @ErrorMSG varchar(200)
declare @PayTypeID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

-----------------------------------------------------------------------------------------------------------------------

set @PayTypeID = dbo.GetLookupDataID('PayType', 'IPR')

if exists (select PayNo from Payments 
where (PayNo in (select RoundNo from Deleted) and PayTypeID = @PayTypeID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payments'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

-----------------------------------------------------------------------------------------------------------------------

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDDoctor' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  AdmissionNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionNo', Deleted.AdmissionNo, null from Deleted

-------------------  StaffNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted

-------------------  RoundDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundDateTime', dbo.FormatDateTime(Deleted.RoundDateTime), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: IPDClinicalFindings ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDClinicalFindings')
drop trigger utrUpdateIPDClinicalFindings
go

create trigger utrUpdateIPDClinicalFindings
on IPDClinicalFindings
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDClinicalFindings' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-RoundNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
end

-------------------  Weight  -----------------------------------------------------

if update(Weight)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Weight', Deleted.Weight, Inserted.Weight
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.Weight <> Deleted.Weight
end

-------------------  Temperature  -----------------------------------------------------

if update(Temperature)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Temperature', Deleted.Temperature, Inserted.Temperature
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.Temperature <> Deleted.Temperature
end

-------------------  Height  -----------------------------------------------------

if update(Height)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Height', Deleted.Height, Inserted.Height
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.Height <> Deleted.Height
end

-------------------  Pulse  -----------------------------------------------------

if update(Pulse)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pulse', Deleted.Pulse, Inserted.Pulse
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.Pulse <> Deleted.Pulse
end

-------------------  BloodPressure  -----------------------------------------------------

if update(BloodPressure)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodPressure', Deleted.BloodPressure, Inserted.BloodPressure
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.BloodPressure <> Deleted.BloodPressure
end

-------------------  HeadCircum  -----------------------------------------------------

if update(HeadCircum)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeadCircum', Deleted.HeadCircum, Inserted.HeadCircum
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.HeadCircum <> Deleted.HeadCircum
end

-------------------  BodySurfaceArea  -----------------------------------------------------

if update(BodySurfaceArea)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BodySurfaceArea', Deleted.BodySurfaceArea, Inserted.BodySurfaceArea
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.BodySurfaceArea <> Deleted.BodySurfaceArea
end

-------------------  History  -----------------------------------------------------

if update(History)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'History', Deleted.History, Inserted.History
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.History <> Deleted.History
end

-------------------  ClinicalNotes  -----------------------------------------------------

if update(ClinicalNotes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClinicalNotes', Deleted.ClinicalNotes, Inserted.ClinicalNotes
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ClinicalNotes <> Deleted.ClinicalNotes
end

-------------------  Respiratory  -----------------------------------------------------

if update(Respiratory)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Respiratory', Deleted.Respiratory, Inserted.Respiratory
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.Respiratory <> Deleted.Respiratory
end

-------------------  GeneralAppearance  -----------------------------------------------------

if update(GeneralAppearance)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GeneralAppearance', Deleted.GeneralAppearance, Inserted.GeneralAppearance
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.GeneralAppearance <> Deleted.GeneralAppearance
end

-------------------  CVS  -----------------------------------------------------

if update(CVS)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CVS', Deleted.CVS, Inserted.CVS
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.CVS <> Deleted.CVS
end

-------------------  Abdomen  -----------------------------------------------------

if update(Abdomen)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Abdomen', Deleted.Abdomen, Inserted.Abdomen
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.Abdomen <> Deleted.Abdomen
end

-------------------  CNS  -----------------------------------------------------

if update(CNS)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CNS', Deleted.CNS, Inserted.CNS
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.CNS <> Deleted.CNS
end

-------------------  MuscularSkeletal  -----------------------------------------------------

if update(MuscularSkeletal)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MuscularSkeletal', Deleted.MuscularSkeletal, Inserted.MuscularSkeletal
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.MuscularSkeletal <> Deleted.MuscularSkeletal
end

-------------------  PsychologicalStatus  -----------------------------------------------------

if update(PsychologicalStatus)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PsychologicalStatus', Deleted.PsychologicalStatus, Inserted.PsychologicalStatus
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.PsychologicalStatus <> Deleted.PsychologicalStatus
end

-------------------  ClinicalDiagnosis  -----------------------------------------------------

if update(ClinicalDiagnosis)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClinicalDiagnosis', Deleted.ClinicalDiagnosis, Inserted.ClinicalDiagnosis
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ClinicalDiagnosis <> Deleted.ClinicalDiagnosis
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: IPDClinicalFindings ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDClinicalFindings')
drop trigger utrDeleteIPDClinicalFindings
go

create trigger utrDeleteIPDClinicalFindings
on IPDClinicalFindings
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDClinicalFindings' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  Weight  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Weight', Deleted.Weight, null from Deleted

-------------------  Temperature  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Temperature', Deleted.Temperature, null from Deleted

-------------------  Height  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Height', Deleted.Height, null from Deleted

-------------------  Pulse  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pulse', Deleted.Pulse, null from Deleted

-------------------  BloodPressure  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodPressure', Deleted.BloodPressure, null from Deleted

-------------------  HeadCircum  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeadCircum', Deleted.HeadCircum, null from Deleted

-------------------  BodySurfaceArea  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BodySurfaceArea', Deleted.BodySurfaceArea, null from Deleted

-------------------  History  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'History', Deleted.History, null from Deleted

-------------------  ClinicalNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClinicalNotes', Deleted.ClinicalNotes, null from Deleted

-------------------  Respiratory  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Respiratory', Deleted.Respiratory, null from Deleted

-------------------  GeneralAppearance  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GeneralAppearance', Deleted.GeneralAppearance, null from Deleted

-------------------  CVS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CVS', Deleted.CVS, null from Deleted

-------------------  Abdomen  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Abdomen', Deleted.Abdomen, null from Deleted

-------------------  CNS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CNS', Deleted.CNS, null from Deleted

-------------------  MuscularSkeletal  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MuscularSkeletal', Deleted.MuscularSkeletal, null from Deleted

-------------------  PsychologicalStatus  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PsychologicalStatus', Deleted.PsychologicalStatus, null from Deleted

-------------------  ClinicalDiagnosis  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClinicalDiagnosis', Deleted.ClinicalDiagnosis, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

----------------------------------------------------------------------------------------------------------------------------
------------- Update: IPDItems ----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDItems')
drop trigger utrUpdateIPDItems
go

create trigger utrUpdateIPDItems
on IPDItems 
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-RoundNo -----------------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted 
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted 
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted 
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemName -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
from Inserted inner join Deleted 
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemName = Deleted.ItemName
end

------------------- Key-UnitMeasure -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, Inserted.UnitMeasure
from Inserted inner join Deleted 
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.UnitMeasure = Deleted.UnitMeasure
end

------------------- Quantity -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted 
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  UnitCost  -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.UnitCost <> Deleted.UnitCost
end

------------------- UnitPrice -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted 
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.UnitPrice <> Deleted.UnitPrice
end

------------------- ItemDetails -----------------------------------------------------

if update(ItemDetails)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemDetails', Deleted.ItemDetails, Inserted.ItemDetails
from Inserted inner join Deleted 
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemDetails <> Deleted.ItemDetails
end

------------------- LastUpdate -----------------------------------------------------

if update(LastUpdate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastUpdate', dbo.FormatDateTime(Deleted.LastUpdate), dbo.FormatDateTime(Inserted.LastUpdate)
from Inserted inner join Deleted 
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LastUpdate <> Deleted.LastUpdate
end

------------------- ItemStatusID -----------------------------------------------------

if update(ItemStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemStatusID', Deleted.ItemStatusID, Inserted.ItemStatusID
from Inserted inner join Deleted 
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemStatusID <> Deleted.ItemStatusID
end

------------------- PayStatusID -----------------------------------------------------

if update(PayStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayStatusID', Deleted.PayStatusID, Inserted.PayStatusID
from Inserted inner join Deleted 
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.PayStatusID <> Deleted.PayStatusID
end

------------------- LoginID -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted 
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ClientMachine <> Deleted.ClientMachine
end

------------------- CreatorLoginID -----------------------------------------------------

if update(CreatorLoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CreatorLoginID', Deleted.CreatorLoginID, Inserted.CreatorLoginID
from Inserted inner join Deleted 
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CreatorLoginID <> Deleted.CreatorLoginID
end

-------------------  CreatorClientMachine  -----------------------------------------------------

if update(CreatorClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CreatorClientMachine', Deleted.CreatorClientMachine, Inserted.CreatorClientMachine
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CreatorClientMachine <> Deleted.CreatorClientMachine
end


go

----------------------------------------------------------------------------------------------------------------------------
------------- Delete: IPDItems ----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDItems')
drop trigger utrDeleteIPDItems
go

create trigger utrDeleteIPDItems
on IPDItems
for  delete
as

declare @ErrorMSG varchar(200)
declare @OfferedItemStatus varchar(10)
declare @DoneItemStatus varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------------------------------------------------------------------
set @OfferedItemStatus = dbo.GetLookupDataID('ItemStatus', 'O')
set @DoneItemStatus = dbo.GetLookupDataID('ItemStatus', 'D')

if exists (select ItemCode from Deleted where ItemStatusID = @OfferedItemStatus or ItemStatusID = @DoneItemStatus)
begin
set @ErrorMSG = 'Can''t delete record entries in IPD Items that are Offered or Done'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return

set @Identity = ident_current('AuditTrail') 
if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- RoundNo -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted 

------------------- ItemCode -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted 

------------------- ItemCategoryID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted 

------------------- ItemName -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted 

------------------- UnitMeasure -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, null from Deleted 

-------------------  UnitCost  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted

------------------- Quantity -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted 

------------------- UnitPrice -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted 

------------------- ItemDetails -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemDetails', Deleted.ItemDetails, null from Deleted 

------------------- LastUpdate -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastUpdate', dbo.FormatDateTime(Deleted.LastUpdate), null from Deleted 

------------------- ItemStatusID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemStatusID', Deleted.ItemStatusID, null from Deleted 

------------------- PayStatusID -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayStatusID', Deleted.PayStatusID, null from Deleted 

------------------- LoginID -----------------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted 

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

------------------- RecordDateTime ----------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted 
------------------- CreatorLoginID -----------------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CreatorLoginID', Deleted.CreatorLoginID, null from Deleted 

-------------------  CreatorClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CreatorClientMachine', Deleted.CreatorClientMachine, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: IPDItemsEXT -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDItemsEXT')
drop trigger utrUpdateIPDItemsEXT
go

create trigger utrUpdateIPDItemsEXT
on IPDItemsEXT
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDItemsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-RoundNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  Dosage  -----------------------------------------------------

if update(Dosage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Dosage', Deleted.Dosage, Inserted.Dosage
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Dosage <> Deleted.Dosage
end

-------------------  Duration  -----------------------------------------------------

if update(Duration)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Duration', Deleted.Duration, Inserted.Duration
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Duration <> Deleted.Duration
end

-------------------  DrQuantity  -----------------------------------------------------

if update(DrQuantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrQuantity', Deleted.DrQuantity, Inserted.DrQuantity
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.DrQuantity <> Deleted.DrQuantity
end

-------------------  IssueDateTime  -----------------------------------------------------

if update(IssueDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IssueDateTime', dbo.FormatDateTime(Deleted.IssueDateTime), dbo.FormatDateTime(Inserted.IssueDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.IssueDateTime <> Deleted.IssueDateTime
end

-------------------  Pharmacist  -----------------------------------------------------

if update(Pharmacist)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pharmacist', Deleted.Pharmacist, Inserted.Pharmacist
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Pharmacist <> Deleted.Pharmacist
end

-------------------  LocationID  -----------------------------------------------------

if update(LocationID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationID', Deleted.LocationID, Inserted.LocationID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LocationID <> Deleted.LocationID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ClientMachine <> Deleted.ClientMachine
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: IPDItemsEXT -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDItemsEXT')
drop trigger utrDeleteIPDItemsEXT
go

create trigger utrDeleteIPDItemsEXT
on IPDItemsEXT
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDItemsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  Dosage  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Dosage', Deleted.Dosage, null from Deleted

-------------------  Duration  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Duration', Deleted.Duration, null from Deleted

-------------------  DrQuantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrQuantity', Deleted.DrQuantity, null from Deleted

-------------------  IssueDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IssueDateTime', dbo.FormatDateTime(Deleted.IssueDateTime), null from Deleted

-------------------  Pharmacist  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pharmacist', Deleted.Pharmacist, null from Deleted

-------------------  LocationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationID', Deleted.LocationID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: IPDDiagnosis ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDDiagnosis')
drop trigger utrUpdateIPDDiagnosis
go

create trigger utrUpdateIPDDiagnosis
on IPDDiagnosis
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDDiagnosis' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-RoundNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseCode = Deleted.DiseaseCode
end

------------------- Key-DiseaseCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseCode', Deleted.DiseaseCode, Inserted.DiseaseCode
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseCode = Deleted.DiseaseCode
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseCode = Deleted.DiseaseCode
and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseCode = Deleted.DiseaseCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseCode = Deleted.DiseaseCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: IPDDiagnosis ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDDiagnosis')
drop trigger utrDeleteIPDDiagnosis
go

create trigger utrDeleteIPDDiagnosis
on IPDDiagnosis
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDDiagnosis' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  DiseaseCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseCode', Deleted.DiseaseCode, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Discharges --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateDischarges')
drop trigger utrUpdateDischarges
go

create trigger utrUpdateDischarges
on Discharges
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Discharges' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-AdmissionNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionNo', Deleted.AdmissionNo, Inserted.AdmissionNo
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
end

-------------------  StaffNo  -----------------------------------------------------

if update(StaffNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.StaffNo <> Deleted.StaffNo
end

-------------------  RoundNo  -----------------------------------------------------

if update(RoundNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.RoundNo <> Deleted.RoundNo
end

-------------------  DischargeDateTime  -----------------------------------------------------

if update(DischargeDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DischargeDateTime', dbo.FormatDate(Deleted.DischargeDateTime), dbo.FormatDate(Inserted.DischargeDateTime)
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.DischargeDateTime <> Deleted.DischargeDateTime
end

-------------------  DischargeNotes  -----------------------------------------------------

if update(DischargeNotes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DischargeNotes', Deleted.DischargeNotes, Inserted.DischargeNotes
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.DischargeNotes <> Deleted.DischargeNotes
end

-------------------  DischargeStatusID  -----------------------------------------------------

if update(DischargeStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DischargeStatusID', Deleted.DischargeStatusID, Inserted.DischargeStatusID
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.DischargeStatusID <> Deleted.DischargeStatusID
end
-------------------  History  -----------------------------------------------------

if update(History)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'History', Deleted.History, Inserted.History
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.History <> Deleted.History
end
-------------------  Examination  -----------------------------------------------------

if update(Examination)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Examination', Deleted.Examination, Inserted.Examination
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.Examination <> Deleted.Examination
end
-------------------  KeyFindingsInvestigation  -----------------------------------------------------

if update(KeyFindingsInvestigation)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'KeyFindingsInvestigation', Deleted.KeyFindingsInvestigation, Inserted.KeyFindingsInvestigation
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.KeyFindingsInvestigation <> Deleted.KeyFindingsInvestigation
end
-------------------  TreatmentOnWard  -----------------------------------------------------

if update(TreatmentOnWard)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TreatmentOnWard', Deleted.TreatmentOnWard, Inserted.TreatmentOnWard
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.TreatmentOnWard <> Deleted.TreatmentOnWard
end
-------------------  DischargeNotes  -----------------------------------------------------

if update(OutcomeOfTreatment)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OutcomeOfTreatment', Deleted.OutcomeOfTreatment, Inserted.OutcomeOfTreatment
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.OutcomeOfTreatment <> Deleted.OutcomeOfTreatment
end
-------------------  DischargeNotes  -----------------------------------------------------

if update(KeyRecommendations)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'KeyRecommendations', Deleted.KeyRecommendations, Inserted.KeyRecommendations
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.KeyRecommendations <> Deleted.KeyRecommendations
end
-------------------  ReviewDate  -----------------------------------------------------

if update(ReviewDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReviewDate', dbo.FormatDate(Deleted.ReviewDate), dbo.FormatDate(Inserted.ReviewDate)
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.ReviewDate <> Deleted.ReviewDate
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.AdmissionNo = Deleted.AdmissionNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Discharges --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteDischarges')
drop trigger utrDeleteDischarges
go

create trigger utrDeleteDischarges
on Discharges
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Discharges' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AdmissionNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionNo', Deleted.AdmissionNo, null from Deleted

-------------------  StaffNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  DischargeDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DischargeDateTime', dbo.FormatDate(Deleted.DischargeDateTime), null from Deleted

-------------------  DischargeNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DischargeNotes', Deleted.DischargeNotes, null from Deleted

-------------------  DischargeStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DischargeStatusID', Deleted.DischargeStatusID, null from Deleted

-------------------  History  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'History', Deleted.History, null from Deleted

-------------------  Examination  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Examination', Deleted.Examination, null from Deleted

-------------------  KeyFindingsInvestigation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'KeyFindingsInvestigation', Deleted.KeyFindingsInvestigation, null from Deleted

-------------------  TreatmentOnWard  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TreatmentOnWard', Deleted.TreatmentOnWard, null from Deleted

-------------------  OutcomeOfTreatment  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OutcomeOfTreatment', Deleted.OutcomeOfTreatment, null from Deleted

-------------------  KeyRecommendations  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'KeyRecommendations', Deleted.KeyRecommendations, null from Deleted

-------------------  ReviewDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReviewDate', dbo.FormatDate(Deleted.ReviewDate), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

----------------------------------------------------------------------------------------------------------------------------
------------- Update: ARTRegimen -------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateARTRegimen')
drop trigger utrUpdateARTRegimen
go

create trigger utrUpdateARTRegimen
on ARTRegimen
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ARTRegimen' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
end

------------------- Combination -----------------------------------------------------

if update(Combination)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Combination', Deleted.Combination, Inserted.Combination
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Combination <> Deleted.Combination
end

------------------- StartDate -----------------------------------------------------

if update(StartDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartDate', dbo.FormatDate(Deleted.StartDate), dbo.FormatDate(Inserted.StartDate)
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.StartDate <> Deleted.StartDate
end

------------------- WHOStageID -----------------------------------------------------

if update(WHOStageID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WHOStageID', Deleted.WHOStageID, Inserted.WHOStageID
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.WHOStageID <> Deleted.WHOStageID
end

------------------- DrugLinesID -----------------------------------------------------

if update(DrugLinesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrugLinesID', Deleted.DrugLinesID, Inserted.DrugLinesID
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DrugLinesID <> Deleted.DrugLinesID
end

------------------- StaffNo -----------------------------------------------------

if update(StaffNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.StaffNo <> Deleted.StaffNo
end

------------------- ARTCategoryID -----------------------------------------------------

if update(ARTCategoryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARTCategoryID', Deleted.ARTCategoryID, Inserted.ARTCategoryID
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ARTCategoryID <> Deleted.ARTCategoryID
end

------------------- WhyEligible -------------------------------------------------------------

if update(WhyEligible)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WhyEligible', Deleted.WhyEligible, Inserted.WhyEligible
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.WhyEligible <> Deleted.WhyEligible
end

------------------- ARTSwitchReasons -------------------------------------------------------------

if update(ARTSwitchReasons)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARTSwitchReasons', Deleted.ARTSwitchReasons, Inserted.ARTSwitchReasons
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ARTSwitchReasons <> Deleted.ARTSwitchReasons
end

------------------- Notes -------------------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Notes <> Deleted.Notes
end

------------------- ARTStatusID -----------------------------------------------------

if update(ARTStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARTStatusID', Deleted.ARTStatusID, Inserted.ARTStatusID
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ARTStatusID <> Deleted.ARTStatusID
end

------------------- LoginID -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

go

----------------------------------------------------------------------------------------------------------------------------
------------- Delete: ARTRegimen -----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteARTRegimen')
drop trigger utrDeleteARTRegimen
go

create trigger utrDeleteARTRegimen
on ARTRegimen
for  delete
as

declare @ErrorMSG varchar(200)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Deletes ----------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return

set @Identity = ident_current('AuditTrail') 
if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ARTRegimen' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- VisitNo ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted 

------------------- Combination --------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Combination', Deleted.Combination, null from Deleted 

------------------- StartDate ----------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartDate', dbo.FormatDate(Deleted.StartDate), null from Deleted 

------------------- WHOStageID ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WHOStageID', Deleted.WHOStageID, null from Deleted 

------------------- DrugLinesID ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrugLinesID', Deleted.DrugLinesID, null from Deleted 

------------------- StaffNo ----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted 

------------------- ARTCategoryID ----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARTCategoryID', Deleted.ARTCategoryID, null from Deleted 

------------------- WhyEligible -------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WhyEligible', Deleted.WhyEligible, null from Deleted 

------------------- ARTSwitchReasons -------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARTSwitchReasons', Deleted.ARTSwitchReasons, null from Deleted 

------------------- Notes ----------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted 

------------------- ARTStatusID ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARTStatusID', Deleted.ARTStatusID, null from Deleted 

------------------- LoginID --------------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted 

------------------- RecordDateTime --------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted 

go

------------------------------------------------------------------------------------------------------
-------------- Update: ARTRegimenDetails -------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateARTRegimenDetails')
drop trigger utrUpdateARTRegimenDetails
go

create trigger utrUpdateARTRegimenDetails
on ARTRegimenDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ARTRegimenDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DrugNo = Deleted.DrugNo
end

------------------- Key-DrugNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrugNo', Deleted.DrugNo, Inserted.DrugNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DrugNo = Deleted.DrugNo
end

-------------------  Dosage  -----------------------------------------------------

if update(Dosage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Dosage', Deleted.Dosage, Inserted.Dosage
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DrugNo = Deleted.DrugNo
and Inserted.Dosage <> Deleted.Dosage
end

-------------------  Duration  -----------------------------------------------------

if update(Duration)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Duration', Deleted.Duration, Inserted.Duration
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DrugNo = Deleted.DrugNo
and Inserted.Duration <> Deleted.Duration
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DrugNo = Deleted.DrugNo
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Formula  -----------------------------------------------------

if update(Formula)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Formula', Deleted.Formula, Inserted.Formula
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DrugNo = Deleted.DrugNo
and Inserted.Formula <> Deleted.Formula
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ARTRegimenDetails -------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteARTRegimenDetails')
drop trigger utrDeleteARTRegimenDetails
go

create trigger utrDeleteARTRegimenDetails
on ARTRegimenDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ARTRegimenDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  DrugNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrugNo', Deleted.DrugNo, null from Deleted

-------------------  Dosage  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Dosage', Deleted.Dosage, null from Deleted

-------------------  Duration  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Duration', Deleted.Duration, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Formula  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Formula', Deleted.Formula, null from Deleted
go

----------------------------------------------------------------------------------------------------------------------------
------------- Update: ARTStopped --------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateARTStopped')
drop trigger utrUpdateARTStopped
go

create trigger utrUpdateARTStopped
on ARTStopped
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ARTStopped' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
end

------------------- StopDate -----------------------------------------------------

if update(StopDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StopDate', dbo.FormatDate(Deleted.StopDate), dbo.FormatDate(Inserted.StopDate)
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.StopDate <> Deleted.StopDate
end

------------------- ARTStopReasons -----------------------------------------------------

if update(ARTStopReasons)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARTStopReasons', Deleted.ARTStopReasons, Inserted.ARTStopReasons
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ARTStopReasons <> Deleted.ARTStopReasons
end

------------------- StaffNo -----------------------------------------------------

if update(StaffNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.StaffNo <> Deleted.StaffNo
end

------------------- LoginID -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted 
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

go

----------------------------------------------------------------------------------------------------------------------------
------------- Delete: ARTStopped -----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteARTStopped')
drop trigger utrDeleteARTStopped
go

create trigger utrDeleteARTStopped
on ARTStopped
for  delete
as

declare @ErrorMSG varchar(200)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Deletes ----------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return

set @Identity = ident_current('AuditTrail') 
if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ARTStopped' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- VisitNo ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted 

------------------- StopDate ----------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StopDate', dbo.FormatDate(Deleted.StopDate), null from Deleted 

------------------- ARTStopReasons ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARTStopReasons', Deleted.ARTStopReasons, null from Deleted 

------------------- StaffNo -------------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted 

------------------- LoginID --------------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted 

------------------- RecordDateTime --------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted 

go


----------------------------------------------------------------------------------------------------------------------------
------------- Update: Deaths -----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateDeaths')
drop trigger utrUpdateDeaths
go

create trigger utrUpdateDeaths
on Deaths
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Deaths' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-PatientNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
end

------------------- DeathDate -----------------------------------------------------

if update(DeathDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DeathDate', dbo.FormatDate(Deleted.DeathDate), dbo.FormatDate(Inserted.DeathDate)
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.DeathDate <> Deleted.DeathDate
end

------------------- Notes -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.Notes <> Deleted.Notes
end

------------------- LoginID -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.LoginID <> Deleted.LoginID
end

------------------- StaffNo -----------------------------------------------------

if update(StaffNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StaffNo <> Deleted.StaffNo
end

------------------- TimeOfDeath -----------------------------------------------------

if update(TimeOfDeath)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TimeOfDeath', Deleted.TimeOfDeath, Inserted.TimeOfDeath
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.TimeOfDeath <> Deleted.TimeOfDeath
end

------------------- PrimaryCauseOfDeath -----------------------------------------------------

if update(PrimaryCauseOfDeath)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PrimaryCauseOfDeath', Deleted.PrimaryCauseOfDeath, Inserted.PrimaryCauseOfDeath
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PrimaryCauseOfDeath <> Deleted.PrimaryCauseOfDeath
end

------------------- SecondaryCauseOfDeath -----------------------------------------------------

if update(SecondaryCauseOfDeath)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SecondaryCauseOfDeath', Deleted.SecondaryCauseOfDeath, Inserted.SecondaryCauseOfDeath
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.SecondaryCauseOfDeath <> Deleted.SecondaryCauseOfDeath
end

------------------- OtherCauseOfDeath -----------------------------------------------------

if update(OtherCauseOfDeath)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherCauseOfDeath', Deleted.OtherCauseOfDeath, Inserted.OtherCauseOfDeath
from Inserted inner join Deleted 
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.OtherCauseOfDeath <> Deleted.OtherCauseOfDeath
end
go

----------------------------------------------------------------------------------------------------------------------------
------------- Delete: Deaths -----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteDeaths')
drop trigger utrDeleteDeaths
go

create trigger utrDeleteDeaths
on Deaths
for  delete
as

declare @ErrorMSG varchar(200)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return 

------------------- Log Deletes ----------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return

set @Identity = ident_current('AuditTrail') 
if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Deaths' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- PatientNo ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted 

------------------- DeathDate ----------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DeathDate', dbo.FormatDate(Deleted.DeathDate), null from Deleted 

------------------- Notes ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted 

------------------- LoginID --------------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted 

------------------- RecordDateTime --------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted 

------------------- StaffNo ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted 

------------------- TimeOfDeath ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TimeOfDeath', Deleted.TimeOfDeath, null from Deleted 

------------------- PrimaryCauseOfDeath ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PrimaryCauseOfDeath', Deleted.PrimaryCauseOfDeath, null from Deleted 

------------------- SecondaryCauseOfDeath ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SecondaryCauseOfDeath', Deleted.SecondaryCauseOfDeath, null from Deleted 

------------------- OtherCauseOfDeath ---------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherCauseOfDeath', Deleted.OtherCauseOfDeath, null from Deleted 

go

------------------------------------------------------------------------------------------------------
-------------- Update: Expenditure -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateExpenditure')
drop trigger utrUpdateExpenditure
go

create trigger utrUpdateExpenditure
on Expenditure
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(ExpenditureID)
begin
set @ErrorMSG = 'You can''t update Expenditure ID for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ExpenditureNo)
begin
set @ErrorMSG = 'You can''t update Expenditure No for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(SpentDate)
begin
set @ErrorMSG = 'You can''t update Spent Date for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ExpenditureCategoryID)
begin
set @ErrorMSG = 'You can''t update Expenditure Category ID for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ExpenditureSourceTypeID)
begin
set @ErrorMSG = 'You can''t update Expenditure Source Type ID for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(AccountNo)
begin
set @ErrorMSG = 'You can''t update AccountNo for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ExchangeRate)
begin
set @ErrorMSG = 'You can''t update ExchangeRate for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(GivenTo)
begin
set @ErrorMSG = 'You can''t update Given To for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Amount)
begin
set @ErrorMSG = 'You can''t update Amount for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(DocumentNo)
begin
set @ErrorMSG = 'You can''t update Document No for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Details)
begin
set @ErrorMSG = 'You can''t update Details for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(LoginID)
begin
set @ErrorMSG = 'You can''t update Login ID for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ClientMachine)
begin
set @ErrorMSG = 'You can''t update Client Machine for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(RecordDateTime)
begin
set @ErrorMSG = 'You can''t update Record Date Time for Expenditure, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Expenditure' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return


------------------- Key-ExpenditureNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpenditureNo', Deleted.ExpenditureNo, Inserted.ExpenditureNo
from Inserted inner join Deleted
on Inserted.ExpenditureNo = Deleted.ExpenditureNo
end

-------------------  SpentDate  -----------------------------------------------------

if update(SpentDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpentDate', dbo.FormatDate(Deleted.SpentDate), dbo.FormatDate(Inserted.SpentDate)
from Inserted inner join Deleted
on Inserted.ExpenditureNo = Deleted.ExpenditureNo
and Inserted.SpentDate <> Deleted.SpentDate
end

-------------------  ExpenditureCategoryID  -----------------------------------------------------

if update(ExpenditureCategoryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpenditureCategoryID', Deleted.ExpenditureCategoryID, Inserted.ExpenditureCategoryID
from Inserted inner join Deleted
on Inserted.ExpenditureNo = Deleted.ExpenditureNo
and Inserted.ExpenditureCategoryID <> Deleted.ExpenditureCategoryID
end

-------------------  ExpenditureSourceTypeID  -----------------------------------------------------

if update(ExpenditureSourceTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpenditureSourceTypeID', Deleted.ExpenditureSourceTypeID, Inserted.ExpenditureSourceTypeID
from Inserted inner join Deleted
on Inserted.ExpenditureNo = Deleted.ExpenditureNo
and Inserted.ExpenditureSourceTypeID <> Deleted.ExpenditureSourceTypeID
end

-------------------  AccountNo  -----------------------------------------------------

if update(AccountNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
from Inserted inner join Deleted
on Inserted.ExpenditureNo = Deleted.ExpenditureNo
and Inserted.AccountNo <> Deleted.AccountNo
end


-------------------  ExchangeRate  -----------------------------------------------------

if update(ExchangeRate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExchangeRate', Deleted.ExchangeRate, Inserted.ExchangeRate
from Inserted inner join Deleted
on Inserted.ExpenditureNo = Deleted.ExpenditureNo
and Inserted.ExchangeRate <> Deleted.ExchangeRate
end
-------------------  GivenTo  -----------------------------------------------------

if update(GivenTo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GivenTo', Deleted.GivenTo, Inserted.GivenTo
from Inserted inner join Deleted
on Inserted.ExpenditureNo = Deleted.ExpenditureNo
and Inserted.GivenTo <> Deleted.GivenTo
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.ExpenditureNo = Deleted.ExpenditureNo
and Inserted.Amount <> Deleted.Amount
end

-------------------  DocumentNo  -----------------------------------------------------

if update(DocumentNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, Inserted.DocumentNo
from Inserted inner join Deleted
on Inserted.ExpenditureNo = Deleted.ExpenditureNo
and Inserted.DocumentNo <> Deleted.DocumentNo
end

-------------------  Details  -----------------------------------------------------

if update(Details)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Details', Deleted.Details, Inserted.Details
from Inserted inner join Deleted
on Inserted.ExpenditureNo = Deleted.ExpenditureNo
and Inserted.Details <> Deleted.Details
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ExpenditureNo = Deleted.ExpenditureNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ExpenditureNo = Deleted.ExpenditureNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ExpenditureNo = Deleted.ExpenditureNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Expenditure -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteExpenditure')
drop trigger utrDeleteExpenditure
go

create trigger utrDeleteExpenditure
on Expenditure
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Expenditure' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ExpenditureID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpenditureID', Deleted.ExpenditureID, null from Deleted

-------------------  ExpenditureNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpenditureNo', Deleted.ExpenditureNo, null from Deleted

-------------------  SpentDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpentDate', dbo.FormatDate(Deleted.SpentDate), null from Deleted

-------------------  ExpenditureCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpenditureCategoryID', Deleted.ExpenditureCategoryID, null from Deleted

-------------------  GivenTo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GivenTo', Deleted.GivenTo, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  DocumentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, null from Deleted

-------------------  Details  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Details', Deleted.Details, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: OtherIncome -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateOtherIncome')
drop trigger utrUpdateOtherIncome
go

create trigger utrUpdateOtherIncome
on OtherIncome
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(IncomeID)
begin
set @ErrorMSG = 'You can''t update Income ID for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(IncomeNo)
begin
set @ErrorMSG = 'You can''t update Income No for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(IncomeDate)
begin
set @ErrorMSG = 'You can''t update Income Date for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(IncomeSourcesID)
begin
set @ErrorMSG = 'You can''t update Income Sources ID for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(PayModesID)
begin
set @ErrorMSG = 'You can''t update Pay Modes ID for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Amount)
begin
set @ErrorMSG = 'You can''t update Amount for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(CurrenciesID)
begin
set @ErrorMSG = 'You can''t update Currency for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(AmountTendered)
begin
set @ErrorMSG = 'You can''t update Amount Tendered for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ExchangeRate)
begin
set @ErrorMSG = 'You can''t update Exchange Rate for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Change)
begin
set @ErrorMSG = 'You can''t update Change for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(DocumentNo)
begin
set @ErrorMSG = 'You can''t update Document No for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(Notes)
begin
set @ErrorMSG = 'You can''t update Notes for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(LoginID)
begin
set @ErrorMSG = 'You can''t update Login ID for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ClientMachine)
begin
set @ErrorMSG = 'You can''t update Client Machine for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(RecordDateTime)
begin
set @ErrorMSG = 'You can''t update Record Date Time for Other Income, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'OtherIncome' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-IncomeNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IncomeNo', Deleted.IncomeNo, Inserted.IncomeNo
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
end

-------------------  IncomeDate  -----------------------------------------------------

if update(IncomeDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IncomeDate', dbo.FormatDate(Deleted.IncomeDate), dbo.FormatDate(Inserted.IncomeDate)
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
and Inserted.IncomeDate <> Deleted.IncomeDate
end

-------------------  IncomeSourcesID  -----------------------------------------------------

if update(IncomeSourcesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IncomeSourcesID', Deleted.IncomeSourcesID, Inserted.IncomeSourcesID
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
and Inserted.IncomeSourcesID <> Deleted.IncomeSourcesID
end

-------------------  PayModesID  -----------------------------------------------------

if update(PayModesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayModesID', Deleted.PayModesID, Inserted.PayModesID
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
and Inserted.PayModesID <> Deleted.PayModesID
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
and Inserted.Amount <> Deleted.Amount
end

-------------------  CurrenciesID  -----------------------------------------------------

if update(CurrenciesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, Inserted.CurrenciesID
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
and Inserted.CurrenciesID <> Deleted.CurrenciesID
end

-------------------  AmountTendered  -----------------------------------------------------

if update(AmountTendered)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountTendered', cast(Deleted.AmountTendered as varchar(20)), cast(Inserted.AmountTendered as varchar(20))
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
and Inserted.AmountTendered <> Deleted.AmountTendered
end

-------------------  ExchangeRate  -----------------------------------------------------

if update(ExchangeRate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExchangeRate', cast(Deleted.ExchangeRate as varchar(20)), cast(Inserted.ExchangeRate as varchar(20))
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
and Inserted.ExchangeRate <> Deleted.ExchangeRate
end

-------------------  Change  -----------------------------------------------------

if update(Change)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Change', cast(Deleted.Change as varchar(20)), cast(Inserted.Change as varchar(20))
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
and Inserted.Change <> Deleted.Change
end

-------------------  DocumentNo  -----------------------------------------------------

if update(DocumentNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, Inserted.DocumentNo
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
and Inserted.DocumentNo <> Deleted.DocumentNo
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.IncomeNo = Deleted.IncomeNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: OtherIncome -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteOtherIncome')
drop trigger utrDeleteOtherIncome
go

create trigger utrDeleteOtherIncome
on OtherIncome
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'OtherIncome' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  IncomeNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IncomeNo', Deleted.IncomeNo, null from Deleted

-------------------  IncomeDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IncomeDate', dbo.FormatDate(Deleted.IncomeDate), null from Deleted

-------------------  IncomeSourcesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IncomeSourcesID', Deleted.IncomeSourcesID, null from Deleted

-------------------  PayModesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayModesID', Deleted.PayModesID, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  CurrenciesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, null from Deleted

-------------------  AmountTendered  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountTendered', cast(Deleted.AmountTendered as varchar(20)), null from Deleted

-------------------  ExchangeRate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExchangeRate', cast(Deleted.ExchangeRate as varchar(20)), null from Deleted

-------------------  Change  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Change', cast(Deleted.Change as varchar(20)), null from Deleted

-------------------  DocumentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Templates ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateTemplates')
drop trigger utrUpdateTemplates
go

create trigger utrUpdateTemplates
on Templates
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Templates' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-TemplateName -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TemplateName', Deleted.TemplateName, Inserted.TemplateName
from Inserted inner join Deleted
on Inserted.TemplateName = Deleted.TemplateName
end

-------------------  TemplateTypeID  -----------------------------------------------------

if update(TemplateTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TemplateTypeID', Deleted.TemplateTypeID, Inserted.TemplateTypeID
from Inserted inner join Deleted
on Inserted.TemplateName = Deleted.TemplateName
and Inserted.TemplateTypeID <> Deleted.TemplateTypeID
end

-------------------  Notes  ----------------------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.TemplateName = Deleted.TemplateName
and Inserted.Notes <> Deleted.Notes
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Templates ---------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteTemplates')
drop trigger utrDeleteTemplates
go

create trigger utrDeleteTemplates
on Templates
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Templates' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  TemplateName  ------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TemplateName', Deleted.TemplateName, null from Deleted

-------------------  TemplateTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TemplateTypeID', Deleted.TemplateTypeID, null from Deleted

-------------------  Notes  --------------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ImportDataInfo ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateImportDataInfo')
drop trigger utrUpdateImportDataInfo
go

create trigger utrUpdateImportDataInfo
on ImportDataInfo
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ImportDataInfo' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.SourceName = Deleted.SourceName
and Inserted.SourceCaption = Deleted.SourceCaption
end

------------------- Key-SourceName -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SourceName', Deleted.SourceName, Inserted.SourceName
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.SourceName = Deleted.SourceName
and Inserted.SourceCaption = Deleted.SourceCaption
end

------------------- Key-SourceCaption -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SourceCaption', Deleted.SourceCaption, Inserted.SourceCaption
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.SourceName = Deleted.SourceName
and Inserted.SourceCaption = Deleted.SourceCaption
end

-------------------  DatabaseTypeID  -----------------------------------------------------

if update(DatabaseTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DatabaseTypeID', Deleted.DatabaseTypeID, Inserted.DatabaseTypeID
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.SourceName = Deleted.SourceName
and Inserted.SourceCaption = Deleted.SourceCaption
and Inserted.DatabaseTypeID <> Deleted.DatabaseTypeID
end

-------------------  ConnectionModeID  -----------------------------------------------------

if update(ConnectionModeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConnectionModeID', Deleted.ConnectionModeID, Inserted.ConnectionModeID
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.SourceName = Deleted.SourceName
and Inserted.SourceCaption = Deleted.SourceCaption
and Inserted.ConnectionModeID <> Deleted.ConnectionModeID
end

-------------------  ImportServer  -----------------------------------------------------

if update(ImportServer)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ImportServer', Deleted.ImportServer, Inserted.ImportServer
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.SourceName = Deleted.SourceName
and Inserted.SourceCaption = Deleted.SourceCaption
and Inserted.ImportServer <> Deleted.ImportServer
end

-------------------  ImportLogin  -----------------------------------------------------

if update(ImportLogin)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ImportLogin', Deleted.ImportLogin, Inserted.ImportLogin
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.SourceName = Deleted.SourceName
and Inserted.SourceCaption = Deleted.SourceCaption
and Inserted.ImportLogin <> Deleted.ImportLogin
end

-------------------  ImportPassword  -----------------------------------------------------

if update(ImportPassword)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ImportPassword', Deleted.ImportPassword, Inserted.ImportPassword
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.SourceName = Deleted.SourceName
and Inserted.SourceCaption = Deleted.SourceCaption
and Inserted.ImportPassword <> Deleted.ImportPassword
end

-------------------  SP_Name  -----------------------------------------------------

if update(SP_Name)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SP_Name', Deleted.SP_Name, Inserted.SP_Name
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.SourceName = Deleted.SourceName
and Inserted.SourceCaption = Deleted.SourceCaption
and Inserted.SP_Name <> Deleted.SP_Name
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ImportDataInfo ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteImportDataInfo')
drop trigger utrDeleteImportDataInfo
go

create trigger utrDeleteImportDataInfo
on ImportDataInfo
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ImportDataInfo' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  SourceName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SourceName', Deleted.SourceName, null from Deleted

-------------------  SourceCaption  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SourceCaption', Deleted.SourceCaption, null from Deleted

-------------------  DatabaseTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DatabaseTypeID', Deleted.DatabaseTypeID, null from Deleted

-------------------  ConnectionModeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConnectionModeID', Deleted.ConnectionModeID, null from Deleted

-------------------  ImportServer  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ImportServer', Deleted.ImportServer, null from Deleted

-------------------  ImportLogin  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ImportLogin', Deleted.ImportLogin, null from Deleted

-------------------  ImportPassword  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ImportPassword', Deleted.ImportPassword, null from Deleted

-------------------  SP_Name  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SP_Name', Deleted.SP_Name, null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: OutwardFiles ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateOutwardFiles')
drop trigger utrUpdateOutwardFiles
go

create trigger utrUpdateOutwardFiles
on OutwardFiles
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(OutwardID)
begin
set @ErrorMSG = 'You can''t update Outward ID for Outward Files, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

if update(OutwardNo)
begin
set @ErrorMSG = 'You can''t update Outward No for Outward Files, transaction cancelled'
raiserror(@ErrorMSG,16,10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'OutwardFiles' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-OutwardNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OutwardNo', Deleted.OutwardNo, Inserted.OutwardNo
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
end

-------------------  FileNo  -----------------------------------------------------

if update(FileNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FileNo', Deleted.FileNo, Inserted.FileNo
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
and Inserted.FileNo <> Deleted.FileNo
end

-------------------  TakenDateTime  -----------------------------------------------------

if update(TakenDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TakenDateTime', dbo.FormatDateTime(Deleted.TakenDateTime), dbo.FormatDateTime(Inserted.TakenDateTime)
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
and Inserted.TakenDateTime <> Deleted.TakenDateTime
end

-------------------  TakenBy  -----------------------------------------------------

if update(TakenBy)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TakenBy', Deleted.TakenBy, Inserted.TakenBy
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
and Inserted.TakenBy <> Deleted.TakenBy
end

-------------------  BillAccountName  -----------------------------------------------------

if update(BillAccountName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillAccountName', Deleted.BillAccountName, Inserted.BillAccountName
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
and Inserted.BillAccountName <> Deleted.BillAccountName
end

-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
and Inserted.VisitNo <> Deleted.VisitNo
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: OutwardFiles ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteOutwardFiles')
drop trigger utrDeleteOutwardFiles
go

create trigger utrDeleteOutwardFiles
on OutwardFiles
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'OutwardFiles' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  OutwardID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OutwardID', Deleted.OutwardID, null from Deleted

-------------------  OutwardNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OutwardNo', Deleted.OutwardNo, null from Deleted

-------------------  FileNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FileNo', Deleted.FileNo, null from Deleted

-------------------  TakenDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TakenDateTime', dbo.FormatDateTime(Deleted.TakenDateTime), null from Deleted

-------------------  TakenBy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TakenBy', Deleted.TakenBy, null from Deleted

-------------------  BillAccountName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillAccountName', Deleted.BillAccountName, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: InwardFiles -------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInwardFiles')
drop trigger utrUpdateInwardFiles
go

create trigger utrUpdateInwardFiles
on InwardFiles
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InwardFiles' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-OutwardNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OutwardNo', Deleted.OutwardNo, Inserted.OutwardNo
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
end

-------------------  ReturnDateTime  -----------------------------------------------------

if update(ReturnDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnDateTime', dbo.FormatDateTime(Deleted.ReturnDateTime), dbo.FormatDateTime(Inserted.ReturnDateTime)
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
and Inserted.ReturnDateTime <> Deleted.ReturnDateTime
end

-------------------  ReturnedBy  -----------------------------------------------------

if update(ReturnedBy)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnedBy', Deleted.ReturnedBy, Inserted.ReturnedBy
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
and Inserted.ReturnedBy <> Deleted.ReturnedBy
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.OutwardNo = Deleted.OutwardNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: InwardFiles ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInwardFiles')
drop trigger utrDeleteInwardFiles
go

create trigger utrDeleteInwardFiles
on InwardFiles
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InwardFiles' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  OutwardNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OutwardNo', Deleted.OutwardNo, null from Deleted

-------------------  ReturnDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnDateTime', dbo.FormatDateTime(Deleted.ReturnDateTime), null from Deleted

-------------------  ReturnedBy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnedBy', Deleted.ReturnedBy, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: PurchaseOrders ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePurchaseOrders')
drop trigger utrUpdatePurchaseOrders
go

create trigger utrUpdatePurchaseOrders
on PurchaseOrders
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(PurchaseOrderID)
begin
set @ErrorMSG = 'You can''t update Purchase Order ID for Orders, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(PurchaseOrderNo)
begin
set @ErrorMSG = 'You can''t update Purchase Order No for Orders, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PurchaseOrders' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-PurchaseOrderNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PurchaseOrderNo', Deleted.PurchaseOrderNo, Inserted.PurchaseOrderNo
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
end

-------------------  PurchaseOrderID  -----------------------------------------------------

if update(PurchaseOrderID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PurchaseOrderID', Deleted.PurchaseOrderID, Inserted.PurchaseOrderID
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.PurchaseOrderID <> Deleted.PurchaseOrderID
end

-------------------  OrderDate  -----------------------------------------------------

if update(OrderDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderDate', dbo.FormatDate(Deleted.OrderDate), dbo.FormatDate(Inserted.OrderDate)
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.OrderDate <> Deleted.OrderDate
end

-------------------  DocumentNo  -----------------------------------------------------

if update(DocumentNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, Inserted.DocumentNo
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.DocumentNo <> Deleted.DocumentNo
end

-------------------  SupplierNo  -----------------------------------------------------

if update(SupplierNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SupplierNo', Deleted.SupplierNo, Inserted.SupplierNo
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.SupplierNo <> Deleted.SupplierNo
end

-------------------  ShipAddress  -----------------------------------------------------

if update(ShipAddress)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ShipAddress', Deleted.ShipAddress, Inserted.ShipAddress
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ShipAddress <> Deleted.ShipAddress
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: PurchaseOrders ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePurchaseOrders')
drop trigger utrDeletePurchaseOrders
go

create trigger utrDeletePurchaseOrders
on PurchaseOrders
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PurchaseOrders' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PurchaseOrderID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PurchaseOrderID', Deleted.PurchaseOrderID, null from Deleted

-------------------  PurchaseOrderNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PurchaseOrderNo', Deleted.PurchaseOrderNo, null from Deleted

-------------------  OrderDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderDate', dbo.FormatDate(Deleted.OrderDate), null from Deleted

-------------------  DocumentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, null from Deleted

-------------------  SupplierNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SupplierNo', Deleted.SupplierNo, null from Deleted

-------------------  ShipAddress  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ShipAddress', Deleted.ShipAddress, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: PurchaseOrderDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePurchaseOrderDetails')
drop trigger utrUpdatePurchaseOrderDetails
go

create trigger utrUpdatePurchaseOrderDetails
on PurchaseOrderDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PurchaseOrderDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-PurchaseOrderNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PurchaseOrderNo', Deleted.PurchaseOrderNo, Inserted.PurchaseOrderNo
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

-------------------  ItemName  -----------------------------------------------------

if update(ItemName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemName <> Deleted.ItemName
end

-------------------  UnitMeasure  -----------------------------------------------------

if update(UnitMeasure)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, Inserted.UnitMeasure
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.UnitMeasure <> Deleted.UnitMeasure
end

-------------------  ItemGroup  -----------------------------------------------------

if update(ItemGroup)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemGroup', Deleted.ItemGroup, Inserted.ItemGroup
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemGroup <> Deleted.ItemGroup
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Rate  -----------------------------------------------------

if update(Rate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Rate', cast(Deleted.Rate as varchar(20)), cast(Inserted.Rate as varchar(20))
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Rate <> Deleted.Rate
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Amount <> Deleted.Amount
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Notes <> Deleted.Notes
end

-------------------  StockStatusID  -----------------------------------------------------

if update(StockStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StockStatusID', Deleted.StockStatusID, Inserted.StockStatusID
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.StockStatusID <> Deleted.StockStatusID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.PurchaseOrderNo = Deleted.PurchaseOrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: PurchaseOrderDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePurchaseOrderDetails')
drop trigger utrDeletePurchaseOrderDetails
go

create trigger utrDeletePurchaseOrderDetails
on PurchaseOrderDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PurchaseOrderDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PurchaseOrderNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PurchaseOrderNo', Deleted.PurchaseOrderNo, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  UnitMeasure  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, null from Deleted

-------------------  ItemGroup  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemGroup', Deleted.ItemGroup, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Rate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Rate', cast(Deleted.Rate as varchar(20)), null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  StockStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StockStatusID', Deleted.StockStatusID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: GoodsReceivedNote -------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateGoodsReceivedNote')
drop trigger utrUpdateGoodsReceivedNote
go

create trigger utrUpdateGoodsReceivedNote
on GoodsReceivedNote
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(GRNID)
begin
set @ErrorMSG = 'You can''t update GRN ID for Goods Received Note, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(GRNNo)
begin
set @ErrorMSG = 'You can''t update GRN No for Goods Received Note, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'GoodsReceivedNote' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-GRNNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GRNNo', Deleted.GRNNo, Inserted.GRNNo
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
end

-------------------  GRNID  -----------------------------------------------------

if update(GRNID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GRNID', Deleted.GRNID, Inserted.GRNID
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.GRNID <> Deleted.GRNID
end

-------------------  PurchaseOrderNo  -----------------------------------------------------

if update(PurchaseOrderNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PurchaseOrderNo', Deleted.PurchaseOrderNo, Inserted.PurchaseOrderNo
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.PurchaseOrderNo <> Deleted.PurchaseOrderNo
end

-------------------  ReceivedDate  -----------------------------------------------------

if update(ReceivedDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceivedDate', dbo.FormatDate(Deleted.ReceivedDate), dbo.FormatDate(Inserted.ReceivedDate)
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ReceivedDate <> Deleted.ReceivedDate
end

-------------------  AdviceNoteNo  -----------------------------------------------------

if update(AdviceNoteNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdviceNoteNo', Deleted.AdviceNoteNo, Inserted.AdviceNoteNo
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.AdviceNoteNo <> Deleted.AdviceNoteNo
end

-------------------  DeliveryLocationID  -----------------------------------------------------

if update(DeliveryLocationID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DeliveryLocationID', Deleted.DeliveryLocationID, Inserted.DeliveryLocationID
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.DeliveryLocationID <> Deleted.DeliveryLocationID
end

-------------------  DiscountTotal  -----------------------------------------------------

if update(DiscountTotal)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiscountTotal', cast(Deleted.DiscountTotal as varchar(20)), cast(Inserted.DiscountTotal as varchar(20))
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.DiscountTotal <> Deleted.DiscountTotal
end

-------------------  TotalVAT  -----------------------------------------------------

if update(TotalVAT)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TotalVAT', Deleted.TotalVAT, Inserted.TotalVAT
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.TotalVAT <> Deleted.TotalVAT
end

-------------------  AmountWords  -----------------------------------------------------

if update(AmountWords)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountWords', Deleted.AmountWords, Inserted.AmountWords
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.AmountWords <> Deleted.AmountWords
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: GoodsReceivedNote -------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteGoodsReceivedNote')
drop trigger utrDeleteGoodsReceivedNote
go

create trigger utrDeleteGoodsReceivedNote
on GoodsReceivedNote
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'GoodsReceivedNote' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  GRNID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GRNID', Deleted.GRNID, null from Deleted

-------------------  GRNNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GRNNo', Deleted.GRNNo, null from Deleted

-------------------  PurchaseOrderNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PurchaseOrderNo', Deleted.PurchaseOrderNo, null from Deleted

-------------------  ReceivedDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceivedDate', dbo.FormatDate(Deleted.ReceivedDate), null from Deleted

-------------------  AdviceNoteNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdviceNoteNo', Deleted.AdviceNoteNo, null from Deleted

-------------------  DeliveryLocationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DeliveryLocationID', Deleted.DeliveryLocationID, null from Deleted

-------------------  DiscountTotal  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiscountTotal', cast(Deleted.DiscountTotal as varchar(20)), null from Deleted

-------------------  TotalVAT  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TotalVAT', Deleted.TotalVAT, null from Deleted

-------------------  AmountWords  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountWords', Deleted.AmountWords, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: GoodsReceivedNoteDetails ------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateGoodsReceivedNoteDetails')
drop trigger utrUpdateGoodsReceivedNoteDetails
go

create trigger utrUpdateGoodsReceivedNoteDetails
on GoodsReceivedNoteDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'GoodsReceivedNoteDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-GRNNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GRNNo', Deleted.GRNNo, Inserted.GRNNo
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

-------------------  ItemName  -----------------------------------------------------

if update(ItemName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemName <> Deleted.ItemName
end

-------------------  UnitMeasure  -----------------------------------------------------

if update(UnitMeasure)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, Inserted.UnitMeasure
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.UnitMeasure <> Deleted.UnitMeasure
end

-------------------  OrderedQuantity  -----------------------------------------------------

if update(OrderedQuantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderedQuantity', Deleted.OrderedQuantity, Inserted.OrderedQuantity
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.OrderedQuantity <> Deleted.OrderedQuantity
end

-------------------  ReceivedQuantity  -----------------------------------------------------

if update(ReceivedQuantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceivedQuantity', Deleted.ReceivedQuantity, Inserted.ReceivedQuantity
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ReceivedQuantity <> Deleted.ReceivedQuantity
end

-------------------  BonusQuantity  -----------------------------------------------------

if update(BonusQuantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BonusQuantity', Deleted.BonusQuantity, Inserted.BonusQuantity
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.BonusQuantity <> Deleted.BonusQuantity
end

-------------------  Rate  -----------------------------------------------------

if update(Rate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Rate', cast(Deleted.Rate as varchar(20)), cast(Inserted.Rate as varchar(20))
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Rate <> Deleted.Rate
end

-------------------  Discount  -----------------------------------------------------

if update(Discount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Discount', cast(Deleted.Discount as varchar(20)), cast(Inserted.Discount as varchar(20))
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Discount <> Deleted.Discount
end

-------------------  VATValue  --------------------------------------------------------------------

if update(VATValue)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATValue', cast(Deleted.VATValue as varchar(20)), cast(Inserted.VATValue as varchar(20))
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.VATValue <> Deleted.VATValue
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Amount <> Deleted.Amount
end

-------------------  BatchNo  -----------------------------------------------------

if update(BatchNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BatchNo', Deleted.BatchNo, Inserted.BatchNo
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.BatchNo <> Deleted.BatchNo
end

-------------------  ExpiryDate  -----------------------------------------------------

if update(ExpiryDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpiryDate', dbo.FormatDate(Deleted.ExpiryDate), dbo.FormatDate(Inserted.ExpiryDate)
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ExpiryDate <> Deleted.ExpiryDate
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.GRNNo = Deleted.GRNNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: GoodsReceivedNoteDetails ------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteGoodsReceivedNoteDetails')
drop trigger utrDeleteGoodsReceivedNoteDetails
go

create trigger utrDeleteGoodsReceivedNoteDetails
on GoodsReceivedNoteDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'GoodsReceivedNoteDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  GRNNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GRNNo', Deleted.GRNNo, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  UnitMeasure  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, null from Deleted

-------------------  OrderedQuantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderedQuantity', Deleted.OrderedQuantity, null from Deleted

-------------------  ReceivedQuantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceivedQuantity', Deleted.ReceivedQuantity, null from Deleted

-------------------  BonusQuantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BonusQuantity', Deleted.BonusQuantity, null from Deleted

-------------------  Rate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Rate', cast(Deleted.Rate as varchar(20)), null from Deleted

-------------------  Discount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Discount', cast(Deleted.Discount as varchar(20)), null from Deleted


-------------------  VATValue  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VATValue', cast(Deleted.VATValue as varchar(20)), null from Deleted
-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  BatchNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BatchNo', Deleted.BatchNo, null from Deleted

-------------------  ExpiryDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpiryDate', dbo.FormatDate(Deleted.ExpiryDate), null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: InventoryOrders ---------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInventoryOrders')
drop trigger utrUpdateInventoryOrders
go

create trigger utrUpdateInventoryOrders
on InventoryOrders
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(OrderID)
begin
set @ErrorMSG = 'You can''t update Order ID for Orders, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(OrderNo)
begin
set @ErrorMSG = 'You can''t update Order No for Orders, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InventoryOrders' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-OrderNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderNo', Deleted.OrderNo, Inserted.OrderNo
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
end

-------------------  OrderDate  -----------------------------------------------------

if update(OrderDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderDate', dbo.FormatDate(Deleted.OrderDate), dbo.FormatDate(Inserted.OrderDate)
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.OrderDate <> Deleted.OrderDate
end

-------------------  FromLocationID  -----------------------------------------------------

if update(FromLocationID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FromLocationID', Deleted.FromLocationID, Inserted.FromLocationID
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.FromLocationID <> Deleted.FromLocationID
end

-------------------  ToLocationID  -----------------------------------------------------

if update(ToLocationID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ToLocationID', Deleted.ToLocationID, Inserted.ToLocationID
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.ToLocationID <> Deleted.ToLocationID
end

-------------------  TransferReasonID  -----------------------------------------------------

if update(TransferReasonID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FromLocationID', Deleted.TransferReasonID, Inserted.TransferReasonID
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.TransferReasonID <> Deleted.TransferReasonID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: InventoryOrders ---------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInventoryOrders')
drop trigger utrDeleteInventoryOrders
go

create trigger utrDeleteInventoryOrders
on InventoryOrders
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InventoryOrders' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  OrderNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderNo', Deleted.OrderNo, null from Deleted

-------------------  OrderDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderDate', dbo.FormatDate(Deleted.OrderDate), null from Deleted

-------------------  FromLocationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FromLocationID', Deleted.FromLocationID, null from Deleted

-------------------  ToLocationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ToLocationID', Deleted.ToLocationID, null from Deleted

-------------------  TransferReasonID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransferReasonID', Deleted.TransferReasonID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: InventoryOrderDetails ---------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInventoryOrderDetails')
drop trigger utrUpdateInventoryOrderDetails
go

create trigger utrUpdateInventoryOrderDetails
on InventoryOrderDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InventoryOrderDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-OrderNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderNo', Deleted.OrderNo, Inserted.OrderNo
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  ItemStatusID  -----------------------------------------------------

if update(ItemStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemStatusID', Deleted.ItemStatusID, Inserted.ItemStatusID
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemStatusID <> Deleted.ItemStatusID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.OrderNo = Deleted.OrderNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: InventoryOrderDetails ---------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInventoryOrderDetails')
drop trigger utrDeleteInventoryOrderDetails
go

create trigger utrDeleteInventoryOrderDetails
on InventoryOrderDetails
for delete
as

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ---------------------------------------------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InventoryOrderDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  OrderNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderNo', Deleted.OrderNo, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  ItemStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemStatusID', Deleted.ItemStatusID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: InventoryTransfers ------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInventoryTransfers')
drop trigger utrUpdateInventoryTransfers
go

create trigger utrUpdateInventoryTransfers
on InventoryTransfers
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(TransferID)
begin
set @ErrorMSG = 'You can''t update Transfer ID for Transfers, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(TransferNo)
begin
set @ErrorMSG = 'You can''t update Transfer No for Transfers, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InventoryTransfers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-TransferNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransferNo', Deleted.TransferNo, Inserted.TransferNo
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
end

-------------------  TransferDate  -----------------------------------------------------

if update(TransferDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransferDate', dbo.FormatDate(Deleted.TransferDate), dbo.FormatDate(Inserted.TransferDate)
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.TransferDate <> Deleted.TransferDate
end

-------------------  FromLocationID  -----------------------------------------------------

if update(FromLocationID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FromLocationID', Deleted.FromLocationID, Inserted.FromLocationID
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.FromLocationID <> Deleted.FromLocationID
end

-------------------  ToLocationID  -----------------------------------------------------

if update(ToLocationID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ToLocationID', Deleted.ToLocationID, Inserted.ToLocationID
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ToLocationID <> Deleted.ToLocationID
end


-------------------  OrderNo  -----------------------------------------------------

if update(OrderNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderNo', Deleted.OrderNo, Inserted.OrderNo
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.OrderNo <> Deleted.OrderNo
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: InventoryTransfers ------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInventoryTransfers')
drop trigger utrDeleteInventoryTransfers
go

create trigger utrDeleteInventoryTransfers
on InventoryTransfers
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InventoryTransfers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  TransferNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransferNo', Deleted.TransferNo, null from Deleted

-------------------  TransferDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransferDate', dbo.FormatDate(Deleted.TransferDate), null from Deleted

-------------------  FromLocationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FromLocationID', Deleted.FromLocationID, null from Deleted

-------------------  ToLocationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ToLocationID', Deleted.ToLocationID, null from Deleted

-------------------  OrderNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrderNo', Deleted.OrderNo, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: InventoryTransferDetails ------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInventoryTransferDetails')
drop trigger utrUpdateInventoryTransferDetails
go

create trigger utrUpdateInventoryTransferDetails
on InventoryTransferDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InventoryTransferDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-TransferNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransferNo', Deleted.TransferNo, Inserted.TransferNo
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Quantity <> Deleted.Quantity
end 

-------------------  BatchNo  -----------------------------------------------------

if update(BatchNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BatchNo', Deleted.BatchNo, Inserted.BatchNo
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.BatchNo <> Deleted.BatchNo
end

-------------------  ExpiryDate  -----------------------------------------------------

if update(ExpiryDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpiryDate', dbo.FormatDate(Deleted.ExpiryDate), dbo.FormatDate(Inserted.ExpiryDate)
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ExpiryDate <> Deleted.ExpiryDate
end

-------------------  StockStatusID  -----------------------------------------------------

if update(StockStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StockStatusID', Deleted.StockStatusID, Inserted.StockStatusID
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.StockStatusID <> Deleted.StockStatusID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: InventoryTransferDetails ------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInventoryTransferDetails')
drop trigger utrDeleteInventoryTransferDetails
go

create trigger utrDeleteInventoryTransferDetails
on InventoryTransferDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InventoryTransferDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  TransferNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransferNo', Deleted.TransferNo, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  BatchNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BatchNo', Deleted.BatchNo, null from Deleted

-------------------  ExpiryDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpiryDate', dbo.FormatDate(Deleted.ExpiryDate), null from Deleted

-------------------  StockStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StockStatusID', Deleted.StockStatusID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: IPDEyeAssessment ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDEyeAssessment')
drop trigger utrUpdateIPDEyeAssessment
go
create trigger utrUpdateIPDEyeAssessment
on IPDEyeAssessment
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDEyeAssessment' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RoundNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
end

-------------------  LeftPupil  -----------------------------------------------------

if update(LeftPupil)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftPupil', Deleted.LeftPupil, Inserted.LeftPupil
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftPupil <> Deleted.LeftPupil
end

-------------------  RightPupil  -----------------------------------------------------

if update(RightPupil)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightPupil', Deleted.RightPupil, Inserted.RightPupil
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightPupil <> Deleted.RightPupil
end

-------------------  LeftLidMargin  -----------------------------------------------------

if update(LeftLidMargin)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftLidMargin', Deleted.LeftLidMargin, Inserted.LeftLidMargin
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftLidMargin <> Deleted.LeftLidMargin
end

-------------------  RightLidMargin  -----------------------------------------------------

if update(RightLidMargin)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightLidMargin', Deleted.RightLidMargin, Inserted.RightLidMargin
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightLidMargin <> Deleted.RightLidMargin
end

-------------------  LeftConjuctiva  -----------------------------------------------------

if update(LeftConjuctiva)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftConjuctiva', Deleted.LeftConjuctiva, Inserted.LeftConjuctiva
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftConjuctiva <> Deleted.LeftConjuctiva
end

-------------------  RightConjuctiva  -----------------------------------------------------

if update(RightConjuctiva)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightConjuctiva', Deleted.RightConjuctiva, Inserted.RightConjuctiva
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightConjuctiva <> Deleted.RightConjuctiva
end

-------------------  LeftBulbarConjuctiva  -----------------------------------------------------

if update(LeftBulbarConjuctiva)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftBulbarConjuctiva', Deleted.LeftBulbarConjuctiva, Inserted.LeftBulbarConjuctiva
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftBulbarConjuctiva <> Deleted.LeftBulbarConjuctiva
end

-------------------  RightBulbarConjuctiva  -----------------------------------------------------

if update(RightBulbarConjuctiva)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightBulbarConjuctiva', Deleted.RightBulbarConjuctiva, Inserted.RightBulbarConjuctiva
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightBulbarConjuctiva <> Deleted.RightBulbarConjuctiva
end

-------------------  LeftCentralCornea  -----------------------------------------------------

if update(LeftCentralCornea)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftCentralCornea', Deleted.LeftCentralCornea, Inserted.LeftCentralCornea
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftCentralCornea <> Deleted.LeftCentralCornea
end

-------------------  RightCentralCornea  -----------------------------------------------------

if update(RightCentralCornea)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightCentralCornea', Deleted.RightCentralCornea, Inserted.RightCentralCornea
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightCentralCornea <> Deleted.RightCentralCornea
end

-------------------  LeftVerticalCornea  -----------------------------------------------------

if update(LeftVerticalCornea)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftVerticalCornea', Deleted.LeftVerticalCornea, Inserted.LeftVerticalCornea
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftVerticalCornea <> Deleted.LeftVerticalCornea
end

-------------------  RightVerticalCornea  -----------------------------------------------------

if update(RightVerticalCornea)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightVerticalCornea', Deleted.RightVerticalCornea, Inserted.RightVerticalCornea
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightVerticalCornea <> Deleted.RightVerticalCornea
end

-------------------  LeftAnteriorChamber  -----------------------------------------------------

if update(LeftAnteriorChamber)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAnteriorChamber', Deleted.LeftAnteriorChamber, Inserted.LeftAnteriorChamber
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftAnteriorChamber <> Deleted.LeftAnteriorChamber
end

-------------------  RightAnteriorChamber  -----------------------------------------------------

if update(RightAnteriorChamber)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAnteriorChamber', Deleted.RightAnteriorChamber, Inserted.RightAnteriorChamber
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightAnteriorChamber <> Deleted.RightAnteriorChamber
end

-------------------  LeftIrish  -----------------------------------------------------

if update(LeftIrish)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftIrish', Deleted.LeftIrish, Inserted.LeftIrish
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftIrish <> Deleted.LeftIrish
end

-------------------  RightIrish  -----------------------------------------------------

if update(RightIrish)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightIrish', Deleted.RightIrish, Inserted.RightIrish
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightIrish <> Deleted.RightIrish
end

-------------------  LeftAnteriorChamberAngle  -----------------------------------------------------

if update(LeftAnteriorChamberAngle)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAnteriorChamberAngle', Deleted.LeftAnteriorChamberAngle, Inserted.LeftAnteriorChamberAngle
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftAnteriorChamberAngle <> Deleted.LeftAnteriorChamberAngle
end

-------------------  RightAnteriorChamberAngle  -----------------------------------------------------

if update(RightAnteriorChamberAngle)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAnteriorChamberAngle', Deleted.RightAnteriorChamberAngle, Inserted.RightAnteriorChamberAngle
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightAnteriorChamberAngle <> Deleted.RightAnteriorChamberAngle
end

-------------------  LeftRetina  -----------------------------------------------------

if update(LeftRetina)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftRetina', Deleted.LeftRetina, Inserted.LeftRetina
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftRetina <> Deleted.LeftRetina
end

-------------------  RightRetina  -----------------------------------------------------

if update(RightRetina)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightRetina', Deleted.RightRetina, Inserted.RightRetina
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightRetina <> Deleted.RightRetina
end

-------------------  LeftMacular  -----------------------------------------------------

if update(LeftMacular)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftMacular', Deleted.LeftMacular, Inserted.LeftMacular
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftMacular <> Deleted.LeftMacular
end

-------------------  RightMacular  -----------------------------------------------------

if update(RightMacular)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightMacular', Deleted.RightMacular, Inserted.RightMacular
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightMacular <> Deleted.RightMacular
end

-------------------  LeftOpticDisc  -----------------------------------------------------

if update(LeftOpticDisc)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftOpticDisc', Deleted.LeftOpticDisc, Inserted.LeftOpticDisc
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftOpticDisc <> Deleted.LeftOpticDisc
end

-------------------  RightOpticDisc  -----------------------------------------------------

if update(RightOpticDisc)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightOpticDisc', Deleted.RightOpticDisc, Inserted.RightOpticDisc
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightOpticDisc <> Deleted.RightOpticDisc
end

-------------------  LeftIOP  -----------------------------------------------------

if update(LeftIOP)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftIOP', Deleted.LeftIOP, Inserted.LeftIOP
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftIOP <> Deleted.LeftIOP
end

-------------------  RightIOP  -----------------------------------------------------

if update(RightIOP)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightIOP', Deleted.RightIOP, Inserted.RightIOP
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightIOP <> Deleted.RightIOP
end

-------------------  LeftVitreous  -----------------------------------------------------

if update(LeftVitreous)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftVitreous', Deleted.LeftVitreous, Inserted.LeftVitreous
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftVitreous <> Deleted.LeftVitreous
end

-------------------  RightVitreous  -----------------------------------------------------

if update(RightVitreous)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightVitreous', Deleted.RightVitreous, Inserted.RightVitreous
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightVitreous <> Deleted.RightVitreous
end

-------------------  LeftLense  -----------------------------------------------------

if update(LeftLense)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftLense', Deleted.LeftLense, Inserted.LeftLense
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftLense <> Deleted.LeftLense
end

-------------------  RightLense  -----------------------------------------------------

if update(RightLense)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightLense', Deleted.RightLense, Inserted.RightLense
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightLense <> Deleted.RightLense
end

-------------------  EyeNotes  -----------------------------------------------------

if update(EyeNotes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EyeNotes', Deleted.EyeNotes, Inserted.EyeNotes
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.EyeNotes <> Deleted.EyeNotes
end

-------------------  LeftEyeBall  -----------------------------------------------------

if update(LeftEyeBall)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftEyeBall', Deleted.LeftEyeBall, Inserted.LeftEyeBall
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftEyeBall <> Deleted.LeftEyeBall
end

-------------------  RightEyeBall  -----------------------------------------------------

if update(RightEyeBall)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightEyeBall', Deleted.RightEyeBall, Inserted.RightEyeBall
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightEyeBall <> Deleted.RightEyeBall
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end

-------------------  LeftOrbit  -----------------------------------------------------

if update(LeftOrbit)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftOrbit', Deleted.LeftOrbit, Inserted.LeftOrbit
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftOrbit <> Deleted.LeftOrbit
end

-------------------  RightOrbit  -----------------------------------------------------

if update(RightOrbit)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightOrbit', Deleted.RightOrbit, Inserted.RightOrbit
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightOrbit <> Deleted.RightOrbit
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LoginID <> Deleted.LoginID
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: IPDEyeAssessment ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDEyeAssessment')
drop trigger utrDeleteIPDEyeAssessment
go

create trigger utrDeleteIPDEyeAssessment
on IPDEyeAssessment
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDEyeAssessment' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  LeftPupil  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftPupil', Deleted.LeftPupil, null from Deleted

-------------------  RightPupil  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightPupil', Deleted.RightPupil, null from Deleted

-------------------  LeftLidMargin  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftLidMargin', Deleted.LeftLidMargin, null from Deleted

-------------------  RightLidMargin  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightLidMargin', Deleted.RightLidMargin, null from Deleted

-------------------  LeftConjuctiva  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftConjuctiva', Deleted.LeftConjuctiva, null from Deleted

-------------------  RightConjuctiva  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightConjuctiva', Deleted.RightConjuctiva, null from Deleted

-------------------  LeftBulbarConjuctiva  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftBulbarConjuctiva', Deleted.LeftBulbarConjuctiva, null from Deleted

-------------------  RightBulbarConjuctiva  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightBulbarConjuctiva', Deleted.RightBulbarConjuctiva, null from Deleted

-------------------  LeftCentralCornea  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftCentralCornea', Deleted.LeftCentralCornea, null from Deleted

-------------------  RightCentralCornea  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightCentralCornea', Deleted.RightCentralCornea, null from Deleted

-------------------  LeftVerticalCornea  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftVerticalCornea', Deleted.LeftVerticalCornea, null from Deleted

-------------------  RightVerticalCornea  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightVerticalCornea', Deleted.RightVerticalCornea, null from Deleted

-------------------  LeftAnteriorChamber  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAnteriorChamber', Deleted.LeftAnteriorChamber, null from Deleted

-------------------  RightAnteriorChamber  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAnteriorChamber', Deleted.RightAnteriorChamber, null from Deleted

-------------------  LeftIrish  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftIrish', Deleted.LeftIrish, null from Deleted

-------------------  RightIrish  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightIrish', Deleted.RightIrish, null from Deleted

-------------------  LeftAnteriorChamberAngle  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAnteriorChamberAngle', Deleted.LeftAnteriorChamberAngle, null from Deleted

-------------------  RightAnteriorChamberAngle  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAnteriorChamberAngle', Deleted.RightAnteriorChamberAngle, null from Deleted

-------------------  LeftRetina  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftRetina', Deleted.LeftRetina, null from Deleted

-------------------  RightRetina  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightRetina', Deleted.RightRetina, null from Deleted

-------------------  LeftMacular  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftMacular', Deleted.LeftMacular, null from Deleted

-------------------  RightMacular  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightMacular', Deleted.RightMacular, null from Deleted

-------------------  LeftOpticDisc  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftOpticDisc', Deleted.LeftOpticDisc, null from Deleted

-------------------  RightOpticDisc  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightOpticDisc', Deleted.RightOpticDisc, null from Deleted

-------------------  LeftIOP  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftIOP', Deleted.LeftIOP, null from Deleted

-------------------  RightIOP  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightIOP', Deleted.RightIOP, null from Deleted

-------------------  LeftVitreous  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftVitreous', Deleted.LeftVitreous, null from Deleted

-------------------  RightVitreous  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightVitreous', Deleted.RightVitreous, null from Deleted

-------------------  LeftLense  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftLense', Deleted.LeftLense, null from Deleted

-------------------  RightLense  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightLense', Deleted.RightLense, null from Deleted

-------------------  EyeNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EyeNotes', Deleted.EyeNotes, null from Deleted

-------------------  LeftEyeBall  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftEyeBall', Deleted.LeftEyeBall, null from Deleted

-------------------  RightEyeBall  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightEyeBall', Deleted.RightEyeBall, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted

-------------------  LeftOrbit  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftOrbit', Deleted.LeftOrbit, null from Deleted

-------------------  RightOrbit  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightOrbit', Deleted.RightOrbit, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted
go
------------------------------------------------------------------------------------------------------
-------------- Update: IPDVisionAssessment ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDVisionAssessment')
drop trigger utrUpdateIPDVisionAssessment
go

create trigger utrUpdateIPDVisionAssessment
on IPDVisionAssessment
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return
if update(VARoundID)
begin
set @ErrorMSG = 'You can''t update Patient ID for Patients, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(VARoundNo)
begin
set @ErrorMSG = 'You can''t update Patient No for Patients, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDVisionAssessment' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VARoundNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VARoundNo', Deleted.VARoundNo, Inserted.VARoundNo
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
end

------------------- Key-EyeTestID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EyeTestID', Deleted.EyeTestID, Inserted.EyeTestID
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
end

-------------------  VARoundID  -----------------------------------------------------

if update(VARoundID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VARoundID', Deleted.VARoundID, Inserted.VARoundID
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.VARoundID <> Deleted.VARoundID
end

-------------------  AdmissionNo  -----------------------------------------------------

if update(AdmissionNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionNo', Deleted.AdmissionNo, Inserted.AdmissionNo
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.AdmissionNo <> Deleted.AdmissionNo
end

-------------------  RoundDateTime  -----------------------------------------------------

if update(RoundDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundDateTime', dbo.FormatDate(Deleted.RoundDateTime), dbo.FormatDate(Inserted.RoundDateTime)
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.RoundDateTime <> Deleted.RoundDateTime
end
-------------------  VisualAcuityRightID  -----------------------------------------------------

if update(VisualAcuityRightID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityRightID', Deleted.VisualAcuityRightID, Inserted.VisualAcuityRightID
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.VisualAcuityRightID <> Deleted.VisualAcuityRightID
end

-------------------  VisualAcuityRightExtID  -----------------------------------------------------

if update(VisualAcuityRightExtID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityRightExtID', Deleted.VisualAcuityRightExtID, Inserted.VisualAcuityRightExtID
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.VisualAcuityRightExtID <> Deleted.VisualAcuityRightExtID
end

-------------------  VisualAcuityLeftID  -----------------------------------------------------

if update(VisualAcuityLeftID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityLeftID', Deleted.VisualAcuityLeftID, Inserted.VisualAcuityLeftID
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.VisualAcuityLeftID <> Deleted.VisualAcuityLeftID
end

-------------------  VisualAcuityLeftExtID  -----------------------------------------------------

if update(VisualAcuityLeftExtID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityLeftExtID', Deleted.VisualAcuityLeftExtID, Inserted.VisualAcuityLeftExtID
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.VisualAcuityLeftExtID <> Deleted.VisualAcuityLeftExtID
end



-------------------  PreferentialLookingRightID  -----------------------------------------------------

if update(PreferentialLookingRightID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreferentialLookingRightID', Deleted.PreferentialLookingRightID, Inserted.PreferentialLookingRightID
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.PreferentialLookingRightID <> Deleted.PreferentialLookingRightID
end

-------------------  PreferentialLookingLeftID  -----------------------------------------------------

if update(PreferentialLookingLeftID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreferentialLookingLeftID', Deleted.PreferentialLookingLeftID, Inserted.PreferentialLookingLeftID
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.PreferentialLookingLeftID <> Deleted.PreferentialLookingLeftID
end


-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VARoundNo = Deleted.VARoundNo
and Inserted.EyeTestID = Deleted.EyeTestID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: IPDVisionAssessment ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDVisionAssessment')
drop trigger utrDeleteIPDVisionAssessment
go

create trigger utrDeleteIPDVisionAssessment
on IPDVisionAssessment
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDVisionAssessment' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VARoundID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VARoundID', Deleted.VARoundID, null from Deleted

-------------------  AdmissionNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdmissionNo', Deleted.AdmissionNo, null from Deleted
-------------------  RoundDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundDateTime', dbo.FormatDate(Deleted.RoundDateTime), null from Deleted

-------------------  VARoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VARoundNo', Deleted.VARoundNo, null from Deleted

-------------------  EyeTestID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EyeTestID', Deleted.EyeTestID, null from Deleted

-------------------  VisualAcuityRightID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityRightID', Deleted.VisualAcuityRightID, null from Deleted

-------------------  VisualAcuityRightExtID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityRightExtID', Deleted.VisualAcuityRightExtID, null from Deleted

-------------------  VisualAcuityLeftID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityLeftID', Deleted.VisualAcuityLeftID, null from Deleted

-------------------  VisualAcuityLeftExtID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualAcuityLeftExtID', Deleted.VisualAcuityLeftExtID, null from Deleted


-------------------  PreferentialLookingRightID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreferentialLookingRightID', Deleted.PreferentialLookingRightID, null from Deleted

-------------------  PreferentialLookingLeftID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreferentialLookingLeftID', Deleted.PreferentialLookingLeftID, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: IPDOrthoptics ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDOrthoptics')
drop trigger utrUpdateIPDOrthoptics
go

create trigger utrUpdateIPDOrthoptics
on IPDOrthoptics
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDOrthoptics' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RoundNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
end

-------------------  HeadPosture  -----------------------------------------------------

if update(HeadPosture)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeadPosture', Deleted.HeadPosture, Inserted.HeadPosture
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.HeadPosture <> Deleted.HeadPosture
end

-------------------  Fixation  -----------------------------------------------------

if update(Fixation)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Fixation', Deleted.Fixation, Inserted.Fixation
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.Fixation <> Deleted.Fixation
end

-------------------  LeftHirschberg  -----------------------------------------------------

if update(LeftHirschberg)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftHirschberg', Deleted.LeftHirschberg, Inserted.LeftHirschberg
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftHirschberg <> Deleted.LeftHirschberg
end

-------------------  RightHirschberg  -----------------------------------------------------

if update(RightHirschberg)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightHirschberg', Deleted.RightHirschberg, Inserted.RightHirschberg
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightHirschberg <> Deleted.RightHirschberg
end

-------------------  RightEOM  -----------------------------------------------------

if update(RightEOM)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightEOM', Deleted.RightEOM, Inserted.RightEOM
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightEOM <> Deleted.RightEOM
end

-------------------  LeftEOM  -----------------------------------------------------

if update(LeftEOM)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftEOM', Deleted.LeftEOM, Inserted.LeftEOM
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftEOM <> Deleted.LeftEOM
end

-------------------  CoverTestID  -----------------------------------------------------

if update(CoverTestID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoverTestID', Deleted.CoverTestID, Inserted.CoverTestID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.CoverTestID <> Deleted.CoverTestID
end

-------------------  LeftAPCTGlasses  -----------------------------------------------------

if update(LeftAPCTGlasses)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAPCTGlasses', Deleted.LeftAPCTGlasses, Inserted.LeftAPCTGlasses
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftAPCTGlasses <> Deleted.LeftAPCTGlasses
end

-------------------  RightAPCTGlasses  -----------------------------------------------------

if update(RightAPCTGlasses)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAPCTGlasses', Deleted.RightAPCTGlasses, Inserted.RightAPCTGlasses
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightAPCTGlasses <> Deleted.RightAPCTGlasses
end

-------------------  LeftAPCTWithOutGlasses  -----------------------------------------------------

if update(LeftAPCTWithOutGlasses)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAPCTWithOutGlasses', Deleted.LeftAPCTWithOutGlasses, Inserted.LeftAPCTWithOutGlasses
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LeftAPCTWithOutGlasses <> Deleted.LeftAPCTWithOutGlasses
end

-------------------  RightAPCTWithOutGlasses  -----------------------------------------------------

if update(RightAPCTWithOutGlasses)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAPCTWithOutGlasses', Deleted.RightAPCTWithOutGlasses, Inserted.RightAPCTWithOutGlasses
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RightAPCTWithOutGlasses <> Deleted.RightAPCTWithOutGlasses
end

-------------------  Correspondence  -----------------------------------------------------

if update(Correspondence)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Correspondence', Deleted.Correspondence, Inserted.Correspondence
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.Correspondence <> Deleted.Correspondence
end

-------------------  PrismAdaptation  -----------------------------------------------------

if update(PrismAdaptation)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PrismAdaptation', Deleted.PrismAdaptation, Inserted.PrismAdaptation
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.PrismAdaptation <> Deleted.PrismAdaptation
end

-------------------  FusionConvergence  -----------------------------------------------------

if update(FusionConvergence)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FusionConvergence', Deleted.FusionConvergence, Inserted.FusionConvergence
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.FusionConvergence <> Deleted.FusionConvergence
end

-------------------  FusionDivergence  -----------------------------------------------------

if update(FusionDivergence)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FusionDivergence', Deleted.FusionDivergence, Inserted.FusionDivergence
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.FusionDivergence <> Deleted.FusionDivergence
end

-------------------  FusionRange  -----------------------------------------------------

if update(FusionRange)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FusionRange', Deleted.FusionRange, Inserted.FusionRange
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.FusionRange <> Deleted.FusionRange
end

-------------------  NearPointOfAccommodation  -----------------------------------------------------

if update(NearPointOfAccommodation)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NearPointOfAccommodation', Deleted.NearPointOfAccommodation, Inserted.NearPointOfAccommodation
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.NearPointOfAccommodation <> Deleted.NearPointOfAccommodation
end

-------------------  NearPointOfConvergence  -----------------------------------------------------

if update(NearPointOfConvergence)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NearPointOfConvergence', Deleted.NearPointOfConvergence, Inserted.NearPointOfConvergence
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.NearPointOfConvergence <> Deleted.NearPointOfConvergence
end

-------------------  OrthopticsNotes  -----------------------------------------------------

if update(OrthopticsNotes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrthopticsNotes', Deleted.OrthopticsNotes, Inserted.OrthopticsNotes
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.OrthopticsNotes <> Deleted.OrthopticsNotes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: IPDOrthoptics ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDOrthoptics')
drop trigger utrDeleteIPDOrthoptics
go

create trigger utrDeleteIPDOrthoptics
on IPDOrthoptics
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDOrthoptics' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  HeadPosture  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeadPosture', Deleted.HeadPosture, null from Deleted

-------------------  Fixation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Fixation', Deleted.Fixation, null from Deleted

-------------------  LeftHirschberg  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftHirschberg', Deleted.LeftHirschberg, null from Deleted

-------------------  RightHirschberg  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightHirschberg', Deleted.RightHirschberg, null from Deleted

-------------------  RightEOM  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightEOM', Deleted.RightEOM, null from Deleted

-------------------  LeftEOM  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftEOM', Deleted.LeftEOM, null from Deleted

-------------------  CoverTestID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoverTestID', Deleted.CoverTestID, null from Deleted

-------------------  LeftAPCTGlasses  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAPCTGlasses', Deleted.LeftAPCTGlasses, null from Deleted

-------------------  RightAPCTGlasses  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAPCTGlasses', Deleted.RightAPCTGlasses, null from Deleted

-------------------  LeftAPCTWithOutGlasses  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAPCTWithOutGlasses', Deleted.LeftAPCTWithOutGlasses, null from Deleted

-------------------  RightAPCTWithOutGlasses  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAPCTWithOutGlasses', Deleted.RightAPCTWithOutGlasses, null from Deleted

-------------------  Correspondence  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Correspondence', Deleted.Correspondence, null from Deleted

-------------------  PrismAdaptation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PrismAdaptation', Deleted.PrismAdaptation, null from Deleted

-------------------  FusionConvergence  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FusionConvergence', Deleted.FusionConvergence, null from Deleted

-------------------  FusionDivergence  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FusionDivergence', Deleted.FusionDivergence, null from Deleted

-------------------  FusionRange  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FusionRange', Deleted.FusionRange, null from Deleted

-------------------  NearPointOfAccommodation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NearPointOfAccommodation', Deleted.NearPointOfAccommodation, null from Deleted

-------------------  NearPointOfConvergence  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NearPointOfConvergence', Deleted.NearPointOfConvergence, null from Deleted

-------------------  OrthopticsNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrthopticsNotes', Deleted.OrthopticsNotes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go
------------------------------------------------------------------------------------------------------
-------------- Update: Orthoptics ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateOrthoptics')
drop trigger utrUpdateOrthoptics
go

create trigger utrUpdateOrthoptics
on Orthoptics
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Orthoptics' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  HeadPosture  -----------------------------------------------------

if update(HeadPosture)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeadPosture', Deleted.HeadPosture, Inserted.HeadPosture
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.HeadPosture <> Deleted.HeadPosture
end

-------------------  Fixation  -----------------------------------------------------

if update(Fixation)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Fixation', Deleted.Fixation, Inserted.Fixation
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Fixation <> Deleted.Fixation
end

-------------------  LeftHirschberg  -----------------------------------------------------

if update(LeftHirschberg)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftHirschberg', Deleted.LeftHirschberg, Inserted.LeftHirschberg
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftHirschberg <> Deleted.LeftHirschberg
end

-------------------  RightHirschberg  -----------------------------------------------------

if update(RightHirschberg)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightHirschberg', Deleted.RightHirschberg, Inserted.RightHirschberg
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightHirschberg <> Deleted.RightHirschberg
end

-------------------  RightEOM  -----------------------------------------------------

if update(RightEOM)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightEOM', Deleted.RightEOM, Inserted.RightEOM
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightEOM <> Deleted.RightEOM
end

-------------------  LeftEOM  -----------------------------------------------------

if update(LeftEOM)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftEOM', Deleted.LeftEOM, Inserted.LeftEOM
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftEOM <> Deleted.LeftEOM
end

-------------------  CoverTestID  -----------------------------------------------------

if update(CoverTestID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoverTestID', Deleted.CoverTestID, Inserted.CoverTestID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CoverTestID <> Deleted.CoverTestID
end

-------------------  LeftAPCTGlasses  -----------------------------------------------------

if update(LeftAPCTGlasses)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAPCTGlasses', Deleted.LeftAPCTGlasses, Inserted.LeftAPCTGlasses
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftAPCTGlasses <> Deleted.LeftAPCTGlasses
end

-------------------  RightAPCTGlasses  -----------------------------------------------------

if update(RightAPCTGlasses)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAPCTGlasses', Deleted.RightAPCTGlasses, Inserted.RightAPCTGlasses
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightAPCTGlasses <> Deleted.RightAPCTGlasses
end

-------------------  LeftAPCTWithOutGlasses  -----------------------------------------------------

if update(LeftAPCTWithOutGlasses)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAPCTWithOutGlasses', Deleted.LeftAPCTWithOutGlasses, Inserted.LeftAPCTWithOutGlasses
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LeftAPCTWithOutGlasses <> Deleted.LeftAPCTWithOutGlasses
end

-------------------  RightAPCTWithOutGlasses  -----------------------------------------------------

if update(RightAPCTWithOutGlasses)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAPCTWithOutGlasses', Deleted.RightAPCTWithOutGlasses, Inserted.RightAPCTWithOutGlasses
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RightAPCTWithOutGlasses <> Deleted.RightAPCTWithOutGlasses
end

-------------------  Correspondence  -----------------------------------------------------

if update(Correspondence)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Correspondence', Deleted.Correspondence, Inserted.Correspondence
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Correspondence <> Deleted.Correspondence
end

-------------------  PrismAdaptation  -----------------------------------------------------

if update(PrismAdaptation)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PrismAdaptation', Deleted.PrismAdaptation, Inserted.PrismAdaptation
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PrismAdaptation <> Deleted.PrismAdaptation
end

-------------------  FusionConvergence  -----------------------------------------------------

if update(FusionConvergence)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FusionConvergence', Deleted.FusionConvergence, Inserted.FusionConvergence
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.FusionConvergence <> Deleted.FusionConvergence
end

-------------------  FusionDivergence  -----------------------------------------------------

if update(FusionDivergence)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FusionDivergence', Deleted.FusionDivergence, Inserted.FusionDivergence
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.FusionDivergence <> Deleted.FusionDivergence
end

-------------------  FusionRange  -----------------------------------------------------

if update(FusionRange)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FusionRange', Deleted.FusionRange, Inserted.FusionRange
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.FusionRange <> Deleted.FusionRange
end

-------------------  NearPointOfAccommodation  -----------------------------------------------------

if update(NearPointOfAccommodation)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NearPointOfAccommodation', Deleted.NearPointOfAccommodation, Inserted.NearPointOfAccommodation
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NearPointOfAccommodation <> Deleted.NearPointOfAccommodation
end

-------------------  NearPointOfConvergence  -----------------------------------------------------

if update(NearPointOfConvergence)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NearPointOfConvergence', Deleted.NearPointOfConvergence, Inserted.NearPointOfConvergence
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NearPointOfConvergence <> Deleted.NearPointOfConvergence
end

-------------------  OrthopticsNotes  -----------------------------------------------------

if update(OrthopticsNotes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrthopticsNotes', Deleted.OrthopticsNotes, Inserted.OrthopticsNotes
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OrthopticsNotes <> Deleted.OrthopticsNotes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: Orthoptics --------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteOrthoptics')
drop trigger utrDeleteOrthoptics
go

create trigger utrDeleteOrthoptics
on Orthoptics
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Orthoptics' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  HeadPosture  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeadPosture', Deleted.HeadPosture, null from Deleted

-------------------  Fixation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Fixation', Deleted.Fixation, null from Deleted

-------------------  LeftHirschberg  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftHirschberg', Deleted.LeftHirschberg, null from Deleted

-------------------  RightHirschberg  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightHirschberg', Deleted.RightHirschberg, null from Deleted

-------------------  RightEOM  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightEOM', Deleted.RightEOM, null from Deleted

-------------------  LeftEOM  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftEOM', Deleted.LeftEOM, null from Deleted

-------------------  CoverTestID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoverTestID', Deleted.CoverTestID, null from Deleted

-------------------  LeftAPCTGlasses  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAPCTGlasses', Deleted.LeftAPCTGlasses, null from Deleted

-------------------  RightAPCTGlasses  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAPCTGlasses', Deleted.RightAPCTGlasses, null from Deleted

-------------------  LeftAPCTWithOutGlasses  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeftAPCTWithOutGlasses', Deleted.LeftAPCTWithOutGlasses, null from Deleted

-------------------  RightAPCTWithOutGlasses  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RightAPCTWithOutGlasses', Deleted.RightAPCTWithOutGlasses, null from Deleted

-------------------  Correspondence  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Correspondence', Deleted.Correspondence, null from Deleted

-------------------  PrismAdaptation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PrismAdaptation', Deleted.PrismAdaptation, null from Deleted

-------------------  FusionConvergence  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FusionConvergence', Deleted.FusionConvergence, null from Deleted

-------------------  FusionDivergence  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FusionDivergence', Deleted.FusionDivergence, null from Deleted

-------------------  FusionRange  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FusionRange', Deleted.FusionRange, null from Deleted

-------------------  NearPointOfAccommodation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NearPointOfAccommodation', Deleted.NearPointOfAccommodation, null from Deleted

-------------------  NearPointOfConvergence  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NearPointOfConvergence', Deleted.NearPointOfConvergence, null from Deleted

-------------------  OrthopticsNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrthopticsNotes', Deleted.OrthopticsNotes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: CancerDiagnosis ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateCancerDiagnosis')
drop trigger utrUpdateCancerDiagnosis
go

create trigger utrUpdateCancerDiagnosis
on CancerDiagnosis
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'CancerDiagnosis' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
end

------------------- Key-DiseaseNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseNo', Deleted.DiseaseNo, Inserted.DiseaseNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
end

-------------------  TopographicalNo  -----------------------------------------------------

if update(TopographicalNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TopographicalNo', Deleted.TopographicalNo, Inserted.TopographicalNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.TopographicalNo <> Deleted.TopographicalNo
end

-------------------  BasisOfDiagnosisID  -----------------------------------------------------

if update(BasisOfDiagnosisID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BasisOfDiagnosisID', Deleted.BasisOfDiagnosisID, Inserted.BasisOfDiagnosisID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.BasisOfDiagnosisID <> Deleted.BasisOfDiagnosisID
end

-------------------  CancerStageID  -----------------------------------------------------

if update(CancerStageID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CancerStageID', Deleted.CancerStageID, Inserted.CancerStageID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.CancerStageID <> Deleted.CancerStageID
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: CancerDiagnosis ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteCancerDiagnosis')
drop trigger utrDeleteCancerDiagnosis
go

create trigger utrDeleteCancerDiagnosis
on CancerDiagnosis
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'CancerDiagnosis' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  DiseaseNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseNo', Deleted.DiseaseNo, null from Deleted

-------------------  TopographicalNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TopographicalNo', Deleted.TopographicalNo, null from Deleted

-------------------  BasisOfDiagnosisID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BasisOfDiagnosisID', Deleted.BasisOfDiagnosisID, null from Deleted

-------------------  CancerStageID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CancerStageID', Deleted.CancerStageID, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: CancerDiseases ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateCancerDiseases')
drop trigger utrUpdateCancerDiseases
go

create trigger utrUpdateCancerDiseases
on CancerDiseases
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'CancerDiseases' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-DiseaseNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseNo', Deleted.DiseaseNo, Inserted.DiseaseNo
from Inserted inner join Deleted
on Inserted.DiseaseNo = Deleted.DiseaseNo
end

-------------------  DiseaseID  -----------------------------------------------------

if update(DiseaseID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseID', Deleted.DiseaseID, Inserted.DiseaseID
from Inserted inner join Deleted
on Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.DiseaseID <> Deleted.DiseaseID
end

-------------------  DiseaseCode  -----------------------------------------------------

if update(DiseaseCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseCode', Deleted.DiseaseCode, Inserted.DiseaseCode
from Inserted inner join Deleted
on Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.DiseaseCode <> Deleted.DiseaseCode
end

-------------------  DiseaseName  -----------------------------------------------------

if update(DiseaseName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseName', Deleted.DiseaseName, Inserted.DiseaseName
from Inserted inner join Deleted
on Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.DiseaseName <> Deleted.DiseaseName
end

-------------------  CancerDiseaseCategoriesID  -----------------------------------------------------

if update(CancerDiseaseCategoriesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CancerDiseaseCategoriesID', Deleted.CancerDiseaseCategoriesID, Inserted.CancerDiseaseCategoriesID
from Inserted inner join Deleted
on Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.CancerDiseaseCategoriesID <> Deleted.CancerDiseaseCategoriesID
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.Hidden <> Deleted.Hidden
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: CancerDiseases ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteCancerDiseases')
drop trigger utrDeleteCancerDiseases
go

create trigger utrDeleteCancerDiseases
on CancerDiseases
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'CancerDiseases' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  DiseaseID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseID', Deleted.DiseaseID, null from Deleted

-------------------  DiseaseNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseNo', Deleted.DiseaseNo, null from Deleted

-------------------  DiseaseCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseCode', Deleted.DiseaseCode, null from Deleted

-------------------  DiseaseName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseName', Deleted.DiseaseName, null from Deleted

-------------------  CancerDiseaseCategoriesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CancerDiseaseCategoriesID', Deleted.CancerDiseaseCategoriesID, null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: TopologySites ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateTopologySites')
drop trigger utrUpdateTopologySites
go

create trigger utrUpdateTopologySites
on TopologySites
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'TopologySites' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-TopographicalNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TopographicalNo', Deleted.TopographicalNo, Inserted.TopographicalNo
from Inserted inner join Deleted
on Inserted.TopographicalNo = Deleted.TopographicalNo
end

-------------------  TopologySiteCodeID  -----------------------------------------------------

if update(TopologySiteCodeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TopologySiteCodeID', Deleted.TopologySiteCodeID, Inserted.TopologySiteCodeID
from Inserted inner join Deleted
on Inserted.TopographicalNo = Deleted.TopographicalNo
and Inserted.TopologySiteCodeID <> Deleted.TopologySiteCodeID
end

-------------------  TopologySiteName  -----------------------------------------------------

if update(TopologySiteName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TopologySiteName', Deleted.TopologySiteName, Inserted.TopologySiteName
from Inserted inner join Deleted
on Inserted.TopographicalNo = Deleted.TopographicalNo
and Inserted.TopologySiteName <> Deleted.TopologySiteName
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.TopographicalNo = Deleted.TopographicalNo
and Inserted.Hidden <> Deleted.Hidden
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.TopographicalNo = Deleted.TopographicalNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.TopographicalNo = Deleted.TopographicalNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.TopographicalNo = Deleted.TopographicalNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: TopologySites ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteTopologySites')
drop trigger utrDeleteTopologySites
go

create trigger utrDeleteTopologySites
on TopologySites
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'TopologySites' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  TopographicalNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TopographicalNo', Deleted.TopographicalNo, null from Deleted

-------------------  TopologySiteCodeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TopologySiteCodeID', Deleted.TopologySiteCodeID, null from Deleted

-------------------  TopologySiteName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TopologySiteName', Deleted.TopologySiteName, null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go
------------------------------------------------------------------------------------------------------
-------------- Update: HCTClientCard ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateHCTClientCard')
drop trigger utrUpdateHCTClientCard
go

create trigger utrUpdateHCTClientCard
on HCTClientCard
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'HCTClientCard' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  DistrictsID  -----------------------------------------------------

if update(DistrictsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DistrictsID', Deleted.DistrictsID, Inserted.DistrictsID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DistrictsID <> Deleted.DistrictsID
end

-------------------  HealthUnitCode  -----------------------------------------------------

if update(HealthUnitCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HealthUnitCode', Deleted.HealthUnitCode, Inserted.HealthUnitCode
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.HealthUnitCode <> Deleted.HealthUnitCode
end

-------------------  HSD  -----------------------------------------------------

if update(HSD)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HSD', Deleted.HSD, Inserted.HSD
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.HSD <> Deleted.HSD
end

-------------------  CenterTypeID  -----------------------------------------------------

if update(CenterTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CenterTypeID', Deleted.CenterTypeID, Inserted.CenterTypeID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CenterTypeID <> Deleted.CenterTypeID
end

-------------------  TestingPointID  -----------------------------------------------------

if update(TestingPointID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestingPointID', Deleted.TestingPointID, Inserted.TestingPointID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TestingPointID <> Deleted.TestingPointID
end

-------------------  AccompaniedByID  -----------------------------------------------------

if update(AccompaniedByID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccompaniedByID', Deleted.AccompaniedByID, Inserted.AccompaniedByID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.AccompaniedByID <> Deleted.AccompaniedByID
end

-------------------  PreTestCounselingID  -----------------------------------------------------

if update(PreTestCounselingID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreTestCounselingID', Deleted.PreTestCounselingID, Inserted.PreTestCounselingID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PreTestCounselingID <> Deleted.PreTestCounselingID
end

-------------------  CounseledAsID  -----------------------------------------------------

if update(CounseledAsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CounseledAsID', Deleted.CounseledAsID, Inserted.CounseledAsID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CounseledAsID <> Deleted.CounseledAsID
end

-------------------  HCTEntryPoint  -----------------------------------------------------

if update(HCTEntryPoint)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HCTEntryPoint', Deleted.HCTEntryPoint, Inserted.HCTEntryPoint
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.HCTEntryPoint <> Deleted.HCTEntryPoint
end

-------------------  MaritalStatusID  -----------------------------------------------------

if update(MaritalStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MaritalStatusID', Deleted.MaritalStatusID, Inserted.MaritalStatusID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.MaritalStatusID <> Deleted.MaritalStatusID
end

-------------------  SexualPatnerNo  -----------------------------------------------------

if update(SexualPatnerNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SexualPatnerNo', Deleted.SexualPatnerNo, Inserted.SexualPatnerNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.SexualPatnerNo <> Deleted.SexualPatnerNo
end

-------------------  TestedHIVBeforeID  -----------------------------------------------------

if update(TestedHIVBeforeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestedHIVBeforeID', Deleted.TestedHIVBeforeID, Inserted.TestedHIVBeforeID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TestedHIVBeforeID <> Deleted.TestedHIVBeforeID
end

-------------------  HIVTestThreeMonthsID  -----------------------------------------------------

if update(HIVTestThreeMonthsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVTestThreeMonthsID', Deleted.HIVTestThreeMonthsID, Inserted.HIVTestThreeMonthsID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.HIVTestThreeMonthsID <> Deleted.HIVTestThreeMonthsID
end

-------------------  HIVTestSixMonthsID  -----------------------------------------------------

if update(HIVTestSixMonthsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVTestSixMonthsID', Deleted.HIVTestSixMonthsID, Inserted.HIVTestSixMonthsID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.HIVTestSixMonthsID <> Deleted.HIVTestSixMonthsID
end

-------------------  HIVTestTwelveMonthsID  -----------------------------------------------------

if update(HIVTestTwelveMonthsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVTestTwelveMonthsID', Deleted.HIVTestTwelveMonthsID, Inserted.HIVTestTwelveMonthsID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.HIVTestTwelveMonthsID <> Deleted.HIVTestTwelveMonthsID
end

-------------------  ResultThreeMonthsID  -----------------------------------------------------

if update(ResultThreeMonthsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultThreeMonthsID', Deleted.ResultThreeMonthsID, Inserted.ResultThreeMonthsID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ResultThreeMonthsID <> Deleted.ResultThreeMonthsID
end

-------------------  ResultSixMonthsID  -----------------------------------------------------

if update(ResultSixMonthsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultSixMonthsID', Deleted.ResultSixMonthsID, Inserted.ResultSixMonthsID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ResultSixMonthsID <> Deleted.ResultSixMonthsID
end

-------------------  ResultTwelveMonthsID  -----------------------------------------------------

if update(ResultTwelveMonthsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultTwelveMonthsID', Deleted.ResultTwelveMonthsID, Inserted.ResultTwelveMonthsID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ResultTwelveMonthsID <> Deleted.ResultTwelveMonthsID
end

-------------------  NoTestsInTwelveMonthsID  -----------------------------------------------------

if update(NoTestsInTwelveMonthsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NoTestsInTwelveMonthsID', Deleted.NoTestsInTwelveMonthsID, Inserted.NoTestsInTwelveMonthsID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NoTestsInTwelveMonthsID <> Deleted.NoTestsInTwelveMonthsID
end

-------------------  PatnerTestedHIVID  -----------------------------------------------------

if update(PatnerTestedHIVID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatnerTestedHIVID', Deleted.PatnerTestedHIVID, Inserted.PatnerTestedHIVID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PatnerTestedHIVID <> Deleted.PatnerTestedHIVID
end

-------------------  PatnerTypeID  -----------------------------------------------------

if update(PatnerTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatnerTypeID', Deleted.PatnerTypeID, Inserted.PatnerTypeID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PatnerTypeID <> Deleted.PatnerTypeID
end

-------------------  PatnerResultID  -----------------------------------------------------

if update(PatnerResultID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatnerResultID', Deleted.PatnerResultID, Inserted.PatnerResultID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PatnerResultID <> Deleted.PatnerResultID
end

-------------------  KnowAboutServiceID  -----------------------------------------------------

if update(KnowAboutServiceID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'KnowAboutServiceID', Deleted.KnowAboutServiceID, Inserted.KnowAboutServiceID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.KnowAboutServiceID <> Deleted.KnowAboutServiceID
end

-------------------  ConsentID  -----------------------------------------------------

if update(ConsentID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConsentID', Deleted.ConsentID, Inserted.ConsentID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ConsentID <> Deleted.ConsentID
end

-------------------  NoConsentReasonID  -----------------------------------------------------

if update(NoConsentReasonID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NoConsentReasonID', Deleted.NoConsentReasonID, Inserted.NoConsentReasonID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NoConsentReasonID <> Deleted.NoConsentReasonID
end

-------------------  HIVResultID  -----------------------------------------------------

if update(HIVResultID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVResultID', Deleted.HIVResultID, Inserted.HIVResultID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.HIVResultID <> Deleted.HIVResultID
end

-------------------  TestDoneBy  -----------------------------------------------------

if update(TestDoneBy)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestDoneBy', Deleted.TestDoneBy, Inserted.TestDoneBy
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TestDoneBy <> Deleted.TestDoneBy
end

-------------------  Designation  -----------------------------------------------------

if update(Designation)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Designation', Deleted.Designation, Inserted.Designation
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Designation <> Deleted.Designation
end

-------------------  TestDate  -----------------------------------------------------

if update(TestDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestDate', dbo.FormatDate(Deleted.TestDate), dbo.FormatDate(Inserted.TestDate)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TestDate <> Deleted.TestDate
end

-------------------  ResultReceivedID  -----------------------------------------------------

if update(ResultReceivedID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultReceivedID', Deleted.ResultReceivedID, Inserted.ResultReceivedID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ResultReceivedID <> Deleted.ResultReceivedID
end

-------------------  ResultReceivedAsCoupleID  -----------------------------------------------------

if update(ResultReceivedAsCoupleID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultReceivedAsCoupleID', Deleted.ResultReceivedAsCoupleID, Inserted.ResultReceivedAsCoupleID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ResultReceivedAsCoupleID <> Deleted.ResultReceivedAsCoupleID
end

-------------------  CoupleResultsID  -----------------------------------------------------

if update(CoupleResultsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoupleResultsID', Deleted.CoupleResultsID, Inserted.CoupleResultsID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CoupleResultsID <> Deleted.CoupleResultsID
end

-------------------  TBSuspicionID  -----------------------------------------------------

if update(TBSuspicionID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TBSuspicionID', Deleted.TBSuspicionID, Inserted.TBSuspicionID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TBSuspicionID <> Deleted.TBSuspicionID
end

-------------------  STIID  -----------------------------------------------------

if update(STIID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'STIID', Deleted.STIID, Inserted.STIID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.STIID <> Deleted.STIID
end

-------------------  StartedCotrimoxazoleID  -----------------------------------------------------

if update(StartedCotrimoxazoleID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartedCotrimoxazoleID', Deleted.StartedCotrimoxazoleID, Inserted.StartedCotrimoxazoleID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.StartedCotrimoxazoleID <> Deleted.StartedCotrimoxazoleID
end

-------------------  LinkedToCareID  -----------------------------------------------------

if update(LinkedToCareID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LinkedToCareID', Deleted.LinkedToCareID, Inserted.LinkedToCareID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LinkedToCareID <> Deleted.LinkedToCareID
end

-------------------  WhereLinkedToCareID  -----------------------------------------------------

if update(WhereLinkedToCareID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WhereLinkedToCareID', Deleted.WhereLinkedToCareID, Inserted.WhereLinkedToCareID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.WhereLinkedToCareID <> Deleted.WhereLinkedToCareID
end

-------------------  ReferralReason  -----------------------------------------------------

if update(ReferralReason)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferralReason', Deleted.ReferralReason, Inserted.ReferralReason
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ReferralReason <> Deleted.ReferralReason
end

-------------------  CounselorName  -----------------------------------------------------

if update(CounselorName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CounselorName', Deleted.CounselorName, Inserted.CounselorName
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CounselorName <> Deleted.CounselorName
end

-------------------  CounselDate  -----------------------------------------------------

if update(CounselDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CounselDate', dbo.FormatDate(Deleted.CounselDate), dbo.FormatDate(Inserted.CounselDate)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CounselDate <> Deleted.CounselDate
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: HCTClientCard ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteHCTClientCard')
drop trigger utrDeleteHCTClientCard
go

create trigger utrDeleteHCTClientCard
on HCTClientCard
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'HCTClientCard' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  DistrictsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DistrictsID', Deleted.DistrictsID, null from Deleted

-------------------  HealthUnitCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HealthUnitCode', Deleted.HealthUnitCode, null from Deleted

-------------------  HSD  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HSD', Deleted.HSD, null from Deleted

-------------------  CenterTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CenterTypeID', Deleted.CenterTypeID, null from Deleted

-------------------  TestingPointID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestingPointID', Deleted.TestingPointID, null from Deleted

-------------------  AccompaniedByID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccompaniedByID', Deleted.AccompaniedByID, null from Deleted

-------------------  PreTestCounselingID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PreTestCounselingID', Deleted.PreTestCounselingID, null from Deleted

-------------------  CounseledAsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CounseledAsID', Deleted.CounseledAsID, null from Deleted

-------------------  HCTEntryPoint  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HCTEntryPoint', Deleted.HCTEntryPoint, null from Deleted

-------------------  MaritalStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MaritalStatusID', Deleted.MaritalStatusID, null from Deleted

-------------------  SexualPatnerNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SexualPatnerNo', Deleted.SexualPatnerNo, null from Deleted

-------------------  TestedHIVBeforeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestedHIVBeforeID', Deleted.TestedHIVBeforeID, null from Deleted

-------------------  HIVTestThreeMonthsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVTestThreeMonthsID', Deleted.HIVTestThreeMonthsID, null from Deleted

-------------------  HIVTestSixMonthsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVTestSixMonthsID', Deleted.HIVTestSixMonthsID, null from Deleted

-------------------  HIVTestTwelveMonthsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVTestTwelveMonthsID', Deleted.HIVTestTwelveMonthsID, null from Deleted

-------------------  ResultThreeMonthsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultThreeMonthsID', Deleted.ResultThreeMonthsID, null from Deleted

-------------------  ResultSixMonthsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultSixMonthsID', Deleted.ResultSixMonthsID, null from Deleted

-------------------  ResultTwelveMonthsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultTwelveMonthsID', Deleted.ResultTwelveMonthsID, null from Deleted

-------------------  NoTestsInTwelveMonthsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NoTestsInTwelveMonthsID', Deleted.NoTestsInTwelveMonthsID, null from Deleted

-------------------  PatnerTestedHIVID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatnerTestedHIVID', Deleted.PatnerTestedHIVID, null from Deleted

-------------------  PatnerTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatnerTypeID', Deleted.PatnerTypeID, null from Deleted

-------------------  PatnerResultID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatnerResultID', Deleted.PatnerResultID, null from Deleted

-------------------  KnowAboutServiceID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'KnowAboutServiceID', Deleted.KnowAboutServiceID, null from Deleted

-------------------  ConsentID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConsentID', Deleted.ConsentID, null from Deleted

-------------------  NoConsentReasonID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NoConsentReasonID', Deleted.NoConsentReasonID, null from Deleted

-------------------  HIVResultID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVResultID', Deleted.HIVResultID, null from Deleted

-------------------  TestDoneBy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestDoneBy', Deleted.TestDoneBy, null from Deleted

-------------------  Designation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Designation', Deleted.Designation, null from Deleted

-------------------  TestDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestDate', dbo.FormatDate(Deleted.TestDate), null from Deleted

-------------------  ResultReceivedID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultReceivedID', Deleted.ResultReceivedID, null from Deleted

-------------------  ResultReceivedAsCoupleID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ResultReceivedAsCoupleID', Deleted.ResultReceivedAsCoupleID, null from Deleted

-------------------  CoupleResultsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoupleResultsID', Deleted.CoupleResultsID, null from Deleted

-------------------  TBSuspicionID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TBSuspicionID', Deleted.TBSuspicionID, null from Deleted

-------------------  STIID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'STIID', Deleted.STIID, null from Deleted

-------------------  StartedCotrimoxazoleID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartedCotrimoxazoleID', Deleted.StartedCotrimoxazoleID, null from Deleted

-------------------  LinkedToCareID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LinkedToCareID', Deleted.LinkedToCareID, null from Deleted

-------------------  WhereLinkedToCareID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WhereLinkedToCareID', Deleted.WhereLinkedToCareID, null from Deleted

-------------------  ReferralReason  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferralReason', Deleted.ReferralReason, null from Deleted

-------------------  CounselorName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CounselorName', Deleted.CounselorName, null from Deleted

-------------------  CounselDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CounselDate', dbo.FormatDate(Deleted.CounselDate), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ExternalReferrals ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateExternalReferrals')
drop trigger utrUpdateExternalReferrals
go

create trigger utrUpdateExternalReferrals
on ExternalReferrals
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ExternalReferrals' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  ProcedurePaidBy  -----------------------------------------------------

if update(ProcedurePaidBy)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProcedurePaidBy', Deleted.ProcedurePaidBy, Inserted.ProcedurePaidBy
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ProcedurePaidBy <> Deleted.ProcedurePaidBy
end

-------------------  EmployeeName  -----------------------------------------------------

if update(EmployeeName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EmployeeName', Deleted.EmployeeName, Inserted.EmployeeName
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.EmployeeName <> Deleted.EmployeeName
end

-------------------  ReferredTo  -----------------------------------------------------

if update(ReferredTo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferredTo', Deleted.ReferredTo, Inserted.ReferredTo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ReferredTo <> Deleted.ReferredTo
end

-------------------  DepartureTime  -----------------------------------------------------

if update(DepartureTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DepartureTime', Deleted.DepartureTime, Inserted.DepartureTime
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DepartureTime <> Deleted.DepartureTime
end

-------------------  DateOfReferral  -----------------------------------------------------

if update(DateOfReferral)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DateOfReferral', dbo.FormatDate(Deleted.DateOfReferral), dbo.FormatDate(Inserted.DateOfReferral)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DateOfReferral <> Deleted.DateOfReferral
end

-------------------  HistoryAndSymptoms  -----------------------------------------------------

if update(HistoryAndSymptoms)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HistoryAndSymptoms', Deleted.HistoryAndSymptoms, Inserted.HistoryAndSymptoms
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.HistoryAndSymptoms <> Deleted.HistoryAndSymptoms
end

-------------------  LabInvestigations  -----------------------------------------------------

if update(LabInvestigations)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LabInvestigations', Deleted.LabInvestigations, Inserted.LabInvestigations
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LabInvestigations <> Deleted.LabInvestigations
end

-------------------  Diagnosis  -----------------------------------------------------

if update(Diagnosis)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Diagnosis', Deleted.Diagnosis, Inserted.Diagnosis
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Diagnosis <> Deleted.Diagnosis
end

-------------------  TreatmentGiven  -----------------------------------------------------

if update(TreatmentGiven)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TreatmentGiven', Deleted.TreatmentGiven, Inserted.TreatmentGiven
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TreatmentGiven <> Deleted.TreatmentGiven
end

-------------------  ReasonForReferral  -----------------------------------------------------

if update(ReasonForReferral)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReasonForReferral', Deleted.ReasonForReferral, Inserted.ReasonForReferral
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ReasonForReferral <> Deleted.ReasonForReferral
end

-------------------  StaffNo  -----------------------------------------------------

if update(StaffNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.StaffNo <> Deleted.StaffNo
end

-------------------  AuthorisedBy  -----------------------------------------------------

if update(AuthorisedBy)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AuthorisedBy', Deleted.AuthorisedBy, Inserted.AuthorisedBy
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.AuthorisedBy <> Deleted.AuthorisedBy
end

-------------------  TreatmentLimit  -----------------------------------------------------

if update(TreatmentLimit)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TreatmentLimit', cast(Deleted.TreatmentLimit as varchar(20)), cast(Inserted.TreatmentLimit as varchar(20))
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TreatmentLimit <> Deleted.TreatmentLimit
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: ExternalReferrals ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteExternalReferrals')
drop trigger utrDeleteExternalReferrals
go

create trigger utrDeleteExternalReferrals
on ExternalReferrals
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ExternalReferrals' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ProcedurePaidBy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProcedurePaidBy', Deleted.ProcedurePaidBy, null from Deleted

-------------------  EmployeeName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EmployeeName', Deleted.EmployeeName, null from Deleted

-------------------  ReferredTo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferredTo', Deleted.ReferredTo, null from Deleted

-------------------  DepartureTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DepartureTime', Deleted.DepartureTime, null from Deleted

-------------------  DateOfReferral  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DateOfReferral', dbo.FormatDate(Deleted.DateOfReferral), null from Deleted

-------------------  HistoryAndSymptoms  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HistoryAndSymptoms', Deleted.HistoryAndSymptoms, null from Deleted

-------------------  Diagnosis  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Diagnosis', Deleted.Diagnosis, null from Deleted

-------------------  TreatmentGiven  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TreatmentGiven', Deleted.TreatmentGiven, null from Deleted

-------------------  LabInvestigations  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LabInvestigations', Deleted.LabInvestigations, null from Deleted

-------------------  ReasonForReferral  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReasonForReferral', Deleted.ReasonForReferral, null from Deleted

-------------------  StaffNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted

-------------------  AuthorisedBy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AuthorisedBy', Deleted.AuthorisedBy, null from Deleted

-------------------  TreatmentLimit  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TreatmentLimit', cast(Deleted.TreatmentLimit as varchar(20)), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go
------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
-------------- Update: PossibleAttachedItems ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePossibleAttachedItems')
drop trigger utrUpdatePossibleAttachedItems
go

create trigger utrUpdatePossibleAttachedItems
on PossibleAttachedItems
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PossibleAttachedItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-AttachedItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AttachedItemCode', Deleted.AttachedItemCode, Inserted.AttachedItemCode
from Inserted inner join Deleted
on Inserted.AttachedItemCode = Deleted.AttachedItemCode
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.AttachedItemCode = Deleted.AttachedItemCode
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.AttachedItemCode = Deleted.AttachedItemCode
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.AttachedItemCode = Deleted.AttachedItemCode
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.AttachedItemCode = Deleted.AttachedItemCode
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.AttachedItemCode = Deleted.AttachedItemCode
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.AttachedItemCode = Deleted.AttachedItemCode
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.AttachedItemCode = Deleted.AttachedItemCode
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PossibleAttachedItems ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePossibleAttachedItems')
drop trigger utrDeletePossibleAttachedItems
go

create trigger utrDeletePossibleAttachedItems
on PossibleAttachedItems
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PossibleAttachedItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AttachedItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AttachedItemCode', Deleted.AttachedItemCode, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: LowVision ----------------------------------------------------------
------------------------------------------------------------------------------------------------------
if exists (select * from sysobjects where name = 'utrUpdateLowVision')
drop trigger utrUpdateLowVision
go

create trigger utrUpdateLowVision
on LowVision
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'LowVision' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  BriefHistory  -----------------------------------------------------

if update(BriefHistory)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BriefHistory', Deleted.BriefHistory, Inserted.BriefHistory
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BriefHistory <> Deleted.BriefHistory
end

-------------------  Profession  -----------------------------------------------------

if update(Profession)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Profession', Deleted.Profession, Inserted.Profession
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Profession <> Deleted.Profession
end

-------------------  MajorOcularDiagnosisRE  -----------------------------------------------------

if update(MajorOcularDiagnosisRE)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MajorOcularDiagnosisRE', Deleted.MajorOcularDiagnosisRE, Inserted.MajorOcularDiagnosisRE
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.MajorOcularDiagnosisRE <> Deleted.MajorOcularDiagnosisRE
end

-------------------  MajorOcularDiagnosisLE  -----------------------------------------------------

if update(MajorOcularDiagnosisLE)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MajorOcularDiagnosisLE', Deleted.MajorOcularDiagnosisLE, Inserted.MajorOcularDiagnosisLE
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.MajorOcularDiagnosisLE <> Deleted.MajorOcularDiagnosisLE
end

-------------------  OtherOcularDiagnosisRE  -----------------------------------------------------

if update(OtherOcularDiagnosisRE)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherOcularDiagnosisRE', Deleted.OtherOcularDiagnosisRE, Inserted.OtherOcularDiagnosisRE
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OtherOcularDiagnosisRE <> Deleted.OtherOcularDiagnosisRE
end

-------------------  OtherOcularDiagnosisLE  -----------------------------------------------------

if update(OtherOcularDiagnosisLE)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherOcularDiagnosisLE', Deleted.OtherOcularDiagnosisLE, Inserted.OtherOcularDiagnosisLE
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OtherOcularDiagnosisLE <> Deleted.OtherOcularDiagnosisLE
end

-------------------  OphthalmologistSeenID  -----------------------------------------------------

if update(OphthalmologistSeenID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OphthalmologistSeenID', Deleted.OphthalmologistSeenID, Inserted.OphthalmologistSeenID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OphthalmologistSeenID <> Deleted.OphthalmologistSeenID
end

-------------------  OtherImpairmentsID  -----------------------------------------------------

if update(OtherImpairmentsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherImpairmentsID', Deleted.OtherImpairmentsID, Inserted.OtherImpairmentsID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OtherImpairmentsID <> Deleted.OtherImpairmentsID
end
-------------------  OtherImpairments  -----------------------------------------------------

if update(OtherImpairments)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherImpairments', Deleted.OtherImpairments, Inserted.OtherImpairments
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OtherImpairments <> Deleted.OtherImpairments
end

-------------------  ExistingTreatmentFarRE  -----------------------------------------------------

if update(ExistingTreatmentFarRE)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingTreatmentFarRE', Deleted.ExistingTreatmentFarRE, Inserted.ExistingTreatmentFarRE
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ExistingTreatmentFarRE <> Deleted.ExistingTreatmentFarRE
end

-------------------  ExistingTreatmentFarLE  -----------------------------------------------------

if update(ExistingTreatmentFarLE)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingTreatmentFarLE', Deleted.ExistingTreatmentFarLE, Inserted.ExistingTreatmentFarLE
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ExistingTreatmentFarLE <> Deleted.ExistingTreatmentFarLE
end
-------------------  ExistingTreatmentNearRE  -----------------------------------------------------

if update(ExistingTreatmentNearRE)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingTreatmentNearRE', Deleted.ExistingTreatmentNearRE, Inserted.ExistingTreatmentNearRE
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ExistingTreatmentNearRE <> Deleted.ExistingTreatmentNearRE
end

-------------------  ExistingTreatmentNearLE  -----------------------------------------------------

if update(ExistingTreatmentNearLE)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingTreatmentNearLE', Deleted.ExistingTreatmentNearLE, Inserted.ExistingTreatmentNearLE
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ExistingTreatmentNearLE <> Deleted.ExistingTreatmentNearLE
end

-------------------  NewTreatmentFarRE  -----------------------------------------------------

if update(NewTreatmentFarRE)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewTreatmentFarRE', Deleted.NewTreatmentFarRE, Inserted.NewTreatmentFarRE
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NewTreatmentFarRE <> Deleted.NewTreatmentFarRE
end

-------------------  NewTreatmentFarLE  -----------------------------------------------------

if update(NewTreatmentFarLE)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewTreatmentFarLE', Deleted.NewTreatmentFarLE, Inserted.NewTreatmentFarLE
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NewTreatmentFarLE <> Deleted.NewTreatmentFarLE
end
-------------------  NewTreatmentNearRE  -----------------------------------------------------

if update(NewTreatmentNearRE)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewTreatmentNearRE', Deleted.NewTreatmentNearRE, Inserted.NewTreatmentNearRE
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NewTreatmentNearRE <> Deleted.NewTreatmentNearRE
end

-------------------  NewTreatmentNearLE  -----------------------------------------------------

if update(NewTreatmentNearLE)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewTreatmentNearLE', Deleted.NewTreatmentNearLE, Inserted.NewTreatmentNearLE
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NewTreatmentNearLE <> Deleted.NewTreatmentNearLE
end
-------------------  ExistingLVDsNear  -----------------------------------------------------

if update(ExistingLVDsNear)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingLVDsNear', Deleted.ExistingLVDsNear, Inserted.ExistingLVDsNear
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ExistingLVDsNear <> Deleted.ExistingLVDsNear
end

-------------------  ExistingLVDsFar  -----------------------------------------------------

if update(ExistingLVDsFar)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingLVDsFar', Deleted.ExistingLVDsFar, Inserted.ExistingLVDsfar
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ExistingLVDsFar <> Deleted.ExistingLVDsfar
end

-------------------  ExistingVisualAcuityFarLEID  -----------------------------------------------------

if update(ExistingVisualAcuityFarLEID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingVisualAcuityFarLEID', Deleted.ExistingVisualAcuityFarLEID, Inserted.ExistingVisualAcuityFarLEID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ExistingVisualAcuityFarLEID <> Deleted.ExistingVisualAcuityFarLEID
end
-------------------  ExistingVisualAcuityFarREID  -----------------------------------------------------

if update(ExistingVisualAcuityFarREID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingVisualAcuityFarREID', Deleted.ExistingVisualAcuityFarREID, Inserted.ExistingVisualAcuityFarREID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ExistingVisualAcuityFarREID <> Deleted.ExistingVisualAcuityFarREID
end
-------------------  ExistingVisualAcuityNearLEID  -----------------------------------------------------

if update(ExistingVisualAcuityNearLEID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingVisualAcuityNearLEID', Deleted.ExistingVisualAcuityNearLEID, Inserted.ExistingVisualAcuityNearLEID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ExistingVisualAcuityNearLEID <> Deleted.ExistingVisualAcuityNearLEID
end
-------------------  ExistingVisualAcuityNearREID  -----------------------------------------------------

if update(ExistingVisualAcuityNearREID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingVisualAcuityNearREID', Deleted.ExistingVisualAcuityNearREID, Inserted.ExistingVisualAcuityNearREID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ExistingVisualAcuityNearREID <> Deleted.ExistingVisualAcuityNearREID
end

-------------------  NewVisualAcuityFarLEID  -----------------------------------------------------

if update(NewVisualAcuityFarLEID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewVisualAcuityFarLEID', Deleted.NewVisualAcuityFarLEID, Inserted.NewVisualAcuityFarLEID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NewVisualAcuityFarLEID <> Deleted.NewVisualAcuityFarLEID
end
-------------------  NewVisualAcuityFarREID  -----------------------------------------------------

if update(NewVisualAcuityFarREID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewVisualAcuityFarREID', Deleted.NewVisualAcuityFarREID, Inserted.NewVisualAcuityFarREID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NewVisualAcuityFarREID <> Deleted.NewVisualAcuityFarREID
end
-------------------  NewVisualAcuityNearLEID  -----------------------------------------------------

if update(NewVisualAcuityNearLEID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewVisualAcuityNearLEID', Deleted.NewVisualAcuityNearLEID, Inserted.NewVisualAcuityNearLEID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NewVisualAcuityNearLEID <> Deleted.NewVisualAcuityNearLEID
end
-------------------  NewVisualAcuityNearREID  -----------------------------------------------------

if update(NewVisualAcuityNearREID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewVisualAcuityNearREID', Deleted.NewVisualAcuityNearREID, Inserted.NewVisualAcuityNearREID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NewVisualAcuityNearREID <> Deleted.NewVisualAcuityNearREID
end

-------------------  ProblemEncounteredLVDsNear  -----------------------------------------------------

if update(ProblemEncounteredLVDsNear)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProblemEncounteredLVDsNear', Deleted.ProblemEncounteredLVDsNear, Inserted.ProblemEncounteredLVDsNear
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ProblemEncounteredLVDsNear <> Deleted.ProblemEncounteredLVDsNear
end

-------------------  ProblemEncounteredLVDsFar  -----------------------------------------------------

if update(ProblemEncounteredLVDsFar)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProblemEncounteredLVDsFar', Deleted.ProblemEncounteredLVDsFar, Inserted.ProblemEncounteredLVDsFar
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ProblemEncounteredLVDsFar <> Deleted.ProblemEncounteredLVDsFar
end

-------------------  ColourVisionDefectID  -----------------------------------------------------

if update(ColourVisionDefectID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ColourVisionDefectID', Deleted.ColourVisionDefectID, Inserted.ColourVisionDefectID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ColourVisionDefectID <> Deleted.ColourVisionDefectID
end

-------------------  ColourVisionTestUsed  -----------------------------------------------------

if update(ColourVisionTestUsed)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ColourVisionTestUsed', Deleted.ColourVisionTestUsed, Inserted.ColourVisionTestUsed
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ColourVisionTestUsed <> Deleted.ColourVisionTestUsed
end

-------------------  ContrastSensitivityID  -----------------------------------------------------

if update(ContrastSensitivityID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContrastSensitivityID', Deleted.ContrastSensitivityID, Inserted.ContrastSensitivityID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ContrastSensitivityID <> Deleted.ContrastSensitivityID
end


-------------------  ContrastSensitivityTestUsed  -----------------------------------------------------

if update(ContrastSensitivityTestUsed)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContrastSensitivityTestUsed', Deleted.ContrastSensitivityTestUsed, Inserted.ContrastSensitivityTestUsed
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ContrastSensitivityTestUsed <> Deleted.ContrastSensitivityTestUsed
end

-------------------  VisualFieldDefectID  -----------------------------------------------------

if update(VisualFieldDefectID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualFieldDefectID', Deleted.VisualFieldDefectID, Inserted.VisualFieldDefectID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.VisualFieldDefectID <> Deleted.VisualFieldDefectID
end


-------------------  VisualFieldDefectTestUsed  -----------------------------------------------------

if update(VisualFieldDefectTestUsed)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualFieldDefectTestUsed', Deleted.VisualFieldDefectTestUsed, Inserted.VisualFieldDefectTestUsed
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.VisualFieldDefectTestUsed <> Deleted.VisualFieldDefectTestUsed
end

-------------------  LowVisionDevicesFar  -----------------------------------------------------

if update(LowVisionDevicesFar)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LowVisionDevicesFar', Deleted.LowVisionDevicesFar, Inserted.LowVisionDevicesFar
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LowVisionDevicesFar <> Deleted.LowVisionDevicesFar
end

-------------------  LowVisionDevicesNear  -----------------------------------------------------

if update(LowVisionDevicesNear)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LowVisionDevicesNear', Deleted.LowVisionDevicesNear, Inserted.LowVisionDevicesNear
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LowVisionDevicesNear <> Deleted.LowVisionDevicesNear
end

-------------------  NonOpticalAids  -----------------------------------------------------

if update(NonOpticalAids)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NonOpticalAids', Deleted.NonOpticalAids, Inserted.NonOpticalAids
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NonOpticalAids <> Deleted.NonOpticalAids
end


-------------------  Advice  -----------------------------------------------------

if update(Advice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Advice', Deleted.Advice, Inserted.Advice
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Advice <> Deleted.Advice
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: LowVision ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteLowVision')
drop trigger utrDeleteLowVision
go

create trigger utrDeleteLowVision
on LowVision
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'LowVision' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  BriefHistory  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BriefHistory', Deleted.BriefHistory, null from Deleted

-------------------  Profession  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Profession', Deleted.Profession, null from Deleted

-------------------  MajorOcularDiagnosisRE  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MajorOcularDiagnosisRE', Deleted.MajorOcularDiagnosisRE, null from Deleted

-------------------  MajorOcularDiagnosisLE  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MajorOcularDiagnosisLE', Deleted.MajorOcularDiagnosisLE, null from Deleted

-------------------  OtherOcularDiagnosisRE  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherOcularDiagnosisRE', Deleted.OtherOcularDiagnosisRE, null from Deleted

-------------------  OtherOcularDiagnosisLE  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherOcularDiagnosisLE', Deleted.OtherOcularDiagnosisLE, null from Deleted

-------------------  OphthalmologistSeenID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OphthalmologistSeenID', Deleted.OphthalmologistSeenID, null from Deleted

-------------------  OtherImpairmentsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherImpairmentsID', Deleted.OtherImpairmentsID, null from Deleted

-------------------  OtherImpairments  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherImpairments', Deleted.OtherImpairments, null from Deleted

-------------------  ExistingTreatmentFarRE  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingTreatmentFarRE', Deleted.ExistingTreatmentFarRE, null from Deleted

-------------------  ExistingTreatmentFarLE  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingTreatmentFarLE', Deleted.ExistingTreatmentFarLE, null from Deleted

-------------------  ExistingTreatmentNearRE  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingTreatmentNearRE', Deleted.ExistingTreatmentNearRE, null from Deleted

-------------------  ExistingTreatmentNearLE  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingTreatmentNearLE', Deleted.ExistingTreatmentNearLE, null from Deleted

-------------------  NewTreatmentFarRE  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewTreatmentFarRE', Deleted.NewTreatmentFarRE, null from Deleted

-------------------  NewTreatmentFarLE  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewTreatmentFarLE', Deleted.NewTreatmentFarLE, null from Deleted

-------------------  NewTreatmentNearRE  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewTreatmentNearRE', Deleted.NewTreatmentNearRE, null from Deleted

-------------------  NewTreatmentNearLE  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewTreatmentNearLE', Deleted.NewTreatmentNearLE, null from Deleted

-------------------  ExistingVisualAcuityFarLEID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingVisualAcuityFarLEID', Deleted.ExistingVisualAcuityFarLEID, null from Deleted

-------------------  ExistingVisualAcuityFarREID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingVisualAcuityFarREID', Deleted.ExistingVisualAcuityFarREID, null from Deleted

-------------------  ExistingVisualAcuityNearLEID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingVisualAcuityNearLEID', Deleted.ExistingVisualAcuityNearLEID, null from Deleted

-------------------  ExistingVisualAcuityNearREID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingVisualAcuityNearREID', Deleted.ExistingVisualAcuityNearREID, null from Deleted

-------------------  NewVisualAcuityFarLEID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewVisualAcuityFarLEID', Deleted.NewVisualAcuityFarLEID, null from Deleted

-------------------  NewVisualAcuityFarREID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewVisualAcuityFarREID', Deleted.NewVisualAcuityFarREID, null from Deleted

-------------------  NewVisualAcuityNearLEID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewVisualAcuityNearLEID', Deleted.NewVisualAcuityNearLEID, null from Deleted

-------------------  NewVisualAcuityNearREID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewVisualAcuityNearREID', Deleted.NewVisualAcuityNearREID, null from Deleted

-------------------  ExistingLVDsNear  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingLVDsNear', Deleted.ExistingLVDsNear, null from Deleted

-------------------  ExistingLVDsFar  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExistingLVDsfar', Deleted.ExistingLVDsFar, null from Deleted

-------------------  ProblemEncounteredLVDsNear  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProblemEncounteredLVDsNear', Deleted.ProblemEncounteredLVDsNear, null from Deleted

-------------------  ProblemEncounteredLVDsFar  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProblemEncounteredLVDsFar', Deleted.ProblemEncounteredLVDsFar, null from Deleted

-------------------  ColourVisionDefectID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ColourVisionDefectID', Deleted.ColourVisionDefectID, null from Deleted

-------------------  ColourVisionTestUsed  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ColourVisionTestUsed', Deleted.ColourVisionTestUsed, null from Deleted

-------------------  ContrastSensitivityID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContrastSensitivityID', Deleted.ContrastSensitivityID, null from Deleted

-------------------  ContrastSensitivityTestUsed  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContrastSensitivityTestUsed', Deleted.ContrastSensitivityTestUsed, null from Deleted

-------------------  VisualFieldDefectID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualFieldDefectID', Deleted.VisualFieldDefectID, null from Deleted

-------------------  VisualFieldDefectTestUsed  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisualFieldDefectTestUsed', Deleted.VisualFieldDefectTestUsed, null from Deleted

-------------------  LowVisionDevicesFar  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LowVisionDevicesFar', Deleted.LowVisionDevicesFar, null from Deleted

-------------------  LowVisionDevicesNear  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LowVisionDevicesNear', Deleted.LowVisionDevicesNear, null from Deleted

-------------------  NonOpticalAids  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NonOpticalAids', Deleted.NonOpticalAids, null from Deleted

-------------------  Advice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Advice', Deleted.Advice, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: AssetRegister ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAssetRegister')
drop trigger utrUpdateAssetRegister
go

create trigger utrUpdateAssetRegister
on AssetRegister
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'AssetRegister' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-SerialNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SerialNo', Deleted.SerialNo, Inserted.SerialNo
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
end


-------------------  ManufacturerID  -----------------------------------------------------

if update(ManufacturerID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ManufacturerID', Deleted.ManufacturerID, Inserted.ManufacturerID
	from Inserted inner join Deleted
	on Inserted.SerialNo = Deleted.SerialNo
	and Inserted.ManufacturerID <> Deleted.ManufacturerID
end

-------------------  InstitutionalID  -----------------------------------------------------

if update(InstitutionalID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'InstitutionalID', Deleted.InstitutionalID, Inserted.InstitutionalID
	from Inserted inner join Deleted
	on Inserted.SerialNo = Deleted.SerialNo
	and Inserted.InstitutionalID <> Deleted.InstitutionalID
end


-------------------  AssetSourceID  -----------------------------------------------------

if update(AssetSourceID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AssetSourceID', Deleted.AssetSourceID, Inserted.AssetSourceID
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.AssetSourceID <> Deleted.AssetSourceID
end

-------------------  AssetCategoryID  -----------------------------------------------------

if update(AssetCategoryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AssetCategoryID', Deleted.AssetCategoryID, Inserted.AssetCategoryID
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.AssetCategoryID <> Deleted.AssetCategoryID
end

-------------------  DeptID  -----------------------------------------------------

if update(DeptID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DeptID', Deleted.DeptID, Inserted.DeptID
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.DeptID <> Deleted.DeptID
end

-------------------  ItemDescription  -----------------------------------------------------

if update(ItemDescription)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemDescription', Deleted.ItemDescription, Inserted.ItemDescription
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.ItemDescription <> Deleted.ItemDescription
end

-------------------  Brand  -----------------------------------------------------

if update(Brand)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Brand', Deleted.Brand, Inserted.Brand
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.Brand <> Deleted.Brand
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Value  -----------------------------------------------------

if update(Value)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Value', Deleted.Value, Inserted.Value
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.Value <> Deleted.Value
end

-------------------  DateOfPurchase  -----------------------------------------------------

if update(DateOfPurchase)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DateOfPurchase', dbo.FormatDate(Deleted.DateOfPurchase), dbo.FormatDate(Inserted.DateOfPurchase)
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.DateOfPurchase <> Deleted.DateOfPurchase
end

-------------------  SupplierNo  -----------------------------------------------------

if update(SupplierNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SupplierNo', Deleted.SupplierNo, Inserted.SupplierNo
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.SupplierNo <> Deleted.SupplierNo
end

-------------------  InvoiceNo  -----------------------------------------------------

if update(InvoiceNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, Inserted.InvoiceNo
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.InvoiceNo <> Deleted.InvoiceNo
end

-------------------  InvoiceDate  -----------------------------------------------------

if update(InvoiceDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceDate', dbo.FormatDate(Deleted.InvoiceDate), dbo.FormatDate(Inserted.InvoiceDate)
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.InvoiceDate <> Deleted.InvoiceDate
end

-------------------  DateOfDelivery  -----------------------------------------------------

if update(DateOfDelivery)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DateOfDelivery', dbo.FormatDate(Deleted.DateOfDelivery), dbo.FormatDate(Inserted.DateOfDelivery)
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.DateOfDelivery <> Deleted.DateOfDelivery
end

-------------------  SalvageValue  -----------------------------------------------------

if update(SalvageValue)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SalvageValue', Deleted.SalvageValue, Inserted.SalvageValue
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.SalvageValue <> Deleted.SalvageValue
end

-------------------  DepreciationRate  -----------------------------------------------------

if update(DepreciationRate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DepreciationRate', Deleted.DepreciationRate, Inserted.DepreciationRate
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.DepreciationRate <> Deleted.DepreciationRate
end

-------------------  UsefulLife  -----------------------------------------------------

if update(UsefulLife)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UsefulLife', Deleted.UsefulLife, Inserted.UsefulLife
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.UsefulLife <> Deleted.UsefulLife
end

-------------------  DepreciationMethodID  -----------------------------------------------------

if update(DepreciationMethodID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DepreciationMethodID', Deleted.DepreciationMethodID, Inserted.DepreciationMethodID
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.DepreciationMethodID <> Deleted.DepreciationMethodID
end

-------------------  DepreciationStartDate  -----------------------------------------------------

if update(DepreciationStartDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DepreciationStartDate', dbo.FormatDate(Deleted.DepreciationStartDate), dbo.FormatDate(Inserted.DepreciationStartDate)
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.DepreciationStartDate <> Deleted.DepreciationStartDate
end

-------------------  AssignedTo  -----------------------------------------------------

if update(AssignedTo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AssignedTo', Deleted.AssignedTo, Inserted.AssignedTo
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.AssignedTo <> Deleted.AssignedTo
end

-------------------  Location  -----------------------------------------------------

if update(Location)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Location', Deleted.Location, Inserted.Location
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.Location <> Deleted.Location
end

-------------------  ServicingSchedule  -----------------------------------------------------

if update(ServicingSchedule)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServicingSchedule', Deleted.ServicingSchedule, Inserted.ServicingSchedule
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.ServicingSchedule <> Deleted.ServicingSchedule
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: AssetRegister ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAssetRegister')
drop trigger utrDeleteAssetRegister
go

create trigger utrDeleteAssetRegister
on AssetRegister
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'AssetRegister' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  SerialNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SerialNo', Deleted.SerialNo, null from Deleted

-------------------  AssetSourceID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AssetSourceID', Deleted.AssetSourceID, null from Deleted

-------------------  AssetCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AssetCategoryID', Deleted.AssetCategoryID, null from Deleted

-------------------  DeptID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DeptID', Deleted.DeptID, null from Deleted

-------------------  ItemDescription  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemDescription', Deleted.ItemDescription, null from Deleted

-------------------  Brand  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Brand', Deleted.Brand, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Value  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Value', Deleted.Value, null from Deleted

-------------------  DateOfPurchase  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DateOfPurchase', dbo.FormatDate(Deleted.DateOfPurchase), null from Deleted

-------------------  SupplierNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SupplierNo', Deleted.SupplierNo, null from Deleted

-------------------  InvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, null from Deleted

-------------------  InvoiceDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceDate', dbo.FormatDate(Deleted.InvoiceDate), null from Deleted

-------------------  DateOfDelivery  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DateOfDelivery', dbo.FormatDate(Deleted.DateOfDelivery), null from Deleted

-------------------  SalvageValue  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SalvageValue', Deleted.SalvageValue, null from Deleted

-------------------  DepreciationRate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DepreciationRate', Deleted.DepreciationRate, null from Deleted

-------------------  UsefulLife  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UsefulLife', Deleted.UsefulLife, null from Deleted

-------------------  DepreciationMethodID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DepreciationMethodID', Deleted.DepreciationMethodID, null from Deleted

-------------------  DepreciationStartDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DepreciationStartDate', dbo.FormatDate(Deleted.DepreciationStartDate), null from Deleted

-------------------  AssignedTo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AssignedTo', Deleted.AssignedTo, null from Deleted

-------------------  Location  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Location', Deleted.Location, null from Deleted

-------------------  ServicingSchedule  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServicingSchedule', Deleted.ServicingSchedule, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: AssetMaintainanceLog ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAssetMaintainanceLog')
drop trigger utrUpdateAssetMaintainanceLog
go

create trigger utrUpdateAssetMaintainanceLog
on AssetMaintainanceLog
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'AssetMaintainanceLog' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-SerialNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SerialNo', Deleted.SerialNo, Inserted.SerialNo
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.MaintainanceDate = Deleted.MaintainanceDate
end

------------------- Key-MaintainanceDate -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MaintainanceDate', dbo.FormatDate(Deleted.MaintainanceDate), dbo.FormatDate(Inserted.MaintainanceDate)
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.MaintainanceDate = Deleted.MaintainanceDate
end

-------------------  ActionTaken  -----------------------------------------------------

if update(ActionTaken)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ActionTaken', Deleted.ActionTaken, Inserted.ActionTaken
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.MaintainanceDate = Deleted.MaintainanceDate
and Inserted.ActionTaken <> Deleted.ActionTaken
end

-------------------  MaintainedBy  -----------------------------------------------------

if update(MaintainedBy)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MaintainedBy', Deleted.MaintainedBy, Inserted.MaintainedBy
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.MaintainanceDate = Deleted.MaintainanceDate
and Inserted.MaintainedBy <> Deleted.MaintainedBy
end

-------------------  MaintainaceCost  -----------------------------------------------------

if update(MaintainaceCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MaintainaceCost', cast(Deleted.MaintainaceCost as varchar(20)), cast(Inserted.MaintainaceCost as varchar(20))
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.MaintainanceDate = Deleted.MaintainanceDate
and Inserted.MaintainaceCost <> Deleted.MaintainaceCost
end

-------------------  NextDue  -----------------------------------------------------

if update(NextDue)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NextDue', dbo.FormatDate(Deleted.NextDue), dbo.FormatDate(Inserted.NextDue)
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.MaintainanceDate = Deleted.MaintainanceDate
and Inserted.NextDue <> Deleted.NextDue
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.MaintainanceDate = Deleted.MaintainanceDate
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.MaintainanceDate = Deleted.MaintainanceDate
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.SerialNo = Deleted.SerialNo
and Inserted.MaintainanceDate = Deleted.MaintainanceDate
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: AssetMaintainanceLog ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAssetMaintainanceLog')
drop trigger utrDeleteAssetMaintainanceLog
go

create trigger utrDeleteAssetMaintainanceLog
on AssetMaintainanceLog
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'AssetMaintainanceLog' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  SerialNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SerialNo', Deleted.SerialNo, null from Deleted

-------------------  ActionTaken  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ActionTaken', Deleted.ActionTaken, null from Deleted

-------------------  MaintainanceDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MaintainanceDate', dbo.FormatDate(Deleted.MaintainanceDate), null from Deleted

-------------------  MaintainedBy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MaintainedBy', Deleted.MaintainedBy, null from Deleted

-------------------  MaintainaceCost  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MaintainaceCost', cast(Deleted.MaintainaceCost as varchar(20)), null from Deleted

-------------------  NextDue  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NextDue', dbo.FormatDate(Deleted.NextDue), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go
------------------------------------------------------------------------------------------------------
-------------- Update: AccessedCashServices ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAccessedCashServices')
drop trigger utrUpdateAccessedCashServices
go

create trigger utrUpdateAccessedCashServices
on AccessedCashServices
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'AccessedCashServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
end

------------------- Key-ToVisitDate -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ToVisitDate', dbo.FormatDate(Deleted.ToVisitDate), dbo.FormatDate(Inserted.ToVisitDate)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
end

-------------------  AuthorisedBy  -----------------------------------------------------

if update(AuthorisedBy)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AuthorisedBy', Deleted.AuthorisedBy, Inserted.AuthorisedBy
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
and Inserted.AuthorisedBy <> Deleted.AuthorisedBy
end

-------------------  AuthorisationReason  -----------------------------------------------------

if update(AuthorisationReason)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AuthorisationReason', Deleted.AuthorisationReason, Inserted.AuthorisationReason
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
and Inserted.AuthorisationReason <> Deleted.AuthorisationReason
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ToVisitDate = Deleted.ToVisitDate
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: AccessedCashServices ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAccessedCashServices')
drop trigger utrDeleteAccessedCashServices
go

create trigger utrDeleteAccessedCashServices
on AccessedCashServices
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'AccessedCashServices' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ToVisitDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ToVisitDate', dbo.FormatDate(Deleted.ToVisitDate), null from Deleted

-------------------  AuthorisedBy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AuthorisedBy', Deleted.AuthorisedBy, null from Deleted

-------------------  AuthorisationReason  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AuthorisationReason', Deleted.AuthorisationReason, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: ItemLocationOrderLevels ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateItemLocationOrderLevels')
drop trigger utrUpdateItemLocationOrderLevels
go

create trigger utrUpdateItemLocationOrderLevels
on ItemLocationOrderLevels
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ItemLocationOrderLevels' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-LocationID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationID', Deleted.LocationID, Inserted.LocationID
from Inserted inner join Deleted
on Inserted.LocationID = Deleted.LocationID
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.LocationID = Deleted.LocationID
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.LocationID = Deleted.LocationID
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

-------------------  LocationOrderLevel  -----------------------------------------------------

if update(LocationOrderLevel)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationOrderLevel', Deleted.LocationOrderLevel, Inserted.LocationOrderLevel
from Inserted inner join Deleted
on Inserted.LocationID = Deleted.LocationID
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.LocationOrderLevel <> Deleted.LocationOrderLevel
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.LocationID = Deleted.LocationID
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.LocationID = Deleted.LocationID
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.LocationID = Deleted.LocationID
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: ItemLocationOrderLevels ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteItemLocationOrderLevels')
drop trigger utrDeleteItemLocationOrderLevels
go

create trigger utrDeleteItemLocationOrderLevels
on ItemLocationOrderLevels
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ItemLocationOrderLevels' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  LocationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationID', Deleted.LocationID, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  LocationOrderLevel  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationOrderLevel', Deleted.LocationOrderLevel, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: SymptomsHistory ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateSymptomsHistory')
drop trigger utrUpdateSymptomsHistory
go

create trigger utrUpdateSymptomsHistory
on SymptomsHistory
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'SymptomsHistory' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  Fever  -----------------------------------------------------

if update(Fever)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Fever', Deleted.Fever, Inserted.Fever
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Fever <> Deleted.Fever
end

-------------------  Cough  -----------------------------------------------------

if update(Cough)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Cough', Deleted.Cough, Inserted.Cough
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Cough <> Deleted.Cough
end

-------------------  CoughMoreThanTwoWeeks  -----------------------------------------------------

if update(CoughMoreThanTwoWeeks)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoughMoreThanTwoWeeks', Deleted.CoughMoreThanTwoWeeks, Inserted.CoughMoreThanTwoWeeks
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CoughMoreThanTwoWeeks <> Deleted.CoughMoreThanTwoWeeks
end

-------------------  ImmunizationDetails  -----------------------------------------------------

if update(ImmunizationDetails)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ImmunizationDetails', Deleted.ImmunizationDetails, Inserted.ImmunizationDetails
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ImmunizationDetails <> Deleted.ImmunizationDetails
end

-------------------  DifficultyInBreathing  -----------------------------------------------------

if update(DifficultyInBreathing)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DifficultyInBreathing', Deleted.DifficultyInBreathing, Inserted.DifficultyInBreathing
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DifficultyInBreathing <> Deleted.DifficultyInBreathing
end

-------------------  OtherHistory  -----------------------------------------------------

if update(OtherHistory)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherHistory', Deleted.OtherHistory, Inserted.OtherHistory
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OtherHistory <> Deleted.OtherHistory
end

-------------------  Convulsions  -----------------------------------------------------

if update(Convulsions)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Convulsions', Deleted.Convulsions, Inserted.Convulsions
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Convulsions <> Deleted.Convulsions
end

-------------------  AlteredConsciousness  -----------------------------------------------------

if update(AlteredConsciousness)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AlteredConsciousness', Deleted.AlteredConsciousness, Inserted.AlteredConsciousness
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.AlteredConsciousness <> Deleted.AlteredConsciousness
end

-------------------  Vomiting  -----------------------------------------------------

if update(Vomiting)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Vomiting', Deleted.Vomiting, Inserted.Vomiting
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Vomiting <> Deleted.Vomiting
end

-------------------  UnableToDrinkBreastfeed  -----------------------------------------------------

if update(UnableToDrinkBreastfeed)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnableToDrinkBreastfeed', Deleted.UnableToDrinkBreastfeed, Inserted.UnableToDrinkBreastfeed
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.UnableToDrinkBreastfeed <> Deleted.UnableToDrinkBreastfeed
end

-------------------  PastMedicalHistory  -----------------------------------------------------

if update(PastMedicalHistory)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PastMedicalHistory', Deleted.PastMedicalHistory, Inserted.PastMedicalHistory
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PastMedicalHistory <> Deleted.PastMedicalHistory
end

-------------------  Diarrhoea  -----------------------------------------------------

if update(Diarrhoea)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Diarrhoea', Deleted.Diarrhoea, Inserted.Diarrhoea
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Diarrhoea <> Deleted.Diarrhoea
end

-------------------  DiarrhoeaLongerThanTwoWeeks  -----------------------------------------------------

if update(DiarrhoeaLongerThanTwoWeeks)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiarrhoeaLongerThanTwoWeeks', Deleted.DiarrhoeaLongerThanTwoWeeks, Inserted.DiarrhoeaLongerThanTwoWeeks
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DiarrhoeaLongerThanTwoWeeks <> Deleted.DiarrhoeaLongerThanTwoWeeks
end

-------------------  BloodDiarrhoea  -----------------------------------------------------

if update(BloodDiarrhoea)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodDiarrhoea', Deleted.BloodDiarrhoea, Inserted.BloodDiarrhoea
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BloodDiarrhoea <> Deleted.BloodDiarrhoea
end

-------------------  PassingTeaColouredUrine  -----------------------------------------------------

if update(PassingTeaColouredUrine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PassingTeaColouredUrine', Deleted.PassingTeaColouredUrine, Inserted.PassingTeaColouredUrine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PassingTeaColouredUrine <> Deleted.PassingTeaColouredUrine
end

-------------------  FeedingHistory  -----------------------------------------------------

if update(FeedingHistory)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FeedingHistory', Deleted.FeedingHistory, Inserted.FeedingHistory
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.FeedingHistory <> Deleted.FeedingHistory
end



-------------------  Pallor  -----------------------------------------------------

if update(Pallor)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pallor', Deleted.Pallor, Inserted.Pallor
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Pallor <> Deleted.Pallor
end

-------------------  SkinPinchReturn  -----------------------------------------------------

if update(SkinPinchReturn)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SkinPinchReturn', Deleted.SkinPinchReturn, Inserted.SkinPinchReturn
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.SkinPinchReturn <> Deleted.SkinPinchReturn
end

-------------------  SevereWasting  -----------------------------------------------------

if update(SevereWasting)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SevereWasting', Deleted.SevereWasting, Inserted.SevereWasting
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.SevereWasting <> Deleted.SevereWasting
end

-------------------  Edema  -----------------------------------------------------

if update(Edema)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Edema', Deleted.Edema, Inserted.Edema
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Edema <> Deleted.Edema
end

-------------------  SunkenEyes  -----------------------------------------------------

if update(SunkenEyes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SunkenEyes', Deleted.SunkenEyes, Inserted.SunkenEyes
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.SunkenEyes <> Deleted.SunkenEyes
end

-------------------  Jaundice  -----------------------------------------------------

if update(Jaundice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Jaundice', Deleted.Jaundice, Inserted.Jaundice
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Jaundice <> Deleted.Jaundice
end

-------------------  MUAC  -----------------------------------------------------

if update(MUAC)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MUAC', Deleted.MUAC, Inserted.MUAC
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.MUAC <> Deleted.MUAC
end

-------------------  Height  -----------------------------------------------------

if update(Height)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Height', Deleted.Height, Inserted.Height
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Height <> Deleted.Height
end

-------------------  DeepBreathing  -----------------------------------------------------

if update(DeepBreathing)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DeepBreathing', Deleted.DeepBreathing, Inserted.DeepBreathing
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DeepBreathing <> Deleted.DeepBreathing
end

-------------------  FlaringOfNostrils  -----------------------------------------------------

if update(FlaringOfNostrils)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FlaringOfNostrils', Deleted.FlaringOfNostrils, Inserted.FlaringOfNostrils
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.FlaringOfNostrils <> Deleted.FlaringOfNostrils
end

-------------------  IntercostalRecession   -----------------------------------------------------

if update(IntercostalRecession )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IntercostalRecession ', Deleted.IntercostalRecession , Inserted.IntercostalRecession 
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.IntercostalRecession  <> Deleted.IntercostalRecession 
end

-------------------  subCostalRecession   -----------------------------------------------------

if update(subCostalRecession )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'subCostalRecession ', Deleted.subCostalRecession , Inserted.subCostalRecession 
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.subCostalRecession  <> Deleted.subCostalRecession 
end

-------------------  Pulse  -----------------------------------------------------

if update(Pulse)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pulse', Deleted.Pulse, Inserted.Pulse
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Pulse <> Deleted.Pulse
end

-------------------  CapRefill  -----------------------------------------------------

if update(CapRefill)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CapRefill', Deleted.CapRefill, Inserted.CapRefill
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CapRefill <> Deleted.CapRefill
end

-------------------  Airway  -----------------------------------------------------

if update(Airway)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Airway', Deleted.Airway, Inserted.Airway
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Airway <> Deleted.Airway
end

-------------------  Wheezing  -----------------------------------------------------

if update(Wheezing)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Wheezing', Deleted.Wheezing, Inserted.Wheezing
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Wheezing <> Deleted.Wheezing
end

-------------------  PleuralRub  -----------------------------------------------------

if update(PleuralRub)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PleuralRub', Deleted.PleuralRub, Inserted.PleuralRub
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PleuralRub <> Deleted.PleuralRub
end

-------------------  Crackles  -----------------------------------------------------

if update(Crackles)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Crackles', Deleted.Crackles, Inserted.Crackles
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Crackles <> Deleted.Crackles
end

-------------------  Unconscious  -----------------------------------------------------

if update(Unconscious)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Unconscious', Deleted.Unconscious, Inserted.Unconscious
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Unconscious <> Deleted.Unconscious
end

-------------------  Lethargic  -----------------------------------------------------

if update(Lethargic)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Lethargic', Deleted.Lethargic, Inserted.Lethargic
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Lethargic <> Deleted.Lethargic
end

-------------------  UnableToSitStand  -----------------------------------------------------

if update(UnableToSitStand)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnableToSitStand', Deleted.UnableToSitStand, Inserted.UnableToSitStand
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.UnableToSitStand <> Deleted.UnableToSitStand
end

-------------------  BulgingFontanelle  -----------------------------------------------------

if update(BulgingFontanelle)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BulgingFontanelle', Deleted.BulgingFontanelle, Inserted.BulgingFontanelle
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BulgingFontanelle <> Deleted.BulgingFontanelle
end

-------------------  StiffNeck  -----------------------------------------------------

if update(StiffNeck)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StiffNeck', Deleted.StiffNeck, Inserted.StiffNeck
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.StiffNeck <> Deleted.StiffNeck
end

-------------------  KerningsSign  -----------------------------------------------------

if update(KerningsSign)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'KerningsSign', Deleted.KerningsSign, Inserted.KerningsSign
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.KerningsSign <> Deleted.KerningsSign
end



-------------------  IsBloodTransfusionDesired  -----------------------------------------------------

if update(IsBloodTransfusionDesired)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IsBloodTransfusionDesired', Deleted.IsBloodTransfusionDesired, Inserted.IsBloodTransfusionDesired
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.IsBloodTransfusionDesired <> Deleted.IsBloodTransfusionDesired
end

-------------------  BloodTransfusionStateReasons  -----------------------------------------------------

if update(BloodTransfusionStateReasons)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodTransfusionStateReasons', Deleted.BloodTransfusionStateReasons, Inserted.BloodTransfusionStateReasons
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BloodTransfusionStateReasons <> Deleted.BloodTransfusionStateReasons
end

-------------------  IfDesiredWasBloodGiven  -----------------------------------------------------

if update(IfDesiredWasBloodGiven)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IfDesiredWasBloodGiven', Deleted.IfDesiredWasBloodGiven, Inserted.IfDesiredWasBloodGiven
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.IfDesiredWasBloodGiven <> Deleted.IfDesiredWasBloodGiven
end

-------------------  IfYesVolume  -----------------------------------------------------

if update(IfYesVolume)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IfYesVolume', Deleted.IfYesVolume, Inserted.IfYesVolume
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.IfYesVolume <> Deleted.IfYesVolume
end

-------------------  TransfusionDate  -----------------------------------------------------

if update(TransfusionDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransfusionDate', Deleted.TransfusionDate, Inserted.TransfusionDate
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TransfusionDate <> Deleted.TransfusionDate
end

-------------------  BloodUnits  -----------------------------------------------------

if update(BloodUnits)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodUnits', Deleted.BloodUnits, Inserted.BloodUnits
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BloodUnits <> Deleted.BloodUnits
end

-------------------  BloodTransfusionNotGivenStateReasons  -----------------------------------------------------

if update(BloodTransfusionNotGivenStateReasons)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodTransfusionNotGivenStateReasons', Deleted.BloodTransfusionNotGivenStateReasons, Inserted.BloodTransfusionNotGivenStateReasons
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BloodTransfusionNotGivenStateReasons <> Deleted.BloodTransfusionNotGivenStateReasons
end

-------------------  OtherFormsOfSupportiveCare  -----------------------------------------------------

if update(OtherFormsOfSupportiveCare)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherFormsOfSupportiveCare', Deleted.OtherFormsOfSupportiveCare, Inserted.OtherFormsOfSupportiveCare
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OtherFormsOfSupportiveCare <> Deleted.OtherFormsOfSupportiveCare
end

-------------------  ReasonsForDiagnosisOfSevereComplicatedMalaria  -----------------------------------------------------

if update(ReasonsForDiagnosisOfSevereComplicatedMalaria)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReasonsForDiagnosisOfSevereComplicatedMalaria', Deleted.ReasonsForDiagnosisOfSevereComplicatedMalaria, Inserted.ReasonsForDiagnosisOfSevereComplicatedMalaria
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ReasonsForDiagnosisOfSevereComplicatedMalaria <> Deleted.ReasonsForDiagnosisOfSevereComplicatedMalaria
end

-------------------  ReasonsForAdmissionWithPositiveMalariaTest  -----------------------------------------------------

if update(ReasonsForAdmissionWithPositiveMalariaTest)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReasonsForAdmissionWithPositiveMalariaTest', Deleted.ReasonsForAdmissionWithPositiveMalariaTest, Inserted.ReasonsForAdmissionWithPositiveMalariaTest
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ReasonsForAdmissionWithPositiveMalariaTest <> Deleted.ReasonsForAdmissionWithPositiveMalariaTest
end


-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: SymptomsHistory ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteSymptomsHistory')
drop trigger utrDeleteSymptomsHistory
go

create trigger utrDeleteSymptomsHistory
on SymptomsHistory
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'SymptomsHistory' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  Fever  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Fever', Deleted.Fever, null from Deleted

-------------------  Cough  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Cough', Deleted.Cough, null from Deleted

-------------------  CoughMoreThanTwoWeeks  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoughMoreThanTwoWeeks', Deleted.CoughMoreThanTwoWeeks, null from Deleted

-------------------  DifficultyInBreathing  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DifficultyInBreathing', Deleted.DifficultyInBreathing, null from Deleted

-------------------  ImmunizationDetails  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ImmunizationDetails', Deleted.ImmunizationDetails, null from Deleted


-------------------  OtherHistory  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherHistory', Deleted.OtherHistory, null from Deleted

-------------------  Convulsions  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Convulsions', Deleted.Convulsions, null from Deleted

-------------------  AlteredConsciousness  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AlteredConsciousness', Deleted.AlteredConsciousness, null from Deleted

-------------------  Vomiting  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Vomiting', Deleted.Vomiting, null from Deleted

-------------------  UnableToDrinkBreastfeed  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnableToDrinkBreastfeed', Deleted.UnableToDrinkBreastfeed, null from Deleted

-------------------  PastMedicalHistory  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PastMedicalHistory', Deleted.PastMedicalHistory, null from Deleted

-------------------  Diarrhoea  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Diarrhoea', Deleted.Diarrhoea, null from Deleted

-------------------  DiarrhoeaLongerThanTwoWeeks  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiarrhoeaLongerThanTwoWeeks', Deleted.DiarrhoeaLongerThanTwoWeeks, null from Deleted

-------------------  BloodDiarrhoea  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodDiarrhoea', Deleted.BloodDiarrhoea, null from Deleted

-------------------  PassingTeaColouredUrine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PassingTeaColouredUrine', Deleted.PassingTeaColouredUrine, null from Deleted

-------------------  FeedingHistory  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FeedingHistory', Deleted.FeedingHistory, null from Deleted


-------------------  Pallor  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pallor', Deleted.Pallor, null from Deleted

-------------------  SkinPinchReturn  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SkinPinchReturn', Deleted.SkinPinchReturn, null from Deleted

-------------------  SevereWasting  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SevereWasting', Deleted.SevereWasting, null from Deleted

-------------------  Edema  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Edema', Deleted.Edema, null from Deleted

-------------------  SunkenEyes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SunkenEyes', Deleted.SunkenEyes, null from Deleted

-------------------  Jaundice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Jaundice', Deleted.Jaundice, null from Deleted

-------------------  MUAC  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MUAC', Deleted.MUAC, null from Deleted

-------------------  Height  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Height', Deleted.Height, null from Deleted

-------------------  DeepBreathing  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DeepBreathing', Deleted.DeepBreathing, null from Deleted

-------------------  FlaringOfNostrils  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FlaringOfNostrils', Deleted.FlaringOfNostrils, null from Deleted

-------------------  IntercostalRecession   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IntercostalRecession ', Deleted.IntercostalRecession , null from Deleted

-------------------  subCostalRecession   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'subCostalRecession ', Deleted.subCostalRecession , null from Deleted

-------------------  Pulse  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pulse', Deleted.Pulse, null from Deleted

-------------------  CapRefill  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CapRefill', Deleted.CapRefill, null from Deleted

-------------------  Airway  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Airway', Deleted.Airway, null from Deleted

-------------------  Wheezing  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Wheezing', Deleted.Wheezing, null from Deleted

-------------------  PleuralRub  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PleuralRub', Deleted.PleuralRub, null from Deleted

-------------------  Crackles  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Crackles', Deleted.Crackles, null from Deleted


-------------------  Unconscious  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Unconscious', Deleted.Unconscious, null from Deleted

-------------------  Lethargic  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Lethargic', Deleted.Lethargic, null from Deleted

-------------------  UnableToSitStand  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnableToSitStand', Deleted.UnableToSitStand, null from Deleted

-------------------  BulgingFontanelle  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BulgingFontanelle', Deleted.BulgingFontanelle, null from Deleted

-------------------  StiffNeck  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StiffNeck', Deleted.StiffNeck, null from Deleted

-------------------  KerningsSign  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'KerningsSign', Deleted.KerningsSign, null from Deleted

-------------------  IsBloodTransfusionDesired  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IsBloodTransfusionDesired', Deleted.IsBloodTransfusionDesired, null from Deleted

-------------------  BloodTransfusionStateReasons  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodTransfusionStateReasons', Deleted.BloodTransfusionStateReasons, null from Deleted

-------------------  IfDesiredWasBloodGiven  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IfDesiredWasBloodGiven', Deleted.IfDesiredWasBloodGiven, null from Deleted

-------------------  IfYesVolume  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IfYesVolume', Deleted.IfYesVolume, null from Deleted

-------------------  TransfusionDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransfusionDate', Deleted.TransfusionDate, null from Deleted

-------------------  BloodUnits  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodUnits', Deleted.BloodUnits, null from Deleted

-------------------  BloodTransfusionNotGivenStateReasons  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodTransfusionNotGivenStateReasons', Deleted.BloodTransfusionNotGivenStateReasons, null from Deleted

-------------------  OtherFormsOfSupportiveCare  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherFormsOfSupportiveCare', Deleted.OtherFormsOfSupportiveCare, null from Deleted

-------------------  ReasonsForDiagnosisOfSevereComplicatedMalaria  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReasonsForDiagnosisOfSevereComplicatedMalaria', Deleted.ReasonsForDiagnosisOfSevereComplicatedMalaria, null from Deleted

-------------------  ReasonsForAdmissionWithPositiveMalariaTest  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReasonsForAdmissionWithPositiveMalariaTest', Deleted.ReasonsForAdmissionWithPositiveMalariaTest, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Examinations ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateExaminations')
drop trigger utrUpdateExaminations
go

create trigger utrUpdateExaminations
on Examinations
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Examinations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  ExamVisitTypeID  -----------------------------------------------------

if update(ExamVisitTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamVisitTypeID', Deleted.ExamVisitTypeID, Inserted.ExamVisitTypeID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ExamVisitTypeID <> Deleted.ExamVisitTypeID
end

-------------------  FollowupDate  -----------------------------------------------------

if update(FollowupDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FollowupDate', dbo.FormatDate(Deleted.FollowupDate), dbo.FormatDate(Inserted.FollowupDate)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.FollowupDate <> Deleted.FollowupDate
end

-------------------  DurationStartART  -----------------------------------------------------

if update(DurationStartART)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DurationStartART', Deleted.DurationStartART, Inserted.DurationStartART
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DurationStartART <> Deleted.DurationStartART
end

-------------------  DurationCurrentART  -----------------------------------------------------

if update(DurationCurrentART)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DurationCurrentART', Deleted.DurationCurrentART, Inserted.DurationCurrentART
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DurationCurrentART <> Deleted.DurationCurrentART
end

-------------------  OedemaID  -----------------------------------------------------

if update(OedemaID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OedemaID', Deleted.OedemaID, Inserted.OedemaID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OedemaID <> Deleted.OedemaID
end

-------------------  PregnancyStatusID  -----------------------------------------------------

if update(PregnancyStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PregnancyStatusID', Deleted.PregnancyStatusID, Inserted.PregnancyStatusID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PregnancyStatusID <> Deleted.PregnancyStatusID
end

-------------------  ExpectedDeliveryDate  -----------------------------------------------------

if update(ExpectedDeliveryDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpectedDeliveryDate', dbo.FormatDate(Deleted.ExpectedDeliveryDate), dbo.FormatDate(Inserted.ExpectedDeliveryDate)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ExpectedDeliveryDate <> Deleted.ExpectedDeliveryDate
end

-------------------  PMTCT  -----------------------------------------------------

if update(PMTCT)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PMTCT', Deleted.PMTCT, Inserted.PMTCT
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PMTCT <> Deleted.PMTCT
end

-------------------  GestationalAge  -----------------------------------------------------

if update(GestationalAge)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GestationalAge', Deleted.GestationalAge, Inserted.GestationalAge
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.GestationalAge <> Deleted.GestationalAge
end

-------------------  MUACStatusID  -----------------------------------------------------

if update(MUACStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MUACStatusID', Deleted.MUACStatusID, Inserted.MUACStatusID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.MUACStatusID <> Deleted.MUACStatusID
end

-------------------  FPMethods  -----------------------------------------------------

if update(FPMethods)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FPMethods', Deleted.FPMethods, Inserted.FPMethods
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.FPMethods <> Deleted.FPMethods
end

-------------------  TBStatusID  -----------------------------------------------------

if update(TBStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TBStatusID', Deleted.TBStatusID, Inserted.TBStatusID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TBStatusID <> Deleted.TBStatusID
end

-------------------  TBRxStartDate  -----------------------------------------------------

if update(TBRxStartDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TBRxStartDate', dbo.FormatDate(Deleted.TBRxStartDate), dbo.FormatDate(Inserted.TBRxStartDate)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TBRxStartDate <> Deleted.TBRxStartDate
end

-------------------  TBRxStopDate  -----------------------------------------------------

if update(TBRxStopDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TBRxStopDate', dbo.FormatDate(Deleted.TBRxStopDate), dbo.FormatDate(Inserted.TBRxStopDate)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TBRxStopDate <> Deleted.TBRxStopDate
end

-------------------  TBRegNo  -----------------------------------------------------

if update(TBRegNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TBRegNo', Deleted.TBRegNo, Inserted.TBRegNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TBRegNo <> Deleted.TBRegNo
end

-------------------  SideEffects  -----------------------------------------------------

if update(SideEffects)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SideEffects', Deleted.SideEffects, Inserted.SideEffects
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.SideEffects <> Deleted.SideEffects
end

-------------------  NewOI  -----------------------------------------------------

if update(NewOI)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewOI', Deleted.NewOI, Inserted.NewOI
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NewOI <> Deleted.NewOI
end

-------------------  FunctionalStatusID  -----------------------------------------------------

if update(FunctionalStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FunctionalStatusID', Deleted.FunctionalStatusID, Inserted.FunctionalStatusID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.FunctionalStatusID <> Deleted.FunctionalStatusID
end

-------------------  WHOStageID  -----------------------------------------------------

if update(WHOStageID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WHOStageID', Deleted.WHOStageID, Inserted.WHOStageID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.WHOStageID <> Deleted.WHOStageID
end

-------------------  CPTAdhereID  -----------------------------------------------------

if update(CPTAdhereID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CPTAdhereID', Deleted.CPTAdhereID, Inserted.CPTAdhereID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CPTAdhereID <> Deleted.CPTAdhereID
end

-------------------  CPTDosage  -----------------------------------------------------

if update(CPTDosage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CPTDosage', Deleted.CPTDosage, Inserted.CPTDosage
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CPTDosage <> Deleted.CPTDosage
end

-------------------  CPTDuration  -----------------------------------------------------

if update(CPTDuration)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CPTDuration', Deleted.CPTDuration, Inserted.CPTDuration
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CPTDuration <> Deleted.CPTDuration
end

-------------------  OtherMeds  -----------------------------------------------------

if update(OtherMeds)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherMeds', Deleted.OtherMeds, Inserted.OtherMeds
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.OtherMeds <> Deleted.OtherMeds
end

-------------------  NutritionalSupID  -----------------------------------------------------

if update(NutritionalSupID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NutritionalSupID', Deleted.NutritionalSupID, Inserted.NutritionalSupID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NutritionalSupID <> Deleted.NutritionalSupID
end

-------------------  ARVAdhereID  -----------------------------------------------------

if update(ARVAdhereID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARVAdhereID', Deleted.ARVAdhereID, Inserted.ARVAdhereID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ARVAdhereID <> Deleted.ARVAdhereID
end

-------------------  ARVAdhereWhy  -----------------------------------------------------

if update(ARVAdhereWhy)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARVAdhereWhy', Deleted.ARVAdhereWhy, Inserted.ARVAdhereWhy
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ARVAdhereWhy <> Deleted.ARVAdhereWhy
end

-------------------  Combination  -----------------------------------------------------

if update(Combination)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Combination', Deleted.Combination, Inserted.Combination
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Combination <> Deleted.Combination
end

-------------------  ARVDosage  -----------------------------------------------------

if update(ARVDosage)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARVDosage', Deleted.ARVDosage, Inserted.ARVDosage
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ARVDosage <> Deleted.ARVDosage
end

-------------------  ARVDuration  -----------------------------------------------------

if update(ARVDuration)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARVDuration', Deleted.ARVDuration, Inserted.ARVDuration
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ARVDuration <> Deleted.ARVDuration
end

-------------------  CD4ABS  -----------------------------------------------------

if update(CD4ABS)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CD4ABS', Deleted.CD4ABS, Inserted.CD4ABS
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CD4ABS <> Deleted.CD4ABS
end

-------------------  CD4PCT  -----------------------------------------------------

if update(CD4PCT)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CD4PCT', Deleted.CD4PCT, Inserted.CD4PCT
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CD4PCT <> Deleted.CD4PCT
end

-------------------  Investigations  -----------------------------------------------------

if update(Investigations)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Investigations', Deleted.Investigations, Inserted.Investigations
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Investigations <> Deleted.Investigations
end

-------------------  Refer  -----------------------------------------------------

if update(Refer)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Refer', Deleted.Refer, Inserted.Refer
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.Refer <> Deleted.Refer
end

-------------------  DaysHOSP  -----------------------------------------------------

if update(DaysHOSP)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DaysHOSP', Deleted.DaysHOSP, Inserted.DaysHOSP
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.DaysHOSP <> Deleted.DaysHOSP
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: Examinations ------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteExaminations')
drop trigger utrDeleteExaminations
go

create trigger utrDeleteExaminations
on Examinations
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Examinations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  ---------------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ExamVisitTypeID  --------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamVisitTypeID', Deleted.ExamVisitTypeID, null from Deleted

-------------------  FollowupDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FollowupDate', dbo.FormatDate(Deleted.FollowupDate), null from Deleted

-------------------  DurationStartART  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DurationStartART', Deleted.DurationStartART, null from Deleted

-------------------  DurationCurrentART  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DurationCurrentART', Deleted.DurationCurrentART, null from Deleted

-------------------  OedemaID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OedemaID', Deleted.OedemaID, null from Deleted

-------------------  PregnancyStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PregnancyStatusID', Deleted.PregnancyStatusID, null from Deleted

-------------------  ExpectedDeliveryDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpectedDeliveryDate', dbo.FormatDate(Deleted.ExpectedDeliveryDate), null from Deleted

-------------------  PMTCT  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PMTCT', Deleted.PMTCT, null from Deleted

-------------------  GestationalAge  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GestationalAge', Deleted.GestationalAge, null from Deleted

-------------------  MUACStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MUACStatusID', Deleted.MUACStatusID, null from Deleted

-------------------  FPMethods  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FPMethods', Deleted.FPMethods, null from Deleted

-------------------  TBStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TBStatusID', Deleted.TBStatusID, null from Deleted

-------------------  TBRxStartDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TBRxStartDate', dbo.FormatDate(Deleted.TBRxStartDate), null from Deleted

-------------------  TBRxStopDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TBRxStopDate', dbo.FormatDate(Deleted.TBRxStopDate), null from Deleted

-------------------  TBRegNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TBRegNo', Deleted.TBRegNo, null from Deleted

-------------------  SideEffects  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SideEffects', Deleted.SideEffects, null from Deleted

-------------------  NewOI  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewOI', Deleted.NewOI, null from Deleted

-------------------  FunctionalStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FunctionalStatusID', Deleted.FunctionalStatusID, null from Deleted

-------------------  WHOStageID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WHOStageID', Deleted.WHOStageID, null from Deleted

-------------------  CPTAdhereID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CPTAdhereID', Deleted.CPTAdhereID, null from Deleted

-------------------  CPTDosage  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CPTDosage', Deleted.CPTDosage, null from Deleted

-------------------  CPTDuration  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CPTDuration', Deleted.CPTDuration, null from Deleted

-------------------  OtherMeds  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherMeds', Deleted.OtherMeds, null from Deleted

-------------------  NutritionalSupID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NutritionalSupID', Deleted.NutritionalSupID, null from Deleted

-------------------  ARVAdhereID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARVAdhereID', Deleted.ARVAdhereID, null from Deleted

-------------------  ARVAdhereWhy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARVAdhereWhy', Deleted.ARVAdhereWhy, null from Deleted

-------------------  Combination  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Combination', Deleted.Combination, null from Deleted

-------------------  ARVDosage  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARVDosage', Deleted.ARVDosage, null from Deleted

-------------------  ARVDuration  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARVDuration', Deleted.ARVDuration, null from Deleted

-------------------  CD4ABS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CD4ABS', Deleted.CD4ABS, null from Deleted

-------------------  CD4PCT  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CD4PCT', Deleted.CD4PCT, null from Deleted

-------------------  Investigations  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Investigations', Deleted.Investigations, null from Deleted

-------------------  Refer  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Refer', Deleted.Refer, null from Deleted

-------------------  DaysHOSP  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DaysHOSP', Deleted.DaysHOSP, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: HIVCARE ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateHIVCARE')
drop trigger utrUpdateHIVCARE
go

create trigger utrUpdateHIVCARE
on HIVCARE
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'HIVCARE' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-PatientNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
end

-------------------  HealthUnitCode  -----------------------------------------------------

if update(HealthUnitCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HealthUnitCode', Deleted.HealthUnitCode, Inserted.HealthUnitCode
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.HealthUnitCode <> Deleted.HealthUnitCode
end

-------------------  TeamLeader  -----------------------------------------------------

if update(TeamLeader)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TeamLeader', Deleted.TeamLeader, Inserted.TeamLeader
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.TeamLeader <> Deleted.TeamLeader
end

-------------------  PtClinic  -----------------------------------------------------

if update(PtClinic)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PtClinic', Deleted.PtClinic, Inserted.PtClinic
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PtClinic <> Deleted.PtClinic
end

-------------------  LC1  -----------------------------------------------------

if update(LC1)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LC1', Deleted.LC1, Inserted.LC1
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.LC1 <> Deleted.LC1
end


-------------------  ConfirmedTestDate  -----------------------------------------------------

if update(ConfirmedTestDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConfirmedTestDate', dbo.FormatDate(Deleted.ConfirmedTestDate), dbo.FormatDate(Inserted.ConfirmedTestDate)
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.ConfirmedTestDate <> Deleted.ConfirmedTestDate
end

-------------------  HIVEnrolledDate  -----------------------------------------------------

if update(HIVEnrolledDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVEnrolledDate', dbo.FormatDate(Deleted.HIVEnrolledDate), dbo.FormatDate(Inserted.HIVEnrolledDate)
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.HIVEnrolledDate <> Deleted.HIVEnrolledDate
end

-------------------  EligibleARTDate  -----------------------------------------------------

if update(EligibleARTDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EligibleARTDate', dbo.FormatDate(Deleted.EligibleARTDate), dbo.FormatDate(Inserted.EligibleARTDate)
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.EligibleARTDate <> Deleted.EligibleARTDate
end

-------------------  EligibleReadyDate  -----------------------------------------------------

if update(EligibleReadyDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EligibleReadyDate', dbo.FormatDate(Deleted.EligibleReadyDate), dbo.FormatDate(Inserted.EligibleReadyDate)
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.EligibleReadyDate <> Deleted.EligibleReadyDate
end

-------------------  Ab  -----------------------------------------------------

if update(Ab)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Ab', Deleted.Ab, Inserted.Ab
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.Ab <> Deleted.Ab
end

-------------------  PCR  -----------------------------------------------------

if update(PCR)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PCR', Deleted.PCR, Inserted.PCR
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PCR <> Deleted.PCR
end

-------------------  HIVCareWhere  -----------------------------------------------------

if update(HIVCareWhere)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVCareWhere', Deleted.HIVCareWhere, Inserted.HIVCareWhere
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.HIVCareWhere <> Deleted.HIVCareWhere
end

-------------------  HIVCareTransferIn  -----------------------------------------------------

if update(HIVCareTransferIn)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVCareTransferIn', Deleted.HIVCareTransferIn, Inserted.HIVCareTransferIn
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.HIVCareTransferIn <> Deleted.HIVCareTransferIn
end

-------------------  TransferInFrom  -----------------------------------------------------

if update(TransferInFrom)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransferInFrom', Deleted.TransferInFrom, Inserted.TransferInFrom
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.TransferInFrom <> Deleted.TransferInFrom
end

-------------------  WHOStageID  -----------------------------------------------------

if update(WHOStageID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WHOStageID', Deleted.WHOStageID, Inserted.WHOStageID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.WHOStageID <> Deleted.WHOStageID
end

-------------------  CD4  -----------------------------------------------------

if update(CD4)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CD4', Deleted.CD4, Inserted.CD4
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.CD4 <> Deleted.CD4
end

-------------------  PresumptiveHIV  -----------------------------------------------------

if update(PresumptiveHIV)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PresumptiveHIV', Deleted.PresumptiveHIV, Inserted.PresumptiveHIV
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PresumptiveHIV <> Deleted.PresumptiveHIV
end

-------------------  PCRInfant  -----------------------------------------------------

if update(PCRInfant)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PCRInfant', Deleted.PCRInfant, Inserted.PCRInfant
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PCRInfant <> Deleted.PCRInfant
end

-------------------  MedicalConditions  -----------------------------------------------------

if update(MedicalConditions)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalConditions', Deleted.MedicalConditions, Inserted.MedicalConditions
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.MedicalConditions <> Deleted.MedicalConditions
end

-------------------  COHORTMonth  -----------------------------------------------------

if update(COHORTMonth)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'COHORTMonth', Deleted.COHORTMonth, Inserted.COHORTMonth
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.COHORTMonth <> Deleted.COHORTMonth
end

-------------------  COHORTYear  -----------------------------------------------------

if update(COHORTYear)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'COHORTYear', Deleted.COHORTYear, Inserted.COHORTYear
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.COHORTYear <> Deleted.COHORTYear
end

-------------------  ARTTransferInDate  -----------------------------------------------------

if update(ARTTransferInDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARTTransferInDate', dbo.FormatDate(Deleted.ARTTransferInDate), dbo.FormatDate(Inserted.ARTTransferInDate)
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.ARTTransferInDate <> Deleted.ARTTransferInDate
end

-------------------  ARTTransferInFrom  -----------------------------------------------------

if update(ARTTransferInFrom)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARTTransferInFrom', Deleted.ARTTransferInFrom, Inserted.ARTTransferInFrom
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.ARTTransferInFrom <> Deleted.ARTTransferInFrom
end

-------------------  TransferInRegimen  -----------------------------------------------------

if update(TransferInRegimen)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransferInRegimen', Deleted.TransferInRegimen, Inserted.TransferInRegimen
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.TransferInRegimen <> Deleted.TransferInRegimen
end

-------------------  StartARTDate  -----------------------------------------------------

if update(StartARTDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartARTDate', dbo.FormatDate(Deleted.StartARTDate), dbo.FormatDate(Inserted.StartARTDate)
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartARTDate <> Deleted.StartARTDate
end

-------------------  StartARTRegimen  -----------------------------------------------------

if update(StartARTRegimen)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartARTRegimen', Deleted.StartARTRegimen, Inserted.StartARTRegimen
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartARTRegimen <> Deleted.StartARTRegimen
end

-------------------  StartARTWeight  -----------------------------------------------------

if update(StartARTWeight)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartARTWeight', Deleted.StartARTWeight, Inserted.StartARTWeight
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartARTWeight <> Deleted.StartARTWeight
end

-------------------  StartARTWHOStageID  -----------------------------------------------------

if update(StartARTWHOStageID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartARTWHOStageID', Deleted.StartARTWHOStageID, Inserted.StartARTWHOStageID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartARTWHOStageID <> Deleted.StartARTWHOStageID
end

-------------------  StartARTCD4  -----------------------------------------------------

if update(StartARTCD4)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartARTCD4', Deleted.StartARTCD4, Inserted.StartARTCD4
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.StartARTCD4 <> Deleted.StartARTCD4
end

-------------------  PregnancyStatusID  -----------------------------------------------------

if update(PregnancyStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PregnancyStatusID', Deleted.PregnancyStatusID, Inserted.PregnancyStatusID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PregnancyStatusID <> Deleted.PregnancyStatusID
end


-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end

-------------------  ComputerName  -----------------------------------------------------

if update(ComputerName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ComputerName', Deleted.ComputerName, Inserted.ComputerName
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.ComputerName <> Deleted.ComputerName
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.LoginID <> Deleted.LoginID
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: HIVCARE ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteHIVCARE')
drop trigger utrDeleteHIVCARE
go

create trigger utrDeleteHIVCARE
on HIVCARE
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'HIVCARE' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  HealthUnitCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HealthUnitCode', Deleted.HealthUnitCode, null from Deleted

-------------------  TeamLeader  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TeamLeader', Deleted.TeamLeader, null from Deleted

-------------------  PtClinic  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PtClinic', Deleted.PtClinic, null from Deleted

-------------------  LC1  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LC1', Deleted.LC1, null from Deleted

-------------------  ConfirmedTestDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConfirmedTestDate', dbo.FormatDate(Deleted.ConfirmedTestDate), null from Deleted

-------------------  HIVEnrolledDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVEnrolledDate', dbo.FormatDate(Deleted.HIVEnrolledDate), null from Deleted

-------------------  EligibleARTDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EligibleARTDate', dbo.FormatDate(Deleted.EligibleARTDate), null from Deleted

-------------------  EligibleReadyDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EligibleReadyDate', dbo.FormatDate(Deleted.EligibleReadyDate), null from Deleted

-------------------  Ab  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Ab', Deleted.Ab, null from Deleted

-------------------  PCR  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PCR', Deleted.PCR, null from Deleted

-------------------  HIVCareWhere  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVCareWhere', Deleted.HIVCareWhere, null from Deleted

-------------------  HIVCareTransferIn  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVCareTransferIn', Deleted.HIVCareTransferIn, null from Deleted

-------------------  TransferInFrom  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransferInFrom', Deleted.TransferInFrom, null from Deleted

-------------------  WHOStageID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WHOStageID', Deleted.WHOStageID, null from Deleted

-------------------  CD4  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CD4', Deleted.CD4, null from Deleted

-------------------  PresumptiveHIV  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PresumptiveHIV', Deleted.PresumptiveHIV, null from Deleted

-------------------  PCRInfant  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PCRInfant', Deleted.PCRInfant, null from Deleted

-------------------  MedicalConditions  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalConditions', Deleted.MedicalConditions, null from Deleted

-------------------  COHORTMonth  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'COHORTMonth', Deleted.COHORTMonth, null from Deleted

-------------------  COHORTYear  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'COHORTYear', Deleted.COHORTYear, null from Deleted

-------------------  ARTTransferInDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARTTransferInDate', dbo.FormatDate(Deleted.ARTTransferInDate), null from Deleted

-------------------  ARTTransferInFrom  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ARTTransferInFrom', Deleted.ARTTransferInFrom, null from Deleted

-------------------  TransferInRegimen  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransferInRegimen', Deleted.TransferInRegimen, null from Deleted

-------------------  StartARTDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartARTDate', dbo.FormatDate(Deleted.StartARTDate), null from Deleted

-------------------  StartARTRegimen  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartARTRegimen', Deleted.StartARTRegimen, null from Deleted

-------------------  StartARTWeight  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartARTWeight', Deleted.StartARTWeight, null from Deleted

-------------------  StartARTWHOStageID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartARTWHOStageID', Deleted.StartARTWHOStageID, null from Deleted

-------------------  StartARTCD4  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartARTCD4', Deleted.StartARTCD4, null from Deleted

-------------------  PregnancyStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PregnancyStatusID', Deleted.PregnancyStatusID, null from Deleted
-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted

-------------------  ComputerName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ComputerName', Deleted.ComputerName, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: DrugAdministration ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateDrugAdministration')
drop trigger utrUpdateDrugAdministration
go

create trigger utrUpdateDrugAdministration
on DrugAdministration
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'DrugAdministration' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TakenDateTime = Deleted.TakenDateTime
end

------------------- Key-TakenDateTime -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TakenDateTime', dbo.FormatDate(Deleted.TakenDateTime), dbo.FormatDate(Inserted.TakenDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TakenDateTime = Deleted.TakenDateTime
end

-------------------  ItemCode  -----------------------------------------------------

if update(ItemCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TakenDateTime = Deleted.TakenDateTime
and Inserted.ItemCode <> Deleted.ItemCode
end

-------------------  ItemCategory  -----------------------------------------------------

if update(ItemCategory)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategory', Deleted.ItemCategory, Inserted.ItemCategory
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TakenDateTime = Deleted.TakenDateTime
and Inserted.ItemCategory <> Deleted.ItemCategory
end

-------------------  ItemName  -----------------------------------------------------

if update(ItemName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TakenDateTime = Deleted.TakenDateTime
and Inserted.ItemName <> Deleted.ItemName
end

-------------------  QuantityTaken  -----------------------------------------------------

if update(QuantityTaken)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QuantityTaken', Deleted.QuantityTaken, Inserted.QuantityTaken
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TakenDateTime = Deleted.TakenDateTime
and Inserted.QuantityTaken <> Deleted.QuantityTaken
end

-------------------  StaffNo  -----------------------------------------------------

if update(StaffNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TakenDateTime = Deleted.TakenDateTime
and Inserted.StaffNo <> Deleted.StaffNo
end

-------------------  NurseNotes  -----------------------------------------------------

if update(NurseNotes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseNotes', Deleted.NurseNotes, Inserted.NurseNotes
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TakenDateTime = Deleted.TakenDateTime
and Inserted.NurseNotes <> Deleted.NurseNotes
end
-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TakenDateTime = Deleted.TakenDateTime
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TakenDateTime = Deleted.TakenDateTime
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.TakenDateTime = Deleted.TakenDateTime
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: DrugAdministration ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteDrugAdministration')
drop trigger utrDeleteDrugAdministration
go

create trigger utrDeleteDrugAdministration
on DrugAdministration
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'DrugAdministration' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  TakenDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TakenDateTime', dbo.FormatDate(Deleted.TakenDateTime), null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategory  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategory', Deleted.ItemCategory, null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  NurseNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseNotes', Deleted.NurseNotes, null from Deleted

-------------------  QuantityTaken  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QuantityTaken', Deleted.QuantityTaken, null from Deleted

-------------------  StaffNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: ItemAdjustments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateItemAdjustments')
	drop trigger utrUpdateItemAdjustments
go

create trigger utrUpdateItemAdjustments
on ItemAdjustments
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ItemAdjustments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-AdjustmentNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AdjustmentNo', Deleted.AdjustmentNo, Inserted.AdjustmentNo
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-VisitNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end


-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Notes <> Deleted.Notes
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Amount <> Deleted.Amount
end

-------------------  Acknowledgeable  -----------------------------------------------------

if update(Acknowledgeable)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Acknowledgeable', Deleted.Acknowledgeable, Inserted.Acknowledgeable
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Acknowledgeable <> Deleted.Acknowledgeable
end

-------------------  IsAcknowledged  -----------------------------------------------------

if update(IsAcknowledged)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'IsAcknowledged', Deleted.IsAcknowledged, Inserted.IsAcknowledged
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.IsAcknowledged <> Deleted.IsAcknowledged
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: ItemAdjustments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteItemAdjustments')
	drop trigger utrDeleteItemAdjustments
go

create trigger utrDeleteItemAdjustments
on ItemAdjustments
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ItemAdjustments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AdjustmentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdjustmentNo', Deleted.AdjustmentNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  Acknowledgeable  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Acknowledgeable', Deleted.Acknowledgeable, null from Deleted

-------------------  IsAcknowledged  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IsAcknowledged', Deleted.IsAcknowledged, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go




------------------------------------------------------------------------------------------------------
-------------- Update: ItemsIncome ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateItemsIncome')
drop trigger utrUpdateItemsIncome
go

create trigger utrUpdateItemsIncome
on ItemsIncome
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ItemsIncome' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ItemName  -----------------------------------------------------

if update(ItemName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemName <> Deleted.ItemName
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  CopayAmount  -----------------------------------------------------

if update(CopayAmount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CopayAmount', cast(Deleted.CopayAmount as varchar(20)), cast(Inserted.CopayAmount as varchar(20))
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CopayAmount <> Deleted.CopayAmount
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: ItemsIncome ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteItemsIncome')
drop trigger utrDeleteItemsIncome
go

create trigger utrDeleteItemsIncome
on ItemsIncome
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ItemsIncome' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  CopayAmount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CopayAmount', cast(Deleted.CopayAmount as varchar(20)), null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: GoodsReturnedNote ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateGoodsReturnedNote')
drop trigger utrUpdateGoodsReturnedNote
go

create trigger utrUpdateGoodsReturnedNote
on GoodsReturnedNote
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'GoodsReturnedNote' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-ReturnNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnNo', Deleted.ReturnNo, Inserted.ReturnNo
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
end

-------------------  ReturnID  -----------------------------------------------------

if update(ReturnID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnID', Deleted.ReturnID, Inserted.ReturnID
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.ReturnID <> Deleted.ReturnID
end

-------------------  GRNNo  -----------------------------------------------------

if update(GRNNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GRNNo', Deleted.GRNNo, Inserted.GRNNo
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.GRNNo <> Deleted.GRNNo
end

-------------------  ReturnDate  -----------------------------------------------------

if update(ReturnDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnDate', dbo.FormatDate(Deleted.ReturnDate), dbo.FormatDate(Inserted.ReturnDate)
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.ReturnDate <> Deleted.ReturnDate
end

-------------------  AmountWords  -----------------------------------------------------

if update(AmountWords)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountWords', Deleted.AmountWords, Inserted.AmountWords
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.AmountWords <> Deleted.AmountWords
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: GoodsReturnedNote ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteGoodsReturnedNote')
drop trigger utrDeleteGoodsReturnedNote
go

create trigger utrDeleteGoodsReturnedNote
on GoodsReturnedNote
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'GoodsReturnedNote' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ReturnID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnID', Deleted.ReturnID, null from Deleted

-------------------  ReturnNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnNo', Deleted.ReturnNo, null from Deleted

-------------------  GRNNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GRNNo', Deleted.GRNNo, null from Deleted

-------------------  ReturnDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnDate', dbo.FormatDate(Deleted.ReturnDate), null from Deleted

-------------------  AmountWords  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountWords', Deleted.AmountWords, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: GoodsReturnedNoteDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateGoodsReturnedNoteDetails')
drop trigger utrUpdateGoodsReturnedNoteDetails
go

create trigger utrUpdateGoodsReturnedNoteDetails
on GoodsReturnedNoteDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'GoodsReturnedNoteDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-ReturnNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnNo', Deleted.ReturnNo, Inserted.ReturnNo
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

-------------------  ItemName  -----------------------------------------------------

if update(ItemName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemName <> Deleted.ItemName
end

-------------------  ReturnQuantity  -----------------------------------------------------

if update(ReturnQuantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnQuantity', Deleted.ReturnQuantity, Inserted.ReturnQuantity
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ReturnQuantity <> Deleted.ReturnQuantity
end

-------------------  GoodsReturnReasonID  -----------------------------------------------------

if update(GoodsReturnReasonID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GoodsReturnReasonID', Deleted.GoodsReturnReasonID, Inserted.GoodsReturnReasonID
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.GoodsReturnReasonID <> Deleted.GoodsReturnReasonID
end



-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ReturnNo = Deleted.ReturnNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: GoodsReturnedNoteDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteGoodsReturnedNoteDetails')
drop trigger utrDeleteGoodsReturnedNoteDetails
go

create trigger utrDeleteGoodsReturnedNoteDetails
on GoodsReturnedNoteDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'GoodsReturnedNoteDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ReturnNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnNo', Deleted.ReturnNo, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  ReturnQuantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnQuantity', Deleted.ReturnQuantity, null from Deleted

-------------------  GoodsReturnReasonID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GoodsReturnReasonID', Deleted.GoodsReturnReasonID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: BulkMessaging ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateBulkMessaging')
drop trigger utrUpdateBulkMessaging
go

create trigger utrUpdateBulkMessaging
on BulkMessaging
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'BulkMessaging' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-MessageNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MessageNo', Deleted.MessageNo, Inserted.MessageNo
from Inserted inner join Deleted
on Inserted.MessageNo = Deleted.MessageNo
end

-------------------  MessageID  -----------------------------------------------------

if update(MessageID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MessageID', Deleted.MessageID, Inserted.MessageID
from Inserted inner join Deleted
on Inserted.MessageNo = Deleted.MessageNo
and Inserted.MessageID <> Deleted.MessageID
end

-------------------  Phone  -----------------------------------------------------

if update(Phone)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, Inserted.Phone
from Inserted inner join Deleted
on Inserted.MessageNo = Deleted.MessageNo
and Inserted.Phone <> Deleted.Phone
end

-------------------  Message  -----------------------------------------------------

if update(Message)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Message', Deleted.Message, Inserted.Message
from Inserted inner join Deleted
on Inserted.MessageNo = Deleted.MessageNo
and Inserted.Message <> Deleted.Message
end

-------------------  SentID  -----------------------------------------------------
if update(SentID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SentID', Deleted.SentID, Inserted.SentID
from Inserted inner join Deleted
on Inserted.MessageNo = Deleted.MessageNo
and Inserted.SentID <> Deleted.SentID
end

-------------------  flagID  -----------------------------------------------------

if update(flagID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'flagID', Deleted.flagID, Inserted.flagID
from Inserted inner join Deleted
on Inserted.MessageNo = Deleted.MessageNo
and Inserted.flagID <> Deleted.flagID
end
-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.MessageNo = Deleted.MessageNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.MessageNo = Deleted.MessageNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.MessageNo = Deleted.MessageNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: BulkMessaging ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteBulkMessaging')
drop trigger utrDeleteBulkMessaging
go

create trigger utrDeleteBulkMessaging
on BulkMessaging
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'BulkMessaging' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  MessageID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MessageID', Deleted.MessageID, null from Deleted

-------------------  MessageNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MessageNo', Deleted.MessageNo, null from Deleted

-------------------  Phone  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Phone', Deleted.Phone, null from Deleted

-------------------  Message  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Message', Deleted.Message, null from Deleted

-------------------  flagID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'flagID', Deleted.flagID, null from Deleted

-------------------  SentID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SentID', Deleted.SentID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Delete: Messenger ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteMessenger')
drop trigger utrDeleteMessenger
go

create trigger utrDeleteMessenger
on Messenger
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Messenger' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ReceiverStaffNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiverStaffNo', Deleted.ReceiverStaffNo, null from Deleted

-------------------  MessageInfo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MessageInfo', Deleted.MessageInfo, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted

-------------------  Status  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Status', Deleted.Status, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: BarCodeDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateBarCodeDetails')
drop trigger utrUpdateBarCodeDetails
go

create trigger utrUpdateBarCodeDetails
on BarCodeDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'BarCodeDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime = Deleted.RecordDateTime
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime = Deleted.RecordDateTime
end

------------------- Key-RecordDateTime -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime = Deleted.RecordDateTime
end

-------------------  BarCode  -----------------------------------------------------

if update(BarCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BarCode', Deleted.BarCode, Inserted.BarCode
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime = Deleted.RecordDateTime
and Inserted.BarCode <> Deleted.BarCode
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime = Deleted.RecordDateTime
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime = Deleted.RecordDateTime
and Inserted.ClientMachine <> Deleted.ClientMachine
end


go


------------------------------------------------------------------------------------------------------
-------------- Delete: BarCodeDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteBarCodeDetails')
drop trigger utrDeleteBarCodeDetails
go

create trigger utrDeleteBarCodeDetails
on BarCodeDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'BarCodeDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  BarCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BarCode', Deleted.BarCode, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: PhysicalStockCount ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePhysicalStockCount')
	drop trigger utrUpdatePhysicalStockCount
go

create trigger utrUpdatePhysicalStockCount
on PhysicalStockCount
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PhysicalStockCount' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-PSCNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PSCNo', Deleted.PSCNo, Inserted.PSCNo
	from Inserted inner join Deleted
	on Inserted.PSCNo = Deleted.PSCNo
end

-------------------  PSCID  -----------------------------------------------------

if update(PSCID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PSCID', Deleted.PSCID, Inserted.PSCID
	from Inserted inner join Deleted
	on Inserted.PSCNo = Deleted.PSCNo
	and Inserted.PSCID <> Deleted.PSCID
end

-------------------  GeneralNotes  -----------------------------------------------------

if update(GeneralNotes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'GeneralNotes', Deleted.GeneralNotes, Inserted.GeneralNotes
	from Inserted inner join Deleted
	on Inserted.PSCNo = Deleted.PSCNo
	and Inserted.GeneralNotes <> Deleted.GeneralNotes
end

-------------------  StartDate  -----------------------------------------------------

if update(StartDate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'StartDate', dbo.FormatDate(Deleted.StartDate), dbo.FormatDate(Inserted.StartDate)
	from Inserted inner join Deleted
	on Inserted.PSCNo = Deleted.PSCNo
	and Inserted.StartDate <> Deleted.StartDate
end

-------------------  EndDate  -----------------------------------------------------

if update(EndDate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'EndDate', dbo.FormatDate(Deleted.EndDate), dbo.FormatDate(Inserted.EndDate)
	from Inserted inner join Deleted
	on Inserted.PSCNo = Deleted.PSCNo
	and Inserted.EndDate <> Deleted.EndDate
end

-------------------  Closed  -----------------------------------------------------

if update(Closed)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Closed', Deleted.Closed, Inserted.Closed
	from Inserted inner join Deleted
	on Inserted.PSCNo = Deleted.PSCNo
	and Inserted.Closed <> Deleted.Closed
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.PSCNo = Deleted.PSCNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.PSCNo = Deleted.PSCNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.PSCNo = Deleted.PSCNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PhysicalStockCount ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePhysicalStockCount')
	drop trigger utrDeletePhysicalStockCount
go

create trigger utrDeletePhysicalStockCount
on PhysicalStockCount
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PhysicalStockCount' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PSCID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PSCID', Deleted.PSCID, null from Deleted

-------------------  PSCNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PSCNo', Deleted.PSCNo, null from Deleted

-------------------  GeneralNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GeneralNotes', Deleted.GeneralNotes, null from Deleted

-------------------  StartDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartDate', dbo.FormatDate(Deleted.StartDate), null from Deleted

-------------------  EndDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EndDate', dbo.FormatDate(Deleted.EndDate), null from Deleted

-------------------  Closed  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Closed', Deleted.Closed, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: PhysicalStockCountDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePhysicalStockCountDetails')
drop trigger utrUpdatePhysicalStockCountDetails
go

create trigger utrUpdatePhysicalStockCountDetails
on PhysicalStockCountDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PhysicalStockCountDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-PSCNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PSCNo', Deleted.PSCNo, Inserted.PSCNo
from Inserted inner join Deleted
on Inserted.PSCNo = Deleted.PSCNo
and Inserted.LocationID  = Deleted.LocationID 
and Inserted.ItemCategoryID  = Deleted.ItemCategoryID 
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-LocationID  -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationID ', Deleted.LocationID , Inserted.LocationID 
from Inserted inner join Deleted
on Inserted.PSCNo = Deleted.PSCNo
and Inserted.LocationID  = Deleted.LocationID 
and Inserted.ItemCategoryID  = Deleted.ItemCategoryID 
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCategoryID  -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID ', Deleted.ItemCategoryID , Inserted.ItemCategoryID 
from Inserted inner join Deleted
on Inserted.PSCNo = Deleted.PSCNo
and Inserted.LocationID  = Deleted.LocationID 
and Inserted.ItemCategoryID  = Deleted.ItemCategoryID 
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.PSCNo = Deleted.PSCNo
and Inserted.LocationID  = Deleted.LocationID 
and Inserted.ItemCategoryID  = Deleted.ItemCategoryID 
and Inserted.ItemCode = Deleted.ItemCode
end

-------------------  SystemQuantity  -----------------------------------------------------

if update(SystemQuantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SystemQuantity', Deleted.SystemQuantity, Inserted.SystemQuantity
from Inserted inner join Deleted
on Inserted.PSCNo = Deleted.PSCNo
and Inserted.LocationID  = Deleted.LocationID 
and Inserted.ItemCategoryID  = Deleted.ItemCategoryID 
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.SystemQuantity <> Deleted.SystemQuantity
end

-------------------  PhysicalCountQuantity  -----------------------------------------------------

if update(PhysicalCountQuantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhysicalCountQuantity', Deleted.PhysicalCountQuantity, Inserted.PhysicalCountQuantity
from Inserted inner join Deleted
on Inserted.PSCNo = Deleted.PSCNo
and Inserted.LocationID  = Deleted.LocationID 
and Inserted.ItemCategoryID  = Deleted.ItemCategoryID 
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.PhysicalCountQuantity <> Deleted.PhysicalCountQuantity
end

-------------------  PhysicalCountQuantity  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.PSCNo = Deleted.PSCNo
and Inserted.LocationID  = Deleted.LocationID 
and Inserted.ItemCategoryID  = Deleted.ItemCategoryID 
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.PSCNo = Deleted.PSCNo
and Inserted.LocationID  = Deleted.LocationID 
and Inserted.ItemCategoryID  = Deleted.ItemCategoryID 
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.PSCNo = Deleted.PSCNo
and Inserted.LocationID  = Deleted.LocationID 
and Inserted.ItemCategoryID  = Deleted.ItemCategoryID 
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.PSCNo = Deleted.PSCNo
and Inserted.LocationID  = Deleted.LocationID 
and Inserted.ItemCategoryID  = Deleted.ItemCategoryID 
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PhysicalStockCountDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePhysicalStockCountDetails')
drop trigger utrDeletePhysicalStockCountDetails
go

create trigger utrDeletePhysicalStockCountDetails
on PhysicalStockCountDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PhysicalStockCountDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PSCNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PSCNo', Deleted.PSCNo, null from Deleted

-------------------  LocationID   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationID ', Deleted.LocationID , null from Deleted

-------------------  ItemCategoryID   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID ', Deleted.ItemCategoryID , null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  SystemQuantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SystemQuantity', Deleted.SystemQuantity, null from Deleted

-------------------  PhysicalCountQuantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhysicalCountQuantity', Deleted.PhysicalCountQuantity, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: IPDNurse ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDNurse')
drop trigger utrUpdateIPDNurse
go

create trigger utrUpdateIPDNurse
on IPDNurse
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDNurse' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-NurseRoundNo  -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseRoundNo ', Deleted.NurseRoundNo , Inserted.NurseRoundNo 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
end

-------------------  RoundNo   -----------------------------------------------------

if update(RoundNo )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo ', Deleted.RoundNo , Inserted.RoundNo 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.RoundNo  <> Deleted.RoundNo 
end

-------------------  Weight   -----------------------------------------------------

if update(Weight )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Weight ', Deleted.Weight , Inserted.Weight 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.Weight  <> Deleted.Weight 
end

-------------------  Temperature   -----------------------------------------------------

if update(Temperature )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Temperature ', Deleted.Temperature , Inserted.Temperature 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.Temperature  <> Deleted.Temperature 
end

-------------------  Height   -----------------------------------------------------

if update(Height )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Height ', Deleted.Height , Inserted.Height 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.Height  <> Deleted.Height 
end

-------------------  Pulse   -----------------------------------------------------

if update(Pulse )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pulse ', Deleted.Pulse , Inserted.Pulse 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.Pulse  <> Deleted.Pulse 
end

-------------------  BloodPressure   -----------------------------------------------------

if update(BloodPressure )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodPressure ', Deleted.BloodPressure , Inserted.BloodPressure 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.BloodPressure  <> Deleted.BloodPressure 
end

-------------------  HeadCircum   -----------------------------------------------------

if update(HeadCircum )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeadCircum ', Deleted.HeadCircum , Inserted.HeadCircum 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.HeadCircum  <> Deleted.HeadCircum 
end

-------------------  BodySurfaceArea   -----------------------------------------------------

if update(BodySurfaceArea )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BodySurfaceArea ', Deleted.BodySurfaceArea , Inserted.BodySurfaceArea 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.BodySurfaceArea  <> Deleted.BodySurfaceArea 
end

-------------------  RespirationRate   -----------------------------------------------------

if update(RespirationRate )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RespirationRate ', Deleted.RespirationRate , Inserted.RespirationRate 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.RespirationRate  <> Deleted.RespirationRate 
end

-------------------  OxygenSaturation   -----------------------------------------------------

if update(OxygenSaturation )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OxygenSaturation ', Deleted.OxygenSaturation , Inserted.OxygenSaturation 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.OxygenSaturation  <> Deleted.OxygenSaturation 
end

-------------------  HeartRate   -----------------------------------------------------

if update(HeartRate )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeartRate ', Deleted.HeartRate , Inserted.HeartRate 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.HeartRate  <> Deleted.HeartRate 
end

-------------------  Notes   -----------------------------------------------------

if update(Notes )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes ', Deleted.Notes , Inserted.Notes 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.Notes  <> Deleted.Notes 
end

-------------------  NurseRoundDateTime   -----------------------------------------------------

if update(NurseRoundDateTime )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseRoundDateTime ', dbo.FormatDate(Deleted.NurseRoundDateTime ), dbo.FormatDate(Inserted.NurseRoundDateTime )
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.NurseRoundDateTime  <> Deleted.NurseRoundDateTime 
end

-------------------  StaffNo   -----------------------------------------------------

if update(StaffNo )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo ', Deleted.StaffNo , Inserted.StaffNo 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.StaffNo  <> Deleted.StaffNo 
end

-------------------  OtherAttendingNurse   -----------------------------------------------------

if update(OtherAttendingNurse )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherAttendingNurse ', Deleted.OtherAttendingNurse , Inserted.OtherAttendingNurse 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.OtherAttendingNurse  <> Deleted.OtherAttendingNurse 
end

-------------------  LoginID   -----------------------------------------------------

if update(LoginID )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID ', Deleted.LoginID , Inserted.LoginID 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.LoginID  <> Deleted.LoginID 
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime    -----------------------------------------------------

if update(RecordDateTime  )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime  ', dbo.FormatDate(Deleted.RecordDateTime  ), dbo.FormatDate(Inserted.RecordDateTime  )
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.RecordDateTime   <> Deleted.RecordDateTime  
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: IPDNurse ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDNurse')
drop trigger utrDeleteIPDNurse
go

create trigger utrDeleteIPDNurse
on IPDNurse
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDNurse' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  NurseRoundNo   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseRoundNo ', Deleted.NurseRoundNo , null from Deleted

-------------------  RoundNo   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo ', Deleted.RoundNo , null from Deleted

-------------------  Weight   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Weight ', Deleted.Weight , null from Deleted

-------------------  Temperature   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Temperature ', Deleted.Temperature , null from Deleted

-------------------  Height   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Height ', Deleted.Height , null from Deleted

-------------------  Pulse   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pulse ', Deleted.Pulse , null from Deleted

-------------------  BloodPressure   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodPressure ', Deleted.BloodPressure , null from Deleted

-------------------  HeadCircum   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeadCircum ', Deleted.HeadCircum , null from Deleted

-------------------  BodySurfaceArea   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BodySurfaceArea ', Deleted.BodySurfaceArea , null from Deleted

-------------------  RespirationRate   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RespirationRate ', Deleted.RespirationRate , null from Deleted

-------------------  OxygenSaturation   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OxygenSaturation ', Deleted.OxygenSaturation , null from Deleted

-------------------  HeartRate   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeartRate ', Deleted.HeartRate , null from Deleted

-------------------  Notes   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes ', Deleted.Notes , null from Deleted

-------------------  NurseRoundDateTime   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseRoundDateTime ', dbo.FormatDate(Deleted.NurseRoundDateTime ), null from Deleted

-------------------  StaffNo   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo ', Deleted.StaffNo , null from Deleted

-------------------  OtherAttendingNurse   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherAttendingNurse ', Deleted.OtherAttendingNurse , null from Deleted

-------------------  LoginID   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID ', Deleted.LoginID , null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime    -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime  ', dbo.FormatDate(Deleted.RecordDateTime  ), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: IPDDrugAdministration ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDDrugAdministration')
drop trigger utrUpdateIPDDrugAdministration
go

create trigger utrUpdateIPDDrugAdministration
on IPDDrugAdministration
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDDrugAdministration' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-NurseRoundNo  -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseRoundNo ', Deleted.NurseRoundNo , Inserted.NurseRoundNo 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
end

-------------------  TakenDateTime  -----------------------------------------------------

if update(TakenDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TakenDateTime', Deleted.TakenDateTime, Inserted.TakenDateTime
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.TakenDateTime <> Deleted.TakenDateTime
end

-------------------  ItemCode   -----------------------------------------------------

if update(ItemCode )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode ', Deleted.ItemCode , Inserted.ItemCode 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.ItemCode  <> Deleted.ItemCode 
end

-------------------  ItemCategoryID   -----------------------------------------------------

if update(ItemCategoryID )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID ', Deleted.ItemCategoryID , Inserted.ItemCategoryID 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.ItemCategoryID  <> Deleted.ItemCategoryID 
end

-------------------  ItemName  -----------------------------------------------------

if update(ItemName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.ItemName <> Deleted.ItemName
end

-------------------  QuantityTaken  -----------------------------------------------------

if update(QuantityTaken)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QuantityTaken', Deleted.QuantityTaken, Inserted.QuantityTaken
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.QuantityTaken <> Deleted.QuantityTaken
end

-------------------  StaffNo   -----------------------------------------------------

if update(StaffNo )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo ', Deleted.StaffNo , Inserted.StaffNo 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.StaffNo  <> Deleted.StaffNo 
end

-------------------  NurseNotes   -----------------------------------------------------

if update(NurseNotes )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseNotes ', Deleted.NurseNotes , Inserted.NurseNotes 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.NurseNotes  <> Deleted.NurseNotes 
end

-------------------  LoginID   -----------------------------------------------------

if update(LoginID )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID ', Deleted.LoginID , Inserted.LoginID 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.LoginID  <> Deleted.LoginID 
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime    -----------------------------------------------------

if update(RecordDateTime  )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime  ', dbo.FormatDate(Deleted.RecordDateTime  ), dbo.FormatDate(Inserted.RecordDateTime  )
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.RecordDateTime   <> Deleted.RecordDateTime  
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: IPDDrugAdministration ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDDrugAdministration')
drop trigger utrDeleteIPDDrugAdministration
go

create trigger utrDeleteIPDDrugAdministration
on IPDDrugAdministration
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDDrugAdministration' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  NurseRoundNo   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseRoundNo ', Deleted.NurseRoundNo , null from Deleted

-------------------  TakenDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TakenDateTime', Deleted.TakenDateTime, null from Deleted

-------------------  ItemCode   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode ', Deleted.ItemCode , null from Deleted

-------------------  ItemCategoryID   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID ', Deleted.ItemCategoryID , null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  QuantityTaken  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QuantityTaken', Deleted.QuantityTaken, null from Deleted

-------------------  StaffNo   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo ', Deleted.StaffNo , null from Deleted

-------------------  NurseNotes   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseNotes ', Deleted.NurseNotes , null from Deleted

-------------------  LoginID   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID ', Deleted.LoginID , null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime    -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime  ', dbo.FormatDate(Deleted.RecordDateTime  ), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: IPDNurseFluids ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDNurseFluids')
drop trigger utrUpdateIPDNurseFluids
go

create trigger utrUpdateIPDNurseFluids
on IPDNurseFluids
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDNurseFluids' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-NurseRoundNo  -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseRoundNo ', Deleted.NurseRoundNo , Inserted.NurseRoundNo 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
end

-------------------  TakenDateTime  -----------------------------------------------------

if update(TakenDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TakenDateTime', Deleted.TakenDateTime, Inserted.TakenDateTime
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.TakenDateTime <> Deleted.TakenDateTime
end

-------------------  FluidTypeID  -----------------------------------------------------

if update(FluidTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FluidTypeID', Deleted.FluidTypeID, Inserted.FluidTypeID
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.FluidTypeID <> Deleted.FluidTypeID
end

-------------------  FluidCategoryID  -----------------------------------------------------

if update(FluidCategoryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FluidCategoryID', Deleted.FluidCategoryID, Inserted.FluidCategoryID
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.FluidCategoryID <> Deleted.FluidCategoryID
end

-------------------  RouteID  -----------------------------------------------------

if update(RouteID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RouteID', Deleted.RouteID, Inserted.RouteID
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.RouteID <> Deleted.RouteID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  StaffNo   -----------------------------------------------------

--if update(StaffNo )
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'StaffNo ', Deleted.StaffNo , Inserted.StaffNo 
--	from Inserted inner join Deleted
--	on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
--	and Inserted.StaffNo  <> Deleted.StaffNo 
--end

-------------------  NurseNotes   -----------------------------------------------------

if update(NurseNotes )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseNotes ', Deleted.NurseNotes , Inserted.NurseNotes 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.NurseNotes  <> Deleted.NurseNotes 
end

-------------------  LoginID   -----------------------------------------------------

if update(LoginID )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID ', Deleted.LoginID , Inserted.LoginID 
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.LoginID  <> Deleted.LoginID 
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime    -----------------------------------------------------

if update(RecordDateTime  )
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime  ', dbo.FormatDate(Deleted.RecordDateTime  ), dbo.FormatDate(Inserted.RecordDateTime  )
from Inserted inner join Deleted
on Inserted.NurseRoundNo  = Deleted.NurseRoundNo 
and Inserted.RecordDateTime   <> Deleted.RecordDateTime  
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: IPDNurseFluids ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDNurseFluids')
drop trigger utrDeleteIPDNurseFluids
go

create trigger utrDeleteIPDNurseFluids
on IPDNurseFluids
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDNurseFluids' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  NurseRoundNo   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseRoundNo ', Deleted.NurseRoundNo , null from Deleted

-------------------  TakenDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TakenDateTime', Deleted.TakenDateTime, null from Deleted

-------------------  FluidTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FluidTypeID', Deleted.FluidTypeID, null from Deleted

-------------------  FluidCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FluidCategoryID', Deleted.FluidCategoryID, null from Deleted

-------------------  RouteID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RouteID', Deleted.RouteID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  StaffNo   -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'StaffNo ', Deleted.StaffNo , null from Deleted

-------------------  NurseNotes   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseNotes ', Deleted.NurseNotes , null from Deleted

-------------------  LoginID   -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID ', Deleted.LoginID , null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime    -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime  ', dbo.FormatDate(Deleted.RecordDateTime  ), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: BankAccounts ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateBankAccounts')
drop trigger utrUpdateBankAccounts
go

create trigger utrUpdateBankAccounts
on BankAccounts
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'BankAccounts' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-AccountNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
end

-------------------  AccountName  -----------------------------------------------------

if update(AccountName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountName', Deleted.AccountName, Inserted.AccountName
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.AccountName <> Deleted.AccountName
end

-------------------  BankNameID  -----------------------------------------------------

if update(BankNameID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BankNameID', Deleted.BankNameID, Inserted.BankNameID
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.BankNameID <> Deleted.BankNameID
end

-------------------  CurrencyID  -----------------------------------------------------

if update(CurrencyID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrencyID', Deleted.CurrencyID, Inserted.CurrencyID
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.CurrencyID <> Deleted.CurrencyID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.AccountNo = Deleted.AccountNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: BankAccounts ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteBankAccounts')
drop trigger utrDeleteBankAccounts
go

create trigger utrDeleteBankAccounts
on BankAccounts
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'BankAccounts' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AccountNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, null from Deleted

-------------------  AccountName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountName', Deleted.AccountName, null from Deleted

-------------------  BankNameID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BankNameID', Deleted.BankNameID, null from Deleted

-------------------  CurrencyID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrencyID', Deleted.CurrencyID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: BankingRegister ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateBankingRegister')
drop trigger utrUpdateBankingRegister
go

create trigger utrUpdateBankingRegister
on BankingRegister
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'BankingRegister' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RegisterNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RegisterNo', Deleted.RegisterNo, Inserted.RegisterNo
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
end

-------------------  RegisterID  -----------------------------------------------------


-------------------  CollectionStartDate  -----------------------------------------------------

if update(CollectionStartDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CollectionStartDate', dbo.FormatDate(Deleted.CollectionStartDate), dbo.FormatDate(Inserted.CollectionStartDate)
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.CollectionStartDate <> Deleted.CollectionStartDate
end

-------------------  CollectionEndDate  -----------------------------------------------------

if update(CollectionEndDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CollectionEndDate', dbo.FormatDate(Deleted.CollectionEndDate), dbo.FormatDate(Inserted.CollectionEndDate)
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.CollectionEndDate <> Deleted.CollectionEndDate
end

-------------------  BankingDate  -----------------------------------------------------

if update(BankingDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BankingDate', dbo.FormatDate(Deleted.BankingDate), dbo.FormatDate(Inserted.BankingDate)
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.BankingDate <> Deleted.BankingDate
end

-------------------  BankNameID  -----------------------------------------------------

if update(BankNameID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BankNameID', Deleted.BankNameID, Inserted.BankNameID
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.BankNameID <> Deleted.BankNameID
end

-------------------  AccountName  -----------------------------------------------------

if update(AccountName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountName', Deleted.AccountName, Inserted.AccountName
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.AccountName <> Deleted.AccountName
end

-------------------  AccountNo  -----------------------------------------------------

if update(AccountNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.AccountNo <> Deleted.AccountNo
end

-------------------  AmountCollected  -----------------------------------------------------

if update(AmountCollected)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountCollected', cast(Deleted.AmountCollected as varchar(20)), cast(Inserted.AmountCollected as varchar(20))
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.AmountCollected <> Deleted.AmountCollected
end

-------------------  AmountBanked  -----------------------------------------------------

if update(AmountBanked)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountBanked', cast(Deleted.AmountBanked as varchar(20)), cast(Inserted.AmountBanked as varchar(20))
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.AmountBanked <> Deleted.AmountBanked
end

-------------------  AmountInWords  -----------------------------------------------------

if update(AmountInWords)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountInWords', Deleted.AmountInWords, Inserted.AmountInWords
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.AmountInWords <> Deleted.AmountInWords
end


-------------------  CurrencyID  -----------------------------------------------------

if update(CurrencyID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrencyID', Deleted.CurrencyID, Inserted.CurrencyID
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.CurrencyID <> Deleted.CurrencyID
end

-------------------  ExchangeRate  -----------------------------------------------------

if update(ExchangeRate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExchangeRate', Deleted.ExchangeRate, Inserted.ExchangeRate
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.ExchangeRate <> Deleted.ExchangeRate
end

-------------------  BankedBy  -----------------------------------------------------

if update(BankedBy)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BankedBy', Deleted.BankedBy, Inserted.BankedBy
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.BankedBy <> Deleted.BankedBy
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: BankingRegister ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteBankingRegister')
drop trigger utrDeleteBankingRegister
go

create trigger utrDeleteBankingRegister
on BankingRegister
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'BankingRegister' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RegisterID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RegisterID', Deleted.RegisterID, null from Deleted

-------------------  RegisterNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RegisterNo', Deleted.RegisterNo, null from Deleted

-------------------  CollectionStartDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CollectionStartDate', dbo.FormatDate(Deleted.CollectionStartDate), null from Deleted

-------------------  CollectionEndDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CollectionEndDate', dbo.FormatDate(Deleted.CollectionEndDate), null from Deleted

-------------------  BankingDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BankingDate', dbo.FormatDate(Deleted.BankingDate), null from Deleted

-------------------  BankNameID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BankNameID', Deleted.BankNameID, null from Deleted

-------------------  AccountName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountName', Deleted.AccountName, null from Deleted

-------------------  AccountNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, null from Deleted

-------------------  AmountCollected  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountCollected', cast(Deleted.AmountCollected as varchar(20)), null from Deleted

-------------------  AmountBanked  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountBanked', cast(Deleted.AmountBanked as varchar(20)), null from Deleted

-------------------  AmountInWords  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountInWords', Deleted.AmountInWords, null from Deleted

-------------------  CurrencyID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrencyID', Deleted.CurrencyID, null from Deleted

-------------------  ExchangeRate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExchangeRate', Deleted.ExchangeRate, null from Deleted

-------------------  BankedBy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BankedBy', Deleted.BankedBy, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: StaffLocations ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateStaffLocations')
drop trigger utrUpdateStaffLocations
go

create trigger utrUpdateStaffLocations
on StaffLocations
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'StaffLocations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-StaffLoginID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffLoginID', Deleted.StaffLoginID, Inserted.StaffLoginID
from Inserted inner join Deleted
on Inserted.StaffLoginID = Deleted.StaffLoginID
and Inserted.LocationID = Deleted.LocationID
and Inserted.StartDate = Deleted.StartDate
end

------------------- Key-LocationID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationID', Deleted.LocationID, Inserted.LocationID
from Inserted inner join Deleted
on Inserted.StaffLoginID = Deleted.StaffLoginID
and Inserted.LocationID = Deleted.LocationID
and Inserted.StartDate = Deleted.StartDate
end

------------------- Key-StartDate -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartDate', dbo.FormatDate(Deleted.StartDate), dbo.FormatDate(Inserted.StartDate)
from Inserted inner join Deleted
on Inserted.StaffLoginID = Deleted.StaffLoginID
and Inserted.LocationID = Deleted.LocationID
and Inserted.StartDate = Deleted.StartDate
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.StaffLoginID = Deleted.StaffLoginID
and Inserted.LocationID = Deleted.LocationID
and Inserted.StartDate = Deleted.StartDate
and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.StaffLoginID = Deleted.StaffLoginID
and Inserted.LocationID = Deleted.LocationID
and Inserted.StartDate = Deleted.StartDate
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.StaffLoginID = Deleted.StaffLoginID
and Inserted.LocationID = Deleted.LocationID
and Inserted.StartDate = Deleted.StartDate
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.StaffLoginID = Deleted.StaffLoginID
and Inserted.LocationID = Deleted.LocationID
and Inserted.StartDate = Deleted.StartDate
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: StaffLocations ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteStaffLocations')
drop trigger utrDeleteStaffLocations
go

create trigger utrDeleteStaffLocations
on StaffLocations
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'StaffLocations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  StaffLoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffLoginID', Deleted.StaffLoginID, null from Deleted

-------------------  LocationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationID', Deleted.LocationID, null from Deleted

-------------------  StartDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartDate', dbo.FormatDate(Deleted.StartDate), null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go




------------------------------------------------------------------------------------------------------
-------------- Update: ClaimPayments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateClaimPayments')
drop trigger utrUpdateClaimPayments
go

create trigger utrUpdateClaimPayments
on ClaimPayments
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ClaimPayments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-ClaimNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimNo', Deleted.ClaimNo, Inserted.ClaimNo
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
end

-------------------  PaymentDateTime  -----------------------------------------------------

if update(PaymentDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PaymentDateTime', Deleted.PaymentDateTime, Inserted.PaymentDateTime
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.PaymentDateTime <> Deleted.PaymentDateTime
end

-------------------  PayStatusID  -----------------------------------------------------

if update(PayStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayStatusID', Deleted.PayStatusID, Inserted.PayStatusID
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.PayStatusID <> Deleted.PayStatusID
end


-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', Deleted.RecordDateTime, Inserted.RecordDateTime
from Inserted inner join Deleted
on Inserted.ClaimNo = Deleted.ClaimNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end


go


------------------------------------------------------------------------------------------------------
-------------- Delete: ClaimPayments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteClaimPayments')
drop trigger utrDeleteClaimPayments
go

create trigger utrDeleteClaimPayments
on ClaimPayments
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ClaimPayments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ClaimNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClaimNo', Deleted.ClaimNo, null from Deleted

-------------------  PaymentDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PaymentDateTime', Deleted.PaymentDateTime, null from Deleted

-------------------  PayStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayStatusID', Deleted.PayStatusID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', Deleted.RecordDateTime, null from Deleted

go

------------------------------------------------------------------------------------------------------
-------------- Update: Queues ------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateQueues')
drop trigger utrUpdateQueues
go

create trigger utrUpdateQueues
on Queues
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Queues' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
end

------------------- Key-BranchID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BranchID', Deleted.BranchID, Inserted.BranchID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
end

------------------- Key-ServicePointID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServicePointID', Deleted.ServicePointID, Inserted.ServicePointID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
end


if update(TokenNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TokenNo', Deleted.TokenNo, Inserted.TokenNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.TokenNo <> Deleted.TokenNo
end

-------------------  PriorityID  -----------------------------------------------------

if update(PriorityID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PriorityID', Deleted.PriorityID, Inserted.PriorityID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.PriorityID <> Deleted.PriorityID
end

-------------------  QueueStatus  -----------------------------------------------------

if update(QueueStatus)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QueueStatus', Deleted.QueueStatus, Inserted.QueueStatus
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.QueueStatus <> Deleted.QueueStatus
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: Queues ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteQueues')
drop trigger utrDeleteQueues
go

create trigger utrDeleteQueues
on Queues
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Queues' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  BranchID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BranchID', Deleted.BranchID, null from Deleted

-------------------  ServicePointID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServicePointID', Deleted.ServicePointID, null from Deleted

-------------------  TokenNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TokenNo', Deleted.TokenNo, null from Deleted

-------------------  PriorityID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PriorityID', Deleted.PriorityID, null from Deleted

-------------------  QueueStatus  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'QueueStatus', Deleted.QueueStatus, null from Deleted


-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: QueuedMessages ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateQueuedMessages')
drop trigger utrUpdateQueuedMessages
go

create trigger utrUpdateQueuedMessages
on QueuedMessages
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'QueuedMessages' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.TokenNo = Deleted.TokenNo
end

------------------- Key-BranchID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BranchID', Deleted.BranchID, Inserted.BranchID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.TokenNo = Deleted.TokenNo
end

------------------- Key-ServicePointID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServicePointID', Deleted.ServicePointID, Inserted.ServicePointID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.TokenNo = Deleted.TokenNo
end

------------------- Key-TokenNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TokenNo', Deleted.TokenNo, Inserted.TokenNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.TokenNo = Deleted.TokenNo
end

-------------------  RoomNameID  -----------------------------------------------------

if update(RoomNameID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoomNameID', Deleted.RoomNameID, Inserted.RoomNameID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.TokenNo = Deleted.TokenNo
and Inserted.RoomNameID <> Deleted.RoomNameID
end



-------------------  ReadCount  -----------------------------------------------------

if update(ReadCount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReadCount', Deleted.ReadCount, Inserted.ReadCount
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.TokenNo = Deleted.TokenNo
and Inserted.ReadCount <> Deleted.ReadCount
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.TokenNo = Deleted.TokenNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.TokenNo = Deleted.TokenNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.BranchID = Deleted.BranchID
and Inserted.ServicePointID = Deleted.ServicePointID
and Inserted.TokenNo = Deleted.TokenNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: QueuedMessages ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteQueuedMessages')
drop trigger utrDeleteQueuedMessages
go

create trigger utrDeleteQueuedMessages
on QueuedMessages
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'QueuedMessages' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  BranchID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BranchID', Deleted.BranchID, null from Deleted

-------------------  ServicePointID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServicePointID', Deleted.ServicePointID, null from Deleted

-------------------  TokenNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TokenNo', Deleted.TokenNo, null from Deleted

-------------------  RoomNameID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoomNameID', Deleted.RoomNameID, null from Deleted

-------------------  ReadCount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReadCount', Deleted.ReadCount, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go






------------------------------------------------------------------------------------------------------
--------------------- Update: StaffPayments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateStaffPayments')
drop trigger utrUpdateStaffPayments
go

create trigger utrUpdateStaffPayments
on StaffPayments
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'StaffPayments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-PaymentVoucherNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PaymentVoucherNo', Deleted.PaymentVoucherNo, Inserted.PaymentVoucherNo
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
end

-------------------  PaymentVoucherID  -----------------------------------------------------

if update(PaymentVoucherID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PaymentVoucherID', Deleted.PaymentVoucherID, Inserted.PaymentVoucherID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.PaymentVoucherID <> Deleted.PaymentVoucherID
end

-------------------  VisitTypeID  -----------------------------------------------------

if update(VisitTypeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitTypeID', Deleted.VisitTypeID, Inserted.VisitTypeID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.VisitTypeID <> Deleted.VisitTypeID
end

-------------------  StartDateTime  -----------------------------------------------------

if update(StartDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartDateTime', dbo.FormatDate(Deleted.StartDateTime), dbo.FormatDate(Inserted.StartDateTime)
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.StartDateTime <> Deleted.StartDateTime
end

-------------------  EndDateTime  -----------------------------------------------------

if update(EndDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EndDateTime', dbo.FormatDate(Deleted.EndDateTime), dbo.FormatDate(Inserted.EndDateTime)
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.EndDateTime <> Deleted.EndDateTime
end

-------------------  BillModesID  -----------------------------------------------------

if update(BillModesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillModesID', Deleted.BillModesID, Inserted.BillModesID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.BillModesID <> Deleted.BillModesID
end

-------------------  StaffNo  -----------------------------------------------------

if update(StaffNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.StaffNo <> Deleted.StaffNo
end

-------------------  VoucherStatusID  -----------------------------------------------------

if update(VoucherStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VoucherStatusID', Deleted.VoucherStatusID, Inserted.VoucherStatusID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.VoucherStatusID <> Deleted.VoucherStatusID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: StaffPayments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteStaffPayments')
drop trigger utrDeleteStaffPayments
go

create trigger utrDeleteStaffPayments
on StaffPayments
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'StaffPayments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PaymentVoucherID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PaymentVoucherID', Deleted.PaymentVoucherID, null from Deleted

-------------------  PaymentVoucherNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PaymentVoucherNo', Deleted.PaymentVoucherNo, null from Deleted

-------------------  VisitTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitTypeID', Deleted.VisitTypeID, null from Deleted

-------------------  StartDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StartDateTime', dbo.FormatDate(Deleted.StartDateTime), null from Deleted

-------------------  EndDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EndDateTime', dbo.FormatDate(Deleted.EndDateTime), null from Deleted

-------------------  BillModesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillModesID', Deleted.BillModesID, null from Deleted

-------------------  StaffNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted

-------------------  VoucherStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VoucherStatusID', Deleted.VoucherStatusID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go





------------------------------------------------------------------------------------------------------
-------------- Update: StaffPaymentsExt ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateStaffPaymentsExt')
drop trigger utrUpdateStaffPaymentsExt
go

create trigger utrUpdateStaffPaymentsExt
on StaffPaymentsExt
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'StaffPaymentsExt' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-PaymentVoucherNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PaymentVoucherNo', Deleted.PaymentVoucherNo, Inserted.PaymentVoucherNo
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
end

-------------------  ApprovalDateTime  -----------------------------------------------------

if update(ApprovalDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalDateTime', dbo.FormatDate(Deleted.ApprovalDateTime), dbo.FormatDate(Inserted.ApprovalDateTime)
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ApprovalDateTime <> Deleted.ApprovalDateTime
end

-------------------  PayModeID  -----------------------------------------------------

if update(PayModeID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayModeID', Deleted.PayModeID, Inserted.PayModeID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.PayModeID <> Deleted.PayModeID
end

-------------------  DocumentNo  -----------------------------------------------------

if update(DocumentNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, Inserted.DocumentNo
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.DocumentNo <> Deleted.DocumentNo
end

-------------------  CurrenciesID  -----------------------------------------------------

if update(CurrenciesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, Inserted.CurrenciesID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.CurrenciesID <> Deleted.CurrenciesID
end

-------------------  ExchangeRate  -----------------------------------------------------

if update(ExchangeRate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExchangeRate', cast(Deleted.ExchangeRate as varchar(20)), cast(Inserted.ExchangeRate as varchar(20))
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ExchangeRate <> Deleted.ExchangeRate
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.Amount <> Deleted.Amount
end

-------------------  AmountWords  -----------------------------------------------------

if update(AmountWords)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountWords', Deleted.AmountWords, Inserted.AmountWords
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.AmountWords <> Deleted.AmountWords
end

-------------------  ApprovalStatusID  -----------------------------------------------------

if update(ApprovalStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalStatusID', Deleted.ApprovalStatusID, Inserted.ApprovalStatusID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ApprovalStatusID <> Deleted.ApprovalStatusID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: StaffPaymentsExt ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteStaffPaymentsExt')
drop trigger utrDeleteStaffPaymentsExt
go

create trigger utrDeleteStaffPaymentsExt
on StaffPaymentsExt
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'StaffPaymentsExt' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PaymentVoucherNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PaymentVoucherNo', Deleted.PaymentVoucherNo, null from Deleted

-------------------  ApprovalDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalDateTime', dbo.FormatDate(Deleted.ApprovalDateTime), null from Deleted

-------------------  PayModeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayModeID', Deleted.PayModeID, null from Deleted

-------------------  DocumentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, null from Deleted

-------------------  CurrenciesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, null from Deleted

-------------------  ExchangeRate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExchangeRate', cast(Deleted.ExchangeRate as varchar(20)), null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  AmountWords  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountWords', Deleted.AmountWords, null from Deleted

-------------------  ApprovalStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalStatusID', Deleted.ApprovalStatusID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go




------------------------------------------------------------------------------------------------------
-------------- Update: IPDStaffPaymentDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDStaffPaymentDetails')
drop trigger utrUpdateIPDStaffPaymentDetails
go

create trigger utrUpdateIPDStaffPaymentDetails
on IPDStaffPaymentDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDStaffPaymentDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PaymentVoucherNo  -----------------------------------------------------

if update(PaymentVoucherNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PaymentVoucherNo', Deleted.PaymentVoucherNo, Inserted.PaymentVoucherNo
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.PaymentVoucherNo <> Deleted.PaymentVoucherNo
end

-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.VisitNo <> Deleted.VisitNo
end

-------------------  RoundNo  -----------------------------------------------------

if update(RoundNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.RoundNo <> Deleted.RoundNo
end

-------------------  ExtraBillNo  -----------------------------------------------------

if update(ExtraBillNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, Inserted.ExtraBillNo
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ExtraBillNo <> Deleted.ExtraBillNo
end

-------------------  ItemCode  -----------------------------------------------------

if update(ItemCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ItemCode <> Deleted.ItemCode
end

-------------------  ItemCategoryID  -----------------------------------------------------

if update(ItemCategoryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ItemCategoryID <> Deleted.ItemCategoryID
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.Amount <> Deleted.Amount
end

-------------------  ApprovalStatusID  -----------------------------------------------------

if update(ApprovalStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalStatusID', Deleted.ApprovalStatusID, Inserted.ApprovalStatusID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ApprovalStatusID <> Deleted.ApprovalStatusID
end

-------------------  ApprovalNotes  -----------------------------------------------------

if update(ApprovalStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalNotes', Deleted.ApprovalNotes, Inserted.ApprovalNotes
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ApprovalNotes <> Deleted.ApprovalNotes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: IPDStaffPaymentDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDStaffPaymentDetails')
drop trigger utrDeleteIPDStaffPaymentDetails
go

create trigger utrDeleteIPDStaffPaymentDetails
on IPDStaffPaymentDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDStaffPaymentDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PaymentVoucherNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PaymentVoucherNo', Deleted.PaymentVoucherNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  ExtraBillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  ApprovalStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalStatusID', Deleted.ApprovalStatusID, null from Deleted

-------------------  ApprovalNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalNotes', Deleted.ApprovalNotes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go




------------------------------------------------------------------------------------------------------
-------------- Update: OPDStaffPaymentDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateOPDStaffPaymentDetails')
drop trigger utrUpdateOPDStaffPaymentDetails
go

create trigger utrUpdateOPDStaffPaymentDetails
on OPDStaffPaymentDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'OPDStaffPaymentDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PaymentVoucherNo  -----------------------------------------------------

if update(PaymentVoucherNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PaymentVoucherNo', Deleted.PaymentVoucherNo, Inserted.PaymentVoucherNo
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.PaymentVoucherNo <> Deleted.PaymentVoucherNo
end

-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.VisitNo <> Deleted.VisitNo
end

-------------------  ItemCode  -----------------------------------------------------

if update(ItemCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ItemCode <> Deleted.ItemCode
end

-------------------  ItemCategoryID  -----------------------------------------------------

if update(ItemCategoryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ItemCategoryID <> Deleted.ItemCategoryID
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.Amount <> Deleted.Amount
end

-------------------  ApprovalStatusID  -----------------------------------------------------

if update(ApprovalStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalStatusID', Deleted.ApprovalStatusID, Inserted.ApprovalStatusID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ApprovalStatusID <> Deleted.ApprovalStatusID
end

-------------------  ApprovalNotes  -----------------------------------------------------

if update(ApprovalNotes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalNotes', Deleted.ApprovalNotes, Inserted.ApprovalNotes
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ApprovalNotes <> Deleted.ApprovalNotes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.PaymentVoucherNo = Deleted.PaymentVoucherNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: OPDStaffPaymentDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteOPDStaffPaymentDetails')
drop trigger utrDeleteOPDStaffPaymentDetails
go

create trigger utrDeleteOPDStaffPaymentDetails
on OPDStaffPaymentDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'OPDStaffPaymentDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PaymentVoucherNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PaymentVoucherNo', Deleted.PaymentVoucherNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  ApprovalStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalStatusID', Deleted.ApprovalStatusID, null from Deleted

-------------------  ApprovalNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalNotes', Deleted.ApprovalNotes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: OtherItems ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateOtherItems')
drop trigger utrUpdateOtherItems
go

create trigger utrUpdateOtherItems
on OtherItems
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'OtherItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
end

-------------------  ItemID  -----------------------------------------------------

if update(ItemID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemID', Deleted.ItemID, Inserted.ItemID
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemID <> Deleted.ItemID
end

-------------------  ItemName  -----------------------------------------------------

if update(ItemName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemName <> Deleted.ItemName
end

-------------------  ItemCategoryID  -----------------------------------------------------

if update(ItemCategoryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID <> Deleted.ItemCategoryID
end

-------------------  UnitCost  -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.UnitCost <> Deleted.UnitCost
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Details  -----------------------------------------------------

if update(Details)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Details', Deleted.Details, Inserted.Details
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.Details <> Deleted.Details
end

-------------------  LocationID  -----------------------------------------------------

if update(LocationID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationID', Deleted.LocationID, Inserted.LocationID
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.LocationID <> Deleted.LocationID
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.Hidden <> Deleted.Hidden
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ClientMachine <> Deleted.ClientMachine
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: OtherItems ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteOtherItems')
drop trigger utrDeleteOtherItems
go

create trigger utrDeleteOtherItems
on OtherItems
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'OtherItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ItemID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemID', Deleted.ItemID, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  UnitCost  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Details  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Details', Deleted.Details, null from Deleted

-------------------  LocationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LocationID', Deleted.LocationID, null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: RefundDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRefundDetails')
	drop trigger utrUpdateRefundDetails
go

create trigger utrUpdateRefundDetails
on RefundDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'RefundDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RefundNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RefundNo', Deleted.RefundNo, Inserted.RefundNo
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-VisitNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ReceiptNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReceiptNo', Deleted.ReceiptNo, Inserted.ReceiptNo
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ReturnReasonID  -----------------------------------------------------

if update(ReturnReasonID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, Inserted.ReturnReasonID
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ReturnReasonID <> Deleted.ReturnReasonID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Amount <> Deleted.Amount
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: RefundDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRefundDetails')
	drop trigger utrDeleteRefundDetails
go

create trigger utrDeleteRefundDetails
on RefundDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'RefundDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RefundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundNo', Deleted.RefundNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ReceiptNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ReturnReasonID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: RefundExtraBillItems ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRefundExtraBillItems')
	drop trigger utrUpdateRefundExtraBillItems
go

create trigger utrUpdateRefundExtraBillItems
on RefundExtraBillItems
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'RefundExtraBillItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RefundNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RefundNo', Deleted.RefundNo, Inserted.RefundNo
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ExtraBillNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, Inserted.ExtraBillNo
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ReceiptNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReceiptNo', Deleted.ReceiptNo, Inserted.ReceiptNo
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ReturnReasonID  -----------------------------------------------------

if update(ReturnReasonID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, Inserted.ReturnReasonID
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ReturnReasonID <> Deleted.ReturnReasonID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Amount <> Deleted.Amount
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: RefundExtraBillItems ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRefundExtraBillItems')
	drop trigger utrDeleteRefundExtraBillItems
go

create trigger utrDeleteRefundExtraBillItems
on RefundExtraBillItems
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'RefundExtraBillItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RefundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundNo', Deleted.RefundNo, null from Deleted

-------------------  ExtraBillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, null from Deleted

-------------------  ReceiptNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ReturnReasonID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go




------------------------------------------------------------------------------------------------------
-------------- Update: BankingRegisterDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateBankingRegisterDetails')
drop trigger utrUpdateBankingRegisterDetails
go

create trigger utrUpdateBankingRegisterDetails
on BankingRegisterDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'BankingRegisterDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RegisterNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RegisterNo', Deleted.RegisterNo, Inserted.RegisterNo
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.CollectionModesID = Deleted.CollectionModesID
and Inserted.DocumentNo = Deleted.DocumentNo
end

------------------- Key-CollectionModesID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CollectionModesID', Deleted.CollectionModesID, Inserted.CollectionModesID
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.CollectionModesID = Deleted.CollectionModesID
and Inserted.DocumentNo = Deleted.DocumentNo
end

------------------- Key-DocumentNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, Inserted.DocumentNo
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.CollectionModesID = Deleted.CollectionModesID
and Inserted.DocumentNo = Deleted.DocumentNo
end

-------------------  BankModesID  -----------------------------------------------------

if update(BankModesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BankModesID', Deleted.BankModesID, Inserted.BankModesID
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.CollectionModesID = Deleted.CollectionModesID
and Inserted.DocumentNo = Deleted.DocumentNo
and Inserted.BankModesID <> Deleted.BankModesID
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.CollectionModesID = Deleted.CollectionModesID
and Inserted.DocumentNo = Deleted.DocumentNo
and Inserted.Amount <> Deleted.Amount
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.CollectionModesID = Deleted.CollectionModesID
and Inserted.DocumentNo = Deleted.DocumentNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.CollectionModesID = Deleted.CollectionModesID
and Inserted.DocumentNo = Deleted.DocumentNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.RegisterNo = Deleted.RegisterNo
and Inserted.CollectionModesID = Deleted.CollectionModesID
and Inserted.DocumentNo = Deleted.DocumentNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: BankingRegisterDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteBankingRegisterDetails')
drop trigger utrDeleteBankingRegisterDetails
go

create trigger utrDeleteBankingRegisterDetails
on BankingRegisterDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'BankingRegisterDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RegisterNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RegisterNo', Deleted.RegisterNo, null from Deleted

-------------------  CollectionModesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CollectionModesID', Deleted.CollectionModesID, null from Deleted

-------------------  BankModesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BankModesID', Deleted.BankModesID, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  DocumentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: RefundDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRefundDetails')
	drop trigger utrUpdateRefundDetails
go

create trigger utrUpdateRefundDetails
on RefundDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'RefundDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RefundNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RefundNo', Deleted.RefundNo, Inserted.RefundNo
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-VisitNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ReceiptNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReceiptNo', Deleted.ReceiptNo, Inserted.ReceiptNo
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ReturnReasonID  -----------------------------------------------------

if update(ReturnReasonID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, Inserted.ReturnReasonID
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ReturnReasonID <> Deleted.ReturnReasonID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Amount <> Deleted.Amount
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: RefundDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRefundDetails')
	drop trigger utrDeleteRefundDetails
go

create trigger utrDeleteRefundDetails
on RefundDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'RefundDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RefundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundNo', Deleted.RefundNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ReceiptNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ReturnReasonID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: BankPaymentDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateBankPaymentDetails')
drop trigger utrUpdateBankPaymentDetails
go

create trigger utrUpdateBankPaymentDetails
on BankPaymentDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'BankPaymentDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-ReceiptNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, Inserted.ReceiptNo
from Inserted inner join Deleted
on Inserted.ReceiptNo = Deleted.ReceiptNo
end

-------------------  BankNamesID  -----------------------------------------------------

if update(BankNamesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BankNamesID', Deleted.BankNamesID, Inserted.BankNamesID
from Inserted inner join Deleted
on Inserted.ReceiptNo = Deleted.ReceiptNo
and Inserted.BankNamesID <> Deleted.BankNamesID
end

-------------------  AccountNo  -----------------------------------------------------

if update(AccountNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
from Inserted inner join Deleted
on Inserted.ReceiptNo = Deleted.ReceiptNo
and Inserted.AccountNo <> Deleted.AccountNo
end

-------------------  DocumentNo  -----------------------------------------------------

if update(DocumentNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, Inserted.DocumentNo
from Inserted inner join Deleted
on Inserted.ReceiptNo = Deleted.ReceiptNo
and Inserted.DocumentNo <> Deleted.DocumentNo
end

-------------------  PayModesID  -----------------------------------------------------

if update(PayModesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayModesID', Deleted.PayModesID, Inserted.PayModesID
from Inserted inner join Deleted
on Inserted.ReceiptNo = Deleted.ReceiptNo
and Inserted.PayModesID <> Deleted.PayModesID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ReceiptNo = Deleted.ReceiptNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ReceiptNo = Deleted.ReceiptNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ReceiptNo = Deleted.ReceiptNo
and Inserted.LoginID <> Deleted.LoginID
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: BankPaymentDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteBankPaymentDetails')
drop trigger utrDeleteBankPaymentDetails
go

create trigger utrDeleteBankPaymentDetails
on BankPaymentDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'BankPaymentDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ReceiptNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, null from Deleted

-------------------  BankNamesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BankNamesID', Deleted.BankNamesID, null from Deleted

-------------------  AccountNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, null from Deleted

-------------------  DocumentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, null from Deleted

-------------------  PayModesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayModesID', Deleted.PayModesID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ReceiptInvoiceDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateReceiptInvoiceDetails')
drop trigger utrUpdateReceiptInvoiceDetails
go

create trigger utrUpdateReceiptInvoiceDetails
on ReceiptInvoiceDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ReceiptInvoiceDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-InvoiceNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, Inserted.InvoiceNo
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.ReceiptNo = Deleted.ReceiptNo
end

------------------- Key-ReceiptNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, Inserted.ReceiptNo
from Inserted inner join Deleted
on Inserted.InvoiceNo = Deleted.InvoiceNo
and Inserted.ReceiptNo = Deleted.ReceiptNo
end


go


------------------------------------------------------------------------------------------------------
-------------- Delete: ReceiptInvoiceDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteReceiptInvoiceDetails')
drop trigger utrDeleteReceiptInvoiceDetails
go

create trigger utrDeleteReceiptInvoiceDetails
on ReceiptInvoiceDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ReceiptInvoiceDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  InvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, null from Deleted

-------------------  ReceiptNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: TBIntensifiedCaseFinding ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateTBIntensifiedCaseFinding')
drop trigger utrUpdateTBIntensifiedCaseFinding
go

create trigger utrUpdateTBIntensifiedCaseFinding
on TBIntensifiedCaseFinding
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'TBIntensifiedCaseFinding' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  CoughingTwoWeeksMoreID  -----------------------------------------------------

if update(CoughingTwoWeeksMoreID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoughingTwoWeeksMoreID', Deleted.CoughingTwoWeeksMoreID, Inserted.CoughingTwoWeeksMoreID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.CoughingTwoWeeksMoreID <> Deleted.CoughingTwoWeeksMoreID
end

-------------------  PersistantFeversID  -----------------------------------------------------

if update(PersistantFeversID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PersistantFeversID', Deleted.PersistantFeversID, Inserted.PersistantFeversID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PersistantFeversID <> Deleted.PersistantFeversID
end

-------------------  NoticableWeightLossID  -----------------------------------------------------

if update(NoticableWeightLossID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NoticableWeightLossID', Deleted.NoticableWeightLossID, Inserted.NoticableWeightLossID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.NoticableWeightLossID <> Deleted.NoticableWeightLossID
end

-------------------  ExcessiveNightSweatsID  -----------------------------------------------------

if update(ExcessiveNightSweatsID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExcessiveNightSweatsID', Deleted.ExcessiveNightSweatsID, Inserted.ExcessiveNightSweatsID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ExcessiveNightSweatsID <> Deleted.ExcessiveNightSweatsID
end

-------------------  PoorWeightGainID  -----------------------------------------------------

if update(PoorWeightGainID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PoorWeightGainID', Deleted.PoorWeightGainID, Inserted.PoorWeightGainID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PoorWeightGainID <> Deleted.PoorWeightGainID
end

-------------------  PulmonaryTBChronicCoughContactID  -----------------------------------------------------

if update(PulmonaryTBChronicCoughContactID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PulmonaryTBChronicCoughContactID', Deleted.PulmonaryTBChronicCoughContactID, Inserted.PulmonaryTBChronicCoughContactID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PulmonaryTBChronicCoughContactID <> Deleted.PulmonaryTBChronicCoughContactID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: TBIntensifiedCaseFinding ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteTBIntensifiedCaseFinding')
drop trigger utrDeleteTBIntensifiedCaseFinding
go

create trigger utrDeleteTBIntensifiedCaseFinding
on TBIntensifiedCaseFinding
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'TBIntensifiedCaseFinding' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  CoughingTwoWeeksMoreID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CoughingTwoWeeksMoreID', Deleted.CoughingTwoWeeksMoreID, null from Deleted

-------------------  PersistantFeversID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PersistantFeversID', Deleted.PersistantFeversID, null from Deleted

-------------------  NoticableWeightLossID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NoticableWeightLossID', Deleted.NoticableWeightLossID, null from Deleted

-------------------  ExcessiveNightSweatsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExcessiveNightSweatsID', Deleted.ExcessiveNightSweatsID, null from Deleted

-------------------  PoorWeightGainID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PoorWeightGainID', Deleted.PoorWeightGainID, null from Deleted

-------------------  PulmonaryTBChronicCoughContactID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PulmonaryTBChronicCoughContactID', Deleted.PulmonaryTBChronicCoughContactID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: RevenueStreams ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRevenueStreams')
drop trigger utrUpdateRevenueStreams
go

create trigger utrUpdateRevenueStreams
on RevenueStreams
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'RevenueStreams' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RevenueStreamCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RevenueStreamCode', Deleted.RevenueStreamCode, Inserted.RevenueStreamCode
from Inserted inner join Deleted
on Inserted.RevenueStreamCode = Deleted.RevenueStreamCode
end

-------------------  Name  -----------------------------------------------------

if update(Name)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Name', Deleted.Name, Inserted.Name
from Inserted inner join Deleted
on Inserted.RevenueStreamCode = Deleted.RevenueStreamCode
and Inserted.Name <> Deleted.Name
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.RevenueStreamCode = Deleted.RevenueStreamCode
and Inserted.Hidden <> Deleted.Hidden
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.RevenueStreamCode = Deleted.RevenueStreamCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: RevenueStreams ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRevenueStreams')
drop trigger utrDeleteRevenueStreams
go

create trigger utrDeleteRevenueStreams
on RevenueStreams
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'RevenueStreams' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RevenueStreamCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RevenueStreamCode', Deleted.RevenueStreamCode, null from Deleted

-------------------  Name  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Name', Deleted.Name, null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: InventoryEXT ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInventoryEXT')
drop trigger utrUpdateInventoryEXT
go

create trigger utrUpdateInventoryEXT
on InventoryEXT
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InventoryEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ItemName  -----------------------------------------------------

if update(ItemName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemName <> Deleted.ItemName
end

-------------------  UnitCost  -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', Deleted.UnitCost, Inserted.UnitCost
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.UnitCost <> Deleted.UnitCost
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', Deleted.UnitPrice, Inserted.UnitPrice
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  Agent  -----------------------------------------------------

if update(Agent)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Agent', Deleted.Agent, Inserted.Agent
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Agent <> Deleted.Agent
end

-------------------  Saved  -----------------------------------------------------

if update(Saved)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Saved', Deleted.Saved, Inserted.Saved
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Saved <> Deleted.Saved
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: InventoryEXT ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInventoryEXT')
drop trigger utrDeleteInventoryEXT
go

create trigger utrDeleteInventoryEXT
on InventoryEXT
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InventoryEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  UnitCost  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', Deleted.UnitCost, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', Deleted.UnitPrice, null from Deleted

-------------------  Agent  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Agent', Deleted.Agent, null from Deleted

-------------------  Saved  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Saved', Deleted.Saved, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: PaymentsINT ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePaymentsINT')
drop trigger utrUpdatePaymentsINT
go

create trigger utrUpdatePaymentsINT
on PaymentsINT
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PaymentsINT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-ReceiptNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, Inserted.ReceiptNo
from Inserted inner join Deleted
on Inserted.ReceiptNo = Deleted.ReceiptNo
and Inserted.AgentID = Deleted.AgentID
end

------------------- Key-AgentID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AgentID', Deleted.AgentID, Inserted.AgentID
from Inserted inner join Deleted
on Inserted.ReceiptNo = Deleted.ReceiptNo
and Inserted.AgentID = Deleted.AgentID
end

-------------------  SyncStatus  -----------------------------------------------------

if update(SyncStatus)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SyncStatus', Deleted.SyncStatus, Inserted.SyncStatus
from Inserted inner join Deleted
on Inserted.ReceiptNo = Deleted.ReceiptNo
and Inserted.AgentID = Deleted.AgentID
and Inserted.SyncStatus <> Deleted.SyncStatus
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ReceiptNo = Deleted.ReceiptNo
and Inserted.AgentID = Deleted.AgentID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PaymentsINT ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePaymentsINT')
drop trigger utrDeletePaymentsINT
go

create trigger utrDeletePaymentsINT
on PaymentsINT
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PaymentsINT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ReceiptNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, null from Deleted

-------------------  SyncStatus  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SyncStatus', Deleted.SyncStatus, null from Deleted

-------------------  AgentID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AgentID', Deleted.AgentID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: RejectedSpecimens ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRejectedSpecimens')
drop trigger utrUpdateRejectedSpecimens
go

create trigger utrUpdateRejectedSpecimens
on RejectedSpecimens
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'RejectedSpecimens' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-SpecimenNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecimenNo', Deleted.SpecimenNo, Inserted.SpecimenNo
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
end

-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.VisitNo <> Deleted.VisitNo
end

-------------------  RejectectionReasonID  -----------------------------------------------------

if update(RejectectionReasonID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RejectectionReasonID', Deleted.RejectectionReasonID, Inserted.RejectectionReasonID
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.RejectectionReasonID <> Deleted.RejectectionReasonID
end

-------------------  RejectionDate  -----------------------------------------------------

if update(RejectionDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RejectionDate', dbo.FormatDate(Deleted.RejectionDate), dbo.FormatDate(Inserted.RejectionDate)
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.RejectionDate <> Deleted.RejectionDate
end

-------------------  RejectedAt  -----------------------------------------------------

if update(RejectedAt)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RejectedAt', Deleted.RejectedAt, Inserted.RejectedAt
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.RejectedAt <> Deleted.RejectedAt
end

-------------------  RejectedBy  -----------------------------------------------------

if update(RejectedBy)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RejectedBy', Deleted.RejectedBy, Inserted.RejectedBy
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.RejectedBy <> Deleted.RejectedBy
end

-------------------  IsReAccepted  -----------------------------------------------------

if update(IsReAccepted)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IsReAccepted', Deleted.IsReAccepted, Inserted.IsReAccepted
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.IsReAccepted <> Deleted.IsReAccepted
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.SpecimenNo = Deleted.SpecimenNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: RejectedSpecimens ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRejectedSpecimens')
drop trigger utrDeleteRejectedSpecimens
go

create trigger utrDeleteRejectedSpecimens
on RejectedSpecimens
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'RejectedSpecimens' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  SpecimenNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecimenNo', Deleted.SpecimenNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  RejectectionReasonID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RejectectionReasonID', Deleted.RejectectionReasonID, null from Deleted

-------------------  RejectionDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RejectionDate', dbo.FormatDate(Deleted.RejectionDate), null from Deleted

-------------------  RejectedAt  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RejectedAt', Deleted.RejectedAt, null from Deleted

-------------------  RejectedBy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RejectedBy', Deleted.RejectedBy, null from Deleted

-------------------  IsReAccepted  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IsReAccepted', Deleted.IsReAccepted, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Packages ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePackages')
drop trigger utrUpdatePackages
go

create trigger utrUpdatePackages
on Packages
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Packages' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-PackageNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageNo', Deleted.PackageNo, Inserted.PackageNo
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
end

-------------------  PackageName  -----------------------------------------------------

if update(PackageName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageName', Deleted.PackageName, Inserted.PackageName
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.PackageName <> Deleted.PackageName
end

-------------------  UnitCost  -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', Deleted.UnitCost, Inserted.UnitCost
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.UnitCost <> Deleted.UnitCost
end


-------------------  ExpiryDays  -----------------------------------------------------

if update(ExpiryDays)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpiryDays', Deleted.ExpiryDays, Inserted.ExpiryDays
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.ExpiryDays <> Deleted.ExpiryDays
end
-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', Deleted.UnitPrice, Inserted.UnitPrice
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  RevenueStreamCode  -----------------------------------------------------

if update(RevenueStreamCode)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RevenueStreamCode', Deleted.RevenueStreamCode, Inserted.RevenueStreamCode
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.RevenueStreamCode <> Deleted.RevenueStreamCode
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.Hidden <> Deleted.Hidden
end

-------------------  MonitorQty  -----------------------------------------------------

if update(MonitorQty)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MonitorQty', Deleted.MonitorQty, Inserted.MonitorQty
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.MonitorQty <> Deleted.MonitorQty
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: Packages ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePackages')
drop trigger utrDeletePackages
go

create trigger utrDeletePackages
on Packages
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Packages' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PackageNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageNo', Deleted.PackageNo, null from Deleted

-------------------  PackageName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageName', Deleted.PackageName, null from Deleted

-------------------  UnitCost  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', Deleted.UnitCost, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', Deleted.UnitPrice, null from Deleted

-------------------  ExpiryDays  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpiryDays', Deleted.ExpiryDays, null from Deleted

-------------------  RevenueStreamCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RevenueStreamCode', Deleted.RevenueStreamCode, null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted

-------------------  MonitorQty  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MonitorQty', Deleted.Hidden, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: PackagesEXT ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePackagesEXT')
drop trigger utrUpdatePackagesEXT
go

create trigger utrUpdatePackagesEXT
on PackagesEXT
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PackagesEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-PackageNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageNo', Deleted.PackageNo, Inserted.PackageNo
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PackagesEXT ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePackagesEXT')
drop trigger utrDeletePackagesEXT
go

create trigger utrDeletePackagesEXT
on PackagesEXT
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PackagesEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PackageNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageNo', Deleted.PackageNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: PackageConsumption ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePackageConsumption')
drop trigger utrUpdatePackageConsumption
go

create trigger utrUpdatePackageConsumption
on PackageConsumption
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PackageConsumption' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-PackageNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageNo', Deleted.PackageNo, Inserted.PackageNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ItemStatusID  -----------------------------------------------------

if update(ItemStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemStatusID', Deleted.ItemStatusID, Inserted.ItemStatusID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemStatusID <> Deleted.ItemStatusID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.PackageNo = Deleted.PackageNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PackageConsumption ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePackageConsumption')
drop trigger utrDeletePackageConsumption
go

create trigger utrDeletePackageConsumption
on PackageConsumption
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PackageConsumption' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  PackageNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageNo', Deleted.PackageNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemStatusID', Deleted.ItemStatusID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: LabTestsEXTPossibleResults ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateLabTestsEXTPossibleResults')
drop trigger utrUpdateLabTestsEXTPossibleResults
go

create trigger utrUpdateLabTestsEXTPossibleResults
on LabTestsEXTPossibleResults
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'LabTestsEXTPossibleResults' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-TestCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestCode', Deleted.TestCode, Inserted.TestCode
from Inserted inner join Deleted
on Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
and Inserted.PossibleResults = Deleted.PossibleResults
end

------------------- Key-SubTestCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SubTestCode', Deleted.SubTestCode, Inserted.SubTestCode
from Inserted inner join Deleted
on Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
and Inserted.PossibleResults = Deleted.PossibleResults
end

------------------- Key-PossibleResults -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PossibleResults', Deleted.PossibleResults, Inserted.PossibleResults
from Inserted inner join Deleted
on Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
and Inserted.PossibleResults = Deleted.PossibleResults
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
and Inserted.PossibleResults = Deleted.PossibleResults
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
and Inserted.PossibleResults = Deleted.PossibleResults
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.TestCode = Deleted.TestCode
and Inserted.SubTestCode = Deleted.SubTestCode
and Inserted.PossibleResults = Deleted.PossibleResults
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: LabTestsEXTPossibleResults ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteLabTestsEXTPossibleResults')
drop trigger utrDeleteLabTestsEXTPossibleResults
go

create trigger utrDeleteLabTestsEXTPossibleResults
on LabTestsEXTPossibleResults
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'LabTestsEXTPossibleResults' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  TestCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestCode', Deleted.TestCode, null from Deleted

-------------------  SubTestCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SubTestCode', Deleted.SubTestCode, null from Deleted

-------------------  PossibleResults  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PossibleResults', Deleted.PossibleResults, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: AttachPackage ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAttachPackage')
	drop trigger utrUpdateAttachPackage
go

create trigger utrUpdateAttachPackage
on AttachPackage
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'AttachPackage' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PackageNo = Deleted.PackageNo
end

------------------- Key-PackageNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PackageNo', Deleted.PackageNo, Inserted.PackageNo
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PackageNo = Deleted.PackageNo
end

-------------------  PatientNo  -----------------------------------------------------

if update(PatientNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.PatientNo <> Deleted.PatientNo
end

-------------------  Details  -----------------------------------------------------

if update(Details)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Details', Deleted.Details, Inserted.Details
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.Details <> Deleted.Details
end

-------------------  PackageStartDate  -----------------------------------------------------

if update(PackageStartDate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PackageStartDate', dbo.FormatDate(Deleted.PackageStartDate), dbo.FormatDate(Inserted.PackageStartDate)
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.PackageStartDate <> Deleted.PackageStartDate
end

-------------------  PackageEndDate  -----------------------------------------------------

if update(PackageEndDate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PackageEndDate', dbo.FormatDate(Deleted.PackageEndDate), dbo.FormatDate(Inserted.PackageEndDate)
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.PackageEndDate <> Deleted.PackageEndDate
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: AttachPackage ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAttachPackage')
	drop trigger utrDeleteAttachPackage
go

create trigger utrDeleteAttachPackage
on AttachPackage
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'AttachPackage' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  PackageNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageNo', Deleted.PackageNo, null from Deleted

-------------------  Details  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Details', Deleted.Details, null from Deleted

-------------------  PackageStartDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageStartDate', dbo.FormatDate(Deleted.PackageStartDate), null from Deleted

-------------------  PackageEndDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageEndDate', dbo.FormatDate(Deleted.PackageEndDate), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: IPDCancerDiagnosis ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDCancerDiagnosis')
drop trigger utrUpdateIPDCancerDiagnosis
go

create trigger utrUpdateIPDCancerDiagnosis
on IPDCancerDiagnosis
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDCancerDiagnosis' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RoundNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
end

------------------- Key-DiseaseNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseNo', Deleted.DiseaseNo, Inserted.DiseaseNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
end

-------------------  TopographicalNo  -----------------------------------------------------

if update(TopographicalNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TopographicalNo', Deleted.TopographicalNo, Inserted.TopographicalNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.TopographicalNo <> Deleted.TopographicalNo
end

-------------------  BasisOfDiagnosisID  -----------------------------------------------------

if update(BasisOfDiagnosisID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BasisOfDiagnosisID', Deleted.BasisOfDiagnosisID, Inserted.BasisOfDiagnosisID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.BasisOfDiagnosisID <> Deleted.BasisOfDiagnosisID
end

-------------------  CancerStageID  -----------------------------------------------------

if update(CancerStageID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CancerStageID', Deleted.CancerStageID, Inserted.CancerStageID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.CancerStageID <> Deleted.CancerStageID
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.DiseaseNo = Deleted.DiseaseNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: IPDCancerDiagnosis ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDCancerDiagnosis')
drop trigger utrDeleteIPDCancerDiagnosis
go

create trigger utrDeleteIPDCancerDiagnosis
on IPDCancerDiagnosis
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDCancerDiagnosis' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  DiseaseNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseNo', Deleted.DiseaseNo, null from Deleted

-------------------  TopographicalNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TopographicalNo', Deleted.TopographicalNo, null from Deleted

-------------------  BasisOfDiagnosisID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BasisOfDiagnosisID', Deleted.BasisOfDiagnosisID, null from Deleted

-------------------  CancerStageID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CancerStageID', Deleted.CancerStageID, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

---------------------------------------------------------------------------------------------------
-------------- Update: DeliveryNoteDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateDeliveryNoteDetails')
drop trigger utrUpdateDeliveryNoteDetails
go

create trigger utrUpdateDeliveryNoteDetails
on DeliveryNoteDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'DeliveryNoteDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-TransferNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransferNo', Deleted.TransferNo, Inserted.TransferNo
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-DeliveryDate -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DeliveryDate', Deleted.DeliveryDate, Inserted.DeliveryDate
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.DeliveryDate = Deleted.DeliveryDate
end
-------------------  PackID  -----------------------------------------------------

if update(PackID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackID', Deleted.PackID, Inserted.PackID
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.PackID <> Deleted.PackID
end

-------------------  PackSize  -----------------------------------------------------

if update(PackSize)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackSize', Deleted.PackSize, Inserted.PackSize
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.PackSize <> Deleted.PackSize
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  UnitCost  -----------------------------------------------------

if update(UnitCost)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), cast(Inserted.UnitCost as varchar(20))
from Inserted inner join Deleted
on Inserted.TransferNo = Deleted.TransferNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.UnitCost <> Deleted.UnitCost
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: DeliveryNoteDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteDeliveryNoteDetails')
drop trigger utrDeleteDeliveryNoteDetails
go

create trigger utrDeleteDeliveryNoteDetails
on DeliveryNoteDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'DeliveryNoteDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  TransferNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TransferNo', Deleted.TransferNo, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  DeliveryDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DeliveryDate', Deleted.DeliveryDate, null from Deleted


-------------------  PackID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackID', Deleted.PackID, null from Deleted

-------------------  PackSize  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackSize', Deleted.PackSize, null from Deleted



-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  UnitCost  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitCost', cast(Deleted.UnitCost as varchar(20)), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: AccountTransferDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAccountTransferDetails')
drop trigger utrUpdateAccountTransferDetails
go

create trigger utrUpdateAccountTransferDetails
on AccountTransferDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName  from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'AccountTransferDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-TranNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TranNo', Deleted.TranNo, Inserted.TranNo
from Inserted inner join Deleted
on Inserted.TranNo = Deleted.TranNo
end

-------------------  FromAccount  -----------------------------------------------------

if update(FromAccount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FromAccount', Deleted.FromAccount, Inserted.FromAccount
from Inserted inner join Deleted
on Inserted.TranNo = Deleted.TranNo
and Inserted.FromAccount <> Deleted.FromAccount
end

-------------------  ToAccount  -----------------------------------------------------

if update(ToAccount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ToAccount', Deleted.ToAccount, Inserted.ToAccount
from Inserted inner join Deleted
on Inserted.TranNo = Deleted.TranNo
and Inserted.ToAccount <> Deleted.ToAccount
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.TranNo = Deleted.TranNo
and Inserted.Amount <> Deleted.Amount
end

-------------------  AmountInWords  -----------------------------------------------------

if update(AmountInWords)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountInWords', Deleted.AmountInWords, Inserted.AmountInWords
from Inserted inner join Deleted
on Inserted.TranNo = Deleted.TranNo
and Inserted.AmountInWords <> Deleted.AmountInWords
end

-------------------  Reason  -----------------------------------------------------

if update(Reason)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Reason', Deleted.Reason, Inserted.Reason
from Inserted inner join Deleted
on Inserted.TranNo = Deleted.TranNo
and Inserted.Reason <> Deleted.Reason
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.TranNo = Deleted.TranNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.TranNo = Deleted.TranNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.TranNo = Deleted.TranNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: AccountTransferDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAccountTransferDetails')
drop trigger utrDeleteAccountTransferDetails
go

create trigger utrDeleteAccountTransferDetails
on AccountTransferDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'AccountTransferDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  TranNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TranNo', Deleted.TranNo, null from Deleted

-------------------  FromAccount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FromAccount', Deleted.FromAccount, null from Deleted

-------------------  ToAccount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ToAccount', Deleted.ToAccount, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  AmountInWords  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountInWords', Deleted.AmountInWords, null from Deleted

-------------------  Reason  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Reason', Deleted.Reason, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: IPDPathologyReports ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDPathologyReports')
	drop trigger utrUpdateIPDPathologyReports
go

create trigger utrUpdateIPDPathologyReports
on IPDPathologyReports
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDPathologyReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RoundNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ReportTypeID  -----------------------------------------------------

if update(ReportTypeID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReportTypeID', Deleted.ReportTypeID, Inserted.ReportTypeID
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ReportTypeID <> Deleted.ReportTypeID
end

-------------------  ExamDateTime  -----------------------------------------------------

if update(ExamDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ExamDateTime', dbo.FormatDate(Deleted.ExamDateTime), dbo.FormatDate(Inserted.ExamDateTime)
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ExamDateTime <> Deleted.ExamDateTime
end

-------------------  Indication  -----------------------------------------------------

if update(Indication)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Indication', Deleted.Indication, Inserted.Indication
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Indication <> Deleted.Indication
end

-------------------  Diagnosis  -----------------------------------------------------

if update(Diagnosis)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Diagnosis', Deleted.Diagnosis, Inserted.Diagnosis
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Diagnosis <> Deleted.Diagnosis
end

-------------------  Macroscopic  -----------------------------------------------------

if update(Macroscopic)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Macroscopic', Deleted.Macroscopic, Inserted.Macroscopic
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Macroscopic <> Deleted.Macroscopic
end

-------------------  Microscopic  -----------------------------------------------------

if update(Microscopic)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Microscopic', Deleted.Microscopic, Inserted.Microscopic
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Microscopic <> Deleted.Microscopic
end

-------------------  Pathologist  -----------------------------------------------------

if update(Pathologist)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Pathologist', Deleted.Pathologist, Inserted.Pathologist
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Pathologist <> Deleted.Pathologist
end

-------------------  PathologyTitleID  -----------------------------------------------------

if update(PathologyTitleID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PathologyTitleID', Deleted.PathologyTitleID, Inserted.PathologyTitleID
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.PathologyTitleID <> Deleted.PathologyTitleID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: IPDPathologyReports ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDPathologyReports')
	drop trigger utrDeleteIPDPathologyReports
go

create trigger utrDeleteIPDPathologyReports
on IPDPathologyReports
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDPathologyReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ReportTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReportTypeID', Deleted.ReportTypeID, null from Deleted

-------------------  ExamDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamDateTime', dbo.FormatDate(Deleted.ExamDateTime), null from Deleted

-------------------  Indication  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Indication', Deleted.Indication, null from Deleted

-------------------  Diagnosis  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Diagnosis', Deleted.Diagnosis, null from Deleted

-------------------  Macroscopic  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Macroscopic', Deleted.Macroscopic, null from Deleted

-------------------  Microscopic  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Microscopic', Deleted.Microscopic, null from Deleted

-------------------  Pathologist  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pathologist', Deleted.Pathologist, null from Deleted

-------------------  PathologyTitleID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PathologyTitleID', Deleted.PathologyTitleID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go
------------------------------------------------------------------------------------------------------
-------------- Update: PrintDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePrintDetails')
drop trigger utrUpdatePrintDetails
go

create trigger utrUpdatePrintDetails
on PrintDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PrintDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-PatientNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PrintDesc = Deleted.PrintDesc
and Inserted.RecordDateTime = Deleted.RecordDateTime
end

------------------- Key-PrintDesc -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PrintDesc', Deleted.PrintDesc, Inserted.PrintDesc
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PrintDesc = Deleted.PrintDesc
and Inserted.RecordDateTime = Deleted.RecordDateTime
end

------------------- Key-RecordDateTime -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PrintDesc = Deleted.PrintDesc
and Inserted.RecordDateTime = Deleted.RecordDateTime
end

-------------------  DocumentNo  -----------------------------------------------------

if update(DocumentNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, Inserted.DocumentNo
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PrintDesc = Deleted.PrintDesc
and Inserted.RecordDateTime = Deleted.RecordDateTime
and Inserted.DocumentNo <> Deleted.DocumentNo
end

-------------------  PrintCategoryID  -----------------------------------------------------

if update(PrintCategoryID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PrintCategoryID', Deleted.PrintCategoryID, Inserted.PrintCategoryID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PrintDesc = Deleted.PrintDesc
and Inserted.RecordDateTime = Deleted.RecordDateTime
and Inserted.PrintCategoryID <> Deleted.PrintCategoryID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PrintDesc = Deleted.PrintDesc
and Inserted.RecordDateTime = Deleted.RecordDateTime
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.PatientNo = Deleted.PatientNo
and Inserted.PrintDesc = Deleted.PrintDesc
and Inserted.RecordDateTime = Deleted.RecordDateTime
and Inserted.ClientMachine <> Deleted.ClientMachine
end


go


------------------------------------------------------------------------------------------------------
-------------- Delete: PrintDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePrintDetails')
drop trigger utrDeletePrintDetails
go

create trigger utrDeletePrintDetails
on PrintDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PrintDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  DocumentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, null from Deleted

-------------------  PrintDesc  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PrintDesc', Deleted.PrintDesc, null from Deleted

-------------------  PrintCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PrintCategoryID', Deleted.PrintCategoryID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: RefundRequests ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRefundRequests')
	drop trigger utrUpdateRefundRequests
go

create trigger utrUpdateRefundRequests
on RefundRequests
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'RefundRequests' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RefundRequestNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RefundRequestNo', Deleted.RefundRequestNo, Inserted.RefundRequestNo
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
end

-------------------  RefundRequestID  -----------------------------------------------------

if update(RefundRequestID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RefundRequestID', Deleted.RefundRequestID, Inserted.RefundRequestID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.RefundRequestID <> Deleted.RefundRequestID
end

-------------------  ReceiptNo  -----------------------------------------------------

if update(ReceiptNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReceiptNo', Deleted.ReceiptNo, Inserted.ReceiptNo
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ReceiptNo <> Deleted.ReceiptNo
end

-------------------  RequestStatusID  -----------------------------------------------------

if update(RequestStatusID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RequestStatusID', Deleted.RequestStatusID, Inserted.RequestStatusID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.RequestStatusID <> Deleted.RequestStatusID
end

-------------------  ApprovalStatusID  -----------------------------------------------------

if update(ApprovalStatusID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ApprovalStatusID', Deleted.ApprovalStatusID, Inserted.ApprovalStatusID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ApprovalStatusID <> Deleted.ApprovalStatusID
end

-------------------  VisitTypeID  -----------------------------------------------------

if update(VisitTypeID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitTypeID', Deleted.VisitTypeID, Inserted.VisitTypeID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.VisitTypeID <> Deleted.VisitTypeID
end

-------------------  Requestedby  -----------------------------------------------------

if update(Requestedby)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Requestedby', Deleted.Requestedby, Inserted.Requestedby
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.Requestedby <> Deleted.Requestedby
end


-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: RefundRequests ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRefundRequests')
	drop trigger utrDeleteRefundRequests
go

create trigger utrDeleteRefundRequests
on RefundRequests
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'RefundRequests' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RefundRequestID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundRequestID', Deleted.RefundRequestID, null from Deleted

-------------------  RefundRequestNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundRequestNo', Deleted.RefundRequestNo, null from Deleted

-------------------  ReceiptNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, null from Deleted

-------------------  RequestStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RequestStatusID', Deleted.RequestStatusID, null from Deleted

-------------------  ApprovalStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalStatusID', Deleted.ApprovalStatusID, null from Deleted

-------------------  VisitTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitTypeID', Deleted.VisitTypeID, null from Deleted

-------------------  Requestedby  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Requestedby', Deleted.Requestedby, null from Deleted


-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go




------------------------------------------------------------------------------------------------------
-------------- Update: RefundRequestDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRefundRequestDetails')
	drop trigger utrUpdateRefundRequestDetails
go

create trigger utrUpdateRefundRequestDetails
on RefundRequestDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'RefundRequestDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RefundRequestNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RefundRequestNo', Deleted.RefundRequestNo, Inserted.RefundRequestNo
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-VisitNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ReceiptNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReceiptNo', Deleted.ReceiptNo, Inserted.ReceiptNo
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ReturnReasonID  -----------------------------------------------------

if update(ReturnReasonID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, Inserted.ReturnReasonID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ReturnReasonID <> Deleted.ReturnReasonID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Amount <> Deleted.Amount
end


-------------------  NewPrice  -----------------------------------------------------

if update(NewPrice)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'NewPrice', cast(Deleted.NewPrice as varchar(20)), cast(Inserted.NewPrice as varchar(20))
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.NewPrice <> Deleted.NewPrice
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: RefundRequestDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRefundRequestDetails')
	drop trigger utrDeleteRefundRequestDetails
go

create trigger utrDeleteRefundRequestDetails
on RefundRequestDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'RefundRequestDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RefundRequestNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundRequestNo', Deleted.RefundRequestNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ReceiptNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ReturnReasonID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  NewPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewPrice', cast(Deleted.NewPrice as varchar(20)), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: RefundRequestExtraBillItems ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRefundRequestExtraBillItems')
	drop trigger utrUpdateRefundRequestExtraBillItems
go

create trigger utrUpdateRefundRequestExtraBillItems
on RefundRequestExtraBillItems
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'RefundRequestExtraBillItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RefundRequestNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RefundRequestNo', Deleted.RefundRequestNo, Inserted.RefundRequestNo
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ExtraBillNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, Inserted.ExtraBillNo
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ReceiptNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReceiptNo', Deleted.ReceiptNo, Inserted.ReceiptNo
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ReturnReasonID  -----------------------------------------------------

if update(ReturnReasonID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, Inserted.ReturnReasonID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ReturnReasonID <> Deleted.ReturnReasonID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Amount <> Deleted.Amount
end

-------------------  NewPrice  -----------------------------------------------------

if update(NewPrice)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'NewPrice', cast(Deleted.NewPrice as varchar(20)), cast(Inserted.NewPrice as varchar(20))
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.NewPrice <> Deleted.NewPrice
end



-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.ReceiptNo = Deleted.ReceiptNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: RefundRequestExtraBillItems ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRefundRequestExtraBillItems')
	drop trigger utrDeleteRefundRequestExtraBillItems
go

create trigger utrDeleteRefundRequestExtraBillItems
on RefundRequestExtraBillItems
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'RefundRequestExtraBillItems' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RefundRequestNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundRequestNo', Deleted.RefundRequestNo, null from Deleted

-------------------  ExtraBillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, null from Deleted

-------------------  ReceiptNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ReturnReasonID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  NewPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NewPrice', cast(Deleted.NewPrice as varchar(20)), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go




------------------------------------------------------------------------------------------------------
-------------- Update: RefundApprovals ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRefundApprovals')
	drop trigger utrUpdateRefundApprovals
go

create trigger utrUpdateRefundApprovals
on RefundApprovals
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'RefundApprovals' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RefundRequestNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RefundRequestNo', Deleted.RefundRequestNo, Inserted.RefundRequestNo
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.Notes <> Deleted.Notes
end

-------------------  AttendingPersonel  -----------------------------------------------------

if update(AttendingPersonel)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AttendingPersonel', Deleted.AttendingPersonel, Inserted.AttendingPersonel
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.AttendingPersonel <> Deleted.AttendingPersonel
end

-------------------  ApprovalStatusID  -----------------------------------------------------

if update(ApprovalStatusID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ApprovalStatusID', Deleted.ApprovalStatusID, Inserted.ApprovalStatusID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ApprovalStatusID <> Deleted.ApprovalStatusID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: RefundApprovals ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRefundApprovals')
	drop trigger utrDeleteRefundApprovals
go

create trigger utrDeleteRefundApprovals
on RefundApprovals
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'RefundApprovals' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RefundRequestNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundRequestNo', Deleted.RefundRequestNo, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  AttendingPersonel  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AttendingPersonel', Deleted.AttendingPersonel, null from Deleted

-------------------  ApprovalStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApprovalStatusID', Deleted.ApprovalStatusID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: RefundRejects ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateRefundRejects')
	drop trigger utrUpdateRefundRejects
go

create trigger utrUpdateRefundRejects
on RefundRejects
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'RefundRejects' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RefundRequestNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RefundRequestNo', Deleted.RefundRequestNo, Inserted.RefundRequestNo
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
end

-------------------  ReceiptNo  -----------------------------------------------------

if update(ReceiptNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReceiptNo', Deleted.ReceiptNo, Inserted.ReceiptNo
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ReceiptNo <> Deleted.ReceiptNo
end

-------------------  RejectedAt  -----------------------------------------------------

if update(RejectedAt)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RejectedAt', Deleted.RejectedAt, Inserted.RejectedAt
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.RejectedAt <> Deleted.RejectedAt
end

-------------------  RejectionDate  -----------------------------------------------------

if update(RejectionDate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RejectionDate', dbo.FormatDate(Deleted.RejectionDate), dbo.FormatDate(Inserted.RejectionDate)
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.RejectionDate <> Deleted.RejectionDate
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.RefundRequestNo = Deleted.RefundRequestNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: RefundRejects ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteRefundRejects')
	drop trigger utrDeleteRefundRejects
go

create trigger utrDeleteRefundRejects
on RefundRejects
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'RefundRejects' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RefundRequestNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundRequestNo', Deleted.RefundRequestNo, null from Deleted

-------------------  ReceiptNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, null from Deleted

-------------------  RejectedAt  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RejectedAt', Deleted.RejectedAt, null from Deleted

-------------------  RejectionDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RejectionDate', dbo.FormatDate(Deleted.RejectionDate), null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: InvoiceAdjustments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInvoiceAdjustments')
	drop trigger utrUpdateInvoiceAdjustments
go

create trigger utrUpdateInvoiceAdjustments
on InvoiceAdjustments
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InvoiceAdjustments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-AdjustmentNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AdjustmentNo', Deleted.AdjustmentNo, Inserted.AdjustmentNo
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
end

-------------------  AdjustmentID  -----------------------------------------------------

if update(AdjustmentID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AdjustmentID', Deleted.AdjustmentID, Inserted.AdjustmentID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.AdjustmentID <> Deleted.AdjustmentID
end

-------------------  InvoiceNo  -----------------------------------------------------

if update(InvoiceNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'InvoiceNo', Deleted.InvoiceNo, Inserted.InvoiceNo
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.InvoiceNo <> Deleted.InvoiceNo
end

-------------------  VisitTypeID  -----------------------------------------------------

if update(VisitTypeID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitTypeID', Deleted.VisitTypeID, Inserted.VisitTypeID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitTypeID <> Deleted.VisitTypeID
end

-------------------  EntryLevelID  -----------------------------------------------------

if update(EntryLevelID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'EntryLevelID', Deleted.EntryLevelID, Inserted.EntryLevelID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.EntryLevelID <> Deleted.EntryLevelID
end

-------------------  AdjustmentTypeID  -----------------------------------------------------

if update(AdjustmentTypeID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AdjustmentTypeID', Deleted.AdjustmentTypeID, Inserted.AdjustmentTypeID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.AdjustmentTypeID <> Deleted.AdjustmentTypeID
end

-------------------  ReversalActionID  -----------------------------------------------------

if update(ReversalActionID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReversalActionID', Deleted.ReversalActionID, Inserted.ReversalActionID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ReversalActionID <> Deleted.ReversalActionID
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.Amount <> Deleted.Amount
end

-------------------  AdjustmentDate  -----------------------------------------------------

if update(AdjustmentDate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AdjustmentDate', dbo.FormatDate(Deleted.AdjustmentDate), dbo.FormatDate(Inserted.AdjustmentDate)
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.AdjustmentDate <> Deleted.AdjustmentDate
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: InvoiceAdjustments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInvoiceAdjustments')
	drop trigger utrDeleteInvoiceAdjustments
go

create trigger utrDeleteInvoiceAdjustments
on InvoiceAdjustments
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InvoiceAdjustments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AdjustmentID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdjustmentID', Deleted.AdjustmentID, null from Deleted

-------------------  AdjustmentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdjustmentNo', Deleted.AdjustmentNo, null from Deleted

-------------------  InvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, null from Deleted

-------------------  VisitTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitTypeID', Deleted.VisitTypeID, null from Deleted

-------------------  EntryLevelID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EntryLevelID', Deleted.EntryLevelID, null from Deleted

-------------------  AdjustmentTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdjustmentTypeID', Deleted.AdjustmentTypeID, null from Deleted


-------------------  ReversalActionID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReversalActionID', Deleted.ReversalActionID, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  AdjustmentDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdjustmentDate', dbo.FormatDate(Deleted.AdjustmentDate), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: InvoiceDetailAdjustments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInvoiceDetailAdjustments')
	drop trigger utrUpdateInvoiceDetailAdjustments
go

create trigger utrUpdateInvoiceDetailAdjustments
on InvoiceDetailAdjustments
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InvoiceDetailAdjustments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-AdjustmentNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AdjustmentNo', Deleted.AdjustmentNo, Inserted.AdjustmentNo
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-VisitNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-InvoiceNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'InvoiceNo', Deleted.InvoiceNo, Inserted.InvoiceNo
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ReturnReasonID  -----------------------------------------------------

if update(ReturnReasonID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, Inserted.ReturnReasonID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ReturnReasonID <> Deleted.ReturnReasonID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Amount <> Deleted.Amount
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitNo = Deleted.VisitNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: InvoiceDetailAdjustments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInvoiceDetailAdjustments')
	drop trigger utrDeleteInvoiceDetailAdjustments
go

create trigger utrDeleteInvoiceDetailAdjustments
on InvoiceDetailAdjustments
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InvoiceDetailAdjustments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AdjustmentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdjustmentNo', Deleted.AdjustmentNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  InvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ReturnReasonID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: InvoiceExtraBillItemAdjustments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateInvoiceExtraBillItemAdjustments')
	drop trigger utrUpdateInvoiceExtraBillItemAdjustments
go

create trigger utrUpdateInvoiceExtraBillItemAdjustments
on InvoiceExtraBillItemAdjustments
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'InvoiceExtraBillItemAdjustments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-AdjustmentNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AdjustmentNo', Deleted.AdjustmentNo, Inserted.AdjustmentNo
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ExtraBillNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, Inserted.ExtraBillNo
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-InvoiceNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'InvoiceNo', Deleted.InvoiceNo, Inserted.InvoiceNo
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ReturnReasonID  -----------------------------------------------------

if update(ReturnReasonID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, Inserted.ReturnReasonID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ReturnReasonID <> Deleted.ReturnReasonID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Amount <> Deleted.Amount
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.InvoiceNo = Deleted.InvoiceNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: InvoiceExtraBillItemAdjustments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteInvoiceExtraBillItemAdjustments')
	drop trigger utrDeleteInvoiceExtraBillItemAdjustments
go

create trigger utrDeleteInvoiceExtraBillItemAdjustments
on InvoiceExtraBillItemAdjustments
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'InvoiceExtraBillItemAdjustments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AdjustmentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdjustmentNo', Deleted.AdjustmentNo, null from Deleted

-------------------  ExtraBillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, null from Deleted

-------------------  InvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceNo', Deleted.InvoiceNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ReturnReasonID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnReasonID', Deleted.ReturnReasonID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: BillAdjustments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateBillAdjustments')
	drop trigger utrUpdateBillAdjustments
go

create trigger utrUpdateBillAdjustments
on BillAdjustments
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'BillAdjustments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-AdjustmentNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AdjustmentNo', Deleted.AdjustmentNo, Inserted.AdjustmentNo
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
end

-------------------  AdjustmentID  -----------------------------------------------------

if update(AdjustmentID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AdjustmentID', Deleted.AdjustmentID, Inserted.AdjustmentID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.AdjustmentID <> Deleted.AdjustmentID
end

-------------------  BillNo  -----------------------------------------------------

if update(BillNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'BillNo', Deleted.BillNo, Inserted.BillNo
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.BillNo <> Deleted.BillNo
end

-------------------  AdjustmentDate  -----------------------------------------------------

if update(AdjustmentDate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AdjustmentDate', dbo.FormatDate(Deleted.AdjustmentDate), dbo.FormatDate(Inserted.AdjustmentDate)
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.AdjustmentDate <> Deleted.AdjustmentDate
end

-------------------  VisitTypeID  -----------------------------------------------------

if update(VisitTypeID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitTypeID', Deleted.VisitTypeID, Inserted.VisitTypeID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.VisitTypeID <> Deleted.VisitTypeID
end

-------------------  AdjustmentTypeID  -----------------------------------------------------

if update(AdjustmentTypeID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AdjustmentTypeID', Deleted.AdjustmentTypeID, Inserted.AdjustmentTypeID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.AdjustmentTypeID <> Deleted.AdjustmentTypeID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.AdjustmentNo = Deleted.AdjustmentNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: BillAdjustments ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteBillAdjustments')
	drop trigger utrDeleteBillAdjustments
go

create trigger utrDeleteBillAdjustments
on BillAdjustments
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'BillAdjustments' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AdjustmentID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdjustmentID', Deleted.AdjustmentID, null from Deleted

-------------------  AdjustmentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdjustmentNo', Deleted.AdjustmentNo, null from Deleted

-------------------  BillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillNo', Deleted.BillNo, null from Deleted

-------------------  AdjustmentDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdjustmentDate', dbo.FormatDate(Deleted.AdjustmentDate), null from Deleted

-------------------  VisitTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitTypeID', Deleted.VisitTypeID, null from Deleted

-------------------  AdjustmentTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdjustmentTypeID', Deleted.AdjustmentTypeID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go





------------------------------------------------------------------------------------------------------
-------------- Update: MappedCodes ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateMappedCodes')
	drop trigger utrUpdateMappedCodes
go

create trigger utrUpdateMappedCodes
on MappedCodes
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'MappedCodes' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-AccountNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
	from Inserted inner join Deleted
	on Inserted.AccountNo = Deleted.AccountNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID = Deleted.LoginID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.AccountNo = Deleted.AccountNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID = Deleted.LoginID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.AccountNo = Deleted.AccountNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID = Deleted.LoginID
end

------------------- Key-LoginID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.AccountNo = Deleted.AccountNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID = Deleted.LoginID
end

-------------------  CustomCode  -----------------------------------------------------

if update(CustomCode)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CustomCode', Deleted.CustomCode, Inserted.CustomCode
	from Inserted inner join Deleted
	on Inserted.AccountNo = Deleted.AccountNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID = Deleted.LoginID
	and Inserted.CustomCode <> Deleted.CustomCode
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.AccountNo = Deleted.AccountNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID = Deleted.LoginID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.AccountNo = Deleted.AccountNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID = Deleted.LoginID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: MappedCodes ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteMappedCodes')
	drop trigger utrDeleteMappedCodes
go

create trigger utrDeleteMappedCodes
on MappedCodes
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'MappedCodes' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AccountNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  CustomCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CustomCode', Deleted.CustomCode, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: CardiologyExaminations ---------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateCardiologyExaminations')
drop trigger utrUpdateCardiologyExaminations
go

create trigger utrUpdateCardiologyExaminations
on CardiologyExaminations
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'CardiologyExaminations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ExamCode --------------------------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamCode', Deleted.ExamCode, Inserted.ExamCode
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
end

-------------------  ExamName  -----------------------------------------------------

if update(ExamName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamName', Deleted.ExamName, Inserted.ExamName
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.ExamName <> Deleted.ExamName
end

-------------------  CardiologyCategoriesID  -----------------------------------------------------

if update(CardiologyCategoriesID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CardiologyCategoriesID', Deleted.CardiologyCategoriesID, Inserted.CardiologyCategoriesID
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.CardiologyCategoriesID <> Deleted.CardiologyCategoriesID
end

-------------------  CardiologySiteID  -----------------------------------------------------

if update(CardiologySiteID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CardiologySiteID', Deleted.CardiologySiteID, Inserted.CardiologySiteID
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.CardiologySiteID <> Deleted.CardiologySiteID
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  Hidden  -----------------------------------------------------

if update(Hidden)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, Inserted.Hidden
from Inserted inner join Deleted
on Inserted.ExamCode = Deleted.ExamCode
and Inserted.Hidden <> Deleted.Hidden
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.ExamCode = Deleted.ExamCode
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.ExamCode = Deleted.ExamCode
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.ExamCode = Deleted.ExamCode
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go



------------------------------------------------------------------------------------------------------
-------------- Delete: CardiologyExaminations ---------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteCardiologyExaminations')
drop trigger utrDeleteCardiologyExaminations
go

create trigger utrDeleteCardiologyExaminations
on CardiologyExaminations
for delete
as

declare @ErrorMSG varchar(200)
declare @ItemCategoryID varchar(10)

declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

set @ItemCategoryID = dbo.GetLookupDataID('ItemCategory', 'CA')

if exists (select ItemCode from Items 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from IPDItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in IPD Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from ExtraBillItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentDetails 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Details'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else
		
if exists (select ItemCode from PaymentExtraBillItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Payment Extra Bill Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from BillCustomFee 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

else

if exists (select ItemCode from BillExcludedItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Bill Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceCustomFee 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Custom Fee'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExclusions 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Exclusions'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end
else

if exists (select ItemCode from InsuranceExcludedItems 
where (ItemCode in (select ExamCode from Deleted) and ItemCategoryID = @ItemCategoryID))
begin
set @ErrorMSG = 'Can''t delete record with corresponding entries in Insurance Excluded Items'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'CardiologyExaminations' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ExamCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamCode', Deleted.ExamCode, null from Deleted

-------------------  ExamName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamName', Deleted.ExamName, null from Deleted

-------------------  CardiologyCategoriesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CardiologyCategoriesID', Deleted.CardiologyCategoriesID, null from Deleted

-------------------  CardiologySiteID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CardiologySiteID', Deleted.CardiologySiteID, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  Hidden  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Hidden', Deleted.Hidden, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: CardiologyReports --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateCardiologyReports')
drop trigger utrUpdateCardiologyReports
go

create trigger utrUpdateCardiologyReports
on CardiologyReports
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'CardiologyReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-VisitNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ExamDateTime  -----------------------------------------------------

if update(ExamDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamDateTime', dbo.FormatDate(Deleted.ExamDateTime), dbo.FormatDate(Inserted.ExamDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ExamDateTime <> Deleted.ExamDateTime
end

-------------------  Indication  -----------------------------------------------------

if update(Indication)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Indication', Deleted.Indication, Inserted.Indication
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Indication <> Deleted.Indication
end


-------------------  Report  -----------------------------------------------------

if update(Report)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, Inserted.Report
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Report <> Deleted.Report
end

-------------------  Conclusion  -----------------------------------------------------

if update(Conclusion)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Conclusion', Deleted.Conclusion, Inserted.Conclusion
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Conclusion <> Deleted.Conclusion
end

-------------------  Cardiologist  -----------------------------------------------------

if update(Cardiologist)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Cardiologist', Deleted.Cardiologist, Inserted.Cardiologist
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Cardiologist <> Deleted.Cardiologist
end

-------------------  CardiologyTitleID  -----------------------------------------------------

if update(CardiologyTitleID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CardiologyTitleID', Deleted.CardiologyTitleID, Inserted.CardiologyTitleID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CardiologyTitleID <> Deleted.CardiologyTitleID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', dbo.FormatDateTime(Deleted.ClientMachine), dbo.FormatDateTime(Inserted.ClientMachine)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.VisitNo = Deleted.VisitNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: CardiologyReports --------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteCardiologyReports')
drop trigger utrDeleteCardiologyReports
go

create trigger utrDeleteCardiologyReports
on CardiologyReports
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'CardiologyReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ExamDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamDateTime', dbo.FormatDate(Deleted.ExamDateTime), null from Deleted

-------------------  Indication  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Indication', Deleted.Indication, null from Deleted

-------------------  Report  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, null from Deleted

-------------------  Conclusion  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Conclusion', Deleted.Conclusion, null from Deleted

-------------------  Cardiologist  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Cardiologist', Deleted.Cardiologist, null from Deleted

-------------------  CardiologyTitleID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CardiologyTitleID', Deleted.CardiologyTitleID, null from Deleted


-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go










------------------------------------------------------------------------------------------------------
-------------- Update: IPDCardiologyReports -----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDCardiologyReports')
drop trigger utrUpdateIPDCardiologyReports
go

create trigger utrUpdateIPDCardiologyReports
on IPDCardiologyReports
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDCardiologyReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-RoundNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  ExamDateTime  -----------------------------------------------------

if update(ExamDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamDateTime', dbo.FormatDate(Deleted.ExamDateTime), dbo.FormatDate(Inserted.ExamDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ExamDateTime <> Deleted.ExamDateTime
end

-------------------  Indication  -----------------------------------------------------

if update(Indication)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Indication', Deleted.Indication, Inserted.Indication
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Indication <> Deleted.Indication
end

-------------------  Report  -----------------------------------------------------

if update(Report)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, Inserted.Report
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Report <> Deleted.Report
end

-------------------  Conclusion  -----------------------------------------------------

if update(Conclusion)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Conclusion', Deleted.Conclusion, Inserted.Conclusion
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Conclusion <> Deleted.Conclusion
end

-------------------  Cardiologist  -----------------------------------------------------

if update(Cardiologist)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Cardiologist', Deleted.Cardiologist, Inserted.Cardiologist
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.Cardiologist <> Deleted.Cardiologist
end

-------------------  CardiologyTitleID  -----------------------------------------------------

if update(CardiologyTitleID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CardiologyTitleID', Deleted.CardiologyTitleID, Inserted.CardiologyTitleID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.CardiologyTitleID <> Deleted.CardiologyTitleID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', dbo.FormatDateTime(Deleted.ClientMachine), dbo.FormatDateTime(Inserted.ClientMachine)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.RoundNo = Deleted.RoundNo
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: IPDCardiologyReports -----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDCardiologyReports')
drop trigger utrDeleteIPDCardiologyReports
go

create trigger utrDeleteIPDCardiologyReports
on IPDCardiologyReports
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDCardiologyReports' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ExamDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExamDateTime', dbo.FormatDate(Deleted.ExamDateTime), null from Deleted

-------------------  Indication  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Indication', Deleted.Indication, null from Deleted

-------------------  Report  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Report', Deleted.Report, null from Deleted

-------------------  Conclusion  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Conclusion', Deleted.Conclusion, null from Deleted

-------------------  Cardiologist  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Cardiologist', Deleted.Cardiologist, null from Deleted

-------------------  CardiologyTitleID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CardiologyTitleID', Deleted.CardiologyTitleID, null from Deleted


-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go




--------GetCardiologyProcessingItems----------------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'uspGetCardiologyProcessingItems')
	drop proc uspGetCardiologyProcessingItems
go

create proc uspGetCardiologyProcessingItems(
@ItemCategoryID varchar(10),
@StartDate smalldatetime = null,
@EndDate smalldatetime = null
)with encryption as

declare @ProcessingItemStatusID varchar(10)
declare @ServicePointID varchar(10)
declare @CardiologyID varchar(10)
set @ProcessingItemStatusID = dbo.GetLookupDataID('ItemStatus', 'CA')
set @CardiologyID = dbo.GetLookupDataID('ItemCategory', 'CA')
set @ServicePointID=dbo.GetLookupDataID('ServicePoint', 'CAR')


if not(@StartDate is null) and not(@EndDate is null)
begin

if @ItemCategoryID=@CardiologyID
  begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,TokenNo, FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime
	from Items  
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues  on Queues.VisitNo = Items.VisitNo and ServicePointID=@ServicePointID and QueueStatus=1
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @ProcessingItemStatusID
	and VisitDate between @StartDate and @EndDate
	order by TokenNO asc, VisitNo desc
   end
else
 begin
	select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,'' as TokenNo, FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty, 
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime
	from Items  
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @ProcessingItemStatusID
	and VisitDate between @StartDate and @EndDate
	order by VisitNo desc
 end
end

else
begin

  if(@ItemCategoryID=@CardiologyID)
     begin
	  select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,TokenNo, FirstName,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	left outer join Queues  on Queues.VisitNo = Items.VisitNo and ServicePointID=@ServicePointID and QueueStatus=1
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @ProcessingItemStatusID
	order by TokenNo asc, VisitNo desc
end
else
   begin
      select dbo.FormatText(Visits.PatientNo, 'Patients', 'PatientNo') as PatientNo,	
			dbo.FormatText(Items.VisitNo, 'Visits', 'VisitNo') as VisitNo,'' as TokenNo, FirstName,
			dbo.FormatDate(VisitDate) as VisitDate, 
			Quantity, UnitPrice,
			(Quantity * dbo.GetCoPayCashAmount(CoPayTypeID, CoPayPercent, UnitPrice)) as Amount,ItemName,
			dbo.GetFullName(LastName, MiddleName, FirstName) as FullName, 
			dbo.GetLookupDataDes(GenderID) as Gender, dbo.GetAge(BirthDate, getdate()) as Age, 
			dbo.GetBillName(BillModesID, BillNo) as BillCustomerName, 
			dbo.GetLookupDataDes(PayStatusID) as PayStatus, 
			dbo.GetLookupDataDes(ItemStatusID) as ItemStatus, 
			dbo.GetDoctorFullName(Visits.VisitNo) as PrimaryDoctor,
			dbo.GetDoctorSpecialty(Visits.VisitNo) as DoctorSpecialty,
			dbo.FormatDate(Items.RecordDateTime) as RecordDate, 
			dbo.GetTime(Items.RecordDateTime) as RecordTime
	from Items 
	inner join Visits  on Items.VisitNo = Visits.VisitNo
	inner join Patients on Visits.PatientNo = Patients.PatientNo
	where ItemCategoryID = @ItemCategoryID and ItemStatusID = @ProcessingItemStatusID
	order by VisitNo desc
 end	
    
end	
return 0
go


------------------------------------------------------------------------------------------------------
-------------- Update: ImmunisationVaccines ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateImmunisationVaccines')
	drop trigger utrUpdateImmunisationVaccines
go

create trigger utrUpdateImmunisationVaccines
on ImmunisationVaccines
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ImmunisationVaccines' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return


-------------------  ImmunisationNo  -----------------------------------------------------

if update(ImmunisationNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ImmunisationNo', Deleted.ImmunisationNo, Inserted.ImmunisationNo
	from Inserted inner join Deleted
	on Inserted.ImmunisationNo = Deleted.ImmunisationNo
	and Inserted.ImmunisationNo <> Deleted.ImmunisationNo
end

-------------------  PatientNo  -----------------------------------------------------

if update(PatientNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
	from Inserted inner join Deleted
	on Inserted.PatientNo <> Deleted.PatientNo
end

-------------------  VaccineName  -----------------------------------------------------

if update(VaccineName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VaccineName', Deleted.VaccineName, Inserted.VaccineName
	from Inserted inner join Deleted
	on Inserted.VaccineName <> Deleted.VaccineName
end

-------------------  VaccineReceived  -----------------------------------------------------

if update(VaccineReceived)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VaccineReceived', Deleted.VaccineReceived, Inserted.VaccineReceived
	from Inserted inner join Deleted
	on Inserted.VaccineReceived <> Deleted.VaccineReceived
end

-------------------  DateGiven  -----------------------------------------------------

if update(DateGiven)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DateGiven', dbo.FormatDate(Deleted.DateGiven), dbo.FormatDate(Inserted.DateGiven)
	from Inserted inner join Deleted
	on Inserted.DateGiven <> Deleted.DateGiven
end

-------------------  PlaceReceived  -----------------------------------------------------

if update(PlaceReceived)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PlaceReceived', Deleted.PlaceReceived, Inserted.PlaceReceived
	from Inserted inner join Deleted
	on Inserted.PlaceReceived <> Deleted.PlaceReceived
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
	from Inserted inner join Deleted
	on Inserted.Notes <> Deleted.Notes
end

-------------------  MothersName  -----------------------------------------------------

if update(MothersName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'MothersName', Deleted.MothersName, Inserted.MothersName
	from Inserted inner join Deleted
	on Inserted.MothersName <> Deleted.MothersName
end
-------------------  UpToDate  -----------------------------------------------------

if update(UpToDate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'UpToDate', Deleted.UpToDate, Inserted.UpToDate
	from Inserted inner join Deleted
	on Inserted.UpToDate <> Deleted.UpToDate
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.LoginID <> Deleted.LoginID
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: ImmunisationVaccines ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteImmunisationVaccines')
	drop trigger utrDeleteImmunisationVaccines
go

create trigger utrDeleteImmunisationVaccines
on ImmunisationVaccines
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ImmunisationVaccines' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ImmunisationNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ImmunisationNo', Deleted.ImmunisationNo, null from Deleted
-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  VaccineName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VaccineName', Deleted.VaccineName, null from Deleted

-------------------  VaccineReceived  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VaccineReceived', Deleted.VaccineReceived, null from Deleted

-------------------  DateGiven  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DateGiven', dbo.FormatDate(Deleted.DateGiven), null from Deleted

-------------------  PlaceReceived  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PlaceReceived', Deleted.PlaceReceived, null from Deleted

-------------------  MothersName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MothersName', Deleted.MothersName, null from Deleted

-------------------  UpToDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UpToDate', Deleted.UpToDate, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

go

--------------------------------------------------------------------------------------------------------
---------------- Update: ChildNutrition ----------------------------------------------------------
--------------------------------------------------------------------------------------------------------

--if exists (select * from sysobjects where name = 'utrUpdateChildNutrition')
--	drop trigger utrUpdateChildNutrition
--go

--create trigger utrUpdateChildNutrition
--on ChildNutrition
--for update
--as
--declare @ErrorMSG varchar(200)
--declare @Identity int
--declare @ObjectName varchar(40)
--declare @FullDate smalldatetime

--if @@rowcount = 0 return

--------------------- Log Updates ----------------------------------------------

--if ident_current('AuditTrail') <>  @@identity return
--set @Identity = ident_current('AuditTrail')

--if @Identity is null return

--set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
--if @ObjectName is null return
--if @ObjectName <> 'ChildNutrition' return

--set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
--if @FullDate is null return
--if datediff(second, @FullDate, getdate()) > 60 return

---------------------  VisitNo  -----------------------------------------------------

--if update(VisitNo)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
--	from Inserted inner join Deleted
	
--	on Inserted.VisitNo <> Deleted.VisitNo
--end

---------------------  BreastFeeding  -----------------------------------------------------

--if update(BreastFeeding)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'BreastFeeding', Deleted.BreastFeeding, Inserted.BreastFeeding
--	from Inserted inner join Deleted
	
--	on Inserted.BreastFeeding <> Deleted.BreastFeeding
--end

---------------------  IfNoDetails  -----------------------------------------------------

--if update(IfNoDetails)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'IfNoDetails', Deleted.IfNoDetails, Inserted.IfNoDetails
--	from Inserted inner join Deleted
	
--	on Inserted.IfNoDetails <> Deleted.IfNoDetails
--end

---------------------  ComplementaryFoods  -----------------------------------------------------

--if update(ComplementaryFoods)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'ComplementaryFoods', Deleted.ComplementaryFoods, Inserted.ComplementaryFoods
--	from Inserted inner join Deleted
	
--	on Inserted.ComplementaryFoods <> Deleted.ComplementaryFoods
--end

---------------------  ComplementaryFoodsDetails  -----------------------------------------------------

--if update(ComplementaryFoodsDetails)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'ComplementaryFoodsDetails', Deleted.ComplementaryFoodsDetails, Inserted.ComplementaryFoodsDetails
--	from Inserted inner join Deleted
	
--	on Inserted.ComplementaryFoodsDetails <> Deleted.ComplementaryFoodsDetails
--end


---------------------  LoginID  -----------------------------------------------------

--if update(LoginID)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
--	from Inserted inner join Deleted
	
--	on Inserted.LoginID <> Deleted.LoginID
--end

--go


--------------------------------------------------------------------------------------------------------
---------------- Delete: ChildNutrition ----------------------------------------------------------
--------------------------------------------------------------------------------------------------------

--if exists (select * from sysobjects where name = 'utrDeleteChildNutrition')
--	drop trigger utrDeleteChildNutrition
--go

--create trigger utrDeleteChildNutrition
--on ChildNutrition
--for delete
--as
--declare @Identity int
--declare @ObjectName varchar(40)
--declare @FullDate smalldatetime

--if @@rowcount = 0 return

--------------------- Log Deletes ----------------------------------------------

--if ident_current('AuditTrail') <>  @@identity return
--set @Identity = ident_current('AuditTrail')

--if @Identity is null return

--set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
--if @ObjectName is null return
--if @ObjectName <> 'ChildNutrition' return

--set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
--if @FullDate is null return
--if datediff(second, @FullDate, getdate()) > 60 return

---------------------  VisitNo  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

---------------------  BreastFeeding  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'BreastFeeding', Deleted.BreastFeeding, null from Deleted

---------------------  IfNoDetails  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'IfNoDetails', Deleted.IfNoDetails, null from Deleted

---------------------  ComplementaryFoods  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'ComplementaryFoods', Deleted.ComplementaryFoods, null from Deleted

---------------------  ComplementaryFoodsDetails  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'ComplementaryFoodsDetails', Deleted.ComplementaryFoodsDetails, null from Deleted

---------------------  LoginID  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

--go

------------------------------------------------------------------------------------------------------
-------------- Update: Antenatal ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAntenatal')
	drop trigger utrUpdateAntenatal
go

create trigger utrUpdateAntenatal
on Antenatal
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Antenatal' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	
	on Inserted.VisitNo <> Deleted.VisitNo
end

-------------------  Infection  -----------------------------------------------------

if update(Infection)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Infection', Deleted.Infection, Inserted.Infection
	from Inserted inner join Deleted
		on Inserted.Infection <> Deleted.Infection
end

-------------------  InfectionDetails  -----------------------------------------------------

if update(InfectionDetails)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'InfectionDetails', Deleted.InfectionDetails, Inserted.InfectionDetails
	from Inserted inner join Deleted
	
	on Inserted.InfectionDetails <> Deleted.InfectionDetails
end

-------------------  AccidentDuringPregnancy  -----------------------------------------------------

if update(AccidentDuringPregnancy)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AccidentDuringPregnancy', Deleted.AccidentDuringPregnancy, Inserted.AccidentDuringPregnancy
	from Inserted inner join Deleted
	
	on Inserted.AccidentDuringPregnancy <> Deleted.AccidentDuringPregnancy
end

-------------------  DetailsOfAccident  -----------------------------------------------------

if update(DetailsOfAccident)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DetailsOfAccident', Deleted.DetailsOfAccident, Inserted.DetailsOfAccident
	from Inserted inner join Deleted
	
	on Inserted.DetailsOfAccident <> Deleted.DetailsOfAccident
end

-------------------  UseOfDrugsOrPrescription  -----------------------------------------------------

if update(UseOfDrugsOrPrescription)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'UseOfDrugsOrPrescription', Deleted.UseOfDrugsOrPrescription, Inserted.UseOfDrugsOrPrescription
	from Inserted inner join Deleted
	
	on Inserted.UseOfDrugsOrPrescription <> Deleted.UseOfDrugsOrPrescription
end

-------------------  DrugDetails  -----------------------------------------------------

if update(DrugDetails)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DrugDetails', Deleted.DrugDetails, Inserted.DrugDetails
	from Inserted inner join Deleted
	
	on Inserted.DrugDetails <> Deleted.DrugDetails
end

-------------------  Smoking  -----------------------------------------------------

if update(Smoking)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Smoking', Deleted.Smoking, Inserted.Smoking
	from Inserted inner join Deleted
	
	on Inserted.Smoking <> Deleted.Smoking
end

-------------------  ChronicIllness  -----------------------------------------------------

if update(ChronicIllness)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ChronicIllness', Deleted.ChronicIllness, Inserted.ChronicIllness
	from Inserted inner join Deleted
	
	on Inserted.ChronicIllness <> Deleted.ChronicIllness
end

-------------------  DetailsOfIllness  -----------------------------------------------------

if update(DetailsOfIllness)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DetailsOfIllness', Deleted.DetailsOfIllness, Inserted.DetailsOfIllness
	from Inserted inner join Deleted
	
	on Inserted.DetailsOfIllness <> Deleted.DetailsOfIllness
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	
	on Inserted.LoginID <> Deleted.LoginID
end

go


------------------------------------------------------------------------------------------------------
-------------- Delete: Antenatal ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAntenatal')
	drop trigger utrDeleteAntenatal
go

create trigger utrDeleteAntenatal
on Antenatal
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Antenatal' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  Infection  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Infection', Deleted.Infection, null from Deleted

-------------------  InfectionDetails  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InfectionDetails', Deleted.InfectionDetails, null from Deleted

-------------------  AccidentDuringPregnancy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccidentDuringPregnancy', Deleted.AccidentDuringPregnancy, null from Deleted

-------------------  DetailsOfAccident  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DetailsOfAccident', Deleted.DetailsOfAccident, null from Deleted

-------------------  UseOfDrugsOrPrescription  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UseOfDrugsOrPrescription', Deleted.UseOfDrugsOrPrescription, null from Deleted

-------------------  DrugDetails  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DrugDetails', Deleted.DrugDetails, null from Deleted

-------------------  Smoking  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Smoking', Deleted.Smoking, null from Deleted

-------------------  ChronicIllness  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ChronicIllness', Deleted.ChronicIllness, null from Deleted

-------------------  DetailsOfIllness  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DetailsOfIllness', Deleted.DetailsOfIllness, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

go

------------------------------------------------------------------------------------------------------
-------------- Update: ChildGrowth ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateChildGrowth')
	drop trigger utrUpdateChildGrowth
go

create trigger utrUpdateChildGrowth
on ChildGrowth
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ChildGrowth' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  SocialSmile  -----------------------------------------------------

if update(SocialSmile)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SocialSmile', Deleted.SocialSmile, Inserted.SocialSmile
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.SocialSmile <> Deleted.SocialSmile
end

-------------------  HeadControl  -----------------------------------------------------

if update(HeadControl)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'HeadControl', Deleted.HeadControl, Inserted.HeadControl
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.HeadControl <> Deleted.HeadControl
end

-------------------  ReactionToSound  -----------------------------------------------------

if update(ReactionToSound)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReactionToSound', Deleted.ReactionToSound, Inserted.ReactionToSound
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReactionToSound <> Deleted.ReactionToSound
end

-------------------  GraspReflex  -----------------------------------------------------

if update(GraspReflex)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'GraspReflex', Deleted.GraspReflex, Inserted.GraspReflex
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.GraspReflex <> Deleted.GraspReflex
end

-------------------  Sitting  -----------------------------------------------------

if update(Sitting)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Sitting', Deleted.Sitting, Inserted.Sitting
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.Sitting <> Deleted.Sitting
end

-------------------  Standing  -----------------------------------------------------

if update(Standing)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Standing', Deleted.Standing, Inserted.Standing
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.Standing <> Deleted.Standing
end

-------------------  WeightForAge  -----------------------------------------------------

if update(WeightForAge)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'WeightForAge', Deleted.WeightForAge, Inserted.WeightForAge
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.WeightForAge <> Deleted.WeightForAge
end

-------------------  HeightForAge  -----------------------------------------------------

if update(HeightForAge)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'HeightForAge', Deleted.HeightForAge, Inserted.HeightForAge
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.HeightForAge <> Deleted.HeightForAge
end

-------------------  WeightForHeight  -----------------------------------------------------

if update(WeightForHeight)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'WeightForHeight', Deleted.WeightForHeight, Inserted.WeightForHeight
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.WeightForHeight <> Deleted.WeightForHeight
end

-------------------  BreastFeedingID  -----------------------------------------------------

if update(BreastFeedingID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'BreastFeedingID', Deleted.BreastFeedingID, Inserted.BreastFeedingID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.BreastFeedingID <> Deleted.BreastFeedingID
	
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.Notes <> Deleted.Notes
end


-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: ChildGrowth ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteChildGrowth')
	drop trigger utrDeleteChildGrowth
go

create trigger utrDeleteChildGrowth
on ChildGrowth
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ChildGrowth' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  SocialSmile  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SocialSmile', Deleted.SocialSmile, null from Deleted

-------------------  HeadControl  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeadControl', Deleted.HeadControl, null from Deleted

-------------------  ReactionToSound  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReactionToSound', Deleted.ReactionToSound, null from Deleted

-------------------  GraspReflex  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GraspReflex', Deleted.GraspReflex, null from Deleted

-------------------  Sitting  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Sitting', Deleted.Sitting, null from Deleted

-------------------  Standing  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Standing', Deleted.Standing, null from Deleted

-------------------  WeightForAge  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WeightForAge', Deleted.WeightForAge, null from Deleted

-------------------  HeightForAge  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeightForAge', Deleted.HeightForAge, null from Deleted

-------------------  WeightForHeight  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WeightForHeight', Deleted.WeightForHeight, null from Deleted

-------------------  BreastFeedingID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BreastFeedingID', Deleted.BreastFeedingID, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted


-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Perinatal ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePerinatal')
	drop trigger utrUpdatePerinatal
go

create trigger utrUpdatePerinatal
on Perinatal
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Perinatal' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	
	on Inserted.VisitNo <> Deleted.VisitNo
end

-------------------  ModeOfDelivery  -----------------------------------------------------

if update(ModeOfDelivery)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ModeOfDelivery', Deleted.ModeOfDelivery, Inserted.ModeOfDelivery
	from Inserted inner join Deleted
	
	on Inserted.ModeOfDelivery <> Deleted.ModeOfDelivery
end

-------------------  DurationOfLabour     -----------------------------------------------------

if update(DurationOfLabour   )
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DurationOfLabour   ', Deleted.DurationOfLabour   , Inserted.DurationOfLabour   
	from Inserted inner join Deleted
	
	on Inserted.DurationOfLabour    <> Deleted.DurationOfLabour   
end

-------------------  DeliveryComplications  -----------------------------------------------------

if update(DeliveryComplications)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DeliveryComplications', Deleted.DeliveryComplications, Inserted.DeliveryComplications
	from Inserted inner join Deleted
	
	on Inserted.DeliveryComplications <> Deleted.DeliveryComplications
end

-------------------  AmountOfBloodLoss  -----------------------------------------------------

if update(AmountOfBloodLoss)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AmountOfBloodLoss', Deleted.AmountOfBloodLoss, Inserted.AmountOfBloodLoss
	from Inserted inner join Deleted
	
	on Inserted.AmountOfBloodLoss <> Deleted.AmountOfBloodLoss
end

-------------------  MothersCondition  -----------------------------------------------------

if update(MothersCondition)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'MothersCondition', Deleted.MothersCondition, Inserted.MothersCondition
	from Inserted inner join Deleted
	
	on Inserted.MothersCondition <> Deleted.MothersCondition
end

-------------------  DetailsOfCondition  -----------------------------------------------------

if update(DetailsOfCondition)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DetailsOfCondition', Deleted.DetailsOfCondition, Inserted.DetailsOfCondition
	from Inserted inner join Deleted
	
	on Inserted.DetailsOfCondition <> Deleted.DetailsOfCondition
end

-------------------  BabyAlive  -----------------------------------------------------

if update(BabyAlive)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'BabyAlive', Deleted.BabyAlive, Inserted.BabyAlive
	from Inserted inner join Deleted
	
	on Inserted.BabyAlive <> Deleted.BabyAlive
end

-------------------  CauseOfDeath  -----------------------------------------------------

if update(CauseOfDeath)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CauseOfDeath', Deleted.CauseOfDeath, Inserted.CauseOfDeath
	from Inserted inner join Deleted
	
	on Inserted.CauseOfDeath <> Deleted.CauseOfDeath
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	
	on Inserted.LoginID <> Deleted.LoginID
end

go


------------------------------------------------------------------------------------------------------
-------------- Delete: Perinatal ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePerinatal')
	drop trigger utrDeletePerinatal
go

create trigger utrDeletePerinatal
on Perinatal
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Perinatal' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ModeOfDelivery  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ModeOfDelivery', Deleted.ModeOfDelivery, null from Deleted

-------------------  DurationOfLabour     -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DurationOfLabour   ', Deleted.DurationOfLabour   , null from Deleted

-------------------  DeliveryComplications  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DeliveryComplications', Deleted.DeliveryComplications, null from Deleted

-------------------  AmountOfBloodLoss  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountOfBloodLoss', Deleted.AmountOfBloodLoss, null from Deleted

-------------------  MothersCondition  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MothersCondition', Deleted.MothersCondition, null from Deleted

-------------------  DetailsOfCondition  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DetailsOfCondition', Deleted.DetailsOfCondition, null from Deleted

-------------------  BabyAlive  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BabyAlive', Deleted.BabyAlive, null from Deleted

-------------------  CauseOfDeath  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CauseOfDeath', Deleted.CauseOfDeath, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

go

--------------------------------------------------------------------------------------------------------
---------------- Update: Neonatal ----------------------------------------------------------
--------------------------------------------------------------------------------------------------------

--if exists (select * from sysobjects where name = 'utrUpdateNeonatal')
--	drop trigger utrUpdateNeonatal
--go

--create trigger utrUpdateNeonatal
--on Neonatal
--for update
--as
--declare @ErrorMSG varchar(200)
--declare @Identity int
--declare @ObjectName varchar(40)
--declare @FullDate smalldatetime

--if @@rowcount = 0 return

--------------------- Log Updates ----------------------------------------------

--if ident_current('AuditTrail') <>  @@identity return
--set @Identity = ident_current('AuditTrail')

--if @Identity is null return

--set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
--if @ObjectName is null return
--if @ObjectName <> 'Neonatal' return

--set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
--if @FullDate is null return
--if datediff(second, @FullDate, getdate()) > 60 return

---------------------  PatientNo  -----------------------------------------------------

--if update(PatientNo)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
--	from Inserted inner join Deleted
--	on Inserted.PatientNo <> Deleted.PatientNo
--end

---------------------  GestationalStage  -----------------------------------------------------

--if update(GestationalStage)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'GestationalStage', Deleted.GestationalStage, Inserted.GestationalStage
--	from Inserted inner join Deleted
--	on Inserted.GestationalStage <> Deleted.GestationalStage
--end

---------------------  Sex  -----------------------------------------------------

--if update(Sex)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'Sex', Deleted.Sex, Inserted.Sex
--	from Inserted inner join Deleted
--	on Inserted.Sex <> Deleted.Sex
--end

---------------------  BirthWeight  -----------------------------------------------------

--if update(BirthWeight)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'BirthWeight', Deleted.BirthWeight, Inserted.BirthWeight
--	from Inserted inner join Deleted
--	on Inserted.BirthWeight <> Deleted.BirthWeight
--end

---------------------  WeighedWithin72hrs  -----------------------------------------------------

--if update(WeighedWithin72hrs)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'WeighedWithin72hrs', Deleted.WeighedWithin72hrs, Inserted.WeighedWithin72hrs
--	from Inserted inner join Deleted
--	on Inserted.WeighedWithin72hrs <> Deleted.WeighedWithin72hrs
--end

---------------------  ConditionOnBirth  -----------------------------------------------------

--if update(ConditionOnBirth)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'ConditionOnBirth', Deleted.ConditionOnBirth, Inserted.ConditionOnBirth
--	from Inserted inner join Deleted
--	on Inserted.ConditionOnBirth <> Deleted.ConditionOnBirth
--end

---------------------  ConditionDetails  -----------------------------------------------------

--if update(ConditionDetails)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'ConditionDetails', Deleted.ConditionDetails, Inserted.ConditionDetails
--	from Inserted inner join Deleted
--	on Inserted.ConditionDetails <> Deleted.ConditionDetails
--end

---------------------  PhysicalAbnormalityDetails  -----------------------------------------------------

--if update(PhysicalAbnormalityDetails)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'PhysicalAbnormalityDetails', Deleted.PhysicalAbnormalityDetails, Inserted.PhysicalAbnormalityDetails
--	from Inserted inner join Deleted
--	on Inserted.PhysicalAbnormalityDetails <> Deleted.PhysicalAbnormalityDetails
--end

---------------------  UmblicalCordDetails  -----------------------------------------------------

--if update(UmblicalCordDetails)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'UmblicalCordDetails', Deleted.UmblicalCordDetails, Inserted.UmblicalCordDetails
--	from Inserted inner join Deleted
--	on Inserted.UmblicalCordDetails <> Deleted.UmblicalCordDetails
--end

---------------------  Jaundice  -----------------------------------------------------

--if update(Jaundice)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'Jaundice', Deleted.Jaundice, Inserted.Jaundice
--	from Inserted inner join Deleted
--	on Inserted.Jaundice <> Deleted.Jaundice
--end

---------------------  Bleeding  -----------------------------------------------------

--if update(Bleeding)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'Bleeding', Deleted.Bleeding, Inserted.Bleeding
--	from Inserted inner join Deleted
--	on Inserted.Bleeding <> Deleted.Bleeding
--end

---------------------  EarlyInfection  -----------------------------------------------------

--if update(EarlyInfection)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'EarlyInfection', Deleted.EarlyInfection, Inserted.EarlyInfection
--	from Inserted inner join Deleted
--	on Inserted.EarlyInfection <> Deleted.EarlyInfection
--end

---------------------  InfectionDetails  -----------------------------------------------------

--if update(InfectionDetails)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'InfectionDetails', Deleted.InfectionDetails, Inserted.InfectionDetails
--	from Inserted inner join Deleted
--	on Inserted.InfectionDetails <> Deleted.InfectionDetails
--end

---------------------  Convulsions  -----------------------------------------------------

--if update(Convulsions)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'Convulsions', Deleted.Convulsions, Inserted.Convulsions
--	from Inserted inner join Deleted
--	on Inserted.Convulsions <> Deleted.Convulsions
--end

---------------------  ConvulsionsDetails  -----------------------------------------------------

--if update(ConvulsionsDetails)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'ConvulsionsDetails', Deleted.ConvulsionsDetails, Inserted.ConvulsionsDetails
--	from Inserted inner join Deleted
--	on Inserted.ConvulsionsDetails <> Deleted.ConvulsionsDetails
--end

---------------------  EIDResults  -----------------------------------------------------

--if update(EIDResults)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'EIDResults', Deleted.EIDResults, Inserted.EIDResults
--	from Inserted inner join Deleted
--	on Inserted.EIDResults <> Deleted.EIDResults
--end

---------------------  ApgarScore  -----------------------------------------------------

--if update(ApgarScore)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'ApgarScore', Deleted.ApgarScore, Inserted.ApgarScore
--	from Inserted inner join Deleted
--	on Inserted.ApgarScore <> Deleted.ApgarScore
--end

---------------------  SleepingHabits  -----------------------------------------------------

--if update(SleepingHabits)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'SleepingHabits', Deleted.SleepingHabits, Inserted.SleepingHabits
--	from Inserted inner join Deleted
--	on Inserted.SleepingHabits <> Deleted.SleepingHabits
--end

---------------------  LoginID  -----------------------------------------------------

--if update(LoginID)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
--	from Inserted inner join Deleted
--	on Inserted.LoginID <> Deleted.LoginID
--end

---------------------  ClientMachine  -----------------------------------------------------

--if update(ClientMachine)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
--	from Inserted inner join Deleted
--	on Inserted.ClientMachine <> Deleted.ClientMachine
--end

---------------------  RecordDateTime  -----------------------------------------------------

--if update(RecordDateTime)
--begin
--	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
--	from Inserted inner join Deleted
--	on Inserted.RecordDateTime <> Deleted.RecordDateTime
--end
--go


--------------------------------------------------------------------------------------------------------
---------------- Delete: Neonatal ----------------------------------------------------------
--------------------------------------------------------------------------------------------------------

--if exists (select * from sysobjects where name = 'utrDeleteNeonatal')
--	drop trigger utrDeleteNeonatal
--go

--create trigger utrDeleteNeonatal
--on Neonatal
--for delete
--as
--declare @Identity int
--declare @ObjectName varchar(40)
--declare @FullDate smalldatetime

--if @@rowcount = 0 return

--------------------- Log Deletes ----------------------------------------------

--if ident_current('AuditTrail') <>  @@identity return
--set @Identity = ident_current('AuditTrail')

--if @Identity is null return

--set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
--if @ObjectName is null return
--if @ObjectName <> 'Neonatal' return

--set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
--if @FullDate is null return
--if datediff(second, @FullDate, getdate()) > 60 return

---------------------  PatientNo  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

---------------------  GestationalStage  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'GestationalStage', Deleted.GestationalStage, null from Deleted

---------------------  Sex  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'Sex', Deleted.Sex, null from Deleted

---------------------  BirthWeight  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'BirthWeight', Deleted.BirthWeight, null from Deleted

---------------------  WeighedWithin72hrs  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'WeighedWithin72hrs', Deleted.WeighedWithin72hrs, null from Deleted

---------------------  ConditionOnBirth  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'ConditionOnBirth', Deleted.ConditionOnBirth, null from Deleted

---------------------  ConditionDetails  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'ConditionDetails', Deleted.ConditionDetails, null from Deleted

---------------------  PhysicalAbnormalityDetails  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'PhysicalAbnormalityDetails', Deleted.PhysicalAbnormalityDetails, null from Deleted

---------------------  UmblicalCordDetails  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'UmblicalCordDetails', Deleted.UmblicalCordDetails, null from Deleted

---------------------  Jaundice  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'Jaundice', Deleted.Jaundice, null from Deleted

---------------------  Bleeding  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'Bleeding', Deleted.Bleeding, null from Deleted

---------------------  EarlyInfection  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'EarlyInfection', Deleted.EarlyInfection, null from Deleted

---------------------  InfectionDetails  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'InfectionDetails', Deleted.InfectionDetails, null from Deleted

---------------------  Convulsions  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'Convulsions', Deleted.Convulsions, null from Deleted

---------------------  ConvulsionsDetails  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'ConvulsionsDetails', Deleted.ConvulsionsDetails, null from Deleted

---------------------  EIDResults  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'EIDResults', Deleted.EIDResults, null from Deleted

---------------------  ApgarScore  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'ApgarScore', Deleted.ApgarScore, null from Deleted

---------------------  SleepingHabits  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'SleepingHabits', Deleted.SleepingHabits, null from Deleted

---------------------  LoginID  -----------------------------------------------------
--insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
--select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

--go

------------------------------------------------------------------------------------------------------
-------------- Update: ObstetricHistory ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateObstetricHistory')
	drop trigger utrUpdateObstetricHistory
go

create trigger utrUpdateObstetricHistory
on ObstetricHistory
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ObstetricHistory' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PatientNo  -----------------------------------------------------

if update(PatientNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
	from Inserted inner join Deleted
	
	on Inserted.PatientNo <> Deleted.PatientNo
end

-------------------  Gravidity  -----------------------------------------------------

if update(Gravidity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Gravidity', Deleted.Gravidity, Inserted.Gravidity
	from Inserted inner join Deleted
	
	on Inserted.Gravidity <> Deleted.Gravidity
end

-------------------  Parity  -----------------------------------------------------

if update(Parity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Parity', Deleted.Parity, Inserted.Parity
	from Inserted inner join Deleted
	
	on Inserted.Parity <> Deleted.Parity
end

-------------------  NoOfSurvivingChildren  -----------------------------------------------------

if update(NoOfSurvivingChildren)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'NoOfSurvivingChildren', Deleted.NoOfSurvivingChildren, Inserted.NoOfSurvivingChildren
	from Inserted inner join Deleted
	
	on Inserted.NoOfSurvivingChildren <> Deleted.NoOfSurvivingChildren
end

-------------------  LMP  -----------------------------------------------------

if update(LMP)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LMP', dbo.FormatDate(Deleted.LMP), dbo.FormatDate(Inserted.LMP)
	from Inserted inner join Deleted
	
	on Inserted.LMP <> Deleted.LMP
end

-------------------  EDD  -----------------------------------------------------

if update(EDD)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'EDD', dbo.FormatDate(Deleted.EDD), dbo.FormatDate(Inserted.EDD)
	from Inserted inner join Deleted
	
	on Inserted.EDD <> Deleted.EDD
end

-------------------  GestationalAgeInWks  -----------------------------------------------------

if update(GestationalAgeInWks)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'GestationalAgeInWks', Deleted.GestationalAgeInWks, Inserted.GestationalAgeInWks
	from Inserted inner join Deleted
	
	on Inserted.GestationalAgeInWks <> Deleted.GestationalAgeInWks
end

-------------------  StillBirth  -----------------------------------------------------

if update(StillBirth)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'StillBirth', Deleted.StillBirth, Inserted.StillBirth
	from Inserted inner join Deleted
	
	on Inserted.StillBirth <> Deleted.StillBirth
end

-------------------  NoOfStillBirths  -----------------------------------------------------

if update(NoOfStillBirths)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'NoOfStillBirths', Deleted.NoOfStillBirths, Inserted.NoOfStillBirths
	from Inserted inner join Deleted
	
	on Inserted.NoOfStillBirths <> Deleted.NoOfStillBirths
end

-------------------  Abortions  -----------------------------------------------------

if update(Abortions)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Abortions', Deleted.Abortions, Inserted.Abortions
	from Inserted inner join Deleted
	
	on Inserted.Abortions <> Deleted.Abortions
end

-------------------  NoOfAbortions  -----------------------------------------------------

if update(NoOfAbortions)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'NoOfAbortions', Deleted.NoOfAbortions, Inserted.NoOfAbortions
	from Inserted inner join Deleted
	
	on Inserted.NoOfAbortions <> Deleted.NoOfAbortions
end

-------------------  Caesarian  -----------------------------------------------------

if update(Caesarian)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Caesarian', Deleted.Caesarian, Inserted.Caesarian
	from Inserted inner join Deleted
	
	on Inserted.Caesarian <> Deleted.Caesarian
end

-------------------  NoOfCaesarians  -----------------------------------------------------

if update(NoOfCaesarians)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'NoOfCaesarians', Deleted.NoOfCaesarians, Inserted.NoOfCaesarians
	from Inserted inner join Deleted
	
	on Inserted.NoOfCaesarians <> Deleted.NoOfCaesarians
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	
	on Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	
	on Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	
	on Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: ObstetricHistory ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteObstetricHistory')
	drop trigger utrDeleteObstetricHistory
go

create trigger utrDeleteObstetricHistory
on ObstetricHistory
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ObstetricHistory' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  Gravidity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Gravidity', Deleted.Gravidity, null from Deleted

-------------------  Parity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Parity', Deleted.Parity, null from Deleted

-------------------  NoOfSurvivingChildren  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NoOfSurvivingChildren', Deleted.NoOfSurvivingChildren, null from Deleted

-------------------  LMP  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LMP', dbo.FormatDate(Deleted.LMP), null from Deleted

-------------------  EDD  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EDD', dbo.FormatDate(Deleted.EDD), null from Deleted

-------------------  GestationalAgeInWks  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GestationalAgeInWks', Deleted.GestationalAgeInWks, null from Deleted

-------------------  StillBirth  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StillBirth', Deleted.StillBirth, null from Deleted

-------------------  NoOfStillBirths  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NoOfStillBirths', Deleted.NoOfStillBirths, null from Deleted

-------------------  Abortions  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Abortions', Deleted.Abortions, null from Deleted

-------------------  NoOfAbortions  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NoOfAbortions', Deleted.NoOfAbortions, null from Deleted

-------------------  Caesarian  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Caesarian', Deleted.Caesarian, null from Deleted

-------------------  NoOfCaesarians  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NoOfCaesarians', Deleted.NoOfCaesarians, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

go

------------------------------------------------------------------------------------------------------
-------------- Update: IPDNurseAssessment ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDNurseAssessment')
	drop trigger utrUpdateIPDNurseAssessment
go

create trigger utrUpdateIPDNurseAssessment
on IPDNurseAssessment
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

----------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDNurseAssessment' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return




------------------- Key-RoundNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
end

-------------------  Complaint  -----------------------------------------------------

if update(Complaint)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Complaint', Deleted.Complaint, Inserted.Complaint
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.Complaint <> Deleted.Complaint
end

-------------------  Etiology  -----------------------------------------------------

if update(Etiology)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Etiology', Deleted.Etiology, Inserted.Etiology
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.Etiology <> Deleted.Etiology
end

-------------------  SignsAndSymptoms  -----------------------------------------------------

if update(SignsAndSymptoms)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SignsAndSymptoms', Deleted.SignsAndSymptoms, Inserted.SignsAndSymptoms
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.SignsAndSymptoms <> Deleted.SignsAndSymptoms
end

-------------------  ProposedSolution  -----------------------------------------------------

if update(ProposedSolution)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ProposedSolution', Deleted.ProposedSolution, Inserted.ProposedSolution
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ProposedSolution <> Deleted.ProposedSolution
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.LoginID <> Deleted.LoginID
end
go



------------------------------------------------------------------------------------------------------
-------------- Delete: IPDNurseAssessment ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDNurseAssessment')
	drop trigger utrDeleteIPDNurseAssessment
go

create trigger utrDeleteIPDNurseAssessment
on IPDNurseAssessment
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDNurseAssessment' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  Complaint  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Complaint', Deleted.Complaint, null from Deleted

-------------------  Etiology  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Etiology', Deleted.Etiology, null from Deleted

-------------------  SignsAndSymptoms  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SignsAndSymptoms', Deleted.SignsAndSymptoms, null from Deleted

-------------------  ProposedSolution  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProposedSolution', Deleted.ProposedSolution, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

go

------------------------------------------------------------------------------------------------------
-------------- Update: IPDNursingPlan ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDNursingPlan')
	drop trigger utrUpdateIPDNursingPlan
go

create trigger utrUpdateIPDNursingPlan
on IPDNursingPlan
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDNursingPlan' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RoundNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
end

-------------------  ExpectedOutcome  -----------------------------------------------------

if update(ExpectedOutcome)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ExpectedOutcome', Deleted.ExpectedOutcome, Inserted.ExpectedOutcome
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ExpectedOutcome <> Deleted.ExpectedOutcome
end

-------------------  NursingActions  -----------------------------------------------------

if update(NursingActions)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'NursingActions', Deleted.NursingActions, Inserted.NursingActions
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.NursingActions <> Deleted.NursingActions
end

-------------------  Implementation  -----------------------------------------------------

if update(Implementation)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Implementation', Deleted.Implementation, Inserted.Implementation
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.Implementation <> Deleted.Implementation
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: IPDNursingPlan ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDNursingPlan')
	drop trigger utrDeleteIPDNursingPlan
go

create trigger utrDeleteIPDNursingPlan
on IPDNursingPlan
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDNursingPlan' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  ExpectedOutcome  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExpectedOutcome', Deleted.ExpectedOutcome, null from Deleted

-------------------  NursingActions  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NursingActions', Deleted.NursingActions, null from Deleted

-------------------  Implementation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Implementation', Deleted.Implementation, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: IPDNurseEvaluation ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDNurseEvaluation')
	drop trigger utrUpdateIPDNurseEvaluation
go

create trigger utrUpdateIPDNurseEvaluation
on IPDNurseEvaluation
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDNurseEvaluation' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RoundNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RoundNo', Deleted.RoundNo, Inserted.RoundNo
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
end

-------------------  NursingCareEffective  -----------------------------------------------------

if update(NursingCareEffective)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'NursingCareEffective', Deleted.NursingCareEffective, Inserted.NursingCareEffective
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.NursingCareEffective <> Deleted.NursingCareEffective
end

-------------------  ProposedModifications  -----------------------------------------------------

if update(ProposedModifications)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ProposedModifications', Deleted.ProposedModifications, Inserted.ProposedModifications
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.ProposedModifications <> Deleted.ProposedModifications
end

-------------------  EvaluationNotes  -----------------------------------------------------

if update(EvaluationNotes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'EvaluationNotes', Deleted.EvaluationNotes, Inserted.EvaluationNotes
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.EvaluationNotes <> Deleted.EvaluationNotes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.RoundNo = Deleted.RoundNo
	and Inserted.LoginID <> Deleted.LoginID
end


go


------------------------------------------------------------------------------------------------------
-------------- Delete: IPDNurseEvaluation ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDNurseEvaluation')
	drop trigger utrDeleteIPDNurseEvaluation
go

create trigger utrDeleteIPDNurseEvaluation
on IPDNurseEvaluation
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDNurseEvaluation' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  RoundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RoundNo', Deleted.RoundNo, null from Deleted

-------------------  NursingCareEffective  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NursingCareEffective', Deleted.NursingCareEffective, null from Deleted

-------------------  ProposedModifications  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProposedModifications', Deleted.ProposedModifications, null from Deleted

-------------------  EvaluationNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EvaluationNotes', Deleted.EvaluationNotes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted


go



/*=================================================================25-12-2017================================================================= */
/*=================================================================25-12-2017================================================================= */



------------------------------------------------------------------------------------------------------
-------------- Update:ServiceInvoices ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateServiceInvoices')
drop trigger utrUpdateServiceInvoices
go

create trigger utrUpdateServiceInvoices
on ServiceInvoices
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

if update(ServiceInvoiceID)
begin
set @ErrorMSG = 'You can''t update Purchase Order ID for Orders, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

if update(ServiceInvoiceNo)
begin
set @ErrorMSG = 'You can''t update Purchase Order No for Orders, transaction cancelled'
raiserror(@ErrorMSG, 16, 10)
rollback tran
return
end

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PurchaseOrders' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ServiceInvoiceNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceInvoiceNo', Deleted.ServiceInvoiceNo, Inserted.ServiceInvoiceNo
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
end

-------------------  ServiceInvoiceID  -----------------------------------------------------

if update(ServiceInvoiceID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceInvoiceID', Deleted.ServiceInvoiceID, Inserted.ServiceInvoiceID
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ServiceInvoiceID <> Deleted.ServiceInvoiceID
end

-------------------  InvoiceDate  -----------------------------------------------------

if update(InvoiceDate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceDate', dbo.FormatDate(Deleted.InvoiceDate), dbo.FormatDate(Inserted.InvoiceDate)
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.InvoiceDate <> Deleted.InvoiceDate
end

-------------------  DocumentNo  -----------------------------------------------------

if update(DocumentNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, Inserted.DocumentNo
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.DocumentNo <> Deleted.DocumentNo
end

-------------------  SupplierNo  -----------------------------------------------------

if update(SupplierNo)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SupplierNo', Deleted.SupplierNo, Inserted.SupplierNo
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.SupplierNo <> Deleted.SupplierNo
end

-------------------  ShipAddress  -----------------------------------------------------

if update(ShipAddress)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ShipAddress', Deleted.ShipAddress, Inserted.ShipAddress
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ShipAddress <> Deleted.ShipAddress
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete:ServiceInvoices ----------------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteServiceInvoices')
drop trigger utrDeleteServiceInvoices
go

create trigger utrDeleteServiceInvoices
on ServiceInvoices
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PurchaseOrders' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ServiceInvoiceID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceInvoiceID', Deleted.ServiceInvoiceID, null from Deleted

-------------------  ServiceInvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceInvoiceNo', Deleted.ServiceInvoiceNo, null from Deleted

-------------------  InvoiceDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InvoiceDate', dbo.FormatDate(Deleted.InvoiceDate), null from Deleted

-------------------  DocumentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, null from Deleted

-------------------  SupplierNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SupplierNo', Deleted.SupplierNo, null from Deleted

-------------------  ShipAddress  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ShipAddress', Deleted.ShipAddress, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go






------------------------------------------------------------------------------------------------------
-------------- Update: ServiceInvoiceDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateServiceInvoiceDetails')
drop trigger utrUpdateServiceInvoiceDetails
go

create trigger utrUpdateServiceInvoiceDetails
on ServiceInvoiceDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ServiceInvoiceDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

------------------- Key-ServiceInvoiceNo -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceInvoiceNo', Deleted.ServiceInvoiceNo, Inserted.ServiceInvoiceNo
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCode -----------------------------------------------------

begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
end

-------------------  ItemName  -----------------------------------------------------

if update(ItemName)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemName <> Deleted.ItemName
end

-------------------  UnitMeasure  -----------------------------------------------------

if update(UnitMeasure)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, Inserted.UnitMeasure
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.UnitMeasure <> Deleted.UnitMeasure
end

-------------------  ItemGroup  -----------------------------------------------------

if update(ItemGroup)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemGroup', Deleted.ItemGroup, Inserted.ItemGroup
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ItemGroup <> Deleted.ItemGroup
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Quantity <> Deleted.Quantity
end

-------------------  Rate  -----------------------------------------------------

if update(Rate)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Rate', cast(Deleted.Rate as varchar(20)), cast(Inserted.Rate as varchar(20))
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Rate <> Deleted.Rate
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Amount <> Deleted.Amount
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.Notes <> Deleted.Notes
end

-------------------  PayStatusID  -----------------------------------------------------

if update(PayStatusID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayStatusID', Deleted.PayStatusID, Inserted.PayStatusID
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.PayStatusID <> Deleted.PayStatusID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
from Inserted inner join Deleted
on Inserted.ServiceInvoiceNo = Deleted.ServiceInvoiceNo
and Inserted.ItemCategoryID = Deleted.ItemCategoryID
and Inserted.ItemCode = Deleted.ItemCode
and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go

------------------------------------------------------------------------------------------------------
-------------- Delete: ServiceInvoiceDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteServiceInvoiceDetails')
drop trigger utrDeleteServiceInvoiceDetails
go

create trigger utrDeleteServiceInvoiceDetails
on ServiceInvoiceDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ServiceInvoiceDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ServiceInvoiceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ServiceInvoiceNo', Deleted.ServiceInvoiceNo, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  UnitMeasure  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitMeasure', Deleted.UnitMeasure, null from Deleted

-------------------  ItemGroup  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemGroup', Deleted.ItemGroup, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  Rate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Rate', cast(Deleted.Rate as varchar(20)), null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  PayStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayStatusID', Deleted.PayStatusID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


--------Function GetServiceInvoiceAmount ----------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetServiceInvoiceAmount')
drop function GetServiceInvoiceAmount
go

create function GetServiceInvoiceAmount(@ServiceInvoiceNo varchar(20)) returns money
with encryption as

begin

declare @ServiceInvoiceAmount money

--------------------------------------------------------------------------------------------------------------------------
set @ServiceInvoiceAmount = (select sum(Amount) from ServiceInvoiceDetails where ServiceInvoiceNo = @ServiceInvoiceNo) 
--------------------------------------------------------------------------------------------------------------------------

set @ServiceInvoiceAmount = isnull(@ServiceInvoiceAmount, 0.00)

return @ServiceInvoiceAmount

end

go

--SELECT * FROM ServiceInvoiceDetails
--------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetServiceInvoiceAmount('170001'))
--------------------------------------------------------------------------------------------------------------------------


-------------------------GetTotalProvided----------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'GetTotalProvided')
drop function GetTotalProvided
go

create function GetTotalProvided (@ServiceInvoiceNo varchar(10),@ItemCategoryID varchar(10), @ItemCode varchar(20)) returns int
with encryption as

begin

declare @TotalOrder int

set @TotalOrder=(select (Quantity*PackSize) from ServiceInvoiceDetails 
where ServiceInvoiceNo=@ServiceInvoiceNo and ItemCategoryID=@ItemCategoryID and ItemCode=@ItemCode)
set @TotalOrder= isnull(@TotalOrder,0)
return @TotalOrder

end

go

--SELECT * FROM ServiceInvoiceDetails
--------------------------------------------------------------------------------------------------------------------------
-- print dbo.FormatMoney(dbo.GetTotalProvided('170001', '7NM', 'A006'))
--------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------
-------------- Update: PaymentVoucherDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePaymentVoucherDetails')
	drop trigger utrUpdatePaymentVoucherDetails
go

create trigger utrUpdatePaymentVoucherDetails
on PaymentVoucherDetails
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PaymentVoucherDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VoucherNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VoucherNo', Deleted.VoucherNo, Inserted.VoucherNo
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.BillNo = Deleted.BillNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-BillNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'BillNo', Deleted.BillNo, Inserted.BillNo
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.BillNo = Deleted.BillNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.BillNo = Deleted.BillNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.BillNo = Deleted.BillNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.BillNo = Deleted.BillNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Quantity <> Deleted.Quantity
end

-------------------  UnitPrice  -----------------------------------------------------

if update(UnitPrice)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), cast(Inserted.UnitPrice as varchar(20))
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.BillNo = Deleted.BillNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.UnitPrice <> Deleted.UnitPrice
end

-------------------  Discount  -----------------------------------------------------

if update(Discount)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Discount', cast(Deleted.Discount as varchar(20)), cast(Inserted.Discount as varchar(20))
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.BillNo = Deleted.BillNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Discount <> Deleted.Discount
end

-------------------  Amount  -----------------------------------------------------

if update(Amount)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), cast(Inserted.Amount as varchar(20))
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.BillNo = Deleted.BillNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Amount <> Deleted.Amount
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.BillNo = Deleted.BillNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.BillNo = Deleted.BillNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.BillNo = Deleted.BillNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PaymentVoucherDetails ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePaymentVoucherDetails')
	drop trigger utrDeletePaymentVoucherDetails
go

create trigger utrDeletePaymentVoucherDetails
on PaymentVoucherDetails
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PaymentVoucherDetails' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VoucherNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VoucherNo', Deleted.VoucherNo, null from Deleted

-------------------  BillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillNo', Deleted.BillNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  UnitPrice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UnitPrice', cast(Deleted.UnitPrice as varchar(20)), null from Deleted

-------------------  Discount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Discount', cast(Deleted.Discount as varchar(20)), null from Deleted

-------------------  Amount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Amount', cast(Deleted.Amount as varchar(20)), null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: PaymentVouchers ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePaymentVouchers')
	drop trigger utrUpdatePaymentVouchers
go

create trigger utrUpdatePaymentVouchers
on PaymentVouchers
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PaymentVouchers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VoucherNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VoucherNo', Deleted.VoucherNo, Inserted.VoucherNo
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
end

-------------------  VoucherID  -----------------------------------------------------

if update(VoucherID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VoucherID', Deleted.VoucherID, Inserted.VoucherID
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.VoucherID <> Deleted.VoucherID
end

-------------------  PayTypeID  -----------------------------------------------------

if update(PayTypeID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PayTypeID', Deleted.PayTypeID, Inserted.PayTypeID
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.PayTypeID <> Deleted.PayTypeID
end

-------------------  BillNo  -----------------------------------------------------

if update(BillNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'BillNo', Deleted.BillNo, Inserted.BillNo
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.BillNo <> Deleted.BillNo
end


-------------------  PayNo  -----------------------------------------------------

if update(PayNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PayNo', Deleted.PayNo, Inserted.PayNo
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.PayNo <> Deleted.PayNo
end

-------------------  PayDate  -----------------------------------------------------

if update(PayDate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PayDate', dbo.FormatDate(Deleted.PayDate), dbo.FormatDate(Inserted.PayDate)
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.PayDate <> Deleted.PayDate
end

-------------------  PayModesID  -----------------------------------------------------

if update(PayModesID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PayModesID', Deleted.PayModesID, Inserted.PayModesID
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.PayModesID <> Deleted.PayModesID
end

-------------------  DocumentNo  -----------------------------------------------------

if update(DocumentNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DocumentNo', Deleted.DocumentNo, Inserted.DocumentNo
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.DocumentNo <> Deleted.DocumentNo
end

-------------------  AmountWords  -----------------------------------------------------

if update(AmountWords)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AmountWords', Deleted.AmountWords, Inserted.AmountWords
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.AmountWords <> Deleted.AmountWords
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.Notes <> Deleted.Notes
end

-------------------  CurrenciesID  -----------------------------------------------------

if update(CurrenciesID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CurrenciesID', Deleted.CurrenciesID, Inserted.CurrenciesID
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.CurrenciesID <> Deleted.CurrenciesID
end

-------------------  AmountTendered  -----------------------------------------------------

if update(AmountTendered)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AmountTendered', cast(Deleted.AmountTendered as varchar(20)), cast(Inserted.AmountTendered as varchar(20))
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.AmountTendered <> Deleted.AmountTendered
end

-------------------  ExchangeRate  -----------------------------------------------------

if update(ExchangeRate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ExchangeRate', cast(Deleted.ExchangeRate as varchar(20)), cast(Inserted.ExchangeRate as varchar(20))
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.ExchangeRate <> Deleted.ExchangeRate
end

-------------------  Change  -----------------------------------------------------

if update(Change)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Change', cast(Deleted.Change as varchar(20)), cast(Inserted.Change as varchar(20))
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.Change <> Deleted.Change
end

-------------------  SendBalanceToAccount  -----------------------------------------------------

if update(SendBalanceToAccount)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SendBalanceToAccount', Deleted.SendBalanceToAccount, Inserted.SendBalanceToAccount
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.SendBalanceToAccount <> Deleted.SendBalanceToAccount
end

-------------------  UseAccountBalance  -----------------------------------------------------

if update(UseAccountBalance)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'UseAccountBalance', Deleted.UseAccountBalance, Inserted.UseAccountBalance
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.UseAccountBalance <> Deleted.UseAccountBalance
end

-------------------  VoucherTypeID  -----------------------------------------------------

if update(VoucherTypeID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VoucherTypeID', Deleted.VoucherTypeID, Inserted.VoucherTypeID
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.VoucherTypeID <> Deleted.VoucherTypeID
end

-------------------  FilterNo  -----------------------------------------------------

if update(FilterNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'FilterNo', Deleted.FilterNo, Inserted.FilterNo
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.FilterNo <> Deleted.FilterNo
end

-------------------  Payee  -----------------------------------------------------

if update(Payee)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Payee', Deleted.Payee, Inserted.Payee
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.Payee <> Deleted.Payee
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.VoucherNo = Deleted.VoucherNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PaymentVouchers ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePaymentVouchers')
	drop trigger utrDeletePaymentVouchers
go

create trigger utrDeletePaymentVouchers
on PaymentVouchers
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PaymentVouchers' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VoucherID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VoucherID', Deleted.VoucherID, null from Deleted

-------------------  VoucherNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VoucherNo', Deleted.VoucherNo, null from Deleted

-------------------  PayTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayTypeID', Deleted.PayTypeID, null from Deleted

-------------------  BillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BillNo', Deleted.BillNo, null from Deleted

-------------------  PayDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayDate', dbo.FormatDate(Deleted.PayDate), null from Deleted

-------------------  PayModesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayModesID', Deleted.PayModesID, null from Deleted

-------------------  DocumentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DocumentNo', Deleted.DocumentNo, null from Deleted

-------------------  AmountWords  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountWords', Deleted.AmountWords, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  CurrenciesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CurrenciesID', Deleted.CurrenciesID, null from Deleted

-------------------  AmountTendered  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AmountTendered', cast(Deleted.AmountTendered as varchar(20)), null from Deleted

-------------------  ExchangeRate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExchangeRate', cast(Deleted.ExchangeRate as varchar(20)), null from Deleted

-------------------  Change  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Change', cast(Deleted.Change as varchar(20)), null from Deleted

-------------------  PayNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PayNo', cast(Deleted.PayNo as varchar(20)), null from Deleted

-------------------  SendBalanceToAccount  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SendBalanceToAccount', Deleted.SendBalanceToAccount, null from Deleted

-------------------  UseAccountBalance  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UseAccountBalance', Deleted.UseAccountBalance, null from Deleted

-------------------  VoucherTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VoucherTypeID', Deleted.VoucherTypeID, null from Deleted

-------------------  FilterNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FilterNo', Deleted.FilterNo, null from Deleted

-------------------  Payee  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Payee', Deleted.Payee, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

-----------------------------------01 Feb 2018-------------------------------------
------------------------------------------------------------------------------------------------------
-------------- Update: PostNatal ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePostNatal')
	drop trigger utrUpdatePostNatal
go

create trigger utrUpdatePostNatal
on PostNatal
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PostNatal' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PatientNo  -----------------------------------------------------

if update(PatientNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.PatientNo <> Deleted.PatientNo
end

-------------------  DeliveryComplications  -----------------------------------------------------

if update(DeliveryComplications)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DeliveryComplications', Deleted.DeliveryComplications, Inserted.DeliveryComplications
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.DeliveryComplications <> Deleted.DeliveryComplications
end

-------------------  ConditionOnBirth  -----------------------------------------------------

if update(ConditionOnBirth)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ConditionOnBirth', Deleted.ConditionOnBirth, Inserted.ConditionOnBirth
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ConditionOnBirth <> Deleted.ConditionOnBirth
end

-------------------  ConditionDetails  -----------------------------------------------------

if update(ConditionDetails)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ConditionDetails', Deleted.ConditionDetails, Inserted.ConditionDetails
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ConditionDetails <> Deleted.ConditionDetails
end

-------------------  PhysicalAbnormalityDetails  -----------------------------------------------------

if update(PhysicalAbnormalityDetails)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PhysicalAbnormalityDetails', Deleted.PhysicalAbnormalityDetails, Inserted.PhysicalAbnormalityDetails
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.PhysicalAbnormalityDetails <> Deleted.PhysicalAbnormalityDetails
end

-------------------  UmblicalCordDetails  -----------------------------------------------------

if update(UmblicalCordDetails)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'UmblicalCordDetails', Deleted.UmblicalCordDetails, Inserted.UmblicalCordDetails
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.UmblicalCordDetails <> Deleted.UmblicalCordDetails
end

-------------------  Jaundice  -----------------------------------------------------

if update(Jaundice)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Jaundice', Deleted.Jaundice, Inserted.Jaundice
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.Jaundice <> Deleted.Jaundice
end

-------------------  EarlyInfection  -----------------------------------------------------

if update(EarlyInfection)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'EarlyInfection', Deleted.EarlyInfection, Inserted.EarlyInfection
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.EarlyInfection <> Deleted.EarlyInfection
end

-------------------  InfectionDetails  -----------------------------------------------------

if update(InfectionDetails)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'InfectionDetails', Deleted.InfectionDetails, Inserted.InfectionDetails
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.InfectionDetails <> Deleted.InfectionDetails
end

-------------------  Convulsions  -----------------------------------------------------

if update(Convulsions)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Convulsions', Deleted.Convulsions, Inserted.Convulsions
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.Convulsions <> Deleted.Convulsions
end

-------------------  ConvulsionsDetails  -----------------------------------------------------

if update(ConvulsionsDetails)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ConvulsionsDetails', Deleted.ConvulsionsDetails, Inserted.ConvulsionsDetails
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ConvulsionsDetails <> Deleted.ConvulsionsDetails
end

-------------------  EIDResults  -----------------------------------------------------

if update(EIDResults)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'EIDResults', Deleted.EIDResults, Inserted.EIDResults
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.EIDResults <> Deleted.EIDResults
end

-------------------  ApgarScore  -----------------------------------------------------

if update(ApgarScore)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ApgarScore', Deleted.ApgarScore, Inserted.ApgarScore
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ApgarScore <> Deleted.ApgarScore
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PostNatal ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePostNatal')
	drop trigger utrDeletePostNatal
go

create trigger utrDeletePostNatal
on PostNatal
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PostNatal' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  DeliveryComplications  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DeliveryComplications', Deleted.DeliveryComplications, null from Deleted

-------------------  ConditionOnBirth  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConditionOnBirth', Deleted.ConditionOnBirth, null from Deleted

-------------------  ConditionDetails  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConditionDetails', Deleted.ConditionDetails, null from Deleted

-------------------  PhysicalAbnormalityDetails  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhysicalAbnormalityDetails', Deleted.PhysicalAbnormalityDetails, null from Deleted

-------------------  UmblicalCordDetails  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UmblicalCordDetails', Deleted.UmblicalCordDetails, null from Deleted

-------------------  Jaundice  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Jaundice', Deleted.Jaundice, null from Deleted

-------------------  EarlyInfection  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EarlyInfection', Deleted.EarlyInfection, null from Deleted

-------------------  InfectionDetails  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InfectionDetails', Deleted.InfectionDetails, null from Deleted

-------------------  Convulsions  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Convulsions', Deleted.Convulsions, null from Deleted

-------------------  ConvulsionsDetails  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConvulsionsDetails', Deleted.ConvulsionsDetails, null from Deleted

-------------------  EIDResults  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EIDResults', Deleted.EIDResults, null from Deleted

-------------------  ApgarScore  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ApgarScore', Deleted.ApgarScore, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: PhysioDiseases ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePhysioDiseases')
	drop trigger utrUpdatePhysioDiseases
go

create trigger utrUpdatePhysioDiseases
on PhysioDiseases
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PhysioDiseases' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-PhysioDiseaseNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PhysioDiseaseNo', Deleted.PhysioDiseaseNo, Inserted.PhysioDiseaseNo
	from Inserted inner join Deleted
	on Inserted.PhysioDiseaseNo = Deleted.PhysioDiseaseNo
end

-------------------  DiseaseID  -----------------------------------------------------

if update(DiseaseID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DiseaseID', Deleted.DiseaseID, Inserted.DiseaseID
	from Inserted inner join Deleted
	on Inserted.PhysioDiseaseNo = Deleted.PhysioDiseaseNo
	and Inserted.DiseaseID <> Deleted.DiseaseID
end

-------------------  DiseaseCode  -----------------------------------------------------

if update(DiseaseCode)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DiseaseCode', Deleted.DiseaseCode, Inserted.DiseaseCode
	from Inserted inner join Deleted
	on Inserted.PhysioDiseaseNo = Deleted.PhysioDiseaseNo
	and Inserted.DiseaseCode <> Deleted.DiseaseCode
end

-------------------  DiseaseName  -----------------------------------------------------

if update(DiseaseName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DiseaseName', Deleted.DiseaseName, Inserted.DiseaseName
	from Inserted inner join Deleted
	on Inserted.PhysioDiseaseNo = Deleted.PhysioDiseaseNo
	and Inserted.DiseaseName <> Deleted.DiseaseName
end

-------------------  PhysioDiseaseCategoriesID  -----------------------------------------------------

if update(PhysioDiseaseCategoriesID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PhysioDiseaseCategoriesID', Deleted.PhysioDiseaseCategoriesID, Inserted.PhysioDiseaseCategoriesID
	from Inserted inner join Deleted
	on Inserted.PhysioDiseaseNo = Deleted.PhysioDiseaseNo
	and Inserted.PhysioDiseaseCategoriesID <> Deleted.PhysioDiseaseCategoriesID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.PhysioDiseaseNo = Deleted.PhysioDiseaseNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.PhysioDiseaseNo = Deleted.PhysioDiseaseNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.PhysioDiseaseNo = Deleted.PhysioDiseaseNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PhysioDiseases ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePhysioDiseases')
	drop trigger utrDeletePhysioDiseases
go

create trigger utrDeletePhysioDiseases
on PhysioDiseases
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PhysioDiseases' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  DiseaseID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseID', Deleted.DiseaseID, null from Deleted

-------------------  PhysioDiseaseNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhysioDiseaseNo', Deleted.PhysioDiseaseNo, null from Deleted

-------------------  DiseaseCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseCode', Deleted.DiseaseCode, null from Deleted

-------------------  DiseaseName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiseaseName', Deleted.DiseaseName, null from Deleted

-------------------  PhysioDiseaseCategoriesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhysioDiseaseCategoriesID', Deleted.PhysioDiseaseCategoriesID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



------------------------------------------------------------------------------------------------------
-------------- Update: PhysioDiagnosis ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePhysioDiagnosis')
	drop trigger utrUpdatePhysioDiagnosis
go

create trigger utrUpdatePhysioDiagnosis
on PhysioDiagnosis
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PhysioDiagnosis' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	
	on Inserted.VisitNo <> Deleted.VisitNo
end

-------------------  PhysioDiseaseNo  -----------------------------------------------------

if update(PhysioDiseaseNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PhysioDiseaseNo', Deleted.PhysioDiseaseNo, Inserted.PhysioDiseaseNo
	from Inserted inner join Deleted
	
	on Inserted.PhysioDiseaseNo <> Deleted.PhysioDiseaseNo
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
	from Inserted inner join Deleted
	
	on Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	
	on Inserted.LoginID <> Deleted.LoginID
end

go


------------------------------------------------------------------------------------------------------
-------------- Delete: PhysioDiagnosis ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePhysioDiagnosis')
	drop trigger utrDeletePhysioDiagnosis
go

create trigger utrDeletePhysioDiagnosis
on PhysioDiagnosis
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PhysioDiagnosis' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  PhysioDiseaseNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhysioDiseaseNo', Deleted.PhysioDiseaseNo, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

go




------------------------------------------------------------------------------------------------------
-------------- Update: Physiotherapy ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePhysiotherapy')
	drop trigger utrUpdatePhysiotherapy
go

create trigger utrUpdatePhysiotherapy
on Physiotherapy
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Physiotherapy' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
end


-------------------  OnMedication  -----------------------------------------------------

if update(OnMedication)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'OnMedication', Deleted.OnMedication, Inserted.OnMedication
	from Inserted inner join Deleted
	on Inserted.OnMedication <> Deleted.OnMedication
end

-------------------  Medication  -----------------------------------------------------

if update(Medication)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Medication', Deleted.Medication, Inserted.Medication
	from Inserted inner join Deleted
	on Inserted.Medication <> Deleted.Medication
end


-------------------  Pain24hoursOrVAS  -----------------------------------------------------

if update(Pain24hoursOrVAS)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Pain24hoursOrVAS', Deleted.Pain24hoursOrVAS, Inserted.Pain24hoursOrVAS
	from Inserted inner join Deleted
	
	on Inserted.Pain24hoursOrVAS <> Deleted.Pain24hoursOrVAS
end


-------------------  LevelOfDependenceOrADLS  -----------------------------------------------------

if update(LevelOfDependenceOrADLS)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LevelOfDependenceOrADLS', Deleted.LevelOfDependenceOrADLS, Inserted.LevelOfDependenceOrADLS
	from Inserted inner join Deleted
	on Inserted.LevelOfDependenceOrADLS <> Deleted.LevelOfDependenceOrADLS
end


-------------------  MuscleStatus  -----------------------------------------------------

if update(MuscleStatus)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'MuscleStatus', Deleted.MuscleStatus, Inserted.MuscleStatus
	from Inserted inner join Deleted
	on Inserted.MuscleStatus <> Deleted.MuscleStatus
end

-------------------  StatusOfJoints  -----------------------------------------------------

if update(StatusOfJoints)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'StatusOfJoints', Deleted.StatusOfJoints, Inserted.StatusOfJoints
	from Inserted inner join Deleted
	on Inserted.StatusOfJoints <> Deleted.StatusOfJoints
end

-------------------  Sensitivity  -----------------------------------------------------

if update(Sensitivity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Sensitivity', Deleted.Sensitivity, Inserted.Sensitivity
	from Inserted inner join Deleted
	on Inserted.Sensitivity <> Deleted.Sensitivity
end

-------------------  WalkingAnalysis  -----------------------------------------------------

if update(WalkingAnalysis)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'WalkingAnalysis', Deleted.WalkingAnalysis, Inserted.WalkingAnalysis
	from Inserted inner join Deleted
	on Inserted.WalkingAnalysis <> Deleted.WalkingAnalysis
end

-------------------  ShortTermTreatmentTargets  -----------------------------------------------------

if update(ShortTermTreatmentTargets)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ShortTermTreatmentTargets', Deleted.ShortTermTreatmentTargets, Inserted.ShortTermTreatmentTargets
	from Inserted inner join Deleted
	on Inserted.ShortTermTreatmentTargets <> Deleted.ShortTermTreatmentTargets
end

-------------------  LongTermTreatmentTargets  -----------------------------------------------------

if update(LongTermTreatmentTargets)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LongTermTreatmentTargets', Deleted.LongTermTreatmentTargets, Inserted.LongTermTreatmentTargets
	from Inserted inner join Deleted
	on Inserted.LongTermTreatmentTargets <> Deleted.LongTermTreatmentTargets
end

-------------------  ProvisionalDiagnosis  -----------------------------------------------------

if update(ProvisionalDiagnosis)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ProvisionalDiagnosis', Deleted.ProvisionalDiagnosis, Inserted.ProvisionalDiagnosis
	from Inserted inner join Deleted
	on Inserted.ProvisionalDiagnosis <> Deleted.ProvisionalDiagnosis
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.LoginID <> Deleted.LoginID
end

go
------------------------------------------------------------------------------------------------------
-------------- Delete: Physiotherapy ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePhysiotherapy')
	drop trigger utrDeletePhysiotherapy
go

create trigger utrDeletePhysiotherapy
on Physiotherapy
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Physiotherapy' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  OnMedication  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OnMedication', Deleted.OnMedication, null from Deleted

-------------------  Medication  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Medication', Deleted.Medication, null from Deleted

-------------------  Pain24hoursOrVAS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pain24hoursOrVAS', Deleted.Pain24hoursOrVAS, null from Deleted

-------------------  LevelOfDependenceOrADLS  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LevelOfDependenceOrADLS', Deleted.LevelOfDependenceOrADLS, null from Deleted

-------------------  MuscleStatus  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MuscleStatus', Deleted.MuscleStatus, null from Deleted

-------------------  StatusOfJoints  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StatusOfJoints', Deleted.StatusOfJoints, null from Deleted

-------------------  Sensitivity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Sensitivity', Deleted.Sensitivity, null from Deleted

-------------------  WalkingAnalysis  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WalkingAnalysis', Deleted.WalkingAnalysis, null from Deleted

-------------------  ShortTermTreatmentTargets  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ShortTermTreatmentTargets', Deleted.ShortTermTreatmentTargets, null from Deleted

-------------------  LongTermTreatmentTargets  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LongTermTreatmentTargets', Deleted.LongTermTreatmentTargets, null from Deleted

------------------  ProvisionalDiagnosis  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ProvisionalDiagnosis', Deleted.ProvisionalDiagnosis, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

go


------------------------------------------------------------------------------------------------------
-------------- Update: Clients ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateClients')
	drop trigger utrUpdateClients
go

create trigger utrUpdateClients
on Clients
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Clients' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-ReferenceNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReferenceNo', Deleted.ReferenceNo, Inserted.ReferenceNo
	from Inserted inner join Deleted
	on Inserted.ReferenceNo = Deleted.ReferenceNo
end

-------------------  ReferenceID  -----------------------------------------------------

if update(ReferenceID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReferenceID', Deleted.ReferenceID, Inserted.ReferenceID
	from Inserted inner join Deleted
	on Inserted.ReferenceNo = Deleted.ReferenceNo
	and Inserted.ReferenceID <> Deleted.ReferenceID
end

-------------------  FirstName  -----------------------------------------------------

if update(FirstName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'FirstName', Deleted.FirstName, Inserted.FirstName
	from Inserted inner join Deleted
	on Inserted.ReferenceNo = Deleted.ReferenceNo
	and Inserted.FirstName <> Deleted.FirstName
end

-------------------  LastName  -----------------------------------------------------

if update(LastName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LastName', Deleted.LastName, Inserted.LastName
	from Inserted inner join Deleted
	on Inserted.ReferenceNo = Deleted.ReferenceNo
	and Inserted.LastName <> Deleted.LastName
end

-------------------  MiddleName  -----------------------------------------------------

if update(MiddleName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'MiddleName', Deleted.MiddleName, Inserted.MiddleName
	from Inserted inner join Deleted
	on Inserted.ReferenceNo = Deleted.ReferenceNo
	and Inserted.MiddleName <> Deleted.MiddleName
end

-------------------  GenderID  -----------------------------------------------------

if update(GenderID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'GenderID', Deleted.GenderID, Inserted.GenderID
	from Inserted inner join Deleted
	on Inserted.ReferenceNo = Deleted.ReferenceNo
	and Inserted.GenderID <> Deleted.GenderID
end

-------------------  PhoneNo  -----------------------------------------------------

if update(PhoneNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PhoneNo', Deleted.PhoneNo, Inserted.PhoneNo
	from Inserted inner join Deleted
	on Inserted.ReferenceNo = Deleted.ReferenceNo
	and Inserted.PhoneNo <> Deleted.PhoneNo
end

-------------------  DoctorSpecialtyID  -----------------------------------------------------

if update(DoctorSpecialtyID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, Inserted.DoctorSpecialtyID
	from Inserted inner join Deleted
	on Inserted.ReferenceNo = Deleted.ReferenceNo
	and Inserted.DoctorSpecialtyID <> Deleted.DoctorSpecialtyID
end

-------------------  StaffNo  -----------------------------------------------------

if update(StaffNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'StaffNo', Deleted.StaffNo, Inserted.StaffNo
	from Inserted inner join Deleted
	on Inserted.ReferenceNo = Deleted.ReferenceNo
	and Inserted.StaffNo <> Deleted.StaffNo
end

-------------------  Description  -----------------------------------------------------

if update(Description)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Description', Deleted.Description, Inserted.Description
	from Inserted inner join Deleted
	on Inserted.ReferenceNo = Deleted.ReferenceNo
	and Inserted.Description <> Deleted.Description
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.ReferenceNo = Deleted.ReferenceNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.ReferenceNo = Deleted.ReferenceNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.ReferenceNo = Deleted.ReferenceNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: Clients ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteClients')
	drop trigger utrDeleteClients
go

create trigger utrDeleteClients
on Clients
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Clients' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ReferenceID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferenceID', Deleted.ReferenceID, null from Deleted

-------------------  ReferenceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferenceNo', Deleted.ReferenceNo, null from Deleted

-------------------  FirstName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FirstName', Deleted.FirstName, null from Deleted

-------------------  LastName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LastName', Deleted.LastName, null from Deleted

-------------------  MiddleName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MiddleName', Deleted.MiddleName, null from Deleted

-------------------  GenderID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GenderID', Deleted.GenderID, null from Deleted

-------------------  PhoneNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhoneNo', Deleted.PhoneNo, null from Deleted

-------------------  DoctorSpecialtyID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialtyID', Deleted.DoctorSpecialtyID, null from Deleted

-------------------  StaffNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StaffNo', Deleted.StaffNo, null from Deleted

-------------------  Description  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Description', Deleted.Description, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: MappedCodesFinance ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateMappedCodesFinance')
	drop trigger utrUpdateMappedCodesFinance
go

create trigger utrUpdateMappedCodesFinance
on MappedCodesFinance
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'MappedCodesFinance' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.AccountTypeID = Deleted.AccountTypeID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.AccountTypeID = Deleted.AccountTypeID
end

------------------- Key-AccountTypeID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AccountTypeID', Deleted.AccountTypeID, Inserted.AccountTypeID
	from Inserted inner join Deleted
	on Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.AccountTypeID = Deleted.AccountTypeID
end

-------------------  ItemName  -----------------------------------------------------

if update(ItemName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemName', Deleted.ItemName, Inserted.ItemName
	from Inserted inner join Deleted
	on Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.AccountTypeID = Deleted.AccountTypeID
	and Inserted.ItemName <> Deleted.ItemName
end

-------------------  AccountNo  -----------------------------------------------------

if update(AccountNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AccountNo', Deleted.AccountNo, Inserted.AccountNo
	from Inserted inner join Deleted
	on Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.AccountTypeID = Deleted.AccountTypeID
	and Inserted.AccountNo <> Deleted.AccountNo
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.AccountTypeID = Deleted.AccountTypeID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  Username  -----------------------------------------------------

if update(Username)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Username', Deleted.Username, Inserted.Username
	from Inserted inner join Deleted
	on Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.AccountTypeID = Deleted.AccountTypeID
	and Inserted.Username <> Deleted.Username
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.AccountTypeID = Deleted.AccountTypeID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.AccountTypeID = Deleted.AccountTypeID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: MappedCodesFinance ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteMappedCodesFinance')
	drop trigger utrDeleteMappedCodesFinance
go

create trigger utrDeleteMappedCodesFinance
on MappedCodesFinance
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'MappedCodesFinance' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  AccountTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountTypeID', Deleted.AccountTypeID, null from Deleted

-------------------  ItemName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemName', Deleted.ItemName, null from Deleted

-------------------  AccountNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AccountNo', Deleted.AccountNo, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  Username  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Username', Deleted.Username, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: OccupationalTherapy ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateOccupationalTherapy')
	drop trigger utrUpdateOccupationalTherapy
go

create trigger utrUpdateOccupationalTherapy
on OccupationalTherapy
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'OccupationalTherapy' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
end


-------------------  WalkingID  -----------------------------------------------------

if update(WalkingID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'WalkingID', Deleted.WalkingID, Inserted.WalkingID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.WalkingID <> Deleted.WalkingID
end

-------------------  SitStandTransfersID  -----------------------------------------------------

if update(SitStandTransfersID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SitStandTransfersID', Deleted.SitStandTransfersID, Inserted.SitStandTransfersID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.SitStandTransfersID <> Deleted.SitStandTransfersID
end

-------------------  BathingID  -----------------------------------------------------

if update(BathingID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'BathingID', Deleted.BathingID, Inserted.BathingID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.BathingID <> Deleted.BathingID
end

-------------------  ToiletingID  -----------------------------------------------------

if update(ToiletingID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ToiletingID', Deleted.ToiletingID, Inserted.ToiletingID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ToiletingID <> Deleted.ToiletingID
end

-------------------  DressingID  -----------------------------------------------------

if update(DressingID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DressingID', Deleted.DressingID, Inserted.DressingID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.DressingID <> Deleted.DressingID
end

-------------------  HandFunctionID  -----------------------------------------------------

if update(HandFunctionID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'HandFunctionID', Deleted.HandFunctionID, Inserted.HandFunctionID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.HandFunctionID <> Deleted.HandFunctionID
end

-------------------  WashingID  -----------------------------------------------------

if update(WashingID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'WashingID', Deleted.WashingID, Inserted.WashingID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.WashingID <> Deleted.WashingID
end

-------------------  FeedingID  -----------------------------------------------------

if update(FeedingID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'FeedingID', Deleted.FeedingID, Inserted.FeedingID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.FeedingID <> Deleted.FeedingID
end

-------------------  GroomingID  -----------------------------------------------------

if update(GroomingID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'GroomingID', Deleted.GroomingID, Inserted.GroomingID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.GroomingID <> Deleted.GroomingID
end

-------------------  MealPreparationID  -----------------------------------------------------

if update(MealPreparationID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'MealPreparationID', Deleted.MealPreparationID, Inserted.MealPreparationID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.MealPreparationID <> Deleted.MealPreparationID
end

-------------------  WorkPlaySchoolID  -----------------------------------------------------

if update(WorkPlaySchoolID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'WorkPlaySchoolID', Deleted.WorkPlaySchoolID, Inserted.WorkPlaySchoolID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.WorkPlaySchoolID <> Deleted.WorkPlaySchoolID
end

-------------------  LeisureID  -----------------------------------------------------

if update(LeisureID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LeisureID', Deleted.LeisureID, Inserted.LeisureID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.LeisureID <> Deleted.LeisureID
end

-------------------  CommunicationID  -----------------------------------------------------

if update(CommunicationID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CommunicationID', Deleted.CommunicationID, Inserted.CommunicationID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.CommunicationID <> Deleted.CommunicationID
end

-------------------  CognitionID  -----------------------------------------------------

if update(CognitionID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CognitionID', Deleted.CognitionID, Inserted.CognitionID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.CognitionID <> Deleted.CognitionID
end

-------------------  AttentionID  -----------------------------------------------------

if update(AttentionID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AttentionID', Deleted.AttentionID, Inserted.AttentionID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.AttentionID <> Deleted.AttentionID
end

-------------------  ImpulseControlID  -----------------------------------------------------

if update(ImpulseControlID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ImpulseControlID', Deleted.ImpulseControlID, Inserted.ImpulseControlID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ImpulseControlID <> Deleted.ImpulseControlID
end

-------------------  SleepID  -----------------------------------------------------

if update(SleepID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SleepID', Deleted.SleepID, Inserted.SleepID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.SleepID <> Deleted.SleepID
end

-------------------  MemoryID  -----------------------------------------------------

if update(MemoryID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'MemoryID', Deleted.MemoryID, Inserted.MemoryID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.MemoryID <> Deleted.MemoryID
end

-------------------  PerceptionID  -----------------------------------------------------

if update(PerceptionID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PerceptionID', Deleted.PerceptionID, Inserted.PerceptionID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PerceptionID <> Deleted.PerceptionID
end

-------------------  ThoughtID  -----------------------------------------------------

if update(ThoughtID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ThoughtID', Deleted.ThoughtID, Inserted.ThoughtID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ThoughtID <> Deleted.ThoughtID
end

-------------------  SightID  -----------------------------------------------------

if update(SightID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SightID', Deleted.SightID, Inserted.SightID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.SightID <> Deleted.SightID
end

-------------------  TasteID  -----------------------------------------------------

if update(TasteID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'TasteID', Deleted.TasteID, Inserted.TasteID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.TasteID <> Deleted.TasteID
end

-------------------  HearingID  -----------------------------------------------------

if update(HearingID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'HearingID', Deleted.HearingID, Inserted.HearingID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.HearingID <> Deleted.HearingID
end

-------------------  TouchID  -----------------------------------------------------

if update(TouchID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'TouchID', Deleted.TouchID, Inserted.TouchID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.TouchID <> Deleted.TouchID
end

-------------------  SmellID  -----------------------------------------------------

if update(SmellID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SmellID', Deleted.SmellID, Inserted.SmellID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.SmellID <> Deleted.SmellID
end

-------------------  PainID  -----------------------------------------------------

if update(PainID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PainID', Deleted.PainID, Inserted.PainID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PainID <> Deleted.PainID
end

-------------------  VestibularID  -----------------------------------------------------

if update(VestibularID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VestibularID', Deleted.VestibularID, Inserted.VestibularID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.VestibularID <> Deleted.VestibularID
end

-------------------  TemperatureAndPressureID  -----------------------------------------------------

if update(TemperatureAndPressureID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'TemperatureAndPressureID', Deleted.TemperatureAndPressureID, Inserted.TemperatureAndPressureID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.TemperatureAndPressureID <> Deleted.TemperatureAndPressureID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: OccupationalTherapy ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteOccupationalTherapy')
	drop trigger utrDeleteOccupationalTherapy
go

create trigger utrDeleteOccupationalTherapy
on OccupationalTherapy
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'OccupationalTherapy' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return


-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  WalkingID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WalkingID', Deleted.WalkingID, null from Deleted

-------------------  SitStandTransfersID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SitStandTransfersID', Deleted.SitStandTransfersID, null from Deleted

-------------------  BathingID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BathingID', Deleted.BathingID, null from Deleted

-------------------  ToiletingID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ToiletingID', Deleted.ToiletingID, null from Deleted

-------------------  DressingID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DressingID', Deleted.DressingID, null from Deleted

-------------------  HandFunctionID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HandFunctionID', Deleted.HandFunctionID, null from Deleted

-------------------  WashingID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WashingID', Deleted.WashingID, null from Deleted

-------------------  FeedingID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FeedingID', Deleted.FeedingID, null from Deleted

-------------------  GroomingID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GroomingID', Deleted.GroomingID, null from Deleted

-------------------  MealPreparationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MealPreparationID', Deleted.MealPreparationID, null from Deleted

-------------------  WorkPlaySchoolID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'WorkPlaySchoolID', Deleted.WorkPlaySchoolID, null from Deleted

-------------------  LeisureID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeisureID', Deleted.LeisureID, null from Deleted

-------------------  CommunicationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CommunicationID', Deleted.CommunicationID, null from Deleted

-------------------  CognitionID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CognitionID', Deleted.CognitionID, null from Deleted

-------------------  AttentionID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AttentionID', Deleted.AttentionID, null from Deleted

-------------------  ImpulseControlID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ImpulseControlID', Deleted.ImpulseControlID, null from Deleted

-------------------  SleepID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SleepID', Deleted.SleepID, null from Deleted

-------------------  MemoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MemoryID', Deleted.MemoryID, null from Deleted

-------------------  PerceptionID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PerceptionID', Deleted.PerceptionID, null from Deleted

-------------------  ThoughtID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ThoughtID', Deleted.ThoughtID, null from Deleted

-------------------  SightID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SightID', Deleted.SightID, null from Deleted

-------------------  TasteID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TasteID', Deleted.TasteID, null from Deleted

-------------------  HearingID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HearingID', Deleted.HearingID, null from Deleted

-------------------  TouchID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TouchID', Deleted.TouchID, null from Deleted

-------------------  SmellID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SmellID', Deleted.SmellID, null from Deleted

-------------------  PainID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PainID', Deleted.PainID, null from Deleted

-------------------  VestibularID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VestibularID', Deleted.VestibularID, null from Deleted

-------------------  TemperatureAndPressureID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TemperatureAndPressureID', Deleted.TemperatureAndPressureID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: OTIntervention ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateOTIntervention')
	drop trigger utrUpdateOTIntervention
go

create trigger utrUpdateOTIntervention
on OTIntervention
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'OTIntervention' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
end


-------------------  LeadTherapist  -----------------------------------------------------

if update(LeadTherapist)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LeadTherapist', Deleted.LeadTherapist, Inserted.LeadTherapist
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.LeadTherapist <> Deleted.LeadTherapist
end

-------------------  InterventionTypeID  -----------------------------------------------------

if update(InterventionTypeID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'InterventionTypeID', Deleted.InterventionTypeID, Inserted.InterventionTypeID
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.InterventionTypeID <> Deleted.InterventionTypeID
end


-------------------  CognitiveAssessment  -----------------------------------------------------

if update(CognitiveAssessment)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CognitiveAssessment', Deleted.CognitiveAssessment, Inserted.CognitiveAssessment
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.CognitiveAssessment <> Deleted.CognitiveAssessment
end

-------------------  HandTherapy  -----------------------------------------------------

if update(HandTherapy)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'HandTherapy', Deleted.HandTherapy, Inserted.HandTherapy
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.HandTherapy <> Deleted.HandTherapy
end

-------------------  HealthEducation  -----------------------------------------------------

if update(HealthEducation)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'HealthEducation', Deleted.HealthEducation, Inserted.HealthEducation
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.HealthEducation <> Deleted.HealthEducation
end

-------------------  TherapeuticGroupActivities  -----------------------------------------------------

if update(TherapeuticGroupActivities)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'TherapeuticGroupActivities', Deleted.TherapeuticGroupActivities, Inserted.TherapeuticGroupActivities
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.TherapeuticGroupActivities <> Deleted.TherapeuticGroupActivities
end

-------------------  HomebasedRehabilitation  -----------------------------------------------------

if update(HomebasedRehabilitation)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'HomebasedRehabilitation', Deleted.HomebasedRehabilitation, Inserted.HomebasedRehabilitation
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.HomebasedRehabilitation <> Deleted.HomebasedRehabilitation
end

-------------------  AssistiveDevices  -----------------------------------------------------

if update(AssistiveDevices)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AssistiveDevices', Deleted.AssistiveDevices, Inserted.AssistiveDevices
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.AssistiveDevices <> Deleted.AssistiveDevices
end

-------------------  MobilitySkillsTraining  -----------------------------------------------------

if update(MobilitySkillsTraining)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'MobilitySkillsTraining', Deleted.MobilitySkillsTraining, Inserted.MobilitySkillsTraining
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.MobilitySkillsTraining <> Deleted.MobilitySkillsTraining
end

-------------------  NeurocognitiveRehabilitation  -----------------------------------------------------

if update(NeurocognitiveRehabilitation)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'NeurocognitiveRehabilitation', Deleted.NeurocognitiveRehabilitation, Inserted.NeurocognitiveRehabilitation
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.NeurocognitiveRehabilitation <> Deleted.NeurocognitiveRehabilitation
end

-------------------  OrientationTechniques  -----------------------------------------------------

if update(OrientationTechniques)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'OrientationTechniques', Deleted.OrientationTechniques, Inserted.OrientationTechniques
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.OrientationTechniques <> Deleted.OrientationTechniques
end

-------------------  VocationalRehabilitation  -----------------------------------------------------

if update(VocationalRehabilitation)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VocationalRehabilitation', Deleted.VocationalRehabilitation, Inserted.VocationalRehabilitation
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.VocationalRehabilitation <> Deleted.VocationalRehabilitation
end

-------------------  SelfCareTraining  -----------------------------------------------------

if update(SelfCareTraining)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SelfCareTraining', Deleted.SelfCareTraining, Inserted.SelfCareTraining
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.SelfCareTraining <> Deleted.SelfCareTraining
end

-------------------  PlayTherapy  -----------------------------------------------------

if update(PlayTherapy)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PlayTherapy', Deleted.PlayTherapy, Inserted.PlayTherapy
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.PlayTherapy <> Deleted.PlayTherapy
end

-------------------  StressManagement  -----------------------------------------------------

if update(StressManagement)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'StressManagement', Deleted.StressManagement, Inserted.StressManagement
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.StressManagement <> Deleted.StressManagement
end

-------------------  OtherAssessment  -----------------------------------------------------

if update(OtherAssessment)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'OtherAssessment', Deleted.OtherAssessment, Inserted.OtherAssessment
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.OtherAssessment <> Deleted.OtherAssessment
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.VisitNo <> Deleted.VisitNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: OTIntervention ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteOTIntervention')
	drop trigger utrDeleteOTIntervention
go

create trigger utrDeleteOTIntervention
on OTIntervention
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'OTIntervention' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  LeadTherapist  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LeadTherapist', Deleted.LeadTherapist, null from Deleted

-------------------  InterventionTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'InterventionTypeID', Deleted.InterventionTypeID, null from Deleted


-------------------  CognitiveAssessment  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CognitiveAssessment', Deleted.CognitiveAssessment, null from Deleted

-------------------  HandTherapy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HandTherapy', Deleted.HandTherapy, null from Deleted

-------------------  HealthEducation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HealthEducation', Deleted.HealthEducation, null from Deleted

-------------------  TherapeuticGroupActivities  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TherapeuticGroupActivities', Deleted.TherapeuticGroupActivities, null from Deleted

-------------------  HomebasedRehabilitation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HomebasedRehabilitation', Deleted.HomebasedRehabilitation, null from Deleted

-------------------  AssistiveDevices  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AssistiveDevices', Deleted.AssistiveDevices, null from Deleted

-------------------  MobilitySkillsTraining  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MobilitySkillsTraining', Deleted.MobilitySkillsTraining, null from Deleted

-------------------  NeurocognitiveRehabilitation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NeurocognitiveRehabilitation', Deleted.NeurocognitiveRehabilitation, null from Deleted

-------------------  OrientationTechniques  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OrientationTechniques', Deleted.OrientationTechniques, null from Deleted

-------------------  VocationalRehabilitation  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VocationalRehabilitation', Deleted.VocationalRehabilitation, null from Deleted

-------------------  SelfCareTraining  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SelfCareTraining', Deleted.SelfCareTraining, null from Deleted

-------------------  PlayTherapy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PlayTherapy', Deleted.PlayTherapy, null from Deleted

-------------------  StressManagement  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'StressManagement', Deleted.StressManagement, null from Deleted

-------------------  OtherAssessment  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherAssessment', Deleted.OtherAssessment, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go



----------------------------------------------------------------------------------------------------
------------ Delete: SuspiciousLogins ----------------------------------------------------------
----------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteSuspiciousLogins')
	drop trigger utrDeleteSuspiciousLogins
go

create trigger utrDeleteSuspiciousLogins
on SuspiciousLogins
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'SuspiciousLogins' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  Username  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Username', Deleted.Username, null from Deleted

-------------------  Details  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Details', Deleted.Details, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: MaternalEnrollment ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateMaternalEnrollment')
	drop trigger utrUpdateMaternalEnrollment
go

create trigger utrUpdateMaternalEnrollment
on MaternalEnrollment
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'MaternalEnrollment' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return


-------------------  ANCID  -----------------------------------------------------

if update(ANCID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ANCID', Deleted.ANCID, Inserted.ANCID
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.ANCID <> Deleted.ANCID
end

------------------- Key-ANCNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ANCNo', Deleted.ANCNo, Inserted.ANCNo
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
end


-------------------  PatientNo  -----------------------------------------------------

if update(PatientNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.PatientNo <> Deleted.PatientNo
end


-------------------  HIVStatusID  -----------------------------------------------------

if update(HIVStatusID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'HIVStatusID', Deleted.HIVStatusID, Inserted.HIVStatusID
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.HIVStatusID <> Deleted.HIVStatusID
end

-------------------  PartnersHIVStatusID  -----------------------------------------------------

if update(PartnersHIVStatusID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PartnersHIVStatusID', Deleted.PartnersHIVStatusID, Inserted.PartnersHIVStatusID
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.PartnersHIVStatusID <> Deleted.PartnersHIVStatusID
end


-------------------  Gravida  -----------------------------------------------------

if update(Gravida)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Gravida', Deleted.Gravida, Inserted.Gravida
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.Gravida <> Deleted.Gravida
end

-------------------  Para  -----------------------------------------------------

if update(Para)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Para', Deleted.Para, Inserted.Para
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.Para <> Deleted.Para
end

-------------------  LNMP  -----------------------------------------------------

if update(LNMP)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LNMP', dbo.FormatDate(Deleted.LNMP), dbo.FormatDate(Inserted.LNMP)
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.LNMP <> Deleted.LNMP
end

-------------------  LNMPDateReliable  -----------------------------------------------------

if update(LNMPDateReliable)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LNMPDateReliable', Deleted.LNMPDateReliable, Inserted.LNMPDateReliable
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.LNMPDateReliable <> Deleted.LNMPDateReliable
end

-------------------  CycleRegularID  -----------------------------------------------------

if update(CycleRegularID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CycleRegularID', Deleted.CycleRegularID, Inserted.CycleRegularID
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.CycleRegularID <> Deleted.CycleRegularID
end

-------------------  EDD  -----------------------------------------------------

if update(EDD)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'EDD', dbo.FormatDate(Deleted.EDD), dbo.FormatDate(Inserted.EDD)
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.EDD <> Deleted.EDD
end

-------------------  ScanDate  -----------------------------------------------------

if update(ScanDate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ScanDate', dbo.FormatDate(Deleted.ScanDate), dbo.FormatDate(Inserted.ScanDate)
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.ScanDate <> Deleted.ScanDate
end



-------------------  MedicalHistory  -----------------------------------------------------

if update(MedicalHistory)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'MedicalHistory', Deleted.MedicalHistory, Inserted.MedicalHistory
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.MedicalHistory <> Deleted.MedicalHistory
end


-------------------  MedicalHistoryNotes  -----------------------------------------------------

if update(MedicalHistoryNotes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'MedicalHistoryNotes', Deleted.MedicalHistoryNotes, Inserted.MedicalHistoryNotes
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.MedicalHistoryNotes <> Deleted.MedicalHistoryNotes
end

-------------------  BloodTransfusion  -----------------------------------------------------

if update(BloodTransfusion)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'BloodTransfusion', Deleted.BloodTransfusion, Inserted.BloodTransfusion
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.BloodTransfusion <> Deleted.BloodTransfusion
end

-------------------  BloodTransfusionDate  -----------------------------------------------------

if update(BloodTransfusionDate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'BloodTransfusionDate', dbo.FormatDateTime(Deleted.BloodTransfusionDate), dbo.FormatDateTime(Inserted.BloodTransfusionDate)
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.BloodTransfusionDate <> Deleted.BloodTransfusionDate
end

-------------------  SurgicalHistory  -----------------------------------------------------

if update(SurgicalHistory)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SurgicalHistory', Deleted.SurgicalHistory, Inserted.SurgicalHistory
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.SurgicalHistory <> Deleted.SurgicalHistory
end

-------------------  SurgicalHistoryNotes  -----------------------------------------------------

if update(SurgicalHistoryNotes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SurgicalHistoryNotes', Deleted.SurgicalHistoryNotes, Inserted.SurgicalHistoryNotes
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.SurgicalHistoryNotes <> Deleted.SurgicalHistoryNotes
end

-------------------  GynaecologicalHistory  -----------------------------------------------------

if update(GynaecologicalHistory)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'GynaecologicalHistory', Deleted.GynaecologicalHistory, Inserted.GynaecologicalHistory
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.GynaecologicalHistory <> Deleted.GynaecologicalHistory
end


-------------------  GynaecologicalHistoryNotes  -----------------------------------------------------

if update(GynaecologicalHistoryNotes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'GynaecologicalHistoryNotes', Deleted.GynaecologicalHistoryNotes, Inserted.GynaecologicalHistoryNotes
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.GynaecologicalHistoryNotes <> Deleted.GynaecologicalHistoryNotes
end

-------------------  FamilyHistory  -----------------------------------------------------

if update(FamilyHistory)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'FamilyHistory', Deleted.FamilyHistory, Inserted.FamilyHistory
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.FamilyHistory <> Deleted.FamilyHistory
end

-------------------  FamilyHistoryNotes  -----------------------------------------------------

if update(FamilyHistory)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'FamilyHistoryNotes', Deleted.FamilyHistoryNotes, Inserted.FamilyHistoryNotes
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.FamilyHistoryNotes <> Deleted.FamilyHistoryNotes
end

-------------------  SocialHistory  -----------------------------------------------------

if update(SocialHistory)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SocialHistory', Deleted.SocialHistory, Inserted.SocialHistory
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.SocialHistory <> Deleted.SocialHistory
end

-------------------  SocialHistoryNotes  -----------------------------------------------------

if update(SocialHistoryNotes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SocialHistoryNotes', Deleted.SocialHistoryNotes, Inserted.SocialHistoryNotes
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.SocialHistoryNotes <> Deleted.SocialHistoryNotes
end

-------------------  PatientStatusID  -----------------------------------------------------

if update(PatientStatusID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PatientStatusID', Deleted.PatientStatusID, Inserted.PatientStatusID
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.PatientStatusID <> Deleted.PatientStatusID
end


-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.ANCNo = Deleted.ANCNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: MaternalEnrollment ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteMaternalEnrollment')
	drop trigger utrDeleteMaternalEnrollment
go

create trigger utrDeleteMaternalEnrollment
on MaternalEnrollment
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'MaternalEnrollment' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ANCID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ANCID', Deleted.ANCID, null from Deleted

-------------------  ANCNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ANCNo', Deleted.ANCNo, null from Deleted

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  HIVStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HIVStatusID', Deleted.HIVStatusID, null from Deleted


-------------------  PartnersHIVStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PartnersHIVStatusID', Deleted.PartnersHIVStatusID, null from Deleted

-------------------  Gravida  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Gravida', Deleted.Gravida, null from Deleted

-------------------  Para  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Para', Deleted.Para, null from Deleted


-------------------  LNMP  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LNMP', dbo.FormatDate(Deleted.LNMP), null from Deleted

-------------------  LNMPDateReliable  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LNMPDateReliable', Deleted.LNMPDateReliable, null from Deleted

-------------------  CycleRegularID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CycleRegularID', Deleted.CycleRegularID, null from Deleted

-------------------  EDD  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'EDD', dbo.FormatDate(Deleted.EDD), null from Deleted

-------------------  ScanDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ScanDate', dbo.FormatDate(Deleted.ScanDate), null from Deleted

-------------------  MedicalHistory  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalHistory', Deleted.MedicalHistory, null from Deleted

-------------------  MedicalHistoryNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MedicalHistoryNotes', Deleted.MedicalHistoryNotes, null from Deleted

-------------------  BloodTransfusion  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodTransfusion', Deleted.BloodTransfusion, null from Deleted

-------------------  BloodTransfusionDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BloodTransfusionDate', dbo.FormatDate(Deleted.BloodTransfusionDate), null from Deleted

-------------------  SurgicalHistory  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SurgicalHistory', Deleted.SurgicalHistory, null from Deleted

-------------------  SurgicalHistoryNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SurgicalHistoryNotes', Deleted.SurgicalHistoryNotes, null from Deleted

-------------------  GynaecologicalHistory  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GynaecologicalHistory', Deleted.GynaecologicalHistory, null from Deleted

-------------------  GynaecologicalHistoryNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GynaecologicalHistoryNotes', Deleted.GynaecologicalHistoryNotes, null from Deleted

-------------------  FamilyHistory  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FamilyHistory', Deleted.FamilyHistory, null from Deleted

-------------------  FamilyHistoryNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FamilyHistoryNotes', Deleted.FamilyHistoryNotes, null from Deleted

-------------------  SocialHistory  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SocialHistory', Deleted.SocialHistory, null from Deleted

-------------------  SocialHistoryNotes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SocialHistoryNotes', Deleted.SocialHistoryNotes, null from Deleted


-------------------  PatientStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientStatusID', Deleted.PatientStatusID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: Obstetric ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateObstetric')
	drop trigger utrUpdateObstetric
go

create trigger utrUpdateObstetric
on Obstetric
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Obstetric' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-PatientNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
end

-------------------  Pregnancy  -----------------------------------------------------

if update(Pregnancy)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Pregnancy', Deleted.Pregnancy, Inserted.Pregnancy
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.Pregnancy <> Deleted.Pregnancy
end

-------------------  YearPregnant  -----------------------------------------------------

if update(YearPregnant)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'YearPregnant', Deleted.YearPregnant, Inserted.YearPregnant
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.YearPregnant <> Deleted.YearPregnant
end

-------------------  AbortionID  -----------------------------------------------------

if update(AbortionID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AbortionID', Deleted.AbortionID, Inserted.AbortionID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.AbortionID <> Deleted.AbortionID
end

-------------------  AbortionPeriodID  -----------------------------------------------------

if update(AbortionPeriodID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AbortionPeriodID', Deleted.AbortionPeriodID, Inserted.AbortionPeriodID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.AbortionPeriodID <> Deleted.AbortionPeriodID
end


-------------------  TypeOfDeliveryID  -----------------------------------------------------

if update(TypeOfDeliveryID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'TypeOfDeliveryID', Deleted.TypeOfDeliveryID, Inserted.TypeOfDeliveryID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.TypeOfDeliveryID <> Deleted.TypeOfDeliveryID
end

-------------------  ThirdStageID  -----------------------------------------------------

if update(ThirdStageID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ThirdStageID', Deleted.ThirdStageID, Inserted.ThirdStageID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ThirdStageID <> Deleted.ThirdStageID
end

-------------------  PuerPeriumID  -----------------------------------------------------

if update(PuerPeriumID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PuerPeriumID', Deleted.PuerPeriumID, Inserted.PuerPeriumID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.PuerPeriumID <> Deleted.PuerPeriumID
end

-------------------  ChildStatusID  -----------------------------------------------------

if update(ChildStatusID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ChildStatusID', Deleted.ChildStatusID, Inserted.ChildStatusID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ChildStatusID <> Deleted.ChildStatusID
end

-------------------  GenderID  -----------------------------------------------------

if update(GenderID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'GenderID', Deleted.GenderID, Inserted.GenderID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.GenderID <> Deleted.GenderID
end

-------------------  BirthWeight  -----------------------------------------------------

if update(BirthWeight)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'BirthWeight', Deleted.BirthWeight, Inserted.BirthWeight
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.BirthWeight <> Deleted.BirthWeight
end

-------------------  ChildImmunised  -----------------------------------------------------

if update(ChildImmunised)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ChildImmunised', Deleted.ChildImmunised, Inserted.ChildImmunised
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ChildImmunised <> Deleted.ChildImmunised
end

-------------------  HealthCondition  -----------------------------------------------------

if update(HealthCondition)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'HealthCondition', Deleted.HealthCondition, Inserted.HealthCondition
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.HealthCondition <> Deleted.HealthCondition
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: Obstetric ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteObstetric')
	drop trigger utrDeleteObstetric
go

create trigger utrDeleteObstetric
on Obstetric
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Obstetric' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  Pregnancy  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Pregnancy', Deleted.Pregnancy, null from Deleted

-------------------  YearPregnant  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'YearPregnant', Deleted.YearPregnant, null from Deleted

-------------------  AbortionID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AbortionID', Deleted.AbortionID, null from Deleted

-------------------  AbortionPeriodID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AbortionPeriodID', Deleted.AbortionPeriodID, null from Deleted

-------------------  TypeOfDeliveryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TypeOfDeliveryID', Deleted.TypeOfDeliveryID, null from Deleted

-------------------  ThirdStageID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ThirdStageID', Deleted.ThirdStageID, null from Deleted

-------------------  PuerPeriumID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PuerPeriumID', Deleted.PuerPeriumID, null from Deleted

-------------------  ChildStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ChildStatusID', Deleted.ChildStatusID, null from Deleted

-------------------  GenderID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'GenderID', Deleted.GenderID, null from Deleted

-------------------  BirthWeight  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BirthWeight', Deleted.BirthWeight, null from Deleted

-------------------  ChildImmunised  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ChildImmunised', Deleted.ChildImmunised, null from Deleted

-------------------  HealthCondition  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HealthCondition', Deleted.HealthCondition, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: ContraceptivesHistory ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateContraceptivesHistory')
	drop trigger utrUpdateContraceptivesHistory
go

create trigger utrUpdateContraceptivesHistory
on ContraceptivesHistory
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ContraceptivesHistory' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-PatientNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
end

-------------------  ComplicationsID  -----------------------------------------------------

if update(ComplicationsID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ComplicationsID', Deleted.ComplicationsID, Inserted.ComplicationsID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ComplicationsID <> Deleted.ComplicationsID
end

-------------------  ComplicationDetails  -----------------------------------------------------

if update(ComplicationDetails)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ComplicationDetails', Deleted.ComplicationDetails, Inserted.ComplicationDetails
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ComplicationDetails <> Deleted.ComplicationDetails
end

-------------------  ContraceptiveID  -----------------------------------------------------

if update(ContraceptiveID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ContraceptiveID', Deleted.ContraceptiveID, Inserted.ContraceptiveID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ContraceptiveID <> Deleted.ContraceptiveID
end

-------------------  DateStarted  -----------------------------------------------------

if update(DateStarted)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DateStarted', dbo.FormatDate(Deleted.DateStarted), dbo.FormatDate(Inserted.DateStarted)
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.DateStarted <> Deleted.DateStarted
end

-------------------  DiscontinuedRemovedID  -----------------------------------------------------

if update(DiscontinuedRemovedID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DiscontinuedRemovedID', Deleted.DiscontinuedRemovedID, Inserted.DiscontinuedRemovedID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.DiscontinuedRemovedID <> Deleted.DiscontinuedRemovedID
end

-------------------  RemovalReasonsID  -----------------------------------------------------

if update(RemovalReasonsID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RemovalReasonsID', Deleted.RemovalReasonsID, Inserted.RemovalReasonsID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.RemovalReasonsID <> Deleted.RemovalReasonsID
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: ContraceptivesHistory ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteContraceptivesHistory')
	drop trigger utrDeleteContraceptivesHistory
go

create trigger utrDeleteContraceptivesHistory
on ContraceptivesHistory
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ContraceptivesHistory' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  ComplicationsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ComplicationsID', Deleted.ComplicationsID, null from Deleted

-------------------  ComplicationDetails  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ComplicationDetails', Deleted.ComplicationDetails, null from Deleted

-------------------  ContraceptiveID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ContraceptiveID', Deleted.ContraceptiveID, null from Deleted

-------------------  DateStarted  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DateStarted', dbo.FormatDate(Deleted.DateStarted), null from Deleted

-------------------  DiscontinuedRemovedID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiscontinuedRemovedID', Deleted.DiscontinuedRemovedID, null from Deleted

-------------------  RemovalReasonsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RemovalReasonsID', Deleted.RemovalReasonsID, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: PelvicExamination ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePelvicExamination')
	drop trigger utrUpdatePelvicExamination
go

create trigger utrUpdatePelvicExamination
on PelvicExamination
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PelvicExamination' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  ANCNo  -----------------------------------------------------

if update(ANCNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ANCNo', Deleted.ANCNo, Inserted.ANCNo
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ANCNo <> Deleted.ANCNo
end

-------------------  VulvaID  -----------------------------------------------------

if update(VulvaID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VulvaID', Deleted.VulvaID, Inserted.VulvaID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.VulvaID <> Deleted.VulvaID
end

-------------------  CervixID  -----------------------------------------------------

if update(CervixID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'CervixID', Deleted.CervixID, Inserted.CervixID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.CervixID <> Deleted.CervixID
end

-------------------  AdnexaID  -----------------------------------------------------

if update(AdnexaID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AdnexaID', Deleted.AdnexaID, Inserted.AdnexaID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.AdnexaID <> Deleted.AdnexaID
end

-------------------  VaginaID  -----------------------------------------------------

if update(VaginaID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VaginaID', Deleted.VaginaID, Inserted.VaginaID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.VaginaID <> Deleted.VaginaID
end

-------------------  UterusID  -----------------------------------------------------

if update(UterusID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'UterusID', Deleted.UterusID, Inserted.UterusID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.UterusID <> Deleted.UterusID
end

-------------------  DiagonalConjugate  -----------------------------------------------------

if update(DiagonalConjugate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DiagonalConjugate', Deleted.DiagonalConjugate, Inserted.DiagonalConjugate
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.DiagonalConjugate <> Deleted.DiagonalConjugate
end

-------------------  SacralCurve  -----------------------------------------------------

if update(SacralCurve)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SacralCurve', Deleted.SacralCurve, Inserted.SacralCurve
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.SacralCurve <> Deleted.SacralCurve
end

-------------------  IschialSpine  -----------------------------------------------------

if update(IschialSpine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'IschialSpine', Deleted.IschialSpine, Inserted.IschialSpine
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.IschialSpine <> Deleted.IschialSpine
end

-------------------  SubPublicAngle  -----------------------------------------------------

if update(SubPublicAngle)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SubPublicAngle', Deleted.SubPublicAngle, Inserted.SubPublicAngle
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.SubPublicAngle <> Deleted.SubPublicAngle
end

-------------------  IschialTuberosities  -----------------------------------------------------

if update(IschialTuberosities)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'IschialTuberosities', Deleted.IschialTuberosities, Inserted.IschialTuberosities
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.IschialTuberosities <> Deleted.IschialTuberosities
end

-------------------  ConclusionID  -----------------------------------------------------

if update(ConclusionID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ConclusionID', Deleted.ConclusionID, Inserted.ConclusionID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ConclusionID <> Deleted.ConclusionID
end

-------------------  RiskFactors  -----------------------------------------------------

if update(RiskFactors)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RiskFactors', Deleted.RiskFactors, Inserted.RiskFactors
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.RiskFactors <> Deleted.RiskFactors
end

-------------------  Recommendations  -----------------------------------------------------

if update(Recommendations)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Recommendations', Deleted.Recommendations, Inserted.Recommendations
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.Recommendations <> Deleted.Recommendations
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PelvicExamination ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePelvicExamination')
	drop trigger utrDeletePelvicExamination
go

create trigger utrDeletePelvicExamination
on PelvicExamination
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PelvicExamination' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  ANCNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ANCNo', Deleted.ANCNo, null from Deleted

-------------------  VulvaID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VulvaID', Deleted.VulvaID, null from Deleted

-------------------  CervixID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'CervixID', Deleted.CervixID, null from Deleted

-------------------  AdnexaID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AdnexaID', Deleted.AdnexaID, null from Deleted

-------------------  VaginaID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VaginaID', Deleted.VaginaID, null from Deleted

-------------------  UterusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'UterusID', Deleted.UterusID, null from Deleted

-------------------  DiagonalConjugate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DiagonalConjugate', Deleted.DiagonalConjugate, null from Deleted

-------------------  SacralCurve  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SacralCurve', Deleted.SacralCurve, null from Deleted

-------------------  IschialSpine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IschialSpine', Deleted.IschialSpine, null from Deleted

-------------------  SubPublicAngle  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SubPublicAngle', Deleted.SubPublicAngle, null from Deleted

-------------------  IschialTuberosities  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IschialTuberosities', Deleted.IschialTuberosities, null from Deleted

-------------------  ConclusionID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ConclusionID', Deleted.ConclusionID, null from Deleted

-------------------  RiskFactors  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RiskFactors', Deleted.RiskFactors, null from Deleted

-------------------  Recommendations  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Recommendations', Deleted.Recommendations, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: AntenatalVisits ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAntenatalVisits')
	drop trigger utrUpdateAntenatalVisits
go

create trigger utrUpdateAntenatalVisits
on AntenatalVisits
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'AntenatalVisits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
end

-------------------  PallorID  -----------------------------------------------------

if update(PallorID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PallorID', Deleted.PallorID, Inserted.PallorID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PallorID <> Deleted.PallorID
end

-------------------  JaundiceID  -----------------------------------------------------

if update(JaundiceID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'JaundiceID', Deleted.JaundiceID, Inserted.JaundiceID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.JaundiceID <> Deleted.JaundiceID
end

-------------------  LynphadenopathyID  -----------------------------------------------------

if update(LynphadenopathyID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LynphadenopathyID', Deleted.LynphadenopathyID, Inserted.LynphadenopathyID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.LynphadenopathyID <> Deleted.LynphadenopathyID
end

-------------------  VaricoseID  -----------------------------------------------------

if update(VaricoseID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VaricoseID', Deleted.VaricoseID, Inserted.VaricoseID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.VaricoseID <> Deleted.VaricoseID
end

-------------------  OedemaID  -----------------------------------------------------

if update(OedemaID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'OedemaID', Deleted.OedemaID, Inserted.OedemaID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.OedemaID <> Deleted.OedemaID
end

-------------------  HeartSoundID  -----------------------------------------------------

if update(HeartSoundID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'HeartSoundID', Deleted.HeartSoundID, Inserted.HeartSoundID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.HeartSoundID <> Deleted.HeartSoundID
end

-------------------  AirEntryID  -----------------------------------------------------

if update(AirEntryID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AirEntryID', Deleted.AirEntryID, Inserted.AirEntryID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.AirEntryID <> Deleted.AirEntryID
end

-------------------  BreastID  -----------------------------------------------------

if update(BreastID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'BreastID', Deleted.BreastID, Inserted.BreastID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.BreastID <> Deleted.BreastID
end

-------------------  LiverID  -----------------------------------------------------

if update(LiverID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LiverID', Deleted.LiverID, Inserted.LiverID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.LiverID <> Deleted.LiverID
end

-------------------  SpleenID  -----------------------------------------------------

if update(SpleenID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SpleenID', Deleted.SpleenID, Inserted.SpleenID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.SpleenID <> Deleted.SpleenID
end

-------------------  BowelSoundsID  -----------------------------------------------------

if update(BowelSoundsID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'BowelSoundsID', Deleted.BowelSoundsID, Inserted.BowelSoundsID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.BowelSoundsID <> Deleted.BowelSoundsID
end

-------------------  ScarID  -----------------------------------------------------

if update(ScarID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ScarID', Deleted.ScarID, Inserted.ScarID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ScarID <> Deleted.ScarID
end

-------------------  PupilReactionID  -----------------------------------------------------

if update(PupilReactionID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PupilReactionID', Deleted.PupilReactionID, Inserted.PupilReactionID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PupilReactionID <> Deleted.PupilReactionID
end

-------------------  ReflexesID  -----------------------------------------------------

if update(ReflexesID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReflexesID', Deleted.ReflexesID, Inserted.ReflexesID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReflexesID <> Deleted.ReflexesID
end

-------------------  OtherSTIID  -----------------------------------------------------

if update(OtherSTIID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'OtherSTIID', Deleted.OtherSTIID, Inserted.OtherSTIID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.OtherSTIID <> Deleted.OtherSTIID
end

-------------------  STIDetails  -----------------------------------------------------

if update(STIDetails)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'STIDetails', Deleted.STIDetails, Inserted.STIDetails
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.STIDetails <> Deleted.STIDetails
end

-------------------  SkeletalDeformityID  -----------------------------------------------------

if update(SkeletalDeformityID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SkeletalDeformityID', Deleted.SkeletalDeformityID, Inserted.SkeletalDeformityID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.SkeletalDeformityID <> Deleted.SkeletalDeformityID
end



-------------------  AnenorrheaWeeks  -----------------------------------------------------

if update(AnenorrheaWeeks)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AnenorrheaWeeks', Deleted.AnenorrheaWeeks, Inserted.AnenorrheaWeeks
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.AnenorrheaWeeks <> Deleted.AnenorrheaWeeks
end

-------------------  FundalHeight  -----------------------------------------------------

if update(FundalHeight)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'FundalHeight', Deleted.FundalHeight, Inserted.FundalHeight
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.FundalHeight <> Deleted.FundalHeight
end

-------------------  PresentationID  -----------------------------------------------------

if update(PresentationID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Presentation', Deleted.PresentationID, Inserted.PresentationID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PresentationID <> Deleted.PresentationID
end

-------------------  LieID  -----------------------------------------------------

if update(LieID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LieID', Deleted.LieID, Inserted.LieID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.LieID <> Deleted.LieID
end

-------------------  PositionID  -----------------------------------------------------

if update(PositionID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PositionID', Deleted.PositionID, Inserted.PositionID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PositionID <> Deleted.PositionID
end


-------------------  RelationPPOrBrim  -----------------------------------------------------

if update(RelationPPOrBrim)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RelationPPOrBrim', Deleted.RelationPPOrBrim, Inserted.RelationPPOrBrim
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.RelationPPOrBrim <> Deleted.RelationPPOrBrim
end

-------------------  FoetalHeart  -----------------------------------------------------

if update(FoetalHeart)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'FoetalHeart', Deleted.FoetalHeart, Inserted.FoetalHeart
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.FoetalHeart <> Deleted.FoetalHeart
end

-------------------  TTGiven  -----------------------------------------------------

if update(TTGiven)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'TTGiven', Deleted.TTGiven, Inserted.TTGiven
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.TTGiven <> Deleted.TTGiven
end

-------------------  IPTID  -----------------------------------------------------

if update(IPTID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'IPT', Deleted.IPTID, Inserted.IPTID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.IPTID <> Deleted.IPTID
end

-------------------  NetUseID  -----------------------------------------------------

if update(NetUseID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'NetUse', Deleted.NetUseID, Inserted.NetUseID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.NetUseID <> Deleted.NetUseID
end

-------------------  Remarks  -----------------------------------------------------

if update(Remarks)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Remarks', Deleted.Remarks, Inserted.Remarks
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.Remarks <> Deleted.Remarks
end

-------------------  ReturnDate  -----------------------------------------------------

if update(ReturnDate)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReturnDate', dbo.FormatDate(Deleted.ReturnDate), dbo.FormatDate(Inserted.ReturnDate)
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ReturnDate <> Deleted.ReturnDate
end

-------------------  DoctorSpecialityID  -----------------------------------------------------

if update(DoctorSpecialityID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DoctorSpecialityID', Deleted.DoctorSpecialityID, Inserted.DoctorSpecialityID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.DoctorSpecialityID <> Deleted.DoctorSpecialityID
end

-------------------  DoctorID  -----------------------------------------------------

if update(DoctorID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DoctorID', Deleted.DoctorID, Inserted.DoctorID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.DoctorID <> Deleted.DoctorID
end

------------------- NurseInChargeID  -----------------------------------------------------

if update(NurseInChargeID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'NurseInChargeID', Deleted.NurseInChargeID, Inserted.NurseInChargeID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.NurseInChargeID <> Deleted.NurseInChargeID
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: AntenatalVisits ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAntenatalVisits')
	drop trigger utrDeleteAntenatalVisits
go

create trigger utrDeleteAntenatalVisits
on AntenatalVisits
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'AntenatalVisits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  PallorID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PallorID', Deleted.PallorID, null from Deleted

-------------------  JaundiceID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'JaundiceID', Deleted.JaundiceID, null from Deleted

-------------------  LynphadenopathyID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LynphadenopathyID', Deleted.LynphadenopathyID, null from Deleted

-------------------  VaricoseID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VaricoseID', Deleted.VaricoseID, null from Deleted

-------------------  OedemaID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OedemaID', Deleted.OedemaID, null from Deleted

-------------------  HeartSoundID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'HeartSoundID', Deleted.HeartSoundID, null from Deleted

-------------------  AirEntryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AirEntryID', Deleted.AirEntryID, null from Deleted

-------------------  BreastID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BreastID', Deleted.BreastID, null from Deleted

-------------------  LiverID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LiverID', Deleted.LiverID, null from Deleted

-------------------  SpleenID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpleenID', Deleted.SpleenID, null from Deleted

-------------------  BowelSoundsID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'BowelSoundsID', Deleted.BowelSoundsID, null from Deleted

-------------------  ScarID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ScarID', Deleted.ScarID, null from Deleted

-------------------  PupilReactionID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PupilReactionID', Deleted.PupilReactionID, null from Deleted

-------------------  ReflexesID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReflexesID', Deleted.ReflexesID, null from Deleted

-------------------  OtherSTIID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'OtherSTIID', Deleted.OtherSTIID, null from Deleted

-------------------  STIDetails  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'STIDetails', Deleted.STIDetails, null from Deleted

-------------------  SkeletalDeformityID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SkeletalDeformityID', Deleted.SkeletalDeformityID, null from Deleted

-------------------  AnenorrheaWeeks  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AnenorrheaWeeks', Deleted.AnenorrheaWeeks, null from Deleted

-------------------  FundalHeight  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FundalHeight', Deleted.FundalHeight, null from Deleted

-------------------  PresentationID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Presentation', Deleted.PresentationID, null from Deleted

-------------------  LieID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LieID', Deleted.LieID, null from Deleted

-------------------  PositionID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PositionID', Deleted.PositionID, null from Deleted

-------------------  RelationPPOrBrim  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RelationPPOrBrim', Deleted.RelationPPOrBrim, null from Deleted

-------------------  FoetalHeart  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FoetalHeart', Deleted.FoetalHeart, null from Deleted

-------------------  TTGiven  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TTGiven', Deleted.TTGiven, null from Deleted

-------------------  IPTID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'IPT', Deleted.IPTID, null from Deleted

-------------------  NetUseID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NetUse', Deleted.NetUseID, null from Deleted

-------------------  Remarks  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Remarks', Deleted.Remarks, null from Deleted

-------------------  ReturnDate  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReturnDate', dbo.FormatDate(Deleted.ReturnDate), null from Deleted

-------------------  DoctorSpecialityID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorSpecialityID', Deleted.DoctorSpecialityID, null from Deleted

-------------------  DoctorID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DoctorID', Deleted.DoctorID, null from Deleted

-------------------  NurseInChargeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'NurseInChargeID', Deleted.NurseInChargeID, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: ReceiptReversals ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateReceiptReversals')
	drop trigger utrUpdateReceiptReversals
go

create trigger utrUpdateReceiptReversals
on ReceiptReversals
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ReceiptReversals' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-RefundNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RefundNo', Deleted.RefundNo, Inserted.RefundNo
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
end

-------------------  ReceiptNo  -----------------------------------------------------

if update(ReceiptNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReceiptNo', Deleted.ReceiptNo, Inserted.ReceiptNo
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.ReceiptNo <> Deleted.ReceiptNo
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.Notes <> Deleted.Notes
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.RefundNo = Deleted.RefundNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: ReceiptReversals ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteReceiptReversals')
	drop trigger utrDeleteReceiptReversals
go

create trigger utrDeleteReceiptReversals
on ReceiptReversals
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ReceiptReversals' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ReceiptNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReceiptNo', Deleted.ReceiptNo, null from Deleted

-------------------  RefundNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RefundNo', Deleted.RefundNo, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: PackageVisits ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePackageVisits')
	drop trigger utrUpdatePackageVisits
go

create trigger utrUpdatePackageVisits
on PackageVisits
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PackageVisits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-VisitNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PackageNo = Deleted.PackageNo
end

------------------- Key-PackageNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PackageNo', Deleted.PackageNo, Inserted.PackageNo
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PackageNo = Deleted.PackageNo
end

-------------------  PatientNo  -----------------------------------------------------

if update(PatientNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
	from Inserted inner join Deleted
	on Inserted.VisitNo = Deleted.VisitNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.PatientNo <> Deleted.PatientNo
end


go


------------------------------------------------------------------------------------------------------
-------------- Delete: PackageVisits ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePackageVisits')
	drop trigger utrDeletePackageVisits
go

create trigger utrDeletePackageVisits
on PackageVisits
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PackageVisits' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  PackageNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageNo', Deleted.PackageNo, null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: ApprovedLabResults ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateApprovedLabResults')
	drop trigger utrUpdateApprovedLabResults
go

create trigger utrUpdateApprovedLabResults
on ApprovedLabResults
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'ApprovedLabResults' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-SpecimenNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'SpecimenNo', Deleted.SpecimenNo, Inserted.SpecimenNo
	from Inserted inner join Deleted
	on Inserted.SpecimenNo = Deleted.SpecimenNo
	and Inserted.TestCode = Deleted.TestCode
end

------------------- Key-TestCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'TestCode', Deleted.TestCode, Inserted.TestCode
	from Inserted inner join Deleted
	on Inserted.SpecimenNo = Deleted.SpecimenNo
	and Inserted.TestCode = Deleted.TestCode
end

-------------------  TestName  -----------------------------------------------------

if update(TestName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'TestName', Deleted.TestName, Inserted.TestName
	from Inserted inner join Deleted
	on Inserted.SpecimenNo = Deleted.SpecimenNo
	and Inserted.TestCode = Deleted.TestCode
	and Inserted.TestName <> Deleted.TestName
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.SpecimenNo = Deleted.SpecimenNo
	and Inserted.TestCode = Deleted.TestCode
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.SpecimenNo = Deleted.SpecimenNo
	and Inserted.TestCode = Deleted.TestCode
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.SpecimenNo = Deleted.SpecimenNo
	and Inserted.TestCode = Deleted.TestCode
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: ApprovedLabResults ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteApprovedLabResults')
	drop trigger utrDeleteApprovedLabResults
go

create trigger utrDeleteApprovedLabResults
on ApprovedLabResults
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'ApprovedLabResults' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  SpecimenNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'SpecimenNo', Deleted.SpecimenNo, null from Deleted

-------------------  TestCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestCode', Deleted.TestCode, null from Deleted

-------------------  TestName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TestName', Deleted.TestName, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: IPDPackageConsumption ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateIPDPackageConsumption')
	drop trigger utrUpdateIPDPackageConsumption
go

create trigger utrUpdateIPDPackageConsumption
on IPDPackageConsumption
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'IPDPackageConsumption' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-ExtraBillNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, Inserted.ExtraBillNo
	from Inserted inner join Deleted
	on Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-PackageNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PackageNo', Deleted.PackageNo, Inserted.PackageNo
	from Inserted inner join Deleted
	on Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
end

-------------------  VisitNo  -----------------------------------------------------

if update(VisitNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'VisitNo', Deleted.VisitNo, Inserted.VisitNo
	from Inserted inner join Deleted
	on Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.VisitNo <> Deleted.VisitNo
end

-------------------  PackageVisitNo  -----------------------------------------------------

if update(PackageVisitNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PackageVisitNo', Deleted.ItemStatusID, Inserted.ItemStatusID
	from Inserted inner join Deleted
	on Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.PackageVisitNo <> Deleted.PackageVisitNo
end


-------------------  ItemStatusID  -----------------------------------------------------

if update(ItemStatusID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemStatusID', Deleted.ItemStatusID, Inserted.ItemStatusID
	from Inserted inner join Deleted
	on Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ItemStatusID <> Deleted.ItemStatusID
end

-------------------  Quantity  -----------------------------------------------------

if update(Quantity)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Quantity', Deleted.Quantity, Inserted.Quantity
	from Inserted inner join Deleted
	on Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.Quantity <> Deleted.Quantity
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.ExtraBillNo = Deleted.ExtraBillNo
	and Inserted.PackageNo = Deleted.PackageNo
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: IPDPackageConsumption ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteIPDPackageConsumption')
	drop trigger utrDeleteIPDPackageConsumption
go

create trigger utrDeleteIPDPackageConsumption
on IPDPackageConsumption
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'IPDPackageConsumption' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ExtraBillNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ExtraBillNo', Deleted.ExtraBillNo, null from Deleted

-------------------  PackageVisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageVisitNo', Deleted.PackageVisitNo, null from Deleted

-------------------  VisitNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'VisitNo', Deleted.VisitNo, null from Deleted

-------------------  PackageNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PackageNo', Deleted.PackageNo, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemStatusID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemStatusID', Deleted.ItemStatusID, null from Deleted

-------------------  Quantity  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Quantity', Deleted.Quantity, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: AccountsEXT ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateAccountsEXT')
	drop trigger utrUpdateAccountsEXT
go

create trigger utrUpdateAccountsEXT
on AccountsEXT
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'AccountsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-TranNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'TranNo', Deleted.TranNo, Inserted.TranNo
	from Inserted inner join Deleted
	on Inserted.TranNo = Deleted.TranNo
	and Inserted.ReferenceNo = Deleted.ReferenceNo
end

------------------- Key-ReferenceNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ReferenceNo', Deleted.ReferenceNo, Inserted.ReferenceNo
	from Inserted inner join Deleted
	on Inserted.TranNo = Deleted.TranNo
	and Inserted.ReferenceNo = Deleted.ReferenceNo
end


go


------------------------------------------------------------------------------------------------------
-------------- Delete: AccountsEXT ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteAccountsEXT')
	drop trigger utrDeleteAccountsEXT
go

create trigger utrDeleteAccountsEXT
on AccountsEXT
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'AccountsEXT' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  TranNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'TranNo', Deleted.TranNo, null from Deleted

-------------------  ReferenceNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ReferenceNo', Deleted.ReferenceNo, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: INTAgents ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateINTAgents')
	drop trigger utrUpdateINTAgents
go

create trigger utrUpdateINTAgents
on INTAgents
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'INTAgents' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-AgentNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AgentNo', Deleted.AgentNo, Inserted.AgentNo
	from Inserted inner join Deleted
	on Inserted.AgentNo = Deleted.AgentNo
end

-------------------  AgentName  -----------------------------------------------------

if update(AgentName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AgentName', Deleted.AgentName, Inserted.AgentName
	from Inserted inner join Deleted
	on Inserted.AgentNo = Deleted.AgentNo
	and Inserted.AgentName <> Deleted.AgentName
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.AgentNo = Deleted.AgentNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.AgentNo = Deleted.AgentNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.AgentNo = Deleted.AgentNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: INTAgents ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteINTAgents')
	drop trigger utrDeleteINTAgents
go

create trigger utrDeleteINTAgents
on INTAgents
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'INTAgents' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  AgentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AgentNo', Deleted.AgentNo, null from Deleted

-------------------  AgentName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AgentName', Deleted.AgentName, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: LookupDataMappings ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateLookupDataMappings')
	drop trigger utrUpdateLookupDataMappings
go

create trigger utrUpdateLookupDataMappings
on LookupDataMappings
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'LookupDataMappings' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-DataID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DataID', Deleted.DataID, Inserted.DataID
	from Inserted inner join Deleted
	on Inserted.DataID = Deleted.DataID
	and Inserted.AgentDataID = Deleted.AgentDataID
end

------------------- Key-AgentDataID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AgentDataID', Deleted.AgentDataID, Inserted.AgentDataID
	from Inserted inner join Deleted
	on Inserted.DataID = Deleted.DataID
	and Inserted.AgentDataID = Deleted.AgentDataID
end

-------------------  AgentNo  -----------------------------------------------------

if update(AgentNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AgentNo', Deleted.AgentNo, Inserted.AgentNo
	from Inserted inner join Deleted
	on Inserted.DataID = Deleted.DataID
	and Inserted.AgentDataID = Deleted.AgentDataID
	and Inserted.AgentNo <> Deleted.AgentNo
end

-------------------  ObjectName  -----------------------------------------------------

if update(ObjectName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ObjectName', Deleted.ObjectName, Inserted.ObjectName
	from Inserted inner join Deleted
	on Inserted.DataID = Deleted.DataID
	and Inserted.AgentDataID = Deleted.AgentDataID
	and Inserted.ObjectName <> Deleted.ObjectName
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.DataID = Deleted.DataID
	and Inserted.AgentDataID = Deleted.AgentDataID
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.DataID = Deleted.DataID
	and Inserted.AgentDataID = Deleted.AgentDataID
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.DataID = Deleted.DataID
	and Inserted.AgentDataID = Deleted.AgentDataID
	and Inserted.ClientMachine <> Deleted.ClientMachine
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: LookupDataMappings ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteLookupDataMappings')
	drop trigger utrDeleteLookupDataMappings
go

create trigger utrDeleteLookupDataMappings
on LookupDataMappings
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'LookupDataMappings' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  DataID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DataID', Deleted.DataID, null from Deleted

-------------------  AgentDataID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AgentDataID', Deleted.AgentDataID, null from Deleted

-------------------  AgentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AgentNo', Deleted.AgentNo, null from Deleted

-------------------  ObjectName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ObjectName', Deleted.ObjectName, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: PatientConsent ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdatePatientConsent')
	drop trigger utrUpdatePatientConsent
go

create trigger utrUpdatePatientConsent
on PatientConsent
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'PatientConsent' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-PatientNo -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PatientNo', Deleted.PatientNo, Inserted.PatientNo
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
end

-------------------  PhoneNo  -----------------------------------------------------

if update(PhoneNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'PhoneNo', Deleted.PhoneNo, Inserted.PhoneNo
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.PhoneNo <> Deleted.PhoneNo
end

-------------------  Notes  -----------------------------------------------------

if update(Notes)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Notes', Deleted.Notes, Inserted.Notes
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.Notes <> Deleted.Notes
end

-------------------  FingerprintVerified  -----------------------------------------------------

if update(FingerprintVerified)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'FingerprintVerified', Deleted.FingerprintVerified, Inserted.FingerprintVerified
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.FingerprintVerified <> Deleted.FingerprintVerified
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.PatientNo = Deleted.PatientNo
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: PatientConsent ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeletePatientConsent')
	drop trigger utrDeletePatientConsent
go

create trigger utrDeletePatientConsent
on PatientConsent
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'PatientConsent' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  PatientNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PatientNo', Deleted.PatientNo, null from Deleted

-------------------  PhoneNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'PhoneNo', Deleted.PhoneNo, null from Deleted

-------------------  Notes  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Notes', Deleted.Notes, null from Deleted

-------------------  FingerprintVerified  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'FingerprintVerified', Deleted.FingerprintVerified, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

------------------------------------------------------------------------------------------------------
-------------- Update: BillableMappings ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateBillableMappings')
	drop trigger utrUpdateBillableMappings
go

create trigger utrUpdateBillableMappings
on BillableMappings
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'BillableMappings' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-ItemCategoryID -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, Inserted.ItemCategoryID
	from Inserted inner join Deleted
	on Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ItemCode = Deleted.ItemCode
end

------------------- Key-ItemCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ItemCode', Deleted.ItemCode, Inserted.ItemCode
	from Inserted inner join Deleted
	on Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ItemCode = Deleted.ItemCode
end

-------------------  AgentNo  -----------------------------------------------------

if update(AgentNo)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'AgentNo', Deleted.AgentNo, Inserted.AgentNo
	from Inserted inner join Deleted
	on Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.AgentNo <> Deleted.AgentNo
end

-------------------  MappedTypeID  -----------------------------------------------------

if update(MappedTypeID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'MappedTypeID', Deleted.MappedTypeID, Inserted.MappedTypeID
	from Inserted inner join Deleted
	on Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.MappedTypeID <> Deleted.MappedTypeID
end

-------------------  MappedCode  -----------------------------------------------------

if update(MappedCode)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'MappedCode', Deleted.MappedCode, Inserted.MappedCode
	from Inserted inner join Deleted
	on Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.MappedCode <> Deleted.MappedCode
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.ItemCategoryID = Deleted.ItemCategoryID
	and Inserted.ItemCode = Deleted.ItemCode
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: BillableMappings ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteBillableMappings')
	drop trigger utrDeleteBillableMappings
go

create trigger utrDeleteBillableMappings
on BillableMappings
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'BillableMappings' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  ItemCategoryID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCategoryID', Deleted.ItemCategoryID, null from Deleted

-------------------  ItemCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ItemCode', Deleted.ItemCode, null from Deleted

-------------------  AgentNo  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'AgentNo', Deleted.AgentNo, null from Deleted

-------------------  MappedTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MappedTypeID', Deleted.MappedTypeID, null from Deleted

-------------------  MappedCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'MappedCode', Deleted.MappedCode, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go


------------------------------------------------------------------------------------------------------
-------------- Update: Dimensions ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrUpdateDimensions')
	drop trigger utrUpdateDimensions
go

create trigger utrUpdateDimensions
on Dimensions
for update
as
declare @ErrorMSG varchar(200)
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Updates ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'U')
if @ObjectName is null return
if @ObjectName <> 'Dimensions' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return



------------------- Key-DimensionCode -----------------------------------------------------

begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DimensionCode', Deleted.DimensionCode, Inserted.DimensionCode
	from Inserted inner join Deleted
	on Inserted.DimensionCode = Deleted.DimensionCode
end

-------------------  DimensionTypeID  -----------------------------------------------------

if update(DimensionTypeID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DimensionTypeID', Deleted.DimensionTypeID, Inserted.DimensionTypeID
	from Inserted inner join Deleted
	on Inserted.DimensionCode = Deleted.DimensionCode
	and Inserted.DimensionTypeID <> Deleted.DimensionTypeID
end

-------------------  DimensionName  -----------------------------------------------------

if update(DimensionName)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'DimensionName', Deleted.DimensionName, Inserted.DimensionName
	from Inserted inner join Deleted
	on Inserted.DimensionCode = Deleted.DimensionCode
	and Inserted.DimensionName <> Deleted.DimensionName
end

-------------------  Blocked  -----------------------------------------------------

if update(Blocked)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'Blocked', Deleted.Blocked, Inserted.Blocked
	from Inserted inner join Deleted
	on Inserted.DimensionCode = Deleted.DimensionCode
	and Inserted.Blocked <> Deleted.Blocked
end

-------------------  LoginID  -----------------------------------------------------

if update(LoginID)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'LoginID', Deleted.LoginID, Inserted.LoginID
	from Inserted inner join Deleted
	on Inserted.DimensionCode = Deleted.DimensionCode
	and Inserted.LoginID <> Deleted.LoginID
end

-------------------  ClientMachine  -----------------------------------------------------

if update(ClientMachine)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'ClientMachine', Deleted.ClientMachine, Inserted.ClientMachine
	from Inserted inner join Deleted
	on Inserted.DimensionCode = Deleted.DimensionCode
	and Inserted.ClientMachine <> Deleted.ClientMachine
end

-------------------  RecordDateTime  -----------------------------------------------------

if update(RecordDateTime)
begin
	insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
	select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), dbo.FormatDateTime(Inserted.RecordDateTime)
	from Inserted inner join Deleted
	on Inserted.DimensionCode = Deleted.DimensionCode
	and Inserted.RecordDateTime <> Deleted.RecordDateTime
end
go


------------------------------------------------------------------------------------------------------
-------------- Delete: Dimensions ----------------------------------------------------------
------------------------------------------------------------------------------------------------------

if exists (select * from sysobjects where name = 'utrDeleteDimensions')
	drop trigger utrDeleteDimensions
go

create trigger utrDeleteDimensions
on Dimensions
for delete
as
declare @Identity int
declare @ObjectName varchar(40)
declare @FullDate smalldatetime

if @@rowcount = 0 return

------------------- Log Deletes ----------------------------------------------

if ident_current('AuditTrail') <>  @@identity return
set @Identity = ident_current('AuditTrail')

if @Identity is null return

set @ObjectName = (select ObjectName from AuditTrail where AuditID = @Identity and AuditAction = 'D')
if @ObjectName is null return
if @ObjectName <> 'Dimensions' return

set @FullDate = (select FullDate from AuditTrail where AuditID = @Identity)
if @FullDate is null return
if datediff(second, @FullDate, getdate()) > 60 return

-------------------  DimensionCode  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DimensionCode', Deleted.DimensionCode, null from Deleted

-------------------  DimensionTypeID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DimensionTypeID', Deleted.DimensionTypeID, null from Deleted

-------------------  DimensionName  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'DimensionName', Deleted.DimensionName, null from Deleted

-------------------  Blocked  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'Blocked', Deleted.Blocked, null from Deleted

-------------------  LoginID  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'LoginID', Deleted.LoginID, null from Deleted

-------------------  ClientMachine  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'ClientMachine', Deleted.ClientMachine, null from Deleted

-------------------  RecordDateTime  -----------------------------------------------------
insert AuditTrailDetails (AuditID, ColumnName, OriginalValue, NewValue)
select @Identity, 'RecordDateTime', dbo.FormatDateTime(Deleted.RecordDateTime), null from Deleted
go

